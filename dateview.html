<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•°å¸¸å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆï¼ˆé¸æŠå¼·èª¿ï¼‹ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºèª¿æ•´ãƒãƒ¼ï¼‰</title>
<style>
  :root{
    --pill-scale: 1;              /* ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºå€ç‡ï¼ˆ0.8ã€œ1.4ï¼‰ */
    --pill-pad-v: calc(14px * var(--pill-scale));
    --pill-pad-h: calc(18px * var(--pill-scale));
    --pill-font:  calc(1rem * var(--pill-scale));
    --pill-sub:   calc(.85rem * var(--pill-scale));
    --pill-minw:  calc(180px * var(--pill-scale));
    --spark-h:    calc(54px * var(--pill-scale));
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Hiragino Sans',sans-serif;background:#f5f5f7;color:#1d1d1f}

  .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.1);position:sticky;top:0;z-index:100}
  .header-content{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
  .header h1{font-size:1.5rem;font-weight:600}
  .header-actions{display:flex;gap:10px}
  .btn-header{background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);color:#fff;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:500;transition:.2s}
  .btn-header:hover{background:rgba(255,255,255,.3)}

  .container{max-width:1400px;margin:0 auto;padding:20px}

  /* æœŸé–“é¸æŠ */
  .date-filter{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
  .date-filter-header{display:flex;justify-content:space-between;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  .date-filter-title{font-size:1.1rem;font-weight:600;color:#667eea}
  .date-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .date-input-group{display:flex;gap:8px;align-items:center}
  .date-input-group input[type="date"]{padding:10px 14px;border:2px solid #e0e0e0;border-radius:8px;font-size:.95rem;transition:.2s}
  .date-input-group input[type="date"]:focus{outline:none;border-color:#667eea}
  .date-quick-btn{padding:10px 20px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:8px;cursor:pointer;font-weight:600;transition:.2s;white-space:nowrap}
  .date-quick-btn:hover{background:#f8f9ff}
  .date-quick-btn.active{background:#667eea;color:#fff}

  /* ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³è¨­å®š */
  .spark-mode{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .seg{display:flex;border:1px solid #e0e0e0;border-radius:8px;overflow:hidden}
  .seg button{padding:8px 12px;background:#fff;border:none;border-right:1px solid #e0e0e0;cursor:pointer}
  .seg button:last-child{border-right:none}
  .seg button.active{background:#667eea;color:#fff}
  .mode-hint{font-size:.85rem;color:#64748b}

  /* èª¿æ•´ãƒãƒ¼ */
  .tuner{background:#fff;border-radius:12px;padding:14px 20px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.06);display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .tuner label{font-weight:600;color:#334155}
  .tuner .val{min-width:4ch;text-align:right;color:#667eea;font-weight:700}

  /* éƒ¨ç½²æ¨ªä¸¦ã³ï¼‹å±•é–‹ãƒ‘ãƒãƒ« */
  .dept-filter{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
  .dept-filter-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:10px;flex-wrap:wrap}
  .dept-filter-title{font-size:1.1rem;font-weight:600;color:#667eea}
  .btn-tool{padding:8px 16px;border:1px solid #e0e0e0;background:#fff;border-radius:6px;cursor:pointer;font-weight:500;transition:.2s}
  .btn-tool:hover{border-color:#667eea;background:#f8f9ff}

  .dept-bar{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-start}
  .btn-pill{
    --bd: 2px;
    position:relative; overflow:hidden;
    padding:var(--pill-pad-v) var(--pill-pad-h);
    border:var(--bd) solid #e0e0e0; background:#fff; border-radius:10px;
    cursor:pointer; font-size:var(--pill-font); font-weight:700; transition:.15s ease; text-align:center; color:#1d1d1f;
    min-width:var(--pill-minw);
  }
  .btn-pill:hover{border-color:#667eea;background:#f8f9ff}

  /* é¸æŠå¼·èª¿ï¼šã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ï¼‹è»½ã„ã‚°ãƒ­ãƒ¼ï¼‹ãƒªãƒœãƒ³ */
  .btn-pill.active{
    border-color:#3b82f6;
    box-shadow:0 0 0 3px rgba(59,130,246,.25), 0 4px 16px rgba(59,130,246,.15);
    background:#fff;
  }
  .btn-pill.active .ribbon{
    display:inline-flex;
  }
  .ribbon{
    position:absolute; top:6px; right:6px;
    display:none; align-items:center; gap:4px;
    padding:2px 6px; font-size:12px; font-weight:700; color:#0b6cff;
    background:rgba(59,130,246,.12); border:1px solid rgba(59,130,246,.35);
    border-radius:999px; z-index:2;
  }

  /* ãƒ¯ãƒ¼ã‚¹ãƒˆè‰²åˆ†ã‘ï¼ˆãƒ©ã‚¤ãƒ³ï¼‰ */
  .btn-pill.rank-1{ background:rgba(239,68,68,.16); border-color:#ef4444; }
  .btn-pill.rank-2{ background:rgba(245,158,11,.16); border-color:#f59e0b; }
  .btn-pill.rank-3{ background:rgba(234,179,8,.16);  border-color:#eab308; }

  /* ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ï¼ˆä¸­å¤®é‡ã­ï¼‰ */
  .btn-pill .sparkline{position:absolute; top:50%; left:6px; right:6px; transform:translateY(-50%); height:var(--spark-h); opacity:.72; pointer-events:none; z-index:0}
  .btn-pill > .title, .btn-pill > .sub, .btn-pill > .ribbon{position:relative; z-index:1}
  .btn-pill .title{text-align:center}
  .btn-pill .sub{font-size:var(--pill-sub); opacity:.9; margin-top:3px}

  .expand-panel{margin-top:14px; border:1px solid #e6e8ef; border-radius:10px; display:none}
  .expand-panel.open{display:block}
  .panel-head{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; background:#f9fafb; border-bottom:1px solid #e6e8ef}
  .panel-title{font-weight:700; color:#334155}
  .lines-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:10px; padding:12px}
  .serials-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:8px; padding:0 12px 12px}

  /* ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ */
  .datasheet-container{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);overflow:hidden}
  .datasheet-toolbar{padding:16px 20px;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center;background:#f8f9fa;flex-wrap:wrap;gap:12px}
  .result-count{font-size:1rem;color:#666}
  .result-count strong{color:#667eea;font-size:1.2rem}
  .display-count-selector{display:flex;align-items:center;gap:8px}
  .display-count-selector select{padding:6px 12px;border:2px solid #e0e0e0;border-radius:6px;background:#fff;cursor:pointer;font-size:.9rem;transition:.2s}
  .display-count-selector select:focus{outline:none;border-color:#667eea}
  .table-wrapper{overflow-x:auto;max-height:calc(100vh - 440px);position:relative}
  table{width:100%;border-collapse:collapse;font-size:.9rem}
  thead{position:sticky;top:0;z-index:10;background:#fff}
  th{padding:12px 16px;text-align:left;background:#667eea;color:#fff;font-weight:600;white-space:nowrap;cursor:pointer;user-select:none;position:relative}
  th:hover{background:#5568d3}
  th.sortable::after{content:'â‡…';margin-left:8px;opacity:.4}
  th.sort-asc::after{content:'â†‘';opacity:1}
  th.sort-desc::after{content:'â†“';opacity:1}
  td{padding:12px 16px;border-bottom:1px solid #f0f0f0}
  tr{cursor:pointer;transition:background .15s}
  tbody tr:hover{background:#f8f9ff}
  .status-badge{display:inline-block;padding:4px 12px;border-radius:12px;font-size:.85rem;font-weight:600}
  .status-pending{background:#fff3cd;color:#856404}
  .status-complete{background:#d4edda;color:#155724}
  .photo-btn{background:#2196f3;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:.85rem;font-weight:600;transition:.2s}
  .photo-btn:hover{background:#1976d2}
  .photo-btn:disabled{background:#ccc;cursor:not-allowed}

  /* è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå¾“æ¥ï¼‰ */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
  .modal.active{display:flex}
  .modal-content{background:#fff;border-radius:16px;max-width:900px;width:95%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)}
  .modal-header{padding:24px;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:#fff;z-index:10}
  .modal-title{font-size:1.3rem;font-weight:600;color:#667eea}
  .btn-close{background:#f0f0f0;border:none;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1.2rem;color:#666;transition:.2s}
  .btn-close:hover{background:#e0e0e0}
  .modal-body{padding:24px}
  .detail-section { margin-bottom: 24px; }
  .section-title {
    font-size: 1rem; font-weight: 600; color: #667eea;
    margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #e0e0e0;
  }
  .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
  .detail-item { display: flex; flex-direction: column; gap: 4px; }
  .detail-label { font-size: .85rem; color: #888; font-weight: 500; }
  .detail-value { font-size: 1rem; color: #333; font-weight: 500; }
  .detail-text-area { background: #f8f9fa; padding: 12px; border-radius: 8px; line-height: 1.6; white-space: pre-wrap; }
  .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; margin-top: 12px; }
  .photo-thumbnail { aspect-ratio: 1; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,.1); cursor: pointer; transition: transform .2s; }
  .photo-thumbnail:hover { transform: scale(1.05); }
  .photo-thumbnail img { width: 100%; height: 100%; object-fit: cover; }

  .empty-state{text-align:center;padding:60px 20px;color:#999}
  .empty-icon{font-size:3rem;margin-bottom:16px}

  @media (max-width:768px){
    .date-controls{flex-direction:column;align-items:stretch}
    .date-input-group{flex-direction:column}
    .date-quick-btn{width:100%}
    .btn-pill{min-width:calc(140px * var(--pill-scale))}
  }
</style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>ğŸ“Š ç•°å¸¸å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆï¼ˆé¸æŠå¼·èª¿ï¼‹ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºèª¿æ•´ãƒãƒ¼ï¼‰</h1>
      <div class="header-actions">
        <button class="btn-header" id="btnSettings">âš™ï¸ è¡¨ç¤ºè¨­å®š</button>
        <button class="btn-header" id="btnExport">ğŸ“¥ CSVå‡ºåŠ›</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- æœŸé–“é¸æŠ -->
    <div class="date-filter">
      <div class="date-filter-header">
        <div class="date-filter-title">ğŸ“… æœŸé–“ã§çµã‚Šè¾¼ã¿</div>
        <div class="spark-mode">
          <div class="seg" title="ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ã®æœŸé–“">
            <button id="mode7" class="active">7æ—¥</button>
            <button id="mode30">30æ—¥</button>
            <button id="mode24">24æ™‚é–“(8æ™‚)</button>
          </div>
          <div class="seg" title="è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼ˆåˆè¨ˆ/ç©ã¿ä¸Šã’ï¼‰">
            <button id="viewTotal" class="active">åˆè¨ˆ</button>
            <button id="viewStack">ç©ã¿ä¸Šã’</button>
          </div>
          <div class="mode-hint" id="modeHint">é¸æŠæ—¥ã®ç¯„å›²ã§æç”»</div>
        </div>
      </div>
      <div class="date-controls">
        <button class="date-quick-btn" id="btnYesterday">å‰æ—¥ï¼ˆå¹³æ—¥ï¼‰</button>
        <button class="date-quick-btn" id="btnToday">ä»Šæ—¥</button>
        <div class="date-input-group">
          <input type="date" id="dateFrom" placeholder="é–‹å§‹æ—¥">
          <span style="color:#999;">ã€œ</span>
          <input type="date" id="dateTo" placeholder="çµ‚äº†æ—¥">
        </div>
        <button class="btn-tool" id="btnClearDate">æœŸé–“ã‚¯ãƒªã‚¢</button>
      </div>
    </div>

    <!-- ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºèª¿æ•´ãƒãƒ¼ -->
    <div class="tuner">
      <label for="btnSize">ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚º</label>
      <input type="range" id="btnSize" min="0.8" max="1.4" step="0.05" value="1.00" />
      <span class="val" id="btnSizeVal">1.00Ã—</span>
      <span style="color:#64748b;">ï¼ˆéƒ¨ç½²ãƒ»ãƒ©ã‚¤ãƒ³ãƒ»æ•´ç†Noãƒœã‚¿ãƒ³ã‚’ä¸€æ‹¬æ‹¡å¤§ / ç¸®å°ï¼‰</span>
    </div>

    <!-- éƒ¨ç½²æ¨ªä¸¦ã³ -->
    <div class="dept-filter">
      <div class="dept-filter-header">
        <div class="dept-filter-title">ğŸ¢ éƒ¨ç½²ï¼ˆæ¨ªä¸¦ã³ï¼è¤‡æ•°é¸æŠå¯ï¼‰</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn-tool" id="btnClearAll">ä¸€æ‹¬è§£é™¤</button>
        </div>
      </div>
      <div id="deptBar" class="dept-bar"></div>

      <!-- å˜ä¸€å±•é–‹ãƒ‘ãƒãƒ« -->
      <div id="expandPanel" class="expand-panel">
        <div class="panel-head">
          <div class="panel-title" id="panelTitle">é¸æŠä¸­ã®éƒ¨ç½²</div>
          <div style="display:flex; gap:8px;">
            <span id="selCounter" style="color:#64748b; font-weight:600;"></span>
            <button class="btn-tool" id="btnClosePanel">ãŸãŸã‚€</button>
          </div>
        </div>
        <div style="padding:8px 12px; color:#64748b;">ãƒ©ã‚¤ãƒ³ï¼ˆåŒéƒ¨ç½² åˆè¨ˆåœæ­¢æ™‚é–“ãƒ¯ãƒ¼ã‚¹ãƒˆ3ã‚’è‰²è¡¨ç¤ºï¼‰</div>
        <div id="linesGrid" class="lines-grid"></div>
        <div id="serialsHolder" style="display:none;">
          <div style="padding:8px 12px; color:#64748b;">æ•´ç†No</div>
          <div id="serialsGrid" class="serials-grid"></div>
        </div>
      </div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ -->
    <div class="datasheet-container">
      <div class="datasheet-toolbar">
        <div class="result-count">è¡¨ç¤ºä¸­: <strong id="resultCount">0</strong> ä»¶ / å…¨ <strong id="totalCount">0</strong> ä»¶</div>
        <div class="display-count-selector">
          <label for="displayCount">è¡¨ç¤ºä»¶æ•°:</label>
          <select id="displayCount">
            <option value="25">25ä»¶</option>
            <option value="50">50ä»¶</option>
            <option value="75">75ä»¶</option>
            <option value="100">100ä»¶</option>
            <option value="0">ã™ã¹ã¦</option>
          </select>
        </div>
        <div class="toolbar-actions">
          <button class="btn-tool" id="btnResetFilters">ğŸ”„ ãƒ•ã‚£ãƒ«ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
          <button class="btn-tool" id="btnResetSort">â†•ï¸ ã‚½ãƒ¼ãƒˆãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
      <div class="table-wrapper">
        <table id="dataTable">
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="detailTitle">è©³ç´°æƒ…å ±</div>
        <button class="btn-close" id="btnCloseDetail">Ã—</button>
      </div>
      <div class="modal-body" id="detailBody"></div>
    </div>
  </div>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">âš™ï¸ è¡¨ç¤ºé …ç›®è¨­å®š</div>
        <button class="btn-close" id="btnCloseSettings">Ã—</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom:16px;color:#666;">è¡¨ç¤ºã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        <div class="settings-grid" id="columnSettings"></div>
        <button class="btn-header" style="width:100%;margin-top:20px;padding:12px;background:#667eea;border:none;font-size:1rem;" id="btnSaveSettings">ä¿å­˜</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
  import { getFirestore, collection, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyA0YUIpIDh4WB4p1ewiNB0XfwHve0ByljU",
    authDomain: "abnreport-fd733.firebaseapp.com",
    databaseURL: "https://abnreport-fd733-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "abnreport-fd733",
    storageBucket: "abnreport-fd733.firebasestorage.app",
    messagingSenderId: "349748947315",
    appId: "1:349748947315:web:010cb671d2a95bcf1f7d06"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth= getAuth(app);

  // ====== çŠ¶æ…‹ ======
  let allData = [];
  let filteredData = [];
  let dateFromStr = null, dateToStr = null;

  // ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³æœŸé–“è¨­å®š
  let sparkMode = '7d';            // '7d' | '30d' | '24h'
  let lastManualSparkMode = '7d';
  let autoRangeActive = false;

  // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼ˆåˆè¨ˆ/ç©ã¿ä¸Šã’ï¼‰
  let viewMode = 'total';          // 'total' | 'stack'

  // é¸æŠçŠ¶æ…‹
  const selectedDepts   = new Set();
  const selectedLines   = new Set();          // "DEPT||LINE"
  const selectedSerials = new Set();          // "DEPT||LINE||SERIAL"

  let focusedDept = null;

  let currentSort = { column:null, direction:'asc' };

  // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
  const pad2 = n => String(n).padStart(2,'0');
  const clamp = (v,lo,hi)=>Math.max(lo,Math.min(hi,v));
  function formatDate(d){return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;}
  function getToday(){ return formatDate(new Date()); }
  function getPreviousBusinessDay(){
    const date=new Date();const dow=date.getDay();
    if(dow===1) date.setDate(date.getDate()-3);
    else if(dow===0) date.setDate(date.getDate()-2);
    else date.setDate(date.getDate()-1);
    return formatDate(date);
  }
  function normalizeWide(s){return s.replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g,ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0)).replace(/ã€€/g,' ').trim();}
  function normalizeDeptName(s){s=(s??'').toString();return normalizeWide(s).toUpperCase()||'æœªè¨­å®š';}
  function normalizeLineName(s){s=(s??'').toString();return normalizeWide(s)||'æœªè¨­å®š';}

  function parseDateFlexible(v){
    if(!v) return {iso:null,value:null};
    let d=null;
    if(typeof v==='object'){
      if(typeof v.toDate==='function') d=v.toDate();
      else if('seconds'in v&&'nanoseconds'in v) d=new Date(v.seconds*1000+Math.round(v.nanoseconds/1e6));
    }
    if(!d && v instanceof Date) d=v;
    if(!d && typeof v==='number') d=new Date(v);
    if(!d && typeof v==='string'){
      const s=v.trim();
      let m=s.match(/^(\d{4})[.\-\/å¹´](\d{1,2})[.\-\/æœˆ](\d{1,2})(?:æ—¥)?$/);
      if(m) d=new Date(+m[1],+m[2]-1,+m[3]);
      if(!d){ m=s.match(/^(\d{2})[.\-\/å¹´](\d{1,2})[.\-\/æœˆ](\d{1,2})(?:æ—¥)?$/); if(m) d=new Date(2000+(+m[1]),+m[2]-1,+m[3]); }
      if(!d){ m=s.match(/^(\d{4})(\d{2})(\d{2})$/); if(m) d=new Date(+m[1],+m[2]-1,+m[3]); }
      if(!d){ const p=Date.parse(s); if(!Number.isNaN(p)) d=new Date(p); }
    }
    if(!d || Number.isNaN(d.getTime())) return {iso:null,value:null};
    const y=d.getFullYear(), m=d.getMonth()+1, dd=d.getDate();
    return {iso:`${y}-${pad2(m)}-${pad2(dd)}`, value:new Date(y,m-1,dd).getTime()};
  }
  function normalizeTime(v){
    if(!v) return null; const s=String(v).trim();
    let m=s.match(/^(\d{1,2}):(\d{1,2})$/);
    if(m){ return `${pad2(clamp(+m[1],0,23))}:${pad2(clamp(+m[2],0,59))}`; }
    m=s.match(/(\d{1,2})\D+(\d{1,2})/);
    if(m){ return `${pad2(clamp(+m[1],0,23))}:${pad2(clamp(+m[2],0,59))}`; }
    m=s.match(/^(\d{3,4})$/);
    if(m){ const raw=m[1].padStart(4,'0'); return `${pad2(clamp(+raw.slice(0,2),0,23))}:${pad2(clamp(+raw.slice(2,4),0,59))}`; }
    return null;
  }

  function getOccurrenceMsLocal(it){
    if (it.occurrenceDateISO) {
      const time = it.occurrenceTimeNorm || '00:00';
      const dt = new Date(`${it.occurrenceDateISO}T${time}:00`);
      if (!Number.isNaN(dt.getTime())) return dt.getTime();
      const dOnly = new Date(it.occurrenceDateISO);
      if (!Number.isNaN(dOnly.getTime())) return dOnly.getTime();
    }
    if (it.occurrenceDateValue != null) return it.occurrenceDateValue;
    if (it.createdAtValue    != null) return it.createdAtValue;
    return null;
  }

  // ====== ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ç”¨ãƒ“ãƒ³ ======
  function buildBins(){
    if(autoRangeActive && dateFromStr && dateToStr){
      const to   = new Date(`${dateToStr}T23:59:59.999`).getTime();
      const bins = [];
      let cur=new Date(`${dateFromStr}T00:00:00`).getTime();
      while(cur<=to){
        const end=new Date(cur); end.setHours(23,59,59,999);
        bins.push({start:cur,end:end.getTime()});
        const next=new Date(cur); next.setDate(next.getDate()+1); next.setHours(0,0,0,0);
        cur = next.getTime();
      }
      return {type:'day', bins, markers:[]};
    }
    const selStr = (dateToStr || dateFromStr) ?? getToday();
    const selDate = new Date(`${selStr}T00:00:00`);
    if(sparkMode==='24h'){
      const start = new Date(selDate); start.setHours(8,0,0,0);
      const bins=[];
      for(let i=0;i<24;i++){
        const s=new Date(start); s.setHours(s.getHours()+i);
        const e=new Date(start); e.setHours(e.getHours()+i+1); e.setMilliseconds(e.getMilliseconds()-1);
        bins.push({start:s.getTime(), end:e.getTime()});
      }
      return {type:'hour', bins, markers:[9]};
    }else{
      const days = (sparkMode==='30d')?30:7;
      const bins=[];
      for(let i=days-1;i>=0;i--){
        const d=new Date(selDate); d.setDate(d.getDate()-i);
        const s=new Date(d); s.setHours(0,0,0,0);
        const e=new Date(d); e.setHours(23,59,59,999);
        bins.push({start:s.getTime(), end:e.getTime()});
      }
      return {type:'day', bins, markers:[]};
    }
  }

  // ====== æç”»ï¼ˆå…±é€šï¼‰ ======
  function drawShiftMarker(ctx, canvas, opts){
    if(!opts || opts.markerIndex==null) return;
    const dpr=window.devicePixelRatio||1;
    const pad=6*dpr;
    const step = (canvas.width - pad*2) / Math.max(1,(opts.count-1));
    const x = pad + step * opts.markerIndex;
    ctx.save(); ctx.strokeStyle='rgba(255,0,0,0.45)'; ctx.setLineDash([3*dpr, 3*dpr]); ctx.lineWidth = 1*dpr;
    ctx.beginPath(); ctx.moveTo(x, pad); ctx.lineTo(x, canvas.height - pad); ctx.stroke(); ctx.restore();
    ctx.save(); ctx.fillStyle='rgba(255,0,0,0.7)'; ctx.font = `${10*dpr}px system-ui`; ctx.textAlign='center'; ctx.textBaseline='top'; ctx.fillText('17', x, pad+1*dpr); ctx.restore();
  }
  function drawLineSpark(canvas, values, color='rgba(66,133,244,0.85)', opts={}){
    if(!canvas) return;
    const dpr=window.devicePixelRatio||1;
    const cssW=canvas.clientWidth||120, cssH=canvas.clientHeight||parseFloat(getComputedStyle(canvas).height);
    canvas.width=Math.max(1,Math.floor(cssW*dpr));
    canvas.height=Math.max(1,Math.floor(cssH*dpr));
    const ctx=canvas.getContext('2d'); if(!ctx) return;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const n=values.length; if(!n) return;
    const max=Math.max(...values,1), min=Math.min(...values,0);
    const pad=6*dpr; const xStep=n>1?(canvas.width-pad*2)/(n-1):0;
    ctx.strokeStyle='rgba(0,0,0,0.12)'; ctx.lineWidth=1*dpr;
    ctx.beginPath(); ctx.moveTo(pad, canvas.height-pad); ctx.lineTo(canvas.width-pad, canvas.height-pad); ctx.stroke();
    if(opts.type==='hour' && typeof opts.markerIndex==='number'){ drawShiftMarker(ctx, canvas, {markerIndex:opts.markerIndex, count:n}); }
    ctx.strokeStyle=color; ctx.lineWidth=2*dpr; ctx.beginPath();
    for(let i=0;i<n;i++){
      const v=values[i];
      const ratio=(max===min)?0.5:(v-min)/(max-min);
      const x=pad+xStep*i;
      const y=canvas.height-pad - ratio*(canvas.height-pad*2);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
    ctx.fillStyle=color;
    const lastX=pad+xStep*(n-1);
    const lastV=values[n-1];
    const lastR=(max===min)?0.5:(lastV-min)/(max-min);
    const lastY=canvas.height-pad - lastR*(canvas.height-pad*2);
    ctx.beginPath(); ctx.arc(lastX,lastY,2.5*dpr,0,Math.PI*2); ctx.fill();
  }
  function hexToRgba(hex, alpha){ const h=hex.replace('#',''); const n=parseInt(h,16); const r=(n>>16)&255,g=(n>>8)&255,b=n&255; return `rgba(${r},${g},${b},${alpha})`; }
  function drawStackedSpark(canvas, seriesList, colors=['#8ab4f8','#a3e0c0','#f9c58d','#f7a9b8','#c9b6f2'], opts={}){
    if(!canvas) return;
    const dpr=window.devicePixelRatio||1;
    const cssW=canvas.clientWidth||120, cssH=canvas.clientHeight||parseFloat(getComputedStyle(canvas).height);
    canvas.width=Math.max(1,Math.floor(cssW*dpr));
    canvas.height=Math.max(1,Math.floor(cssH*dpr));
    const ctx=canvas.getContext('2d'); if(!ctx) return;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const L=seriesList?.[0]?.length||0; if(!L) return;
    const sums = Array.from({length:L},(_,i)=> seriesList.reduce((a,s)=>a+(s[i]||0),0));
    const maxSum=Math.max(...sums,1);
    const pad=6*dpr, step=(canvas.width-pad*2)/Math.max(1,(L-1)), baseY=canvas.height-pad, height=(canvas.height-pad*2);
    ctx.strokeStyle='rgba(0,0,0,0.12)'; ctx.lineWidth=1*dpr; ctx.beginPath(); ctx.moveTo(pad,baseY); ctx.lineTo(canvas.width-pad,baseY); ctx.stroke();
    if(opts.type==='hour' && typeof opts.markerIndex==='number'){ drawShiftMarker(ctx, canvas, {markerIndex:opts.markerIndex, count:L}); }
    let accumPrev=Array(L).fill(0);
    seriesList.forEach((s,idx)=>{
      const topY=s.map((v,i)=> baseY - ((accumPrev[i]+v)/maxSum)*height);
      const botY=accumPrev.map((v,i)=> baseY - (v/maxSum)*height);
      ctx.beginPath();
      for(let i=0;i<L;i++){ const x=pad+step*i, y=topY[i]; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }
      for(let i=L-1;i>=0;i--){ const x=pad+step*i, y=botY[i]; ctx.lineTo(x,y); }
      ctx.closePath(); ctx.fillStyle=hexToRgba(colors[idx%colors.length],0.85); ctx.fill();
      accumPrev=accumPrev.map((v,i)=>v+(s[i]||0));
    });
    ctx.beginPath();
    for(let i=0;i<L;i++){ const x=pad+step*i, y=baseY-(sums[i]/maxSum)*height; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }
    ctx.strokeStyle='rgba(0,0,0,0.18)'; ctx.lineWidth=1*dpr; ctx.stroke();
  }

  // ====== åˆ—å®šç¾© ======
  const allColumns=[
    {id:'serialNo',label:'æ•´ç†No',sortable:true,filterable:true},
    {id:'department',label:'éƒ¨ç½²',sortable:true,filterable:true},
    {id:'lineName',label:'ãƒ©ã‚¤ãƒ³',sortable:true,filterable:true},
    {id:'occurrenceDate',label:'ç™ºç”Ÿæ—¥',sortable:true,filterable:true},
    {id:'occurrenceTime',label:'ç™ºç”Ÿæ™‚åˆ»',sortable:true,filterable:false},
    {id:'restartTime',label:'å†é–‹æ™‚åˆ»',sortable:true,filterable:false},
    {id:'stopMinutes',label:'åœæ­¢æ™‚é–“',sortable:true,filterable:false},
    {id:'handler',label:'å‡¦ç½®è€…',sortable:true,filterable:true},
    {id:'techHandler',label:'æŠ€è¡“å‡¦ç½®è€…',sortable:true,filterable:true},
    {id:'status',label:'çŠ¶æ…‹',sortable:true,filterable:true},
    {id:'photos',label:'å†™çœŸ',sortable:true,filterable:false},
    {id:'anomalyContent',label:'ç•°å¸¸å†…å®¹',sortable:false,filterable:true},
    {id:'actionTaken',label:'å¯¾å¿œå†…å®¹',sortable:false,filterable:true},
  ];
  let visibleColumns=['serialNo','department','lineName','occurrenceDate','occurrenceTime','stopMinutes','handler','photos','status'];
  let displayLimit=25;

  // ====== èªè¨¼ãƒ»ãƒ­ãƒ¼ãƒ‰ ======
  async function checkAuth(){
    return new Promise(resolve=>{
      onAuthStateChanged(auth,(user)=>{
        if(user) resolve(true);
        else{
          const email=prompt('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          const password=prompt('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          if(email && password){
            setPersistence(auth,browserLocalPersistence)
              .then(()=>signInWithEmailAndPassword(auth,email,password))
              .then(()=>resolve(true))
              .catch(e=>{alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: '+e.message); resolve(false);});
          }else resolve(false);
        }
      });
    });
  }

  async function loadData(){
    const q=query(collection(db,'anomalies'), orderBy('createdAt','desc'));
    const snap=await getDocs(q);
    allData=snap.docs.map(doc=>{
      const raw={_id:doc.id, ...doc.data()};
      const deptNorm=normalizeDeptName(raw.department);
      const lineNorm=normalizeLineName(raw.lineName);

      const occSource = raw.occurrenceDate ?? raw.occurrence_at ?? raw.date ?? raw.createdAt ?? raw.updatedAt;
      const occ      = parseDateFlexible(occSource);
      const created  = parseDateFlexible(raw.createdAt);

      const occTime=normalizeTime(raw.occurrenceTime);
      const resTime=normalizeTime(raw.restartTime);
      let stop=null;
      if(occTime && resTime){
        const [oh,om]=occTime.split(':').map(Number);
        const [rh,rm]=resTime.split(':').map(Number);
        let diff=(rh*60+rm)-(oh*60+om);
        if(diff<0) diff+=1440;
        stop=diff;
      }
      return {
        ...raw,
        departmentNormalized:deptNorm,
        lineNameNormalized:lineNorm,
        occurrenceDateISO:occ.iso,
        occurrenceDateValue:occ.value,
        createdAtISO: created.iso,
        createdAtValue: created.value,
        occurrenceTimeNorm:occTime,
        restartTimeNorm:resTime,
        stopMinutes: (typeof raw.stopMinutes==='number') ? raw.stopMinutes : stop
      };
    });
    renderDeptBar();
    applyFilters();
  }

  // ====== éƒ¨ç½²ãƒãƒ¼ ======
  function renderDeptBar(){
    const bar=document.getElementById('deptBar');
    const counts = new Map();
    for(const it of allData){
      const d=it.departmentNormalized||'æœªè¨­å®š';
      counts.set(d,(counts.get(d)||0)+1);
    }
    const depts=[...counts.keys()].sort();
    bar.innerHTML = depts.map(dept=>{
      const total=counts.get(dept);
      const activeClass = selectedDepts.has(dept)?'active':'';
      return `
        <div class="btn-pill ${activeClass}" data-role="dept" data-dept="${dept}" title="${dept}">
          <span class="ribbon">âœ“ é¸æŠä¸­</span>
          <canvas class="sparkline"></canvas>
          <div class="title">${dept}</div>
          <div class="sub">${total}ä»¶</div>
        </div>`;
    }).join('');

    bar.querySelectorAll('[data-role="dept"]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const dept=btn.getAttribute('data-dept');
        const isActive=btn.classList.toggle('active');
        if(isActive) selectedDepts.add(dept); else selectedDepts.delete(dept);
        focusedDept = dept;
        renderExpandPanel(dept);
        applyFilters();
        drawAllSparklines();
      });
    });

    drawAllSparklines();
    let timer=null;
    window.addEventListener('resize', ()=>{
      clearTimeout(timer);
      timer=setTimeout(()=>{ drawAllSparklines(); }, 150);
    }, {passive:true});
  }

  // ====== å±•é–‹ãƒ‘ãƒãƒ«ï¼ˆãƒ©ã‚¤ãƒ³ï¼šãƒ¯ãƒ¼ã‚¹ãƒˆè‰²åˆ†ã‘ï¼‰ ======
  function renderExpandPanel(dept){
    const panel=document.getElementById('expandPanel');
    const title=document.getElementById('panelTitle');
    const linesGrid=document.getElementById('linesGrid');
    const serialsHolder=document.getElementById('serialsHolder');
    const serialsGrid=document.getElementById('serialsGrid');
    const selCounter = document.getElementById('selCounter');

    if(!dept){ panel.classList.remove('open'); linesGrid.innerHTML=''; serialsGrid.innerHTML=''; serialsHolder.style.display='none'; selCounter.textContent=''; return; }

    title.textContent=`éƒ¨ç½²ï¼š${dept}`;
    panel.classList.add('open');
    serialsHolder.style.display='none'; serialsGrid.innerHTML='';

    // ãƒ©ã‚¤ãƒ³ã”ã¨ã®ä»¶æ•°ã¨åˆè¨ˆåœæ­¢æ™‚é–“
    const base=allData.filter(it=>(it.departmentNormalized||'æœªè¨­å®š')===dept);
    const lineCount=new Map();
    const lineStop =new Map();
    for(const it of base){
      const l=it.lineNameNormalized||'æœªè¨­å®š';
      lineCount.set(l,(lineCount.get(l)||0)+1);
      const sm = typeof it.stopMinutes==='number' ? it.stopMinutes : 0;
      lineStop.set(l,(lineStop.get(l)||0)+sm);
    }
    const lines=[...lineCount.keys()].sort();

    // åŒéƒ¨ç½²å†…ãƒ¯ãƒ¼ã‚¹ãƒˆ3ï¼ˆåˆè¨ˆåœæ­¢æ™‚é–“ï¼‰
    const top3 = [...lineStop.entries()]
      .sort((a,b)=> b[1]-a[1])
      .slice(0,3)
      .map(([ln])=>ln);

    linesGrid.innerHTML = lines.map(line=>{
      const totalCnt=lineCount.get(line)||0;
      const totalMin=lineStop.get(line)||0;
      const key=`${dept}||${line}`;
      const active=selectedLines.has(key)?'active':'';
      const rankCls = top3[0]===line ? 'rank-1' : top3[1]===line ? 'rank-2' : top3[2]===line ? 'rank-3' : '';
      return `
        <div class="btn-pill ${active} ${rankCls}" data-role="line" data-dept="${dept}" data-line="${line}" title="åˆè¨ˆåœæ­¢æ™‚é–“: ${totalMin}åˆ†">
          <span class="ribbon">âœ“ é¸æŠä¸­</span>
          <canvas class="sparkline"></canvas>
          <div class="title">${line}</div>
          <div class="sub">${totalCnt}ä»¶</div>
        </div>`;
    }).join('');

    linesGrid.querySelectorAll('[data-role="line"]').forEach(btn=>{
      btn.addEventListener('click',(e)=>{
        const d=btn.getAttribute('data-dept');
        const l=btn.getAttribute('data-line');
        const key=`${d}||${l}`;
        const isActive=btn.classList.toggle('active');
        if(isActive) selectedLines.add(key); else selectedLines.delete(key);
        renderSerials(d,l);
        applyFilters();
        drawAllSparklines();
        e.stopPropagation();
      });
    });

    selCounter.textContent = `é¸æŠä¸­ï¼šéƒ¨ç½² ${selectedDepts.size}ï¼ãƒ©ã‚¤ãƒ³ ${selectedLines.size}ï¼æ•´ç†No ${selectedSerials.size}`;
    drawAllSparklines();
  }

  function renderSerials(dept,line){
    const serialsHolder=document.getElementById('serialsHolder');
    const serialsGrid=document.getElementById('serialsGrid');
    const selCounter = document.getElementById('selCounter');
    if(!dept || !line){ serialsHolder.style.display='none'; serialsGrid.innerHTML=''; selCounter.textContent = `é¸æŠä¸­ï¼šéƒ¨ç½² ${selectedDepts.size}ï¼ãƒ©ã‚¤ãƒ³ ${selectedLines.size}ï¼æ•´ç†No ${selectedSerials.size}`; return; }

    const base=allData.filter(it=>(it.departmentNormalized||'æœªè¨­å®š')===dept && (it.lineNameNormalized||'æœªè¨­å®š')===line);
    const serialCounts=new Map();
    for(const it of base){
      const s=it.serialNo||'æœªè¨­å®š';
      serialCounts.set(s,(serialCounts.get(s)||0)+1);
    }
    const serials=[...serialCounts.keys()].sort();

    serialsGrid.innerHTML = serials.map(sn=>{
      const total=serialCounts.get(sn);
      const sk=`${dept}||${line}||${sn}`;
      const active=selectedSerials.has(sk)?'active':'';
      return `
        <div class="btn-pill ${active}" data-role="serial" data-dept="${dept}" data-line="${line}" data-serial="${sn}">
          <span class="ribbon">âœ“ é¸æŠä¸­</span>
          <canvas class="sparkline"></canvas>
          <div class="title">${sn}</div>
          <div class="sub">${total}ä»¶</div>
        </div>`;
    }).join('');

    serialsGrid.querySelectorAll('[data-role="serial"]').forEach(btn=>{
      btn.addEventListener('click',(e)=>{
        const d=btn.getAttribute('data-dept');
        const l=btn.getAttribute('data-line');
        const s=btn.getAttribute('data-serial');
        const key=`${d}||${l}||${s}`;
        const isActive=btn.classList.toggle('active');
        if(isActive) selectedSerials.add(key); else selectedSerials.delete(key);
        applyFilters();
        drawAllSparklines();
        const selCounter = document.getElementById('selCounter');
        selCounter.textContent = `é¸æŠä¸­ï¼šéƒ¨ç½² ${selectedDepts.size}ï¼ãƒ©ã‚¤ãƒ³ ${selectedLines.size}ï¼æ•´ç†No ${selectedSerials.size}`;
        e.stopPropagation();
      });
    });

    serialsHolder.style.display='block';
    selCounter.textContent = `é¸æŠä¸­ï¼šéƒ¨ç½² ${selectedDepts.size}ï¼ãƒ©ã‚¤ãƒ³ ${selectedLines.size}ï¼æ•´ç†No ${selectedSerials.size}`;
  }

  // ====== ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³å†æç”» ======
  function buildSeriesMapsFlexible(data){
    const {bins} = buildBins();
    const len=bins.length;

    const deptSeries=new Map();   // dept -> [len]
    const deptStack =new Map();   // dept -> Map(line->[len])
    const lineSeries=new Map();   // dept -> Map(line->[len])
    const lineStack =new Map();   // dept -> Map(line -> Map(serial->[len]))

    function binIndex(ms){
      for(let i=0;i<len;i++){ const b=bins[i]; if(ms>=b.start && ms<=b.end) return i; }
      return -1;
    }

    for(const it of data){
      const ms = getOccurrenceMsLocal(it);
      if(ms==null) continue;
      const idx=binIndex(ms);
      if(idx<0) continue;

      const dept=it.departmentNormalized||'æœªè¨­å®š';
      const line=it.lineNameNormalized||'æœªè¨­å®š';
      const sn  =it.serialNo||'æœªè¨­å®š';

      if(!deptSeries.has(dept)) deptSeries.set(dept, Array(len).fill(0));
      deptSeries.get(dept)[idx]+=1;

      if(!deptStack.has(dept)) deptStack.set(dept,new Map());
      if(!deptStack.get(dept).has(line)) deptStack.get(dept).set(line, Array(len).fill(0));
      deptStack.get(dept).get(line)[idx]+=1;

      if(!lineSeries.has(dept)) lineSeries.set(dept,new Map());
      if(!lineSeries.get(dept).has(line)) lineSeries.get(dept).set(line, Array(len).fill(0));
      lineSeries.get(dept).get(line)[idx]+=1;

      if(!lineStack.has(dept)) lineStack.set(dept,new Map());
      if(!lineStack.get(dept).has(line)) lineStack.get(dept).set(line,new Map());
      if(!lineStack.get(dept).get(line).has(sn)) lineStack.get(dept).get(line).set(sn, Array(len).fill(0));
      lineStack.get(dept).get(line).get(sn)[idx]+=1;
    }

    return {deptSeries,deptStack,lineSeries,lineStack};
  }

  function drawAllSparklines(){
    const binsInfo = buildBins();
    const {deptSeries,deptStack,lineSeries,lineStack}=buildSeriesMapsFlexible(allData);
    const binsLen = binsInfo.bins.length;

    const drawOpts = (seriesLen)=>({
      type: binsInfo.type,
      markerIndex: (binsInfo.type==='hour' ? 9 : null),
      count: seriesLen
    });

    document.querySelectorAll('#deptBar [data-role="dept"]').forEach(btn=>{
      const dept=btn.getAttribute('data-dept');
      const canvas=btn.querySelector('.sparkline');
      if(viewMode==='stack'){
        const stacks = [...(deptStack.get(dept)?.values()||[])];
        const fallback = stacks.length? stacks : [Array(binsLen).fill(0)];
        drawStackedSpark(canvas, fallback, undefined, drawOpts(binsLen));
      }else{
        const vals=deptSeries.get(dept)||Array(binsLen).fill(0);
        drawLineSpark(canvas, vals, 'rgba(66,133,244,0.85)', drawOpts(binsLen));
      }
    });

    document.querySelectorAll('#linesGrid [data-role="line"]').forEach(btn=>{
      const dept=btn.getAttribute('data-dept');
      const line=btn.getAttribute('data-line');
      const canvas=btn.querySelector('.sparkline');
      if(viewMode==='stack'){
        const stacks = [...(lineStack.get(dept)?.get(line)?.values()||[])];
        const fallback = stacks.length? stacks : [Array(binsLen).fill(0)];
        drawStackedSpark(canvas, fallback, undefined, drawOpts(binsLen));
      }else{
        const vals=(lineSeries.get(dept)?.get(line))||Array(binsLen).fill(0);
        drawLineSpark(canvas, vals, 'rgba(66,133,244,0.85)', drawOpts(binsLen));
      }
    });

    document.querySelectorAll('#serialsGrid [data-role="serial"]').forEach(btn=>{
      const dept=btn.getAttribute('data-dept');
      const line=btn.getAttribute('data-line');
      const sn  =btn.getAttribute('data-serial');
      const canvas=btn.querySelector('.sparkline');
      const map = lineStack.get(dept)?.get(line);
      const vals = map?.get(sn) || [];
      const bins = vals.length? vals : Array(binsLen).fill(0);
      drawLineSpark(canvas, bins, 'rgba(66,133,244,0.85)', drawOpts(binsLen));
    });

    const hint=document.getElementById('modeHint');
    if(autoRangeActive && dateFromStr && dateToStr){
      hint.textContent = `æœŸé–“ï¼ˆ${dateFromStr}ã€œ${dateToStr}ï¼‰ï¼è¡¨ç¤º:${viewMode==='stack'?'ç©ã¿ä¸Šã’':'åˆè¨ˆ'}`;
    }else{
      const base = (dateToStr || dateFromStr) ?? getToday();
      const p = (sparkMode==='7d')?`7æ—¥`:(sparkMode==='30d')?`30æ—¥`:`24æ™‚é–“ï¼ˆ8:00ã€œç¿Œ8:00ï¼‰`;
      hint.textContent = `${base} ã‚’åŸºæº–ã« ${p} ï¼è¡¨ç¤º:${viewMode==='stack'?'ç©ã¿ä¸Šã’':'åˆè¨ˆ'}`;
    }
  }

  // ====== ãƒ†ãƒ¼ãƒ–ãƒ« ======
  function applyFilters(){
    let fromMs=null, toMs=null;
    if(dateFromStr && /^\d{4}-\d{2}-\d{2}$/.test(dateFromStr)){ fromMs=new Date(`${dateFromStr}T00:00:00`).getTime(); }
    if(dateToStr   && /^\d{4}-\d{2}-\d{2}$/.test(dateToStr)){   toMs  =new Date(`${dateToStr}T23:59:59.999`).getTime(); }

    filteredData = allData.filter(it=>{
      const occMs = getOccurrenceMsLocal(it);
      if(fromMs!==null || toMs!==null){
        if (occMs != null) {
          if(fromMs!==null && occMs<fromMs) return false;
          if(toMs!==null   && occMs>toMs)   return false;
        }
      }

      const dept=it.departmentNormalized||'æœªè¨­å®š';
      const line=it.lineNameNormalized||'æœªè¨­å®š';
      const sn  =it.serialNo||'æœªè¨­å®š';

      if(selectedSerials.size>0){
        if(!selectedSerials.has(`${dept}||${line}||${sn}`)) return false;
      }else if(selectedLines.size>0){
        if(!selectedLines.has(`${dept}||${line}`)) return false;
      }else if(selectedDepts.size>0){
        if(!selectedDepts.has(dept)) return false;
      }
      return true;
    });

    if(currentSort.column) applySorting();
    else renderTable();

    drawAllSparklines();
  }

  function renderTable(){
    const thead=document.getElementById('tableHead');
    const tbody=document.getElementById('tableBody');
    const columns=allColumns.filter(c=>visibleColumns.includes(c.id));

    thead.innerHTML = `<tr>${
      columns.map(col=>`
        <th class="${col.sortable?'sortable':''} ${currentSort.column===col.id?('sort-'+currentSort.direction):''}" data-column="${col.id}">
          ${col.label}${col.filterable?'<span class="filter-icon">ğŸ”</span>':''}
        </th>`).join('')}</tr>`;

    thead.querySelectorAll('th.sortable').forEach(th=>{
      th.addEventListener('click', ()=>{
        const col=th.getAttribute('data-column');
        if(currentSort.column===col) currentSort.direction = currentSort.direction==='asc'?'desc':'asc';
        else { currentSort.column=col; currentSort.direction='asc'; }
        applySorting();
      });
    });

    const display=(displayLimit && displayLimit>0)? filteredData.slice(0, displayLimit) : filteredData;

    if(display.length===0){
      tbody.innerHTML = `<tr><td colspan="${columns.length}">
        <div class="empty-state"><div class="empty-icon">ğŸ“­</div><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div></td></tr>`;
    }else{
      tbody.innerHTML = display.map(item=>`
        <tr data-id="${item._id}">
          ${columns.map(col=>{
            let v=item[col.id]??'-';
            if(col.id==='occurrenceDate') v=item.occurrenceDateISO || item.createdAtISO || '-';
            else if(col.id==='occurrenceTime') v=item.occurrenceTimeNorm||'-';
            else if(col.id==='restartTime') v=item.restartTimeNorm||'-';
            else if(col.id==='status'){
              const t=item.status==='complete'?'å®Œäº†':'æŠ€è¡“å…¥åŠ›å¾…ã¡';
              const cls=item.status==='complete'?'status-complete':'status-pending';
              v=`<span class="status-badge ${cls}">${t}</span>`;
            }else if(col.id==='photos'){
              const m=(item.mfgPhotoUrls||[]).length, t=(item.techPhotoUrls||[]).length;
              const total=m+t; v = total>0?`<button class="photo-btn" onclick="event.stopPropagation(); showPhotosOnly('${item._id}')">ğŸ“· ${total}æš</button>`:'-';
            }else if(col.id==='stopMinutes' && item.stopMinutes!=null){ v=`${item.stopMinutes}åˆ†`; }
            else if(col.id==='anomalyContent'||col.id==='actionTaken'){ const s=v||''; v=(s.length>30?s.slice(0,30)+'...':s); }
            return `<td>${v}</td>`;
          }).join('')}
        </tr>`).join('');
      tbody.querySelectorAll('tr').forEach(tr=>tr.addEventListener('click',()=>showDetail(tr.getAttribute('data-id'))));
    }

    document.getElementById('resultCount').textContent=display.length;
    document.getElementById('totalCount').textContent=filteredData.length;
  }

  function applySorting(){
    const col=currentSort.column, dir=currentSort.direction;
    filteredData.sort((a,b)=>{
      let A,B;
      if(col==='occurrenceDate'){A=a.occurrenceDateValue??a.createdAtValue??-Infinity; B=b.occurrenceDateValue??b.createdAtValue??-Infinity;}
      else if(col==='occurrenceTime'){A=a.occurrenceTimeNorm??''; B=b.occurrenceTimeNorm??'';}
      else if(col==='restartTime'){A=a.restartTimeNorm??''; B=b.restartTimeNorm??'';}
      else if(col==='stopMinutes'){A=a.stopMinutes??-Infinity; B=b.stopMinutes??-Infinity;}
      else {A=a[col]??''; B=b[col]??'';}
      if(A<B) return dir==='asc'?-1:1;
      if(A>B) return dir==='asc'?1:-1;
      return 0;
    });
    renderTable();
  }

  // ====== CSV ======
  function exportCSV(){
    const cols=allColumns.filter(c=>visibleColumns.includes(c.id));
    const headers=cols.map(c=>c.label);
    let csv='\uFEFF'+headers.join(',')+'\n';
    filteredData.forEach(it=>{
      const row=cols.map(col=>{
        let v=it[col.id]??'';
        if(col.id==='occurrenceDate') v=it.occurrenceDateISO || it.createdAtISO || '';
        else if(col.id==='occurrenceTime') v=it.occurrenceTimeNorm||'';
        else if(col.id==='restartTime') v=it.restartTimeNorm||'';
        else if(col.id==='status') v=(it.status==='complete'?'å®Œäº†':'æŠ€è¡“å…¥åŠ›å¾…ã¡');
        else if(col.id==='stopMinutes' && it.stopMinutes!=null) v=it.stopMinutes;
        return `"${String(v).replace(/"/g,'""')}"`;
      });
      csv+=row.join(',')+'\n';
    });
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const link=document.createElement('a');
    link.href=URL.createObjectURL(blob);
    link.download=`ç•°å¸¸å±¥æ­´_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
  }

  // ====== è©³ç´°ãƒ»å†™çœŸ ======
  function showDetail(id){
    const item=allData.find(x=>x._id===id); if(!item) return;
    const modal=document.getElementById('detailModal');
    const title=document.getElementById('detailTitle');
    const body =document.getElementById('detailBody');
    title.textContent=`æ•´ç†No: ${item.serialNo||'-'}`;
    const mfg=item.mfgPhotoUrls||[], tech=item.techPhotoUrls||[];
    body.innerHTML=`
      <div class="detail-section"><div class="section-title">ğŸ“‹ åŸºæœ¬æƒ…å ±</div>
        <div class="detail-grid">
          <div class="detail-item"><div class="detail-label">æ•´ç†No</div><div class="detail-value">${item.serialNo||'-'}</div></div>
          <div class="detail-item"><div class="detail-label">éƒ¨ç½²</div><div class="detail-value">${item.department||'-'}</div></div>
          <div class="detail-item"><div class="detail-label">ãƒ©ã‚¤ãƒ³</div><div class="detail-value">${item.lineName||'-'}</div></div>
          <div class="detail-item"><div class="detail-label">ç™ºç”Ÿæ—¥</div><div class="detail-value">${item.occurrenceDateISO || item.createdAtISO || '-'}</div></div>
          <div class="detail-item"><div class="detail-label">ç™ºç”Ÿæ™‚åˆ»</div><div class="detail-value">${item.occurrenceTimeNorm||'-'}</div></div>
          <div class="detail-item"><div class="detail-label">å†é–‹æ™‚åˆ»</div><div class="detail-value">${item.restartTimeNorm||'-'}</div></div>
          <div class="detail-item"><div class="detail-label">åœæ­¢æ™‚é–“</div><div class="detail-value">${item.stopMinutes!=null?item.stopMinutes+'åˆ†':'-'}</div></div>
          <div class="detail-item"><div class="detail-label">å‡¦ç½®è€…</div><div class="detail-value">${item.handler||'-'}</div></div>
          <div class="detail-item"><div class="detail-label">çŠ¶æ…‹</div><div class="detail-value">
            <span class="status-badge ${item.status==='complete'?'status-complete':'status-pending'}">${item.status==='complete'?'å®Œäº†':'æŠ€è¡“å…¥åŠ›å¾…ã¡'}</span>
          </div></div>
        </div>
      </div>
      <div class="detail-section"><div class="section-title">ğŸš¨ ç•°å¸¸å†…å®¹</div><div class="detail-text-area">${item.anomalyContent||'-'}</div></div>
      <div class="detail-section"><div class="section-title">ğŸ”§ å¯¾å¿œå†…å®¹</div><div class="detail-text-area">${item.actionTaken||'-'}</div></div>
      ${mfg.length?`<div class="detail-section"><div class="section-title">ğŸ“· ç™ºä¿¡éƒ¨ç½²ã®å†™çœŸï¼ˆ${mfg.length}æšï¼‰</div><div class="photo-grid">${mfg.map(u=>`<div class="photo-thumbnail" onclick="window.open('${u}','_blank')"><img src="${u}" alt=""></div>`).join('')}</div></div>`:''}
      ${tech.length?`<div class="detail-section"><div class="section-title">ğŸ”§ æŠ€è¡“éƒ¨é–€ã®å†™çœŸï¼ˆ${tech.length}æšï¼‰</div><div class="photo-grid">${tech.map(u=>`<div class="photo-thumbnail" onclick="window.open('${u}','_blank')"><img src="${u}" alt=""></div>`).join('')}</div></div>`:''}
    `;
    modal.classList.add('active');
  }
  window.showPhotosOnly=function(id){
    const it=allData.find(x=>x._id===id); if(!it) return;
    const modal=document.getElementById('detailModal');
    const title=document.getElementById('detailTitle');
    const body =document.getElementById('detailBody');
    title.textContent=`ğŸ“· å†™çœŸ - æ•´ç†No: ${it.serialNo||'-'}`;
    const mfg=it.mfgPhotoUrls||[], tech=it.techPhotoUrls||[];
    body.innerHTML = `
      ${mfg.length?`<div class="detail-section"><div class="section-title">ğŸ“· ç™ºä¿¡éƒ¨ç½²ã®å†™çœŸï¼ˆ${mfg.length}æšï¼‰</div><div class="photo-grid">${mfg.map(u=>`<div class="photo-thumbnail" onclick="window.open('${u}','_blank')"><img src="${u}" alt=""></div>`).join('')}</div></div>`:''}
      ${tech.length?`<div class="detail-section"><div class="section-title">ğŸ”§ æŠ€è¡“éƒ¨é–€ã®å†™çœŸï¼ˆ${tech.length}æšï¼‰</div><div class="photo-grid">${tech.map(u=>`<div class="photo-thumbnail" onclick="window.open('${u}','_blank')"><img src="${u}" alt=""></div>`).join('')}</div></div>`:''}
      ${(!mfg.length&&!tech.length)?`<div class="empty-state"><div class="empty-icon">ğŸ“·</div><p>å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“</p></div>`:''}
    `;
    modal.classList.add('active');
  };

  // ====== è¨­å®šãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ ======
  function loadSettings(){
    const saved=localStorage.getItem('datasheetColumns');
    if(saved) visibleColumns=JSON.parse(saved);

    const savedLimit=localStorage.getItem('displayLimit');
    if(savedLimit!==null){
      const v=parseInt(savedLimit,10);
      if([0,25,50,75,100].includes(v)){
        displayLimit=v;
        document.getElementById('displayCount').value=String(v);
      }
    }

    // ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚º
    const savedScale = parseFloat(localStorage.getItem('pillScale'));
    const initial = (!Number.isNaN(savedScale) && savedScale>=0.8 && savedScale<=1.4) ? savedScale : 1.0;
    document.documentElement.style.setProperty('--pill-scale', String(initial));
    const sizeInput = document.getElementById('btnSize');
    const sizeVal   = document.getElementById('btnSizeVal');
    sizeInput.value = String(initial.toFixed(2));
    sizeVal.textContent = `${initial.toFixed(2)}Ã—`;
  }
  function saveSettings(){ localStorage.setItem('datasheetColumns', JSON.stringify(visibleColumns)); }
  function saveDisplayLimit(){ localStorage.setItem('displayLimit', String(displayLimit)); }

  // ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºèª¿æ•´
  document.getElementById('btnSize').addEventListener('input', (e)=>{
    const v = parseFloat(e.target.value || '1');
    document.documentElement.style.setProperty('--pill-scale', String(v));
    document.getElementById('btnSizeVal').textContent = `${v.toFixed(2)}Ã—`;
    localStorage.setItem('pillScale', String(v));
    // ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ã¯é«˜ã•ãŒå¤‰ã‚ã‚‹ãŸã‚å†æç”»
    drawAllSparklines();
  });

  document.getElementById('btnSettings').addEventListener('click', ()=>{
    const modal=document.getElementById('settingsModal');
    const container=document.getElementById('columnSettings');
    container.innerHTML = allColumns.map(col=>`
      <div class="column-checkbox">
        <input type="checkbox" id="col-${col.id}" ${visibleColumns.includes(col.id)?'checked':''}>
        <label for="col-${col.id}">${col.label}</label>
      </div>`).join('');
    modal.classList.add('active');
  });
  document.getElementById('btnSaveSettings').addEventListener('click',()=>{
    visibleColumns=[]; allColumns.forEach(col=>{ const cb=document.getElementById(`col-${col.id}`); if(cb && cb.checked) visibleColumns.push(col.id); });
    saveSettings(); document.getElementById('settingsModal').classList.remove('active'); renderTable();
  });
  document.getElementById('btnCloseSettings').addEventListener('click',()=>document.getElementById('settingsModal').classList.remove('active'));
  document.getElementById('btnCloseDetail').addEventListener('click',()=>document.getElementById('detailModal').classList.remove('active'));

  document.getElementById('btnExport').addEventListener('click', exportCSV);
  document.getElementById('displayCount').addEventListener('change', e=>{displayLimit=parseInt(e.target.value,10); saveDisplayLimit(); renderTable();});

  // æœŸé–“ãƒ¢ãƒ¼ãƒ‰
  function setManualMode(mode){
    autoRangeActive=false;
    sparkMode=mode;
    lastManualSparkMode=mode;
    document.getElementById('mode7').classList.toggle('active', mode==='7d');
    document.getElementById('mode30').classList.toggle('active', mode==='30d');
    document.getElementById('mode24').classList.toggle('active', mode==='24h');
    drawAllSparklines();
  }
  document.getElementById('mode7').addEventListener('click', ()=>setManualMode('7d'));
  document.getElementById('mode30').addEventListener('click',()=>setManualMode('30d'));
  document.getElementById('mode24').addEventListener('click',()=>setManualMode('24h'));
  setManualMode('7d');

  // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼ˆåˆè¨ˆ/ç©ã¿ä¸Šã’ï¼‰
  function setViewMode(mode){
    viewMode = mode;
    document.getElementById('viewTotal').classList.toggle('active', mode==='total');
    document.getElementById('viewStack').classList.toggle('active', mode==='stack');
    drawAllSparklines();
  }
  document.getElementById('viewTotal').addEventListener('click', ()=>setViewMode('total'));
  document.getElementById('viewStack').addEventListener('click', ()=>setViewMode('stack'));

  // ã‚¯ã‚¤ãƒƒã‚¯æœŸé–“
  document.getElementById('btnYesterday').addEventListener('click',()=>{
    const y=getPreviousBusinessDay(); dateFromStr=y; dateToStr=y;
    document.getElementById('dateFrom').value=y; document.getElementById('dateTo').value=y;
    document.getElementById('btnYesterday').classList.add('active'); document.getElementById('btnToday').classList.remove('active');
    autoRangeActive=true; drawAllSparklines();
    applyFilters();
  });
  document.getElementById('btnToday').addEventListener('click',()=>{
    const t=getToday(); dateFromStr=t; dateToStr=t;
    document.getElementById('dateFrom').value=t; document.getElementById('dateTo').value=t;
    document.getElementById('btnToday').classList.add('active'); document.getElementById('btnYesterday').classList.remove('active');
    autoRangeActive=true; drawAllSparklines();
    applyFilters();
  });

  // ä»»æ„æœŸé–“
  function onDateChange(){
    const f=document.getElementById('dateFrom').value||null;
    const t=document.getElementById('dateTo').value||null;
    dateFromStr=f; dateToStr=t;
    document.getElementById('btnYesterday').classList.remove('active');
    document.getElementById('btnToday').classList.remove('active');
    if(f || t){ autoRangeActive=true; } else { autoRangeActive=false; sparkMode=lastManualSparkMode; }
    drawAllSparklines();
    applyFilters();
  }
  document.getElementById('dateFrom').addEventListener('change', onDateChange);
  document.getElementById('dateTo').addEventListener('change', onDateChange);

  document.getElementById('btnClearDate').addEventListener('click',()=>{
    dateFromStr=null; dateToStr=null;
    document.getElementById('dateFrom').value=''; document.getElementById('dateTo').value='';
    document.getElementById('btnYesterday').classList.remove('active'); document.getElementById('btnToday').classList.remove('active');
    autoRangeActive=false; sparkMode=lastManualSparkMode;
    drawAllSparklines();
    applyFilters();
  });

  // ä¸€æ‹¬è§£é™¤
  document.getElementById('btnClearAll').addEventListener('click',()=>{
    selectedDepts.clear(); selectedLines.clear(); selectedSerials.clear();
    document.querySelectorAll('.btn-pill.active').forEach(b=>b.classList.remove('active'));
    // å±•é–‹ãƒ‘ãƒãƒ«é–‰ã˜
    document.getElementById('expandPanel').classList.remove('open');
    document.getElementById('linesGrid').innerHTML='';
    document.getElementById('serialsGrid').innerHTML='';
    document.getElementById('serialsHolder').style.display='none';
    const selCounter = document.getElementById('selCounter'); if(selCounter) selCounter.textContent='';
    applyFilters();
    drawAllSparklines();
  });

  // ãƒ•ã‚£ãƒ«ã‚¿/ã‚½ãƒ¼ãƒˆãƒªã‚»ãƒƒãƒˆ
  document.getElementById('btnResetFilters').addEventListener('click',()=>{
    selectedDepts.clear(); selectedLines.clear(); selectedSerials.clear();
    document.querySelectorAll('.btn-pill.active').forEach(b=>b.classList.remove('active'));
    dateFromStr=null; dateToStr=null;
    document.getElementById('dateFrom').value=''; document.getElementById('dateTo').value='';
    document.getElementById('btnYesterday').classList.remove('active'); document.getElementById('btnToday').classList.remove('active');
    autoRangeActive=false; sparkMode=lastManualSparkMode||'7d';
    const selCounter = document.getElementById('selCounter'); if(selCounter) selCounter.textContent='';
    drawAllSparklines();
    applyFilters();
  });
  document.getElementById('btnResetSort').addEventListener('click',()=>{ currentSort={column:null,direction:'asc'}; renderTable(); });

  // é–‰ã˜ã‚‹
  document.getElementById('btnClosePanel').addEventListener('click', ()=>{
    document.getElementById('expandPanel').classList.remove('open');
    document.getElementById('linesGrid').innerHTML='';
    document.getElementById('serialsGrid').innerHTML='';
    document.getElementById('serialsHolder').style.display='none';
  });

  // åˆæœŸåŒ–
  (async()=>{
    const ok=await checkAuth(); if(!ok){ alert('èªè¨¼ãŒå¿…è¦ã§ã™'); return; }
    loadSettings();
    await loadData();
  })();
</script>
</body>
</html>