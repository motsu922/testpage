<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•°å¸¸å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆï¼ˆéšå±¤ãƒ•ã‚£ãƒ«ã‚¿ç‰ˆï¼‰</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Hiragino Sans',sans-serif;background:#f5f5f7;color:#1d1d1f}

  .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.1);position:sticky;top:0;z-index:100}
  .header-content{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
  .header h1{font-size:1.5rem;font-weight:600}
  .header-actions{display:flex;gap:10px}
  .btn-header{background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);color:#fff;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:500;transition:.2s}
  .btn-header:hover{background:rgba(255,255,255,.3)}

  .container{max-width:1400px;margin:0 auto;padding:20px}

  /* æœŸé–“é¸æŠ */
  .date-filter{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
  .date-filter-header{font-size:1.1rem;font-weight:600;color:#667eea;margin-bottom:16px}
  .date-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .date-input-group{display:flex;gap:8px;align-items:center}
  .date-input-group input[type="date"]{padding:10px 14px;border:2px solid #e0e0e0;border-radius:8px;font-size:.95rem;transition:.2s}
  .date-input-group input[type="date"]:focus{outline:none;border-color:#667eea}
  .date-quick-btn{padding:10px 20px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:8px;cursor:pointer;font-weight:600;transition:.2s;white-space:nowrap}
  .date-quick-btn:hover{background:#f8f9ff}
  .date-quick-btn.active{background:#667eea;color:#fff}

  /* éƒ¨ç½²â†’ãƒ©ã‚¤ãƒ³â†’æ•´ç†No ã®éšå±¤ãƒ•ã‚£ãƒ«ã‚¿ */
  .dept-filter{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
  .dept-filter-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  .dept-filter-title{font-size:1.1rem;font-weight:600;color:#667eea}
  .btn-tool{padding:8px 16px;border:1px solid #e0e0e0;background:#fff;border-radius:6px;cursor:pointer;font-weight:500;transition:.2s}
  .btn-tool:hover{border-color:#667eea;background:#f8f9ff}

  .hier{display:flex;flex-direction:column;gap:12px}
  .dept-group{border:1px solid #e6e8ef;border-radius:10px;padding:12px}
  .dept-header{display:flex;gap:12px;align-items:center;flex-wrap:wrap; margin-bottom:10px}

  .btn-pill{
    position:relative; overflow:hidden;
    padding:14px 18px; border:2px solid #e0e0e0; background:#fff; border-radius:10px;
    cursor:pointer; font-size:1rem; font-weight:700; transition:.2s; text-align:center; color:#1d1d1f;
  }
  .btn-pill:hover{border-color:#667eea;background:#f8f9ff}
  .btn-pill.active{border-color:#667eea;background:#667eea;color:#fff}

  /* ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ï¼ˆä¸­å¤®é‡ã­ï¼‰ */
  .btn-pill .sparkline{position:absolute; top:50%; left:6px; right:6px; transform:translateY(-50%); height:44px; opacity:.5; pointer-events:none; z-index:0}
  .btn-pill > .title, .btn-pill > .sub{position:relative; z-index:1}
  .btn-pill .title{text-align:center}
  .btn-pill .sub{font-size:.85rem; opacity:.8; margin-top:3px}

  .line-panel, .serial-panel{display:none; padding:8px 4px 4px}
  .line-panel.open, .serial-panel.open{display:block}

  .lines-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:10px}
  .serials-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:8px}

  /* ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ */
  .datasheet-container{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);overflow:hidden}
  .datasheet-toolbar{padding:16px 20px;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center;background:#f8f9fa;flex-wrap:wrap;gap:12px}
  .result-count{font-size:1rem;color:#666}
  .result-count strong{color:#667eea;font-size:1.2rem}
  .display-count-selector{display:flex;align-items:center;gap:8px}
  .display-count-selector select{padding:6px 12px;border:2px solid #e0e0e0;border-radius:6px;background:#fff;cursor:pointer;font-size:.9rem;transition:.2s}
  .display-count-selector select:focus{outline:none;border-color:#667eea}
  .table-wrapper{overflow-x:auto;max-height:calc(100vh - 400px);position:relative}
  table{width:100%;border-collapse:collapse;font-size:.9rem}
  thead{position:sticky;top:0;z-index:10;background:#fff}
  th{padding:12px 16px;text-align:left;background:#667eea;color:#fff;font-weight:600;white-space:nowrap;cursor:pointer;user-select:none;position:relative}
  th:hover{background:#5568d3}
  th.sortable::after{content:'â‡…';margin-left:8px;opacity:.4}
  th.sort-asc::after{content:'â†‘';opacity:1}
  th.sort-desc::after{content:'â†“';opacity:1}
  td{padding:12px 16px;border-bottom:1px solid #f0f0f0}
  tr{cursor:pointer;transition:background .15s}
  tbody tr:hover{background:#f8f9ff}
  .status-badge{display:inline-block;padding:4px 12px;border-radius:12px;font-size:.85rem;font-weight:600}
  .status-pending{background:#fff3cd;color:#856404}
  .status-complete{background:#d4edda;color:#155724}
  .photo-btn{background:#2196f3;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:.85rem;font-weight:600;transition:.2s}
  .photo-btn:hover{background:#1976d2}
  .photo-btn:disabled{background:#ccc;cursor:not-allowed}

  /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆçœç•¥â€¦æ—¢å­˜åŒç­‰ï¼‰ */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
  .modal.active{display:flex}
  .modal-content{background:#fff;border-radius:16px;max-width:900px;width:95%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)}
  .modal-header{padding:24px;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:#fff;z-index:10}
  .modal-title{font-size:1.3rem;font-weight:600;color:#667eea}
  .btn-close{background:#f0f0f0;border:none;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1.2rem;color:#666;transition:.2s}
  .btn-close:hover{background:#e0e0e0}
  .modal-body{padding:24px}
  .empty-state{text-align:center;padding:60px 20px;color:#999}
  .empty-icon{font-size:3rem;margin-bottom:16px}

  @media (max-width:768px){
    .date-controls{flex-direction:column;align-items:stretch}
    .date-input-group{flex-direction:column}
    .date-quick-btn{width:100%}
  }
</style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>ğŸ“Š ç•°å¸¸å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆï¼ˆéšå±¤ãƒ•ã‚£ãƒ«ã‚¿ï¼‰</h1>
      <div class="header-actions">
        <button class="btn-header" id="btnSettings">âš™ï¸ è¡¨ç¤ºè¨­å®š</button>
        <button class="btn-header" id="btnExport">ğŸ“¥ CSVå‡ºåŠ›</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- æœŸé–“é¸æŠ -->
    <div class="date-filter">
      <div class="date-filter-header">ğŸ“… æœŸé–“ã§çµã‚Šè¾¼ã¿</div>
      <div class="date-controls">
        <button class="date-quick-btn" id="btnYesterday">å‰æ—¥ï¼ˆå¹³æ—¥ï¼‰</button>
        <button class="date-quick-btn" id="btnToday">ä»Šæ—¥</button>
        <div class="date-input-group">
          <input type="date" id="dateFrom" placeholder="é–‹å§‹æ—¥">
          <span style="color:#999;">ã€œ</span>
          <input type="date" id="dateTo" placeholder="çµ‚äº†æ—¥">
        </div>
        <button class="btn-tool" id="btnClearDate">æœŸé–“ã‚¯ãƒªã‚¢</button>
      </div>
    </div>

    <!-- éšå±¤ãƒ•ã‚£ãƒ«ã‚¿ -->
    <div class="dept-filter">
      <div class="dept-filter-header">
        <div class="dept-filter-title">ğŸ¢ éƒ¨ç½² â†’ ãƒ©ã‚¤ãƒ³ â†’ æ•´ç†No ã§çµã‚Šè¾¼ã¿ï¼ˆè¤‡æ•°é¸æŠå¯ï¼ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn-tool" id="btnClearSerials">æ•´ç†Noè§£é™¤</button>
          <button class="btn-tool" id="btnClearLines">ãƒ©ã‚¤ãƒ³è§£é™¤</button>
          <button class="btn-tool" id="btnClearDept">éƒ¨ç½²è§£é™¤</button>
          <button class="btn-tool" id="btnCollapseAll">å…¨éƒ¨ãŸãŸã‚€</button>
        </div>
      </div>
      <div class="hier" id="hierRoot"><!-- å‹•çš„ç”Ÿæˆ --></div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ -->
    <div class="datasheet-container">
      <div class="datasheet-toolbar">
        <div class="result-count">è¡¨ç¤ºä¸­: <strong id="resultCount">0</strong> ä»¶ / å…¨ <strong id="totalCount">0</strong> ä»¶</div>
        <div class="display-count-selector">
          <label for="displayCount">è¡¨ç¤ºä»¶æ•°:</label>
          <select id="displayCount">
            <option value="25">25ä»¶</option><option value="50">50ä»¶</option>
            <option value="75">75ä»¶</option><option value="100">100ä»¶</option>
          </select>
        </div>
        <div class="toolbar-actions">
          <button class="btn-tool" id="btnResetFilters">ğŸ”„ ãƒ•ã‚£ãƒ«ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
          <button class="btn-tool" id="btnResetSort">â†•ï¸ ã‚½ãƒ¼ãƒˆãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
      <div class="table-wrapper">
        <table id="dataTable">
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="detailTitle">è©³ç´°æƒ…å ±</div>
        <button class="btn-close" id="btnCloseDetail">Ã—</button>
      </div>
      <div class="modal-body" id="detailBody"></div>
    </div>
  </div>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">âš™ï¸ è¡¨ç¤ºé …ç›®è¨­å®š</div>
        <button class="btn-close" id="btnCloseSettings">Ã—</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom:16px;color:#666;">è¡¨ç¤ºã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        <div class="settings-grid" id="columnSettings"></div>
        <button class="btn-header" style="width:100%;margin-top:20px;padding:12px;background:#667eea;border:none;font-size:1rem;" id="btnSaveSettings">ä¿å­˜</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
  import { getFirestore, collection, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyA0YUIpIDh4WB4p1ewiNB0XfwHve0ByljU",
    authDomain: "abnreport-fd733.firebaseapp.com",
    databaseURL: "https://abnreport-fd733-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "abnreport-fd733",
    storageBucket: "abnreport-fd733.firebasestorage.app",
    messagingSenderId: "349748947315",
    appId: "1:349748947315:web:010cb671d2a95bcf1f7d06"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth= getAuth(app);

  // ====== çŠ¶æ…‹ ======
  let allData = [];
  let filteredData = [];
  let dateFromStr = null, dateToStr = null;

  // é¸æŠçŠ¶æ…‹ï¼ˆè¤‡æ•°å¯ï¼‰
  const selectedDepts   = new Set();                // "DEPT"
  const selectedLines   = new Set();                // "DEPT||LINE"
  const selectedSerials = new Set();                // "DEPT||LINE||SERIAL"

  let currentSort = { column:null, direction:'asc' };

  // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
  const pad2 = n => String(n).padStart(2,'0');
  function formatDate(d){return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;}
  function getToday(){return formatDate(new Date());}
  function getPreviousBusinessDay(){
    const date=new Date();const dow=date.getDay();
    if(dow===1) date.setDate(date.getDate()-3);
    else if(dow===0) date.setDate(date.getDate()-2);
    else date.setDate(date.getDate()-1);
    return formatDate(date);
  }
  function toStartOfDayMs(y,m,d){return Date.UTC(y,m-1,d,0,0,0,0);}

  function normalizeWide(s){return s.replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g,ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0)).replace(/ã€€/g,' ').trim();}
  function normalizeDeptName(s){s = (s??'').toString(); return normalizeWide(s).toUpperCase() || 'æœªè¨­å®š';}
  function normalizeLineName(s){s = (s??'').toString(); return normalizeWide(s) || 'æœªè¨­å®š';}

  // æ—¥ä»˜ã®ã‚†ã‚Œâ†’ {iso, valueMs}
  function parseDateFlexible(v){
    if(!v) return {iso:null, value:null};
    let d=null;
    if(typeof v==='object'){
      if(typeof v.toDate==='function') d=v.toDate();
      else if('seconds'in v&&'nanoseconds'in v) d=new Date(v.seconds*1000+Math.round(v.nanoseconds/1e6));
    }
    if(!d && v instanceof Date) d=v;
    if(!d && typeof v==='number') d=new Date(v);
    if(!d && typeof v==='string'){
      const s=v.trim();
      let m=s.match(/^(\d{4})[.\-\/å¹´](\d{1,2})[.\-\/æœˆ](\d{1,2})(?:æ—¥)?$/);
      if(m) d=new Date(Date.UTC(+m[1],+m[2]-1,+m[3]));
      if(!d){ m=s.match(/^(\d{2})[.\-\/å¹´](\d{1,2})[.\-\/æœˆ](\d{1,2})(?:æ—¥)?$/); if(m) d=new Date(Date.UTC(2000+(+m[1]),+m[2]-1,+m[3])); }
      if(!d){ m=s.match(/^(\d{4})(\d{2})(\d{2})$/); if(m) d=new Date(Date.UTC(+m[1],+m[2]-1,+m[3])); }
      if(!d){ const p=Date.parse(s); if(!Number.isNaN(p)) d=new Date(p); }
    }
    if(!d || Number.isNaN(d.getTime())) return {iso:null,value:null};
    const y=d.getUTCFullYear(), m=d.getUTCMonth()+1, dd=d.getUTCDate();
    return {iso:`${y}-${pad2(m)}-${pad2(dd)}`, value:toStartOfDayMs(y,m,dd)};
  }

  // æ™‚åˆ»ã®ã‚†ã‚Œ â†’ HH:MM
  function normalizeTime(v){
    if(!v) return null; const s=String(v).trim();
    let m=s.match(/^(\d{1,2}):(\d{1,2})$/);
    if(m){ return `${pad2(Math.min(+m[1],23))}:${pad2(Math.min(+m[2],59))}`; }
    m=s.match(/(\d{1,2})\D+(\d{1,2})/);
    if(m){ return `${pad2(Math.min(+m[1],23))}:${pad2(Math.min(+m[2],59))}`; }
    m=s.match(/^(\d{3,4})$/);
    if(m){ const raw=m[1].padStart(4,'0'); return `${pad2(Math.min(+raw.slice(0,2),23))}:${pad2(Math.min(+raw.slice(2,4),59))}`; }
    return null;
  }

  // ç›´è¿‘næ—¥ï¼ˆUTC 00:00ï¼‰ã®é…åˆ—ï¼ˆå¤â†’æ–°ï¼‰
  function buildLastNDaysUTC(n=7){
    const today=new Date();
    const base=Date.UTC(today.getUTCFullYear(),today.getUTCMonth(),today.getUTCDate(),0,0,0,0);
    const arr=[]; for(let i=n-1;i>=0;i--) arr.push(base - i*86400000);
    return arr;
  }

  // ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³æç”»ï¼ˆBæ¡ˆï¼šè‰²æŒ‡å®šï¼‰
  function drawSparkline(canvas, values, color='rgba(66,133,244,0.65)', pointColor=color){
    if(!canvas) return;
    const dpr=window.devicePixelRatio||1;
    const cssW=canvas.clientWidth||120, cssH=canvas.clientHeight||44;
    canvas.width=Math.max(1,Math.floor(cssW*dpr));
    canvas.height=Math.max(1,Math.floor(cssH*dpr));
    const ctx=canvas.getContext('2d'); if(!ctx) return;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.lineWidth=2*dpr;

    const n=values.length; if(!n) return;
    const max=Math.max(...values), min=Math.min(...values);
    const pad=3*dpr; const xStep=n>1?(canvas.width-pad*2)/(n-1):0;

    // baseline
    ctx.strokeStyle='rgba(0,0,0,0.12)';
    ctx.beginPath(); ctx.moveTo(pad, canvas.height-pad); ctx.lineTo(canvas.width-pad, canvas.height-pad); ctx.stroke();

    // line
    ctx.strokeStyle=color; ctx.beginPath();
    for(let i=0;i<n;i++){
      const v=values[i];
      const ratio=(max===min)?0.5:(v-min)/(max-min);
      const x=pad+xStep*i;
      const y=canvas.height-pad - ratio*(canvas.height-pad*2);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    // end point
    ctx.fillStyle=pointColor;
    const lastX=pad+xStep*(n-1);
    const lastV=values[n-1];
    const lastR=(max===min)?0.5:(lastV-min)/(max-min);
    const lastY=canvas.height-pad - lastR*(canvas.height-pad*2);
    ctx.beginPath(); ctx.arc(lastX,lastY,2.5*dpr,0,Math.PI*2); ctx.fill();
  }

  // ====== åˆ—å®šç¾©ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ ======
  const allColumns=[
    {id:'serialNo',label:'æ•´ç†No',sortable:true,filterable:true},
    {id:'department',label:'éƒ¨ç½²',sortable:true,filterable:true},
    {id:'lineName',label:'ãƒ©ã‚¤ãƒ³',sortable:true,filterable:true},
    {id:'occurrenceDate',label:'ç™ºç”Ÿæ—¥',sortable:true,filterable:true},
    {id:'occurrenceTime',label:'ç™ºç”Ÿæ™‚åˆ»',sortable:true,filterable:false},
    {id:'restartTime',label:'å†é–‹æ™‚åˆ»',sortable:true,filterable:false},
    {id:'stopMinutes',label:'åœæ­¢æ™‚é–“',sortable:true,filterable:false},
    {id:'handler',label:'å‡¦ç½®è€…',sortable:true,filterable:true},
    {id:'techHandler',label:'æŠ€è¡“å‡¦ç½®è€…',sortable:true,filterable:true},
    {id:'status',label:'çŠ¶æ…‹',sortable:true,filterable:true},
    {id:'photos',label:'å†™çœŸ',sortable:true,filterable:false},
    {id:'anomalyContent',label:'ç•°å¸¸å†…å®¹',sortable:false,filterable:true},
    {id:'actionTaken',label:'å¯¾å¿œå†…å®¹',sortable:false,filterable:true},
  ];
  let visibleColumns=['serialNo','department','lineName','occurrenceDate','occurrenceTime','stopMinutes','handler','photos','status'];
  let displayLimit=25;

  // ====== èªè¨¼ãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ ======
  async function checkAuth(){
    return new Promise(resolve=>{
      onAuthStateChanged(auth,(user)=>{
        if(user) resolve(true);
        else{
          const email=prompt('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          const password=prompt('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          if(email && password){
            setPersistence(auth,browserLocalPersistence)
              .then(()=>signInWithEmailAndPassword(auth,email,password))
              .then(()=>resolve(true))
              .catch(e=>{alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: '+e.message); resolve(false);});
          }else resolve(false);
        }
      });
    });
  }

  async function loadData(){
    const q=query(collection(db,'anomalies'), orderBy('createdAt','desc'));
    const snap=await getDocs(q);
    allData=snap.docs.map(doc=>{
      const raw={_id:doc.id, ...doc.data()};
      const deptNorm=normalizeDeptName(raw.department);
      const lineNorm=normalizeLineName(raw.lineName);
      const occ=parseDateFlexible(raw.occurrenceDate||raw.occurrence_at||raw.date);
      const occTime=normalizeTime(raw.occurrenceTime);
      const resTime=normalizeTime(raw.restartTime);
      let stop=null;
      if(occTime && resTime){
        const [oh,om]=occTime.split(':').map(Number);
        const [rh,rm]=resTime.split(':').map(Number);
        let diff=(rh*60+rm)-(oh*60+om);
        if(diff<0) diff+=1440;
        stop=diff;
      }
      return {
        ...raw,
        departmentNormalized:deptNorm,
        lineNameNormalized:lineNorm,
        occurrenceDateISO:occ.iso,
        occurrenceDateValue:occ.value,
        occurrenceTimeNorm:occTime,
        restartTimeNorm:resTime,
        stopMinutes:stop
      };
    });
    renderHierarchy();   // éƒ¨ç½²â†’ãƒ©ã‚¤ãƒ³â†’æ•´ç†No
    applyFilters();      // ãƒ†ãƒ¼ãƒ–ãƒ«
  }

  // ====== ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ç”¨ã‚·ãƒªãƒ¼ã‚ºæ§‹ç¯‰ ======
  function buildSeriesMaps(data){
    const days=buildLastNDaysUTC(7);
    const ONE=86400000;
    const dayIndex=new Map(); days.forEach((ms,i)=>dayIndex.set(ms,i));

    const deptSeries=new Map();                 // dept -> [7]
    const lineSeries=new Map();                 // dept -> Map(line -> [7])
    const serialSeries=new Map();               // dept -> Map(line -> Map(serial -> [7]))

    for(const it of data){
      const dept=it.departmentNormalized || 'æœªè¨­å®š';
      const line=it.lineNameNormalized    || 'æœªè¨­å®š';
      const ser =it.serialNo || 'æœªè¨­å®š';
      let occ=it.occurrenceDateValue;
      if(occ==null && it.occurrenceDateISO){ const [y,m,d]=it.occurrenceDateISO.split('-').map(Number); occ=toStartOfDayMs(y,m,d); }
      if(occ==null) continue;

      const first=days[0], last=days[days.length-1]+ONE-1;
      if(occ<first || occ>last) continue;

      const align=occ - (occ%ONE);
      let idx=dayIndex.get(align);
      if(idx==null){
        for(let i=0;i<days.length;i++){ if(Math.abs(days[i]-align)<=43200000){ idx=i; break; } }
        if(idx==null) continue;
      }

      // dept
      if(!deptSeries.has(dept)) deptSeries.set(dept, Array(days.length).fill(0));
      deptSeries.get(dept)[idx]+=1;

      // line
      if(!lineSeries.has(dept)) lineSeries.set(dept,new Map());
      if(!lineSeries.get(dept).has(line)) lineSeries.get(dept).set(line, Array(days.length).fill(0));
      lineSeries.get(dept).get(line)[idx]+=1;

      // serial
      if(!serialSeries.has(dept)) serialSeries.set(dept,new Map());
      if(!serialSeries.get(dept).has(line)) serialSeries.get(dept).set(line,new Map());
      if(!serialSeries.get(dept).get(line).has(ser)) serialSeries.get(dept).get(line).set(ser, Array(days.length).fill(0));
      serialSeries.get(dept).get(line).get(ser)[idx]+=1;
    }

    return {days, deptSeries, lineSeries, serialSeries};
  }

  // ====== éšå±¤ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ======
  function renderHierarchy(){
    const root=document.getElementById('hierRoot');
    // ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ã¯å…¨ä»¶ãƒ™ãƒ¼ã‚¹ï¼šå¿…è¦ãªã‚‰ filteredData ã«å¤‰ãˆã‚‹
    // const base = filteredData; // â†æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿é€£å‹•ã«ã™ã‚‹ãªã‚‰ã“ã¡ã‚‰ã«åˆ‡æ›¿
    const base = allData;

    // ä»¶æ•°é›†è¨ˆ
    const counts = new Map(); // dept -> {total, lines: Map(line -> {total, serials: Map(serial -> total)})}
    for(const it of base){
      const d=it.departmentNormalized||'æœªè¨­å®š';
      const l=it.lineNameNormalized||'æœªè¨­å®š';
      const s=it.serialNo||'æœªè¨­å®š';
      if(!counts.has(d)) counts.set(d,{total:0, lines:new Map()});
      counts.get(d).total++;
      if(!counts.get(d).lines.has(l)) counts.get(d).lines.set(l,{total:0, serials:new Map()});
      counts.get(d).lines.get(l).total++;
      const mp=counts.get(d).lines.get(l).serials;
      mp.set(s,(mp.get(s)||0)+1);
    }

    const {deptSeries,lineSeries,serialSeries}=buildSeriesMaps(base);
    const depts=[...counts.keys()].sort();

    // éƒ¨ç½²ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«HTMLç”Ÿæˆ
    root.innerHTML = depts.map(dept=>{
      const total=counts.get(dept).total;
      const activeClass = selectedDepts.has(dept)?'active':'';
      // ãƒ©ã‚¤ãƒ³å±¤
      const lines=[...counts.get(dept).lines.keys()].sort();
      const lineHTML = lines.map(line=>{
        const ltotal=counts.get(dept).lines.get(line).total;
        const lk=`${dept}||${line}`;
        const lactive=selectedLines.has(lk)?'active':'';
        // æ•´ç†Noå±¤
        const serials=[...counts.get(dept).lines.get(line).serials.keys()].sort();
        const serialHTML = serials.map(sn=>{
          const stotal=counts.get(dept).lines.get(line).serials.get(sn);
          const sk=`${dept}||${line}||${sn}`;
          const sactive=selectedSerials.has(sk)?'active':'';
          return `
            <div class="btn-pill ${sactive}" data-role="serial" data-dept="${dept}" data-line="${line}" data-serial="${sn}">
              <canvas class="sparkline"></canvas>
              <div class="title">${sn}</div>
              <div class="sub">${stotal}ä»¶</div>
            </div>`;
        }).join('');
        return `
          <div class="line-block">
            <div class="btn-pill ${lactive}" data-role="line" data-dept="${dept}" data-line="${line}">
              <canvas class="sparkline"></canvas>
              <div class="title">${line}</div>
              <div class="sub">${ltotal}ä»¶</div>
            </div>
            <div class="serial-panel" data-owner="${dept}||${line}">
              <div class="serials-grid">${serialHTML}</div>
            </div>
          </div>`;
      }).join('');

      return `
        <div class="dept-group">
          <div class="dept-header">
            <div class="btn-pill ${activeClass}" data-role="dept" data-dept="${dept}">
              <canvas class="sparkline"></canvas>
              <div class="title">${dept}</div>
              <div class="sub">${total}ä»¶</div>
            </div>
          </div>
          <div class="line-panel" data-owner="${dept}">
            <div class="lines-grid">${lineHTML}</div>
          </div>
        </div>`;
    }).join('');

    // ã‚¤ãƒ™ãƒ³ãƒˆä»˜ä¸
    bindHierarchyEvents({deptSeries,lineSeries,serialSeries});
    // åˆå›ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³æç”»
    drawAllSparklines({deptSeries,lineSeries,serialSeries});
  }

  function bindHierarchyEvents(seriesMaps){
    const root=document.getElementById('hierRoot');

    // éƒ¨ç½²ã‚¯ãƒªãƒƒã‚¯ï¼šé¸æŠON/OFFï¼†ãƒ‘ãƒãƒ«é–‹é–‰
    root.querySelectorAll('[data-role="dept"]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const dept=btn.getAttribute('data-dept');
        const panel=root.querySelector(`.line-panel[data-owner="${dept}"]`);
        const isActive=btn.classList.toggle('active');
        if(isActive) selectedDepts.add(dept); else selectedDepts.delete(dept);
        // å±•é–‹ãƒˆã‚°ãƒ«
        panel.classList.toggle('open');
        applyFilters();
        redrawSparklinesForHierarchy(seriesMaps);
      });
    });

    // ãƒ©ã‚¤ãƒ³ã‚¯ãƒªãƒƒã‚¯ï¼šé¸æŠON/OFFï¼†ãƒ‘ãƒãƒ«é–‹é–‰
    root.querySelectorAll('[data-role="line"]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        const dept=btn.getAttribute('data-dept');
        const line=btn.getAttribute('data-line');
        const key =`${dept}||${line}`;
        const panel=root.querySelector(`.serial-panel[data-owner="${key}"]`);
        const isActive=btn.classList.toggle('active');
        if(isActive) selectedLines.add(key); else selectedLines.delete(key);
        panel.classList.toggle('open');
        applyFilters();
        redrawSparklinesForHierarchy(seriesMaps);
      });
    });

    // æ•´ç†Noã‚¯ãƒªãƒƒã‚¯ï¼šé¸æŠON/OFF
    root.querySelectorAll('[data-role="serial"]').forEach(btn=>{
      btn.addEventListener('click',(e)=>{
        e.stopPropagation();
        const dept=btn.getAttribute('data-dept');
        const line=btn.getAttribute('data-line');
        const sn  =btn.getAttribute('data-serial');
        const key =`${dept}||${line}||${sn}`;
        const isActive=btn.classList.toggle('active');
        if(isActive) selectedSerials.add(key); else selectedSerials.delete(key);
        applyFilters();
        redrawSparklinesForHierarchy(seriesMaps);
      });
    });

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒœã‚¿ãƒ³
    document.getElementById('btnCollapseAll').addEventListener('click', ()=>{
      root.querySelectorAll('.line-panel.open, .serial-panel.open').forEach(p=>p.classList.remove('open'));
    });
  }

  function drawAllSparklines({deptSeries,lineSeries,serialSeries}){
    const root=document.getElementById('hierRoot');
    // éƒ¨ç½²
    root.querySelectorAll('[data-role="dept"]').forEach(btn=>{
      const dept=btn.getAttribute('data-dept');
      const canvas=btn.querySelector('.sparkline');
      const vals=deptSeries.get(dept)||Array(7).fill(0);
      const active=btn.classList.contains('active');
      drawSparkline(canvas, vals,
        active?'rgba(255,255,255,0.95)':'rgba(66,133,244,0.65)',
        active?'rgba(255,255,255,0.95)':'rgba(66,133,244,0.65)');
    });
    // ãƒ©ã‚¤ãƒ³
    root.querySelectorAll('[data-role="line"]').forEach(btn=>{
      const dept=btn.getAttribute('data-dept');
      const line=btn.getAttribute('data-line');
      const canvas=btn.querySelector('.sparkline');
      const vals=(lineSeries.get(dept)?.get(line))||Array(7).fill(0);
      const active=btn.classList.contains('active');
      drawSparkline(canvas, vals,
        active?'rgba(255,255,255,0.95)':'rgba(66,133,244,0.65)',
        active?'rgba(255,255,255,0.95)':'rgba(66,133,244,0.65)');
    });
    // æ•´ç†No
    root.querySelectorAll('[data-role="serial"]').forEach(btn=>{
      const dept=btn.getAttribute('data-dept');
      const line=btn.getAttribute('data-line');
      const sn  =btn.getAttribute('data-serial');
      const canvas=btn.querySelector('.sparkline');
      const vals=(serialSeries.get(dept)?.get(line)?.get(sn))||Array(7).fill(0);
      const active=btn.classList.contains('active');
      drawSparkline(canvas, vals,
        active?'rgba(255,255,255,0.95)':'rgba(66,133,244,0.65)',
        active?'rgba(255,255,255,0.95)':'rgba(66,133,244,0.65)');
    });

    // ãƒªã‚µã‚¤ã‚ºæ™‚ã¯å†æç”»
    let timer=null;
    window.addEventListener('resize', ()=>{
      clearTimeout(timer);
      timer=setTimeout(()=>drawAllSparklines({deptSeries,lineSeries,serialSeries}), 150);
    }, {passive:true});
  }

  function redrawSparklinesForHierarchy(seriesMaps){
    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è‰²åˆ‡æ›¿ã®ãŸã‚å†æç”»
    drawAllSparklines(seriesMaps);
  }

  // ====== ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ï¼ˆéšå±¤é¸æŠï¼‹æ—¥ä»˜ï¼‰ ======
  function applyFilters(){
    let fromMs=null, toMs=null;
    if(dateFromStr && /^\d{4}-\d{2}-\d{2}$/.test(dateFromStr)){
      const [,y,m,d]=dateFromStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      fromMs=Date.UTC(+y,+m-1,+d,0,0,0,0);
    }
    if(dateToStr && /^\d{4}-\d{2}-\d{2}$/.test(dateToStr)){
      const [,y,m,d]=dateToStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      toMs=Date.UTC(+y,+m-1,+d,23,59,59,999);
    }

    filteredData = allData.filter(it=>{
      // æ—¥ä»˜
      if((fromMs!==null || toMs!==null) && (it.occurrenceDateValue==null)) return false;
      if(fromMs!==null && it.occurrenceDateValue<fromMs) return false;
      if(toMs!==null   && it.occurrenceDateValue>toMs)   return false;

      const dept=it.departmentNormalized||'æœªè¨­å®š';
      const line=it.lineNameNormalized||'æœªè¨­å®š';
      const sn  =it.serialNo||'æœªè¨­å®š';

      // éšå±¤é¸æŠï¼ˆæ·±ã„é¸æŠãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’å„ªå…ˆï¼‰
      if(selectedSerials.size>0){
        const key=`${dept}||${line}||${sn}`;
        if(!selectedSerials.has(key)) return false;
      }else if(selectedLines.size>0){
        const key=`${dept}||${line}`;
        if(!selectedLines.has(key)) return false;
      }else if(selectedDepts.size>0){
        if(!selectedDepts.has(dept)) return false;
      }
      return true;
    });

    if(currentSort.column) applySorting();
    else renderTable();
  }

  // ====== ãƒ†ãƒ¼ãƒ–ãƒ«æç”»ãƒ»ã‚½ãƒ¼ãƒˆ ======
  function renderTable(){
    const thead=document.getElementById('tableHead');
    const tbody=document.getElementById('tableBody');
    const columns=allColumns.filter(c=>visibleColumns.includes(c.id));

    thead.innerHTML = `<tr>${
      columns.map(col=>`
        <th class="${col.sortable?'sortable':''} ${currentSort.column===col.id?('sort-'+currentSort.direction):''}" data-column="${col.id}">
          ${col.label}${col.filterable?'<span class="filter-icon">ğŸ”</span>':''}
        </th>`).join('')}</tr>`;

    thead.querySelectorAll('th.sortable').forEach(th=>{
      th.addEventListener('click', ()=>{
        const col=th.getAttribute('data-column');
        if(currentSort.column===col) currentSort.direction = currentSort.direction==='asc'?'desc':'asc';
        else { currentSort.column=col; currentSort.direction='asc'; }
        applySorting();
      });
    });

    const display=filteredData.slice(0, displayLimit);
    if(display.length===0){
      tbody.innerHTML = `<tr><td colspan="${columns.length}">
        <div class="empty-state"><div class="empty-icon">ğŸ“­</div><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div></td></tr>`;
    }else{
      tbody.innerHTML = display.map(item=>`
        <tr data-id="${item._id}">
          ${columns.map(col=>{
            let v=item[col.id]??'-';
            if(col.id==='occurrenceDate') v=item.occurrenceDateISO||'-';
            else if(col.id==='occurrenceTime') v=item.occurrenceTimeNorm||'-';
            else if(col.id==='restartTime') v=item.restartTimeNorm||'-';
            else if(col.id==='status'){
              const t=item.status==='complete'?'å®Œäº†':'æŠ€è¡“å…¥åŠ›å¾…ã¡';
              const cls=item.status==='complete'?'status-complete':'status-pending';
              v=`<span class="status-badge ${cls}">${t}</span>`;
            }else if(col.id==='photos'){
              const m=(item.mfgPhotoUrls||[]).length, t=(item.techPhotoUrls||[]).length;
              const total=m+t; v = total>0?`<button class="photo-btn" onclick="event.stopPropagation(); showPhotosOnly('${item._id}')">ğŸ“· ${total}æš</button>`:'-';
            }else if(col.id==='stopMinutes' && item.stopMinutes!=null){ v=`${item.stopMinutes}åˆ†`; }
            else if(col.id==='anomalyContent'||col.id==='actionTaken'){ const s=v||''; v=(s.length>30?s.slice(0,30)+'...':s); }
            return `<td>${v}</td>`;
          }).join('')}
        </tr>`).join('');
      tbody.querySelectorAll('tr').forEach(tr=>tr.addEventListener('click',()=>showDetail(tr.getAttribute('data-id'))));
    }

    document.getElementById('resultCount').textContent=display.length;
    document.getElementById('totalCount').textContent=filteredData.length;
  }

  function applySorting(){
    const col=currentSort.column, dir=currentSort.direction;
    filteredData.sort((a,b)=>{
      let A,B;
      if(col==='occurrenceDate'){A=a.occurrenceDateValue??-Infinity; B=b.occurrenceDateValue??-Infinity;}
      else if(col==='occurrenceTime'){A=a.occurrenceTimeNorm??''; B=b.occurrenceTimeNorm??'';}
      else if(col==='restartTime'){A=a.restartTimeNorm??''; B=b.restartTimeNorm??'';}
      else if(col==='stopMinutes'){A=a.stopMinutes??-Infinity; B=b.stopMinutes??-Infinity;}
      else {A=a[col]??''; B=b[col]??'';}
      if(A<B) return dir==='asc'?-1:1;
      if(A>B) return dir==='asc'?1:-1;
      return 0;
    });
    renderTable();
  }

  // ====== CSV ======
  function exportCSV(){
    const cols=allColumns.filter(c=>visibleColumns.includes(c.id));
    const headers=cols.map(c=>c.label);
    let csv='\uFEFF'+headers.join(',')+'\n';
    filteredData.forEach(it=>{
      const row=cols.map(col=>{
        let v=it[col.id]??'';
        if(col.id==='occurrenceDate') v=it.occurrenceDateISO||'';
        else if(col.id==='occurrenceTime') v=it.occurrenceTimeNorm||'';
        else if(col.id==='restartTime') v=it.restartTimeNorm||'';
        else if(col.id==='status') v=(it.status==='complete'?'å®Œäº†':'æŠ€è¡“å…¥åŠ›å¾…ã¡');
        else if(col.id==='stopMinutes' && it.stopMinutes!=null) v=it.stopMinutes;
        return `"${String(v).replace(/"/g,'""')}"`;
      });
      csv+=row.join(',')+'\n';
    });
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const link=document.createElement('a');
    link.href=URL.createObjectURL(blob);
    link.download=`ç•°å¸¸å±¥æ­´_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
  }

  // ====== è©³ç´°ãƒ»å†™çœŸ ======
  function showDetail(id){
    const item=allData.find(x=>x._id===id); if(!item) return;
    const modal=document.getElementById('detailModal');
    const title=document.getElementById('detailTitle');
    const body =document.getElementById('detailBody');
    title.textContent=`æ•´ç†No: ${item.serialNo||'-'}`;
    const mfg=item.mfgPhotoUrls||[], tech=item.techPhotoUrls||[];
    body.innerHTML=`
      <div class="detail-section"><div class="section-title">ğŸ“‹ åŸºæœ¬æƒ…å ±</div>
        <div class="detail-grid">
          <div><div class="detail-label">æ•´ç†No</div><div class="detail-value">${item.serialNo||'-'}</div></div>
          <div><div class="detail-label">éƒ¨ç½²</div><div class="detail-value">${item.department||'-'}</div></div>
          <div><div class="detail-label">ãƒ©ã‚¤ãƒ³</div><div class="detail-value">${item.lineName||'-'}</div></div>
          <div><div class="detail-label">ç™ºç”Ÿæ—¥</div><div class="detail-value">${item.occurrenceDateISO||'-'}</div></div>
          <div><div class="detail-label">ç™ºç”Ÿæ™‚åˆ»</div><div class="detail-value">${item.occurrenceTimeNorm||'-'}</div></div>
          <div><div class="detail-label">å†é–‹æ™‚åˆ»</div><div class="detail-value">${item.restartTimeNorm||'-'}</div></div>
          <div><div class="detail-label">åœæ­¢æ™‚é–“</div><div class="detail-value">${item.stopMinutes!=null?item.stopMinutes+'åˆ†':'-'}</div></div>
          <div><div class="detail-label">å‡¦ç½®è€…</div><div class="detail-value">${item.handler||'-'}</div></div>
          <div><div class="detail-label">çŠ¶æ…‹</div><div class="detail-value">
            <span class="status-badge ${item.status==='complete'?'status-complete':'status-pending'}">${item.status==='complete'?'å®Œäº†':'æŠ€è¡“å…¥åŠ›å¾…ã¡'}</span>
          </div></div>
        </div>
      </div>
      <div class="detail-section"><div class="section-title">ğŸš¨ ç•°å¸¸å†…å®¹</div><div class="detail-text-area">${item.anomalyContent||'-'}</div></div>
      <div class="detail-section"><div class="section-title">ğŸ”§ å¯¾å¿œå†…å®¹</div><div class="detail-text-area">${item.actionTaken||'-'}</div></div>
      ${mfg.length?`<div class="detail-section"><div class="section-title">ğŸ“· ç™ºä¿¡éƒ¨ç½²ã®å†™çœŸï¼ˆ${mfg.length}æšï¼‰</div><div class="photo-grid">${mfg.map(u=>`<div class="photo-thumbnail" onclick="window.open('${u}','_blank')"><img src="${u}" alt=""></div>`).join('')}</div></div>`:''}
      ${tech.length?`<div class="detail-section"><div class="section-title">ğŸ”§ æŠ€è¡“éƒ¨é–€ã®å†™çœŸï¼ˆ${tech.length}æšï¼‰</div><div class="photo-grid">${tech.map(u=>`<div class="photo-thumbnail" onclick="window.open('${u}','_blank')"><img src="${u}" alt=""></div>`).join('')}</div></div>`:''}
    `;
    modal.classList.add('active');
  }
  window.showPhotosOnly=function(id){
    const it=allData.find(x=>x._id===id); if(!it) return;
    const modal=document.getElementById('detailModal');
    const title=document.getElementById('detailTitle');
    const body =document.getElementById('detailBody');
    title.textContent=`ğŸ“· å†™çœŸ - æ•´ç†No: ${it.serialNo||'-'}`;
    const mfg=it.mfgPhotoUrls||[], tech=it.techPhotoUrls||[];
    body.innerHTML = `
      ${mfg.length?`<div class="detail-section"><div class="section-title">ğŸ“· ç™ºä¿¡éƒ¨ç½²ã®å†™çœŸï¼ˆ${mfg.length}æšï¼‰</div><div class="photo-grid">${mfg.map(u=>`<div class="photo-thumbnail" onclick="window.open('${u}','_blank')"><img src="${u}" alt=""></div>`).join('')}</div></div>`:''}
      ${tech.length?`<div class="detail-section"><div class="section-title">ğŸ”§ æŠ€è¡“éƒ¨é–€ã®å†™çœŸï¼ˆ${tech.length}æšï¼‰</div><div class="photo-grid">${tech.map(u=>`<div class="photo-thumbnail" onclick="window.open('${u}','_blank')"><img src="${u}" alt=""></div>`).join('')}</div></div>`:''}
      ${(!mfg.length&&!tech.length)?`<div class="empty-state"><div class="empty-icon">ğŸ“·</div><p>å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“</p></div>`:''}
    `;
    modal.classList.add('active');
  };

  // ====== è¨­å®šãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ ======
  function loadSettings(){
    const saved=localStorage.getItem('datasheetColumns');
    if(saved) visibleColumns=JSON.parse(saved);
    const savedLimit=localStorage.getItem('displayLimit');
    if(savedLimit){ const v=parseInt(savedLimit); if([25,50,75,100].includes(v)){displayLimit=v; document.getElementById('displayCount').value=String(v);} }
  }
  function saveSettings(){ localStorage.setItem('datasheetColumns', JSON.stringify(visibleColumns)); }
  function saveDisplayLimit(){ localStorage.setItem('displayLimit', String(displayLimit)); }

  document.getElementById('btnSettings').addEventListener('click', ()=>{
    const modal=document.getElementById('settingsModal');
    const container=document.getElementById('columnSettings');
    container.innerHTML = allColumns.map(col=>`
      <div class="column-checkbox">
        <input type="checkbox" id="col-${col.id}" ${visibleColumns.includes(col.id)?'checked':''}>
        <label for="col-${col.id}">${col.label}</label>
      </div>`).join('');
    modal.classList.add('active');
  });
  document.getElementById('btnSaveSettings').addEventListener('click',()=>{
    visibleColumns=[]; allColumns.forEach(col=>{ const cb=document.getElementById(`col-${col.id}`); if(cb && cb.checked) visibleColumns.push(col.id); });
    saveSettings(); document.getElementById('settingsModal').classList.remove('active'); renderTable();
  });
  document.getElementById('btnCloseSettings').addEventListener('click',()=>document.getElementById('settingsModal').classList.remove('active'));
  document.getElementById('btnCloseDetail').addEventListener('click',()=>document.getElementById('detailModal').classList.remove('active'));

  document.getElementById('btnExport').addEventListener('click', exportCSV);
  document.getElementById('displayCount').addEventListener('change', e=>{displayLimit=parseInt(e.target.value); saveDisplayLimit(); renderTable();});

  // æœŸé–“ãƒœã‚¿ãƒ³
  document.getElementById('btnYesterday').addEventListener('click',()=>{
    const y=getPreviousBusinessDay(); dateFromStr=y; dateToStr=y;
    document.getElementById('dateFrom').value=y; document.getElementById('dateTo').value=y;
    document.getElementById('btnYesterday').classList.add('active'); document.getElementById('btnToday').classList.remove('active');
    applyFilters();
  });
  document.getElementById('btnToday').addEventListener('click',()=>{
    const t=getToday(); dateFromStr=t; dateToStr=t;
    document.getElementById('dateFrom').value=t; document.getElementById('dateTo').value=t;
    document.getElementById('btnToday').classList.add('active'); document.getElementById('btnYesterday').classList.remove('active');
    applyFilters();
  });
  document.getElementById('dateFrom').addEventListener('change',e=>{dateFromStr=e.target.value||null; document.getElementById('btnYesterday').classList.remove('active'); document.getElementById('btnToday').classList.remove('active'); applyFilters();});
  document.getElementById('dateTo').addEventListener('change',e=>{dateToStr=e.target.value||null; document.getElementById('btnYesterday').classList.remove('active'); document.getElementById('btnToday').classList.remove('active'); applyFilters();});
  document.getElementById('btnClearDate').addEventListener('click',()=>{dateFromStr=null; dateToStr=null; document.getElementById('dateFrom').value=''; document.getElementById('dateTo').value=''; document.getElementById('btnYesterday').classList.remove('active'); document.getElementById('btnToday').classList.remove('active'); applyFilters();});

  // éšå±¤è§£é™¤
  document.getElementById('btnClearDept').addEventListener('click',()=>{
    selectedDepts.clear(); document.querySelectorAll('[data-role="dept"].active').forEach(b=>b.classList.remove('active')); applyFilters();
  });
  document.getElementById('btnClearLines').addEventListener('click',()=>{
    selectedLines.clear(); document.querySelectorAll('[data-role="line"].active').forEach(b=>b.classList.remove('active')); applyFilters();
  });
  document.getElementById('btnClearSerials').addEventListener('click',()=>{
    selectedSerials.clear(); document.querySelectorAll('[data-role="serial"].active').forEach(b=>b.classList.remove('active')); applyFilters();
  });

  // ãƒªã‚»ãƒƒãƒˆ
  document.getElementById('btnResetFilters').addEventListener('click',()=>{
    selectedDepts.clear(); selectedLines.clear(); selectedSerials.clear();
    document.querySelectorAll('.btn-pill.active').forEach(b=>b.classList.remove('active'));
    dateFromStr=null; dateToStr=null;
    document.getElementById('dateFrom').value=''; document.getElementById('dateTo').value='';
    document.getElementById('btnYesterday').classList.remove('active'); document.getElementById('btnToday').classList.remove('active');
    applyFilters();
  });
  document.getElementById('btnResetSort').addEventListener('click',()=>{ currentSort={column:null,direction:'asc'}; renderTable(); });

  // åˆæœŸåŒ–
  (async()=>{
    const ok=await checkAuth(); if(!ok){ alert('èªè¨¼ãŒå¿…è¦ã§ã™'); return; }
    loadSettings();
    await loadData();
  })();
</script>
</body>
</html>