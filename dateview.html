<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•°å¸¸å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ</title>
<style>
  :root{
    /* ã‚µã‚¤ã‚ºå¯å¤‰ æ—¢å®šå€¤ */
    --pill-scale: 1;              /* 0.8ã€œ2.5ï¼šã‚«ãƒ¼ãƒ‰å…¨ä½“å€ç‡ */
    --font-scale: 1;              /* 0.9ã€œ1.3ï¼šæœ¬æ–‡ */
    --table-font-scale: 1;        /* 0.9ã€œ1.3ï¼šè¡¨ */
    --header-title-scale: 1;      /* 0.9ã€œ1.4ï¼šãƒ˜ãƒƒãƒ€ãƒ¼é¡Œå */
    --modal-font-scale: 1;        /* 0.9ã€œ1.3ï¼šãƒ¢ãƒ¼ãƒ€ãƒ« */
    --pill-title-scale: 1;        /* 0.8ã€œ1.6ï¼šã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒˆãƒ« */
    --pill-sub-scale: 1;          /* 0.8ã€œ1.6ï¼šã‚«ãƒ¼ãƒ‰ã‚µãƒ– */

    /* æ´¾ç”Ÿï¼ˆã‚«ãƒ¼ãƒ‰ï¼‰ */
    --pill-pad-v: calc(14px * var(--pill-scale));
    --pill-pad-h: calc(18px * var(--pill-scale));
    --pill-font:  calc(1rem * var(--pill-scale) * var(--pill-title-scale));
    --pill-sub:   calc(.85rem * var(--pill-scale) * var(--pill-sub-scale));
    --pill-minw:  calc(180px * var(--pill-scale));
    --spark-h:    calc(54px * var(--pill-scale));

    /* ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆï¼ˆãƒ©ã‚¤ãƒˆï¼‰ */
    --bg:#f5f5f7;
    --ink:#1d1d1f;
    --ink-2:#334155;
    --muted:#64748b;
    --card:#ffffff;
    --border:#e5e7eb;
    --brand:#667eea;
    --brand-2:#764ba2;
    --thead:#667eea;
    --thead-hover:#5568d3;
    --row-hover:#f8f9ff;
    --chip-on:#3b82f6;
    --chip-bg:rgba(59,130,246,.12);
    --chip-bd:rgba(59,130,246,.35);
    --shadow:0 2px 10px rgba(0,0,0,.1);
    --shadow-2:0 2px 8px rgba(0,0,0,.08);
    --backdrop:rgba(0,0,0,.5);
  }

  /* ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ */
  body.theme-dark{
    --bg:#0b1120;
    --ink:#e5e7eb;
    --ink-2:#cbd5e1;
    --muted:#94a3b8;
    --card:#0f172a;
    --border:#1f2937;
    --brand:#3b82f6;
    --brand-2:#7c3aed;
    --thead:#334155;
    --thead-hover:#1f2937;
    --row-hover:#0b1b34;
    --chip-on:#60a5fa;
    --chip-bg:rgba(96,165,250,.16);
    --chip-bd:rgba(96,165,250,.35);
    --shadow:none;
    --shadow-2:none;
    --backdrop:rgba(0,0,0,.6);
  }

  *{margin:0;padding:0;box-sizing:border-box}
  body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Hiragino Sans',sans-serif;
    background:var(--bg);color:var(--ink);
    font-size:calc(16px * var(--font-scale));
  }

  .header{
    background:linear-gradient(135deg,var(--brand) 0%,var(--brand-2) 100%);
    color:#fff;padding:20px;box-shadow:var(--shadow);
    position:sticky;top:0;z-index:100
  }
  .header-content{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
  .header h1{font-size:calc(1.5rem * var(--header-title-scale));font-weight:600}
  .header-actions{display:flex;gap:10px;flex-wrap:wrap}
  .btn-header{
    background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);
    color:#fff;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:500;transition:.2s
  }
  .btn-header:hover{background:rgba(255,255,255,.3)}

  .container{max-width:1400px;margin:0 auto;padding:20px}

  /* æœŸé–“é¸æŠ */
  .date-filter{background:var(--card);border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:var(--shadow-2);border:1px solid var(--border)}
  .date-filter-header{display:flex;justify-content:space-between;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  .date-filter-title{font-size:1.1rem;font-weight:600;color:var(--brand)}
  .date-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .date-input-group{display:flex;gap:8px;align-items:center}
  .date-input-group input[type="date"]{
    padding:10px 14px;border:2px solid var(--border);border-radius:8px;font-size:.95rem;transition:.2s;background:transparent;color:var(--ink)
  }
  .date-input-group input[type="date"]:focus{outline:none;border-color:var(--brand)}
  .date-quick-btn{
    padding:10px 20px;border:2px solid var(--brand);background:transparent;color:var(--brand);
    border-radius:8px;cursor:pointer;font-weight:600;transition:.2s;white-space:nowrap
  }
  .date-quick-btn:hover{background:rgba(102,126,234,.08)}
  .date-quick-btn.active{background:var(--brand);color:#fff}

  /* ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³è¨­å®š */
  .spark-mode{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .seg{display:flex;border:1px solid var(--border);border-radius:8px;overflow:hidden}
  .seg button{padding:8px 12px;background:transparent;color:var(--ink);border:none;border-right:1px solid var(--border);cursor:pointer}
  .seg button:last-child{border-right:none}
  .seg button.active{background:var(--brand);color:#fff}
  .mode-hint{font-size:.85rem;color:var(--muted)}

  /* éƒ¨ç½²æ¨ªä¸¦ã³ï¼‹å±•é–‹ãƒ‘ãƒãƒ« */
  .dept-filter{background:var(--card);border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:var(--shadow-2);border:1px solid var(--border)}
  .dept-filter-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:10px;flex-wrap:wrap}
  .dept-filter-title{font-size:1.1rem;font-weight:600;color:var(--brand)}
  .btn-tool{
    padding:8px 16px;border:1px solid var(--border);background:transparent;color:var(--ink);
    border-radius:6px;cursor:pointer;font-weight:500;transition:.2s
  }
  .btn-tool:hover{border-color:var(--brand);background:rgba(102,126,234,.08)}

/* === ã‚«ãƒ¼ãƒ‰ï¼ˆé‡ãªã‚Šé˜²æ­¢å¼·åŒ–ï¼‰ === */
.dept-bar{
  display:flex;flex-wrap:wrap;gap:12px;align-items:flex-start;
  contain: layout;
}
.btn-pill{
  --bd: 2px;
  position:relative; overflow:hidden;
  display:inline-flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:var(--pill-pad-v) var(--pill-pad-h);
  border:var(--bd) solid var(--border);
  background:var(--card);
  border-radius:12px;
  cursor:pointer;
  font-size:var(--pill-font);
  font-weight:700;
  transition:.15s ease;
  text-align:center;
  color:var(--ink);
  /* â˜… ä¿®æ­£ï¼šå›ºå®šå¹…ã«å¤‰æ›´ï¼ˆflexã§ä¼¸ç¸®ã—ãªã„ï¼‰ */
  width: calc(180px * var(--pill-scale));
  min-width: calc(180px * var(--pill-scale));
  max-width: calc(180px * var(--pill-scale));
  flex-shrink: 0;
  word-break:break-word;
  box-shadow: var(--shadow-2);
  min-height: 92px;
}

.btn-pill canvas{
  display:block;
  margin:auto;
  height:28px;
  width:80%;
}

  .btn-pill.active{
    border-color:var(--chip-on);
    box-shadow:0 0 0 3px rgba(59,130,246,.25), 0 4px 16px rgba(59,130,246,.15);
    background:var(--card);
  }
  body.theme-dark .btn-pill.active{
    box-shadow:0 0 0 3px rgba(96,165,250,.25);
  }
  .btn-pill.active .ribbon{display:inline-flex}
  .ribbon{
    position:absolute; top:6px; right:6px; display:none; align-items:center; gap:4px;
    padding:2px 6px; font-size:12px; font-weight:700; color:var(--chip-on);
    background:var(--chip-bg); border:1px solid var(--chip-bd);
    border-radius:999px; z-index:2;
  }

  /* ãƒ¯ãƒ¼ã‚¹ãƒˆè‰²åˆ†ã‘ï¼ˆãƒ©ã‚¤ãƒ³ï¼‰ */
  .btn-pill.rank-1{ background:rgba(239,68,68,.16); border-color:#ef4444; box-shadow:0 0 0 2px rgba(239,68,68,.15) inset; }
  .btn-pill.rank-1::before{
    content:''; position:absolute; left:0; top:0; bottom:0; width:6px; background:#ef4444;
  }
  .btn-pill.rank-2{ background:rgba(245,158,11,.16); border-color:#f97316; box-shadow:0 0 0 2px rgba(249,115,22,.15) inset; }
  .btn-pill.rank-2::before{
    content:''; position:absolute; left:0; top:0; bottom:0; width:6px; background:#f97316;
  }
  .btn-pill.rank-3{ background:rgba(234,179,8,.16); border-color:#eab308; box-shadow:0 0 0 2px rgba(234,179,8,.18) inset; }
  .btn-pill.rank-3::before{
    content:''; position:absolute; left:0; top:0; bottom:0; width:6px; background:#eab308;
  }
  body.theme-dark .btn-pill.rank-1{ background:rgba(239,68,68,.22); }
  body.theme-dark .btn-pill.rank-2{ background:rgba(245,158,11,.22); }
  body.theme-dark .btn-pill.rank-3{ background:rgba(234,179,8,.22); }

  /* ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ï¼ˆä¸­å¤®é‡ã­ï¼‰ */
  .btn-pill .sparkline{position:absolute; top:50%; left:6px; right:6px; transform:translateY(-50%); height:var(--spark-h); opacity:.72; pointer-events:none; z-index:0}
  .btn-pill > .title, .btn-pill > .sub, .btn-pill > .ribbon{position:relative; z-index:1}
  .btn-pill .title{text-align:center}
  .btn-pill .sub{font-size:var(--pill-sub); opacity:.9; margin-top:3px}

  /* ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ã®é–‹å§‹/çµ‚äº†æ—¥ãƒ©ãƒ™ãƒ« */
  .btn-pill .spark-dates{
    position:absolute; left:8px; right:8px; bottom:6px;
    display:flex; justify-content:space-between; font-size:.78rem; opacity:.9; pointer-events:none;
  }
  .btn-pill .spark-dates .spark-start,
  .btn-pill .spark-dates .spark-end{
    background:rgba(0,0,0,.05);
    padding:2px 6px; border-radius:6px;
  }
  body.theme-dark .btn-pill .spark-dates .spark-start,
  body.theme-dark .btn-pill .spark-dates .spark-end{
    background:rgba(255,255,255,.06);
  }

  .expand-panel{margin-top:14px; border:1px solid var(--border); border-radius:10px; display:none;background:transparent}
  .expand-panel.open{display:block}
  .panel-head{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; background:rgba(148,163,184,.12); border-bottom:1px solid var(--border)}
  .panel-title{font-weight:700; color:var(--ink-2)}
.lines-grid{
  display:grid; 
  /* â˜… ä¿®æ­£ï¼šå›ºå®šå¹…ã§å‡ç­‰é…ç½® */
  grid-template-columns:repeat(auto-fill, calc(180px * var(--pill-scale))); 
  gap:12px; 
  padding:12px;
  justify-content: start;
}

.serials-grid{
  display:grid; 
  /* â˜… ä¿®æ­£ï¼šå›ºå®šå¹…ã§å‡ç­‰é…ç½® */
  grid-template-columns:repeat(auto-fill, calc(180px * var(--pill-scale))); 
  gap:10px; 
  padding:0 12px 12px;
  justify-content: start;
}

  /* ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ */
  .datasheet-container{background:var(--card);border-radius:12px;box-shadow:var(--shadow-2);overflow:hidden;border:1px solid var(--border)}
  .datasheet-toolbar{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:rgba(148,163,184,.12);flex-wrap:wrap;gap:12px}
  .result-count{font-size:1rem;color:var(--muted)}
  .result-count strong{color:var(--brand);font-size:1.2rem}
  .display-count-selector{display:flex;align-items:center;gap:8px;color:var(--ink)}
  .display-count-selector select{padding:6px 12px;border:2px solid var(--border);border-radius:6px;background:transparent;color:var(--ink);cursor:pointer;font-size:.9rem;transition:.2s}
  .display-count-selector select:focus{outline:none;border-color:var(--brand)}
  .table-wrapper{overflow-x:auto;max-height:calc(100vh - 440px);position:relative}
  table{width:100%;border-collapse:collapse;font-size:calc(.9rem * var(--table-font-scale));color:var(--ink)}
  thead{position:sticky;top:0;z-index:10;background:var(--card)}
  th{padding:12px 16px;text-align:left;background:var(--thead);color:#fff;font-weight:600;white-space:nowrap;cursor:move;user-select:none;position:relative}
  th:hover{background:var(--thead-hover)}
  th.sortable::after{content:'â‡…';margin-left:8px;opacity:.4}
  th.sort-asc::after{content:'â†‘';opacity:1}
  th.sort-desc::after{content:'â†“';opacity:1}
  th.dragging{opacity:0.4;background:var(--brand);color:#fff}
  td{padding:12px 16px;border-bottom:1px solid var(--border)}
  tr{cursor:pointer;transition:background .15s}
  tbody tr:hover{background:var(--row-hover)}
  .status-badge{display:inline-block;padding:4px 12px;border-radius:12px;font-size:.85rem;font-weight:600}
  .status-pending{background:#fff3cd;color:#856404}
  .status-complete{background:#d4edda;color:#155724}
  body.theme-dark .status-pending{background:#664d03;color:#ffec99}
  body.theme-dark .status-complete{background:#123524;color:#86efac}
  .photo-btn{background:#2196f3;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:.85rem;font-weight:600;transition:.2s}
  .photo-btn:hover{background:#1976d2}
  .photo-btn:disabled{background:#ccc;cursor:not-allowed}

  /* è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal{display:none;position:fixed;inset:0;background:var(--backdrop);z-index:5000;align-items:center;justify-content:center}
  .modal.active{display:flex}
  .modal-content{background:var(--card);border-radius:16px;max-width:900px;width:95%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3);border:1px solid var(--border)}
  .modal-header{padding:24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--card);z-index:10;gap:12px}
  .modal-title{font-size:calc(1.3rem * var(--modal-font-scale));font-weight:600;color:var(--brand);display:flex;align-items:center;flex-wrap:wrap;gap:10px}
  .modal-title .sn{font-size:calc(1.6rem * var(--modal-font-scale));font-weight:800;letter-spacing:.02em;color:var(--ink)}
  .btn-close{background:rgba(148,163,184,.18);border:1px solid var(--border);width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1.2rem;color:var(--ink);transition:.2s}
  .btn-close:hover{background:rgba(148,163,184,.28)}
  .modal-body{padding:24px;font-size:calc(1rem * var(--modal-font-scale));color:var(--ink)}
  .detail-section{margin-bottom:24px}
  .section-title{font-size:calc(1rem * var(--modal-font-scale));font-weight:600;color:var(--brand);margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid var(--border)}
  .detail-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px}
  .detail-item{display:flex;flex-direction:column;gap:4px}
  .detail-label{font-size:calc(.85rem * var(--modal-font-scale));color:var(--muted);font-weight:500}
  .detail-value{font-size:calc(1rem * var(--modal-font-scale));color:var(--ink);font-weight:500}
  .detail-text-area{background:rgba(148,163,184,.12);padding:12px;border-radius:8px;line-height:1.6;white-space:pre-wrap;color:var(--ink)}
  .photo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;margin-top:12px}
  .photo-thumbnail{aspect-ratio:1;border-radius:8px;overflow:hidden;box-shadow:var(--shadow-2);cursor:pointer;transition:transform .2s;border:1px solid var(--border)}
  .photo-thumbnail:hover{transform:scale(1.05)}
  .photo-thumbnail img{width:100%;height:100%;object-fit:cover}

  /* ãƒãƒƒã‚¸ */
  .badge{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 10px;border-radius:999px;font-size:.85rem;font-weight:700;line-height:1;
    border:1px solid var(--border);background:rgba(148,163,184,.12);color:var(--ink-2);
  }
  .badge .dot{width:8px;height:8px;border-radius:50%}
  .badge-muted{background:rgba(148,163,184,.18)}
  .badge-info{background:rgba(59,130,246,.12);border-color:rgba(59,130,246,.35);color:#2563eb}
  .badge-good{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.35);color:#059669}
  .badge-warn{background:rgba(245,158,11,.14);border-color:rgba(245,158,11,.35);color:#b45309}
  .badge-danger{background:rgba(239,68,68,.14);border-color:rgba(239,68,68,.35);color:#dc2626}
  .badge-info .dot{background:#3b82f6}
  .badge-good .dot{background:#10b981}
  .badge-warn .dot{background:#f59e0b}
  .badge-danger .dot{background:#ef4444}
  .badge-compact{padding:4px 8px;font-size:.78rem}

  /* ã‚µã‚¤ã‚ºè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal-sm .modal-content{max-width:720px}
  .form-row{display:flex;align-items:center;gap:12px;margin:10px 0;flex-wrap:wrap;color:var(--ink)}
  .form-row label{min-width:240px;font-weight:700;color:var(--ink-2)}
  .form-row input[type="range"]{flex:1}
  .preview-box{padding:12px;border:1px dashed var(--border);border-radius:8px;background:rgba(148,163,184,.12);color:var(--ink)}
  .note{color:var(--muted);font-size:.9em}

  .empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
  .empty-icon{font-size:3rem;margin-bottom:16px}

@media (max-width:768px){
  .date-controls{flex-direction:column;align-items:stretch}
  .date-input-group{flex-direction:column}
  .date-quick-btn{width:100%}
  /* â˜… ä¿®æ­£ï¼šãƒ¢ãƒã‚¤ãƒ«ã§ã‚‚å›ºå®šå¹… */
  .btn-pill{
    width: calc(140px * var(--pill-scale));
    min-width: calc(140px * var(--pill-scale));
    max-width: calc(140px * var(--pill-scale));
  }
  .lines-grid{grid-template-columns:repeat(auto-fill, calc(140px * var(--pill-scale)))}
  .serials-grid{grid-template-columns:repeat(auto-fill, calc(140px * var(--pill-scale)))}
}

  /* === ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆå…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰ === */
.datasheet-container.fullscreen {
  position: fixed;
  inset: 0;
  z-index: 2000;
  width: 100vw;
  height: 100vh;
  margin: 0;
  border-radius: 0;
  box-shadow: none;
  background: var(--card);
  display: flex;
  flex-direction: column;
}

.datasheet-container.fullscreen .table-wrapper {
  flex: 1;
  max-height: none;
}

.datasheet-container.fullscreen .datasheet-toolbar {
  border-radius: 0;
}

body.fullscreen-active {
  overflow: hidden; /* èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
}

</style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>ğŸ“Š ç•°å¸¸å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ</h1>
      <div class="header-actions">
        <button class="btn-header" id="btnTheme">ğŸŒ™ ãƒ€ãƒ¼ã‚¯</button>
        <button class="btn-header" id="btnSizeSettings">ğŸ…°ï¸ ã‚µã‚¤ã‚ºè¨­å®š</button>
        <button class="btn-header" id="btnSettings">âš™ï¸ è¡¨ç¤ºè¨­å®š</button>
        <button class="btn-header" id="btnExport">ğŸ“¥ CSVå‡ºåŠ›</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- æœŸé–“é¸æŠ -->
    <div class="date-filter">
      <div class="date-filter-header">
        <div class="date-filter-title">ğŸ“… æœŸé–“ã§çµã‚Šè¾¼ã¿</div>
        <div class="spark-mode">
          <div class="seg" title="ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ã®æœŸé–“">
            <button id="mode7" class="active">7æ—¥</button>
            <button id="mode30">30æ—¥</button>
            <button id="mode24">24æ™‚é–“(8æ™‚)</button>
          </div>
          <div class="seg" title="è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼ˆåˆè¨ˆ/ç©ã¿ä¸Šã’ï¼‰">
            <button id="viewTotal" class="active">åˆè¨ˆ</button>
            <button id="viewStack">ç©ã¿ä¸Šã’</button>
          </div>
          <div class="mode-hint" id="modeHint">é¸æŠæ—¥ã®ç¯„å›²ã§æç”»</div>
        </div>
      </div>
      <div class="date-controls">
        <button class="date-quick-btn" id="btnYesterday">å‰æ—¥ï¼ˆå¹³æ—¥ï¼‰</button>
        <button class="date-quick-btn" id="btnToday">ä»Šæ—¥</button>
        <div class="date-input-group">
          <input type="date" id="dateFrom" placeholder="é–‹å§‹æ—¥">
          <span style="color:var(--muted);">ã€œ</span>
          <input type="date" id="dateTo" placeholder="çµ‚äº†æ—¥">
        </div>
        <button class="btn-tool" id="btnClearDate">æœŸé–“ã‚¯ãƒªã‚¢</button>
      </div>
    </div>

    <!-- éƒ¨ç½²æ¨ªä¸¦ã³ -->
    <div class="dept-filter">
      <div class="dept-filter-header">
        <div class="dept-filter-title">ğŸ¢ éƒ¨ç½²ï¼ˆæ¨ªä¸¦ã³ï¼è¤‡æ•°é¸æŠå¯ï¼‰</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn-tool" id="btnClearAll">ä¸€æ‹¬è§£é™¤</button>
        </div>
      </div>
      <div id="deptBar" class="dept-bar"></div>

      <!-- å˜ä¸€å±•é–‹ãƒ‘ãƒãƒ« -->
      <div id="expandPanel" class="expand-panel">
        <div class="panel-head">
          <div class="panel-title" id="panelTitle">é¸æŠä¸­ã®éƒ¨ç½²</div>
          <div style="display:flex; gap:8px;">
            <span id="selCounter" style="color:var(--muted); font-weight:600;"></span>
          </div>
        </div>
        <div style="padding:8px 12px; color:var(--muted);">ãƒ©ã‚¤ãƒ³ï¼ˆåŒéƒ¨ç½² åˆè¨ˆåœæ­¢æ™‚é–“ãƒ¯ãƒ¼ã‚¹ãƒˆ3ã‚’è‰²è¡¨ç¤ºï¼‰</div>
        <div id="linesGrid" class="lines-grid"></div>
        <div id="serialsHolder" style="display:none;">
          <div style="padding:8px 12px; color:var(--muted);">æ•´ç†No</div>
          <div id="serialsGrid" class="serials-grid"></div>
        </div>
      </div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ -->
    <div class="datasheet-container">
      <div class="datasheet-toolbar">
        <div class="result-count">è¡¨ç¤ºä¸­: <strong id="resultCount">0</strong> ä»¶ / å…¨ <strong id="totalCount">0</strong> ä»¶</div>
        <div class="display-count-selector">
          <label for="displayCount">è¡¨ç¤ºä»¶æ•°:</label>
          <select id="displayCount">
            <option value="25">25ä»¶</option>
            <option value="50">50ä»¶</option>
            <option value="75">75ä»¶</option>
            <option value="100">100ä»¶</option>
          </select>
        </div>
        <div class="toolbar-actions">
          <button class="btn-tool" id="btnResetFilters">ğŸ”„ ãƒ•ã‚£ãƒ«ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
          <button class="btn-tool" id="btnResetSort">â†•ï¸ ã‚½ãƒ¼ãƒˆãƒªã‚»ãƒƒãƒˆ</button>
            <button class="btn-tool" id="btnFullscreen">ğŸ–¥ï¸ å…¨ç”»é¢</button>
        </div>
      </div>
      <div class="table-wrapper">
        <table id="dataTable">
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="detailTitle">è©³ç´°æƒ…å ±</div>
        <button class="btn-close" id="btnCloseDetail">Ã—</button>
      </div>
      <div class="modal-body" id="detailBody"></div>
    </div>
  </div>

  <!-- è¡¨ç¤ºé …ç›®ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">âš™ï¸ è¡¨ç¤ºé …ç›®è¨­å®š</div>
        <button class="btn-close" id="btnCloseSettings">Ã—</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom:16px;color:var(--muted);">è¡¨ç¤ºã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        <div class="settings-grid" id="columnSettings"></div>
        <button class="btn-header" style="width:100%;margin-top:20px;padding:12px;background:var(--brand);border:none;font-size:1rem;" id="btnSaveSettings">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ã‚µã‚¤ã‚ºè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal modal-sm" id="sizeModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ğŸ…°ï¸ ã‚µã‚¤ã‚ºè¨­å®š</div>
        <button class="btn-close" id="btnCloseSize">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <label for="slPill">ã‚«ãƒ¼ãƒ‰ï¼ˆéƒ¨ç½²/ãƒ©ã‚¤ãƒ³/æ•´ç†Noï¼‰ã‚µã‚¤ã‚º</label>
          <input type="range" id="slPill" min="0.8" max="2.5" step="0.05">
          <span class="val" id="valPill"></span>
        </div>
        <div class="form-row">
          <label for="slPillTitle">ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒˆãƒ«æ–‡å­—</label>
          <input type="range" id="slPillTitle" min="0.8" max="1.6" step="0.05">
          <span class="val" id="valPillTitle"></span>
        </div>
        <div class="form-row">
          <label for="slPillSub">ã‚«ãƒ¼ãƒ‰ã‚µãƒ–æ–‡å­—ï¼ˆä»¶æ•°ãªã©ï¼‰</label>
          <input type="range" id="slPillSub" min="0.8" max="1.6" step="0.05">
          <span class="val" id="valPillSub"></span>
        </div>
        <div class="form-row">
          <label for="slBase">æœ¬æ–‡ï¼ˆå…¨ä½“ï¼‰æ–‡å­—ã‚µã‚¤ã‚º</label>
          <input type="range" id="slBase" min="0.9" max="1.3" step="0.05">
          <span class="val" id="valBase"></span>
        </div>
        <div class="form-row">
          <label for="slTable">è¡¨ã®æ–‡å­—ã‚µã‚¤ã‚º</label>
          <input type="range" id="slTable" min="0.9" max="1.3" step="0.05">
          <span class="val" id="valTable"></span>
        </div>
        <div class="form-row">
          <label for="slHeader">ãƒ˜ãƒƒãƒ€ãƒ¼é¡Œåã‚µã‚¤ã‚º</label>
          <input type="range" id="slHeader" min="0.9" max="1.4" step="0.05">
          <span class="val" id="valHeader"></span>
        </div>
        <div class="form-row">
          <label for="slModal">ãƒ¢ãƒ¼ãƒ€ãƒ«æ–‡å­—ã‚µã‚¤ã‚º</label>
          <input type="range" id="slModal" min="0.9" max="1.3" step="0.05">
          <span class="val" id="valModal"></span>
        </div>

        <div class="preview-box" id="previewBox" style="margin-top:16px;">
          ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼šã‚µã‚¤ã‚ºå¤‰æ›´ã¯ã“ã®ã‚ˆã†ã«åæ˜ ã•ã‚Œã¾ã™ï¼ˆã‚«ãƒ¼ãƒ‰ã®ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³é«˜ã•ã‚‚ã‚«ãƒ¼ãƒ‰ã‚µã‚¤ã‚ºã«é€£å‹•ï¼‰
        </div>
        <div class="form-row" style="justify-content:flex-end;margin-top:12px;">
          <button class="btn-tool" id="btnSizeReset">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
          <button class="btn-header" id="btnSizeSave" style="background:var(--brand);border:none;">ä¿å­˜</button>
        </div>
        <p class="note">â€» ä¿å­˜ã™ã‚‹ã¨æ¬¡å›ä»¥é™ã‚‚ã“ã®ã‚µã‚¤ã‚ºã§è¡¨ç¤ºã—ã¾ã™ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ï¼‰ã€‚</p>
      </div>
    </div>
  </div>

<script type="module">

  // === Canvasã®å®Ÿãƒ”ã‚¯ã‚»ãƒ«è§£åƒåº¦ã‚’CSSã‚µã‚¤ã‚ºã«åŒæœŸï¼ˆæœªå®šç¾©ãªã‚‰å®šç¾©ï¼‰ ===
if (typeof window.ensureCanvasResolution !== 'function') {
  window.ensureCanvasResolution = function ensureCanvasResolution(canvas){
    if (!canvas) return;
    const dpr  = window.devicePixelRatio || 1;
    const cssW = Math.floor(canvas.clientWidth || 120);
    // getComputedStyle().height ã¯ "28px" ã®ã‚ˆã†ãªæ–‡å­—åˆ—ãªã®ã§ parseFloat
    const cssH = Math.floor(parseFloat(getComputedStyle(canvas).height) || 40);
    const needW = Math.max(1, Math.floor(cssW * dpr));
    const needH = Math.max(1, Math.floor(cssH * dpr));
    if (canvas.width  !== needW) canvas.width  = needW;
    if (canvas.height !== needH) canvas.height = needH;
  };
}

  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
  import { getFirestore, collection, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

  let headerDragActive = false;
  
  const firebaseConfig = {
    apiKey: "AIzaSyA0YUIpIDh4WB4p1ewiNB0XfwHve0ByljU",
    authDomain: "abnreport-fd733.firebaseapp.com",
    databaseURL: "https://abnreport-fd733-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "abnreport-fd733",
    storageBucket: "abnreport-fd733.firebasestorage.app",
    messagingSenderId: "349748947315",
    appId: "1:349748947315:web:010cb671d2a95bcf1f7d06"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth= getAuth(app);

  /* ===== ãƒ†ãƒ¼ãƒï¼ˆãƒ€ãƒ¼ã‚¯/ãƒ©ã‚¤ãƒˆï¼‰ ===== */
  const THEME_KEY = 'datasheetTheme';
  const themeBtn = document.getElementById('btnTheme');
  function applyTheme(t){
    document.body.classList.toggle('theme-dark', t==='dark');
    themeBtn.textContent = (t==='dark') ? 'â˜€ï¸ ãƒ©ã‚¤ãƒˆ' : 'ğŸŒ™ ãƒ€ãƒ¼ã‚¯';
  }
  function getInitialTheme(){
    const saved = localStorage.getItem(THEME_KEY);
    if(saved==='dark' || saved==='light') return saved;
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    return prefersDark ? 'dark' : 'light';
  }
  let currentTheme = getInitialTheme();
  applyTheme(currentTheme);
  themeBtn.addEventListener('click', ()=>{
    currentTheme = (currentTheme==='dark') ? 'light' : 'dark';
    localStorage.setItem(THEME_KEY, currentTheme);
    applyTheme(currentTheme);
  });

  /* ===== çŠ¶æ…‹ ===== */
  let allData = [];
  let filteredData = [];
  let dateFromStr = null, dateToStr = null;

  let sparkMode = '24h';
  let lastManualSparkMode = '24h';
  let autoRangeActive = false;

  let viewMode = 'total';

  const selectedDepts   = new Set();
  const selectedLines   = new Set();
  const selectedSerials = new Set();

  let focusedDept = null;
  let currentSort = { column:null, direction:'asc' };
  let displayLimit = 25;

  const allColumns = [
    { id:'serialNo', label:'æ•´ç†No', sortable:true },
    { id:'department', label:'éƒ¨ç½²', sortable:true, filterable:true },
    { id:'lineName', label:'ãƒ©ã‚¤ãƒ³', sortable:true, filterable:true },
    { id:'occurrenceDate', label:'ç™ºç”Ÿæ—¥', sortable:true },
    { id:'occurrenceTime', label:'ç™ºç”Ÿæ™‚åˆ»', sortable:true },
    { id:'restartTime', label:'å†é–‹æ™‚åˆ»', sortable:true },
    { id:'stopMinutes', label:'åœæ­¢æ™‚é–“', sortable:true },
    { id:'handler', label:'å‡¦ç½®è€…', sortable:true },
    { id:'anomalyContent', label:'ç•°å¸¸å†…å®¹', sortable:false },
    { id:'actionTaken', label:'å¯¾å¿œå†…å®¹', sortable:false },
    { id:'rootCauseAction', label:'æŠ€è¡“å¯¾å¿œå†…å®¹', sortable:false },
    { id:'photos', label:'å†™çœŸ', sortable:false },
    { id:'status', label:'çŠ¶æ…‹', sortable:true }
  ];

  const DEFAULT_COLUMNS = ['department',
     'occurrenceDate','occurrenceTime','lineName',
    'serialNo','anomalyContent','actionTaken',
   'rootCauseAction',
    'stopMinutes'
  ];
  
  let visibleColumns = [...DEFAULT_COLUMNS];

  /* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
  const pad2 = n => String(n).padStart(2,'0');
  const clamp = (v,lo,hi)=>Math.max(lo,Math.min(hi,v));
  function formatDate(d){return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;}
  function getToday(){ return formatDate(new Date()); }
  function getPreviousBusinessDay(){
    const date=new Date();const dow=date.getDay();
    if(dow===1) date.setDate(date.getDate()-3);
    else if(dow===0) date.setDate(date.getDate()-2);
    else date.setDate(date.getDate()-1);
    return formatDate(date);
  }
  function normalizeWide(s){return String(s??'').replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g,ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0)).replace(/ã€€/g,' ').trim();}
  function normalizeDeptName(s){return normalizeWide(s).toUpperCase()||'æœªè¨­å®š';}
  function normalizeLineName(s){return normalizeWide(s)||'æœªè¨­å®š';}

  function getOperationalToday(){
    const now = new Date();
    if (now.getHours() < 8) now.setDate(now.getDate() - 1);
    return formatDate(now);
  }

  function parseDateFlexible(v){
    if(!v) return {iso:null,value:null};
    let d=null;
    if(typeof v==='object'){
      if(typeof v.toDate==='function') d=v.toDate();
      else if('seconds'in v&&'nanoseconds'in v) d=new Date(v.seconds*1000+Math.round(v.nanoseconds/1e6));
    }
    if(!d && v instanceof Date) d=v;
    if(!d && typeof v==='number') d=new Date(v);
    if(!d && typeof v==='string'){
      const s=v.trim();
      let m=s.match(/^(\d{4})[.\-\/å¹´](\d{1,2})[.\-\/æœˆ](\d{1,2})(?:æ—¥)?$/);
      if(m) d=new Date(+m[1],+m[2]-1,+m[3]);
      if(!d){ m=s.match(/^(\d{2})[.\-\/å¹´](\d{1,2})[.\-\/æœˆ](\d{1,2})(?:æ—¥)?$/); if(m) d=new Date(2000+(+m[1]),+m[2]-1,+m[3]); }
      if(!d){ m=s.match(/^(\d{4})(\d{2})(\d{2})$/); if(m) d=new Date(+m[1],+m[2]-1,+m[3]); }
      if(!d){ const p=Date.parse(s); if(!Number.isNaN(p)) d=new Date(p); }
    }
    if(!d || Number.isNaN(d.getTime())) return {iso:null,value:null};
    const y=d.getFullYear(), m=d.getMonth()+1, dd=d.getDate();
    return {iso:`${y}-${pad2(m)}-${pad2(dd)}`, value:new Date(y,m-1,dd).getTime()};
  }

  function normalizeTime(v){
    if(!v) return null; const s=String(v).trim();
    let m=s.match(/^(\d{1,2}):(\d{1,2})$/);
    if(m){ return `${pad2(clamp(+m[1],0,23))}:${pad2(clamp(+m[2],0,59))}`; }
    m=s.match(/(\d{1,2})\D+(\d{1,2})/);
    if(m){ return `${pad2(clamp(+m[1],0,23))}:${pad2(clamp(+m[2],0,59))}`; }
    m=s.match(/^(\d{3,4})$/);
    if(m){ const raw=m[1].padStart(4,'0'); return `${pad2(clamp(+raw.slice(0,2),0,23))}:${pad2(clamp(+raw.slice(2,4),0,59))}`; }
    return null;
  }

  function getOccurrenceMsLocal(it){
    if (it.occurrenceDateISO) {
      const time = it.occurrenceTimeNorm || '00:00';
      const dt = new Date(`${it.occurrenceDateISO}T${time}:00`);
      if (!Number.isNaN(dt.getTime())) return dt.getTime();
      const dOnly = new Date(it.occurrenceDateISO);
      if (!Number.isNaN(dOnly.getTime())) return dOnly.getTime();
    }
    if (it.occurrenceDateValue != null) return it.occurrenceDateValue;
    if (it.createdAtValue    != null) return it.createdAtValue;
    return null;
  }

  function buildStopBadge(sm, {compact=true} = {}){
    const n = (typeof sm === 'number') ? sm : Number.parseInt(sm, 10);
    let cls = 'badge-muted';
    let txt = 'â€”';
    if (!Number.isNaN(n)) {
      txt = `${n}åˆ†`;
      if (n >= 60) cls = 'badge-danger';
      else if (n >= 15) cls = 'badge-warn';
      else if (n > 0) cls = 'badge-good';
      else cls = 'badge-muted';
    }
    return `<span class="badge ${compact ? 'badge-compact' : ''} ${cls}">
              <span class="dot"></span>${txt}
            </span>`;
  }

/* ===== èµ¤/ç·‘åˆ¤å®šã‚’ã€Œãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æœŸé–“ã®æ™‚é–“å½“ãŸã‚Šå¹³å‡ã€vsã€Œ30æ—¥å¹³å‡ã€ã§æ¯”è¼ƒ ===== */

// ã„ã¾ç”»é¢ã«é©ç”¨ã•ã‚Œã¦ã„ã‚‹ã€Œæ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆmsï¼‰ã‚’å–å¾—
function getCurrentFilterWindow(){
  // æ˜ç¤ºçš„ãªæœŸé–“æŒ‡å®šãŒã‚ã‚‹å ´åˆï¼ˆå‰æ—¥/ä»Šæ—¥ãƒœã‚¿ãƒ³ã€ã¾ãŸã¯dateFrom/dateToå…¥åŠ›ï¼‰
  if (dateFromStr || dateToStr){
    const from = dateFromStr ? new Date(`${dateFromStr}T00:00:00`).getTime() : -Infinity;
    const to   = dateToStr   ? new Date(`${dateToStr}T23:59:59.999`).getTime() :  Infinity;
    return [from, to];
  }
  // ãªã„å ´åˆã¯ã€ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ã®è¡¨ç¤ºãƒ¬ãƒ³ã‚¸ï¼ˆbuildBinsï¼‰ã‚’ä½¿ã†
  const binsInfo = buildBins();
  const bins = binsInfo?.bins || [];
  if (!bins.length){
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šä»Šæ—¥ã®0:00ã€œ23:59:59
    const t = new Date(); t.setHours(0,0,0,0);
    const from = t.getTime();
    const to = from + 24*60*60*1000 - 1;
    return [from, to];
  }
  const from = bins[0].start;
  const to   = bins[bins.length - 1].end;
  return [from, to];
}

// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æœŸé–“ã«ãŠã‘ã‚‹ã€éƒ¨ç½²ã”ã¨ã®ã€Œæ™‚é–“å½“ãŸã‚Šå¹³å‡ä»¶æ•°ã€
function getDeptFilteredAvgRate(dept){
  const [from, to] = getCurrentFilterWindow();
  if (!(Number.isFinite(from) && Number.isFinite(to) && to > from)) return 0;
  let count = 0;
  for (const it of allData){
    if ((it.departmentNormalized||'æœªè¨­å®š') !== dept) continue;
    const ms = getOccurrenceMsLocal(it);
    if (ms==null) continue;
    if (ms >= from && ms <= to) count++;
  }
  const hours = Math.max(1, (to - from) / 36e5);
  return count / hours;
}

// ç›´è¿‘30æ—¥ã®ï¼ˆåŒä¸€çµ‚ç«¯æ—¥ãƒ™ãƒ¼ã‚¹ï¼‰æ™‚é–“å½“ãŸã‚Šå¹³å‡ä»¶æ•°
function getDeptRolling30dAvgRate(dept){
  // æ¯”è¼ƒã®çµ‚ç«¯ã¯ã€Œç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æœŸé–“ã®çµ‚ç«¯ã€ã«åˆã‚ã›ã‚‹
  const [, to] = getCurrentFilterWindow();
  const endMs = Number.isFinite(to) ? to : Date.now();
  const startMs = endMs - 30*24*60*60*1000; // 30æ—¥
  let count = 0;
  for (const it of allData){
    if ((it.departmentNormalized||'æœªè¨­å®š') !== dept) continue;
    const ms = getOccurrenceMsLocal(it);
    if (ms==null) continue;
    if (ms >= startMs && ms <= endMs) count++;
  }
  const hours = 30*24; // 30æ—¥ã‚’å›ºå®šæ™‚é–“ã§æ­£è¦åŒ–
  return count / hours;
}

// è‰²æ±ºå®šï¼šãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¹³å‡ <= 30æ—¥å¹³å‡ ãªã‚‰ã€Œç·‘ã€ã€è¶…ãˆã‚‹ã¨ã€Œèµ¤ã€ã€‚
// ã©ã¡ã‚‰ã‚‚0ãªã‚‰é’ï¼ˆãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«ï¼‰
function getDeptSparkColor(dept){
  const cur = getDeptFilteredAvgRate(dept);
  const base = getDeptRolling30dAvgRate(dept);

  if (base === 0 && cur === 0) return 'rgba(66,133,244,0.85)'; // ãƒ‡ãƒ¼ã‚¿ãªã—ï¼šé’
  // ã—ãã„å€¤ã‚’å°‘ã—ç·©ã‚ãŸã„å ´åˆã¯ä»¥ä¸‹ã®ã‚¤ãƒ—ã‚·ãƒ­ãƒ³ã‚’èª¿æ•´ï¼ˆÂ±5%ï¼‰
  const eps = Math.max(0.0001, base * 0.05);
  return (cur <= base + eps) ? 'rgba(22,163,74,0.95)'     // ç·‘ï¼ˆè‰¯åŒ– or åŒç­‰ï¼‰
                             : 'rgba(239,68,68,0.95)';    // èµ¤ï¼ˆæ‚ªåŒ–ï¼‰
}


  /* ===== èªè¨¼ãƒ»ãƒ­ãƒ¼ãƒ‰ ===== */
  async function checkAuth(){
    return new Promise(resolve=>{
      onAuthStateChanged(auth,(user)=>{
        if(user) resolve(true);
        else{
          const email=prompt('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          const password=prompt('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          if(email && password){
            setPersistence(auth,browserLocalPersistence)
              .then(()=>signInWithEmailAndPassword(auth,email,password))
              .then(()=>resolve(true))
              .catch(e=>{alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: '+e.message); resolve(false);});
          }else resolve(false);
        }
      });
    });
  }

  async function loadData(){
    const q=query(collection(db,'anomalies'), orderBy('createdAt','desc'));
    const snap=await getDocs(q);
    allData=snap.docs.map(doc=>{
      const raw={_id:doc.id, ...doc.data()};
      const deptNorm=normalizeDeptName(raw.department);
      const lineNorm=normalizeLineName(raw.lineName);
const rootCauseAction =
raw.rootCauseAction ??
raw.techAction ??
raw.techResponse ??
raw.techRootCause ??
raw.countermeasure ??
raw.qualityRootCauseAction ??
null;


      const occSource = raw.occurrenceDate ?? raw.occurrence_at ?? raw.date ?? raw.createdAt ?? raw.updatedAt;
      const occ      = parseDateFlexible(occSource);
      const created  = parseDateFlexible(raw.createdAt);

      const occTime=normalizeTime(raw.occurrenceTime);
      const resTime=normalizeTime(raw.restartTime);
      let stop=null;
      if(occTime && resTime){
        const [oh,om]=occTime.split(':').map(Number);
        const [rh,rm]=resTime.split(':').map(Number);
        let diff=(rh*60+rm)-(oh*60+om);
        if(diff<0) diff+=1440;
        stop=diff;
      }
      return {
        ...raw,
        rootCauseAction,
        departmentNormalized:deptNorm,
        lineNameNormalized:lineNorm,
        occurrenceDateISO:occ.iso,
        occurrenceDateValue:occ.value,
        createdAtISO: created.iso,
        createdAtValue: created.value,
        occurrenceTimeNorm:occTime,
        restartTimeNorm:resTime,
        stopMinutes: (typeof raw.stopMinutes==='number') ? raw.stopMinutes : stop
      };
    });
    renderDeptBar();
    applyFilters();
    drawAllSparklines();

    const ro = new ResizeObserver(() => {
      requestAnimationFrame(() => drawAllSparklines());
    });
    ['deptBar','linesGrid','serialsGrid'].forEach(id=>{
      const el = document.getElementById(id);
      if (el) ro.observe(el);
    });
  }

  /* ===== éƒ¨ç½²ãƒãƒ¼ ===== */
  function renderDeptBar(){
    const bar=document.getElementById('deptBar');
    const periodData = filterByDate(allData);

    const counts = new Map();
    for(const it of periodData){
      const d=it.departmentNormalized||'æœªè¨­å®š';
      counts.set(d,(counts.get(d)||0)+1);
    }
    const depts=[...counts.keys()].sort();

    bar.innerHTML = depts.map(dept=>{
      const total=counts.get(dept);
      const activeClass = selectedDepts.has(dept)?'active':'';
      return `
        <div class="btn-pill ${activeClass}" data-role="dept" data-dept="${dept}" title="${dept}">
          <span class="ribbon">âœ“ é¸æŠä¸­</span>
          <canvas class="sparkline"></canvas>
          <div class="spark-dates"><span class="spark-start"></span><span class="spark-end"></span></div>
          <div class="title">${dept}</div>
          <div class="sub">${total}ä»¶</div>
        </div>`;
    }).join('');

    bar.querySelectorAll('[data-role="dept"]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const dept = btn.getAttribute('data-dept');
        const isActive = btn.classList.toggle('active');

        if (isActive) {
          selectedDepts.add(dept);
          focusedDept = dept;
          renderExpandPanel(dept);
        } else {
          selectedDepts.delete(dept);
          if (focusedDept === dept) focusedDept = null;
          
          const toRemoveLines = new Set();
          const toRemoveSerials = new Set();
          
          selectedLines.forEach(key => {
            if (key.startsWith(`${dept}||`)) toRemoveLines.add(key);
          });
          selectedSerials.forEach(key => {
            if (key.startsWith(`${dept}||`)) toRemoveSerials.add(key);
          });
          
          toRemoveLines.forEach(key => selectedLines.delete(key));
          toRemoveSerials.forEach(key => selectedSerials.delete(key));
          
          if (selectedDepts.size === 0) {
            const panel = document.getElementById('expandPanel');
            panel.classList.remove('open');
            document.getElementById('linesGrid').innerHTML = '';
            document.getElementById('serialsGrid').innerHTML = '';
            document.getElementById('serialsHolder').style.display = 'none';
          } else {
            const lastDept = [...selectedDepts].pop();
            focusedDept = lastDept;
            renderExpandPanel(lastDept);
          }
        }

        const selCounter = document.getElementById('selCounter');
        if (selCounter) {
          selCounter.textContent = `é¸æŠä¸­ï¼šéƒ¨ç½² ${selectedDepts.size}ï¼ãƒ©ã‚¤ãƒ³ ${selectedLines.size}ï¼æ•´ç†No ${selectedSerials.size}`;
        }

        applyFilters();
        drawAllSparklines();
      });
    });

    drawAllSparklines();
    let timer=null;
    window.addEventListener('resize', ()=>{
      clearTimeout(timer);
      timer=setTimeout(()=>{ drawAllSparklines(); }, 150);
    }, {passive:true});
  }

  /* ===== å±•é–‹ãƒ‘ãƒãƒ«ï¼ˆãƒ©ã‚¤ãƒ³ï¼šãƒ¯ãƒ¼ã‚¹ãƒˆè‰²åˆ†ã‘ï¼‰ ===== */
  function renderExpandPanel(dept){
    const panel=document.getElementById('expandPanel');
    const title=document.getElementById('panelTitle');
    const linesGrid=document.getElementById('linesGrid');
    const serialsHolder=document.getElementById('serialsHolder');
    const serialsGrid=document.getElementById('serialsGrid');
    const selCounter = document.getElementById('selCounter');

    if(!dept){ panel.classList.remove('open'); linesGrid.innerHTML=''; serialsGrid.innerHTML=''; serialsHolder.style.display='none'; selCounter.textContent=''; return; }

    title.textContent=`éƒ¨ç½²ï¼š${dept}`;
    panel.classList.add('open');
    serialsHolder.style.display='none'; serialsGrid.innerHTML='';

    const base=filterByDate(allData).filter(it=>(it.departmentNormalized||'æœªè¨­å®š')===dept);
    const lineCount=new Map();
    const lineStop =new Map();
    for(const it of base){
      const l=it.lineNameNormalized||'æœªè¨­å®š';
      lineCount.set(l,(lineCount.get(l)||0)+1);
      const sm = typeof it.stopMinutes==='number' ? it.stopMinutes : 0;
      lineStop.set(l,(lineStop.get(l)||0)+sm);
    }
    const lines=[...lineCount.keys()].sort();

    const top3 = [...lineStop.entries()]
      .sort((a,b)=> b[1]-a[1])
      .slice(0,3)
      .map(([ln])=>ln);

    linesGrid.innerHTML = lines.map(line=>{
      const totalCnt=lineCount.get(line)||0;
      const totalMin=lineStop.get(line)||0;
      const key=`${dept}||${line}`;
      const active=selectedLines.has(key)?'active':'';
      const rankCls = top3[0]===line ? 'rank-1' : top3[1]===line ? 'rank-2' : top3[2]===line ? 'rank-3' : '';
      return `
        <div class="btn-pill ${active} ${rankCls}" data-role="line" data-dept="${dept}" data-line="${line}" title="åˆè¨ˆåœæ­¢æ™‚é–“: ${totalMin}åˆ†">
          <span class="ribbon">âœ“ é¸æŠä¸­</span>
          <canvas class="sparkline"></canvas>
          <div class="spark-dates"><span class="spark-start"></span><span class="spark-end"></span></div>
          <div class="title">${line}</div>
          <div class="sub">${totalCnt}ä»¶</div>
        </div>`;
    }).join('');

    linesGrid.querySelectorAll('[data-role="line"]').forEach(btn=>{
      btn.addEventListener('click',(e)=>{
        const d=btn.getAttribute('data-dept');
        const l=btn.getAttribute('data-line');
        const key=`${d}||${l}`;
        const isActive=btn.classList.toggle('active');
        if(isActive) selectedLines.add(key); else selectedLines.delete(key);
        renderSerials(d,l);
        applyFilters();
        drawAllSparklines();
        e.stopPropagation();
      });
    });

    selCounter.textContent = `é¸æŠä¸­ï¼šéƒ¨ç½² ${selectedDepts.size}ï¼ãƒ©ã‚¤ãƒ³ ${selectedLines.size}ï¼æ•´ç†No ${selectedSerials.size}`;
    drawAllSparklines();
  }

  function renderSerials(dept,line){
    const serialsHolder=document.getElementById('serialsHolder');
    const serialsGrid=document.getElementById('serialsGrid');
    const selCounter = document.getElementById('selCounter');

    if(!dept || !line){
      serialsHolder.style.display='none';
      serialsGrid.innerHTML='';
      selCounter.textContent = `é¸æŠä¸­ï¼šéƒ¨ç½² ${selectedDepts.size}ï¼ãƒ©ã‚¤ãƒ³ ${selectedLines.size}ï¼æ•´ç†No ${selectedSerials.size}`;
      return;
    }

    const base = filterByDate(allData).filter(
      it => (it.departmentNormalized||'æœªè¨­å®š')===dept && (it.lineNameNormalized||'æœªè¨­å®š')===line
    );

    const serialCount = new Map();
    const serialStop  = new Map();
    for(const it of base){
      const sn = it.serialNo || 'æœªè¨­å®š';
      serialCount.set(sn, (serialCount.get(sn)||0) + 1);
      const sm = typeof it.stopMinutes==='number' ? it.stopMinutes : 0;
      serialStop.set(sn, (serialStop.get(sn)||0) + sm);
    }

    const serials = [...serialCount.keys()].sort();

    const top3 = [...serialStop.entries()]
      .sort((a,b)=> b[1]-a[1])
      .slice(0,3)
      .map(([sn])=>sn);

    serialsGrid.innerHTML = serials.map(sn=>{
      const totalCnt = serialCount.get(sn) || 0;
      const totalMin = serialStop.get(sn)  || 0;
      const key = `${dept}||${line}||${sn}`;
      const active = selectedSerials.has(key) ? 'active' : '';

      const rankCls =
        top3[0]===sn ? 'rank-1' :
        top3[1]===sn ? 'rank-2' :
        top3[2]===sn ? 'rank-3' : '';

      return `
        <div class="btn-pill ${active} ${rankCls}"
             data-role="serial"
             data-dept="${dept}"
             data-line="${line}"
             data-serial="${sn}"
             title="åˆè¨ˆåœæ­¢æ™‚é–“: ${totalMin}åˆ†">
          <span class="ribbon">âœ“ é¸æŠä¸­</span>
          <canvas class="sparkline"></canvas>
          <div class="spark-dates"><span class="spark-start"></span><span class="spark-end"></span></div>
          <div class="title">${sn}</div>
          <div class="sub">${totalCnt}ä»¶</div>
        </div>`;
    }).join('');

    serialsGrid.querySelectorAll('[data-role="serial"]').forEach(btn=>{
      btn.addEventListener('click',(e)=>{
        const d = btn.getAttribute('data-dept');
        const l = btn.getAttribute('data-line');
        const s = btn.getAttribute('data-serial');
        const key = `${d}||${l}||${s}`;
        const isActive = btn.classList.toggle('active');
        if(isActive) selectedSerials.add(key); else selectedSerials.delete(key);
        applyFilters();
        drawAllSparklines();
        selCounter.textContent = `é¸æŠä¸­ï¼šéƒ¨ç½² ${selectedDepts.size}ï¼ãƒ©ã‚¤ãƒ³ ${selectedLines.size}ï¼æ•´ç†No ${selectedSerials.size}`;
        e.stopPropagation();
      });
    });

    serialsHolder.style.display='block';
    selCounter.textContent = `é¸æŠä¸­ï¼šéƒ¨ç½² ${selectedDepts.size}ï¼ãƒ©ã‚¤ãƒ³ ${selectedLines.size}ï¼æ•´ç†No ${selectedSerials.size}`;
  }

  function fmtMD(ts){
    const d = new Date(ts);
    return `${d.getMonth()+1}/${String(d.getDate()).padStart(2,'0')}`;
  }

  function setSparkDateLabels(containerSelector, binsInfo){
    if(!binsInfo?.bins?.length) return;
    const firstStart = binsInfo.bins[0].start;
    const lastEnd    = binsInfo.bins[binsInfo.bins.length-1].end;

    const startLabel = fmtMD(firstStart);
    const endLabel   = fmtMD(lastEnd);

    document.querySelectorAll(`${containerSelector} .btn-pill`).forEach(btn=>{
      const startEl = btn.querySelector('.spark-start');
      const endEl   = btn.querySelector('.spark-end');
      if(startEl) startEl.textContent = startLabel;
      if(endEl)   endEl.textContent   = endLabel;
    });
  }

  /* ===== ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ï¼ˆæç”»ï¼‰ ===== */
  function rr(ctx, x, y, w, h, r, fill, stroke){
    ctx.save();
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y,   x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x,   y+h, r);
    ctx.arcTo(x,   y+h, x,   y,   r);
    ctx.arcTo(x,   y,   x+w, y,   r);
    ctx.closePath();
    if(fill){ ctx.fillStyle = fill; ctx.fill(); }
    if(stroke){ ctx.strokeStyle = stroke; ctx.lineWidth = 1; ctx.stroke(); }
    ctx.restore();
  }

  function drawShiftMarker(ctx, canvas, opts){
    if(!opts || opts.markerIndex==null) return;
    const dpr = window.devicePixelRatio || 1;
    const pad = 6 * dpr;
    const step = (canvas.width - pad*2) / Math.max(1,(opts.count-1));
    const x = pad + step * opts.markerIndex;

    const dark = document.body.classList.contains('theme-dark');

    ctx.save();
    ctx.strokeStyle = dark ? 'rgba(255,255,255,0.65)' : 'rgba(0,0,0,0.55)';
    ctx.setLineDash([4*dpr, 3*dpr]);
    ctx.lineWidth = 1.5 * dpr;
    ctx.beginPath();
    ctx.moveTo(x, pad);
    ctx.lineTo(x, canvas.height - pad);
    ctx.stroke();
    ctx.restore();

    const label = (opts.label ?? '17') + '';

    ctx.save();
    const fontPx = 11 * dpr;
    ctx.font = `600 ${fontPx}px system-ui`;
    const textW = ctx.measureText(label).width;
    const px = 6 * dpr, py = 3 * dpr;
    const boxW = textW + px*2;
    const boxH = fontPx + py*2;
    const boxX = Math.min(Math.max(x - boxW/2, pad), canvas.width - pad - boxW);
    const boxY = pad + 2 * dpr;

    const bg     = dark ? 'rgba(0,0,0,0.80)'  : 'rgba(255,255,255,0.95)';
    const border = dark ? 'rgba(255,255,255,0.40)' : 'rgba(0,0,0,0.25)';
    const text   = dark ? '#ffffff' : '#111111';

    rr(ctx, boxX, boxY, boxW, boxH, 6*dpr, bg, border);

    ctx.fillStyle = text;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.shadowColor = dark ? 'rgba(0,0,0,0.35)' : 'rgba(0,0,0,0.15)';
    ctx.shadowBlur = 2 * dpr;
    ctx.fillText(label, boxX + boxW/2, boxY + boxH/2);
    ctx.restore();
  }

  function drawLineSpark(canvas, values, color='rgba(66,133,244,0.85)', opts={}){
    if (!canvas) return;

    const arr = (Array.isArray(values) ? values : []).map(v=>{
      const n = Number(v);
      return Number.isFinite(n) && n >= 0 ? n : 0;
    });
    const n = arr.length;
    if (!n) return;

    const dpr = window.devicePixelRatio || 1;
    ensureCanvasResolution(canvas);

    const ctx = canvas.getContext('2d'); if (!ctx) return;
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const max = Math.max(1, ...arr);
    const min = 0;

    const pad = 6 * dpr;
    const xStep = n > 1 ? (canvas.width - pad*2)/(n-1) : 0;

    ctx.strokeStyle = document.body.classList.contains('theme-dark')
      ? 'rgba(255,255,255,0.18)' : 'rgba(0,0,0,0.12)';
    ctx.lineWidth = 1 * dpr;
    ctx.beginPath();
    ctx.moveTo(pad, canvas.height - pad);
    ctx.lineTo(canvas.width - pad, canvas.height - pad);
    ctx.stroke();

    if (opts.type === 'hour' && typeof opts.markerIndex === 'number'){
      const hour = (8 + opts.markerIndex) % 24;
      drawShiftMarker(ctx, canvas, { markerIndex: opts.markerIndex, count: n, label: String(hour) });
    }

    ctx.font = `${10*dpr}px 'Segoe UI', sans-serif`;
    ctx.fillStyle = document.body.classList.contains('theme-dark')
      ? 'rgba(255,255,255,0.65)' : 'rgba(0,0,0,0.55)';
    ctx.textAlign = 'right';
    ctx.textBaseline = 'top';
    ctx.fillText(String(Math.max(1, Math.round(max))), canvas.width - pad, pad * 0.5);

    const yMax = canvas.height - pad - (canvas.height - pad*2);
    ctx.save();
    ctx.strokeStyle = document.body.classList.contains('theme-dark')
      ? 'rgba(255,255,255,0.55)' : 'rgba(0,0,0,0.45)';
    ctx.setLineDash([4*dpr, 3*dpr]);
    ctx.lineWidth = 1 * dpr;
    ctx.beginPath();
    ctx.moveTo(pad, yMax);
    ctx.lineTo(canvas.width - pad, yMax);
    ctx.stroke();
    ctx.restore();

    ctx.strokeStyle = color;
    ctx.lineWidth = 2 * dpr;
    ctx.beginPath();
    for (let i=0;i<n;i++){
      const v = arr[i];
      const ratio = (max === 0) ? 0 : (v / max);
      const x = pad + xStep * i;
      const y = canvas.height - pad - ratio * (canvas.height - pad*2);
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    const lastX = pad + xStep*(n-1);
    const lastRatio = (max === 0) ? 0 : (arr[n-1] / max);
    const lastY = canvas.height - pad - lastRatio*(canvas.height - pad*2);
    ctx.fillStyle = color;
    ctx.beginPath(); ctx.arc(lastX,lastY,2.5*dpr,0,Math.PI*2); ctx.fill();
  }

  function hexToRgba(hex, alpha){ 
    const h=hex.replace('#',''); 
    const n=parseInt(h,16); 
    const r=(n>>16)&255,g=(n>>8)&255,b=n&255; 
    return `rgba(${r},${g},${b},${alpha})`; 
  }

  function drawStackedSpark(canvas, seriesList, colors=['#8ab4f8','#a3e0c0','#f9c58d','#f7a9b8','#c9b6f2'], opts={}){
    if (!canvas) return;

    const clean = (seriesList || []).map(s =>
      (Array.isArray(s)? s: []).map(v=>{
        const n = Number(v);
        return Number.isFinite(n) && n >= 0 ? n : 0;
      })
    );
    const L = clean?.[0]?.length || 0;
    if (!L) return;

    const dpr = window.devicePixelRatio || 1;
    ensureCanvasResolution(canvas);

    const ctx = canvas.getContext('2d'); if (!ctx) return;
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const sums = Array.from({length:L},(_,i)=> clean.reduce((a,s)=> a + (s[i]||0), 0));
    const maxSum = Math.max(1, ...sums);

    const pad = 6 * dpr;
    const step = (canvas.width - pad*2) / Math.max(1,(L-1));
    const baseY = canvas.height - pad;
    const height = canvas.height - pad*2;

    ctx.strokeStyle = document.body.classList.contains('theme-dark')
      ? 'rgba(255,255,255,0.18)' : 'rgba(0,0,0,0.12)';
    ctx.lineWidth = 1 * dpr;
    ctx.beginPath();
    ctx.moveTo(pad, baseY);
    ctx.lineTo(canvas.width - pad, baseY);
    ctx.stroke();

    if (opts.type === 'hour' && typeof opts.markerIndex === 'number'){
      const hour = (8 + opts.markerIndex) % 24;
      drawShiftMarker(ctx, canvas, { markerIndex: opts.markerIndex, count: L, label: String(hour) });
    }

    const yMax = baseY - height;
    ctx.save();
    ctx.strokeStyle = document.body.classList.contains('theme-dark')
      ? 'rgba(255,255,255,0.55)' : 'rgba(0,0,0,0.45)';
    ctx.setLineDash([4*dpr, 3*dpr]);
    ctx.lineWidth = 1 * dpr;
    ctx.beginPath();
    ctx.moveTo(pad, yMax);
    ctx.lineTo(canvas.width - pad, yMax);
    ctx.stroke();
    ctx.restore();

    ctx.font = `${10*dpr}px 'Segoe UI', sans-serif`;
    ctx.fillStyle = document.body.classList.contains('theme-dark')
      ? 'rgba(255,255,255,0.65)' : 'rgba(0,0,0,0.55)';
    ctx.textAlign = 'right';
    ctx.textBaseline = 'top';
    ctx.fillText(String(Math.round(maxSum)), canvas.width - pad, pad * 0.5);

    let accumPrev = Array(L).fill(0);
    clean.forEach((s,idx)=>{
      const topY = s.map((v,i)=> baseY - ((accumPrev[i]+v)/maxSum)*height);
      const botY = accumPrev.map((v,i)=> baseY - (v/maxSum)*height);

      ctx.beginPath();
      for (let i=0;i<L;i++){ const x=pad+step*i, y=topY[i]; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }
      for (let i=L-1;i>=0;i--){ const x=pad+step*i, y=botY[i]; ctx.lineTo(x,y); }
      ctx.closePath();
      ctx.fillStyle = hexToRgba(colors[idx%colors.length], 0.85);
      ctx.fill();

      accumPrev = accumPrev.map((v,i)=> v + (s[i]||0));
    });

    ctx.beginPath();
    for (let i=0;i<L;i++){
      const x = pad + step*i;
      const y = baseY - (sums[i]/maxSum)*height;
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.strokeStyle = (opts && opts.edgeColor)
      ? opts.edgeColor
      : (document.body.classList.contains('theme-dark') ? 'rgba(255,255,255,0.24)' : 'rgba(0,0,0,0.18)');
    ctx.lineWidth = 1 * dpr;
    ctx.stroke();
  }

  function refreshPillsForDate(){
    renderDeptBar();
    if(focusedDept) renderExpandPanel(focusedDept);
  }

  function buildBins(){
    if(autoRangeActive && dateFromStr && dateToStr){
      const to   = new Date(`${dateToStr}T23:59:59.999`).getTime();
      const bins = [];
      let cur=new Date(`${dateFromStr}T00:00:00`).getTime();
      while(cur<=to){
        const end=new Date(cur); end.setHours(23,59,59,999);
        bins.push({start:cur,end:end.getTime()});
        const next=new Date(cur); next.setDate(next.getDate()+1); next.setHours(0,0,0,0);
        cur = next.getTime();
      }
      return {type:'day', bins, markers:[]};
    }
    const selStr = (dateToStr || dateFromStr) ?? getToday();
    const selDate = new Date(`${selStr}T00:00:00`);
    if(sparkMode==='24h'){
      const start = new Date(selDate); start.setHours(8,0,0,0);
      const bins=[];
      for(let i=0;i<24;i++){
        const s=new Date(start); s.setHours(s.getHours()+i);
        const e=new Date(start); e.setHours(e.getHours()+i+1); e.setMilliseconds(e.getMilliseconds()-1);
        bins.push({start:s.getTime(), end:e.getTime()});
      }
      return {type:'hour', bins, markers:[9]};
    }else{
      const days = (sparkMode==='30d')?30:7;
      const bins=[];
      for(let i=days-1;i>=0;i--){
        const d=new Date(selDate); d.setDate(d.getDate()-i);
        const s=new Date(d); s.setHours(0,0,0,0);
        const e=new Date(d); e.setHours(23,59,59,999);
        bins.push({start:s.getTime(), end:e.getTime()});
      }
      return {type:'day', bins, markers:[]};
    }
  }

  function buildSeriesMapsFlexible(data){
    const {bins} = buildBins();
    const len=bins.length;

    const deptSeries=new Map();
    const deptStack =new Map();
    const lineSeries=new Map();
    const lineStack =new Map();

    function binIndex(ms){
      for(let i=0;i<len;i++){ const b=bins[i]; if(ms>=b.start && ms<=b.end) return i; }
      return -1;
    }

    for(const it of data){
      const ms = getOccurrenceMsLocal(it);
      if(ms==null) continue;
      const idx=binIndex(ms);
      if(idx<0) continue;

      const dept=it.departmentNormalized||'æœªè¨­å®š';
      const line=it.lineNameNormalized||'æœªè¨­å®š';
      const sn  =it.serialNo||'æœªè¨­å®š';

      if(!deptSeries.has(dept)) deptSeries.set(dept, Array(len).fill(0));
      deptSeries.get(dept)[idx]+=1;

      if(!deptStack.has(dept)) deptStack.set(dept,new Map());
      if(!deptStack.get(dept).has(line)) deptStack.get(dept).set(line, Array(len).fill(0));
      deptStack.get(dept).get(line)[idx]+=1;

      if(!lineSeries.has(dept)) lineSeries.set(dept,new Map());
      if(!lineSeries.get(dept).has(line)) lineSeries.get(dept).set(line, Array(len).fill(0));
      lineSeries.get(dept).get(line)[idx]+=1;

      if(!lineStack.has(dept)) lineStack.set(dept,new Map());
      if(!lineStack.get(dept).has(line)) lineStack.get(dept).set(line,new Map());
      if(!lineStack.get(dept).get(line).has(sn)) lineStack.get(dept).get(line).set(sn, Array(len).fill(0));
      lineStack.get(dept).get(line).get(sn)[idx]+=1;
    }

    return {deptSeries,deptStack,lineSeries,lineStack};
  }

  function drawAllSparklines(){
    const binsInfo = buildBins();
    const {deptSeries,deptStack,lineSeries,lineStack}=buildSeriesMapsFlexible(allData);
    const binsLen = binsInfo.bins.length;

    const drawOpts = (seriesLen)=>({
      type: binsInfo.type,
      markerIndex: (binsInfo.type==='hour' ? 9 : null),
      count: seriesLen
    });

    document.querySelectorAll('#deptBar [data-role="dept"]').forEach(btn=>{
      const dept=btn.getAttribute('data-dept');
      const canvas=btn.querySelector('.sparkline');
      const color = getDeptSparkColor(dept);
      if(viewMode==='stack'){
        const stacks = [...(deptStack.get(dept)?.values()||[])];
        const fallback = stacks.length? stacks : [Array(binsLen).fill(0)];
        const o = drawOpts(binsLen); o.edgeColor = color;
        drawStackedSpark(canvas, fallback, undefined, o);
      }else{
        const vals=deptSeries.get(dept)||Array(binsLen).fill(0);
        drawLineSpark(canvas, vals, color, drawOpts(binsLen));
      }
    });

    document.querySelectorAll('#linesGrid [data-role="line"]').forEach(btn=>{
      const dept=btn.getAttribute('data-dept');
      const line=btn.getAttribute('data-line');
      const canvas=btn.querySelector('.sparkline');
      if(viewMode==='stack'){
        const stacks = [...(lineStack.get(dept)?.get(line)?.values()||[])];
        const fallback = stacks.length? stacks : [Array(binsLen).fill(0)];
        drawStackedSpark(canvas, fallback, undefined, drawOpts(binsLen));
      }else{
        const vals=(lineSeries.get(dept)?.get(line))||Array(binsLen).fill(0);
        drawLineSpark(canvas, vals, 'rgba(66,133,244,0.85)', drawOpts(binsLen));
      }
    });

    document.querySelectorAll('#serialsGrid [data-role="serial"]').forEach(btn=>{
      const dept=btn.getAttribute('data-dept');
      const line=btn.getAttribute('data-line');
      const sn  =btn.getAttribute('data-serial');
      const canvas=btn.querySelector('.sparkline');
      const map = lineStack.get(dept)?.get(line);
      const vals = map?.get(sn) || [];
      const bins = vals.length? vals : Array(binsLen).fill(0);
      drawLineSpark(canvas, bins, 'rgba(66,133,244,0.85)', drawOpts(binsLen));
    });

    const hint=document.getElementById('modeHint');
    if(autoRangeActive && dateFromStr && dateToStr){
      hint.textContent = `æœŸé–“ï¼ˆ${dateFromStr}ã€œ${dateToStr}ï¼‰ï¼è¡¨ç¤º:${viewMode==='stack'?'ç©ã¿ä¸Šã’':'åˆè¨ˆ'}`;
    }else{
      const base = (dateToStr || dateFromStr) ?? getToday();
      const p = (sparkMode==='7d')?`7æ—¥`:(sparkMode==='30d')?`30æ—¥`:`24æ™‚é–“ï¼ˆ8:00ã€œç¿Œ8:00ï¼‰`;
      hint.textContent = `${base} ã‚’åŸºæº–ã« ${p} ï¼è¡¨ç¤º:${viewMode==='stack'?'ç©ã¿ä¸Šã’':'åˆè¨ˆ'}`;
    }

    setSparkDateLabels('#deptBar',  binsInfo);
    setSparkDateLabels('#linesGrid', binsInfo);
    setSparkDateLabels('#serialsGrid', binsInfo);
  }

  function filterByDate(dataArr){
    let fromMs=null, toMs=null;
    if(dateFromStr && /^\d{4}-\d{2}-\d{2}$/.test(dateFromStr)){
      fromMs = new Date(`${dateFromStr}T00:00:00`).getTime();
    }
    if(dateToStr && /^\d{4}-\d{2}-\d{2}$/.test(dateToStr)){
      toMs = new Date(`${dateToStr}T23:59:59.999`).getTime();
    }
    if(fromMs===null && toMs===null) return dataArr;

    return dataArr.filter(it=>{
      const occMs = getOccurrenceMsLocal(it);
      if(occMs==null) return false;
      if(fromMs!==null && occMs<fromMs) return false;
      if(toMs!==null   && occMs>toMs)   return false;
      return true;
    });
  }

  /* ===== ãƒ•ã‚£ãƒ«ã‚¿ â†’ ãƒ†ãƒ¼ãƒ–ãƒ« ===== */
  function applyFilters(){
    let fromMs=null, toMs=null;
    if(dateFromStr && /^\d{4}-\d{2}-\d{2}$/.test(dateFromStr)){ fromMs=new Date(`${dateFromStr}T00:00:00`).getTime(); }
    if(dateToStr   && /^\d{4}-\d{2}-\d{2}$/.test(dateToStr)){   toMs  =new Date(`${dateToStr}T23:59:59.999`).getTime(); }

    filteredData = allData.filter(it=>{
      const occMs = getOccurrenceMsLocal(it);
      if(fromMs!==null || toMs!==null){
        if (occMs == null) return false;
        if(fromMs!==null && occMs<fromMs) return false;
        if(toMs!==null   && occMs>toMs)   return false;
      }

      const dept=it.departmentNormalized||'æœªè¨­å®š';
      const line=it.lineNameNormalized||'æœªè¨­å®š';
      const sn  =it.serialNo||'æœªè¨­å®š';

      if (selectedDepts.size > 0 && !selectedDepts.has(dept)) {
        return false;
      }
      if (selectedLines.size > 0 && !selectedLines.has(`${dept}||${line}`)) {
        return false;
      }
      if (selectedSerials.size > 0 && !selectedSerials.has(`${dept}||${line}||${sn}`)) {
        return false;
      }
      return true;
    });

    if(currentSort.column) applySorting();
    else renderTable();

    drawAllSparklines();
  }

  function renderTable(){
    const thead=document.getElementById('tableHead');
    const tbody=document.getElementById('tableBody');
const columns = visibleColumns
  .map(id => allColumns.find(c => c.id === id))
  .filter(Boolean);
    

    thead.innerHTML = `<tr>${
      columns.map(col=>`
        <th class="${col.sortable?'sortable':''} ${currentSort.column===col.id?('sort-'+currentSort.direction):''}" data-column="${col.id}">
          ${col.label}${col.filterable?'<span class="filter-icon">ğŸ”</span>':''}
        </th>`).join('')}</tr>`;

    thead.querySelectorAll('th.sortable').forEach(th=>{
      th.addEventListener('click', ()=>{
        const col=th.getAttribute('data-column');
        if(currentSort.column===col) currentSort.direction = currentSort.direction==='asc'?'desc':'asc';
        else { currentSort.column=col; currentSort.direction='asc'; }
        applySorting();
      });
    });

    const display=(displayLimit && displayLimit>0)? filteredData.slice(0, displayLimit) : filteredData;

    if(display.length===0){
      tbody.innerHTML = `<tr><td colspan="${columns.length}">
        <div class="empty-state"><div class="empty-icon">ğŸ“­</div><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div></td></tr>`;
    }else{
      tbody.innerHTML = display.map(item=>`
        <tr data-id="${item._id}">
          ${columns.map(col=>{
            let v=item[col.id]??'-';

            if (col.id==='occurrenceDate') {
              v = item.occurrenceDateISO || item.createdAtISO || '-';

            } else if (col.id==='occurrenceTime') {
              v = item.occurrenceTimeNorm || '-';

            } else if (col.id==='restartTime') {
              v = item.restartTimeNorm || '-';

            } else if (col.id==='status') {
              const statusText = (item.status==='complete') ? 'å®Œäº†' : 'æŠ€è¡“å…¥åŠ›å¾…ã¡';
              const statusCls  = (item.status==='complete') ? 'status-complete' : 'status-pending';
              v = `<span class="status-badge ${statusCls}">${statusText}</span>`;

            } else if (col.id==='photos') {
              const mCnt = (item.mfgPhotoUrls||[]).length;
              const techCnt = (item.techPhotoUrls||[]).length;
              const total = mCnt + techCnt;
              v = total>0
                ? `<button class="photo-btn" onclick="event.stopPropagation(); showPhotosOnly('${item._id}')">ğŸ“· ${total}æš</button>`
                : '-';

            } else if (col.id==='stopMinutes') {
              v = buildStopBadge(item.stopMinutes, {compact:true});

            } else if (col.id==='anomalyContent' || col.id==='actionTaken') {
              const s = v || '';
              v = (s.length>30 ? s.slice(0,30)+'...' : s);
            }

            return `<td>${v}</td>`;
          }).join('')}
        </tr>`).join('');
      tbody.querySelectorAll('tr').forEach(tr=>{
        tr.addEventListener('click',()=>showDetail(tr.getAttribute('data-id')));
      });
    }

    document.getElementById('resultCount').textContent=display.length;
    document.getElementById('totalCount').textContent=filteredData.length;
    enableHeaderReorder();
  }

// åˆ—ã®ãƒ‰ãƒ©ãƒƒã‚°å…¥ã‚Œæ›¿ãˆæ©Ÿèƒ½ï¼ˆPCå¯¾å¿œï¼‰
function enableHeaderReorder(){
  const ths = document.querySelectorAll('#tableHead th');
  ths.forEach(th=>{
    th.draggable = true;

    th.addEventListener('dragstart', e=>{
      headerDragActive = true;
      e.dataTransfer.setData('colId', th.dataset.column);
      th.classList.add('dragging');
    });

    th.addEventListener('dragend', ()=>{
      th.classList.remove('dragging');
      // åŒæœŸã‚¿ã‚¹ã‚¯çµ‚ã‚ã£ãŸæ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ ã§è§£é™¤ï¼ˆclickèª¤ç™ºç«å¯¾ç­–ï¼‰
      setTimeout(()=>{ headerDragActive = false; }, 0);
    });

    th.addEventListener('dragover', e=>{
      e.preventDefault();
      th.style.borderLeft = '3px solid var(--brand)';
    });

    th.addEventListener('dragleave', ()=>{
      th.style.borderLeft = '';
    });

    th.addEventListener('drop', e=>{
      e.preventDefault();
      th.style.borderLeft = '';
      const from = e.dataTransfer.getData('colId');
      const to = th.dataset.column;
      reorderColumns(from, to);
    });

    // â† clickï¼ˆæ˜‡é †/é™é †ãƒˆã‚°ãƒ«ï¼‰ã¯ drag ã®ã¨ãç„¡è¦–
    th.addEventListener('click', (ev)=>{
      if (headerDragActive) return;
      const col = th.getAttribute('data-column');
      if(currentSort.column===col) currentSort.direction = currentSort.direction==='asc'?'desc':'asc';
      else { currentSort.column=col; currentSort.direction='asc'; }
      applySorting();
    });
  });
}

// åˆ—é †ã‚’å…¥ã‚Œæ›¿ãˆã¦å†æç”»
function reorderColumns(fromId, toId){
  const fromIndex = visibleColumns.indexOf(fromId);
  const toIndex = visibleColumns.indexOf(toId);
  if(fromIndex === -1 || toIndex === -1 || fromIndex === toIndex) return;

  // ç§»å‹•å‡¦ç†
  const moved = visibleColumns.splice(fromIndex,1)[0];
  visibleColumns.splice(toIndex,0,moved);

  // ä¿å­˜
  localStorage.setItem('datasheetColumns', JSON.stringify(visibleColumns));

  // å†æç”»
  renderTable();
  enableHeaderReorder();
}

  function applySorting(){
    const col=currentSort.column, dir=currentSort.direction;
    filteredData.sort((a,b)=>{
      let A,B;
      if(col==='occurrenceDate'){A=a.occurrenceDateValue??a.createdAtValue??-Infinity; B=b.occurrenceDateValue??b.createdAtValue??-Infinity;}
      else if(col==='occurrenceTime'){A=a.occurrenceTimeNorm??''; B=b.occurrenceTimeNorm??'';}
      else if(col==='restartTime'){A=a.restartTimeNorm??''; B=b.restartTimeNorm??'';}
      else if(col==='stopMinutes'){A=a.stopMinutes??-Infinity; B=b.stopMinutes??-Infinity;}
      else {A=a[col]??''; B=b[col]??'';}
      if(A<B) return dir==='asc'?-1:1;
      if(A>B) return dir==='asc'?1:-1;
      return 0;
    });
    renderTable();
  }

  /* ===== CSV ===== */
  function exportCSV(){
    const cols=allColumns.filter(c=>visibleColumns.includes(c.id));
    const headers=cols.map(c=>c.label);
    let csv='\uFEFF'+headers.join(',')+'\n';
    filteredData.forEach(it=>{
      const row=cols.map(col=>{
        let v=it[col.id]??'';
        if(col.id==='occurrenceDate') v=it.occurrenceDateISO || it.createdAtISO || '';
        else if(col.id==='occurrenceTime') v=it.occurrenceTimeNorm||'';
        else if(col.id==='restartTime') v=it.restartTimeNorm||'';
        else if(col.id==='status') v=(it.status==='complete'?'å®Œäº†':'æŠ€è¡“å…¥åŠ›å¾…ã¡');
        else if(col.id==='stopMinutes' && it.stopMinutes!=null) v=it.stopMinutes;
        return `"${String(v).replace(/"/g,'""')}"`;
      });
      csv+=row.join(',')+'\n';
    });
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const link=document.createElement('a');
    link.href=URL.createObjectURL(blob);
    link.download=`ç•°å¸¸å±¥æ­´_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
  }

  /* ===== è©³ç´°ãƒ»å†™çœŸ ===== */
  function showDetail(id){
    const item=allData.find(x=>x._id===id); if(!item) return;

    const sm = (typeof item.stopMinutes==='number') ? item.stopMinutes : null;
    let stopBadgeCls='badge-muted', stopBadgeLbl='åœæ­¢æ™‚é–“: -';
    if (sm!=null){
      if (sm >= 60){ stopBadgeCls='badge-danger'; stopBadgeLbl=`åœæ­¢æ™‚é–“: ${sm}åˆ†`; }
      else if (sm >= 15){ stopBadgeCls='badge-warn'; stopBadgeLbl=`åœæ­¢æ™‚é–“: ${sm}åˆ†`; }
      else if (sm > 0){ stopBadgeCls='badge-good'; stopBadgeLbl=`åœæ­¢æ™‚é–“: ${sm}åˆ†`; }
      else { stopBadgeCls='badge-muted'; stopBadgeLbl='åœæ­¢æ™‚é–“: 0åˆ†'; }
    }

    const recRaw = (item.recurrenceType ?? item.recurrence ?? (item.isRepeat ? 'å†ç™º' : 'æ–°è¦')) || null;
    const isRepeat = typeof recRaw==='string' ? /å†ç™º|repeat/i.test(recRaw) : !!recRaw;
    const recBadgeCls = isRepeat ? 'badge-danger' : 'badge-info';
    const recBadgeLbl = isRepeat ? 'å†ç™º' : 'æ–°è¦';

    const modal=document.getElementById('detailModal');
    const title=document.getElementById('detailTitle');
    const body =document.getElementById('detailBody');

    const snText = item.serialNo || '-';
    title.innerHTML = `
      <span class="sn">æ•´ç†No: ${snText}</span>
      <span class="badge ${stopBadgeCls}"><span class="dot"></span>${stopBadgeLbl}</span>
      <span class="badge ${recBadgeCls}"><span class="dot"></span>${recBadgeLbl}</span>
    `;

    const mfg=item.mfgPhotoUrls||[], tech=item.techPhotoUrls||[];
    body.innerHTML=`
      <div class="detail-section"><div class="section-title">ğŸ“‹ åŸºæœ¬æƒ…å ±</div>
        <div class="detail-grid">
          <div class="detail-item"><div class="detail-label">éƒ¨ç½²</div><div class="detail-value">${item.department||'-'}</div></div>
          <div class="detail-item"><div class="detail-label">ãƒ©ã‚¤ãƒ³</div><div class="detail-value">${item.lineName||'-'}</div></div>
          <div class="detail-item"><div class="detail-label">ç™ºç”Ÿæ—¥</div><div class="detail-value">${item.occurrenceDateISO || item.createdAtISO || '-'}</div></div>
          <div class="detail-item"><div class="detail-label">ç™ºç”Ÿæ™‚åˆ»</div><div class="detail-value">${item.occurrenceTimeNorm||'-'}</div></div>
          <div class="detail-item"><div class="detail-label">å†é–‹æ™‚åˆ»</div><div class="detail-value">${item.restartTimeNorm||'-'}</div></div>
          <div class="detail-item"><div class="detail-label">å‡¦ç½®è€…</div><div class="detail-value">${item.handler||'-'}</div></div>
          <div class="detail-item"><div class="detail-label">çŠ¶æ…‹</div><div class="detail-value">
            <span class="status-badge ${item.status==='complete'?'status-complete':'status-pending'}">${item.status==='complete'?'å®Œäº†':'æŠ€è¡“å…¥åŠ›å¾…ã¡'}</span>
          </div></div>
        </div>
      </div>
      <div class="detail-section"><div class="section-title">ğŸš¨ ç•°å¸¸å†…å®¹</div><div class="detail-text-area">${item.anomalyContent||'-'}</div></div>
      <div class="detail-section"><div class="section-title">ğŸ”§ å¯¾å¿œå†…å®¹</div><div class="detail-text-area">${item.actionTaken||'-'}</div></div>
           <div class="detail-section">
       <div class="section-title">ğŸ› ï¸ æŠ€è¡“å¯¾å¿œå†…å®¹</div>
       <div class="detail-text-area">${item.rootCauseAction || '-'}</div>
     </div>
      ${mfg.length?`<div class="detail-section"><div class="section-title">ğŸ“· ç™ºä¿¡éƒ¨ç½²ã®å†™çœŸï¼ˆ${mfg.length}æšï¼‰</div><div class="photo-grid">${mfg.map(u=>`<div class="photo-thumbnail" onclick="window.open('${u}','_blank')"><img src="${u}" alt=""></div>`).join('')}</div></div>`:''}
      ${tech.length?`<div class="detail-section"><div class="section-title">ğŸ”§ æŠ€è¡“éƒ¨é–€ã®å†™çœŸï¼ˆ${tech.length}æšï¼‰</div><div class="photo-grid">${tech.map(u=>`<div class="photo-thumbnail" onclick="window.open('${u}','_blank')"><img src="${u}" alt=""></div>`).join('')}</div></div>`:''}
    `;
    modal.classList.add('active');
  }

  /* ===== è¡¨ç¤ºé …ç›®ï¼†ã‚µã‚¤ã‚ºè¨­å®š ===== */
  function loadSettings(){
    const saved = localStorage.getItem('datasheetColumns');
    try{
      const parsed = saved ? JSON.parse(saved) : null;
      if (Array.isArray(parsed) && parsed.length){
        visibleColumns = parsed.filter(id => allColumns.some(c => c.id === id));
        if (!visibleColumns.length) visibleColumns = [...DEFAULT_COLUMNS];
      }else{
        visibleColumns = [...DEFAULT_COLUMNS];
      }
    }catch(e){
      console.warn('column settings parse error', e);
      visibleColumns = [...DEFAULT_COLUMNS];
    }

    const savedLimit=localStorage.getItem('displayLimit');
    if(savedLimit!==null){
      const v=parseInt(savedLimit,10);
      if([25,50,75,100].includes(v)){
        displayLimit=v;
        document.getElementById('displayCount').value=String(v);
         const savedOrder = localStorage.getItem('columnOrder');
 if (savedOrder) {
   const order = JSON.parse(savedOrder);
   const existingIds = allColumns.map(c=>c.id);
   // ä¸æ­£ãªIDã‚’é™¤å¤–ã—ã¦é †åºåæ˜ 
   const valid = order.filter(id => existingIds.includes(id));
   // ä¸¦ã¹æ›¿ãˆã‚’åæ˜ 
   allColumns.sort((a,b)=> valid.indexOf(a.id) - valid.indexOf(b.id));
 }
      }
    }
    


    const pill = parseFloat(localStorage.getItem('pillScale'));           setPillScale(!Number.isNaN(pill)?pill:1.0,false);
    const base = parseFloat(localStorage.getItem('fontScale'));           setFontScale(!Number.isNaN(base)?base:1.0,false);
    const tbl  = parseFloat(localStorage.getItem('tableFontScale'));      setTableFontScale(!Number.isNaN(tbl)?tbl:1.0,false);
    const head = parseFloat(localStorage.getItem('headerTitleScale'));    setHeaderScale(!Number.isNaN(head)?head:1.0,false);
    const modf = parseFloat(localStorage.getItem('modalFontScale'));      setModalScale(!Number.isNaN(modf)?modf:1.0,false);
    const ptit = parseFloat(localStorage.getItem('pillTitleScale'));      setPillTitleScale(!Number.isNaN(ptit)?ptit:1.0,false);
    const psub = parseFloat(localStorage.getItem('pillSubScale'));        setPillSubScale(!Number.isNaN(psub)?psub:1.0,false);

    document.getElementById('slPill').value       = getVar('--pill-scale', '1');
    document.getElementById('slPillTitle').value  = getVar('--pill-title-scale', '1');
    document.getElementById('slPillSub').value    = getVar('--pill-sub-scale', '1');
    document.getElementById('slBase').value       = getVar('--font-scale', '1');
    document.getElementById('slTable').value      = getVar('--table-font-scale', '1');
    document.getElementById('slHeader').value     = getVar('--header-title-scale', '1');
    document.getElementById('slModal').value      = getVar('--modal-font-scale', '1');

    updateSizeLabels();
  }

  function getVar(name, fallback){
    const v=getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    return v || fallback;
  }

  function saveSettings(){ localStorage.setItem('datasheetColumns', JSON.stringify(visibleColumns)); }
  function saveDisplayLimit(){ localStorage.setItem('displayLimit', String(displayLimit)); }

  function setPillScale(v, persist=true){
    const val = clamp(v,0.8,2.5); document.documentElement.style.setProperty('--pill-scale', String(val));
    if(persist) localStorage.setItem('pillScale', String(val));
    drawAllSparklines();
  }
  function setPillTitleScale(v, persist=true){
    const val = clamp(v,0.8,1.6); document.documentElement.style.setProperty('--pill-title-scale', String(val));
    if(persist) localStorage.setItem('pillTitleScale', String(val));
  }
  function setPillSubScale(v, persist=true){
    const val = clamp(v,0.8,1.6); document.documentElement.style.setProperty('--pill-sub-scale', String(val));
    if(persist) localStorage.setItem('pillSubScale', String(val));
  }
  function setFontScale(v, persist=true){
    const val = clamp(v,0.9,1.3); document.documentElement.style.setProperty('--font-scale', String(val));
    if(persist) localStorage.setItem('fontScale', String(val));
  }
  function setTableFontScale(v, persist=true){
    const val = clamp(v,0.9,1.3); document.documentElement.style.setProperty('--table-font-scale', String(val));
    if(persist) localStorage.setItem('tableFontScale', String(val));
  }
  function setHeaderScale(v, persist=true){
    const val = clamp(v,0.9,1.4); document.documentElement.style.setProperty('--header-title-scale', String(val));
    if(persist) localStorage.setItem('headerTitleScale', String(val));
  }
  function setModalScale(v, persist=true){
    const val = clamp(v,0.9,1.3); document.documentElement.style.setProperty('--modal-font-scale', String(val));
    if(persist) localStorage.setItem('modalFontScale', String(val));
  }

  function updateSizeLabels(){
    const g = name => parseFloat(getComputedStyle(document.documentElement).getPropertyValue(name)||'1');
    document.getElementById('valPill').textContent      = `${g('--pill-scale').toFixed(2)}Ã—`;
    document.getElementById('valPillTitle').textContent = `${g('--pill-title-scale').toFixed(2)}Ã—`;
    document.getElementById('valPillSub').textContent   = `${g('--pill-sub-scale').toFixed(2)}Ã—`;
    document.getElementById('valBase').textContent      = `${g('--font-scale').toFixed(2)}Ã—`;
    document.getElementById('valTable').textContent     = `${g('--table-font-scale').toFixed(2)}Ã—`;
    document.getElementById('valHeader').textContent    = `${g('--header-title-scale').toFixed(2)}Ã—`;
    document.getElementById('valModal').textContent     = `${g('--modal-font-scale').toFixed(2)}Ã—`;
  }

  const sizeModal = document.getElementById('sizeModal');
  document.getElementById('btnSizeSettings').addEventListener('click', ()=>{ sizeModal.classList.add('active'); updateSizeLabels(); });
  document.getElementById('btnCloseSize').addEventListener('click', ()=> sizeModal.classList.remove('active'));

  document.getElementById('slPill').addEventListener('input', e=>{ setPillScale(parseFloat(e.target.value), false); updateSizeLabels(); });
  document.getElementById('slPillTitle').addEventListener('input', e=>{ setPillTitleScale(parseFloat(e.target.value), false); updateSizeLabels(); });
  document.getElementById('slPillSub').addEventListener('input', e=>{ setPillSubScale(parseFloat(e.target.value), false); updateSizeLabels(); });
  document.getElementById('slBase').addEventListener('input', e=>{ setFontScale(parseFloat(e.target.value), false); updateSizeLabels(); });
  document.getElementById('slTable').addEventListener('input', e=>{ setTableFontScale(parseFloat(e.target.value), false); updateSizeLabels(); });
  document.getElementById('slHeader').addEventListener('input', e=>{ setHeaderScale(parseFloat(e.target.value), false); updateSizeLabels(); });
  document.getElementById('slModal').addEventListener('input', e=>{ setModalScale(parseFloat(e.target.value), false); updateSizeLabels(); });

  document.getElementById('btnSizeSave').addEventListener('click', ()=>{
    setPillScale(parseFloat(document.getElementById('slPill').value), true);
    setPillTitleScale(parseFloat(document.getElementById('slPillTitle').value), true);
    setPillSubScale(parseFloat(document.getElementById('slPillSub').value), true);
    setFontScale(parseFloat(document.getElementById('slBase').value), true);
    setTableFontScale(parseFloat(document.getElementById('slTable').value), true);
    setHeaderScale(parseFloat(document.getElementById('slHeader').value), true);
    setModalScale(parseFloat(document.getElementById('slModal').value), true);
    sizeModal.classList.remove('active');
  });

  document.getElementById('btnSizeReset').addEventListener('click', ()=>{
    setPillScale(1.0, true);
    setPillTitleScale(1.0, true);
    setPillSubScale(1.0, true);
    setFontScale(1.0, true);
    setTableFontScale(1.0, true);
    setHeaderScale(1.0, true);
    setModalScale(1.0, true);
    document.getElementById('slPill').value='1.00';
    document.getElementById('slPillTitle').value='1.00';
    document.getElementById('slPillSub').value='1.00';
    document.getElementById('slBase').value='1.00';
    document.getElementById('slTable').value='1.00';
    document.getElementById('slHeader').value='1.00';
    document.getElementById('slModal').value='1.00';
    updateSizeLabels();
    drawAllSparklines();
  });

  document.getElementById('btnSettings').addEventListener('click', ()=>{
    const modal=document.getElementById('settingsModal');
    const container=document.getElementById('columnSettings');
    container.innerHTML = allColumns.map(col=>`
      <div class="column-checkbox" style="margin:6px 0; display:flex; align-items:center; gap:8px; color:var(--ink)">
        <input type="checkbox" id="col-${col.id}" ${visibleColumns.includes(col.id)?'checked':''}>
        <label for="col-${col.id}">${col.label}</label>
      </div>`).join('');
    modal.classList.add('active');
  });

  document.getElementById('btnSaveSettings').addEventListener('click',()=>{
    visibleColumns=[]; allColumns.forEach(col=>{ const cb=document.getElementById(`col-${col.id}`); if(cb && cb.checked) visibleColumns.push(col.id); });
    saveSettings(); document.getElementById('settingsModal').classList.remove('active'); renderTable();
  });

  document.getElementById('btnCloseSettings').addEventListener('click',()=>document.getElementById('settingsModal').classList.remove('active'));

  document.getElementById('btnCloseDetail').addEventListener('click',()=>document.getElementById('detailModal').classList.remove('active'));
  document.getElementById('btnExport').addEventListener('click', exportCSV);
  document.getElementById('displayCount').addEventListener('change', e=>{displayLimit=parseInt(e.target.value,10); saveDisplayLimit(); renderTable();});

  document.getElementById('detailModal').addEventListener('click', (e)=>{
    if (e.target === e.currentTarget) {
      e.currentTarget.classList.remove('active');
    }
  });

  function setManualMode(mode){
    autoRangeActive=false;
    sparkMode=mode;
    lastManualSparkMode=mode;
    document.getElementById('mode7').classList.toggle('active', mode==='7d');
    document.getElementById('mode30').classList.toggle('active', mode==='30d');
    document.getElementById('mode24').classList.toggle('active', mode==='24h');
    drawAllSparklines();
  }

  document.getElementById('mode7').addEventListener('click', ()=>setManualMode('7d'));
  document.getElementById('mode30').addEventListener('click',()=>setManualMode('30d'));
  document.getElementById('mode24').addEventListener('click',()=>setManualMode('24h'));
  setManualMode('24h');

  function setViewMode(mode){
    viewMode = mode;
    document.getElementById('viewTotal').classList.toggle('active', mode==='total');
    document.getElementById('viewStack').classList.toggle('active', mode==='stack');
    drawAllSparklines();
  }

  document.getElementById('viewTotal').addEventListener('click', ()=>setViewMode('total'));
  document.getElementById('viewStack').addEventListener('click', ()=>setViewMode('stack'));

  document.getElementById('btnYesterday').addEventListener('click',()=>{
    const y=getPreviousBusinessDay(); dateFromStr=y; dateToStr=y;
    document.getElementById('dateFrom').value=y; document.getElementById('dateTo').value=y;
    document.getElementById('btnYesterday').classList.add('active'); document.getElementById('btnToday').classList.remove('active');
    autoRangeActive=true; drawAllSparklines();
    refreshPillsForDate();
    applyFilters();
  });

  document.getElementById('btnToday').addEventListener('click',()=>{
    const t=getOperationalToday(); dateFromStr=t; dateToStr=t;
    document.getElementById('dateFrom').value=t; document.getElementById('dateTo').value=t;
    document.getElementById('btnToday').classList.add('active'); document.getElementById('btnYesterday').classList.remove('active');
    autoRangeActive=true; drawAllSparklines();
    refreshPillsForDate();
    applyFilters();
  });

  function onDateChange(){
    const f=document.getElementById('dateFrom').value||null;
    const t=document.getElementById('dateTo').value||null;
    dateFromStr=f; dateToStr=t;
    document.getElementById('btnYesterday').classList.remove('active');
    document.getElementById('btnToday').classList.remove('active');

    if(f || t){ autoRangeActive=true; } else { autoRangeActive=false; sparkMode=lastManualSparkMode; }
    drawAllSparklines();
    refreshPillsForDate();
    applyFilters();
  }

  document.getElementById('dateFrom').addEventListener('change', onDateChange);
  document.getElementById('dateTo').addEventListener('change', onDateChange);

  document.getElementById('btnClearDate').addEventListener('click',()=>{
    dateFromStr=null; dateToStr=null;
    document.getElementById('dateFrom').value=''; document.getElementById('dateTo').value='';
    document.getElementById('btnYesterday').classList.remove('active'); document.getElementById('btnToday').classList.remove('active');
    autoRangeActive=false; sparkMode=lastManualSparkMode;
    drawAllSparklines();
    refreshPillsForDate();
    applyFilters();
  });

  document.getElementById('btnClearAll').addEventListener('click',()=>{
    selectedDepts.clear(); selectedLines.clear(); selectedSerials.clear();
    document.querySelectorAll('.btn-pill.active').forEach(b=>b.classList.remove('active'));
    document.getElementById('expandPanel').classList.remove('open');
    document.getElementById('linesGrid').innerHTML='';
    document.getElementById('serialsGrid').innerHTML='';
    document.getElementById('serialsHolder').style.display='none';
    const selCounter = document.getElementById('selCounter'); if(selCounter) selCounter.textContent='';
    applyFilters();
    drawAllSparklines();
  });

  document.getElementById('btnResetFilters').addEventListener('click',()=>{
    selectedDepts.clear(); selectedLines.clear(); selectedSerials.clear();
    document.querySelectorAll('.btn-pill.active').forEach(b=>b.classList.remove('active'));
    dateFromStr=null; dateToStr=null;
    document.getElementById('dateFrom').value=''; document.getElementById('dateTo').value='';
    document.getElementById('btnYesterday').classList.remove('active'); document.getElementById('btnToday').classList.remove('active');
    autoRangeActive=false; sparkMode=lastManualSparkMode||'7d';
    const selCounter = document.getElementById('selCounter'); if(selCounter) selCounter.textContent='';
    drawAllSparklines();
    refreshPillsForDate();
    applyFilters();
  });

  document.getElementById('btnResetSort').addEventListener('click',()=>{ currentSort={column:null,direction:'asc'}; renderTable(); });
  // === Esc ã§è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ ===
window.addEventListener('keydown', (e)=>{
  if (e.key === 'Escape') {
    const modal = document.getElementById('detailModal');
    if (modal && modal.classList.contains('active')) {
      modal.classList.remove('active');
    }
  }
});

// === å…¨ç”»é¢è¡¨ç¤ºæ©Ÿèƒ½ ===
const btnFullscreen = document.getElementById('btnFullscreen');
const sheet = document.querySelector('.datasheet-container');
let isFullscreen = false;

btnFullscreen.addEventListener('click', () => {
  isFullscreen = !isFullscreen;
  sheet.classList.toggle('fullscreen', isFullscreen);
  document.body.classList.toggle('fullscreen-active', isFullscreen);
  btnFullscreen.textContent = isFullscreen ? 'ğŸ”™ æˆ»ã‚‹' : 'ğŸ–¥ï¸ å…¨ç”»é¢';
});

  (async()=>{
    const ok=await checkAuth(); if(!ok){ alert('èªè¨¼ãŒå¿…è¦ã§ã™'); return; }
    loadSettings();

    const t = getOperationalToday();
    const df = document.getElementById('dateFrom');
    const dt = document.getElementById('dateTo');

    if (df && !df.value) df.value = t;
    if (dt && !dt.value) dt.value = t;

    if (!dateFromStr && !dateToStr) {
      dateFromStr = t;
      dateToStr   = t;
      autoRangeActive = true;
      const btnToday = document.getElementById('btnToday');
      const btnYesterday = document.getElementById('btnYesterday');
      if (btnToday) btnToday.classList.add('active');
      if (btnYesterday) btnYesterday.classList.remove('active');
    }

    await loadData();
  })();
</script>
</body>
</html>
