<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•°å¸¸å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

body {
font-family: -apple-system, BlinkMacSystemFont, â€˜Segoe UIâ€™, â€˜Hiragino Sansâ€™, sans-serif;
background: #f5f5f7;
color: #1d1d1f;
}

.header {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: #fff;
padding: 20px;
box-shadow: 0 2px 10px rgba(0,0,0,.1);
position: sticky;
top: 0;
z-index: 100;
}

.header-content {
max-width: 1400px;
margin: 0 auto;
display: flex;
justify-content: space-between;
align-items: center;
}

.header h1 {
font-size: 1.5rem;
font-weight: 600;
}

.header-actions {
display: flex;
gap: 10px;
}

.btn-header {
background: rgba(255,255,255,.2);
border: 1px solid rgba(255,255,255,.3);
color: #fff;
padding: 8px 16px;
border-radius: 6px;
cursor: pointer;
font-weight: 500;
transition: .2s;
}

.btn-header:hover {
background: rgba(255,255,255,.3);
}

.container {
max-width: 1400px;
margin: 0 auto;
padding: 20px;
}

/* æœŸé–“é¸æŠã‚¨ãƒªã‚¢ */
.date-filter {
background: #fff;
border-radius: 12px;
padding: 20px;
margin-bottom: 20px;
box-shadow: 0 2px 8px rgba(0,0,0,.08);
}

.date-filter-header {
font-size: 1.1rem;
font-weight: 600;
color: #667eea;
margin-bottom: 16px;
}

.date-controls {
display: flex;
gap: 12px;
align-items: center;
flex-wrap: wrap;
}

.date-input-group {
display: flex;
gap: 8px;
align-items: center;
}

.date-input-group input[type=â€œdateâ€] {
padding: 10px 14px;
border: 2px solid #e0e0e0;
border-radius: 8px;
font-size: .95rem;
transition: .2s;
}

.date-input-group input[type=â€œdateâ€]:focus {
outline: none;
border-color: #667eea;
}

.date-quick-btn {
padding: 10px 20px;
border: 2px solid #667eea;
background: #fff;
color: #667eea;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
transition: .2s;
white-space: nowrap;
}

.date-quick-btn:hover {
background: #f8f9ff;
}

.date-quick-btn.active {
background: #667eea;
color: #fff;
}

/* éƒ¨ç½²é¸æŠã‚¨ãƒªã‚¢ */
.dept-filter {
background: #fff;
border-radius: 12px;
padding: 20px;
margin-bottom: 20px;
box-shadow: 0 2px 8px rgba(0,0,0,.08);
}

.dept-filter-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 16px;
}

.dept-filter-title {
font-size: 1.1rem;
font-weight: 600;
color: #667eea;
}

.dept-buttons {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
gap: 12px;
}

.dept-btn {
padding: 16px 20px;
border: 2px solid #e0e0e0;
background: #fff;
border-radius: 10px;
cursor: pointer;
font-size: 1rem;
font-weight: 600;
transition: .2s;
text-align: center;
}

.dept-btn:hover {
border-color: #667eea;
background: #f8f9ff;
}

.dept-btn.active {
border-color: #667eea;
background: #667eea;
color: #fff;
}

.dept-count {
font-size: .85rem;
opacity: .8;
margin-top: 4px;
}

/* ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã‚¨ãƒªã‚¢ */
.datasheet-container {
background: #fff;
border-radius: 12px;
box-shadow: 0 2px 8px rgba(0,0,0,.08);
overflow: hidden;
}

.datasheet-toolbar {
padding: 16px 20px;
border-bottom: 1px solid #e0e0e0;
display: flex;
justify-content: space-between;
align-items: center;
background: #f8f9fa;
flex-wrap: wrap;
gap: 12px;
}

.result-count {
font-size: 1rem;
color: #666;
}

.result-count strong {
color: #667eea;
font-size: 1.2rem;
}

.display-count-selector {
display: flex;
align-items: center;
gap: 8px;
}

.display-count-selector label {
font-size: .9rem;
color: #666;
white-space: nowrap;
}

.display-count-selector select {
padding: 6px 12px;
border: 2px solid #e0e0e0;
border-radius: 6px;
background: #fff;
cursor: pointer;
font-size: .9rem;
transition: .2s;
}

.display-count-selector select:focus {
outline: none;
border-color: #667eea;
}

.toolbar-actions {
display: flex;
gap: 10px;
flex-wrap: wrap;
}

.btn-tool {
padding: 8px 16px;
border: 1px solid #e0e0e0;
background: #fff;
border-radius: 6px;
cursor: pointer;
font-weight: 500;
transition: .2s;
}

.btn-tool:hover {
border-color: #667eea;
background: #f8f9ff;
}

/* ãƒ†ãƒ¼ãƒ–ãƒ« */
.table-wrapper {
overflow-x: auto;
max-height: calc(100vh - 400px);
position: relative;
}

table {
width: 100%;
border-collapse: collapse;
font-size: .9rem;
}

thead {
position: sticky;
top: 0;
z-index: 10;
background: #fff;
}

th {
padding: 12px 16px;
text-align: left;
background: #667eea;
color: #fff;
font-weight: 600;
white-space: nowrap;
cursor: pointer;
user-select: none;
position: relative;
}

th:hover {
background: #5568d3;
}

th.sortable::after {
content: â€˜â‡…â€™;
margin-left: 8px;
opacity: .4;
}

th.sort-asc::after {
content: â€˜â†‘â€™;
opacity: 1;
}

th.sort-desc::after {
content: â€˜â†“â€™;
opacity: 1;
}

.filter-icon {
margin-left: 6px;
font-size: .8rem;
opacity: .6;
}

td {
padding: 12px 16px;
border-bottom: 1px solid #f0f0f0;
}

tr {
cursor: pointer;
transition: background .15s;
}

tbody tr:hover {
background: #f8f9ff;
}

.status-badge {
display: inline-block;
padding: 4px 12px;
border-radius: 12px;
font-size: .85rem;
font-weight: 600;
}

.status-pending {
background: #fff3cd;
color: #856404;
}

.status-complete {
background: #d4edda;
color: #155724;
}

/* è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal {
display: none;
position: fixed;
inset: 0;
background: rgba(0,0,0,.5);
z-index: 1000;
align-items: center;
justify-content: center;
}

.modal.active {
display: flex;
}

.modal-content {
background: #fff;
border-radius: 16px;
max-width: 900px;
width: 95%;
max-height: 90vh;
overflow-y: auto;
box-shadow: 0 20px 60px rgba(0,0,0,.3);
}

.modal-header {
padding: 24px;
border-bottom: 1px solid #e0e0e0;
display: flex;
justify-content: space-between;
align-items: center;
position: sticky;
top: 0;
background: #fff;
z-index: 10;
}

.modal-title {
font-size: 1.3rem;
font-weight: 600;
color: #667eea;
}

.btn-close {
background: #f0f0f0;
border: none;
width: 32px;
height: 32px;
border-radius: 50%;
cursor: pointer;
font-size: 1.2rem;
color: #666;
transition: .2s;
}

.btn-close:hover {
background: #e0e0e0;
}

.modal-body {
padding: 24px;
}

.detail-section {
margin-bottom: 24px;
}

.section-title {
font-size: 1rem;
font-weight: 600;
color: #667eea;
margin-bottom: 12px;
padding-bottom: 8px;
border-bottom: 2px solid #e0e0e0;
}

.detail-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 16px;
}

.detail-item {
display: flex;
flex-direction: column;
gap: 4px;
}

.detail-label {
font-size: .85rem;
color: #888;
font-weight: 500;
}

.detail-value {
font-size: 1rem;
color: #333;
font-weight: 500;
}

.detail-text-area {
background: #f8f9fa;
padding: 12px;
border-radius: 8px;
line-height: 1.6;
white-space: pre-wrap;
}

/* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
.settings-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
gap: 12px;
}

.column-checkbox {
display: flex;
align-items: center;
gap: 8px;
padding: 12px;
border: 1px solid #e0e0e0;
border-radius: 8px;
cursor: pointer;
transition: .2s;
}

.column-checkbox:hover {
border-color: #667eea;
background: #f8f9ff;
}

.column-checkbox input[type=â€œcheckboxâ€] {
width: 18px;
height: 18px;
cursor: pointer;
}

.column-checkbox label {
cursor: pointer;
flex: 1;
}

.empty-state {
text-align: center;
padding: 60px 20px;
color: #999;
}

.empty-icon {
font-size: 3rem;
margin-bottom: 16px;
}

@media (max-width: 768px) {
.date-controls {
flex-direction: column;
align-items: stretch;
}

```
.date-input-group {
  flex-direction: column;
}

.date-quick-btn {
  width: 100%;
}

.dept-buttons {
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
}

.dept-btn {
  padding: 12px 16px;
  font-size: .9rem;
}

.header-content {
  flex-direction: column;
  gap: 12px;
}

.detail-grid {
  grid-template-columns: 1fr;
}
```

}
</style>

</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>ğŸ“Š ç•°å¸¸å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ</h1>
      <div class="header-actions">
        <button class="btn-header" id="btnSettings">âš™ï¸ è¡¨ç¤ºè¨­å®š</button>
        <button class="btn-header" id="btnExport">ğŸ“¥ CSVå‡ºåŠ›</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- æœŸé–“é¸æŠãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <div class="date-filter">
      <div class="date-filter-header">ğŸ“… æœŸé–“ã§çµã‚Šè¾¼ã¿</div>
      <div class="date-controls">
        <button class="date-quick-btn" id="btnYesterday">å‰æ—¥ï¼ˆå¹³æ—¥ï¼‰</button>
        <button class="date-quick-btn" id="btnToday">ä»Šæ—¥</button>
        <div class="date-input-group">
          <input type="date" id="dateFrom" placeholder="é–‹å§‹æ—¥">
          <span style="color:#999;">ã€œ</span>
          <input type="date" id="dateTo" placeholder="çµ‚äº†æ—¥">
        </div>
        <button class="btn-tool" id="btnClearDate">æœŸé–“ã‚¯ãƒªã‚¢</button>
      </div>
    </div>

```
<!-- éƒ¨ç½²é¸æŠãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
<div class="dept-filter">
  <div class="dept-filter-header">
    <div class="dept-filter-title">ğŸ¢ éƒ¨ç½²ã§çµã‚Šè¾¼ã¿ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</div>
    <button class="btn-tool" id="btnClearDept">ã™ã¹ã¦è§£é™¤</button>
  </div>
  <div class="dept-buttons" id="deptButtons">
    <!-- å‹•çš„ã«ç”Ÿæˆ -->
  </div>
</div>

<!-- ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ -->
<div class="datasheet-container">
  <div class="datasheet-toolbar">
    <div class="result-count">
      è¡¨ç¤ºä¸­: <strong id="resultCount">0</strong> ä»¶ / å…¨ <strong id="totalCount">0</strong> ä»¶
    </div>
    <div class="display-count-selector">
      <label for="displayCount">è¡¨ç¤ºä»¶æ•°:</label>
      <select id="displayCount">
        <option value="25">25ä»¶</option>
        <option value="50">50ä»¶</option>
        <option value="75">75ä»¶</option>
        <option value="100">100ä»¶</option>
      </select>
    </div>
    <div class="toolbar-actions">
      <button class="btn-tool" id="btnResetFilters">ğŸ”„ ãƒ•ã‚£ãƒ«ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
      <button class="btn-tool" id="btnResetSort">â†•ï¸ ã‚½ãƒ¼ãƒˆãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>
  <div class="table-wrapper">
    <table id="dataTable">
      <thead id="tableHead">
        <!-- å‹•çš„ã«ç”Ÿæˆ -->
      </thead>
      <tbody id="tableBody">
        <!-- å‹•çš„ã«ç”Ÿæˆ -->
      </tbody>
    </table>
  </div>
</div>
```

  </div>

  <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->

  <div class="modal" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="detailTitle">è©³ç´°æƒ…å ±</div>
        <button class="btn-close" id="btnCloseDetail">Ã—</button>
      </div>
      <div class="modal-body" id="detailBody">
        <!-- å‹•çš„ã«ç”Ÿæˆ -->
      </div>
    </div>
  </div>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->

  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">âš™ï¸ è¡¨ç¤ºé …ç›®è¨­å®š</div>
        <button class="btn-close" id="btnCloseSettings">Ã—</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom:16px;color:#666;">è¡¨ç¤ºã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        <div class="settings-grid" id="columnSettings">
          <!-- å‹•çš„ã«ç”Ÿæˆ -->
        </div>
        <button class="btn-header" style="width:100%;margin-top:20px;padding:12px;background:#667eea;border:none;font-size:1rem;" id="btnSaveSettings">ä¿å­˜</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
  import { getFirestore, collection, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyA0YUIpIDh4WB4p1ewiNB0XfwHve0ByljU",
    authDomain: "abnreport-fd733.firebaseapp.com",
    databaseURL: "https://abnreport-fd733-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "abnreport-fd733",
    storageBucket: "abnreport-fd733.firebasestorage.app",
    messagingSenderId: "349748947315",
    appId: "1:349748947315:web:010cb671d2a95bcf1f7d06"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // å…¨ãƒ‡ãƒ¼ã‚¿
  let allData = [];
  let filteredData = [];
  let selectedDepts = new Set();
  let dateFrom = null;
  let dateTo = null;
  let currentSort = { column: null, direction: 'asc' };

  // éƒ¨ç½²åã‚’æ­£è¦åŒ–ï¼ˆå…¨è§’â†’åŠè§’ã€ãƒˆãƒªãƒ ã€å¤§æ–‡å­—å°æ–‡å­—çµ±ä¸€ï¼‰
  function normalizeDeptName(name) {
    if (!name) return 'æœªè¨­å®š';
    return name
      .replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
      .replace(/ã€€/g, ' ')
      .trim()
      .toUpperCase();
  }

  // å¹³æ—¥ã®å‰æ—¥ã‚’å–å¾—ï¼ˆåœŸæ—¥ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
  function getPreviousBusinessDay() {
    const date = new Date();
    let dayOfWeek = date.getDay();
    
    // ä»Šæ—¥ãŒæœˆæ›œæ—¥(1)ãªã‚‰é‡‘æ›œæ—¥(-3æ—¥)ã€ãã‚Œä»¥å¤–ã¯å‰æ—¥(-1æ—¥)
    if (dayOfWeek === 1) {
      date.setDate(date.getDate() - 3);
    } else if (dayOfWeek === 0) {
      // æ—¥æ›œæ—¥ãªã‚‰é‡‘æ›œæ—¥(-2æ—¥)
      date.setDate(date.getDate() - 2);
    } else {
      date.setDate(date.getDate() - 1);
    }
    
    return formatDate(date);
  }

  // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
  function getToday() {
    return formatDate(new Date());
  }

  // æ—¥ä»˜ã‚’YYYY-MM-DDå½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
  function formatDate(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }

  // åˆ—å®šç¾©
  const allColumns = [
    { id: 'serialNo', label: 'æ•´ç†No', sortable: true, filterable: true },
    { id: 'department', label: 'éƒ¨ç½²', sortable: true, filterable: true },
    { id: 'lineName', label: 'ãƒ©ã‚¤ãƒ³', sortable: true, filterable: true },
    { id: 'occurrenceDate', label: 'ç™ºç”Ÿæ—¥', sortable: true, filterable: true },
    { id: 'occurrenceTime', label: 'ç™ºç”Ÿæ™‚åˆ»', sortable: true, filterable: false },
    { id: 'restartTime', label: 'å†é–‹æ™‚åˆ»', sortable: true, filterable: false },
    { id: 'stopMinutes', label: 'åœæ­¢æ™‚é–“', sortable: true, filterable: false },
    { id: 'handler', label: 'å‡¦ç½®è€…', sortable: true, filterable: true },
    { id: 'techHandler', label: 'æŠ€è¡“å‡¦ç½®è€…', sortable: true, filterable: true },
    { id: 'status', label: 'çŠ¶æ…‹', sortable: true, filterable: true },
    { id: 'anomalyContent', label: 'ç•°å¸¸å†…å®¹', sortable: false, filterable: true },
    { id: 'actionTaken', label: 'å¯¾å¿œå†…å®¹', sortable: false, filterable: true },
  ];

  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºåˆ—
  let visibleColumns = ['serialNo', 'department', 'lineName', 'occurrenceDate', 'occurrenceTime', 'stopMinutes', 'handler', 'status'];
  let displayLimit = 25; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºä»¶æ•°

  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
  function loadSettings() {
    const saved = localStorage.getItem('datasheetColumns');
    if (saved) {
      visibleColumns = JSON.parse(saved);
    }
    
    const savedLimit = localStorage.getItem('displayLimit');
    if (savedLimit) {
      displayLimit = parseInt(savedLimit);
      document.getElementById('displayCount').value = displayLimit.toString();
    }
  }

  // è¨­å®šã‚’ä¿å­˜
  function saveSettings() {
    localStorage.setItem('datasheetColumns', JSON.stringify(visibleColumns));
  }
  
  // è¡¨ç¤ºä»¶æ•°ã‚’ä¿å­˜
  function saveDisplayLimit() {
    localStorage.setItem('displayLimit', displayLimit.toString());
  }

  // èªè¨¼
  async function checkAuth() {
    return new Promise((resolve) => {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          resolve(true);
        } else {
          const email = prompt('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          const password = prompt('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          if (email && password) {
            setPersistence(auth, browserLocalPersistence)
              .then(() => signInWithEmailAndPassword(auth, email, password))
              .then(() => resolve(true))
              .catch((e) => {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
                resolve(false);
              });
          } else {
            resolve(false);
          }
        }
      });
    });
  }

  // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  async function loadData() {
    const q = query(collection(db, 'anomalies'), orderBy('createdAt', 'desc'));
    const snapshot = await getDocs(q);
    
    allData = snapshot.docs.map(doc => {
      const data = { _id: doc.id, ...doc.data() };
      
      // éƒ¨ç½²åã‚’æ­£è¦åŒ–
      data.departmentNormalized = normalizeDeptName(data.department);
      
      // åœæ­¢æ™‚é–“ã‚’è¨ˆç®—
      if (data.occurrenceTime && data.restartTime) {
        const [oh, om] = data.occurrenceTime.split(':').map(Number);
        const [rh, rm] = data.restartTime.split(':').map(Number);
        let diff = (rh * 60 + rm) - (oh * 60 + om);
        if (diff < 0) diff += 1440;
        data.stopMinutes = diff;
      } else {
        data.stopMinutes = null;
      }
      
      return data;
    });
    
    filteredData = [...allData];
    renderDepartmentButtons();
    renderTable();
  }

  // éƒ¨ç½²ãƒœã‚¿ãƒ³æç”»
  function renderDepartmentButtons() {
    const deptCounts = {};
    allData.forEach(item => {
      const dept = item.departmentNormalized;
      deptCounts[dept] = (deptCounts[dept] || 0) + 1;
    });
    
    const sortedDepts = Object.keys(deptCounts).sort();
    const container = document.getElementById('deptButtons');
    
    container.innerHTML = sortedDepts.map(dept => `
      <div class="dept-btn" data-dept="${dept}">
        <div>${dept}</div>
        <div class="dept-count">${deptCounts[dept]}ä»¶</div>
      </div>
    `).join('');
    
    // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    container.querySelectorAll('.dept-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const dept = btn.getAttribute('data-dept');
        if (selectedDepts.has(dept)) {
          selectedDepts.delete(dept);
          btn.classList.remove('active');
        } else {
          selectedDepts.add(dept);
          btn.classList.add('active');
        }
        applyFilters();
      });
    });
  }

  // ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
  function applyFilters() {
    filteredData = allData.filter(item => {
      // éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      if (selectedDepts.size > 0 && !selectedDepts.has(item.departmentNormalized)) {
        return false;
      }
      
      // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      if (dateFrom && item.occurrenceDate < dateFrom) {
        return false;
      }
      if (dateTo && item.occurrenceDate > dateTo) {
        return false;
      }
      
      return true;
    });
    
    // ã‚½ãƒ¼ãƒˆç¶­æŒ
    if (currentSort.column) {
      applySorting();
    } else {
      renderTable();
    }
  }

  // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
  function renderTable() {
    const thead = document.getElementById('tableHead');
    const tbody = document.getElementById('tableBody');
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼
    const columns = allColumns.filter(col => visibleColumns.includes(col.id));
    thead.innerHTML = `
      <tr>
        ${columns.map(col => `
          <th class="${col.sortable ? 'sortable' : ''} ${currentSort.column === col.id ? 'sort-' + currentSort.direction : ''}" 
              data-column="${col.id}">
            ${col.label}
            ${col.filterable ? '<span class="filter-icon">ğŸ”</span>' : ''}
          </th>
        `).join('')}
      </tr>
    `;
    
    // ã‚½ãƒ¼ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ
    thead.querySelectorAll('th.sortable').forEach(th => {
      th.addEventListener('click', () => {
        const column = th.getAttribute('data-column');
        if (currentSort.column === column) {
          currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          currentSort.column = column;
          currentSort.direction = 'asc';
        }
        applySorting();
      });
    });
    
    // è¡¨ç¤ºä»¶æ•°ã§åˆ¶é™
    const displayData = filteredData.slice(0, displayLimit);
    
    // ãƒœãƒ‡ã‚£
    if (displayData.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="${columns.length}">
            <div class="empty-state">
              <div class="empty-icon">ğŸ“­</div>
              <p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>
          </td>
        </tr>
      `;
    } else {
      tbody.innerHTML = displayData.map(item => `
        <tr data-id="${item._id}">
          ${columns.map(col => {
            let value = item[col.id] || '-';
            
            if (col.id === 'status') {
              const statusText = item.status === 'complete' ? 'å®Œäº†' : 'æŠ€è¡“å…¥åŠ›å¾…ã¡';
              const statusClass = item.status === 'complete' ? 'status-complete' : 'status-pending';
              value = `<span class="status-badge ${statusClass}">${statusText}</span>`;
            } else if (col.id === 'stopMinutes' && item.stopMinutes !== null) {
              value = `${item.stopMinutes}åˆ†`;
            } else if (col.id === 'anomalyContent' || col.id === 'actionTaken') {
              value = (value.length > 30 ? value.slice(0, 30) + '...' : value);
            }
            
            return `<td>${value}</td>`;
          }).join('')}
        </tr>
      `).join('');
      
      // è¡Œã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      tbody.querySelectorAll('tr').forEach(tr => {
        tr.addEventListener('click', () => {
          const id = tr.getAttribute('data-id');
          showDetail(id);
        });
      });
    }
    
    // ä»¶æ•°è¡¨ç¤º
    document.getElementById('resultCount').textContent = displayData.length;
    document.getElementById('totalCount').textContent = filteredData.length;
  }

  // ã‚½ãƒ¼ãƒˆé©ç”¨
  function applySorting() {
    const col = currentSort.column;
    const dir = currentSort.direction;
    
    filteredData.sort((a, b) => {
      let valA = a[col] || '';
      let valB = b[col] || '';
      
      // æ•°å€¤ã®å ´åˆ
      if (col === 'stopMinutes') {
        valA = valA || 0;
        valB = valB || 0;
      }
      
      if (valA < valB) return dir === 'asc' ? -1 : 1;
      if (valA > valB) return dir === 'asc' ? 1 : -1;
      return 0;
    });
    
    renderTable();
  }

  // è©³ç´°è¡¨ç¤º
  function showDetail(id) {
    const item = allData.find(x => x._id === id);
    if (!item) return;
    
    const modal = document.getElementById('detailModal');
    const title = document.getElementById('detailTitle');
    const body = document.getElementById('detailBody');
    
    title.textContent = `æ•´ç†No: ${item.serialNo || '-'}`;
    
    body.innerHTML = `
      <div class="detail-section">
        <div class="section-title">ğŸ“‹ åŸºæœ¬æƒ…å ±</div>
        <div class="detail-grid">
          <div class="detail-item">
            <div class="detail-label">æ•´ç†No</div>
            <div class="detail-value">${item.serialNo || '-'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">éƒ¨ç½²</div>
            <div class="detail-value">${item.department || '-'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">ãƒ©ã‚¤ãƒ³</div>
            <div class="detail-value">${item.lineName || '-'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">ç™ºç”Ÿæ—¥</div>
            <div class="detail-value">${item.occurrenceDate || '-'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">ç™ºç”Ÿæ™‚åˆ»</div>
            <div class="detail-value">${item.occurrenceTime || '-'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">å†é–‹æ™‚åˆ»</div>
            <div class="detail-value">${item.restartTime || '-'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">åœæ­¢æ™‚é–“</div>
            <div class="detail-value">${item.stopMinutes !== null ? item.stopMinutes + 'åˆ†' : '-'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">å‡¦ç½®è€…</div>
            <div class="detail-value">${item.handler || '-'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">çŠ¶æ…‹</div>
            <div class="detail-value">
              <span class="status-badge ${item.status === 'complete' ? 'status-complete' : 'status-pending'}">
                ${item.status === 'complete' ? 'å®Œäº†' : 'æŠ€è¡“å…¥åŠ›å¾…ã¡'}
              </span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="detail-section">
        <div class="section-title">ğŸš¨ ç•°å¸¸å†…å®¹</div>
        <div class="detail-text-area">${item.anomalyContent || '-'}</div>
      </div>
      
      <div class="detail-section">
        <div class="section-title">ğŸ”§ å¯¾å¿œå†…å®¹</div>
        <div class="detail-text-area">${item.actionTaken || '-'}</div>
      </div>
      
      ${item.status === 'complete' && item.techRequest === 'è¦è«‹' ? `
        <div class="detail-section">
          <div class="section-title">âš™ï¸ æŠ€è¡“å¯¾å¿œ</div>
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">æŠ€è¡“å‡¦ç½®è€…</div>
              <div class="detail-value">${item.techHandler || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°</div>
              <div class="detail-value">${item.discoveryTiming || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">å‘½æ•°æœ‰ç„¡</div>
              <div class="detail-value">${item.lifespan || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">å‘½æ•°åˆ°é”</div>
              <div class="detail-value">${item.lifespanReached || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">ä¿å…¨å˜ä½</div>
              <div class="detail-value">${item.maintenanceUnit || '-'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">å†ç™º/æ–°è¦</div>
              <div class="detail-value">${item.recurrenceType || '-'}</div>
            </div>
          </div>
          ${item.rootCauseAction ? `
            <div style="margin-top:16px;">
              <div class="detail-label" style="margin-bottom:8px;">æŠ€è¡“å¯¾å¿œå†…å®¹</div>
              <div class="detail-text-area">${item.rootCauseAction}</div>
            </div>
          ` : ''}
        </div>
      ` : ''}
    `;
    
    modal.classList.add('active');
  }

  // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«
  function showSettings() {
    const modal = document.getElementById('settingsModal');
    const container = document.getElementById('columnSettings');
    
    container.innerHTML = allColumns.map(col => `
      <div class="column-checkbox">
        <input type="checkbox" id="col-${col.id}" ${visibleColumns.includes(col.id) ? 'checked' : ''}>
        <label for="col-${col.id}">${col.label}</label>
      </div>
    `).join('');
    
    modal.classList.add('active');
  }

  // CSVå‡ºåŠ›
  function exportCSV() {
    const columns = allColumns.filter(col => visibleColumns.includes(col.id));
    const headers = columns.map(col => col.label);
    
    let csv = '\uFEFF' + headers.join(',') + '\n';
    
    filteredData.forEach(item => {
      const row = columns.map(col => {
        let value = item[col.id] || '';
        if (col.id === 'status') {
          value = item.status === 'complete' ? 'å®Œäº†' : 'æŠ€è¡“å…¥åŠ›å¾…ã¡';
        } else if (col.id === 'stopMinutes' && item.stopMinutes !== null) {
          value = item.stopMinutes;
        }
        return `"${value.toString().replace(/"/g, '""')}"`;
      });
      csv += row.join(',') + '\n';
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `ç•°å¸¸å±¥æ­´_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
  document.getElementById('btnSettings').addEventListener('click', showSettings);
  document.getElementById('btnExport').addEventListener('click', exportCSV);
  
  // è¡¨ç¤ºä»¶æ•°å¤‰æ›´
  document.getElementById('displayCount').addEventListener('change', (e) => {
    displayLimit = parseInt(e.target.value);
    saveDisplayLimit();
    renderTable();
  });
  
  // éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  document.getElementById('btnClearDept').addEventListener('click', () => {
    selectedDepts.clear();
    document.querySelectorAll('.dept-btn').forEach(btn => btn.classList.remove('active'));
    applyFilters();
  });
  
  // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  document.getElementById('btnYesterday').addEventListener('click', () => {
    const yesterday = getPreviousBusinessDay();
    dateFrom = yesterday;
    dateTo = yesterday;
    document.getElementById('dateFrom').value = yesterday;
    document.getElementById('dateTo').value = yesterday;
    document.getElementById('btnYesterday').classList.add('active');
    document.getElementById('btnToday').classList.remove('active');
    applyFilters();
  });
  
  document.getElementById('btnToday').addEventListener('click', () => {
    const today = getToday();
    dateFrom = today;
    dateTo = today;
    document.getElementById('dateFrom').value = today;
    document.getElementById('dateTo').value = today;
    document.getElementById('btnToday').classList.add('active');
    document.getElementById('btnYesterday').classList.remove('active');
    applyFilters();
  });
  
  document.getElementById('dateFrom').addEventListener('change', (e) => {
    dateFrom = e.target.value;
    document.getElementById('btnYesterday').classList.remove('active');
    document.getElementById('btnToday').classList.remove('active');
    applyFilters();
  });
  
  document.getElementById('dateTo').addEventListener('change', (e) => {
    dateTo = e.target.value;
    document.getElementById('btnYesterday').classList.remove('active');
    document.getElementById('btnToday').classList.remove('active');
    applyFilters();
  });
  
  document.getElementById('btnClearDate').addEventListener('click', () => {
    dateFrom = null;
    dateTo = null;
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    document.getElementById('btnYesterday').classList.remove('active');
    document.getElementById('btnToday').classList.remove('active');
    applyFilters();
  });
  
  document.getElementById('btnResetFilters').addEventListener('click', () => {
    // éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢
    selectedDepts.clear();
    document.querySelectorAll('.dept-btn').forEach(btn => btn.classList.remove('active'));
    // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢
    dateFrom = null;
    dateTo = null;
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    document.getElementById('btnYesterday').classList.remove('active');
    document.getElementById('btnToday').classList.remove('active');
    applyFilters();
  });
  
  document.getElementById('btnResetSort').addEventListener('click', () => {
    currentSort = { column: null, direction: 'asc' };
    renderTable();
  });
  
  document.getElementById('btnCloseDetail').addEventListener('click', () => {
    document.getElementById('detailModal').classList.remove('active');
  });
  
  document.getElementById('btnCloseSettings').addEventListener('click', () => {
    document.getElementById('settingsModal').classList.remove('active');
  });
  
  document.getElementById('btnSaveSettings').addEventListener('click', () => {
    visibleColumns = [];
    allColumns.forEach(col => {
      const checkbox = document.getElementById(`col-${col.id}`);
      if (checkbox && checkbox.checked) {
        visibleColumns.push(col.id);
      }
    });
    saveSettings();
    document.getElementById('settingsModal').classList.remove('active');
    renderTable();
  });

  // åˆæœŸåŒ–
  (async () => {
    const authenticated = await checkAuth();
    if (!authenticated) {
      alert('èªè¨¼ãŒå¿…è¦ã§ã™');
      return;
    }
    
    loadSettings();
    await loadData();
  })();
</script>

</body>
</html>