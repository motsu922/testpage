<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>選別実績 簡易入力アプリ</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#f5f5f5;
      color:#333;
      line-height:1.5;
    }
    a { color:inherit; }

    /* 共通 */
    .page { display:none; }
    .page.active { display:block; }
    .container {
      max-width:1000px;
      margin:0 auto;
      padding:1rem;
    }
    .card {
      background:#fff;
      border-radius:8px;
      padding:1rem;
      margin-bottom:0.75rem;
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
    }
    h1,h2,h3 { font-weight:600; }
    h1 { font-size:1.2rem; }
    h2 { font-size:1.1rem; margin-bottom:0.5rem; }
    h3 { font-size:1rem; margin-bottom:0.25rem; }

    label {
      display:block;
      font-size:0.85rem;
      font-weight:600;
      margin-bottom:0.25rem;
    }
    input,select,textarea {
      width:100%;
      padding:0.5rem;
      border-radius:6px;
      border:1px solid #ddd;
      font-size:0.9rem;
      font-family:inherit;
    }
    textarea { min-height:120px; }

    .btn {
      border:none;
      border-radius:999px;
      padding:0.5rem 1rem;
      font-size:0.9rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:0.25rem;
      transition:transform 0.1s, box-shadow 0.1s, background 0.1s;
      white-space:nowrap;
    }
    .btn:hover {
      transform:translateY(-1px);
      box-shadow:0 2px 4px rgba(0,0,0,0.12);
    }
    .btn-primary { background:#3498db; color:#fff; }
    .btn-secondary { background:#95a5a6; color:#fff; }
    .btn-danger { background:#e74c3c; color:#fff; }
    .btn-ghost { background:transparent; color:#fff; }
    .btn-sm { padding:0.3rem 0.7rem; font-size:0.8rem; }

    .flex { display:flex; }
    .flex-between { display:flex; justify-content:space-between; align-items:center; }
    .flex-wrap { flex-wrap:wrap; }
    .gap-4 { gap:0.25rem; }
    .gap-8 { gap:0.5rem; }
    .mt-8 { margin-top:0.5rem; }
    .mt-12 { margin-top:0.75rem; }
    .mt-16 { margin-top:1rem; }
    .text-right { text-align:right; }
    .text-center { text-align:center; }
    .badge {
      display:inline-block;
      border-radius:999px;
      padding:0.15rem 0.6rem;
      font-size:0.75rem;
      background:#eee;
    }

    /* ヘッダー */
    header {
      position:sticky;
      top:0;
      z-index:100;
      background:#2c3e50;
      color:#fff;
      box-shadow:0 2px 4px rgba(0,0,0,0.2);
    }
    .header-inner {
      max-width:1000px;
      margin:0 auto;
      padding:0.6rem 1rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:0.5rem;
      flex-wrap:wrap;
    }
    .tabs {
      display:flex;
      gap:0.25rem;
      flex-wrap:wrap;
    }
    .tab {
      border:none;
      background:transparent;
      color:#ecf0f1;
      padding:0.35rem 0.8rem;
      border-radius:999px;
      font-size:0.82rem;
      cursor:pointer;
      white-space:nowrap;
    }
    .tab.active {
      background:rgba(255,255,255,0.15);
      font-weight:600;
    }

    /* 2カラム（PC） */
    .grid-2 {
      display:grid;
      grid-template-columns:1.1fr 1fr;
      gap:0.75rem;
    }

    /* アラート */
    .alert {
      position:fixed;
      left:50%;
      top:0.75rem;
      transform:translateX(-50%);
      background:#2c3e50;
      color:#fff;
      padding:0.6rem 1rem;
      border-radius:999px;
      font-size:0.85rem;
      box-shadow:0 4px 10px rgba(0,0,0,0.2);
      z-index:1000;
      animation:fadeSlide 0.3s ease-out;
    }
    @keyframes fadeSlide {
      from { opacity:0; transform:translate(-50%, -10px); }
      to   { opacity:1; transform:translate(-50%, 0); }
    }

    /* テーブル（履歴） */
    .table-wrap {
      overflow-x:auto;
    }
    table {
      width:100%;
      border-collapse:collapse;
      font-size:0.8rem;
      min-width:700px;
    }
    th,td {
      padding:0.4rem 0.3rem;
      border-bottom:1px solid #eee;
      text-align:left;
      vertical-align:top;
    }
    th {
      background:#f8f9fa;
      font-weight:600;
      position:sticky;
      top:0;
      z-index:1;
    }

    /* 画像グリッド */
    .photo-grid {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
      gap:0.5rem;
    }
    .photo-grid img {
      width:100%;
      height:100px;
      object-fit:cover;
      border-radius:6px;
      border:2px solid #ddd;
    }

    /* モーダル */
    .modal-backdrop {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.5);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:900;
    }
    .modal {
      background:#fff;
      border-radius:10px;
      width:92%;
      max-width:480px;
      max-height:90vh;
      overflow-y:auto;
      padding:1rem;
      box-shadow:0 8px 20px rgba(0,0,0,0.25);
    }

    @media (max-width:768px) {
      .container { padding:0.75rem; }
      .grid-2 { grid-template-columns:1fr; }
      header .header-inner { padding:0.5rem 0.75rem; }
      h1 { font-size:1.05rem; }
      .tab { font-size:0.78rem; padding:0.3rem 0.6rem; }
      .btn { min-height:40px; }
      input,select,textarea { font-size:16px; } /* iOS ズーム防止 */
      table { font-size:0.75rem; }
    }
  </style>
</head>
<body>

<!-- いきなりメインアプリ表示（ログイン画面なし） -->
<div id="mainApp" class="page active">
  <header>
    <div class="header-inner">
      <div>
        <h1>選別実績 簡易入力</h1>
      </div>
      <div class="flex gap-8 flex-wrap" style="align-items:center;">
        <div class="tabs">
          <button class="tab active" data-tab="inputTab" onclick="switchTab('inputTab')">① 実績入力</button>
          <button class="tab" data-tab="noteTab" onclick="switchTab('noteTab')">② 連絡内容確認</button>
          <button class="tab" data-tab="historyTab" onclick="switchTab('historyTab')">③ 履歴確認・修正</button>
        </div>
        <!-- 匿名運用なのでログアウトボタンは省略 -->
      </div>
    </div>
  </header>

  <main class="container">

    <!-- 実績入力タブ -->
    <section id="inputTab" class="page active">
      <div class="grid-2">
        <!-- 左：案件・場所選択 -->
        <div>
          <div class="card">
            <h2>① 案件選択</h2>
            <div class="mt-8">
              <label>案件</label>
              <select id="inputCaseSelect" onchange="onInputCaseChange()">
                <option value="">（選択してください）</option>
              </select>
            </div>
            <div class="mt-12">
              <label>選別場所</label>
              <select id="inputLocationSelect" onchange="onInputLocationChange()" disabled>
                <option value="">（先に案件を選択）</option>
              </select>
            </div>
            <button class="btn btn-secondary btn-sm mt-12" onclick="reloadCases()">案件一覧を再読み込み</button>
          </div>
          <div class="card">
            <h3>選択中の情報</h3>
            <div id="inputSelectionInfo" style="font-size:0.85rem; color:#555; margin-top:0.5rem;">
              案件・場所を選択してください。
            </div>
          </div>
        </div>

        <!-- 右：実績入力フォーム -->
        <div>
          <div class="card">
            <h2>② 実績入力</h2>
            <form id="inspectionForm">
              <div class="mt-8">
                <label>開始時刻</label>
                <input type="datetime-local" id="inspStart">
              </div>
              <div class="mt-8">
                <label>完了時刻</label>
                <input type="datetime-local" id="inspEnd">
              </div>
              <div class="mt-8">
                <label>かんばん（便）</label>
                <input type="text" id="inspKanban" placeholder="例: 3便 / K-12345">
              </div>
              <div class="mt-8">
                <label>選別した整理No（複数選択可）</label>
                <div id="inspSerialList" style="max-height:120px; overflow-y:auto; padding:0.5rem; background:#f8f9fa; border-radius:6px; font-size:0.85rem;">
                  選択中案件の整理Noを表示します。
                </div>
              </div>
              <div class="flex gap-8 mt-8">
                <div style="flex:1;">
                  <label>選別数 *</label>
                  <input type="number" id="inspCount" min="0" required>
                </div>
                <div style="flex:1;">
                  <label>NG数 *</label>
                  <input type="number" id="inspNg" min="0" required>
                </div>
              </div>
              <div class="mt-8">
                <label>責任者／作業者</label>
                <input type="text" id="inspSupervisor" placeholder="例: 山田">
              </div>
              <div class="mt-8">
                <label>写真（任意・複数可）</label>
                <input type="file" id="inspPhotos" accept="image/*" multiple>
              </div>
              <button type="submit" class="btn btn-primary" style="width:100%; margin-top:1rem;">登録する</button>
            </form>
          </div>
        </div>
      </div>
    </section>

    <!-- 連絡内容確認タブ -->
    <section id="noteTab" class="page">
      <div class="card">
        <h2>連絡内容確認（ホワイトボード & 写真のみ閲覧）</h2>
        <div class="mt-8">
          <label>案件</label>
          <select id="noteCaseSelect" onchange="onNoteCaseChange()">
            <option value="">（選択してください）</option>
          </select>
        </div>
        <div class="mt-12">
          <h3>ホワイトボード内容</h3>
          <textarea id="noteWhiteboard" readonly style="background:#f8f9fa;"></textarea>
        </div>
        <div class="mt-12">
          <h3>アップロード画像</h3>
          <div id="notePhotos" class="photo-grid mt-8"></div>
          <div id="notePhotosEmpty" style="font-size:0.85rem; color:#999; margin-top:0.5rem;">画像は登録されていません。</div>
        </div>
      </div>
    </section>

    <!-- 履歴確認タブ -->
    <section id="historyTab" class="page">
      <div class="card">
        <div class="flex-between flex-wrap gap-8">
          <h2>履歴確認・修正</h2>
          <div class="flex gap-8 flex-wrap">
            <select id="historyCaseFilter" onchange="buildHistoryList()" style="min-width:140px;">
              <option value="">案件：すべて</option>
            </select>
            <select id="historyOwnerFilter" onchange="buildHistoryList()" style="min-width:120px;">
              <option value="all">担当：すべて</option>
              <option value="me">自分の実績のみ</option>
            </select>
            <button class="btn btn-secondary btn-sm" onclick="reloadCases(true)">再読み込み</button>
          </div>
        </div>
        <div class="table-wrap mt-12">
          <table>
            <thead>
              <tr>
                <th>案件</th>
                <th>場所</th>
                <th>日時</th>
                <th>かんばん</th>
                <th>整理No</th>
                <th class="text-right">選別</th>
                <th class="text-right">NG</th>
                <th>責任者</th>
                <th>編集</th>
              </tr>
            </thead>
            <tbody id="historyTbody">
              <tr><td colspan="9" class="text-center" style="padding:1rem; color:#999;">読み込み中…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- 編集モーダル -->
<div id="editModalBackdrop" style="display:none;"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<script>
  // ===== Firebase 初期化 =====
  const firebaseConfig = {
    apiKey: "AIzaSyCr2A0kYdlJsCKnJhGXwEDViu2Ae08yKJc",
    authDomain: "qckyouyu.firebaseapp.com",
    projectId: "qckyouyu",
    storageBucket: "qckyouyu.firebasestorage.app",
    messagingSenderId: "884065987840",
    appId: "1:884065987840:web:2b12cc1204e484b999d7e5"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // ===== 状態 =====
  let currentUser = null;
  let casesCache = []; // {id, ...data}
  let inputSelectedCaseId = null;
  let inputSelectedLocationIndex = null;
  let historyRecords = []; // フラット化した実績

  // ===== 共通UI =====
  function showAlert(msg) {
    const el = document.createElement('div');
    el.className = 'alert';
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(), 2500);
  }

  function switchTab(tabId) {
    document.querySelectorAll('.tab').forEach(t => {
      t.classList.toggle('active', t.dataset.tab === tabId);
    });
    document.querySelectorAll('main .page').forEach(p => {
      p.classList.toggle('active', p.id === tabId);
    });
    if (tabId === 'historyTab') buildHistoryList();
  }

  // ===== 認証（匿名ログイン） =====
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      // 初回だけ読み込み
      if (casesCache.length === 0) {
        reloadCases();
      }
    } else {
      // ★ここがポイント：自動で匿名ログイン
      auth.signInAnonymously().catch(err => {
        alert('匿名ログインに失敗しました: ' + err.message + '\nFirebaseコンソールで「匿名認証」が有効か確認してください。');
      });
    }
  });

  // ===== Firestore: 案件読み込み =====
  async function reloadCases(forceHistoryOnly=false) {
    try {
      const snap = await db.collection('cases').orderBy('updatedAt', 'desc').get();
      casesCache = [];
      snap.forEach(doc => {
        casesCache.push({ id: doc.id, ...doc.data() });
      });

      if (!forceHistoryOnly) {
        populateCaseSelects();
        onInputCaseChange();
        onNoteCaseChange();
      }
      buildHistoryFilters();
      if (document.getElementById('historyTab').classList.contains('active') || forceHistoryOnly) {
        buildHistoryList();
      }
      showAlert('案件情報を更新しました');
    } catch (err) {
      console.error(err);
      alert('案件読み込みエラー: ' + err.message);
    }
  }

  function populateCaseSelects() {
    const inputSel = document.getElementById('inputCaseSelect');
    const noteSel = document.getElementById('noteCaseSelect');

    inputSel.innerHTML = '<option value="">（選択してください）</option>';
    noteSel.innerHTML = '<option value="">（選択してください）</option>';

    casesCache
      .filter(c => c.status !== 'archived')
      .forEach(c => {
        const text = `${c.caseName || '無題'} / ${c.customerName || ''}`;
        const opt1 = new Option(text, c.id);
        const opt2 = new Option(text, c.id);
        inputSel.add(opt1);
        noteSel.add(opt2);
      });
  }

  // ===== 実績入力タブ =====
  function getCaseById(id) {
    return casesCache.find(c => c.id === id) || null;
  }

  function onInputCaseChange() {
    inputSelectedCaseId = document.getElementById('inputCaseSelect').value || null;
    const locSel = document.getElementById('inputLocationSelect');
    const info = document.getElementById('inputSelectionInfo');
    locSel.innerHTML = '';
    locSel.disabled = true;
    inputSelectedLocationIndex = null;
    document.getElementById('inspKanban').value = '';
    document.getElementById('inspSerialList').innerHTML = '選択中案件の整理Noを表示します。';

    if (!inputSelectedCaseId) {
      info.textContent = '案件・場所を選択してください。';
      locSel.innerHTML = '<option value="">（先に案件を選択）</option>';
      return;
    }

    const c = getCaseById(inputSelectedCaseId);
    const locations = c.inventoryLocations || [];
    if (locations.length === 0) {
      locSel.innerHTML = '<option value="">在庫場所が登録されていません</option>';
      info.textContent = '在庫場所が登録されていません。（本アプリでは場所追加はできません）';
      return;
    }

    locSel.disabled = false;
    locSel.innerHTML = '<option value="">（選択してください）</option>';
    locations.forEach((loc, idx) => {
      locSel.add(new Option(loc.location || `場所${idx+1}`, idx));
    });

    info.textContent = '選別場所を選択してください。';
  }

  function onInputLocationChange() {
    const locSel = document.getElementById('inputLocationSelect');
    const idxStr = locSel.value;
    const info = document.getElementById('inputSelectionInfo');
    inputSelectedLocationIndex = idxStr === '' ? null : parseInt(idxStr, 10);

    const c = getCaseById(inputSelectedCaseId);
    if (!c || inputSelectedLocationIndex==null) {
      info.textContent = '選別場所を選択してください。';
      return;
    }
    const loc = (c.inventoryLocations || [])[inputSelectedLocationIndex];
    const occurred = c.occurredDate && c.occurredDate.seconds
      ? new Date(c.occurredDate.seconds*1000).toLocaleDateString('ja-JP') : '';

    info.innerHTML = `
      <div><strong>案件:</strong> ${c.caseName || ''}</div>
      <div><strong>得意先:</strong> ${c.customerName || ''}</div>
      <div><strong>発生日:</strong> ${occurred}</div>
      <div class="mt-8"><strong>場所:</strong> ${loc.location || ''}</div>
      <div><strong>かんばん:</strong> ${loc.kanban || '-'}</div>
      <div><strong>担当:</strong> ${loc.customerContact || '-'}</div>
    `;

    document.getElementById('inspKanban').value = loc.kanban || '';

    const serials = c.targetSerialNumbers || [];
    const list = document.getElementById('inspSerialList');
    if (serials.length === 0) {
      list.textContent = '整理Noが登録されていません。';
    } else {
      list.innerHTML = serials.map(sn => `
        <label style="display:block; padding:0.2rem;">
          <input type="checkbox" value="${sn}" style="width:auto; margin-right:0.3rem;">
          ${sn}
        </label>
      `).join('');
    }
  }

  async function uploadPhotos(files, path) {
    const urls = [];
    for (const file of files) {
      const ref = storage.ref(`${path}/${Date.now()}_${file.name}`);
      await ref.put(file);
      const url = await ref.getDownloadURL();
      urls.push({ url, name:file.name, uploadedAt:new Date() });
    }
    return urls;
  }

  document.getElementById('inspectionForm').addEventListener('submit', async e => {
    e.preventDefault();
    if (!inputSelectedCaseId || inputSelectedLocationIndex==null) {
      alert('先に「案件」と「選別場所」を選択してください。');
      return;
    }

    const c = getCaseById(inputSelectedCaseId);
    if (!c) {
      alert('案件情報が見つかりません。再読み込みしてください。');
      return;
    }

    const startStr = document.getElementById('inspStart').value;
    const endStr   = document.getElementById('inspEnd').value;
    const kanban   = document.getElementById('inspKanban').value.trim();
    const count    = parseInt(document.getElementById('inspCount').value || '0', 10);
    const ng       = parseInt(document.getElementById('inspNg').value || '0', 10);
    const sup      = document.getElementById('inspSupervisor').value.trim();
    const photoFiles = document.getElementById('inspPhotos').files;

    if (isNaN(count) || isNaN(ng)) {
      alert('選別数／NG数を数値で入力してください。');
      return;
    }
    if (count < ng) {
      if (!confirm('NG数が選別数より多くなっています。本当に登録しますか？')) {
        return;
      }
    }

    const serialChecked = Array.from(document.querySelectorAll('#inspSerialList input[type="checkbox"]:checked'))
      .map(cb => cb.value);

    try {
      let photos = [];
      if (photoFiles.length > 0) {
        showAlert('写真アップロード中…');
        photos = await uploadPhotos(Array.from(photoFiles), `inspections/${inputSelectedCaseId}`);
      }

      const newResult = {
        startTime: startStr ? firebase.firestore.Timestamp.fromDate(new Date(startStr)) : null,
        endTime:   endStr   ? firebase.firestore.Timestamp.fromDate(new Date(endStr))   : null,
        kanban,
        serialNumbers: serialChecked,
        count,
        ngCount: ng,
        supervisor: sup || '',
        photos,
        createdBy: currentUser ? currentUser.uid : null,
        createdAt: firebase.firestore.Timestamp.now()
      };

      const caseIndex = casesCache.findIndex(x => x.id === inputSelectedCaseId);
      const caseData = { ...casesCache[caseIndex] };
      const locations = [...(caseData.inventoryLocations || [])];
      const loc = { ...(locations[inputSelectedLocationIndex] || {} ) };
      const results = [...(loc.inspectionResults || [])];
      results.push(newResult);
      loc.inspectionResults = results;
      locations[inputSelectedLocationIndex] = loc;
      caseData.inventoryLocations = locations;

      await db.collection('cases').doc(inputSelectedCaseId).update({
        inventoryLocations: locations,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      casesCache[caseIndex] = caseData;

      document.getElementById('inspectionForm').reset();
      onInputLocationChange();

      showAlert('選別実績を登録しました');

      const ok = confirm('ラインへの転送は完了しましたか？');
      if (!ok) {
        showAlert('ライン転送が未完了の場合は、忘れずに実施してください。');
      }
    } catch (err) {
      console.error(err);
      alert('登録エラー: ' + err.message);
    }
  });

  // ===== 連絡内容確認タブ =====
  function onNoteCaseChange() {
    const id = document.getElementById('noteCaseSelect').value;
    const wb = document.getElementById('noteWhiteboard');
    const photosDiv = document.getElementById('notePhotos');
    const emptyDiv = document.getElementById('notePhotosEmpty');

    wb.value = '';
    photosDiv.innerHTML = '';
    emptyDiv.style.display = 'block';

    if (!id) return;
    const c = getCaseById(id);
    if (!c) return;

    wb.value = c.whiteboard || '';

    let photos = c.whiteboardPhotos || [];
    if (!Array.isArray(photos)) {
      photos = Object.values(photos || {});
    }
    photos = photos.map(p => typeof p === 'string' ? {url:p} : p).filter(p => p.url);

    if (photos.length === 0) {
      emptyDiv.style.display = 'block';
      return;
    }
    emptyDiv.style.display = 'none';
    photosDiv.innerHTML = photos.map(p => `
      <a href="${p.url}" target="_blank" title="${p.name || ''}">
        <img src="${p.url}">
      </a>
    `).join('');
  }

  // ===== 履歴タブ =====
  function buildHistoryFilters() {
    const caseFilter = document.getElementById('historyCaseFilter');
    const current = caseFilter.value;
    caseFilter.innerHTML = '<option value="">案件：すべて</option>';
    casesCache.forEach(c => {
      const text = `${c.caseName || '無題'} / ${c.customerName || ''}`;
      caseFilter.add(new Option(text, c.id));
    });
    if (current) caseFilter.value = current;
  }

  function buildHistoryList() {
    const tbody = document.getElementById('historyTbody');
    tbody.innerHTML = '<tr><td colspan="9" class="text-center" style="padding:1rem; color:#999;">読み込み中…</td></tr>';

    const caseFilter = document.getElementById('historyCaseFilter').value;
    const ownerFilter = document.getElementById('historyOwnerFilter').value;

    const records = [];
    casesCache.forEach(c => {
      if (caseFilter && c.id !== caseFilter) return;
      const locations = c.inventoryLocations || [];
      locations.forEach((loc, locIdx) => {
        (loc.inspectionResults || []).forEach((r, resIdx) => {
          if (ownerFilter === 'me' && currentUser && r.createdBy && r.createdBy !== currentUser.uid) return;

          const dateStr = r.startTime && r.startTime.seconds
            ? new Date(r.startTime.seconds*1000).toLocaleString('ja-JP',{
                month:'2-digit', day:'2-digit',
                hour:'2-digit', minute:'2-digit'
              })
            : (r.createdAt && r.createdAt.seconds
                ? new Date(r.createdAt.seconds*1000).toLocaleString('ja-JP',{
                    month:'2-digit', day:'2-digit',
                    hour:'2-digit', minute:'2-digit'
                  })
                : '');
          records.push({
            caseId:c.id,
            caseName:c.caseName || '',
            locationName:loc.location || '',
            locIdx:locIdx,
            resIdx:resIdx,
            datetime:dateStr,
            kanban:r.kanban || '',
            serials:(r.serialNumbers || []).join(' '),
            count:r.count || 0,
            ng:r.ngCount || 0,
            supervisor:r.supervisor || '',
            raw:r
          });
        });
      });
    });

    historyRecords = records.sort((a,b) => {
      const at = a.raw.createdAt && a.raw.createdAt.seconds ? a.raw.createdAt.seconds : 0;
      const bt = b.raw.createdAt && b.raw.createdAt.seconds ? b.raw.createdAt.seconds : 0;
      return bt - at;
    });

    if (historyRecords.length === 0) {
      tbody.innerHTML = '<tr><td colspan="9" class="text-center" style="padding:1rem; color:#999;">履歴がありません</td></tr>';
      return;
    }

    tbody.innerHTML = historyRecords.map((rec, idx) => `
      <tr>
        <td>${rec.caseName}</td>
        <td>${rec.locationName}</td>
        <td>${rec.datetime}</td>
        <td>${rec.kanban}</td>
        <td>${rec.serials}</td>
        <td class="text-right">${rec.count.toLocaleString()}</td>
        <td class="text-right">${rec.ng.toLocaleString()}</td>
        <td>${rec.supervisor || '-'}</td>
        <td>
          <button class="btn btn-secondary btn-sm" onclick="openEditRecord(${idx})">編集</button>
        </td>
      </tr>
    `).join('');
  }

  // ===== 編集モーダル =====
  function openEditRecord(index) {
    const rec = historyRecords[index];
    if (!rec) return;

    const modalHtml = `
      <div class="modal-backdrop" id="editBackdropInner">
        <div class="modal">
          <h3>実績編集</h3>
          <div style="font-size:0.8rem; color:#555; margin-top:0.25rem;">
            案件: ${rec.caseName}<br>
            場所: ${rec.locationName}
          </div>
          <form id="editForm" class="mt-12">
            <input type="hidden" id="editIndex" value="${index}">
            <div class="mt-8">
              <label>開始時刻</label>
              <input type="datetime-local" id="editStart">
            </div>
            <div class="mt-8">
              <label>完了時刻</label>
              <input type="datetime-local" id="editEnd">
            </div>
            <div class="mt-8">
              <label>かんばん（便）</label>
              <input type="text" id="editKanban" value="${rec.kanban}">
            </div>
            <div class="mt-8">
              <label>整理No（スペース区切り）</label>
              <input type="text" id="editSerials" value="${rec.serials}">
            </div>
            <div class="flex gap-8 mt-8">
              <div style="flex:1;">
                <label>選別数 *</label>
                <input type="number" id="editCount" min="0" value="${rec.count}">
              </div>
              <div style="flex:1;">
                <label>NG数 *</label>
                <input type="number" id="editNg" min="0" value="${rec.ng}">
              </div>
            </div>
            <div class="mt-8">
              <label>責任者／作業者</label>
              <input type="text" id="editSupervisor" value="${rec.supervisor}">
            </div>
            <div class="flex gap-8 mt-12" style="justify-content:flex-end;">
              <button type="button" class="btn btn-secondary btn-sm" onclick="closeEditModal()">キャンセル</button>
              <button type="submit" class="btn btn-primary btn-sm">保存</button>
            </div>
          </form>
        </div>
      </div>
    `;

    const backdrop = document.getElementById('editModalBackdrop');
    backdrop.innerHTML = modalHtml;
    backdrop.style.display = 'block';

    const raw = rec.raw;
    const editStart = document.getElementById('editStart');
    const editEnd = document.getElementById('editEnd');

    if (raw.startTime && raw.startTime.seconds) {
      const d = new Date(raw.startTime.seconds*1000);
      editStart.value = toLocalInputString(d);
    }
    if (raw.endTime && raw.endTime.seconds) {
      const d2 = new Date(raw.endTime.seconds*1000);
      editEnd.value = toLocalInputString(d2);
    }

    document.getElementById('editForm').addEventListener('submit', saveEditRecord);
    document.getElementById('editBackdropInner').addEventListener('click', e => {
      if (e.target.id === 'editBackdropInner') closeEditModal();
    });
  }

  function toLocalInputString(d) {
    const pad = n => n.toString().padStart(2,'0');
    const year = d.getFullYear();
    const month = pad(d.getMonth()+1);
    const day   = pad(d.getDate());
    const hh    = pad(d.getHours());
    const mm    = pad(d.getMinutes());
    return `${year}-${month}-${day}T${hh}:${mm}`;
  }

  function closeEditModal() {
    const backdrop = document.getElementById('editModalBackdrop');
    backdrop.innerHTML = '';
    backdrop.style.display = 'none';
  }

  async function saveEditRecord(e) {
    e.preventDefault();
    const idx = parseInt(document.getElementById('editIndex').value,10);
    const rec = historyRecords[idx];
    if (!rec) return;

    const startStr = document.getElementById('editStart').value;
    const endStr   = document.getElementById('editEnd').value;
    const kanban   = document.getElementById('editKanban').value.trim();
    const serials  = document.getElementById('editSerials').value.trim().split(/\s+/).filter(Boolean);
    const count    = parseInt(document.getElementById('editCount').value || '0', 10);
    const ng       = parseInt(document.getElementById('editNg').value || '0', 10);
    const sup      = document.getElementById('editSupervisor').value.trim();

    if (isNaN(count) || isNaN(ng)) {
      alert('選別数／NG数を数値で入力してください。');
      return;
    }
    if (count < ng) {
      if (!confirm('NG数が選別数より多くなっています。本当に保存しますか？')) return;
    }

    try {
      const caseIndex = casesCache.findIndex(c => c.id === rec.caseId);
      const caseData = { ...casesCache[caseIndex] };
      const locations = [...(caseData.inventoryLocations || [])];
      const loc = { ...(locations[rec.locIdx] || {}) };
      const results = [...(loc.inspectionResults || [])];
      const result = { ...(results[rec.resIdx] || {}) };

      result.startTime = startStr ? firebase.firestore.Timestamp.fromDate(new Date(startStr)) : null;
      result.endTime   = endStr   ? firebase.firestore.Timestamp.fromDate(new Date(endStr))   : null;
      result.kanban    = kanban;
      result.serialNumbers = serials;
      result.count     = count;
      result.ngCount   = ng;
      result.supervisor = sup;

      results[rec.resIdx] = result;
      loc.inspectionResults = results;
      locations[rec.locIdx] = loc;
      caseData.inventoryLocations = locations;

      await db.collection('cases').doc(rec.caseId).update({
        inventoryLocations: locations,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      casesCache[caseIndex] = caseData;
      closeEditModal();
      showAlert('実績を更新しました');
      buildHistoryList();
    } catch (err) {
      console.error(err);
      alert('更新エラー: ' + err.message);
    }
  }
</script>
</body>
</html>
