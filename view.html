<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ç•°å¸¸å±¥æ­´ é›†è¨ˆãƒ»è§£æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<style>
  :root{
    --bg:#f5f7fb; --card:#ffffff; --ink:#1f2937; --muted:#6b7280;
    --brand:#6366f1; --accent:#f59e0b; --ok:#16a34a; --warn:#f59e0b; --ng:#dc2626; --border:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Sans","Noto Sans JP",sans-serif}
  .topbar{position:sticky;top:0;z-index:20;background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%);color:#fff;padding:14px 18px;display:flex;gap:12px;align-items:center;justify-content:space-between;box-shadow:0 2px 12px rgba(0,0,0,.1)}
  .topbar h1{font-size:1.1rem;margin:0}
  .wrap{display:grid;grid-template-columns:300px 1fr;gap:16px;max-width:1400px;margin:18px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,.04)}
  .panel{padding:16px}
  .panel h3{margin:0 0 10px;color:#374151;font-size:1rem}
  .filters .row{display:grid;gap:10px;margin-bottom:12px}
  .filters label{font-size:.9rem;color:#374151;font-weight:600;margin-bottom:6px;display:block}
  .filters input,.filters select{width:100%;padding:10px;border:2px solid var(--border);border-radius:8px;font-size:.95rem}
  .filters .btn{display:inline-flex;align-items:center;gap:.4rem;padding:10px 12px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
  .btn-primary{background:var(--brand);color:#fff}
  .btn-ghost{background:#eef2ff;color:#3730a3}
  .btn-danger{background:#fee2e2;color:#991b1b}
  .kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
  .kpi{padding:16px;border-radius:12px;background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%);color:#fff}
  .kpi h4{margin:0 0 6px;font-size:.9rem;opacity:.9}
  .kpi .val{font-size:1.8rem;font-weight:800}
  .kpi.ok{background:linear-gradient(135deg,#16a34a 0%,#22c55e 100%)}
  .kpi.warn{background:linear-gradient(135deg,#f59e0b 0%,#fbbf24 100%)}
  .kpi.ng{background:linear-gradient(135deg,#dc2626 0%,#ef4444 100%)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
  .chart-card{padding:16px}
  .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .chart-header h4{margin:0;font-size:1rem}
  .muted{color:var(--muted);font-size:.9rem}
  .tablewrap{margin-top:16px}
  table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:.92rem;vertical-align:top}
  th{background:#eef2ff}
  tr:hover{background:#f9fafb}
  .signout{background:#f87171;color:#fff;border:none;border-radius:8px;padding:8px 10px;cursor:pointer}
  #authGate{position:fixed;inset:0;background:rgba(0,0,0,.04);display:flex;align-items:center;justify-content:center;z-index:50}
  #authCard{background:#fff;max-width:380px;width:92%;padding:20px;border-radius:12px;border:1px solid var(--border);box-shadow:0 10px 30px rgba(0,0,0,.12)}
  #authCard h2{margin:0 0 8px;color:#4f46e5}
  #authCard .form-group{margin-bottom:10px}
  #authCard input{width:100%;padding:10px;border:2px solid var(--border);border-radius:8px}
  #authMsg{color:#b91c1c;margin-top:6px;min-height:1.2em}
  @media (max-width:1100px){ .kpis{grid-template-columns:repeat(3,1fr)} .grid{grid-template-columns:1fr} .wrap{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="topbar">
    <h1>ğŸ“Š ç•°å¸¸å±¥æ­´ é›†è¨ˆãƒ»è§£æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    <div>
      <button id="btnSignOut" class="signout" style="display:none;">ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>

  <!-- èªè¨¼ã‚²ãƒ¼ãƒˆ -->
  <div id="authGate">
    <div id="authCard">
      <h2>ğŸ” ã‚µã‚¤ãƒ³ã‚¤ãƒ³</h2>
      <p class="muted" style="margin-bottom:10px;">ç¤¾å†…ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
      <div class="form-group">
        <input type="email" id="authEmail" placeholder="user@miyama-unitec.co.jp">
      </div>
      <div class="form-group">
        <input type="password" id="authPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <button id="btnLogin" class="btn btn-primary" style="width:100%;margin-top:4px;">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div id="authMsg"></div>
    </div>
  </div>

  <div class="wrap" id="app" style="display:none;">
    <!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
    <div class="card panel filters">
      <h3>ğŸ” ãƒ•ã‚£ãƒ«ã‚¿</h3>
      <div class="row">
        <label>æ—¥ä»˜ç¯„å›²ï¼ˆç™ºç”Ÿæ—¥ï¼‰</label>
        <input type="date" id="dateFrom">
        <input type="date" id="dateTo">
      </div>
      <div class="row">
        <label>éƒ¨ç½²</label>
        <select id="fDepartment"><option value="">ã™ã¹ã¦</option></select>
      </div>
      <div class="row">
        <label>ãƒ©ã‚¤ãƒ³</label>
        <select id="fLine"><option value="">ã™ã¹ã¦</option></select>
      </div>
      <div class="row">
        <label>æŠ€è¡“è¦è«‹</label>
        <select id="fTechReq">
          <option value="">ã™ã¹ã¦</option>
          <option value="è¦è«‹">æŠ€è¡“è¦è«‹</option>
          <option value="å®Œçµ">è£½é€ ã§å®Œçµ</option>
        </select>
      </div>
      <div class="row">
        <label>çŠ¶æ…‹</label>
        <select id="fStatus">
          <option value="">ã™ã¹ã¦</option>
          <option value="pending">æŠ€è¡“å…¥åŠ›å¾…ã¡</option>
          <option value="complete">å®Œäº†</option>
        </select>
      </div>
      <div class="row">
        <label>å†ç™º/æ–°è¦</label>
        <select id="fRecur">
          <option value="">ã™ã¹ã¦</option>
          <option value="å†ç™º">å†ç™º</option>
          <option value="æ–°è¦">æ–°è¦</option>
        </select>
      </div>
      <div class="row">
        <label>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆç•°å¸¸å†…å®¹ãƒ»åŸå› å¯¾ç­–ã‚’æ¤œç´¢ï¼‰</label>
        <input type="text" id="fKeyword" placeholder="ä¾‹: ãƒãƒª, QR, å“é•ã„ ãªã©">
      </div>
      <div class="row" style="display:flex;gap:8px;">
        <button id="btnReload" class="btn btn-primary">å†èª­è¾¼</button>
        <button id="btnClear" class="btn btn-ghost">ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="btnExport" class="btn btn-ghost">CSVå‡ºåŠ›ï¼ˆæ˜ç´°ï¼‰</button>
      </div>
      <div class="row muted">â€» ã¾ãšå…¨ä»¶ã‚’èª­ã¿è¾¼ã¿ã€ãƒ•ã‚£ãƒ«ã‚¿ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§é©ç”¨ã—ã¾ã™ï¼ˆé«˜é€Ÿï¼‰</div>
    </div>

    <!-- å³ãƒšã‚¤ãƒ³ -->
    <div class="col">
      <div class="kpis">
        <div class="kpi"><h4>ç·ç•°å¸¸ä»¶æ•°</h4><div class="val" id="kpiTotal">0</div></div>
        <div class="kpi ok"><h4>å®Œäº†</h4><div class="val"><span id="kpiDone">0</span></div></div>
        <div class="kpi warn"><h4>å¯¾å¿œå¾…ã¡</h4><div class="val"><span id="kpiPending">0</span></div></div>
        <div class="kpi ng"><h4>ä»Šæœˆã®ç•°å¸¸</h4><div class="val" id="kpiThisMonth">0</div></div>
        <div class="kpi" style="background:linear-gradient(135deg,#0ea5e9 0%,#38bdf8 100%);">
          <h4>å¹³å‡å¯¾å¿œæ™‚é–“</h4><div class="val"><span id="kpiAvgMin">0</span>åˆ†</div>
        </div>
      </div>

      <div class="grid">
        <div class="card chart-card">
          <div class="chart-header"><h4>ğŸ“ˆ æœˆæ¬¡ãƒˆãƒ¬ãƒ³ãƒ‰</h4><span class="muted" id="trendCaption"></span></div>
          <canvas id="chartTrend" height="180"></canvas>
        </div>
        <div class="card chart-card">
          <div class="chart-header"><h4>ğŸ¢ éƒ¨ç½²åˆ¥ä»¶æ•°</h4><span class="muted">ãƒˆãƒƒãƒ—10</span></div>
          <canvas id="chartDept" height="180"></canvas>
        </div>
        <div class="card chart-card">
          <div class="chart-header"><h4>ğŸ›  ãƒ©ã‚¤ãƒ³åˆ¥ä»¶æ•°</h4><span class="muted">ãƒˆãƒƒãƒ—10</span></div>
          <canvas id="chartLine" height="180"></canvas>
        </div>
        <div class="card chart-card">
          <div class="chart-header"><h4>ğŸ”„ å†ç™º / æ–°è¦</h4><span class="muted">å‰²åˆ</span></div>
          <canvas id="chartRecurrence" height="180"></canvas>
        </div>
        <div class="card chart-card">
          <div class="chart-header"><h4>ğŸ“Š ãƒ‘ãƒ¬ãƒ¼ãƒˆï¼ˆç•°å¸¸å†…å®¹ã®é »å‡ºèªï¼‰</h4><span class="muted">ä¸Šä½20èª</span></div>
          <canvas id="chartPareto" height="220"></canvas>
        </div>
        <div class="card chart-card">
          <div class="chart-header"><h4>â± å¯¾å¿œæ™‚é–“ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ </h4><span class="muted">åˆ†å˜ä½</span></div>
          <canvas id="chartDuration" height="220"></canvas>
        </div>
      </div>

      <div class="card panel tablewrap">
        <h3>ğŸ“„ æ˜ç´°ï¼ˆãƒ•ã‚£ãƒ«ã‚¿é©ç”¨å¾Œ ä¸Šä½500ä»¶è¡¨ç¤ºï¼‰</h3>
        <div style="overflow:auto;">
          <table id="tbl">
            <thead>
              <tr>
                <th>æ•´ç†No</th><th>éƒ¨ç½²</th><th>ãƒ©ã‚¤ãƒ³</th><th>ç™ºç”Ÿæ—¥</th><th>ç™ºç”Ÿ</th><th>å†é–‹</th>
                <th>ç•°å¸¸å†…å®¹</th><th>è£½é€ å‡¦ç½®</th><th>æŠ€è¡“è¦è«‹</th><th>çŠ¶æ…‹</th>
                <th>å†ç™º/æ–°è¦</th><th>åŸå› ãƒ»å¯¾ç­–</th>
              </tr>
            </thead>
            <tbody id="tblBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script type="module">
  // ===== Firebase SDK =====
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
  import { getFirestore, collection, getDocs, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyA0YUIpIDh4WB4p1ewiNB0XfwHve0ByljU",
    authDomain: "abnreport-fd733.firebaseapp.com",
    projectId: "abnreport-fd733",
    storageBucket: "abnreport-fd733.appspot.com",
    messagingSenderId: "349748947315",
    appId: "1:349748947315:web:010cb671d2a95bcf1f7d06"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  enableIndexedDbPersistence(db).catch(()=>{});

  // ===== UI Elements =====
  const gate = document.getElementById('authGate');
  const appRoot = document.getElementById('app');
  const btnLogin = document.getElementById('btnLogin');
  const btnSignOut = document.getElementById('btnSignOut');
  const authMsg = document.getElementById('authMsg');

  btnLogin.addEventListener('click', async ()=>{
    const email = document.getElementById('authEmail').value.trim();
    const pass  = document.getElementById('authPassword').value;
    try{
      await setPersistence(auth, browserLocalPersistence);
      await signInWithEmailAndPassword(auth, email, pass);
    }catch(e){
      authMsg.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ' + (e.code || e.message);
    }
  });
  btnSignOut.addEventListener('click', ()=> signOut(auth));

  onAuthStateChanged(auth, user=>{
    if (user){ gate.style.display='none'; appRoot.style.display='grid'; btnSignOut.style.display='inline-block'; boot(); }
    else{ appRoot.style.display='none'; gate.style.display='flex'; btnSignOut.style.display='none'; }
  });

  // ===== Data Cache =====
  let ALL = []; // å…¨ä»¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  let filtered = []; // ãƒ•ã‚£ãƒ«ã‚¿å¾Œ
  let charts = {};

  // ===== Filters =====
  const fDepartment = document.getElementById('fDepartment');
  const fLine       = document.getElementById('fLine');
  const fTechReq    = document.getElementById('fTechReq');
  const fStatus     = document.getElementById('fStatus');
  const fRecur      = document.getElementById('fRecur');
  const fKeyword    = document.getElementById('fKeyword');
  const dateFrom    = document.getElementById('dateFrom');
  const dateTo      = document.getElementById('dateTo');

  document.getElementById('btnClear').addEventListener('click', ()=>{
    dateFrom.value=''; dateTo.value='';
    fDepartment.value=''; fLine.value=''; fTechReq.value=''; fStatus.value=''; fRecur.value='';
    fKeyword.value=''; applyFilters();
  });
  document.getElementById('btnReload').addEventListener('click', async ()=>{ await loadAll(); applyFilters(); });
  document.getElementById('btnExport').addEventListener('click', ()=> exportCSV(filtered));

  // ===== Boot =====
  async function boot(){
    await loadAll();
    populateMasterFilters(ALL);
    applyFilters();
  }

  async function loadAll(){
    const snap = await getDocs(collection(db,'anomalies'));
    ALL = snap.docs.map(d=> ({_id:d.id, ...d.data()}));
  }

  function populateMasterFilters(rows){
    const deps = [...new Set(rows.map(r=>r.department).filter(Boolean))].sort();
    const lines= [...new Set(rows.map(r=>r.lineName).filter(Boolean))].sort();
    fDepartment.innerHTML = '<option value="">ã™ã¹ã¦</option>'+deps.map(x=>`<option>${x}</option>`).join('');
    fLine.innerHTML       = '<option value="">ã™ã¹ã¦</option>'+lines.map(x=>`<option>${x}</option>`).join('');
  }

  // ===== Apply Filters =====
  function applyFilters(){
    const kw = (fKeyword.value||'').trim().toLowerCase();
    const dFrom = dateFrom.value? new Date(dateFrom.value) : null;
    const dTo   = dateTo.value? new Date(dateTo.value) : null;

    filtered = ALL.filter(r=>{
      if (fDepartment.value && r.department!==fDepartment.value) return false;
      if (fLine.value && r.lineName!==fLine.value) return false;
      if (fTechReq.value && r.techRequest!==fTechReq.value) return false;
      if (fStatus.value && r.status!==fStatus.value) return false;
      if (fRecur.value && r.recurrenceType!==fRecur.value) return false;
      if (dFrom || dTo){
        const d = r.occurrenceDate ? new Date(r.occurrenceDate) : null;
        if (!d) return false;
        if (dFrom && d < dFrom) return false;
        if (dTo){
          const end = new Date(dTo); end.setDate(end.getDate()+1); // inclusive
          if (d >= end) return false;
        }
      }
      if (kw){
        const t = `${r.anomalyContent||''} ${r.rootCauseAction||''}`.toLowerCase();
        if (!t.includes(kw)) return false;
      }
      return true;
    });

    renderKPI(filtered);
    renderCharts(filtered);
    renderTable(filtered);
  }

  // ===== KPI =====
  function renderKPI(rows){
    const total = rows.length;
    const done  = rows.filter(r=>r.status==='complete').length;
    const pend  = total - done;

    const now = new Date();
    const ym  = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    const thisMonth = rows.filter(r=>{
      if (!r.occurrenceDate) return false;
      const d = new Date(r.occurrenceDate);
      const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      return k===ym;
    }).length;

    const durs = rows.map(durationMinutes).filter(v=>v!=null);
    const avg  = durs.length ? Math.round(durs.reduce((a,b)=>a+b,0)/durs.length) : 0;

    document.getElementById('kpiTotal').textContent = total;
    document.getElementById('kpiDone').textContent  = done;
    document.getElementById('kpiPending').textContent= pend;
    document.getElementById('kpiThisMonth').textContent = thisMonth;
    document.getElementById('kpiAvgMin').textContent = avg;
  }

  // ===== Charts =====
  function destroyCharts(){
    for (const k in charts){ try{ charts[k].destroy(); }catch{} }
    charts = {};
  }

  function renderCharts(rows){
    destroyCharts();

    // æœˆæ¬¡ãƒˆãƒ¬ãƒ³ãƒ‰
    const monthly = groupCount(rows, r=>{
      if (!r.occurrenceDate) return 'ä¸æ˜';
      const d=new Date(r.occurrenceDate);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    });
    const months = Object.keys(monthly).sort();
    const trendVals = months.map(m=>monthly[m]);
    charts.trend = new Chart(document.getElementById('chartTrend'),{
      type:'line',
      data:{ labels:months, datasets:[{ label:'ä»¶æ•°', data:trendVals, tension:.25 }] },
      options:{ responsive:true, plugins:{legend:{display:false}} }
    });
    document.getElementById('trendCaption').textContent = months.length? `${months[0]} ï½ ${months[months.length-1]}` : '';

    // éƒ¨ç½²åˆ¥ï¼ˆãƒˆãƒƒãƒ—10ï¼‰
    const byDept = topN(groupCount(rows, r=>r.department||'æœªè¨­å®š'), 10);
    charts.dept = new Chart(document.getElementById('chartDept'),{
      type:'bar',
      data:{ labels:byDept.labels, datasets:[{ label:'ä»¶æ•°', data:byDept.values }] },
      options:{ indexAxis:'y', plugins:{legend:{display:false}} }
    });

    // ãƒ©ã‚¤ãƒ³åˆ¥ï¼ˆãƒˆãƒƒãƒ—10ï¼‰
    const byLine = topN(groupCount(rows, r=>r.lineName||'æœªè¨­å®š'), 10);
    charts.line = new Chart(document.getElementById('chartLine'),{
      type:'bar',
      data:{ labels:byLine.labels, datasets:[{ label:'ä»¶æ•°', data:byLine.values }] },
      options:{ indexAxis:'y', plugins:{legend:{display:false}} }
    });

    // å†ç™º/æ–°è¦
    const rec = groupCount(rows.filter(r=>r.recurrenceType), r=>r.recurrenceType);
    charts.recur = new Chart(document.getElementById('chartRecurrence'),{
      type:'doughnut',
      data:{ labels:Object.keys(rec), datasets:[{ data:Object.values(rec) }] },
      options:{ plugins:{legend:{position:'bottom'}} }
    });

    // ãƒ‘ãƒ¬ãƒ¼ãƒˆï¼ˆç•°å¸¸å†…å®¹ã®é »å‡ºèªï¼‰
    const words = topWords(rows, 20);
    charts.pareto = new Chart(document.getElementById('chartPareto'),{
      type:'bar',
      data:{ labels:words.labels, datasets:[{ label:'å‡ºç¾å›æ•°', data:words.values }] },
      options:{ plugins:{legend:{display:false}}, scales:{ x:{ ticks:{maxRotation:60,minRotation:30} } } }
    });

    // å¯¾å¿œæ™‚é–“ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ 
    const durations = rows.map(durationMinutes).filter(v=>v!=null);
    const hist = histogram(durations, [0,5,10,15,20,30,45,60,90,120,180,240,360,480,720,1440,2880]); // ä¸Šé™2æ—¥
    charts.dur = new Chart(document.getElementById('chartDuration'),{
      type:'bar',
      data:{ labels:hist.labels, datasets:[{ label:'ä»¶æ•°', data:hist.values }] },
      options:{ plugins:{legend:{display:false}} }
    });
  }

  // ===== Table =====
  function renderTable(rows){
    const body = document.getElementById('tblBody');
    const MAX = 500;
    body.innerHTML = rows.slice(0,MAX).map(r=>`
      <tr>
        <td>${esc(r.serialNo)}</td>
        <td>${esc(r.department)}</td>
        <td>${esc(r.lineName)}</td>
        <td>${esc(r.occurrenceDate)}</td>
        <td>${esc(r.occurrenceTime)}</td>
        <td>${esc(r.restartTime)}</td>
        <td>${esc(trunc(r.anomalyContent,60))}</td>
        <td>${esc(trunc(r.actionTaken,60))}</td>
        <td>${r.techRequest==='è¦è«‹'?'æŠ€è¡“è¦è«‹':r.techRequest==='å®Œçµ'?'è£½é€ å®Œçµ':'-'}</td>
        <td>${r.status==='complete'?'å®Œäº†':'å¾…ã¡'}</td>
        <td>${esc(r.recurrenceType)}</td>
        <td>${esc(trunc(r.rootCauseAction,60))}</td>
      </tr>
    `).join('');
  }

  // ===== Helpers =====
  function esc(v){ return (v??'').toString().replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[s]); }
  function trunc(v,n){ if(!v) return ''; const s=v.toString(); return s.length>n? s.slice(0,n)+'â€¦' : s; }

  function groupCount(rows, keyFn){
    const m={}; rows.forEach(r=>{ const k=keyFn(r); m[k]=(m[k]||0)+1; });
    return m;
  }
  function topN(mapObj, n){
    const arr = Object.entries(mapObj).sort((a,b)=>b[1]-a[1]).slice(0,n);
    return { labels: arr.map(([k])=>k), values: arr.map(([,v])=>v) };
  }

  function durationMinutes(r){
    if (!r.occurrenceTime || !r.restartTime) return null;
    const [oh,om] = r.occurrenceTime.split(':').map(Number);
    const [rh,rm] = r.restartTime.split(':').map(Number);
    if (isNaN(oh)||isNaN(om)||isNaN(rh)||isNaN(rm)) return null;
    let m = (rh*60+rm) - (oh*60+om);
    if (m<0) m += 1440; // æ—¥è·¨ã
    return m;
  }

  function tokenizeJa(text){
    // ã²ã‚‰ãŒãª/ã‚«ã‚¿ã‚«ãƒŠ/æ¼¢å­—/è‹±æ•°ã‚’ã–ã£ãã‚Šåˆ†å‰²
    // å“è³ªç”¨ãªã®ã§ã‚·ãƒ³ãƒ—ãƒ«è¦å‰‡ã§ååˆ†ï¼ˆä¸è¦èªã‚‚èª¿æ•´æ¸ˆã¿ï¼‰
    const s = (text||'').toLowerCase()
      .replace(/[ï¼ˆï¼‰\(\)\[\]{}ã€Œã€ã€ã€ã€ã€‘<>]/g,' ')
      .replace(/[ã€ã€‚ï¼Œï¼.,!ï¼?ï¼Ÿ:ï¼š;ï¼›/ï¼\\\-\+]/g,' ');
    const tokens = s.split(/\s+/).filter(w=>w && w.length<=20);
    const stop = new Set(['ã®','ã¨','ã«','ã¯','ã‚’','ãŒ','ã§','ã‚‚','ã¸','ã‚ˆã‚Š','ã‹ã‚‰','ã¾ã§','ã§ã™','ã¾ã™','ã™ã‚‹','ã—ãŸ','ã‚ã‚Š','ãªã—','ãŸã‚','ãªã©','åŠã³','ã¾ãŸ','ã™ã‚‹ã“ã¨','ã«ã¦','ã¨ã—ã¦','ã™ã‚‹ãŸã‚','ã«ã‚ˆã‚Š','ã«ã‚ˆã‚‹','ã“ã‚Œ','ãã‚Œ','ã‚‚ã®','ãŸã‚','ä»¶','æœ‰','ç„¡']);
    return tokens.filter(w=>!stop.has(w) && w.length>=2);
  }
  function topWords(rows, topK=20){
    const cnt={};
    rows.forEach(r=>{
      tokenizeJa(`${r.anomalyContent||''} ${r.rootCauseAction||''}`).forEach(w=> cnt[w]=(cnt[w]||0)+1 );
    });
    const arr = Object.entries(cnt).sort((a,b)=>b[1]-a[1]).slice(0,topK);
    return { labels: arr.map(a=>a[0]), values: arr.map(a=>a[1]) };
  }

  function histogram(values, edges){
    if (!values.length) return {labels:[], values:[]};
    const bins = new Array(edges.length).fill(0);
    values.forEach(v=>{
      let i = edges.findIndex(e=>v<=e);
      if (i<0) i = edges.length-1;
      bins[i]++;
    });
    const labels = edges.map((e,i)=>{
      if (i===0) return `ï½${edges[0]}åˆ†`;
      return `${edges[i-1]+1}ï½${e}åˆ†`;
    });
    return { labels, values: bins };
  }

  function exportCSV(rows){
    if (!rows.length){ alert('å‡ºåŠ›å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const headers = ['æ•´ç†No','éƒ¨ç½²','ãƒ©ã‚¤ãƒ³','ç™ºç”Ÿæ—¥','ç™ºç”Ÿæ™‚åˆ»','å†é–‹æ™‚åˆ»','ç•°å¸¸å†…å®¹','è£½é€ å‡¦ç½®','é¡ã‚Š','å‡¦ç½®è€…','æŠ€è¡“è¦è«‹','çŠ¶æ…‹','æŠ€è¡“å‡¦ç½®è€…','ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°','å‰å›çµ‚ç‰©ç¢ºèª','å‘½æ•°æœ‰ç„¡','å‘½æ•°åˆ°é”','ä¿å…¨å˜ä½','åŸå› å¯¾ç­–','å†ç™º/æ–°è¦','è‚¯å®š','_id'];
    const csvRows = rows.map(r=>[
      r.serialNo||'', r.department||'', r.lineName||'', r.occurrenceDate||'', r.occurrenceTime||'', r.restartTime||'',
      r.anomalyContent||'', r.actionTaken||'', r.traceback||'', r.handler||'',
      r.techRequest||'', r.status||'', r.techHandler||'', r.discoveryTiming||'', r.previousCheck||'',
      r.lifespan||'', r.lifespanReached||'', r.maintenanceUnit||'', r.rootCauseAction||'',
      r.recurrenceType||'', r.affirmation||'', r._id||''
    ]);
    let csv = '\uFEFF' + headers.join(',') + '\n';
    csvRows.forEach(r=>{ csv += r.map(c=>`"${(c??'').toString().replace(/"/g,'""')}"`).join(',')+'\n'; });
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `ç•°å¸¸å±¥æ­´_æ˜ç´°_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
  }
</script>
</body>
</html>