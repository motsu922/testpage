<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ç•°å¸¸å±¥æ­´ é›†è¨ˆãƒ»è§£æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆãƒ€ãƒ¼ã‚¯ãƒ»å¤§å‹ãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼‰</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<style>
  :root{
    /* --- Dark Theme Palette --- */
    --bg:#0b0f19;           /* èƒŒæ™¯ï¼šæ¼†é»’å¯„ã‚Š */
    --card:#111827;         /* ã‚«ãƒ¼ãƒ‰ï¼šæ¿ƒç´ºã‚°ãƒ¬ãƒ¼ */
    --ink:#e5e7eb;          /* æ–‡å­—ï¼šæ˜ç° */
    --muted:#9ca3af;        /* è£œåŠ©æ–‡å­— */
    --border:#1f2937;       /* æ ç·š */
    --brand:#60a5fa;        /* é’ç³»ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ */
    --accent:#f59e0b;       /* é»„æ©™ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ */
    --ok:#22c55e;           /* å®Œäº† */
    --warn:#f59e0b;         /* è­¦å‘Š */
    --ng:#ef4444;           /* æ³¨æ„ */
    --cardGlow:0 8px 30px rgba(0,0,0,.35);

    /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨ˆæ¸¬ */
    --header-h: 64px;
    --wrap-max: 2560px;          /* 4Kã«ã‚‚è€ãˆã‚‹ */
    --grid-gap: 16px;

    /* å£æ›ã‘ç”¨ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆ1.0ï½1.3ãã‚‰ã„ã§å¾®èª¿æ•´ï¼‰ */
    --scale: 1.00;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Sans","Noto Sans JP",sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }

  /* ===== Top Bar ===== */
  .topbar{
    position:sticky;top:0;z-index:50;height:var(--header-h);
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:12px 16px;border-bottom:1px solid var(--border);
    background:linear-gradient(135deg,#0b1022 0%, #0f172a 100%);
    box-shadow:0 6px 18px rgba(0,0,0,.4);
  }
  .title{display:flex;align-items:baseline;gap:12px}
  .title h1{margin:0;font-size:20px;letter-spacing:.2px}
  .title .sub{color:var(--muted);font-size:12px}

  .toolbar{display:flex;align-items:center;gap:10px}
  .btn, .chip{
    display:inline-flex;align-items:center;gap:.5rem;
    border:1px solid var(--border);background:#0f172a;color:var(--ink);
    padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700;font-size:13px;
    transition:.2s;
  }
  .btn:hover{border-color:#334155;background:#111b2e}
  .btn.primary{border-color:#1d4ed8;background:#0b2a66}
  .btn.danger{border-color:#7f1d1d;background:#3f1010}
  .btn.ghost{background:#0b1327}
  .btn[aria-pressed="true"]{outline:2px solid var(--brand);outline-offset:2px}

  .range{appearance:none;width:160px;height:4px;border-radius:4px;background:#1f2a44;outline:none}
  .range::-webkit-slider-thumb{appearance:none;width:14px;height:14px;border-radius:50%;background:var(--brand);cursor:pointer}

  /* ===== App Wrap ===== */
  .wrap{
    max-width:var(--wrap-max);margin:0 auto;padding:16px;transform-origin: top left;
    transform: scale(var(--scale));
  }

  /* ===== KPI Row ===== */
  .kpis{
    display:grid;grid-template-columns:repeat(5, 1fr);gap:var(--grid-gap);margin-top:16px;
  }
  .kpi{
    background:linear-gradient(135deg,#0f172a 0%, #111827 100%);
    border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:var(--cardGlow);
  }
  .kpi .label{color:var(--muted);font-size:12px;margin-bottom:6px}
  .kpi .val{font-size:32px;font-weight:800;letter-spacing:.5px}
  .kpi.ok{box-shadow:0 0 0 1px rgba(34,197,94,.15), 0 10px 30px rgba(34,197,94,.08)}
  .kpi.warn{box-shadow:0 0 0 1px rgba(245,158,11,.15), 0 10px 30px rgba(245,158,11,.08)}
  .kpi.ng{box-shadow:0 0 0 1px rgba(239,68,68,.15), 0 10px 30px rgba(239,68,68,.08)}

  /* ===== Grid Charts (3 cols x 2 rows, one screen) ===== */
  .grid{
    margin-top:var(--grid-gap);
    display:grid;grid-template-columns:repeat(3,1fr);
    grid-auto-rows: 320px; /* é«˜ã•ï¼šå¤§å‹ãƒ¢ãƒ‹ã‚¿ä¸€ç”»é¢ã§åã¾ã‚‹æƒ³å®š */
    gap:var(--grid-gap);
  }
  .card{
    background:var(--card);border:1px solid var(--border);border-radius:14px;
    box-shadow:var(--cardGlow);padding:14px;display:flex;flex-direction:column;min-height:0;
  }
  .chart-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .chart-header h4{margin:0;font-size:14px;color:#cbd5e1}
  .muted{color:var(--muted);font-size:12px}

  .chart-wrap{position:relative;inset:0;flex:1;min-height:0}
  canvas{width:100% !important;height:100% !important}

  /* ===== Details Table (toggle) ===== */
  .details{margin-top:var(--grid-gap)}
  .tablewrap{border:1px solid var(--border);border-radius:14px;background:var(--card);box-shadow:var(--cardGlow);overflow:auto;max-height:420px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;font-size:13px}
  th{position:sticky;top:0;background:#0f172a;color:#cbd5e1;z-index:1}
  tr:hover{background:#0f1422}

  /* ===== Filters Drawer (collapsible) ===== */
  .filters{
    margin-top:16px;display:none; /* é€šå¸¸ã¯éš ã™ï¼šãƒ—ãƒ¬ã‚¼ãƒ³é‡è¦– */
    grid-template-columns: repeat(6, 1fr);gap:10px;
  }
  .filters.active{display:grid}
  .filters .field{display:flex;flex-direction:column;gap:6px}
  .filters label{font-size:12px;color:#cbd5e1}
  .filters input,.filters select{
    background:#0b1327;border:1px solid #1f2a44;color:#e5e7eb;border-radius:10px;padding:10px;font-size:13px
  }

  /* ===== Auth Gate ===== */
  #authGate{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#030712;
  }
  #authCard{
    width:min(380px,92%);background:#0b1327;border:1px solid #1f2a44;color:#e5e7eb;border-radius:14px;padding:20px;
    box-shadow:0 20px 60px rgba(0,0,0,.6)
  }
  #authCard h2{margin:0 0 8px;color:#93c5fd}
  #authCard .muted{color:#93a0b5}
  #authCard input{width:100%;padding:12px;border-radius:10px;border:1px solid #1f2a44;background:#0a1226;color:#e5e7eb}
  #authMsg{color:#fca5a5;min-height:1.2em;margin-top:6px}

  /* ===== Responsive (fallback) ===== */
  @media (max-width:1600px){
    .kpis{grid-template-columns:repeat(5,1fr)}
    .grid{grid-template-columns:repeat(2,1fr)}
  }
  @media (max-width:1100px){
    .grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <!-- Top bar -->
  <div class="topbar">
    <div class="title">
      <h1>ğŸ“Š ç•°å¸¸å±¥æ­´ é›†è¨ˆãƒ»è§£æï¼ˆDarkï¼‰</h1>
      <span class="sub">å¤§å‹ãƒ¢ãƒ‹ã‚¿ãƒ¼æœ€é©åŒ–ãƒ»ä¸€ç”»é¢</span>
    </div>
    <div class="toolbar">
      <label class="muted" for="scale">è¡¨ç¤ºå€ç‡</label>
      <input id="scale" class="range" type="range" min="0.85" max="1.30" step="0.01" value="1.00" />
      <button id="btnToggleFilters" class="btn ghost" aria-pressed="false">ğŸ§° ãƒ•ã‚£ãƒ«ã‚¿</button>
      <button id="btnPresenter" class="btn" aria-pressed="false" title="ãƒ•ã‚£ãƒ«ã‚¿/æ˜ç´°ã‚’éš ã—ã¦ç™ºè¡¨å‘ã‘ã«æœ€é©åŒ–">ğŸ–¥ï¸ ãƒ—ãƒ¬ã‚¼ãƒ³è¡¨ç¤º</button>
      <button id="btnFullscreen" class="btn primary" title="å…¨ç”»é¢">â›¶ å…¨ç”»é¢</button>
      <button id="btnSignOut" class="btn danger" style="display:none;">ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>

  <!-- Auth gate -->
  <div id="authGate">
    <div id="authCard">
      <h2>ğŸ” ã‚µã‚¤ãƒ³ã‚¤ãƒ³</h2>
      <p class="muted" style="margin-bottom:10px;">ç¤¾å†…ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
      <div class="field" style="margin-bottom:8px;">
        <input type="email" id="authEmail" placeholder="user@miyama-unitec.co.jp">
      </div>
      <div class="field">
        <input type="password" id="authPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <div style="display:flex;gap:10px;margin-top:10px;">
        <button id="btnLogin" class="btn primary" style="flex:1;">ãƒ­ã‚°ã‚¤ãƒ³</button>
      </div>
      <div id="authMsg"></div>
    </div>
  </div>

  <!-- App -->
  <div id="app" style="display:none;">
    <div class="wrap" id="wrap">
      <!-- KPI -->
      <div class="kpis" id="kpis">
        <div class="kpi"><div class="label">ç·ç•°å¸¸ä»¶æ•°</div><div class="val" id="kpiTotal">0</div></div>
        <div class="kpi ok"><div class="label">å®Œäº†</div><div class="val" id="kpiDone">0</div></div>
        <div class="kpi warn"><div class="label">å¯¾å¿œå¾…ã¡</div><div class="val" id="kpiPending">0</div></div>
        <div class="kpi ng"><div class="label">ä»Šæœˆã®ç•°å¸¸</div><div class="val" id="kpiThisMonth">0</div></div>
        <div class="kpi" style="box-shadow:0 0 0 1px rgba(14,165,233,.15), 0 10px 30px rgba(14,165,233,.08)">
          <div class="label">å¹³å‡å¯¾å¿œæ™‚é–“</div><div class="val"><span id="kpiAvgMin">0</span> åˆ†</div>
        </div>
      </div>

      <!-- ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆé€šå¸¸éè¡¨ç¤ºï¼‰ -->
      <div class="filters" id="filters">
        <div class="field"><label>æ—¥ä»˜(From)</label><input type="date" id="dateFrom"></div>
        <div class="field"><label>æ—¥ä»˜(To)</label><input type="date" id="dateTo"></div>
        <div class="field"><label>éƒ¨ç½²</label><select id="fDepartment"><option value="">ã™ã¹ã¦</option></select></div>
        <div class="field"><label>ãƒ©ã‚¤ãƒ³</label><select id="fLine"><option value="">ã™ã¹ã¦</option></select></div>
        <div class="field"><label>æŠ€è¡“è¦è«‹</label>
          <select id="fTechReq"><option value="">ã™ã¹ã¦</option><option value="è¦è«‹">æŠ€è¡“è¦è«‹</option><option value="å®Œçµ">è£½é€ ã§å®Œçµ</option></select>
        </div>
        <div class="field"><label>çŠ¶æ…‹</label>
          <select id="fStatus"><option value="">ã™ã¹ã¦</option><option value="pending">æŠ€è¡“å…¥åŠ›å¾…ã¡</option><option value="complete">å®Œäº†</option></select>
        </div>
        <div class="field"><label>å†ç™º/æ–°è¦</label>
          <select id="fRecur"><option value="">ã™ã¹ã¦</option><option value="å†ç™º">å†ç™º</option><option value="æ–°è¦">æ–°è¦</option></select>
        </div>
        <div class="field" style="grid-column:span 3;">
          <label>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆç•°å¸¸å†…å®¹ãƒ»åŸå› å¯¾ç­–ï¼‰</label>
          <input id="fKeyword" type="text" placeholder="ä¾‹: ãƒãƒª, QR, å“é•ã„ ãªã©">
        </div>
        <div class="field" style="grid-column:span 3;display:flex;gap:10px;align-items:flex-end;">
          <button id="btnReload" class="btn">å†èª­è¾¼</button>
          <button id="btnClear" class="btn ghost">ãƒªã‚»ãƒƒãƒˆ</button>
          <button id="btnExport" class="btn ghost">CSVå‡ºåŠ›ï¼ˆæ˜ç´°ï¼‰</button>
        </div>
      </div>

      <!-- Charts Grid -->
      <div class="grid" id="grid">
        <div class="card">
          <div class="chart-header"><h4>ğŸ“ˆ æœˆæ¬¡ãƒˆãƒ¬ãƒ³ãƒ‰</h4><span class="muted" id="trendCaption"></span></div>
          <div class="chart-wrap"><canvas id="chartTrend"></canvas></div>
        </div>
        <div class="card">
          <div class="chart-header"><h4>ğŸ¢ éƒ¨ç½²åˆ¥ä»¶æ•°ï¼ˆTop10ï¼‰</h4><span class="muted"></span></div>
          <div class="chart-wrap"><canvas id="chartDept"></canvas></div>
        </div>
        <div class="card">
          <div class="chart-header"><h4>ğŸ›  ãƒ©ã‚¤ãƒ³åˆ¥ä»¶æ•°ï¼ˆTop10ï¼‰</h4><span class="muted"></span></div>
          <div class="chart-wrap"><canvas id="chartLine"></canvas></div>
        </div>
        <div class="card">
          <div class="chart-header"><h4>ğŸ”„ å†ç™º / æ–°è¦</h4><span class="muted">å‰²åˆ</span></div>
          <div class="chart-wrap"><canvas id="chartRecurrence"></canvas></div>
        </div>
        <div class="card">
          <div class="chart-header"><h4>ğŸ“Š ãƒ‘ãƒ¬ãƒ¼ãƒˆï¼ˆé »å‡ºèªï¼‰</h4><span class="muted">ä¸Šä½20èª</span></div>
          <div class="chart-wrap"><canvas id="chartPareto"></canvas></div>
        </div>
        <div class="card">
          <div class="chart-header"><h4>â± å¯¾å¿œæ™‚é–“ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ </h4><span class="muted">åˆ†å˜ä½</span></div>
          <div class="chart-wrap"><canvas id="chartDuration"></canvas></div>
        </div>
      </div>

      <!-- Details -->
      <div class="details" id="details">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
          <h4 class="muted" style="margin:0;">ğŸ“„ æ˜ç´°ï¼ˆãƒ•ã‚£ãƒ«ã‚¿å¾Œ ä¸Šä½500ä»¶ï¼‰</h4>
          <button id="btnToggleDetails" class="btn ghost" aria-pressed="true">éš ã™/è¡¨ç¤º</button>
        </div>
        <div class="tablewrap" id="tableWrap">
          <table id="tbl">
            <thead>
              <tr>
                <th>æ•´ç†No</th><th>éƒ¨ç½²</th><th>ãƒ©ã‚¤ãƒ³</th><th>ç™ºç”Ÿæ—¥</th><th>ç™ºç”Ÿ</th><th>å†é–‹</th>
                <th>ç•°å¸¸å†…å®¹</th><th>è£½é€ å‡¦ç½®</th><th>æŠ€è¡“è¦è«‹</th><th>çŠ¶æ…‹</th>
                <th>å†ç™º/æ–°è¦</th><th>åŸå› ãƒ»å¯¾ç­–</th>
              </tr>
            </thead>
            <tbody id="tblBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script type="module">
  /* ===== Firebase SDK ===== */
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
  import { getFirestore, collection, getDocs, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyA0YUIpIDh4WB4p1ewiNB0XfwHve0ByljU",
    authDomain: "abnreport-fd733.firebaseapp.com",
    projectId: "abnreport-fd733",
    storageBucket: "abnreport-fd733.appspot.com",
    messagingSenderId: "349748947315",
    appId: "1:349748947315:web:010cb671d2a95bcf1f7d06"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  enableIndexedDbPersistence(db).catch(()=>{});

  /* ===== Chart.js Dark Defaults ===== */
  Chart.defaults.color = '#d1d5db';
  Chart.defaults.borderColor = '#334155';
  Chart.defaults.font.family = getComputedStyle(document.body).fontFamily;
  const COLORS = {
    line:'#60a5fa',
    bar:'#93c5fd',
    bar2:'#fbbf24',
    ok:'#22c55e',
    warn:'#f59e0b',
    ng:'#ef4444'
  };

  /* ===== UI ===== */
  const gate = document.getElementById('authGate');
  const appRoot = document.getElementById('app');
  const btnLogin = document.getElementById('btnLogin');
  const btnSignOut = document.getElementById('btnSignOut');
  const authMsg = document.getElementById('authMsg');
  const scaleCtl = document.getElementById('scale');
  const wrap = document.getElementById('wrap');
  const btnToggleFilters = document.getElementById('btnToggleFilters');
  const filters = document.getElementById('filters');
  const btnPresenter = document.getElementById('btnPresenter');
  const btnFullscreen = document.getElementById('btnFullscreen');
  const btnToggleDetails = document.getElementById('btnToggleDetails');
  const tableWrap = document.getElementById('tableWrap');

  btnLogin.addEventListener('click', async ()=>{
    const email = document.getElementById('authEmail').value.trim();
    const pass  = document.getElementById('authPassword').value;
    try{
      await setPersistence(auth, browserLocalPersistence);
      await signInWithEmailAndPassword(auth, email, pass);
    }catch(e){
      authMsg.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ' + (e.code || e.message);
    }
  });
  btnSignOut.addEventListener('click', ()=> signOut(auth));

  onAuthStateChanged(auth, user=>{
    if (user){ gate.style.display='none'; appRoot.style.display='block'; btnSignOut.style.display='inline-flex'; boot(); }
    else{ appRoot.style.display='none'; gate.style.display='flex'; btnSignOut.style.display='none'; }
  });

  // è¡¨ç¤ºå€ç‡ï¼ˆå£æ›ã‘è·é›¢ã«åˆã‚ã›ã¦ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼‰
  scaleCtl.addEventListener('input', (e)=>{
    document.documentElement.style.setProperty('--scale', e.target.value);
  });

  // ãƒ•ã‚£ãƒ«ã‚¿è¡¨ç¤ºåˆ‡æ›¿
  btnToggleFilters.addEventListener('click', ()=>{
    const on = filters.classList.toggle('active');
    btnToggleFilters.setAttribute('aria-pressed', on ? 'true' : 'false');
  });

  // ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ•ã‚£ãƒ«ã‚¿/æ˜ç´°éš ã—ï¼‰
  btnPresenter.addEventListener('click', ()=>{
    const pressed = btnPresenter.getAttribute('aria-pressed') === 'true';
    const next = !pressed;
    btnPresenter.setAttribute('aria-pressed', next?'true':'false');
    // ãƒˆã‚°ãƒ«ï¼šãƒ•ã‚£ãƒ«ã‚¿éè¡¨ç¤ºãƒ»æ˜ç´°éš ã—
    filters.classList.remove('active');
    tableWrap.style.display = next ? 'none' : 'block';
  });

  // æ˜ç´°è¡¨ç¤ºåˆ‡æ›¿ï¼ˆå€‹åˆ¥ï¼‰
  btnToggleDetails.addEventListener('click', ()=>{
    const vis = tableWrap.style.display !== 'none';
    tableWrap.style.display = vis ? 'none' : 'block';
    btnToggleDetails.setAttribute('aria-pressed', vis ? 'false' : 'true');
  });

  // å…¨ç”»é¢
  btnFullscreen.addEventListener('click', ()=>{
    if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
    else document.exitFullscreen().catch(()=>{});
  });

  /* ===== Data ===== */
  let ALL = [];
  let filtered = [];
  let charts = {};

  // Filters
  const fDepartment = document.getElementById('fDepartment');
  const fLine       = document.getElementById('fLine');
  const fTechReq    = document.getElementById('fTechReq');
  const fStatus     = document.getElementById('fStatus');
  const fRecur      = document.getElementById('fRecur');
  const fKeyword    = document.getElementById('fKeyword');
  const dateFrom    = document.getElementById('dateFrom');
  const dateTo      = document.getElementById('dateTo');

  document.getElementById('btnClear').addEventListener('click', ()=>{
    dateFrom.value=''; dateTo.value='';
    fDepartment.value=''; fLine.value=''; fTechReq.value=''; fStatus.value=''; fRecur.value='';
    fKeyword.value=''; applyFilters();
  });
  document.getElementById('btnReload').addEventListener('click', async ()=>{ await loadAll(); applyFilters(); });
  document.getElementById('btnExport').addEventListener('click', ()=> exportCSV(filtered));

  async function boot(){
    await loadAll();
    populateMasterFilters(ALL);
    applyFilters();
  }

  async function loadAll(){
    const snap = await getDocs(collection(db,'anomalies'));
    ALL = snap.docs.map(d=> ({_id:d.id, ...d.data()}));
  }

  function populateMasterFilters(rows){
    const deps = [...new Set(rows.map(r=>r.department).filter(Boolean))].sort();
    const lines= [...new Set(rows.map(r=>r.lineName).filter(Boolean))].sort();
    fDepartment.innerHTML = '<option value="">ã™ã¹ã¦</option>'+deps.map(x=>`<option>${x}</option>`).join('');
    fLine.innerHTML       = '<option value="">ã™ã¹ã¦</option>'+lines.map(x=>`<option>${x}</option>`).join('');
  }

  function applyFilters(){
    const kw = (fKeyword.value||'').trim().toLowerCase();
    const dFrom = dateFrom.value? new Date(dateFrom.value) : null;
    const dTo   = dateTo.value? new Date(dateTo.value) : null;

    filtered = ALL.filter(r=>{
      if (fDepartment.value && r.department!==fDepartment.value) return false;
      if (fLine.value && r.lineName!==fLine.value) return false;
      if (fTechReq.value && r.techRequest!==fTechReq.value) return false;
      if (fStatus.value && r.status!==fStatus.value) return false;
      if (fRecur.value && r.recurrenceType!==fRecur.value) return false;
      if (dFrom || dTo){
        const d = r.occurrenceDate ? new Date(r.occurrenceDate) : null;
        if (!d) return false;
        if (dFrom && d < dFrom) return false;
        if (dTo){
          const end = new Date(dTo); end.setDate(end.getDate()+1);
          if (d >= end) return false;
        }
      }
      if (kw){
        const t = `${r.anomalyContent||''} ${r.rootCauseAction||''}`.toLowerCase();
        if (!t.includes(kw)) return false;
      }
      return true;
    });

    renderKPI(filtered);
    renderCharts(filtered);
    renderTable(filtered);
  }

  /* ===== KPI ===== */
  function renderKPI(rows){
    const total = rows.length;
    const done  = rows.filter(r=>r.status==='complete').length;
    const pend  = total - done;

    const now = new Date();
    const ym  = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    const thisMonth = rows.filter(r=>{
      if (!r.occurrenceDate) return false;
      const d = new Date(r.occurrenceDate);
      const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      return k===ym;
    }).length;

    const durs = rows.map(durationMinutes).filter(v=>v!=null);
    const avg  = durs.length ? Math.round(durs.reduce((a,b)=>a+b,0)/durs.length) : 0;

    document.getElementById('kpiTotal').textContent = total;
    document.getElementById('kpiDone').textContent  = done;
    document.getElementById('kpiPending').textContent= pend;
    document.getElementById('kpiThisMonth').textContent = thisMonth;
    document.getElementById('kpiAvgMin').textContent = avg;
  }

  /* ===== Charts ===== */
  function destroyCharts(){ for (const k in charts){ try{ charts[k].destroy(); }catch{} } charts = {}; }

  function renderCharts(rows){
    destroyCharts();

    // æœˆæ¬¡ãƒˆãƒ¬ãƒ³ãƒ‰
    const monthly = groupCount(rows, r=>{
      if (!r.occurrenceDate) return 'ä¸æ˜';
      const d=new Date(r.occurrenceDate);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    });
    const months = Object.keys(monthly).sort();
    const trendVals = months.map(m=>monthly[m]);
    charts.trend = new Chart(document.getElementById('chartTrend'),{
      type:'line',
      data:{ labels:months, datasets:[{ label:'ä»¶æ•°', data:trendVals, borderColor:COLORS.line, backgroundColor:'rgba(96,165,250,.2)', tension:.25, fill:true }] },
      options:{ responsive:true, plugins:{legend:{display:false}}, scales:{x:{grid:{color:'#1f2937'}},y:{grid:{color:'#1f2937'}}} }
    });
    document.getElementById('trendCaption').textContent = months.length? `${months[0]} ï½ ${months[months.length-1]}` : '';

    // éƒ¨ç½²åˆ¥Top10
    const byDept = topN(groupCount(rows, r=>r.department||'æœªè¨­å®š'), 10);
    charts.dept = new Chart(document.getElementById('chartDept'),{
      type:'bar',
      data:{ labels:byDept.labels, datasets:[{ label:'ä»¶æ•°', data:byDept.values, backgroundColor:COLORS.bar }] },
      options:{ indexAxis:'y', plugins:{legend:{display:false}}, scales:{x:{grid:{color:'#1f2937'}},y:{grid:{color:'#1f2937'}}} }
    });

    // ãƒ©ã‚¤ãƒ³åˆ¥Top10
    const byLine = topN(groupCount(rows, r=>r.lineName||'æœªè¨­å®š'), 10);
    charts.line = new Chart(document.getElementById('chartLine'),{
      type:'bar',
      data:{ labels:byLine.labels, datasets:[{ label:'ä»¶æ•°', data:byLine.values, backgroundColor:COLORS.bar2 }] },
      options:{ indexAxis:'y', plugins:{legend:{display:false}}, scales:{x:{grid:{color:'#1f2937'}},y:{grid:{color:'#1f2937'}}} }
    });

    // å†ç™º/æ–°è¦
    const rec = groupCount(rows.filter(r=>r.recurrenceType), r=>r.recurrenceType);
    charts.recur = new Chart(document.getElementById('chartRecurrence'),{
      type:'doughnut',
      data:{ labels:Object.keys(rec), datasets:[{ data:Object.values(rec), backgroundColor:[COLORS.ng, COLORS.ok] }] },
      options:{ plugins:{legend:{position:'bottom'}} }
    });

    // ãƒ‘ãƒ¬ãƒ¼ãƒˆï¼ˆé »å‡ºèªï¼‰
    const words = topWords(rows, 20);
    charts.pareto = new Chart(document.getElementById('chartPareto'),{
      type:'bar',
      data:{ labels:words.labels, datasets:[{ label:'å‡ºç¾å›æ•°', data:words.values, backgroundColor:'#38bdf8' }] },
      options:{ plugins:{legend:{display:false}}, scales:{ x:{ ticks:{maxRotation:60,minRotation:30}, grid:{color:'#1f2937'} }, y:{ grid:{color:'#1f2937'} } } }
    });

    // å¯¾å¿œæ™‚é–“ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ 
    const durations = rows.map(durationMinutes).filter(v=>v!=null);
    const hist = histogram(durations, [0,5,10,15,20,30,45,60,90,120,180,240,360,480,720,1440,2880]);
    charts.dur = new Chart(document.getElementById('chartDuration'),{
      type:'bar',
      data:{ labels:hist.labels, datasets:[{ label:'ä»¶æ•°', data:hist.values, backgroundColor:'#a78bfa' }] },
      options:{ plugins:{legend:{display:false}}, scales:{x:{grid:{color:'#1f2937'}},y:{grid:{color:'#1f2937'}}} }
    });
  }

  /* ===== Table ===== */
  function renderTable(rows){
    const body = document.getElementById('tblBody');
    const MAX = 500;
    body.innerHTML = rows.slice(0,MAX).map(r=>`
      <tr>
        <td>${esc(r.serialNo)}</td>
        <td>${esc(r.department)}</td>
        <td>${esc(r.lineName)}</td>
        <td>${esc(r.occurrenceDate)}</td>
        <td>${esc(r.occurrenceTime)}</td>
        <td>${esc(r.restartTime)}</td>
        <td>${esc(trunc(r.anomalyContent,60))}</td>
        <td>${esc(trunc(r.actionTaken,60))}</td>
        <td>${r.techRequest==='è¦è«‹'?'æŠ€è¡“è¦è«‹':r.techRequest==='å®Œçµ'?'è£½é€ å®Œçµ':'-'}</td>
        <td>${r.status==='complete'?'å®Œäº†':'å¾…ã¡'}</td>
        <td>${esc(r.recurrenceType)}</td>
        <td>${esc(trunc(r.rootCauseAction,60))}</td>
      </tr>
    `).join('');
  }

  /* ===== Helpers ===== */
  function esc(v){ return (v??'').toString().replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[s]); }
  function trunc(v,n){ if(!v) return ''; const s=v.toString(); return s.length>n? s.slice(0,n)+'â€¦' : s; }

  function groupCount(rows, keyFn){
    const m={}; rows.forEach(r=>{ const k=keyFn(r); m[k]=(m[k]||0)+1; });
    return m;
  }
  function topN(mapObj, n){
    const arr = Object.entries(mapObj).sort((a,b)=>b[1]-a[1]).slice(0,n);
    return { labels: arr.map(([k])=>k), values: arr.map(([,v])=>v) };
  }

  function durationMinutes(r){
    if (!r.occurrenceTime || !r.restartTime) return null;
    const [oh,om] = r.occurrenceTime.split(':').map(Number);
    const [rh,rm] = r.restartTime.split(':').map(Number);
    if (isNaN(oh)||isNaN(om)||isNaN(rh)||isNaN(rm)) return null;
    let m = (rh*60+rm) - (oh*60+om);
    if (m<0) m += 1440; // æ—¥è·¨ã
    return m;
  }

  function tokenizeJa(text){
    const s = (text||'').toLowerCase()
      .replace(/[ï¼ˆï¼‰\(\)\[\]{}ã€Œã€ã€ã€ã€ã€‘<>]/g,' ')
      .replace(/[ã€ã€‚ï¼Œï¼.,!ï¼?ï¼Ÿ:ï¼š;ï¼›/ï¼\\\-\+]/g,' ');
    const tokens = s.split(/\s+/).filter(w=>w && w.length<=20);
    const stop = new Set(['ã®','ã¨','ã«','ã¯','ã‚’','ãŒ','ã§','ã‚‚','ã¸','ã‚ˆã‚Š','ã‹ã‚‰','ã¾ã§','ã§ã™','ã¾ã™','ã™ã‚‹','ã—ãŸ','ã‚ã‚Š','ãªã—','ãŸã‚','ãªã©','åŠã³','ã¾ãŸ','ã™ã‚‹ã“ã¨','ã«ã¦','ã¨ã—ã¦','ã™ã‚‹ãŸã‚','ã«ã‚ˆã‚Š','ã«ã‚ˆã‚‹','ã“ã‚Œ','ãã‚Œ','ã‚‚ã®','ãŸã‚','ä»¶','æœ‰','ç„¡']);
    return tokens.filter(w=>!stop.has(w) && w.length>=2);
  }
  function topWords(rows, topK=20){
    const cnt={};
    rows.forEach(r=>{
      tokenizeJa(`${r.anomalyContent||''} ${r.rootCauseAction||''}`).forEach(w=> cnt[w]=(cnt[w]||0)+1 );
    });
    const arr = Object.entries(cnt).sort((a,b)=>b[1]-a[1]).slice(0,topK);
    return { labels: arr.map(a=>a[0]), values: arr.map(a=>a[1]) };
  }

  function histogram(values, edges){
    if (!values.length) return {labels:[], values:[]};
    const bins = new Array(edges.length).fill(0);
    values.forEach(v=>{
      let i = edges.findIndex(e=>v<=e);
      if (i<0) i = edges.length-1;
      bins[i]++;
    });
    const labels = edges.map((e,i)=>{
      if (i===0) return `ï½${edges[0]}åˆ†`;
      return `${edges[i-1]+1}ï½${e}åˆ†`;
    });
    return { labels, values: bins };
  }

  function exportCSV(rows){
    if (!rows.length){ alert('å‡ºåŠ›å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const headers = ['æ•´ç†No','éƒ¨ç½²','ãƒ©ã‚¤ãƒ³','ç™ºç”Ÿæ—¥','ç™ºç”Ÿæ™‚åˆ»','å†é–‹æ™‚åˆ»','ç•°å¸¸å†…å®¹','è£½é€ å‡¦ç½®','é¡ã‚Š','å‡¦ç½®è€…','æŠ€è¡“è¦è«‹','çŠ¶æ…‹','æŠ€è¡“å‡¦ç½®è€…','ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°','å‰å›çµ‚ç‰©ç¢ºèª','å‘½æ•°æœ‰ç„¡','å‘½æ•°åˆ°é”','ä¿å…¨å˜ä½','åŸå› å¯¾ç­–','å†ç™º/æ–°è¦','è‚¯å®š','_id'];
    const csvRows = rows.map(r=>[
      r.serialNo||'', r.department||'', r.lineName||'', r.occurrenceDate||'', r.occurrenceTime||'', r.restartTime||'',
      r.anomalyContent||'', r.actionTaken||'', r.traceback||'', r.handler||'',
      r.techRequest||'', r.status||'', r.techHandler||'', r.discoveryTiming||'', r.previousCheck||'',
      r.lifespan||'', r.lifespanReached||'', r.maintenanceUnit||'', r.rootCauseAction||'',
      r.recurrenceType||'', r.affirmation||'', r._id||''
    ]);
    let csv = '\uFEFF' + headers.join(',') + '\n';
    csvRows.forEach(r=>{ csv += r.map(c=>`"${(c??'').toString().replace(/"/g,'""')}"`).join(',')+'\n'; });
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `ç•°å¸¸å±¥æ­´_æ˜ç´°_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
  }
</script>
</body>
</html>