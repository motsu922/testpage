<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤‰åŒ–ç‚¹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    /* èªè¨¼ç”»é¢ */
    #authGate{
      position: fixed; inset: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex; align-items: center; justify-content: center; z-index: 2000;
    }
    #authCard{
      background: #fff; padding: 40px; border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,.2); width: 100%; max-width: 360px;
    }
    #authCard h2{ color:#333; margin-bottom:24px; text-align:center; }
    #authCard .form-group{ margin-bottom:16px; }
    #authCard label{ display:block; font-size:.85rem; color:#666; margin-bottom:6px; }
    #authCard input{
      width:100%; padding:12px; border:2px solid #e0e0e0;
      border-radius:8px; font-size:1rem;
    }
    #authCard input:focus{ outline:none; border-color:#667eea; }
    #authCard button{
      width:100%; padding:14px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color:#fff; border:none; border-radius:8px;
      font-size:1rem; font-weight:600; cursor:pointer; margin-top:8px;
    }

    /* ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    #mainMenu{ display:none; padding:30px 0; min-height:100vh; }
    .menu-container{ max-width:100%; margin:0; padding:0 10px; }
    .menu-header{ text-align:center; margin-bottom:30px; color:#fff; }
    .menu-header h1{ font-size:2.5rem; margin-bottom:8px; }
    .menu-header p{ opacity:.9; font-size:1.1rem; }

    /* ãƒˆãƒ”ãƒƒã‚¯ã‚¹ */
    .topics-filters{
      display:flex; gap:10px; align-items:center;
      margin: 10px 0 16px 0;
      padding: 14px 16px;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      background: #fafbfc;
    }
    .topics-filters label{ font-size:1rem; color:#444; font-weight:600; }
    .topics-filters select{
      flex:1; min-width: 220px;
      padding:12px 14px;
      border:2px solid #e0e0e0;
      border-radius:10px;
      font-size:1.05rem;
      background:#fff;
    }

    .topics-card{
      background:#fff; border-radius:12px; padding:16px;
      margin-bottom:16px; 
      box-shadow:0 4px 16px rgba(0,0,0,.2);
      border: 2px solid #e0e0e0;

    .overdue-banner{
      margin: 6px 0 10px 0;
      padding: 10px 12px;
      border-radius: 8px;
      border: 2px solid #ff8a80;
      background: #fff5f5;
      color: #7a1c1c;
      box-shadow: 0 2px 8px rgba(255,107,107,.25);
    }
    .overdue-banner h3{
      margin:0 0 6px 0;
      font-size: .95rem;
      display:flex; align-items:center; gap:6px;
    }
    .overdue-banner .overdue-list{ display:flex; flex-direction:column; gap:6px; }
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:.75rem;
      font-weight:700;
      margin-left:6px;
      vertical-align:middle;
    }
    .pill.overdue{
      background:#ffebee;
      color:#b71c1c;
      border:1px solid #ffcdd2;
    }

}
    .topics-card h2{
      font-size:1.15rem; color:#333; margin-bottom:12px;
      display:flex; align-items:center; gap:8px;
    }
    .topics-row{ display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; }
    .topics-row.two-columns{ grid-template-columns:repeat(2, 1fr); }
    .topics-section{ 
      background:#f8f9ff; 
      border-radius:10px; 
      padding:12px; 
      border: 2px solid #c5cae9;
      box-shadow: 0 2px 8px rgba(102,126,234,.12);
    }
    .topics-section.undecided{ grid-column: 1 / -1; }
    .topics-section.undecided > .topics-row{ display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; }
    .topics-section.undecided .topics-item{ margin-bottom:0; }
    .topics-section h3{
      font-size:.95rem; color:#667eea; margin-bottom:10px;
      display:flex; align-items:center; gap:6px;
    }
    .topics-section.tomorrow h3{ color:#ff9800; }
    .topics-item{
      background:#fff; 
      border-radius:6px; 
      padding:10px; 
      margin-bottom:8px;
      border-left:4px solid #2196f3; 
      cursor:pointer; 
      transition:all .2s;
      border: 2px solid #e3f2fd;
      box-shadow: 0 1px 4px rgba(33,150,243,.15);
    }
    .topics-item:hover{ 
      transform: translateX(3px); 
      box-shadow:0 2px 10px rgba(33,150,243,.3);
      border-color: #90caf9;
    }
    .topics-item:last-child{ margin-bottom:0; }
    .topics-item .time{ 
      font-size:.95rem; 
      color:#fff; 
      margin-bottom:6px; 
      font-weight:700;
      background: linear-gradient(135deg, #5c6bc0 0%, #3949ab 100%);
      padding: 5px 10px;
      border-radius: 5px;
      display: inline-block;
      border-left: 3px solid #283593;
    }
    
    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ */
    .status-badge{
      display:inline-block;
      padding:3px 10px;
      border-radius:5px;
      font-size:.75rem;
      font-weight:700;
      margin-left:8px;
    }
    .status-badge.planned{ background:#bbdefb; color:#1565c0; border:1px solid #1976d2; }
    .status-badge.completed{ background:#c8e6c9; color:#2e7d32; border:1px solid #388e3c; }
    .status-badge.canceled{ background:#ffcdd2; color:#c62828; border:1px solid #d32f2f; }
    .status-badge.postponed{ background:#ffe0b2; color:#e65100; border:1px solid #ef6c00; }
    
    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ãƒœã‚¿ãƒ³ */
    .status-actions{
      display:flex;
      gap:5px;
      margin-top:8px;
      flex-wrap:wrap;
    }
    .status-btn{
      padding:4px 10px;
      border:none;
      border-radius:5px;
      font-size:.75rem;
      font-weight:600;
      cursor:pointer;
      transition:all .2s;
    }
    .status-btn:hover{ transform:translateY(-1px); box-shadow:0 3px 6px rgba(0,0,0,.2); }
    .status-btn.btn-complete{ background:#4caf50; color:#fff; }
    .status-btn.btn-complete:hover{ background:#388e3c; }
    .status-btn.btn-postpone{ background:#ff9800; color:#fff; }
    .status-btn.btn-postpone:hover{ background:#f57c00; }
    .status-btn.btn-cancel{ background:#f44336; color:#fff; }
    .status-btn.btn-cancel:hover{ background:#d32f2f; }
    .status-btn.btn-decide-date{ background:#2196f3; color:#fff; }
    .status-btn.btn-decide-date:hover{ background:#1976d2; }

    .topics-item .category{
      display:inline-block; padding:3px 10px; border-radius:8px;
      font-size:.75rem; font-weight:700; background:#c8e6c9; color:#2e7d32; margin-right:6px;
    }
    .topics-item .content{ font-size:.9rem; color:#333; line-height:1.5; margin-bottom:6px; }
    .topics-item .lines{ 
      font-size:.9rem; 
      color:#1565c0; 
      margin-top:6px; 
      font-weight:700;
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      padding: 5px 10px;
      border-radius: 5px;
      border-left: 3px solid #1976d2;
    }
    .topics-empty{ text-align:center; padding:20px; color:#888; font-size:.95rem; }

    /* ä»Šæœˆã®å¤‰åŒ–ç‚¹ãƒ†ãƒ¼ãƒ–ãƒ« */
    .month-table{
      width:100%;
      border-collapse:collapse;
      font-size:.85rem;
      background:#fff;
      border-radius:6px;
      overflow:hidden;
    }
    .month-table thead{
      background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:#fff;
    }
    .month-table th{
      padding:8px 10px;
      text-align:left;
      font-weight:600;
      font-size:.8rem;
    }
    .month-table tbody tr{
      border-bottom:1px solid #e0e0e0;
      transition:background .2s;
      cursor:pointer;
    }
    .month-table tbody tr:hover{
      background:#f5f5ff;
    }
    .month-table td{
      padding:8px 10px;
      vertical-align:top;
    }
    .month-table td.date-col{
      font-weight:600;
      color:#667eea;
      white-space:nowrap;
    }
    .month-table td.content-col{
      max-width:200px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ */
    .menu-cards{ display:grid; grid-template-columns:repeat(2, 1fr); gap:16px; }
    .menu-card{
      background:#fff; border-radius:16px; padding:24px;
      cursor:pointer; transition:all .3s; box-shadow:0 4px 20px rgba(0,0,0,.1);
    }
    .menu-card:hover{ transform: translateY(-5px); box-shadow:0 8px 30px rgba(0,0,0,.2); }
    .menu-card .icon{ font-size:2.5rem; margin-bottom:12px; }
    .menu-card h3{ font-size:1.1rem; color:#333; margin-bottom:6px; }
    .menu-card p{ color:#666; font-size:.85rem; line-height:1.4; }

    /* å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ */
    .app-header{
      background: rgba(255,255,255,.95); padding:16px 24px;
      display:flex; justify-content:space-between; align-items:center;
      box-shadow:0 2px 10px rgba(0,0,0,.1);
    }
    .app-header h1{ font-size:1.2rem; color:#333; display:flex; align-items:center; gap:10px; }
    .btn-back{
      padding:8px 16px; background:#f5f5f5; border:none;
      border-radius:8px; cursor:pointer; font-size:.9rem;
    }
    .btn-back:hover{ background:#e0e0e0; }
    .btn-logout{
      padding:8px 16px; background:#ef5350; color:#fff; border:none;
      border-radius:8px; cursor:pointer; font-size:.9rem;
    }
    .btn-logout:hover{ background:#e53935; }

    /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    .screen{ display:none; }
    .container{ max-width:1200px; margin:0 auto; padding:20px; }
    .card{ background:#fff; border-radius:16px; padding:24px; box-shadow:0 4px 20px rgba(0,0,0,.15); margin-bottom:20px; }
    .btn{
      padding:10px 20px; border:none; border-radius:8px;
      font-size:1rem; cursor:pointer; font-weight:500; transition:all .2s;
    }
    .btn-primary{ background: linear-gradient(135deg, #667eea, #764ba2); color:#fff; }
    .btn-primary:hover{ transform: translateY(-2px); box-shadow:0 4px 12px rgba(102,126,234,.4); }
    .btn-secondary{ background:#f5f5f5; color:#333; }
    .btn-danger{ background:#e53935; color:#fff; }
    .btn-sm{ padding:6px 12px; font-size:.85rem; }

    /* CSVãƒœã‚¿ãƒ³ disabledè¡¨ç¾ */
    .btn-disabled{ opacity:.45; cursor:not-allowed; filter:grayscale(30%); }

    .form-group{ margin-bottom:16px; }
    .form-group label{ display:block; font-size:.9rem; font-weight:600; color:#333; margin-bottom:6px; }
    .form-group label .required{ color:#e53935; margin-left:4px; }
    .form-group input, .form-group select, .form-group textarea{
      width:100%; padding:10px 12px; border:2px solid #e0e0e0;
      border-radius:8px; font-size:1rem;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus{
      outline:none; border-color:#667eea;
    }
    .form-group textarea{ min-height:100px; resize:vertical; }
    .form-group .hint{ font-size:.8rem; color:#888; margin-top:4px; }
    .form-row{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }

    .badge{ padding:2px 8px; border-radius:12px; font-size:.7rem; font-weight:600; }
    .badge-anomaly{ background:#ffcdd2; color:#c62828; }
    .badge-changepoint{ background:#c8e6c9; color:#2e7d32; }
    .badge-planned{ background:#bbdefb; color:#1565c0; }
    .badge-sudden{ background:#ffe0b2; color:#e65100; }

    /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
    .filter-section{ display:flex; flex-wrap:wrap; gap:16px; align-items:flex-end; margin-bottom:20px; }
    .filter-group{ display:flex; flex-direction:column; gap:6px; }
    .filter-group label{ font-size:.85rem; color:#666; font-weight:500; }
    .filter-group select, .filter-group input{
      padding:10px 14px; border:2px solid #e0e0e0; border-radius:8px; font-size:1rem; min-width:150px;
    }

    /* çµ±è¨ˆ */
    .stats-row{ display:grid; grid-template-columns:repeat(auto-fit, minmax(130px, 1fr)); gap:12px; margin-bottom:20px; }
    .stat-card{ background:#fff; border-radius:12px; padding:16px; text-align:center; box-shadow:0 2px 10px rgba(0,0,0,.1); }
    .stat-card .number{ font-size:1.8rem; font-weight:bold; color:#667eea; }
    .stat-card .label{ font-size:.8rem; color:#666; margin-top:4px; }
    .stat-card.anomaly .number{ color:#e53935; }
    .stat-card.sudden .number{ color:#e65100; }
    .stat-card.planned .number{ color:#2196f3; }

    /* â–¼ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®ã‚°ãƒ©ãƒ•è¡¨ç¤º */
    .chart-wrap{
      position: relative;
      width: 100%;
      height: 320px;
    }
    @media (max-width: 768px){
      .chart-wrap{ height: 260px; }
    }

    /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ */
    .timeline{ position:relative; padding-left:24px; }
    .timeline::before{
      content:''; position:absolute; left:8px; top:0; bottom:0;
      width:3px; background: linear-gradient(180deg, #667eea, #764ba2); border-radius:3px;
    }
    .timeline-item{
      position:relative; margin-bottom:8px; padding:10px 16px;
      background:#f8f9ff; border-radius:8px; border-left:4px solid #667eea;
      cursor:pointer; transition:all .2s;
    }
    .timeline-item:hover{ transform: translateX(5px); box-shadow:0 4px 15px rgba(0,0,0,.1); }
    .timeline-item::before{
      content:''; position:absolute; left:-20px; top:14px;
      width:10px; height:10px; background:#667eea;
      border-radius:50%; border:2px solid #fff;
    }
    .timeline-item.anomaly-only{ border-left-color:#e53935; background:#fff5f5; }
    .timeline-item.anomaly-only::before{ background:#e53935; }
    .timeline-item.cp-sudden{ border-left-color:#ff9800; background:#fff8e1; }
    .timeline-item.cp-sudden::before{ background:#ff9800; }
    .timeline-item.cp-planned{ border-left-color:#2196f3; background:#e3f2fd; }
    .timeline-item.cp-planned::before{ background:#2196f3; }
    .timeline-row{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .timeline-date{ font-size:.8rem; color:#666; min-width:85px; }
    .timeline-badges{ display:flex; gap:4px; flex-wrap:wrap; }
    .timeline-summary{ flex:1; font-size:.9rem; color:#333; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; min-width:120px; }

    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
    .calendar-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .calendar-nav{ display:flex; align-items:center; gap:16px; }
    .calendar-nav button{ padding:8px 16px; background:#f5f5f5; border:none; border-radius:8px; cursor:pointer; font-size:1rem; }
    .calendar-nav button:hover{ background:#e0e0e0; }
    .calendar-nav .month-year{ font-size:1.3rem; font-weight:bold; color:#333; min-width:160px; text-align:center; }
    .calendar-grid{ display:grid; grid-template-columns:repeat(7, 1fr); gap:4px; }
    .calendar-day-header{ text-align:center; padding:10px; font-weight:600; color:#666; font-size:.85rem; }
    .calendar-day{
      min-height:150px; background:#f8f9ff; border-radius:8px; padding:8px;
      cursor:pointer; transition:all .2s;
    }
    .calendar-day:hover{ background:#e8ebff; }
    .calendar-day.other-month{ background:#f5f5f5; opacity:.6; }
    .calendar-day.today{ background:#e3f2fd; border:2px solid #2196f3; }
    .calendar-day .day-number{ font-size:.85rem; font-weight:600; color:#333; margin-bottom:6px; }
    .calendar-day.sunday .day-number{ color:#e53935; }
    .calendar-day.saturday .day-number{ color:#2196f3; }
    .calendar-event{
      background:#2196f3; color:#fff; padding:6px 8px; border-radius:4px;
      font-size:.7rem; margin-bottom:4px; overflow:hidden; cursor:pointer;
      line-height:1.4;
    }
    .calendar-event:hover{ opacity:.9; transform:scale(1.02); }
    .calendar-event.category-äºº{ background:#e53935; }
    .calendar-event.category-æ–¹æ³•{ background:#2196f3; }
    .calendar-event.category-ææ–™{ background:#43a047; }
    .calendar-event.category-é‡‘å‹{ background:#ff9800; }
    .calendar-event.category-è¨­å‚™{ background:#9c27b0; }
    .calendar-event.category-ãã®ä»–{ background:#607d8b; }
    .calendar-more{ font-size:.7rem; color:#666; text-align:center; }

    /* ç®¡ç†ç”»é¢ */
    .master-tabs{ display:flex; gap:8px; margin-bottom:20px; }
    .master-tab{
      padding:10px 20px; background:#f5f5f5; border:none;
      border-radius:8px 8px 0 0; cursor:pointer; font-size:.95rem;
    }
    .master-tab.active{ background:#667eea; color:#fff; }
    .master-table{ width:100%; border-collapse:collapse; }
    .master-table th{ background:#667eea; color:#fff; padding:12px; text-align:left; }
    .master-table td{ padding:12px; border-bottom:1px solid #e0e0e0; }
    .master-table tr:hover{ background:#f8f9ff; }
    .master-add{ display:flex; gap:12px; margin-bottom:20px; }
    .master-add input{ flex:1; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .switch-flow-guide{
      border:1px solid #e9ecef;
      background:#f8f9fb;
      border-radius:14px;
      padding:12px 14px;
    }
    .switch-flow-title{ font-weight:800; color:#333; margin-bottom:10px; }
    .switch-flow-steps{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .switch-flow-steps .step{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background:#fff;
      border:1px solid #e5e7eb;
      color:#444;
      font-weight:700;
    }
    .switch-flow-steps .step .n{
      width:26px; height:26px; border-radius:50%;
      display:inline-flex; align-items:center; justify-content:center;
      background:#eef2ff; color:#333;
      font-weight:900;
    }
    .switch-flow-steps .step.active{
      border-color:#667eea;
      box-shadow:0 2px 12px rgba(102,126,234,.18);
    }
    .switch-flow-steps .step.active .n{ background:#667eea; color:#fff; }
    .switch-flow-steps .arrow{ opacity:.6; font-weight:900; }
    .switch-flow-status{
      margin-top:10px;
      font-size:.9rem;
      color:#333;
      background:#fff;
      border:1px dashed #d7dde7;
      border-radius:12px;
      padding:10px 12px;
    }

    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:3000; align-items:center; justify-content:center; padding:20px; }
    .modal.active{ display:flex; }
    .modal-content{ background:#fff; border-radius:16px; max-width:700px; width:100%; max-height:85vh; overflow-y:auto; }
    .modal-header{ padding:20px 24px; border-bottom:1px solid #e0e0e0; display:flex; justify-content:space-between; align-items:flex-start; }
    .modal-header h3{ font-size:1.2rem; color:#333; }
    .modal-close{ background:none; border:none; font-size:1.5rem; cursor:pointer; color:#999; }
    .modal-badges{ display:flex; gap:8px; flex-wrap:wrap; padding:16px 24px; background:#f8f9ff; border-bottom:1px solid #e0e0e0; }
    .modal-badges .badge{ padding:4px 12px; font-size:.8rem; }
    .modal-body{ padding:24px; }
    .modal-actions{ display:flex; gap:12px; padding:16px 24px; border-top:1px solid #e0e0e0; }
    .form-row{ display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px; }
    @media (max-width:600px){ .form-row{ grid-template-columns:1fr; } }
    .detail-section{ margin-bottom:20px; }
    .detail-section-title{ font-size:.85rem; font-weight:600; color:#667eea; margin-bottom:8px; }
    .detail-section-content{
      font-size:.95rem; color:#333; line-height:1.6;
      background:#f8f9fa; padding:12px 16px; border-radius:8px; white-space:pre-wrap;
    }
    .detail-grid{ display:grid; grid-template-columns:repeat(2, 1fr)); gap:12px; }
    .detail-grid-item{ background:#f8f9fa; padding:10px 14px; border-radius:8px; }
    .detail-grid-item .label{ font-size:.75rem; color:#888; margin-bottom:4px; }
    .detail-grid-item .value{ font-size:.9rem; color:#333; }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ç©ºçŠ¶æ…‹ */
    .loading{ text-align:center; padding:60px 20px; color:#666; }
    .spinner{ width:40px; height:40px; border:4px solid #e0e0e0; border-top-color:#667eea; border-radius:50%; animation: spin 1s linear infinite; margin:0 auto 16px; }
    @keyframes spin{ to{ transform: rotate(360deg);} }
    .empty-state{ text-align:center; padding:40px 20px; color:#666; }
    .empty-state .icon{ font-size:3rem; margin-bottom:12px; }

    #signOutBtn{
      position:fixed; top:16px; right:16px;
      padding:8px 16px; background:rgba(239,83,80,.9); color:#fff; border:none; border-radius:8px;
      cursor:pointer; font-size:.85rem; z-index:1000; display:none;
    }
    #signOutBtn:hover{ background:#e53935; }

    /* å„ç”»é¢ãƒ˜ãƒƒãƒ€ãƒ¼å†…ã®ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ */
    .header-actions{ display:flex; gap:10px; align-items:center; }

    /* å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ« */
    .history-table{ width:100%; border-collapse:collapse; font-size:.9rem; }
    .history-table th{ background:#667eea; color:#fff; padding:10px; text-align:left; }
    .history-table td{ padding:10px; border-bottom:1px solid #e0e0e0; }
    .history-table tr:hover{ background:#f8f9ff; }

    /* ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
    .file-upload-area{
      border:2px dashed #ccc; border-radius:8px; padding:20px;
      text-align:center; cursor:pointer; transition: all .2s;
      background:#fafafa;
    }
    .file-upload-area:hover{ border-color:#667eea; background:#f5f5ff; }

    @media (max-width: 768px){
      .menu-cards{ grid-template-columns:1fr; }
      .topics-row{ grid-template-columns:1fr; }
      .form-row{ grid-template-columns:1fr; }
      .filter-section{ flex-direction:column; }
      .detail-grid{ grid-template-columns:1fr; }
      .calendar-day{ min-height:70px; padding:4px; }
      .calendar-event{ font-size:.6rem; padding:1px 4px; }
    }

    /* ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .confirm-modal {
      display: none;
      position: fixed;
      z-index: 2500;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .confirm-modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .confirm-modal-header {
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 20px;
      color: #333;
    }
    .confirm-modal-body {
      margin-bottom: 25px;
    }
    .confirm-item {
      margin-bottom: 15px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 5px;
    }
    .confirm-label {
      font-weight: 600;
      color: #666;
      font-size: 0.85rem;
      margin-bottom: 5px;
    }
    .confirm-value {
      color: #333;
      font-size: 0.95rem;
    }
    .confirm-modal-buttons {
      display: flex;
      gap: 10px;
    }
    .confirm-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .confirm-btn-confirm {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .confirm-btn-confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    .confirm-btn-cancel {
      background: #95a5a6;
      color: white;
    }
    .confirm-btn-cancel:hover {
      background: #7f8c8d;
    }
  </style>
</head>
<body>
  <!-- èªè¨¼ç”»é¢ -->
  <div id="authGate">
    <div id="authCard">
      <h2>ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <div class="form-group">
        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="email" id="authEmail" placeholder="user@example.com">
      </div>
      <div class="form-group">
        <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="authPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <button id="authLoginBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <p id="authMsg" style="color:#c62828;margin-top:12px;text-align:center;font-size:.9rem;"></p>
    </div>
  </div>

  <button id="signOutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

  <!-- ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <div id="mainMenu">
    <div class="menu-container">
      <div class="menu-header">
        <h1>ğŸ”„ å¤‰åŒ–ç‚¹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
      </div>

      
  <!-- ãƒˆãƒ”ãƒƒã‚¯ã‚¹ï¼ˆplannedã®ã¿ï¼‰ -->
      <div class="topics-card">
        <h2>ğŸ“¢ ãƒˆãƒ”ãƒƒã‚¯ã‚¹ï¼ˆè¨ˆç”»å¤‰åŒ–ç‚¹ï¼‰</h2>
        <div class="topics-filters">
          <label for="topicsDeptFilter">ç™ºç”Ÿéƒ¨ç½²</label>
          <select id="topicsDeptFilter">
            <option value="">å…¨ã¦</option>
          </select>
        </div>
        <div id="topicsOverdueBanner" class="overdue-banner" style="display:none;"></div>
        <div class="topics-row">
          <div class="topics-section today">
            <h3>ğŸ“… ä»Šæ—¥ã®å¤‰åŒ–ç‚¹</h3>
            <div id="topicsToday"></div>
          </div>

          <div class="topics-section">
            <h3>ğŸ—“ ä»Šé€±ã®å¤‰åŒ–ç‚¹</h3>
            <div id="topicsWeek"></div>
          </div>

          <div class="topics-section month">
            <h3>ğŸ“† ä»Šæœˆã®å¤‰åŒ–ç‚¹</h3>
            <div id="topicsMonth"></div>
          </div>

          <div class="topics-section undecided">
            <h3>âš ï¸ åˆ‡ã‚Šæ›¿ãˆæ—¥æœªç¢ºå®šã®å¤‰åŒ–ç‚¹</h3>
            <div id="topicsUndecided" class="topics-row two-columns"></div>
            <div class="hint" style="margin-top:8px;color:#666;">
              â€»ã€Œåˆ‡ã‚Šæ›¿ãˆæ—¥æœªç¢ºå®šã€= è£½é€ ãŒã€Œåˆ‡ã‚Šæ›¿ãˆæ—¥ã€ã‚’ã¾ã ç¢ºå®šã—ã¦ã„ãªã„è¨ˆç”»å¤‰åŒ–ç‚¹
            </div>
          </div>
        </div>
      </div>

      <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ -->

      <div class="menu-cards">
        <div class="menu-card" data-screen="timeline">
          <div class="icon">ğŸ“Š</div>
          <h3>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h3>
          <p>ç•°å¸¸ï¼‹å¤‰åŒ–ç‚¹ã‚’æ™‚ç³»åˆ—ã§ç¢ºèª</p>
        </div>
        <div class="menu-card" data-screen="planned">
          <div class="icon">ğŸ“</div>
          <h3>è¨ˆç”»å¤‰åŒ–ç‚¹å…¥åŠ›</h3>
          <p>å¤‰åŒ–ç‚¹æƒ…å ±ã‚’ç™»éŒ²</p>
        </div>
        <div class="menu-card" data-screen="calendar">
          <div class="icon">ğŸ“†</div>
          <h3>è¨ˆç”»å¤‰åŒ–ç‚¹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>
          <p>å¤‰åŒ–ç‚¹äºˆå®šã‚’ç¢ºèª</p>
        </div>
        <div class="menu-card" data-screen="master">
          <div class="icon">âš™ï¸</div>
          <h3>ç®¡ç†</h3>
          <p>éƒ¨ç½²ãƒ»ãƒ©ã‚¤ãƒ³ãªã©ã®ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”»é¢ -->
  <div id="timelineScreen" class="screen">
    <div class="app-header">
      <h1>ğŸ“Š ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h1>
      <div class="header-actions">
        <button class="btn-back" data-back>â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
        <button class="btn-logout" data-logout>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>
    <div class="container">
      <div class="card">
        <div class="filter-section">
          <div class="filter-group">
            <label>è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</label>
            <select id="filterMode">
              <option value="serial">æ•´ç†Noåˆ¥</option>
              <option value="line">ãƒ©ã‚¤ãƒ³åˆ¥</option>
            </select>
          </div>

          <div class="filter-group" id="serialFilterGroup">
            <label>æ•´ç†No</label>
            <input type="text" id="filterSerial" list="serialList" placeholder="å…¥åŠ›...">
            <datalist id="serialList"></datalist>
          </div>

          <div class="filter-group" id="lineFilterGroup" style="display:none;">
            <label>ãƒ©ã‚¤ãƒ³</label>
            <select id="filterLine"><option value="">é¸æŠ...</option></select>
          </div>

          <div class="filter-group">
            <label>æœŸé–“ï¼ˆé–‹å§‹ï¼‰</label>
            <input type="date" id="filterDateFrom">
          </div>
          <div class="filter-group">
            <label>æœŸé–“ï¼ˆçµ‚äº†ï¼‰</label>
            <input type="date" id="filterDateTo">
          </div>

          <div class="filter-group">
            <label>è¡¨ç¤ºã‚¿ã‚¤ãƒ—</label>
            <select id="filterType">
              <option value="all">ã™ã¹ã¦</option>
              <option value="anomaly">ç•°å¸¸ã®ã¿</option>
              <option value="sudden">çªç™ºå¤‰åŒ–ç‚¹ã®ã¿</option>
              <option value="planned">è¨ˆç”»å¤‰åŒ–ç‚¹ã®ã¿</option>
            </select>
          </div>

          <!-- âœ… ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰çµã‚Šè¾¼ã¿ -->
          <div class="filter-group" style="min-width:260px;">
            <label>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="text" id="filterKeyword" placeholder="">
          </div>

          <!-- âœ… è¿½åŠ ï¼šã‚½ãƒ¼ãƒˆé †åˆ‡ã‚Šæ›¿ãˆ -->
          <div class="filter-group">
            <label>ä¸¦ã³é †</label>
            <select id="sortOrder">
              <option value="desc" selected>é™é †ï¼ˆæ–°ã—ã„â†’å¤ã„ï¼‰</option>
            </select>
          </div>

          <button class="btn btn-primary" id="btnSearch">ğŸ” æ¤œç´¢</button>
        </div>
      </div>

      <div class="stats-row">
        <div class="stat-card"><div class="number" id="statTotal">0</div><div class="label">ç·ä»¶æ•°</div></div>
        <div class="stat-card anomaly"><div class="number" id="statAnomaly">0</div><div class="label">ç•°å¸¸</div></div>
        <div class="stat-card sudden"><div class="number" id="statSudden">0</div><div class="label">çªç™ºå¤‰åŒ–ç‚¹</div></div>
        <div class="stat-card planned"><div class="number" id="statPlanned">0</div><div class="label">è¨ˆç”»å¤‰åŒ–ç‚¹</div></div>
      </div>

      <!-- âœ… ã‚°ãƒ©ãƒ•ã‚«ãƒ¼ãƒ‰ï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‹0æ—¥ã‚‚è¡¨ç¤ºï¼‰ -->
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
          <h2 style="margin:0;font-size:1.05rem;color:#333;">ğŸ“ˆ ç•°å¸¸ãƒ»å¤‰åŒ–ç‚¹ æ¨ç§»</h2>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <span style="font-size:.85rem;color:#666;">é›†è¨ˆ</span>
            <select id="chartAgg" style="padding:8px 12px;border:2px solid #e0e0e0;border-radius:8px;">
              <option value="day" selected>æ—¥åˆ¥</option>
              <option value="week">é€±åˆ¥</option>
              <option value="month">æœˆåˆ¥</option>
            </select>
          </div>
        </div>

        <div class="chart-wrap" style="margin-top:12px;">
          <canvas id="timelineChart"></canvas>
        </div>

        <div id="timelineChartEmpty" class="empty-state" style="display:none;padding:20px 0;">
          <div class="icon">ğŸ“‰</div>
          <p>è¡¨ç¤ºã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
        </div>
      </div>

      <div class="card">
        <div id="timelineLoading" class="loading"><div class="spinner"></div><p>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</p></div>
        <div id="timelineEmpty" class="empty-state" style="display:none;"><div class="icon">ğŸ“­</div><p>æ¡ä»¶ã‚’æŒ‡å®šã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„</p></div>
        <div id="timelineView" class="timeline" style="display:none;"></div>
      </div>
    </div>
  </div>

  <!-- è¨ˆç”»å¤‰åŒ–ç‚¹å…¥åŠ›ç”»é¢ -->
  <div id="plannedScreen" class="screen">
    <div class="app-header">
      <h1>ğŸ“ è¨ˆç”»å¤‰åŒ–ç‚¹å…¥åŠ›</h1>
      <div class="header-actions">
        <button class="btn-back" data-back>â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
        <button class="btn-logout" data-logout>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>

    <div class="container" style="max-width:1400px;">
      <div class="card">
        <h2 style="margin-bottom:20px;color:#333;">è¨ˆç”»å¤‰åŒ–ç‚¹ã®ç™»éŒ²ï¼ˆchangepoints / type=plannedï¼‰</h2>

        <form id="plannedForm">
          <div class="form-row">
            <div class="form-group">
              <label>èµ·æ¡ˆéƒ¨ç½²<span class="required">*</span></label>
              <select id="planDepartment" required><option value="">é¸æŠã—ã¦ãã ã•ã„</option></select>
              <div class="hint">ä¿å­˜å…ˆ:planneddepartment</div>
            </div>
            <div class="form-group">
              <label>å¤‰åŒ–ç‚¹åˆ†é¡<span class="required">*</span></label>
              <select id="planCategory" required>
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option value="äºº">äºº</option>
                <option value="æ–¹æ³•">æ–¹æ³•</option>
                <option value="ææ–™">ææ–™</option>
                <option value="é‡‘å‹">é‡‘å‹</option>
                <option value="è¨­å‚™">è¨­å‚™</option>
                <option value="ãã®ä»–">ãã®ä»–</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>å¤‰åŒ–ç‚¹ç™ºç”Ÿéƒ¨ç½²<span class="required">*</span></label>
              <select id="planDepartmentOccur" required><option value="">é¸æŠã—ã¦ãã ã•ã„</option></select>
              <div class="hint">ä¿å­˜å…ˆ:department</div>
            </div>
            <div class="form-group">
              <label>å¯¾è±¡ãƒ©ã‚¤ãƒ³å<span class="required">*</span></label>
              <input type="text" id="planLineName" list="lineList2" required placeholder="ä¾‹: 94-300 / RL1 ãªã©">
              <datalist id="lineList2"></datalist>
              <div class="hint">ä¿å­˜å…ˆ:lineName</div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>å¯¾è±¡æ•´ç†No</label>
              <input type="text" id="planSerialNo" list="serialList2" placeholder="ä¾‹: 6769">
              <datalist id="serialList2"></datalist>
              <div class="hint">ä¿å­˜å…ˆ:serialNo</div>
            </div>
            <div class="form-group">
              <label>åˆ‡æ›¿ãˆæ—¥ï¼ˆä»»æ„ï¼‰</label>
              <input type="date" id="planDate">
              <div class="hint">ä¿å­˜å…ˆ:occurrenceDateï¼ˆåˆ‡æ›¿ãˆæ—¥ï¼‰</div>
            </div>
          </div>

          <div class="form-group">
            <label>å¤‰åŒ–ç‚¹å†…å®¹<span class="required">*</span></label>
            <textarea id="planContent" required placeholder="å¤‰åŒ–ç‚¹ã®è©³ç´°å†…å®¹ã‚’å…¥åŠ›..."></textarea>
          </div>


          <!-- é–¢é€£è³‡æ–™ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
          <div class="form-group">
            <label>ğŸ“ é–¢é€£è³‡æ–™ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆ5MBã¾ã§ï¼‰</label>
            <div class="file-upload-area" id="fileUploadArea">
              <input type="file" id="planDocumentFile" accept="*/*" style="display:none;">
              <div>ğŸ“ ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
              <div style="font-size:.8rem;color:#888;margin-top:8px;">å¯¾å¿œå½¢å¼: PDF, ç”»åƒ, Excel, Word ãªã©ï¼ˆæœ€å¤§5MBï¼‰</div>
            </div>
            <div id="filePreview" style="display:none;"></div>
            <div id="uploadProgress" style="display:none;margin-top:10px;height:6px;background:#e0e0e0;border-radius:3px;overflow:hidden;">
              <div id="uploadProgressBar" style="height:100%;background:linear-gradient(135deg, #667eea, #764ba2);width:0%;transition:width .3s;"></div>
            </div>
            <div class="hint">ä¿å­˜å…ˆï¼šdocumentUrlï¼ˆStorageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰</div>
          </div>

          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <button type="button" id="btnRegisterPlanned" class="btn btn-primary" style="flex:1;min-width:140px;padding:14px;font-size:1.05rem;">
              ğŸ“¤ ç™»éŒ²ã™ã‚‹
            </button>
            <button type="button" id="btnExportLastPlannedCSV" class="btn btn-secondary btn-disabled" style="flex:1;min-width:120px;padding:14px;font-size:1.05rem;">
              â¬‡ CSVå‡ºåŠ›
            </button>
            <button type="button" id="btnExportLastPlannedQR" class="btn btn-secondary btn-disabled" style="flex:1;min-width:120px;padding:14px;font-size:1.05rem;">
              ğŸ“± QRå‡ºåŠ›
            </button>
          </div>
          <div class="hint" style="margin-top:8px;">
            â€»ã€ŒCSVå‡ºåŠ›ã€ã€ŒQRå‡ºåŠ›ã€ã¯ã€æœ€å¾Œã«ç™»éŒ²ã—ãŸè¨ˆç”»å¤‰åŒ–ç‚¹ã®å†…å®¹ã‚’å‡ºåŠ›ã—ã¾ã™ï¼ˆç™»éŒ²ç›´å¾Œã«åˆ‡æ›¿ãˆæ—¥ã‚’ç¢ºå®šã—ã€å¾Œã§å®Œäº†ç™»éŒ²ã§ãã¾ã™ï¼‰
          </div>
        </form>

        <div style="margin-top:30px;">
          <h3 style="font-size:1rem;color:#333;margin-bottom:16px;">ğŸ“‹ æœ€è¿‘ã®è¨ˆç”»å¤‰åŒ–ç‚¹</h3>
          <div id="plannedHistory"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”»é¢ -->
  <div id="calendarScreen" class="screen">
    <div class="app-header">
      <h1>ğŸ“† è¨ˆç”»å¤‰åŒ–ç‚¹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
      <div class="header-actions">
        <button class="btn-back" data-back>â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
        <button class="btn-logout" data-logout>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>
    <div class="container" style="max-width:100%; padding:10px;">
      <div class="card">
        <div class="filter-section">
          <div class="filter-group">
            <label>ç™ºç”Ÿéƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
            <select id="calendarDeptFilter">
              <option value="">ã™ã¹ã¦ã®éƒ¨ç½²</option>
            </select>
          </div>
          <div class="filter-group">
            <label>åˆ†é¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
            <select id="calendarCatFilter">
              <option value="">ã™ã¹ã¦ã®åˆ†é¡</option>
              <option value="äºº">äºº</option>
              <option value="æ–¹æ³•">æ–¹æ³•</option>
              <option value="ææ–™">ææ–™</option>
              <option value="é‡‘å‹">é‡‘å‹</option>
              <option value="è¨­å‚™">è¨­å‚™</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
          </div>
        </div>

        <div class="calendar-header">
          <div class="calendar-nav">
            <button id="calPrev">â—€ å‰æœˆ</button>
            <div class="month-year" id="calMonthYear"></div>
            <button id="calNext">æ¬¡æœˆ â–¶</button>
          </div>
          <button class="btn btn-secondary" id="calToday">ä»Šæœˆ</button>
        </div>

        <div class="calendar-grid" id="calendarGrid"></div>
      </div>
    </div>
  </div>

  <!-- ç®¡ç†ç”»é¢ -->
  <div id="masterScreen" class="screen">
    <div class="app-header">
      <h1>âš™ï¸ ãƒã‚¹ã‚¿ç®¡ç†</h1>
      <div class="header-actions">
        <button class="btn-back" data-back>â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
        <button class="btn-logout" data-logout>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>
    <div class="container" style="max-width:800px;">
      <div class="card">
        <div class="master-tabs">
          <button class="master-tab active" data-tab="department">éƒ¨ç½²</button>
          <button class="master-tab" data-tab="line">ãƒ©ã‚¤ãƒ³</button>
        </div>
        <div id="masterDepartment" class="master-content">
          <div class="master-add">
            <input type="text" id="addDeptName" placeholder="æ–°ã—ã„éƒ¨ç½²åã‚’å…¥åŠ›...">
            <button class="btn btn-primary" id="btnAddDept">è¿½åŠ </button>
          </div>
          <table class="master-table">
            <thead><tr><th>éƒ¨ç½²å</th><th style="width:120px;">æ“ä½œ</th></tr></thead>
            <tbody id="deptTableBody"></tbody>
          </table>
        </div>
        <div id="masterLine" class="master-content" style="display:none;">
          <div class="master-add">
            <input type="text" id="addLineName" placeholder="æ–°ã—ã„ãƒ©ã‚¤ãƒ³åã‚’å…¥åŠ›...">
            <button class="btn btn-primary" id="btnAddLine">è¿½åŠ </button>
          </div>
          <table class="master-table">
            <thead><tr><th>ãƒ©ã‚¤ãƒ³å</th><th style="width:120px;">æ“ä½œ</th></tr></thead>
            <tbody id="lineTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h3 id="detailTitle">è©³ç´°æƒ…å ±</h3>
          <div id="detailDate" style="font-size:.9rem;color:#666;margin-top:4px;"></div>
        </div>
        <button class="modal-close" id="detailClose">&times;</button>
      </div>
      <div class="modal-badges" id="detailBadges"></div>
      <div class="modal-body" id="detailBody"></div>
      <div id="detailActions" class="modal-actions" style="display:none;padding:16px 24px;border-top:1px solid #e0e0e0;gap:12px;flex-direction:column;">
        <!-- è£½é€ ï¼šåˆ‡æ›¿ãˆãƒ•ãƒ­ãƒ¼ -->
        <div id="switchFlowGuide" class="switch-flow-guide" style="display:none;">
          <div class="switch-flow-title">ğŸ§­ è£½é€ ï¼šåˆ‡æ›¿ãˆãƒ•ãƒ­ãƒ¼</div>
          <div class="switch-flow-steps">
            <div class="step" data-step="1"><span class="n">â‘ </span><span class="t">æœªç¢ºå®š</span></div>
            <div class="arrow">â†’</div>
            <div class="step" data-step="2"><span class="n">â‘¡</span><span class="t">åˆ‡æ›¿ãˆæ—¥æ±ºå®š</span></div>
            <div class="arrow">â†’</div>
            <div class="step" data-step="3"><span class="n">â‘¢</span><span class="t">åˆ‡æ›¿ãˆå®Ÿæ–½</span></div>
          </div>
          <div class="switch-flow-status" id="switchFlowStatusText"></div>
        </div>

        <!-- è£½é€ ï¼šåˆ‡æ›¿ãˆãƒ•ãƒ­ãƒ¼ -->
        <div id="switchDecisionBox" style="width:100%;display:none;flex-direction:column;gap:10px;">
          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;">
            <div style="flex:1;min-width:200px;">
              <label style="display:block;font-size:.85rem;color:#666;font-weight:600;margin-bottom:6px;">åˆ‡æ›¿ãˆæ—¥</label>
              <input type="date" id="switchDateInput" style="width:100%;padding:10px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:1rem;">
              <div style="font-size:.8rem;color:#888;margin-top:6px;">â€»ã€Œä»Šæ—¥ã§æ±ºå®šã€ã¾ãŸã¯ã€ŒæŒ‡å®šæ—¥ã§æ±ºå®šã€ã§åˆ‡æ›¿ãˆæ—¥ã‚’ç¢ºå®šã—ã¾ã™</div>
            </div>
            <button class="btn" id="btnSwitchToday" style="background:#1565c0;color:#fff;">ğŸ“… ä»Šæ—¥ã§æ±ºå®š</button>
            <button class="btn" id="btnSwitchDecide" style="background:#0b7a3b;color:#fff;">ğŸ—“ æŒ‡å®šæ—¥ã§æ±ºå®š</button>
          </div>
        </div>

        <div id="switchAfterDecisionBox" style="width:100%;display:none;flex-direction:column;gap:10px;">
          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
            <div id="switchStatusHint" style="flex:1;min-width:220px;background:#f8f9fa;border-radius:10px;padding:10px 12px;color:#333;font-size:.9rem;"></div>
            <button class="btn" id="btnSwitchComplete" style="background:#2e7d32;color:#fff;">âœ… åˆ‡æ›¿ãˆå®Œäº†</button>
            <button class="btn" id="btnSwitchPostpone" style="background:#ef6c00;color:#fff;">â© å»¶æœŸ</button>
            <button class="btn" id="btnSwitchCancel" style="background:#c62828;color:#fff;">â›” ä¸­æ­¢</button>
          </div>
          <div style="font-size:.8rem;color:#888;">â€»åˆ‡æ›¿ãˆå¾Œã«ã€Œå®Œäº†ã€ã€‚å»¶æœŸ/ä¸­æ­¢ã‚‚ã“ã“ã§ç¢ºå®šã—ã¾ã™ã€‚</div>
        </div>

        <!-- å…±é€šæ“ä½œ -->
        <div style="display:flex;gap:12px;width:100%;flex-wrap:wrap;">
          <button class="btn btn-primary" id="btnDetailEdit" style="flex:1;min-width:160px;">âœï¸ ç·¨é›†</button>
          <button class="btn" id="btnDetailDelete" style="flex:1;min-width:160px;background:#e53935;color:#fff;">ğŸ—‘ï¸ å‰Šé™¤</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="editModal" class="modal">
    <div class="modal-content" style="max-width:700px;">
      <div class="modal-header">
        <h3>âœï¸ å¤‰åŒ–ç‚¹ã®ç·¨é›†</h3>
        <button class="modal-close" id="editClose">&times;</button>
      </div>
      <div class="modal-body" id="editFormContainer" style="padding:24px;"></div>
      <div style="padding:16px 24px;border-top:1px solid #e0e0e0;display:flex;gap:12px;">
        <button class="btn btn-primary" id="btnEditSave" style="flex:1;">ğŸ’¾ ä¿å­˜</button>
        <button class="btn btn-secondary" id="btnEditCancel" style="flex:1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- QRã‚³ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="qrModal" class="modal">
    <div class="modal-content" style="max-width:400px;text-align:center;">
      <div class="modal-header">
        <h3>ğŸ“± QRã‚³ãƒ¼ãƒ‰</h3>
        <button class="modal-close" id="qrClose">&times;</button>
      </div>
      <div style="padding:30px;display:flex;flex-direction:column;align-items:center;gap:16px;">
        <div id="qrCanvas" style="background:#fff;padding:10px;border-radius:8px;"></div>
        <div id="qrUrl" style="font-size:.8rem;color:#666;word-break:break-all;background:#f5f5f5;padding:10px;border-radius:6px;width:100%;"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;">
          <button class="btn btn-primary" id="btnDownloadQR">ğŸ’¾ QRç”»åƒã‚’ä¿å­˜</button>
          <button class="btn btn-secondary" id="btnCopyUrl">ğŸ“‹ URLã‚’ã‚³ãƒ”ãƒ¼</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <div id="confirmModal" class="confirm-modal">
    <div class="confirm-modal-content">
      <div class="confirm-modal-header">ç™»éŒ²å†…å®¹ã®ç¢ºèªï¼ˆãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãä½œæˆï¼‰</div>

      <div class="confirm-modal-body">
        <!-- ç™»éŒ²å†…å®¹ -->
        <div id="confirmContent"></div>

        <div class="confirm-modal-buttons">
        <button class="confirm-btn confirm-btn-cancel" id="btnConfirmCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="confirm-btn confirm-btn-confirm" id="btnConfirmOk">ç™»éŒ²ã—ã¦Outlookã‚’é–‹ã</button>
      </div>
    </div>
  </div>

  <!-- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
    import {
      getFirestore, collection, doc, getDocs, addDoc, deleteDoc, updateDoc,
      query, orderBy, onSnapshot, serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
    import {
      getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut,
      setPersistence, browserLocalPersistence
    } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
    import {
      getStorage, ref, uploadBytesResumable, getDownloadURL
    } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyA0YUIpIDh4WB4p1ewiNB0XfwHve0ByljU",
      authDomain: "abnreport-fd733.firebaseapp.com",
      databaseURL: "https://abnreport-fd733-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "abnreport-fd733",
      storageBucket: "abnreport-fd733.firebasestorage.app",
      messagingSenderId: "349748947315",
      appId: "1:349748947315:web:010cb671d2a95bcf1f7d06"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // State
    let anomalyData = [];       // anomalies
    let changepointData = [];   // changepoints (planned + sudden)
    let filteredData = [];

    let masterDepartments = [];
    let masterLines = [];
    let deptDocs = [];
    let lineDocs = [];

    let calendarYear, calendarMonth;

    // CSV export stateï¼ˆæœ€å¾Œã«ç™»éŒ²ã—ãŸè¨ˆç”»å¤‰åŒ–ç‚¹ï¼‰
    let lastRegisteredPlanned = null;
    let lastDetailHtmlUrl = null;
    let selectedFile = null;

    // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒãƒ£ãƒ¼ãƒˆ
    let timelineChart = null;

    // CSV columns (planned changepoint)
    const PLANNED_CP_CSV_HEADERS = [
      { key: 'docId',             label: 'DocID' },
      { key: 'type',              label: 'ç¨®åˆ¥' },
      { key: 'category',          label: 'åˆ†é¡' },
      { key: 'planneddepartment', label: 'èµ·æ¡ˆéƒ¨ç½²' },
      { key: 'department',        label: 'ç™ºç”Ÿéƒ¨ç½²' },
      { key: 'lineName',          label: 'ãƒ©ã‚¤ãƒ³å' },
      { key: 'serialNo',          label: 'æ•´ç†No' },
      { key: 'occurrenceDate',    label: 'ç™ºç”Ÿæ—¥' },
      { key: 'occurrenceTime',    label: 'æ™‚åˆ»' },
      { key: 'lot',               label: 'å¯¾è±¡ãƒ­ãƒƒãƒˆ' },
      { key: 'document',          label: 'é–¢é€£è³‡æ–™' },
      { key: 'documentUrl',       label: 'è³‡æ–™URL' },
      { key: 'content',           label: 'å†…å®¹' },
      { key: 'createdAtLocal',    label: 'ç™»éŒ²æ—¥æ™‚(ç«¯æœ«)' }
    ];

    // DOM
    const gate = document.getElementById('authGate');
    const mainMenu = document.getElementById('mainMenu');
    const screens = {
      timeline: document.getElementById('timelineScreen'),
      planned: document.getElementById('plannedScreen'),
      calendar: document.getElementById('calendarScreen'),
      master: document.getElementById('masterScreen')
    };

    // Helpers
    function ymdLocal(dateObj){
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth()+1).padStart(2,'0');
      const d = String(dateObj.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    function escapeHtml(text){
      if (text === null || text === undefined) return '';
      return String(text)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;').replace(/'/g,'&#039;')
        .replace(/\n/g,'<br>');
    }
    function escapeAttr(text){
      if (text === null || text === undefined) return '';
      return String(text).replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // CSV utilities
    function csvEscape(v){
      if (v === null || v === undefined) return '';
      const s = String(v);
      if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
      return s;
    }
    function downloadCSV(filename, headers, rowObj){
      const bom = '\uFEFF'; // Excelæ–‡å­—åŒ–ã‘å¯¾ç­–
      const headerLine = headers.map(h => csvEscape(h.label)).join(',');
      const valueLine  = headers.map(h => csvEscape(rowObj[h.key])).join(',');
      const csv = bom + headerLine + '\n' + valueLine + '\n';

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url  = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }
    function safeFilenamePart(s){
      return String(s || '').replace(/[\\\/:*?"<>|]/g,'_');
    }

    function setExportButtonEnabled(enabled){
      const btnCSV = document.getElementById('btnExportLastPlannedCSV');
      const btnQR = document.getElementById('btnExportLastPlannedQR');
      if (btnCSV) {
        btnCSV.disabled = !enabled;
        btnCSV.classList.toggle('btn-disabled', !enabled);
      }
      if (btnQR) {
        btnQR.disabled = !enabled;
        btnQR.classList.toggle('btn-disabled', !enabled);
      }
    }

    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ­£è¦åŒ–
    function normText(s){
      return String(s || '').toLowerCase().trim();
    }

    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒåˆ¤å®šï¼ˆç•°å¸¸/å¤‰åŒ–ç‚¹ã®ä¸»è¦é …ç›®ã‚’æ¨ªæ–­ï¼‰
    function matchesKeyword(item, keyword){
      const kw = normText(keyword);
      if (!kw) return true;

      let hay = '';
      if (item._kind === 'anomaly'){
        hay = [
          item.serialNo, item.lineName, item.department, item.handler,
          item.occurrenceDate, item.occurrenceTime,
          item.anomalyContent, item.actionTaken, item.rootCauseAction
        ].join(' ');
      } else {
        hay = [
          item.type, item.category, item.planneddepartment, item.department,
          item.lineName, item.serialNo,
          item.occurrenceDate, item.occurrenceTime,
          item.lot, item.document, item.content,
          item.relatedAnomalyId
        ].join(' ');
      }
      return normText(hay).includes(kw);
    }

    // æ˜‡é †/é™é † ä¸¡å¯¾å¿œï¼šç•°å¸¸â†’ç´ã¥ãå¤‰åŒ–ç‚¹ã‚’ç›´å¾Œã«å¯„ã›ã‚‹ï¼ˆä¸¦ã³é †ã‚’ç¶­æŒï¼‰
  // âœ… ä¿®æ­£ï¼šç•°å¸¸ã«ç´ã¥ãå¤‰åŒ–ç‚¹ã¯ã€Œå¿…ãš ç•°å¸¸ â‡’ å¤‰åŒ–ç‚¹ã€ã«ãªã‚‹ã‚ˆã†ã«ä¸¦ã¹æ›¿ãˆ
// æ˜‡é †/é™é † ä¸¡å¯¾å¿œï¼šç•°å¸¸ã¨ç´ã¥ãå¤‰åŒ–ç‚¹ã¯ã€ŒåŒã˜å¡Šã€ã«ã¾ã¨ã‚ã¤ã¤ã€å¡Šã®ä¸­ã¯æ™‚ç³»åˆ—ï¼ˆsortOrderï¼‰ã‚’å„ªå…ˆ
// ï¼é™é †ã§ã‚‚ã€Œæ–°ã—ã„ã‚‚ã®ãŒä¸Šã€ã«ä¸¦ã³ã€é€†è»¢ã—ãªã„
// æ˜‡é †/é™é † ä¸¡å¯¾å¿œï¼šç•°å¸¸ã¨ç´ã¥ãå¤‰åŒ–ç‚¹ã¯ã€Œå¿…ãš ç•°å¸¸ â‡’ å¤‰åŒ–ç‚¹ã€
// ã‹ã¤ã€é™é †/æ˜‡é †ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã‚‚ã€Œå¡Šï¼ˆç•°å¸¸ï¼‹ç´ã¥ãCPï¼‰ã€ã¯ç•°å¸¸ã®æ™‚åˆ»ã‚’åŸºæº–ã«ä¸¦ã¶ï¼ˆCPã®æ™‚åˆ»ã§ã¯å¡Šé †ã‚’å´©ã•ãªã„ï¼‰
// é€†ãƒ­ã‚¸ãƒƒã‚¯ç‰ˆï¼šæœ€åˆã«ã€Œç•°å¸¸ãƒ–ãƒ­ãƒƒã‚¯ã€ã‚’ä½œã£ã¦ã‹ã‚‰ã€ãƒ–ãƒ­ãƒƒã‚¯å˜ä½ã§ä¸¦ã¹æ›¿ãˆã‚‹ã€‚
// - ç´ã¥ãå¤‰åŒ–ç‚¹ã¯å¿…ãšã€Œç•°å¸¸ â‡’ å¤‰åŒ–ç‚¹ã€
// - ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸¦ã³é †ã¯ã€Œç•°å¸¸ã®æ—¥æ™‚ã€ã ã‘ã§æ±ºã‚ã‚‹ï¼ˆå¤‰åŒ–ç‚¹ã®æ—¥æ™‚ã§ãƒ–ãƒ­ãƒƒã‚¯ãŒå‰å¾Œã—ãªã„ï¼‰
// - ç´ã¥ã‹ãªã„å¤‰åŒ–ç‚¹ã¯å˜ç‹¬ã‚¢ã‚¤ãƒ†ãƒ ã¨ã—ã¦æ™‚ç³»åˆ—é †ã«ä¸¦ã¶
// é™é †å›ºå®šï¼ˆæ˜‡é †å»ƒæ­¢ï¼‰
// ä»•æ§˜ï¼šç´ã¥ãã‚‚ã®ã¯ã€Œå¤‰åŒ–ç‚¹ â‡’ ç•°å¸¸ã€ã®é †ã§å¿…ãšä¸¦ã¹ã‚‹ï¼ˆå¤‰åŒ–ç‚¹ãŒä¸Šã€ç•°å¸¸ãŒä¸‹ï¼‰
// ã‹ã¤ã€å…¨ä½“ã®ä¸¦ã³ã¯ã€Œãƒ–ãƒ­ãƒƒã‚¯å†…ã§æœ€ã‚‚æ–°ã—ã„æ—¥æ™‚ã€ã‚’åŸºæº–ã«é™é †ã«ã™ã‚‹
function reorderLinkedTimelineItems(items){
  const timeKey = (it) => `${it.sortDate || ''}T${it.sortTime || ''}`;

  const cmpDesc = (a,b) => timeKey(b).localeCompare(timeKey(a)); // æ–°ã—ã„â†’å¤ã„

  // anomalies ã‚’è¾æ›¸åŒ–ï¼ˆä»Šå›ã®æ¤œç´¢çµæœã«å­˜åœ¨ã™ã‚‹ç•°å¸¸ã®ã¿ãƒ–ãƒ­ãƒƒã‚¯åŒ–å¯¾è±¡ï¼‰
  const anomalies = new Map(); // id -> anomaly
  for (const it of items){
    if (it._kind === 'anomaly') anomalies.set(it._id, it);
  }

  // ç•°å¸¸ã”ã¨ã® linked CP ã‚’æŸã­ã‚‹
  const blocks = new Map(); // anomalyId -> { anomaly, cps:[], key:'' }
  for (const [aid, a] of anomalies.entries()){
    blocks.set(aid, { anomaly: a, cps: [], key: timeKey(a) });
  }

  const standalone = []; // ç´ã¥ã‹ãªã„CPï¼ˆã¾ãŸã¯ç•°å¸¸ãŒæ¤œç´¢çµæœã«å«ã¾ã‚Œãªã„ linkedCPï¼‰

  for (const it of items){
    if (it._kind !== 'changepoint') continue;
    const rel = (it.relatedAnomalyId || '').trim();
    if (rel && blocks.has(rel)){
      blocks.get(rel).cps.push(it);
    } else {
      standalone.push(it);
    }
  }

  // ãƒ–ãƒ­ãƒƒã‚¯å†…ï¼šCPã‚’é™é †ã«ã—ã¦ã‹ã‚‰ã€æœ€å¾Œã«ç•°å¸¸ã‚’ç½®ã
  const elements = []; // {type:'block'|'single', key, ...}
  for (const [aid, b] of blocks.entries()){
    b.cps.sort(cmpDesc);

    // ãƒ–ãƒ­ãƒƒã‚¯keyã¯ã€Œãƒ–ãƒ­ãƒƒã‚¯å†…ã§æœ€ã‚‚æ–°ã—ã„æ—¥æ™‚ã€ï¼ˆCPãŒæ–°ã—ã‘ã‚Œã°ãã‚ŒãŒã‚­ãƒ¼ã«ãªã‚‹ï¼‰
    let newest = b.key;
    for (const cp of b.cps){
      const k = timeKey(cp);
      if (k > newest) newest = k;
    }
    b.key = newest;

    elements.push({ _type:'block', key: b.key, block: b });
  }

  for (const cp of standalone){
    elements.push({ _type:'single', key: timeKey(cp), item: cp });
  }

  // è¦ç´ ã‚’é™é †ã‚½ãƒ¼ãƒˆã€‚åŒæ—¥æ™‚ãªã‚‰ block ã‚’å…ˆã«ï¼ˆCPâ‡’ç•°å¸¸ã®ä¸¦ã³ãŒç›®ã«ã¤ãï¼‰
  elements.sort((A,B) => {
    const d = B.key.localeCompare(A.key);
    if (d !== 0) return d;
    if (A._type === B._type) return 0;
    return (A._type === 'block') ? -1 : 1;
  });

  // å±•é–‹ï¼šblockã¯ [CPs..., anomaly] ã®é †
  const out = [];
  for (const el of elements){
    if (el._type === 'single'){
      out.push(el.item);
    } else {
      for (const cp of el.block.cps) out.push(cp);
      out.push(el.block.anomaly);
    }
  }

  return out;
}


    // ====== ã‚°ãƒ©ãƒ•ç”¨ï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‹0æœŸé–“ã‚‚è¡¨ç¤ºï¼‰ ======
    function parseYMD(ymd){
      if (!ymd) return null;
      const d = new Date(ymd + 'T00:00:00');
      return Number.isNaN(d.getTime()) ? null : d;
    }
    function clampStartEnd(fromStr, toStr, fallbackMinStr, fallbackMaxStr){
      const from = parseYMD(fromStr) || parseYMD(fallbackMinStr);
      const to   = parseYMD(toStr)   || parseYMD(fallbackMaxStr);
      if (!from || !to) return { from:null, to:null };
      if (from.getTime() <= to.getTime()) return { from, to };
      return { from: to, to: from }; // é€†ãªã‚‰å…¥ã‚Œæ›¿ãˆ
    }
    function addDays(d, n){
      const x = new Date(d);
      x.setDate(x.getDate() + n);
      return x;
    }
    function monthStart(d){
      return new Date(d.getFullYear(), d.getMonth(), 1);
    }
    function addMonths(d, n){
      return new Date(d.getFullYear(), d.getMonth() + n, 1);
    }

    // ISO week helpers
    function isoWeekKeyFromDateObj(dateObj){
      // dateObj: local date
      const d = new Date(dateObj);
      d.setHours(0,0,0,0);

      // Thursday in current week decides the year
      const day = (d.getDay() + 6) % 7; // Mon=0..Sun=6
      d.setDate(d.getDate() - day + 3);

      const firstThu = new Date(d.getFullYear(), 0, 4);
      const firstDay = (firstThu.getDay() + 6) % 7;
      firstThu.setDate(firstThu.getDate() - firstDay + 3);

      const weekNo = 1 + Math.round((d - firstThu) / (7 * 24 * 3600 * 1000));
      return `${d.getFullYear()}-W${String(weekNo).padStart(2,'0')}`;
    }
    function isoWeekStart(dateObj){
      const d = new Date(dateObj);
      d.setHours(0,0,0,0);
      const day = (d.getDay() + 6) % 7; // Mon=0
      d.setDate(d.getDate() - day); // Monday
      return d;
    }
    function monthKeyFromDateObj(dateObj){
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth()+1).padStart(2,'0');
      return `${y}-${m}`;
    }

    function buildAggKey(dateStr, agg){
      if (!dateStr) return '';
      if (agg === 'month') return String(dateStr).slice(0,7);
      if (agg === 'week')  return isoWeekKeyFromDateObj(parseYMD(dateStr));
      return dateStr; // day
    }

    // âœ… å¤‰æ›´ï¼šã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’é›†è¨ˆã—ã¦ã€Œ3æœ¬ä¸¦ã¶æ£’ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—æ£’ï¼‰ã€ã§æç”»
let currentSortOrder = 'desc'; // â† è¿½åŠ ï¼ˆæ¤œç´¢æ™‚ã«æ›´æ–°ï¼‰

function renderTimelineChart(){
  const canvas = document.getElementById('timelineChart');
  const emptyEl = document.getElementById('timelineChartEmpty');
  if (!canvas) return;

  if (timelineChart){
    timelineChart.destroy();
    timelineChart = null;
  }

  if (!filteredData || filteredData.length === 0){
    canvas.style.display = 'none';
    if (emptyEl) emptyEl.style.display = 'block';
    return;
  }

  const agg = document.getElementById('chartAgg')?.value || 'day';

  const map = new Map(); // key -> { anomaly, sudden, planned }
  for (const it of filteredData){
    const key = buildAggKey(it.sortDate, agg);
    if (!key) continue;
    if (!map.has(key)) map.set(key, { anomaly: 0, sudden: 0, planned: 0 });
    const row = map.get(key);

    if (it._kind === 'anomaly') row.anomaly++;
    else if (it._kind === 'changepoint' && it.type === 'sudden') row.sudden++;
    else if (it._kind === 'changepoint' && it.type === 'planned') row.planned++;
  }

  let labels = Array.from(map.keys()).sort((a,b)=>a.localeCompare(b)); // âœ… ã‚°ãƒ©ãƒ•ã¯å¸¸ã«æ™‚é–“æ˜‡é †ï¼ˆå·¦â†’å³ï¼‰å›ºå®š


  const anomaly = labels.map(k => map.get(k).anomaly);
  const sudden  = labels.map(k => map.get(k).sudden);
  const planned = labels.map(k => map.get(k).planned);

  const hasAny = anomaly.some(v=>v>0) || sudden.some(v=>v>0) || planned.some(v=>v>0);
  if (!hasAny){
    canvas.style.display = 'none';
    if (emptyEl) emptyEl.style.display = 'block';
    return;
  }

  canvas.style.display = 'block';
  if (emptyEl) emptyEl.style.display = 'none';

  const maxY = Math.max(...anomaly, ...sudden, ...planned, 1);
  const suggestedMax = Math.max(3, maxY + 1);

  const ctx = canvas.getContext('2d');
  timelineChart = new Chart(ctx, {
    type: 'bar', // âœ… line â†’ bar
    data: {
      labels,
      datasets: [
        { label:'ç•°å¸¸',       data: anomaly, borderWidth: 1, barPercentage: 0.9, categoryPercentage: 0.7 },
        { label:'çªç™ºå¤‰åŒ–ç‚¹', data: sudden,  borderWidth: 1, barPercentage: 0.9, categoryPercentage: 0.7 },
        { label:'è¨ˆç”»å¤‰åŒ–ç‚¹', data: planned, borderWidth: 1, barPercentage: 0.9, categoryPercentage: 0.7 },
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top' },
        tooltip: { enabled: true }
      },
      scales: {
        x: { stacked: false },
        y: { stacked: false, beginAtZero: true, suggestedMax, ticks: { precision: 0 } }
      }
    }
  });
}

    // Auth
    document.getElementById('authLoginBtn').addEventListener('click', async () => {
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;
      try{
        await setPersistence(auth, browserLocalPersistence);
        await signInWithEmailAndPassword(auth, email, password);
      }catch(e){
        document.getElementById('authMsg').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ' + (e.code || e.message);
      }
    });

    document.getElementById('signOutBtn').addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, (user) => {
      if (user){
        gate.style.display = 'none';
        mainMenu.style.display = 'block';
        document.getElementById('signOutBtn').style.display = 'inline-block';
        initApp();
      } else {
        gate.style.display = 'flex';
        mainMenu.style.display = 'none';
        Object.values(screens).forEach(s => s.style.display = 'none');
        document.getElementById('signOutBtn').style.display = 'none';
      }
    });

    // Screen Navigation
    function showScreen(screen){
      mainMenu.style.display = (screen === 'menu') ? 'block' : 'none';
      Object.entries(screens).forEach(([key, el]) => {
        el.style.display = (key === screen) ? 'block' : 'none';
      });
      }


    document.querySelectorAll('.menu-card').forEach(card => {
      card.addEventListener('click', () => {
        const screen = card.dataset.screen;
        showScreen(screen);
        if (screen === 'timeline'){
          document.getElementById('timelineLoading').style.display = 'none';
          document.getElementById('timelineEmpty').style.display = 'block';
          // ã‚°ãƒ©ãƒ•ã¯æ¤œç´¢å¾Œã«æç”»
        } else if (screen === 'calendar'){
          renderCalendar();
        } else if (screen === 'master'){
          renderMasterTables();
        }
      });
    });

    document.querySelectorAll('[data-back]').forEach(btn => {
      btn.addEventListener('click', () => showScreen('menu'));
    });

    document.querySelectorAll('[data-logout]').forEach(btn => {
      btn.addEventListener('click', () => signOut(auth));
    });

    // Init
    async function initApp(){
      const now = new Date();
      calendarYear = now.getFullYear();
      calendarMonth = now.getMonth();

      await loadMasters();
      setupListeners();
      setupPlannedForm();
      setupFileUpload();
      setupQRModal();
      setupCalendar();
      setupMasterTabs();
      setupFilterMode();

      document.getElementById('planDate').value = '';

      setExportButtonEnabled(false);

      // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰Enterã§æ¤œç´¢
      const kwEl = document.getElementById('filterKeyword');
      if (kwEl){
        kwEl.addEventListener('keydown', (e) => {
          if (e.key === 'Enter'){
            e.preventDefault();
            document.getElementById('btnSearch').click();
          }
        });
      }

      // é›†è¨ˆå˜ä½å¤‰æ›´ã§å†æç”»ï¼ˆæ¤œç´¢çµæœã«å¯¾ã—ã¦ï¼‰
      const aggSel = document.getElementById('chartAgg');
      if (aggSel){
        aggSel.addEventListener('change', () => renderTimelineChart());
      }
    }

    // Masters
    async function loadMasters(){
      try{
        const [deptSnap, lineSnap] = await Promise.all([
          getDocs(collection(db, 'masters', 'department', 'items')),
          getDocs(collection(db, 'masters', 'line', 'items'))
        ]);

        deptDocs = deptSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        lineDocs = lineSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        masterDepartments = deptDocs.map(d => d.name).filter(Boolean).sort();
        masterLines = lineDocs.map(d => d.name).filter(Boolean).sort();

        document.getElementById('filterLine').innerHTML =
          '<option value="">é¸æŠ...</option>' +
          masterLines.map(l => `<option value="${escapeAttr(l)}">${escapeHtml(l)}</option>`).join('');

        document.getElementById('planDepartment').innerHTML =
          '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
          masterDepartments.map(d => `<option value="${escapeAttr(d)}">${escapeHtml(d)}</option>`).join('');

        document.getElementById('planDepartmentOccur').innerHTML =
          '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
          masterDepartments.map(d => `<option value="${escapeAttr(d)}">${escapeHtml(d)}</option>`).join('');

        document.getElementById('calendarDeptFilter').innerHTML =
          '<option value="">ã™ã¹ã¦ã®éƒ¨ç½²</option>' +
          masterDepartments.map(d => `<option value="${escapeAttr(d)}">${escapeHtml(d)}</option>`).join('');

        document.getElementById('lineList2').innerHTML = masterLines.map(l => `<option value="${escapeAttr(l)}">`).join('');

      }catch(err){
        console.error('ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
      }
    }

    // Realtime Listeners
    function setupListeners(){
      onSnapshot(query(collection(db, 'anomalies'), orderBy('occurrenceDate', 'desc')), (snap) => {
        anomalyData = snap.docs.map(d => ({ _id: d.id, type: 'anomaly', ...d.data() }));
        updateSerialList();
      });

      onSnapshot(query(collection(db, 'changepoints'), orderBy('occurrenceDate', 'desc')), (snap) => {
        changepointData = snap.docs.map(d => ({ _id: d.id, docType: 'changepoint', ...d.data() }));
        setupTopicsDeptFilter();
        buildTopicsDeptOptions();
        updateTopics();
        renderPlannedHistory();
        if (screens.calendar.style.display === 'block') renderCalendar();
      });
    }

    function updateSerialList(){
      const serialNos = [...new Set(anomalyData.map(d => d.serialNo).filter(Boolean))].sort();
      const optionsHtml = serialNos.map(no => `<option value="${escapeAttr(no)}">`).join('');
      document.getElementById('serialList').innerHTML  = optionsHtml;
      document.getElementById('serialList2').innerHTML = optionsHtml;
    }

    // Topicsï¼ˆplannedã®ã¿ï¼‰â€” ä»Šæ—¥ã®ã€Œåˆ‡æ›¿ãˆæœªç¢ºå®šã€ã ã‘è¡¨ç¤º
    
    
    // â–¼ ãƒˆãƒ”ãƒƒã‚¯ã‚¹ï¼šç™ºç”Ÿéƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    function buildTopicsDeptOptions(){
      const sel = document.getElementById('topicsDeptFilter');
      if (!sel) return;
      const current = sel.value || '';
      const deptSel = (document.getElementById('topicsDeptFilter') ? document.getElementById('topicsDeptFilter').value : '') || '';

      let planned = changepointData.filter(p => (p.type === 'planned'));
      if (deptSel){
        planned = planned.filter(p => String(p.department||'') === String(deptSel));
      }
      const depts = Array.from(new Set(planned.map(p => (p.department || '').trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'ja'));
      sel.innerHTML = '<option value="">å…¨ã¦</option>' + depts.map(d => `<option value="${escapeAttr(d)}">${escapeHtml(d)}</option>`).join('');
      // restore
      if (depts.includes(current)) sel.value = current;
    }
    function setupTopicsDeptFilter(){
      const sel = document.getElementById('topicsDeptFilter');
      if (!sel) return;
      if (sel._bound) return;
      sel.addEventListener('change', () => updateTopics());
      sel._bound = true;
    }

function updateTopics(){
      const todayDate = new Date();
      const today = ymdLocal(todayDate);

      // ä»Šé€±ï¼ˆMon-Sunï¼‰
      const day = todayDate.getDay(); // 0=Sun
      const diffToMon = (day === 0) ? -6 : (1 - day);
      const mon = new Date(todayDate); mon.setDate(todayDate.getDate() + diffToMon);
      const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
      const weekStart = ymdLocal(mon);
      const weekEnd = ymdLocal(sun);

      const deptSel = (document.getElementById('topicsDeptFilter') ? document.getElementById('topicsDeptFilter').value : '') || '';

      let planned = changepointData.filter(p => (p.type === 'planned'));
      if (deptSel){
        planned = planned.filter(p => String(p.department||'') === String(deptSel));
      }

      const isLegacyCompleted = (p) => {
        return !!p.activatedAt || !!p.effectiveAt || (p.isActivated === true) || (p.effectiveStatus === 'active') || (p.activationStatus === 'activated');
      };

      const getSwitchStatus = (p) => (p.switchStatus || p.switchState || ((p.occurrenceDate ? 'scheduled' : 'undecided'))) || ((p.occurrenceDate ? 'scheduled' : 'undecided'));
      const getSwitchDate = (p) => (p.occurrenceDate || '');

      // 1) ä»Šæ—¥ã®å¤‰åŒ–ç‚¹ï¼ˆoccurrenceDateåŸºæº–ï¼‰
      const todayItems = planned
        .filter(p => p.occurrenceDate === today)
        .sort((a,b) => String(a.occurrenceTime||'').localeCompare(String(b.occurrenceTime||'')));

      // 2) ä»Šé€±ã®å¤‰åŒ–ç‚¹ï¼ˆoccurrenceDateåŸºæº–ï¼šé€±å†…ï¼‰
      const weekItems = planned
        .filter(p => {
          const d = String(p.occurrenceDate || '');
          return d && d >= weekStart && d <= weekEnd;
        })
        .sort((a,b) => String(a.occurrenceDate||'').localeCompare(String(b.occurrenceDate||'')) || String(a.occurrenceTime||'').localeCompare(String(b.occurrenceTime||'')));

      // 3) åˆ‡ã‚Šæ›¿ãˆæ—¥æœªç¢ºå®šï¼ˆoccurrenceDate ãŒç©ºã€ã‹ã¤å®Œäº†ãƒ»ä¸­æ­¢ã‚’é™¤å¤–ï¼‰
      const undecidedItems = planned
        .filter(p => !isLegacyCompleted(p))
        .filter(p => {
          const st = getSwitchStatus(p);
          const sd = getSwitchDate(p);
          if (sd) return false; // åˆ‡æ›¿ãˆæ—¥ãŒå…¥ã£ã¦ã„ã‚Œã°æœªç¢ºå®šã§ã¯ãªã„
          if (st === 'completed' || st === 'canceled') return false;
          return true;
        })
        .sort((a,b) => String(a.department||'').localeCompare(String(b.department||''),'ja') || String(a.category||'').localeCompare(String(b.category||''),'ja'));

      // 3.5) ä»Šæœˆã®å¤‰åŒ–ç‚¹ï¼ˆå½“æœˆã®occurrenceDateã‚’æŒã¤ã‚‚ã®ï¼‰
      const currentYear = todayDate.getFullYear();
      const currentMonth = todayDate.getMonth() + 1;
      const monthStart = `${currentYear}-${String(currentMonth).padStart(2,'0')}-01`;
      const lastDayOfMonth = new Date(currentYear, currentMonth, 0).getDate();
      const monthEnd = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(lastDayOfMonth).padStart(2,'0')}`;
      
      const monthItems = planned
        .filter(p => {
          const d = String(p.occurrenceDate || '');
          return d && d >= monthStart && d <= monthEnd;
        })
        .sort((a,b) => String(a.occurrenceDate||'').localeCompare(String(b.occurrenceDate||'')));



      // 4) åˆ‡æ›¿ãˆæ—¥ã‚’éãã¦ã„ã‚‹ã®ã«å®Œäº†ã•ã‚Œã¦ã„ãªã„ï¼ˆè­¦å‘Šï¼‰
      const isOverdue = (p) => {
        const st = getSwitchStatus(p);
        if (st === 'completed' || st === 'canceled') return false;
        if (isLegacyCompleted(p)) return false;
        const d = String(getSwitchDate(p) || '');
        return !!d && d < today;
      };
      const overdueItems = planned
        .filter(p => isOverdue(p))
        .sort((a,b) => String(a.occurrenceDate||'').localeCompare(String(b.occurrenceDate||'')) || String(a.lineName||'').localeCompare(String(b.lineName||''),'ja'));

      const renderItems = (items, withDate=false) => items.map(item => {
        const switchStatus = item.switchStatus || '';
        let statusBadge = '';
        let statusActions = '';
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸
        if (switchStatus === 'completed') {
          statusBadge = '<span class="status-badge completed">âœ… å®Œäº†</span>';
        } else if (switchStatus === 'canceled') {
          statusBadge = '<span class="status-badge canceled">â›” ä¸­æ­¢</span>';
        } else if (switchStatus === 'postponed') {
          statusBadge = '<span class="status-badge postponed">â© å»¶æœŸ</span>';
        } else if (item.occurrenceDate) {
          statusBadge = '<span class="status-badge planned">ğŸ“‹ åˆ‡æ›¿ãˆæ—¥ç¢ºå®šæ¸ˆ</span>';
        } else {
          statusBadge = '<span class="status-badge planned">ğŸ“ è¨ˆç”»ä¸­</span>';
        }
        
        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆå®Œäº†ãƒ»ä¸­æ­¢ä»¥å¤–ï¼‰
        if (switchStatus !== 'completed' && switchStatus !== 'canceled') {
          statusActions = `
            <div class="status-actions" onclick="event.stopPropagation();">
              ${!item.occurrenceDate ? `<button class="status-btn btn-decide-date" onclick="decideSwitchDateQuick('${escapeAttr(item._id)}')">ğŸ“… åˆ‡æ›¿ãˆæ—¥æ±ºå®š</button>` : ''}
              ${item.occurrenceDate ? `<button class="status-btn btn-complete" onclick="completeSwitchQuick('${escapeAttr(item._id)}')">âœ… å®Œäº†</button>` : ''}
              ${item.occurrenceDate ? `<button class="status-btn btn-postpone" onclick="postponeSwitchQuick('${escapeAttr(item._id)}')">â© å»¶æœŸ</button>` : ''}
              <button class="status-btn btn-cancel" onclick="cancelSwitchQuick('${escapeAttr(item._id)}')">â›” ä¸­æ­¢</button>
            </div>
          `;
        }
        
        return `
        <div class="topics-item" data-id="${escapeAttr(item._id)}">
          <div class="time">ğŸ“… ${withDate ? escapeHtml(item.occurrenceDate || 'æ—¥ä»˜æœªå®š') + (item.occurrenceTime ? ' â° ' + escapeHtml(item.occurrenceTime) : '') : 'â° ' + escapeHtml(item.occurrenceTime || 'æ™‚åˆ»æœªå®š')}${(typeof isOverdue === "function" && isOverdue(item)) ? `<span class="pill overdue" style="background:#fff;color:#c92a2a;margin-left:8px;">æœŸé™è¶…é</span>` : ``}${statusBadge}</div>
          <div class="lines">
            <strong style="font-size:1.15rem;">ğŸ­ ${escapeHtml(item.department || '-')}</strong>
            ${' <strong style="font-size:1.15rem;">ï½œ ğŸ”§ ' + escapeHtml(item.lineName || '-') + '</strong>'}
            ${item.serialNo ? ' <strong style="font-size:1.15rem;">ï½œ ğŸ“‹ No.' + escapeHtml(item.serialNo) + '</strong>' : ''}
          </div>
          <div style="margin-top:8px;">
            <span class="category">${escapeHtml(item.category || '-')}</span>
            <span class="content">${escapeHtml((item.content || '').slice(0, 40))}${(item.content || '').length > 40 ? '...' : ''}</span>
          </div>
          ${statusActions}
        </div>
        `;
      }).join('');

      document.getElementById('topicsToday').innerHTML =
        todayItems.length ? renderItems(todayItems, false) : '<div class="topics-empty">ä»Šæ—¥ã®å¤‰åŒ–ç‚¹ã¯ã‚ã‚Šã¾ã›ã‚“</div>';

      document.getElementById('topicsWeek').innerHTML =
        weekItems.length ? renderItems(weekItems, true) : '<div class="topics-empty">ä»Šé€±ã®å¤‰åŒ–ç‚¹ã¯ã‚ã‚Šã¾ã›ã‚“</div>';

      // ä»Šæœˆã®å¤‰åŒ–ç‚¹ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºï¼‰
      const renderMonthTable = (items) => {
        if (!items.length) return '<div class="topics-empty">ä»Šæœˆã®å¤‰åŒ–ç‚¹ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        
        return `
          <table class="month-table">
            <thead>
              <tr>
                <th style="width:90px;">æ—¥ä»˜</th>
                <th style="width:100px;">éƒ¨ç½²</th>
                <th style="width:100px;">ãƒ©ã‚¤ãƒ³</th>
                <th style="width:80px;">æ•´ç†No.</th>
                <th>å¤‰åŒ–ç‚¹å†…å®¹</th>
              </tr>
            </thead>
            <tbody>
              ${items.map(item => `
                <tr onclick="showDetail(changepointData.find(p => p._id === '${escapeAttr(item._id)}'))" data-id="${escapeAttr(item._id)}">
                  <td class="date-col">${escapeHtml(item.occurrenceDate || '-')}</td>
                  <td>${escapeHtml(item.department || '-')}</td>
                  <td>${escapeHtml(item.lineName || '-')}</td>
                  <td>${escapeHtml(item.serialNo || '-')}</td>
                  <td class="content-col" title="${escapeAttr(item.content || '')}">${escapeHtml(item.content || '-')}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      };
      
      document.getElementById('topicsMonth').innerHTML = renderMonthTable(monthItems);

      document.getElementById('topicsUndecided').innerHTML =
        undecidedItems.length ? renderItems(undecidedItems, true) : '<div class="topics-empty">åˆ‡ã‚Šæ›¿ãˆæ—¥æœªç¢ºå®šã®å¤‰åŒ–ç‚¹ã¯ã‚ã‚Šã¾ã›ã‚“</div>';


      // â–¼ è­¦å‘ŠãƒãƒŠãƒ¼
      const banner = document.getElementById('topicsOverdueBanner');
      if (banner){
        if (overdueItems.length){
          const listHtml = overdueItems.slice(0, 8).map(item => {
            const switchStatus = item.switchStatus || '';
            let statusBadge = '';
            let statusActions = '';
            
            if (switchStatus === 'completed') {
              statusBadge = '<span class="status-badge completed">âœ… å®Œäº†</span>';
            } else if (switchStatus === 'canceled') {
              statusBadge = '<span class="status-badge canceled">â›” ä¸­æ­¢</span>';
            } else if (switchStatus === 'postponed') {
              statusBadge = '<span class="status-badge postponed">â© å»¶æœŸ</span>';
            } else {
              statusBadge = '<span class="status-badge planned">ğŸ“‹ åˆ‡æ›¿ãˆæ—¥ç¢ºå®šæ¸ˆ</span>';
            }
            
            if (switchStatus !== 'completed' && switchStatus !== 'canceled') {
              statusActions = `
                <div class="status-actions" onclick="event.stopPropagation();">
                  <button class="status-btn btn-complete" onclick="completeSwitchQuick('${escapeAttr(item._id)}')">âœ… å®Œäº†</button>
                  <button class="status-btn btn-postpone" onclick="postponeSwitchQuick('${escapeAttr(item._id)}')">â© å»¶æœŸ</button>
                  <button class="status-btn btn-cancel" onclick="cancelSwitchQuick('${escapeAttr(item._id)}')">â›” ä¸­æ­¢</button>
                </div>
              `;
            }
            
            return `
            <div class="topics-item" data-id="${escapeAttr(item._id)}">
              <div class="time">ğŸ“… ${escapeHtml(item.occurrenceDate || '-')}<span class="pill overdue" style="background:#fff;color:#c92a2a;margin-left:8px;">æœŸé™è¶…é</span>${statusBadge}</div>
              <div class="lines"><strong style="font-size:1.15rem;">ğŸ­ ${escapeHtml(item.department || '-')}</strong>${' <strong style="font-size:1.15rem;">ï½œ ğŸ”§ ' + escapeHtml(item.lineName || '-') + '</strong>'}${item.serialNo ? ' <strong style="font-size:1.15rem;">ï½œ ğŸ“‹ No.' + escapeHtml(item.serialNo) + '</strong>' : ''}</div>
              <div style="margin-top:8px;">
                <span class="category">${escapeHtml(item.category || '-')}</span>
                <span class="content">${escapeHtml((item.content || '').slice(0, 34))}${(item.content || '').length > 34 ? '...' : ''}</span>
              </div>
              ${statusActions}
            </div>
            `;
          }).join('');
          banner.style.display = 'block';
          banner.innerHTML = `
            <h3>âš ï¸ åˆ‡ã‚Šæ›¿ãˆæ—¥ã‚’éãã¦ã„ã¾ã™ï¼ˆæœªå®Œäº†ï¼‰ <span class="pill overdue">${overdueItems.length}ä»¶</span></h3>
            <div class="overdue-list">${listHtml}</div>
            <div style="margin-top:8px;font-size:.8rem;color:#7a1c1c;">â€»åˆ‡ã‚Šæ›¿ãˆå®Œäº†ï¼ˆã¾ãŸã¯å»¶æœŸï¼ä¸­æ­¢ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
          `;
        } else {
          banner.style.display = 'none';
          banner.innerHTML = '';
        }
      }


      // ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã¸ï¼ˆå§”è­²ï¼‰
      document.querySelectorAll('.topics-item').forEach(el => {
        el.addEventListener('click', () => {
          const item = changepointData.find(p => p._id === el.dataset.id);
          if (item) showDetail(item);
        });
      });
    }

    // ãƒˆãƒ”ãƒƒã‚¯ã‚¹ã‚«ãƒ¼ãƒ‰ã‹ã‚‰ã®ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é–¢æ•°
    window.decideSwitchDateQuick = async function(id) {
      const newDate = prompt('åˆ‡æ›¿ãˆæ—¥ï¼ˆYYYY-MM-DDï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', ymdLocal(new Date()));
      if (!newDate) return;
      if (!/^\d{4}-\d{2}-\d{2}$/.test(newDate)){
        alert('æ—¥ä»˜å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆYYYY-MM-DDï¼‰');
        return;
      }
      try {
        const user = auth.currentUser;
        await updateDoc(doc(db, 'changepoints', id), {
          occurrenceDate: newDate,
          switchStatus: 'scheduled',
          updatedAt: serverTimestamp(),
          updatedBy: user ? (user.email || user.uid) : ''
        });
        alert('åˆ‡æ›¿ãˆæ—¥ã‚’è¨­å®šã—ã¾ã—ãŸ');
      } catch(err) {
        console.error(err);
        alert('è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
      }
    };

    window.completeSwitchQuick = async function(id) {
      if (!confirm('ã“ã®å¤‰åŒ–ç‚¹ã‚’ã€Œå®Œäº†ã€ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ')) return;
      try {
        const user = auth.currentUser;
        await updateDoc(doc(db, 'changepoints', id), {
          switchStatus: 'completed',
          completedAt: serverTimestamp(),
          completedBy: user ? (user.email || user.uid) : ''
        });
        alert('å®Œäº†ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
      } catch(err) {
        console.error(err);
        alert('å®Œäº†ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
      }
    };

    window.postponeSwitchQuick = async function(id) {
      const item = changepointData.find(x => x._id === id);
      const current = item ? (item.occurrenceDate || ymdLocal(new Date())) : ymdLocal(new Date());
      const newDate = prompt('å»¶æœŸå¾Œã®åˆ‡æ›¿ãˆæ—¥ï¼ˆYYYY-MM-DDï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', current);
      if (!newDate) return;
      if (!/^\d{4}-\d{2}-\d{2}$/.test(newDate)){
        alert('æ—¥ä»˜å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆYYYY-MM-DDï¼‰');
        return;
      }
      try {
        const user = auth.currentUser;
        await updateDoc(doc(db, 'changepoints', id), {
          switchStatus: 'postponed',
          occurrenceDate: newDate,
          postponedAt: serverTimestamp(),
          postponedBy: user ? (user.email || user.uid) : ''
        });
        alert('å»¶æœŸã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
      } catch(err) {
        console.error(err);
        alert('å»¶æœŸç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
      }
    };

    window.cancelSwitchQuick = async function(id) {
      if (!confirm('ã“ã®å¤‰åŒ–ç‚¹ã‚’ã€Œä¸­æ­¢ã€ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ')) return;
      try {
        const user = auth.currentUser;
        await updateDoc(doc(db, 'changepoints', id), {
          switchStatus: 'canceled',
          canceledAt: serverTimestamp(),
          canceledBy: user ? (user.email || user.uid) : ''
        });
        alert('ä¸­æ­¢ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
      } catch(err) {
        console.error(err);
        alert('ä¸­æ­¢ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
      }
    };

    // Timeline
    function setupFilterMode(){
      document.getElementById('filterMode').addEventListener('change', (e) => {
        document.getElementById('serialFilterGroup').style.display = (e.target.value === 'serial') ? 'flex' : 'none';
        document.getElementById('lineFilterGroup').style.display = (e.target.value === 'line') ? 'flex' : 'none';
      });
    }

    document.getElementById('btnSearch').addEventListener('click', () => {
      const mode = document.getElementById('filterMode').value;
      const serial = document.getElementById('filterSerial').value.trim();
      const line = document.getElementById('filterLine').value;
      const dateFrom = document.getElementById('filterDateFrom').value;
      const dateTo = document.getElementById('filterDateTo').value;
      const typeFilter = document.getElementById('filterType').value;
      const keyword = document.getElementById('filterKeyword').value || '';

      const sortOrder = 'desc'; // âœ… æ˜‡é †ã¯å»ƒæ­¢ï¼šå¸¸ã«é™é †ï¼ˆæ–°ã—ã„â†’å¤ã„ï¼‰
currentSortOrder = sortOrder; // âœ… ä¸€è¦§ã®ä¸¦ã³é †ã¨ã—ã¦ä¿æŒï¼ˆã‚°ãƒ©ãƒ•æ¨ªè»¸ã¯å›ºå®šã§æ˜‡é †ï¼‰

      // anomalies + changepoints ã‚’çµ±åˆ
      let allItems = [];

      anomalyData.forEach(item => {
        allItems.push({
          ...item,
          _kind: 'anomaly',
          sortDate: item.occurrenceDate || '',
          sortTime: item.occurrenceTime || '',
        });
      });

      changepointData.forEach(item => {
        allItems.push({
          ...item,
          _kind: 'changepoint',
          sortDate: item.occurrenceDate || '',
          sortTime: item.occurrenceTime || '',
        });
      });

      filteredData = allItems.filter(item => {
        if (mode === 'serial' && serial){
          if (!String(item.serialNo || '').includes(serial)) return false;
        }

        if (mode === 'line' && line){
          if (String(item.lineName || '') !== String(line)) return false;
        }

        const itemDate = item.sortDate || '';
        if (dateFrom && itemDate < dateFrom) return false;
        if (dateTo && itemDate > dateTo) return false;

        if (typeFilter === 'anomaly'){
          if (item._kind !== 'anomaly') return false;
        }
        if (typeFilter === 'sudden'){
          if (item._kind !== 'changepoint' || item.type !== 'sudden') return false;
        }
        if (typeFilter === 'planned'){
          if (item._kind !== 'changepoint' || item.type !== 'planned') return false;
        }

        if (!matchesKeyword(item, keyword)) return false;
        return true;
      });

      // æ˜‡é †/é™é †ã§ã‚½ãƒ¼ãƒˆ
      filteredData.sort((a,b) => {
        const d = (a.sortDate || '').localeCompare(b.sortDate || '');
        if (d !== 0) return sortOrder === 'asc' ? d : -d;

        const t = (a.sortTime || '').localeCompare(b.sortTime || '');
        return sortOrder === 'asc' ? t : -t;
      });

      // ç•°å¸¸â†’ç´ã¥ãå¤‰åŒ–ç‚¹ã‚’ç›´å¾Œã«å¯„ã›ã‚‹
      filteredData = reorderLinkedTimelineItems(filteredData);

      updateStats();
      renderTimeline();
      renderTimelineChart(); // âœ… æ£’ã‚°ãƒ©ãƒ•ï¼†0æ—¥è¡¨ç¤º
    });

    function updateStats(){
      document.getElementById('statTotal').textContent = filteredData.length;
      document.getElementById('statAnomaly').textContent =
        filteredData.filter(d => d._kind === 'anomaly').length;
      document.getElementById('statSudden').textContent =
        filteredData.filter(d => d._kind === 'changepoint' && d.type === 'sudden').length;
      document.getElementById('statPlanned').textContent =
        filteredData.filter(d => d._kind === 'changepoint' && d.type === 'planned').length;
    }

    function renderTimeline(){
      document.getElementById('timelineLoading').style.display = 'none';
      if (filteredData.length === 0){
        document.getElementById('timelineEmpty').style.display = 'block';
        document.getElementById('timelineView').style.display = 'none';
        return;
      }
      document.getElementById('timelineEmpty').style.display = 'none';
      document.getElementById('timelineView').style.display = 'block';

      const container = document.getElementById('timelineView');

      container.innerHTML = filteredData.map((item, i) => {
        let cls = 'timeline-item';
        let badges = '';
        let summary = '';

        if (item._kind === 'anomaly'){
          cls += ' anomaly-only';
          badges = `<span class="badge badge-anomaly">ç•°å¸¸</span>`;
          summary = (item.anomalyContent || '').replace(/\n/g,' ').slice(0, 55);
        } else {
          if (item.type === 'planned'){
            cls += ' cp-planned';
            badges =
              `<span class="badge badge-planned">è¨ˆç”»</span>` +
              `<span class="badge badge-changepoint">${escapeHtml(item.category || '-')}</span>`;
            summary = 'ğŸ“‹ ' + (item.content || '').replace(/\n/g,' ').slice(0, 55);
          } else {
            cls += ' cp-sudden';
            badges =
              `<span class="badge badge-sudden">çªç™º</span>` +
              `<span class="badge badge-changepoint">${escapeHtml(item.category || '-')}</span>`;
            summary = 'ğŸ”„ ' + (item.content || '').replace(/\n/g,' ').slice(0, 55);
          }
        }

        return `
          <div class="${cls}" data-index="${i}">
            <div class="timeline-row">
              <div class="timeline-date">${escapeHtml(item.sortDate || '')}</div>
              <div class="timeline-badges">${badges}</div>
              <div class="timeline-summary">${escapeHtml(summary)}</div>
            </div>
          </div>
        `;
      }).join('');

      container.querySelectorAll('.timeline-item').forEach(el => {
        el.addEventListener('click', () => showDetail(filteredData[parseInt(el.dataset.index, 10)]));
      });
    }

    // Calendarï¼ˆplannedã®ã¿ï¼‰
    function setupCalendar(){
      document.getElementById('calPrev').addEventListener('click', () => {
        calendarMonth--;
        if (calendarMonth < 0){ calendarMonth = 11; calendarYear--; }
        renderCalendar();
      });
      document.getElementById('calNext').addEventListener('click', () => {
        calendarMonth++;
        if (calendarMonth > 11){ calendarMonth = 0; calendarYear++; }
        renderCalendar();
      });
      document.getElementById('calToday').addEventListener('click', () => {
        const now = new Date();
        calendarYear = now.getFullYear();
        calendarMonth = now.getMonth();
        renderCalendar();
      });

      document.getElementById('calendarDeptFilter').addEventListener('change', renderCalendar);
      document.getElementById('calendarCatFilter').addEventListener('change', renderCalendar);
    }

    function renderCalendar(){
      const deptFilter = document.getElementById('calendarDeptFilter').value;
      const catFilter  = document.getElementById('calendarCatFilter').value;

      document.getElementById('calMonthYear').textContent = `${calendarYear}å¹´${calendarMonth + 1}æœˆ`;

      const firstDay = new Date(calendarYear, calendarMonth, 1);
      const lastDay  = new Date(calendarYear, calendarMonth + 1, 0);
      const startDay = firstDay.getDay();
      const daysInMonth = lastDay.getDate();

      const today = ymdLocal(new Date());
      const grid  = document.getElementById('calendarGrid');

      let html = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].map(d => `<div class="calendar-day-header">${d}</div>`).join('');

      const plannedOnly = changepointData.filter(p => p.type === 'planned').filter(p => {
        if (deptFilter && String(p.department || '') !== String(deptFilter)) return false;
        if (catFilter && String(p.category || '') !== String(catFilter)) return false;
        return true;
      });

      const prevMonth = new Date(calendarYear, calendarMonth, 0);
      for (let i = startDay - 1; i >= 0; i--){
        const day = prevMonth.getDate() - i;
        html += `<div class="calendar-day other-month"><div class="day-number">${day}</div></div>`;
      }

      for (let day = 1; day <= daysInMonth; day++){
        const dateStr = `${calendarYear}-${String(calendarMonth + 1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const dayOfWeek = new Date(calendarYear, calendarMonth, day).getDay();
        const isToday = (dateStr === today);
        const dayClass = isToday ? 'today' : (dayOfWeek === 0 ? 'sunday' : (dayOfWeek === 6 ? 'saturday' : ''));

        const dayEvents = plannedOnly.filter(p => p.occurrenceDate === dateStr);

        let eventsHtml = dayEvents.slice(0,3).map(e => {
          const info = [e.department, e.lineName, e.serialNo].filter(Boolean).join(' / ');
          const contentPreview = (e.content || '').slice(0, 30) + ((e.content || '').length > 30 ? '...' : '');
          return `<div class="calendar-event category-${escapeAttr(e.category || 'ãã®ä»–')}" data-id="${escapeAttr(e._id)}" title="${escapeAttr(e.content || '')}">
            <div style="font-weight:600;font-size:.75rem;">${escapeHtml(e.category || '')}</div>
            <div style="font-size:.65rem;opacity:.9;">${escapeHtml(info || '-')}</div>
            <div style="font-size:.65rem;margin-top:2px;line-height:1.3;">${escapeHtml(contentPreview)}</div>
          </div>`;
        }).join('');

        if (dayEvents.length > 3) eventsHtml += `<div class="calendar-more">ä»–${dayEvents.length - 3}ä»¶</div>`;

        html += `
          <div class="calendar-day ${dayClass}" data-date="${escapeAttr(dateStr)}">
            <div class="day-number">${day}</div>
            ${eventsHtml}
          </div>
        `;
      }

      const remaining = (7 - ((startDay + daysInMonth) % 7)) % 7;
      for (let i = 1; i <= remaining; i++){
        html += `<div class="calendar-day other-month"><div class="day-number">${i}</div></div>`;
      }

      grid.innerHTML = html;

      grid.querySelectorAll('.calendar-event').forEach(el => {
        el.addEventListener('click', (e) => {
          e.stopPropagation();
          const item = changepointData.find(p => p._id === el.dataset.id);
          if (item) showDetail(item);
        });
      });
    }

    // Planned Form
    function setupPlannedForm(){
      document.getElementById('btnExportLastPlannedCSV').addEventListener('click', () => {
        if (!lastRegisteredPlanned){
          alert('ã¾ã CSVå‡ºåŠ›ã§ãã‚‹ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå…ˆã«ç™»éŒ²ã—ã¦ãã ã•ã„ï¼‰');
          return;
        }
        const safeDate = (lastRegisteredPlanned.occurrenceDate || ymdLocal(new Date()));
        const safeTime = (lastRegisteredPlanned.occurrenceTime || '').replace(':','') || '----';
        const safeSerial = safeFilenamePart(lastRegisteredPlanned.serialNo || 'no-serial');
        const filename = `CP_planned_${safeDate}_${safeTime}_${safeSerial}.csv`;
        downloadCSV(filename, PLANNED_CP_CSV_HEADERS, lastRegisteredPlanned);
      });

      document.getElementById('btnExportLastPlannedQR').addEventListener('click', async () => {
        if (!lastRegisteredPlanned){
          alert('ã¾ã QRå‡ºåŠ›ã§ãã‚‹ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå…ˆã«ç™»éŒ²ã—ã¦ãã ã•ã„ï¼‰');
          return;
        }

        if (!lastDetailHtmlUrl){
          try {
            document.getElementById('btnExportLastPlannedQR').textContent = 'â³ ç”Ÿæˆä¸­...';
            document.getElementById('btnExportLastPlannedQR').disabled = true;
            lastDetailHtmlUrl = await generateAndUploadDetailHtml(lastRegisteredPlanned);
          } catch(err) {
            alert('è©³ç´°ãƒšãƒ¼ã‚¸ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
            document.getElementById('btnExportLastPlannedQR').textContent = 'ğŸ“± QRå‡ºåŠ›';
            document.getElementById('btnExportLastPlannedQR').disabled = false;
            return;
          }
          document.getElementById('btnExportLastPlannedQR').textContent = 'ğŸ“± QRå‡ºåŠ›';
          document.getElementById('btnExportLastPlannedQR').disabled = false;
        }
        showQRModal(lastDetailHtmlUrl);
      });

      // ç™»éŒ²ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ â†’ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
      document.getElementById('btnRegisterPlanned').addEventListener('click', () => {
        const planneddepartment = document.getElementById('planDepartment').value || '';
        const department = document.getElementById('planDepartmentOccur').value || '';
        const category = document.getElementById('planCategory').value || '';
        const lineName = document.getElementById('planLineName').value.trim() || '';
        const serialNo = document.getElementById('planSerialNo').value.trim() || '';
        const content  = document.getElementById('planContent').value || '';
        const occurrenceDate = document.getElementById('planDate').value || '';

        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if (!planneddepartment){ alert('èµ·æ¡ˆéƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
        if (!category){ alert('å¤‰åŒ–ç‚¹åˆ†é¡ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
        if (!department){ alert('å¤‰åŒ–ç‚¹ç™ºç”Ÿéƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
        if (!lineName){ alert('å¯¾è±¡ãƒ©ã‚¤ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        if (!content.trim()){ alert('å¤‰åŒ–ç‚¹å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

        // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
        showConfirmDialog();
      });

      // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«
      document.getElementById('btnConfirmCancel').addEventListener('click', () => {
        document.getElementById('confirmModal').style.display = 'none';
      });

      // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼šç™»éŒ²å®Ÿè¡Œ
      
document.getElementById('btnConfirmOk').addEventListener('click', async () => {
  document.getElementById('confirmModal').style.display = 'none';
  await executeRegistration();
});


      // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      document.getElementById('confirmModal').addEventListener('click', (e) => {
        if (e.target.id === 'confirmModal') {
          document.getElementById('confirmModal').style.display = 'none';
        }
      });
    }

    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºé–¢æ•°
    function showConfirmDialog(){
  const planneddepartment = document.getElementById('planDepartment').value || '';
  const department = document.getElementById('planDepartmentOccur').value || '';
  const category = document.getElementById('planCategory').value || '';
  const lineName = document.getElementById('planLineName').value.trim() || '';
  const serialNo = document.getElementById('planSerialNo').value.trim() || '';
  const content  = document.getElementById('planContent').value || '';
  const occurrenceDate = document.getElementById('planDate').value || '';

  const confirmContent = `
    <div class="confirm-item">
      <div class="confirm-label">èµ·æ¡ˆéƒ¨ç½²</div>
      <div class="confirm-value">${escapeHtml(planneddepartment)}</div>
    </div>
    <div class="confirm-item">
      <div class="confirm-label">å¤‰åŒ–ç‚¹åˆ†é¡</div>
      <div class="confirm-value">${escapeHtml(category)}</div>
    </div>
    <div class="confirm-item">
      <div class="confirm-label">å¤‰åŒ–ç‚¹ç™ºç”Ÿéƒ¨ç½²</div>
      <div class="confirm-value">${escapeHtml(department)}</div>
    </div>
    <div class="confirm-item">
      <div class="confirm-label">å¯¾è±¡ãƒ©ã‚¤ãƒ³å</div>
      <div class="confirm-value">${escapeHtml(lineName)}</div>
    </div>
    <div class="confirm-item">
      <div class="confirm-label">æ•´ç†No</div>
      <div class="confirm-value">${escapeHtml(serialNo || '(ãªã—)')}</div>
    </div>
    <div class="confirm-item">
      <div class="confirm-label">å¤‰åŒ–ç‚¹å†…å®¹</div>
      <div class="confirm-value">${escapeHtml(content)}</div>
    </div>
    <div class="confirm-item">
      <div class="confirm-label">åˆ‡æ›¿ãˆæ—¥</div>
      <div class="confirm-value">${escapeHtml(occurrenceDate || '(æœªå®š)')}</div>
    </div>
  `;

  document.getElementById('confirmContent').innerHTML = confirmContent;

  document.getElementById('confirmModal').style.display = 'block';
}



// ===== ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãï¼ˆOutlook / mailtoï¼‰é€£æº =====
function buildMailSubject(lineName, department, category){
  const parts = ['ã€å¤‰åŒ–ç‚¹ä¿¡å·ã€‘'];
  if (category) parts.push(category);
  if (department) parts.push('ç™ºç”Ÿéƒ¨ç½²:' + department);
  if (lineName) parts.push('ãƒ©ã‚¤ãƒ³:' + lineName);
  return parts.join(' ');
}

function buildMailBody(data){
  const lines = [];
  lines.push('å„ä½');
  lines.push('');
  lines.push('ãŠç–²ã‚Œæ§˜ã§ã™ã€‚');
  lines.push('ä¸‹è¨˜ã®é€šã‚Šã€è¨ˆç”»å¤‰åŒ–ç‚¹ã‚’ç™»éŒ²ã—ã¾ã—ãŸã®ã§ãŠçŸ¥ã‚‰ã›ã„ãŸã—ã¾ã™ã€‚');
  lines.push('');
  lines.push('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  lines.push('ã€ç™»éŒ²å†…å®¹ã€‘');
  lines.push('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  lines.push('');
  if (data.planneddepartment) lines.push('â–  èµ·æ¡ˆéƒ¨ç½²ã€€ã€€ï¼š' + data.planneddepartment);
  if (data.department) lines.push('â–  ç™ºç”Ÿéƒ¨ç½²ã€€ã€€ï¼š' + data.department);
  if (data.category) lines.push('â–  åˆ†é¡ã€€ã€€ã€€ã€€ï¼š' + data.category);
  if (data.lineName) lines.push('â–  ãƒ©ã‚¤ãƒ³åã€€ã€€ï¼š' + data.lineName);
  if (data.serialNo) lines.push('â–  æ•´ç†Noã€€ã€€ã€€ï¼š' + data.serialNo);
  lines.push('');
  lines.push('â–  å†…å®¹');
  lines.push('---');
  if (data.content) {
    lines.push(data.content.trim());
  }
  lines.push('---');
  lines.push('');
  lines.push('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  lines.push('');
  lines.push('å¿…è¦ã«å¿œã˜ã¦ã€ã”ç¢ºèªãƒ»å¯¾å¿œã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚');
  if (data.who) {
    lines.push('');
    lines.push('ç™»éŒ²è€…ï¼š' + data.who);
  }
  lines.push('');
  
  return lines.join('\n');
}

function openMailDraft(opts){
  const to = (opts && opts.to) ? String(opts.to) : '';
  const cc = (opts && opts.cc) ? String(opts.cc) : '';
  const subject = (opts && opts.subject) ? String(opts.subject) : '';
  let body = (opts && opts.body) ? String(opts.body) : '';

  // URLSearchParamsã¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’+ã«ã™ã‚‹ã®ã§ä½¿ã‚ãªã„ï¼ˆ+æ··å…¥é˜²æ­¢ï¼‰
  const enc = (s) => encodeURIComponent(String(s)).replace(/\+/g, '%20');

  // bodyã¯æ”¹è¡Œã‚’æ®‹ã—ãŸã¾ã¾ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
  body = body.replace(/\r\n/g, '\n').split('\n').map(line => enc(line)).join('%0D%0A');

  let url = 'mailto:' + enc(to);
  const params = [];
  if (cc) params.push('cc=' + enc(cc));
  if (subject) params.push('subject=' + enc(subject));
  if (body) params.push('body=' + body);
  if (params.length) url += '?' + params.join('&');

  window.open(url, '_blank');
}

    // ç™»éŒ²å®Ÿè¡Œé–¢æ•°
    async function executeRegistration(){
        const planneddepartment = document.getElementById('planDepartment').value || '';
        const department = document.getElementById('planDepartmentOccur').value || '';
        const category = document.getElementById('planCategory').value || '';
        const lineName = document.getElementById('planLineName').value.trim() || '';
        const serialNo = document.getElementById('planSerialNo').value.trim() || '';
        const content  = document.getElementById('planContent').value || '';
        const occurrenceDate = document.getElementById('planDate').value || '';
        const occurrenceTime = null;

        const data = {
          type: 'planned',
          planneddepartment,
          department,
          category,
          lineName,
          serialNo,
          content,
          occurrenceDate: occurrenceDate || null,
          occurrenceTime: null,
          document: '',
          documentUrl: '',
          createdAt: serverTimestamp()
        };

        try{
          const docRef = await addDoc(collection(db, 'changepoints'), data);

          let documentUrl = '';
          if (selectedFile){
            try {
              documentUrl = await uploadFileToStorage(selectedFile, docRef.id);
              await updateDoc(doc(db, 'changepoints', docRef.id), { documentUrl });
            } catch(uploadErr){
              alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€å¤‰åŒ–ç‚¹ã¯ç™»éŒ²ã•ã‚Œã¾ã—ãŸ');
            }
          }

          const now = new Date();
          lastRegisteredPlanned = {
            docId: docRef.id,
            ...data,
            documentUrl,
            createdAtLocal: now.toISOString()
          };
          lastDetailHtmlUrl = null;
          setExportButtonEnabled(true);





// ãƒ¡ãƒ¼ãƒ«ä¸‹æ›¸ãä½œæˆï¼ˆè‡ªå‹•ï¼‰
try{
  const user = auth.currentUser;
  const who = user?.email || user?.uid || '';
  const subject = buildMailSubject(lineName, department, category);
  const body = buildMailBody({
    planneddepartment,
    department,
    category,
    lineName,
    serialNo,
    content,
    who
  });

  // â˜…å®›å…ˆã¯å¿…è¦ã«å¿œã˜ã¦å›ºå®š or ãƒã‚¹ã‚¿é€£å‹•ã«å¤‰æ›´å¯
  openMailDraft({
    to: '',
    cc: '',
    subject,
    body
  });
}catch(_){}
alert('è¨ˆç”»å¤‰åŒ–ç‚¹ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
          document.getElementById('plannedForm').reset();
          document.getElementById('planDate').value = '';

          selectedFile = null;
          document.getElementById('filePreview').style.display = 'none';
          document.getElementById('filePreview').innerHTML = '';

        }catch(err){
          alert('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
        }
    }


    function renderPlannedHistory(){
      const container = document.getElementById('plannedHistory');
      const plannedOnly = changepointData.filter(p => p.type === 'planned')
        .sort((a,b) => (String(b.occurrenceDate||'').localeCompare(String(a.occurrenceDate||''))));

      if (!plannedOnly.length){
        container.innerHTML = '<div class="empty-state"><p>ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
        return;
      }

      container.innerHTML = `
        <table class="history-table">
          <thead>
            <tr>
              <th>ç™ºç”Ÿæ—¥</th><th>æ™‚åˆ»</th><th>åˆ†é¡</th><th>èµ·æ¡ˆéƒ¨ç½²</th><th>ç™ºç”Ÿéƒ¨ç½²</th><th>ãƒ©ã‚¤ãƒ³</th><th>æ•´ç†No</th><th>å†…å®¹</th><th style="width:100px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${plannedOnly.slice(0, 20).map(item => `
              <tr>
                <td>${escapeHtml(item.occurrenceDate || '')}</td>
                <td>${escapeHtml(item.occurrenceTime || '')}</td>
                <td><span class="badge badge-changepoint">${escapeHtml(item.category || '-')}</span></td>
                <td>${escapeHtml(item.planneddepartment || '')}</td>
                <td>${escapeHtml(item.department || '')}</td>
                <td>${escapeHtml(item.lineName || '')}</td>
                <td>${escapeHtml(item.serialNo || '')}</td>
                <td>${escapeHtml((item.content || '').slice(0, 30))}${(item.content || '').length > 30 ? '...' : ''}</td>
                <td>
                  <button class="btn btn-sm" style="background:#ffc107;color:#000;margin-right:4px;" onclick="openEditFromHistory('${item._id}')">âœï¸</button>
                  <button class="btn btn-sm" style="background:#e53935;color:#fff;" onclick="deleteChangepoint('${item._id}')">ğŸ—‘ï¸</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // Master Management
    function setupMasterTabs(){
      document.querySelectorAll('.master-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.master-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById('masterDepartment').style.display = (tab.dataset.tab === 'department') ? 'block' : 'none';
          document.getElementById('masterLine').style.display = (tab.dataset.tab === 'line') ? 'block' : 'none';
        });
      });

      document.getElementById('btnAddDept').addEventListener('click', async () => {
        const name = document.getElementById('addDeptName').value.trim();
        if (!name) return;
        try{
          await addDoc(collection(db, 'masters', 'department', 'items'), { name });
          document.getElementById('addDeptName').value = '';
          await loadMasters();
          renderMasterTables();
        }catch(e){
          alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      });

      document.getElementById('btnAddLine').addEventListener('click', async () => {
        const name = document.getElementById('addLineName').value.trim();
        if (!name) return;
        try{
          await addDoc(collection(db, 'masters', 'line', 'items'), { name });
          document.getElementById('addLineName').value = '';
          await loadMasters();
          renderMasterTables();
        }catch(e){
          alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      });
    }

    function renderMasterTables(){
      document.getElementById('deptTableBody').innerHTML = deptDocs.map(d =>
        `<tr><td>${escapeHtml(d.name || '')}</td><td><button class="btn btn-danger btn-sm" onclick="deleteMaster('department', '${escapeAttr(d.id)}')">å‰Šé™¤</button></td></tr>`
      ).join('');

      document.getElementById('lineTableBody').innerHTML = lineDocs.map(d =>
        `<tr><td>${escapeHtml(d.name || '')}</td><td><button class="btn btn-danger btn-sm" onclick="deleteMaster('line', '${escapeAttr(d.id)}')">å‰Šé™¤</button></td></tr>`
      ).join('');
    }

    window.deleteMaster = async function(type, id){
      if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      try{
        await deleteDoc(doc(db, 'masters', type, 'items', id));
        await loadMasters();
        renderMasterTables();
      }catch(e){
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    };

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è¨­å®š
    function setupFileUpload(){
      const area = document.getElementById('fileUploadArea');
      const input = document.getElementById('planDocumentFile');

      area.addEventListener('click', () => input.click());

      area.addEventListener('dragover', (e) => {
        e.preventDefault();
        area.style.borderColor = '#667eea';
        area.style.background = '#f5f5ff';
      });

      area.addEventListener('dragleave', () => {
        area.style.borderColor = '#ccc';
        area.style.background = '#fafafa';
      });

      area.addEventListener('drop', (e) => {
        e.preventDefault();
        area.style.borderColor = '#ccc';
        area.style.background = '#fafafa';
        if (e.dataTransfer.files.length > 0){
          handleFileSelect(e.dataTransfer.files[0]);
        }
      });

      input.addEventListener('change', (e) => {
        if (e.target.files.length > 0){
          handleFileSelect(e.target.files[0]);
        }
      });
    }

    function handleFileSelect(file){
      const MAX_SIZE = 5 * 1024 * 1024; // 5MB
      if (file.size > MAX_SIZE){
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒ5MBã‚’è¶…ãˆã¦ã„ã¾ã™');
        return;
      }

      selectedFile = file;
      const preview = document.getElementById('filePreview');
      preview.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;margin-top:10px;padding:10px;background:#e8f5e9;border-radius:8px;">
          <span style="flex:1;font-size:.9rem;color:#333;word-break:break-all;">ğŸ“„ ${escapeHtml(file.name)} (${(file.size / 1024).toFixed(1)} KB)</span>
          <button type="button" style="padding:4px 10px;background:#e53935;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:.8rem;" id="btnRemoveFile">âœ• å‰Šé™¤</button>
        </div>
      `;
      preview.style.display = 'block';

      document.getElementById('btnRemoveFile').addEventListener('click', () => {
        selectedFile = null;
        preview.style.display = 'none';
        preview.innerHTML = '';
        document.getElementById('planDocumentFile').value = '';
      });
    }

    async function uploadFileToStorage(file, docId){
      const timestamp = Date.now();
      const safeFileName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
      const storagePath = `changepoints/${docId}/${timestamp}_${safeFileName}`;
      const storageRef = ref(storage, storagePath);

      const progressEl = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('uploadProgressBar');
      progressEl.style.display = 'block';

      return new Promise((resolve, reject) => {
        const uploadTask = uploadBytesResumable(storageRef, file);

        uploadTask.on('state_changed',
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            progressBar.style.width = progress + '%';
          },
          (error) => {
            progressEl.style.display = 'none';
            reject(error);
          },
          async () => {
            progressEl.style.display = 'none';
            const downloadUrl = await getDownloadURL(uploadTask.snapshot.ref);
            resolve(downloadUrl);
          }
        );
      });
    }

    // è©³ç´°HTMLã‚’ç”Ÿæˆã—ã¦Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    async function generateAndUploadDetailHtml(data){
      const htmlContent = `<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¨ˆç”»å¤‰åŒ–ç‚¹ - ${escapeHtml(data.occurrenceDate)} ${escapeHtml(data.category)}</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
    .card { max-width: 600px; margin: 0 auto; background: #fff; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,.15); overflow: hidden; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 24px; text-align: center; }
    .header h1 { font-size: 1.3rem; margin-bottom: 8px; }
    .header .date { font-size: 1rem; opacity: .9; }
    .badges { display: flex; gap: 8px; justify-content: center; padding: 16px; background: #f8f9ff; border-bottom: 1px solid #e0e0e0; }
    .badge { padding: 6px 14px; border-radius: 20px; font-size: .85rem; font-weight: 600; }
    .badge-planned { background: #bbdefb; color: #1565c0; }
    .badge-category { background: #c8e6c9; color: #2e7d32; }
    .body { padding: 24px; }
    .section { margin-bottom: 20px; }
    .section-title { font-size: .85rem; font-weight: 600; color: #667eea; margin-bottom: 8px; }
    .section-content { font-size: .95rem; color: #333; line-height: 1.6; background: #f8f9fa; padding: 12px 16px; border-radius: 8px; white-space: pre-wrap; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .grid-item { background: #f8f9fa; padding: 12px; border-radius: 8px; }
    .grid-item .label { font-size: .75rem; color: #888; margin-bottom: 4px; }
    .grid-item .value { font-size: .9rem; color: #333; }
    .footer { padding: 16px 24px; background: #f8f9fa; text-align: center; font-size: .8rem; color: #888; }
    a { color: #667eea; }
    @media (max-width: 500px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <h1>ğŸ“‹ è¨ˆç”»å¤‰åŒ–ç‚¹</h1>
      <div class="date">${escapeHtml(data.occurrenceDate)} ${escapeHtml(data.occurrenceTime || '')}</div>
    </div>
    <div class="badges">
      <span class="badge badge-planned">è¨ˆç”»</span>
      <span class="badge badge-category">${escapeHtml(data.category || '-')}</span>
    </div>
    <div class="body">
      <div class="grid">
        <div class="grid-item"><div class="label">èµ·æ¡ˆéƒ¨ç½²</div><div class="value">${escapeHtml(data.planneddepartment || '-')}</div></div>
        <div class="grid-item"><div class="label">ç™ºç”Ÿéƒ¨ç½²</div><div class="value">${escapeHtml(data.department || '-')}</div></div>
        <div class="grid-item"><div class="label">ãƒ©ã‚¤ãƒ³å</div><div class="value">${escapeHtml(data.lineName || '-')}</div></div>
        <div class="grid-item"><div class="label">æ•´ç†No</div><div class="value">${escapeHtml(data.serialNo || '-')}</div></div>
        <div class="grid-item"><div class="label">å¯¾è±¡ãƒ­ãƒƒãƒˆ</div><div class="value">${escapeHtml(data.lot || '-')}</div></div>
        <div class="grid-item"><div class="label">DocID</div><div class="value" style="font-size:.75rem;">${escapeHtml(data.docId || '-')}</div></div>
      </div>
      <div class="section">
        <div class="section-title">ğŸ“ å¤‰åŒ–ç‚¹å†…å®¹</div>
        <div class="section-content">${escapeHtml(data.content || '-')}</div>
      </div>
      ${data.document ? `<div class="section"><div class="section-title">ğŸ“ é–¢é€£è³‡æ–™ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰</div><div class="section-content">${escapeHtml(data.document)}</div></div>` : ''}
      ${data.documentUrl ? `<div class="section"><div class="section-title">ğŸ“ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</div><div class="section-content"><a href="${escapeHtml(data.documentUrl)}" target="_blank">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã</a></div></div>` : ''}
    </div>
    <div class="footer">ç™»éŒ²æ—¥æ™‚: ${escapeHtml(data.createdAtLocal || '-')}<br>å¤‰åŒ–ç‚¹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </div>
  </div>
</body>
</html>`;

      const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
      const storagePath = `changepoints/${data.docId}/detail_${Date.now()}.html`;
      const storageRef = ref(storage, storagePath);

      const uploadTask = uploadBytesResumable(storageRef, blob, { contentType: 'text/html' });

      return new Promise((resolve, reject) => {
        uploadTask.on('state_changed',
          null,
          (error) => reject(error),
          async () => {
            const downloadUrl = await getDownloadURL(uploadTask.snapshot.ref);
            resolve(downloadUrl);
          }
        );
      });
    }

    // QRãƒ¢ãƒ¼ãƒ€ãƒ«è¨­å®š
    let qrCodeInstance = null;

    function setupQRModal(){
      document.getElementById('qrClose').addEventListener('click', () => {
        document.getElementById('qrModal').classList.remove('active');
      });
      document.getElementById('qrModal').addEventListener('click', (e) => {
        if (e.target.id === 'qrModal') document.getElementById('qrModal').classList.remove('active');
      });

      document.getElementById('btnDownloadQR').addEventListener('click', () => {
        const qrContainer = document.getElementById('qrCanvas');
        const canvas = qrContainer.querySelector('canvas');
        if (canvas) {
          const link = document.createElement('a');
          link.download = `QR_${lastRegisteredPlanned?.docId || 'changepoint'}.png`;
          link.href = canvas.toDataURL('image/png');
          link.click();
        } else {
          alert('QRã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }
      });

      document.getElementById('btnCopyUrl').addEventListener('click', () => {
        const url = document.getElementById('qrUrl').textContent;
        navigator.clipboard.writeText(url).then(() => {
          alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
        }).catch(() => {
          const textarea = document.createElement('textarea');
          textarea.value = url;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
        });
      });
    }

    function showQRModal(url){
      const qrContainer = document.getElementById('qrCanvas');
      const urlEl = document.getElementById('qrUrl');

      urlEl.textContent = url;
      qrContainer.innerHTML = '';

      try {
        qrCodeInstance = new QRCode(qrContainer, {
          text: url,
          width: 200,
          height: 200,
          colorDark: '#000000',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.M
        });
      } catch (error) {
        qrContainer.innerHTML = '<p style="color:red;">QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
      }

      document.getElementById('qrModal').classList.add('active');
    }

    // Detail Modal
    let currentDetailItem = null;

    function showDetail(item){
      currentDetailItem = item;
      const isAnomaly = (item._kind === 'anomaly') || (item.type === 'anomaly');
      const isCP = !isAnomaly;
      const isPlannedCP = isCP && item.type === 'planned';

      if (isAnomaly){
        document.getElementById('detailTitle').textContent =
          `æ•´ç†No: ${item.serialNo || '-'}ã€€${item.lineName || ''}`;
        document.getElementById('detailDate').textContent =
          `${item.occurrenceDate || ''} ${item.occurrenceTime || ''}`;
      } else {
        const t = (item.type === 'planned') ? 'è¨ˆç”»å¤‰åŒ–ç‚¹' : 'çªç™ºå¤‰åŒ–ç‚¹';
        document.getElementById('detailTitle').textContent =
          `${t}ï¼ˆ${item.category || ''}ï¼‰`;
        document.getElementById('detailDate').textContent =
          `${item.occurrenceDate || ''} ${item.occurrenceTime || ''}`;
      }

      let badges = '';
      if (isAnomaly){
        badges += `<span class="badge badge-anomaly">ç•°å¸¸</span>`;
      } else {
        if (item.type === 'planned'){
          badges += `<span class="badge badge-planned">è¨ˆç”»</span>`;
        } else {
          badges += `<span class="badge badge-sudden">çªç™º</span>`;
        }
        badges += `<span class="badge badge-changepoint">${escapeHtml(item.category || '-')}</span>`;
      }
      document.getElementById('detailBadges').innerHTML = badges;

      let body = '';

      if (isAnomaly){
        body = `
          <div class="detail-grid" style="margin-bottom:20px;">
            <div class="detail-grid-item"><div class="label">æ•´ç†No</div><div class="value">${escapeHtml(item.serialNo || '-')}</div></div>
            <div class="detail-grid-item"><div class="label">ãƒ©ã‚¤ãƒ³</div><div class="value">${escapeHtml(item.lineName || '-')}</div></div>
            <div class="detail-grid-item"><div class="label">éƒ¨ç½²</div><div class="value">${escapeHtml(item.department || '-')}</div></div>
            <div class="detail-grid-item"><div class="label">å‡¦ç½®è€…</div><div class="value">${escapeHtml(item.handler || '-')}</div></div>
          </div>
        `;
        if (item.anomalyContent) body += `<div class="detail-section"><div class="detail-section-title">âš ï¸ ç•°å¸¸å†…å®¹</div><div class="detail-section-content">${escapeHtml(item.anomalyContent)}</div></div>`;
        if (item.actionTaken) body += `<div class="detail-section"><div class="detail-section-title">ğŸ”§ ç¾å ´å¯¾å¿œ</div><div class="detail-section-content">${escapeHtml(item.actionTaken)}</div></div>`;
        if (item.rootCauseAction) body += `<div class="detail-section"><div class="detail-section-title">ğŸ“‹ å‡¦ç½®æ–¹æ³•</div><div class="detail-section-content">${escapeHtml(item.rootCauseAction)}</div></div>`;
      } else {
        body = `
          <div class="detail-grid" style="margin-bottom:20px;">
            <div class="detail-grid-item"><div class="label">ç¨®åˆ¥</div><div class="value">${escapeHtml(item.type || '-')}</div></div>
            <div class="detail-grid-item"><div class="label">åˆ†é¡</div><div class="value">${escapeHtml(item.category || '-')}</div></div>
            <div class="detail-grid-item"><div class="label">ç™ºç”Ÿéƒ¨ç½²</div><div class="value">${escapeHtml(item.department || '-')}</div></div>
            <div class="detail-grid-item"><div class="label">ãƒ©ã‚¤ãƒ³</div><div class="value">${escapeHtml(item.lineName || '-')}</div></div>
            <div class="detail-grid-item"><div class="label">æ•´ç†No</div><div class="value">${escapeHtml(item.serialNo || '-')}</div></div>
            <div class="detail-grid-item"><div class="label">é–¢é€£ç•°å¸¸ID</div><div class="value">${escapeHtml(item.relatedAnomalyId || '-')}</div></div>
          </div>
        `;

        if (item.type === 'planned'){
          body += `
            <div class="detail-section">
              <div class="detail-section-title">ğŸ·ï¸ èµ·æ¡ˆéƒ¨ç½²</div>
              <div class="detail-section-content">${escapeHtml(item.planneddepartment || '-')}</div>
            </div>
          `;
        }

        body += `
          <div class="detail-section">
            <div class="detail-section-title">ğŸ“ å¤‰åŒ–ç‚¹å†…å®¹</div>
            <div class="detail-section-content">${escapeHtml(item.content || '-')}</div>
          </div>
        `;

        if (item.document){
          body += `
            <div class="detail-section">
              <div class="detail-section-title">ğŸ“ é–¢é€£è³‡æ–™ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰</div>
              <div class="detail-section-content">${escapeHtml(item.document)}</div>
            </div>
          `;
        }
        if (item.documentUrl){
          body += `
            <div class="detail-section">
              <div class="detail-section-title">ğŸ“ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</div>
              <div class="detail-section-content"><a href="${escapeHtml(item.documentUrl)}" target="_blank" style="color:#667eea;">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã</a></div>
            </div>
          `;
        }
      }

      document.getElementById('detailBody').innerHTML = body;

      const actionsEl = document.getElementById('detailActions');
      actionsEl.style.display = isPlannedCP ? 'flex' : 'none';

      // â–¼ è£½é€ ï¼šåˆ‡æ›¿ãˆãƒ•ãƒ­ãƒ¼è¡¨ç¤ºåˆ¶å¾¡
      const decisionBox = document.getElementById('switchDecisionBox');
      const afterBox    = document.getElementById('switchAfterDecisionBox');
      const dateInput   = document.getElementById('switchDateInput');
      const hintEl      = document.getElementById('switchStatusHint');

      const legacyCompleted = !!item.activatedAt || !!item.effectiveAt || (item.isActivated === true) || (item.effectiveStatus === 'active') || (item.activationStatus === 'activated');
      const switchDate   = (item.occurrenceDate || '') || '';
      const switchStatus = (item.switchStatus || item.switchState || (legacyCompleted ? 'completed' : (switchDate ? 'scheduled' : 'undecided'))) || (switchDate ? 'scheduled' : 'undecided');


      // â–¼ ãƒ•ãƒ­ãƒ¼ã‚¬ã‚¤ãƒ‰ï¼ˆè‡ªç„¶ã«èª˜å°ã™ã‚‹ï¼‰
      const guideEl = document.getElementById('switchFlowGuide');
      const guideText = document.getElementById('switchFlowStatusText');
      if (guideEl && isPlannedCP){
        guideEl.style.display = 'block';
        const steps = guideEl.querySelectorAll('.step');
        steps.forEach(s => s.classList.remove('active'));
        let activeStep = 1;
        if (switchStatus === 'scheduled' || switchStatus === 'postponed') activeStep = 2;
        if (switchStatus === 'completed' || switchStatus === 'canceled') activeStep = 3;
        const activeEl = guideEl.querySelector(`.step[data-step="${activeStep}"]`);
        if (activeEl) activeEl.classList.add('active');

        const label = (s) => {
          if (s === 'undecided') return 'åˆ‡æ›¿ãˆæ—¥ï¼šæœªç¢ºå®š';
          if (s === 'scheduled') return `åˆ‡æ›¿ãˆæ—¥ï¼š${switchDate || 'æœªè¨­å®š'}ï¼ˆç¢ºå®šæ¸ˆã¿ï¼‰`;
          if (s === 'postponed') return `åˆ‡æ›¿ãˆæ—¥ï¼š${switchDate || 'æœªè¨­å®š'}ï¼ˆå»¶æœŸå¾Œï¼‰`;
          if (s === 'completed') return `åˆ‡æ›¿ãˆï¼šå®Œäº†ï¼ˆ${switchDate || '-'}ï¼‰`;
          if (s === 'canceled') return `åˆ‡æ›¿ãˆï¼šä¸­æ­¢ï¼ˆ${switchDate || '-'}ï¼‰`;
          return `çŠ¶æ…‹ï¼š${s || '-'}`;
        };
        const next = (s) => {
          if (s === 'undecided') return 'æ¬¡ã«ã‚„ã‚‹ã“ã¨ï¼šğŸ“…ã€Œä»Šæ—¥ã§æ±ºå®šã€ã¾ãŸã¯ ğŸ—“ã€ŒæŒ‡å®šæ—¥ã§æ±ºå®šã€ã§åˆ‡æ›¿ãˆæ—¥ã‚’æ±ºã‚ã¦ãã ã•ã„ã€‚';
          if (s === 'scheduled' || s === 'postponed') return 'æ¬¡ã«ã‚„ã‚‹ã“ã¨ï¼šåˆ‡æ›¿ãˆå®Ÿæ–½å¾Œã« âœ…ã€Œåˆ‡æ›¿ãˆå®Œäº†ã€ã€‚å¿…è¦ã«å¿œã˜ã¦ â©ã€Œå»¶æœŸã€ï¼â›”ã€Œä¸­æ­¢ã€ã€‚';
          if (s === 'completed') return 'ã“ã®å¤‰åŒ–ç‚¹ã¯å®Œäº†æ¸ˆã¿ã§ã™ã€‚';
          if (s === 'canceled') return 'ã“ã®å¤‰åŒ–ç‚¹ã¯ä¸­æ­¢ã§ã™ã€‚';
          return '';
        };
        if (guideText) guideText.textContent = `${label(switchStatus)}ã€€ï¼ã€€${next(switchStatus)}`;
      } else if (guideEl){
        guideEl.style.display = 'none';
      }


      const todayYmd = ymdLocal(new Date());
      if (dateInput && !dateInput.value){
        dateInput.value = todayYmd;
      }

      const statusLabel = (s) => {
        if (s === 'undecided') return 'åˆ‡æ›¿ãˆæœªç¢ºå®š';
        if (s === 'scheduled') return 'åˆ‡æ›¿ãˆæ—¥ç¢ºå®šï¼ˆæœªå®Œäº†ï¼‰';
        if (s === 'postponed') return 'å»¶æœŸï¼ˆåˆ‡æ›¿ãˆæ—¥å†è¨­å®šæ¸ˆã¿ï¼‰';
        if (s === 'canceled')  return 'ä¸­æ­¢';
        if (s === 'completed') return 'å®Œäº†';
        return s || '-';
      };

      if (decisionBox) decisionBox.style.display = 'none';
      if (afterBox) afterBox.style.display = 'none';

      if (isPlannedCP){
        if (switchStatus === 'undecided'){
          if (decisionBox) decisionBox.style.display = 'flex';
          if (dateInput) dateInput.value = todayYmd;
        } else if (switchStatus === 'scheduled' || switchStatus === 'postponed'){
          if (afterBox) afterBox.style.display = 'flex';
          if (hintEl){
            hintEl.textContent = `åˆ‡æ›¿ãˆæ—¥ï¼š${switchDate || 'æœªè¨­å®š'} ï¼ çŠ¶æ…‹ï¼š${statusLabel(switchStatus)}`;
          }
        } else {
          // completed / canceled ç­‰ï¼šæ“ä½œãƒ–ãƒ­ãƒƒã‚¯ã¯éè¡¨ç¤ºï¼ˆé–²è¦§ã®ã¿ï¼‰
          if (hintEl){
            hintEl.textContent = `åˆ‡æ›¿ãˆæ—¥ï¼š${switchDate || '-'} ï¼ çŠ¶æ…‹ï¼š${statusLabel(switchStatus)}`;
          }
        }
      }


      // â–¼ æœªç¢ºå®šãƒ¢ãƒ¼ãƒ€ãƒ«ã¯ã€Œåˆ‡æ›¿ãˆæ—¥å…¥åŠ›ã€ã ã‘ã«é™å®šï¼ˆç·¨é›†/å‰Šé™¤ãªã©ã¯éš ã™ï¼‰
      const editBtn = document.getElementById('btnDetailEdit');
      const delBtn  = document.getElementById('btnDetailDelete');
      const isUndecidedOnly = isPlannedCP && (switchStatus === 'undecided') && !switchDate;
      if (editBtn) editBtn.style.display = isUndecidedOnly ? 'none' : '';
      if (delBtn)  delBtn.style.display  = isUndecidedOnly ? 'none' : '';

      // â–¼ æœªç¢ºå®šãƒ¢ãƒ¼ãƒ€ãƒ«ã¯ã€Œåˆ‡æ›¿ãˆæ—¥å…¥åŠ›ã€ã ã‘ã‚’è¦‹ã›ã‚‹ï¼ˆæƒ…å ±è¡¨ç¤ºã‚‚æœ€å°åŒ–ï¼‰
      const bodyEl   = document.getElementById('detailBody');
      const badgesEl = document.getElementById('detailBadges');
      const dateEl   = document.getElementById('detailDate');
      if (isUndecidedOnly){
        if (bodyEl){
          bodyEl.innerHTML = '';
          bodyEl.style.display = 'none';
        }
        if (badgesEl) badgesEl.style.display = 'none';
        if (dateEl) dateEl.style.display = 'none';
      } else {
        if (bodyEl) bodyEl.style.display = '';
        if (badgesEl) badgesEl.style.display = '';
        if (dateEl) dateEl.style.display = '';
      }

      document.getElementById('detailModal').classList.add('active');
    }

    document.getElementById('detailClose').addEventListener('click', () => {
      document.getElementById('detailModal').classList.remove('active');
    });
    document.getElementById('detailModal').addEventListener('click', (e) => {
      if (e.target.id === 'detailModal') document.getElementById('detailModal').classList.remove('active');
    });

    document.getElementById('btnDetailEdit').addEventListener('click', () => {
      if (!currentDetailItem) return;
      document.getElementById('detailModal').classList.remove('active');
      openEditModal(currentDetailItem._id);
    });

    document.getElementById('btnDetailDelete').addEventListener('click', async () => {
      if (!currentDetailItem) return;
      await deleteChangepoint(currentDetailItem._id);
      document.getElementById('detailModal').classList.remove('active');
    });

    
    // â–¼ è£½é€ ï¼šåˆ‡æ›¿ãˆãƒ•ãƒ­ãƒ¼ï¼ˆåˆ‡æ›¿ãˆæ—¥æ±ºå®šï¼å®Œäº†ï¼å»¶æœŸï¼ä¸­æ­¢ï¼‰
    const btnSwitchToday = document.getElementById('btnSwitchToday');
    const btnSwitchDecide = document.getElementById('btnSwitchDecide');
    const btnSwitchComplete = document.getElementById('btnSwitchComplete');
    const btnSwitchPostpone = document.getElementById('btnSwitchPostpone');
    const btnSwitchCancel = document.getElementById('btnSwitchCancel');

    async function decideSwitchDate(dateYmd, mode){
      if (!currentDetailItem) return;
      if (!dateYmd){ alert('åˆ‡æ›¿ãˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      const user = auth.currentUser;
      const msg = (mode === 'today') ? `åˆ‡æ›¿ãˆæ—¥ã‚’ã€Œä»Šæ—¥ï¼ˆ${dateYmd}ï¼‰ã€ã§ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ` : `åˆ‡æ›¿ãˆæ—¥ã‚’ã€Œ${dateYmd}ã€ã§ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ`;
      if (!confirm(msg)) return;

      try{
        await updateDoc(doc(db, 'changepoints', currentDetailItem._id), {
          switchStatus: 'scheduled',
          occurrenceDate: dateYmd,
          switchDecidedAt: serverTimestamp(),
          switchDecidedBy: user ? (user.email || user.uid) : ''
        });
        alert('åˆ‡æ›¿ãˆæ—¥ã‚’ç¢ºå®šã—ã¾ã—ãŸ');
        document.getElementById('detailModal').classList.remove('active');
      }catch(err){
        console.error(err);
        alert('åˆ‡æ›¿ãˆæ—¥ã®ç¢ºå®šã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™ãƒ»é€šä¿¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰');
      }
    }

    async function completeSwitch(){
      if (!currentDetailItem) return;
      const sw = currentDetailItem.switchStatus || currentDetailItem.switchState || '';
      const swDate = currentDetailItem.occurrenceDate || '';
      if (!swDate || (sw !== 'scheduled' && sw !== 'postponed')){
        alert('å…ˆã«ã€Œåˆ‡æ›¿ãˆæ—¥ã€ã‚’ç¢ºå®šã—ã¦ãã ã•ã„ï¼ˆä»Šæ—¥ or æŒ‡å®šæ—¥ï¼‰');
        return;
      }
      if (!confirm(`åˆ‡æ›¿ãˆå®Œäº†ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿï¼ˆåˆ‡æ›¿ãˆæ—¥ï¼š${swDate}ï¼‰`)) return;
      const user = auth.currentUser;
      try{
        await updateDoc(doc(db, 'changepoints', currentDetailItem._id), {
          switchStatus: 'completed',
          switchedAt: serverTimestamp(),
          switchedBy: user ? (user.email || user.uid) : ''
        });
        alert('åˆ‡æ›¿ãˆå®Œäº†ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
        document.getElementById('detailModal').classList.remove('active');
      }catch(err){
        console.error(err);
        alert('å®Œäº†ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™ãƒ»é€šä¿¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰');
      }
    }

    async function cancelSwitch(){
      if (!currentDetailItem) return;
      if (!confirm('ã“ã®å¤‰åŒ–ç‚¹ã‚’ã€Œä¸­æ­¢ã€ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ')) return;
      const user = auth.currentUser;
      try{
        await updateDoc(doc(db, 'changepoints', currentDetailItem._id), {
          switchStatus: 'canceled',
          canceledAt: serverTimestamp(),
          canceledBy: user ? (user.email || user.uid) : ''
        });
        alert('ä¸­æ­¢ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
        document.getElementById('detailModal').classList.remove('active');
      }catch(err){
        console.error(err);
        alert('ä¸­æ­¢ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™ãƒ»é€šä¿¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰');
      }
    }

    async function postponeSwitch(){
      if (!currentDetailItem) return;
      const current = document.getElementById('switchDateInput')?.value || ymdLocal(new Date());
      const newDate = prompt('å»¶æœŸå¾Œã®åˆ‡æ›¿ãˆæ—¥ï¼ˆYYYY-MM-DDï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', current);
      if (!newDate) return;

      // ç°¡æ˜“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!/^\d{4}-\d{2}-\d{2}$/.test(newDate)){
        alert('æ—¥ä»˜å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆYYYY-MM-DDï¼‰');
        return;
      }

      const user = auth.currentUser;
      try{
        await updateDoc(doc(db, 'changepoints', currentDetailItem._id), {
          switchStatus: 'postponed',
          occurrenceDate: newDate,
          postponedAt: serverTimestamp(),
          postponedBy: user ? (user.email || user.uid) : ''
        });
        alert('å»¶æœŸã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
        document.getElementById('detailModal').classList.remove('active');
      }catch(err){
        console.error(err);
        alert('å»¶æœŸç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™ãƒ»é€šä¿¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰');
      }
    }

    if (btnSwitchToday){
      btnSwitchToday.addEventListener('click', () => decideSwitchDate(ymdLocal(new Date()), 'today'));
    }
    if (btnSwitchDecide){
      btnSwitchDecide.addEventListener('click', () => {
        const v = document.getElementById('switchDateInput')?.value || '';
        decideSwitchDate(v, 'pick');
      });
    }
    if (btnSwitchComplete){
      btnSwitchComplete.addEventListener('click', () => completeSwitch());
    }
    if (btnSwitchCancel){
      btnSwitchCancel.addEventListener('click', () => cancelSwitch());
    }
    if (btnSwitchPostpone){
      btnSwitchPostpone.addEventListener('click', () => postponeSwitch());
    }


    // å±¥æ­´ã‹ã‚‰ã®ç·¨é›†
    window.openEditFromHistory = function(id) {
      openEditModal(id);
    };

    // å‰Šé™¤æ©Ÿèƒ½
    window.deleteChangepoint = async function(id) {
      if (!confirm('ã“ã®å¤‰åŒ–ç‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      try {
        await deleteDoc(doc(db, 'changepoints', id));
        alert('å‰Šé™¤ã—ã¾ã—ãŸ');
      } catch (err) {
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
      }
    };

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openEditModal(id) {
      const item = changepointData.find(x => x._id === id);
      if (!item) return;

      const container = document.getElementById('editFormContainer');
      container.innerHTML = `
        <input type="hidden" id="editId" value="${item._id}">
        <div class="form-row">
          <div class="form-group">
            <label>èµ·æ¡ˆéƒ¨ç½²</label>
            <select id="editPlannedDept">
              <option value="">é¸æŠ</option>
              ${masterDepartments.map(d => `<option value="${d}" ${item.planneddepartment === d ? 'selected' : ''}>${d}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label>å¤‰åŒ–ç‚¹åˆ†é¡</label>
            <select id="editCategory">
              <option value="">é¸æŠ</option>
              <option value="äºº" ${item.category === 'äºº' ? 'selected' : ''}>äºº</option>
              <option value="æ–¹æ³•" ${item.category === 'æ–¹æ³•' ? 'selected' : ''}>æ–¹æ³•</option>
              <option value="ææ–™" ${item.category === 'ææ–™' ? 'selected' : ''}>ææ–™</option>
              <option value="é‡‘å‹" ${item.category === 'é‡‘å‹' ? 'selected' : ''}>é‡‘å‹</option>
              <option value="è¨­å‚™" ${item.category === 'è¨­å‚™' ? 'selected' : ''}>è¨­å‚™</option>
              <option value="ãã®ä»–" ${item.category === 'ãã®ä»–' ? 'selected' : ''}>ãã®ä»–</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>ç™ºç”Ÿéƒ¨ç½²</label>
            <select id="editDepartment">
              <option value="">é¸æŠ</option>
              ${masterDepartments.map(d => `<option value="${d}" ${item.department === d ? 'selected' : ''}>${d}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label>ãƒ©ã‚¤ãƒ³å</label>
            <input type="text" id="editLineName" value="${escapeAttr(item.lineName || '')}" list="editLineList">
            <datalist id="editLineList">
              ${masterLines.map(l => `<option value="${l}">`).join('')}
            </datalist>
          </div>
        </div>
        <div class="form-group">
          <label>æ•´ç†No</label>
          <input type="text" id="editSerialNo" value="${escapeAttr(item.serialNo || '')}">
        </div>
        <div class="form-group">
          <label>å¤‰åŒ–ç‚¹å†…å®¹</label>
          <textarea id="editContent" style="min-height:120px;">${escapeHtml(item.content || '')}</textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>ç™ºç”Ÿæ—¥</label>
            <input type="date" id="editDate" value="${item.occurrenceDate || ''}">
          </div>
          <div class="form-group">
            <label>ç™ºç”Ÿæ™‚åˆ»</label>
            <input type="time" id="editTime" value="${item.occurrenceTime || ''}">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>å¯¾è±¡ãƒ­ãƒƒãƒˆ</label>
            <input type="text" id="editLot" value="${escapeAttr(item.lot || '')}">
          </div>
          <div class="form-group">
            <label>é–¢é€£è³‡æ–™</label>
            <input type="text" id="editDocument" value="${escapeAttr(item.document || '')}">
          </div>
        </div>
      `;

      document.getElementById('editModal').classList.add('active');
    }

    // ç·¨é›†ä¿å­˜
    document.getElementById('btnEditSave').addEventListener('click', async () => {
      const id = document.getElementById('editId').value;
      if (!id) return;

      const updates = {
        planneddepartment: document.getElementById('editPlannedDept').value,
        category: document.getElementById('editCategory').value,
        department: document.getElementById('editDepartment').value,
        lineName: document.getElementById('editLineName').value,
        serialNo: document.getElementById('editSerialNo').value,
        content: document.getElementById('editContent').value,
        occurrenceDate: document.getElementById('editDate').value,
        occurrenceTime: document.getElementById('editTime').value,
        lot: document.getElementById('editLot').value,
        document: document.getElementById('editDocument').value
      };

      try {
        await updateDoc(doc(db, 'changepoints', id), updates);
        alert('ä¿å­˜ã—ã¾ã—ãŸ');
        document.getElementById('editModal').classList.remove('active');
      } catch (err) {
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
      }
    });

    // ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    document.getElementById('btnEditCancel').addEventListener('click', () => {
      document.getElementById('editModal').classList.remove('active');
    });
    document.getElementById('editClose').addEventListener('click', () => {
      document.getElementById('editModal').classList.remove('active');
    });
    document.getElementById('editModal').addEventListener('click', (e) => {
      if (e.target.id === 'editModal') document.getElementById('editModal').classList.remove('active');
    });
  </script>
</body>
</html>
