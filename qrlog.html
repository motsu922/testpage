<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>QRログ閲覧（ページング 2000件/頁・最大10頁）</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{ --fg:#111; --muted:#6b7280; --border:#e5e7eb; --bg:#f8fafc; --accent:#0b3b75; }
  *{ box-sizing:border-box; }
  body{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin:0; color:var(--fg); background:var(--bg); }
  header{ background:#fff; border-bottom:1px solid var(--border); padding:12px 16px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; position:sticky; top:0; z-index:10; }
  h1{ font-size:20px; margin:0; }
  .badge{ font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--border); color:#94a3b8; }
  main{ padding:16px; }
  .panel{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:16px; }
  .row{ display:grid; gap:10px; grid-template-columns: repeat(6, minmax(160px,1fr)); align-items:end; }
  @media (max-width: 1100px){ .row{ grid-template-columns: 1fr 1fr; } }
  label{ font-size:12px; color:var(--muted); display:block; margin-bottom:4px; }
  input, select{ border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:14px; background:#fff; width:100%; }
  button{ border:1px solid var(--border); background:#fff; border-radius:10px; padding:8px 12px; cursor:pointer; font-size:14px; }
  button.primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
  button:disabled{ opacity:.5; cursor:not-allowed; }
  table{ width:100%; border-collapse: collapse; }
  th, td{ border-bottom:1px solid var(--border); padding:8px 10px; text-align:left; vertical-align:top; }
  th{ font-size:12px; color:var(--muted); position:sticky; top:0; background:#fff; z-index:5; }
  tbody tr:hover{ background:#fafafa; }
  .controls{ display:flex; gap:8px; align-items:center; margin-left:auto; }
  .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); }
  .ok{ background:#ebfbee; color:#1a7f37; border-color:#b7f0c0; }
  .ng{ background:#fff5f5; color:#d1242f; border-color:#ffd0d5; }
  .warn{ background:#fffbeb; color:#a16207; border-color:#fde68a; }
  .error{ color:#d1242f; font-size:13px; }
  .nowrap{ white-space:nowrap; }
  .tableWrap{ max-height: 62vh; overflow:auto; border:1px solid var(--border); border-radius:10px; }
  .small{ font-size:12px; color:var(--muted); }
  .right{ text-align:right; }
  .pager{ display:flex; gap:10px; align-items:center; }
</style>
</head>
<body>
<header>
  <h1>QRログ閲覧（ページング）</h1>
  <span id="fbStatus" class="badge">Firebase: 未接続</span>
  <div class="controls">
    <button id="btnExport">CSVエクスポート</button>
    <button id="btnReload" class="primary">1ページ目を再取得</button>
  </div>
</header>

<main>
  <section class="panel">
    <div class="row">
      <div>
        <label for="dateFrom">開始日</label>
        <input id="dateFrom" type="date" />
      </div>
      <div>
        <label for="dateTo">終了日</label>
        <input id="dateTo" type="date" />
      </div>
      <div>
        <label for="lineSel">生産ライン</label>
        <select id="lineSel"><option value="">すべて</option></select>
      </div>
      <div>
        <label for="slicedSel">切り出し</label>
        <select id="slicedSel"><option value="">すべて</option></select>
      </div>
      <div>
        <label for="judgeSel">結果</label>
        <select id="judgeSel">
          <option value="">すべて</option>
          <option value="OK">OK</option>
          <option value="NG">NG</option>
          <option value="SET_BASE">SET_BASE</option>
          <option value="RESET">RESET</option>
          <option value="UNLOCK_BY_ADMIN">UNLOCK_BY_ADMIN</option>
          <option value="LOCK_REJECT">LOCK_REJECT</option>
        </select>
      </div>
      <div>
        <label for="lockSel">ロック状態</label>
        <select id="lockSel">
          <option value="">すべて</option>
          <option value="LOCKED">LOCKED</option>
          <option value="UNLOCK">UNLOCK</option>
        </select>
      </div>
    </div>
    <div class="right" style="margin-top:8px;">
      <button id="btnApply">フィルター適用</button>
      <span id="count" class="small"></span>
    </div>
    <div id="err" class="error" style="display:none; margin-top:6px;"></div>
  </section>

  <section class="panel">
    <div class="pager" style="margin: 0 0 8px 0;">
      <button id="btnPrev" disabled>前へ</button>
      <span id="pageInfo" class="small">ページ 1 / 10</span>
      <button id="btnNext" disabled>次へ</button>
    </div>
    <div class="tableWrap">
      <table id="tbl">
        <thead>
          <tr>
            <th class="nowrap">端末時刻</th>
            <th>生産ライン</th>
            <th>QR(raw)</th>
            <th class="nowrap">切出</th>
            <th class="nowrap">結果</th>
            <th class="nowrap">ロック</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, collection, query, orderBy, limit, getDocs, startAfter } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const fbStatus = document.getElementById("fbStatus");
  const tbody = document.getElementById("tbody");
  const btnExport = document.getElementById("btnExport");
  const btnReload = document.getElementById("btnReload");
  const btnApply = document.getElementById("btnApply");
  const btnPrev = document.getElementById("btnPrev");
  const btnNext = document.getElementById("btnNext");
  const pageInfo = document.getElementById("pageInfo");
  const errEl = document.getElementById("err");
  const countEl = document.getElementById("count");

  const lineSel = document.getElementById("lineSel");
  const slicedSel = document.getElementById("slicedSel");
  const judgeSel = document.getElementById("judgeSel");
  const lockSel = document.getElementById("lockSel");
  const dateFrom = document.getElementById("dateFrom");
  const dateTo = document.getElementById("dateTo");

  // ========= Firebase 設定（miyamaunitec-fb87a へ切替） =========
  const firebaseConfig = {
    apiKey: "AIzaSyAOMRoojKv9Hnh3OjVGwYV_k1LBTGOKepY",
    authDomain: "miyamaunitec-fb87a.firebaseapp.com",
    databaseURL: "https://miyamaunitec-fb87a-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "miyamaunitec-fb87a",
    storageBucket: "miyamaunitec-fb87a.firebasestorage.app",
    messagingSenderId: "495316649507",
    appId: "1:495316649507:web:1f98ee3dd851474fa39396",
    measurementId: "G-1NXD8ZPGNR"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  function setFbStatus(t, ok){
    fbStatus.textContent = "Firebase: " + t;
    fbStatus.style.color = ok ? "#16a34a" : "#d1242f";
  }
  function showErr(msg){
    errEl.style.display = "block";
    errEl.textContent = msg;
  }
  function clearErr(){
    errEl.style.display = "none";
    errEl.textContent = "";
  }

  // 接続（匿名認証）
  try{
    await signInAnonymously(auth);
    setFbStatus("接続済み", true);
  }catch(e){
    console.warn(e);
    setFbStatus("未接続", false);
    showErr(`Authエラー: ${e.code || ""} ${e.message || e}`);
  }

  const PER_PAGE = 2000;
  const MAX_PAGES = 10;

  let currentPage = 1;
  let pageCursors = [null];
  let currentDocs = [];

  function pill(j){
    const s=document.createElement("span");
    s.className="pill "+(j==="OK"?"ok":j==="NG"?"ng":"warn");
    s.textContent=j || "";
    return s;
  }
  function clearTable(){ tbody.innerHTML=""; }

  function parseClientDate(tsStr){
    if (!tsStr) return null;
    const m = tsStr.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2}):(\d{2})$/);
    if (!m) return null;
    const [_, y, mo, d, h, mi, s] = m.map(Number);
    return new Date(y, mo-1, d, h, mi, s);
  }

  function uniqueSorted(values){
    return Array.from(new Set(values.filter(v => v != null && v !== ""))).sort((a, b) => {
      const sa=String(a), sb=String(b);
      return sa.localeCompare(sb, "ja");
    });
  }

  function populateSelectors(data){
    const lines = uniqueSorted(data.map(r => r.line || ""));
    const sliced = uniqueSorted(data.map(r => r.sliced || ""));

    const fill = (sel, arr) => {
      const cur = sel.value;
      sel.innerHTML = "<option value=''>すべて</option>" + arr.map(v => `<option value="${String(v).replace(/"/g, '&quot;')}">${v}</option>`).join("");
      if (cur && arr.includes(cur)){ sel.value = cur; }
    };
    fill(lineSel, lines);
    fill(slicedSel, sliced);
  }

  function applyFilters(){
    clearErr();
    const fLine = lineSel.value.trim();
    const fSliced = slicedSel.value.trim();
    const fJudge = judgeSel.value.trim();
    const fLock  = lockSel.value.trim();

    let fromDate = null, toDate = null;
    if (dateFrom.value){ fromDate = new Date(dateFrom.value + "T00:00:00"); }
    if (dateTo.value){ toDate = new Date(dateTo.value + "T23:59:59"); }

    const filtered = currentDocs.filter(r => {
      if (fLine && r.line !== fLine) return false;
      if (fSliced && r.sliced !== fSliced) return false;

      const judge = r.judge || r.result || "";
      if (fJudge && judge !== fJudge) return false;

      const lockState = r.lockState || "";
      if (fLock && lockState !== fLock) return false;

      let dt = null;
      if (r.ts){ dt = parseClientDate(r.ts); }
      if (!dt && r.readAt && r.readAt.seconds){ dt = new Date(r.readAt.seconds*1000); }
      if (fromDate && dt && dt < fromDate) return false;
      if (toDate && dt && dt > toDate) return false;
      return true;
    });

    renderTable(filtered);
  }

  function renderTable(rows){
    clearTable();
    for (const d of rows){
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td class="nowrap">${d.ts||""}</td>
        <td>${d.line||""}</td>
        <td>${(d.raw||d.qrData||"")}</td>
        <td class="nowrap">${d.sliced||""}</td>
        <td class="nowrap"></td>
        <td class="nowrap">${d.lockState||""}</td>
      `;
      tr.children[4].appendChild(pill(d.judge||d.result||""));
      tbody.appendChild(tr);
    }
    countEl.textContent = `表示件数：${rows.length}（このページ全体：${currentDocs.length}）`;
  }

  async function fetchPage(pageNum){
    clearErr();
    clearTable();
    countEl.textContent = "読み込み中…";
    pageInfo.textContent = `ページ ${pageNum} / ${MAX_PAGES}`;

    try{
      const col = collection(db, "qrLogs");
      let qRef = query(col, orderBy("readAt","desc"), limit(PER_PAGE));

      const cursor = pageCursors[pageNum-1] || null;
      if (cursor) qRef = query(qRef, startAfter(cursor));

      const snap = await getDocs(qRef);
      currentDocs = [];
      snap.forEach(doc => currentDocs.push({ id: doc.id, ...doc.data() }));

      const lastDoc = snap.docs[snap.docs.length-1] || null;
      pageCursors[pageNum] = lastDoc;

      btnPrev.disabled = (pageNum === 1);
      btnNext.disabled = !(lastDoc && pageNum < MAX_PAGES);

      populateSelectors(currentDocs);
      applyFilters();
    }catch(e){
      console.warn(e);
      showErr(`Firestoreエラー: ${e.code || ""} ${e.message || e}`);
      countEl.textContent = "";
    }
  }

  // イベント
  btnApply.addEventListener("click", applyFilters);
  btnReload.addEventListener("click", async () => {
    currentPage = 1;
    pageCursors = [null];
    await fetchPage(currentPage);
  });
  btnPrev.addEventListener("click", async () => {
    if (currentPage <= 1) return;
    currentPage -= 1;
    await fetchPage(currentPage);
  });
  btnNext.addEventListener("click", async () => {
    if (currentPage >= MAX_PAGES) return;
    currentPage += 1;
    await fetchPage(currentPage);
  });

  btnExport.addEventListener("click", () => {
    const rows = [["clientTime","line","qrRaw","sliced","result","lockState"]];
    Array.from(tbody.children).forEach(tr => {
      const tds = Array.from(tr.children).map(td => td.textContent.trim());
      rows.push(tds);
    });
    const csv = rows.map(r => r.map(f => {
      const s = String(f ?? "");
      return /[\",\n]/.test(s) ? `"${s.replace(/\"/g,'\"\"')}"` : s;
    }).join(",")).join("\n");

    const blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `qrLogs_p${currentPage}_filtered.csv`; a.click();
    URL.revokeObjectURL(url);
  });

  // 初期日付（今日）
  const today = new Date();
  const y = today.getFullYear();
  const m = String(today.getMonth()+1).padStart(2,'0');
  const d = String(today.getDate()).padStart(2,'0');
  const todayStr = `${y}-${m}-${d}`;
  dateFrom.value = todayStr;
  dateTo.value = todayStr;

  // 初回ロード
  fetchPage(currentPage);
</script>

</body>
</html>
