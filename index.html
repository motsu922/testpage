<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>検査データ入力</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#667eea;min-height:100vh;padding:3px;font-size:11px}
.container{max-width:100%;margin:0 auto;background:#fff;border-radius:6px;box-shadow:0 3px 10px rgba(0,0,0,.1);overflow:hidden}
.header{background:linear-gradient(135deg,#2c3e50,#3498db);color:#fff;padding:6px;text-align:center}
.header h1{font-size:16px;margin-bottom:2px}
.header p{font-size:10px}
.main{display:grid;grid-template-columns:1fr 240px;min-height:calc(100vh - 80px)}
.table-section{padding:6px;background:#f8f9fa;overflow-x:auto}
.input-panel{background:#fff;border-left:1px solid #e9ecef;padding:6px;overflow-y:auto;max-height:calc(100vh - 80px)}
.data-table{width:100%;border-collapse:collapse;background:#fff;border-radius:4px;overflow:hidden;box-shadow:0 1px 5px rgba(0,0,0,.08)}
.data-table th{background:linear-gradient(135deg,#4a90e2,#357abd);color:#fff;padding:4px 2px;text-align:center;font-weight:600;font-size:9px;white-space:nowrap}
.data-table th.ng{background:linear-gradient(135deg,#f39c12,#e67e22);font-size:8px}
.data-table td{padding:4px 2px;text-align:center;border-bottom:1px solid #e9ecef;font-size:9px;cursor:pointer;white-space:nowrap}
.data-table td.ng{background:#fff8e1;font-weight:600;color:#f57c00}
.data-table tr:hover td{background:#f1f8ff}
.data-table tr.selected td{background:#e3f2fd;border-left:2px solid #2196f3}
.empty{text-align:center;padding:15px 6px;color:#6c757d;font-size:12px}
.group{margin-bottom:5px}
.label{display:block;font-weight:600;margin-bottom:2px;color:#2c3e50;font-size:10px}
.input,.select{width:100%;padding:4px;border:1px solid #e9ecef;border-radius:3px;font-size:10px;background:#f8f9fa}
.textarea{width:100%;padding:4px;border:1px solid #e9ecef;border-radius:3px;font-size:10px;background:#f8f9fa;resize:vertical;min-height:30px;font-family:inherit}
.time-group{display:flex;gap:3px;align-items:center}
.btn-now{padding:4px 6px;background:linear-gradient(135deg,#f39c12,#e67e22);color:#fff;border:none;border-radius:3px;font-size:9px;font-weight:600;cursor:pointer}
.btn{padding:4px 8px;border:none;border-radius:3px;font-size:10px;font-weight:600;cursor:pointer;margin:1px;min-height:22px;display:inline-flex;align-items:center;justify-content:center;gap:2px}
.btn-primary{background:linear-gradient(135deg,#4a90e2,#357abd);color:#fff}
.btn-success{background:linear-gradient(135deg,#27ae60,#229954);color:#fff}
.btn-danger{background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff}
.btn-secondary{background:linear-gradient(135deg,#95a5a6,#7f8c8d);color:#fff}
.btn-row{display:flex;flex-wrap:wrap;gap:2px;margin-top:5px}
.status{background:#2c3e50;color:#fff;padding:4px 6px;display:flex;justify-content:space-between;align-items:center;font-size:10px}
.counter{display:flex;align-items:center;border:1px solid #e9ecef;border-radius:3px;background:#fff;overflow:hidden}
.counter-btn{background:#f8f9fa;border:none;padding:2px 4px;font-size:12px;font-weight:bold;color:#495057;cursor:pointer;min-width:18px;height:18px;display:flex;align-items:center;justify-content:center}
.counter-btn.minus{color:#dc3545;border-right:1px solid #e9ecef}
.counter-btn.plus{color:#28a745;border-left:1px solid #e9ecef}
.counter-input{border:none;padding:2px;font-size:10px;text-align:center;background:#fff;min-width:25px;flex:1}
.ng-section{border:1px solid #e9ecef;border-radius:3px;padding:5px;margin-top:4px;background:#f8f9fa}
.ng-title{font-weight:600;color:#2c3e50;margin-bottom:4px;font-size:10px}
.counter-item{margin-bottom:4px}
.ng-info{background:#e3f2fd;border:1px solid #90caf9;color:#1565c0;padding:3px;border-radius:2px;margin-bottom:4px;font-size:9px}
.inspector-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:2px;margin-bottom:4px}
.inspector-item{display:flex;align-items:center;gap:1px;font-size:9px;white-space:nowrap}
.inspector-item input[type="checkbox"]{margin:0;transform:scale(0.7)}
@media(max-width:768px){
.main{grid-template-columns:1fr;grid-template-rows:300px 1fr}
.input-panel{border-left:none;border-top:1px solid #e9ecef;max-height:none}
.table-section{order:2}
.input-panel{order:1}
.inspector-grid{grid-template-columns:repeat(2,1fr)}
}
@media(max-width:480px){
.inspector-grid{grid-template-columns:repeat(2,1fr)}
.main{grid-template-rows:350px 1fr}
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>📊 検査データ入力システム</h1>
<p>NG項目列表示版</p>
</div>
<div class="main">
<div class="table-section">
<table class="data-table" id="tbl">
<thead id="thead"></thead>
<tbody id="tbody"></tbody>
</table>
<div id="empty" class="empty">
<p>📋 データがありません</p>
<p>右側のフォームからデータを入力してください</p>
</div>
</div>
<div class="input-panel">
<h3 style="margin-bottom:6px;color:#2c3e50;font-size:12px">📝 データ入力</h3>
<div class="group">
<label class="label">生産日付</label>
<input type="date" class="input" id="pd">
</div>
<div class="group">
<label class="label">整理No</label>
<select class="select" id="on">
<option value="">選択してください</option>
<option value="N0008">N0008</option>
<option value="N0006">N0006</option>
<option value="N0007">N0007</option>
</select>
</div>
<div class="group">
<label class="label">検査種類</label>
<select class="select" id="it2">
<option value="">選択してください</option>
<option value="A">A</option>
<option value="B">B</option>
<option value="C">C</option>
<option value="D">D</option>
<option value="E">E</option>
<option value="F">F</option>
<option value="G">G</option>
<option value="H">H</option>
</select>
</div>
<div class="group">
<label class="label">検査数</label>
<input type="number" class="input" id="ic" placeholder="例: 500">
</div>
<div class="group">
<label class="label">ロットNo</label>
<input type="text" class="input" id="ln" placeholder="例: LOT-001">
</div>
<div class="group">
<label class="label">検査開始時間</label>
<div class="time-group">
<input type="time" class="input" id="st">
<button class="btn-now" onclick="setNow('st')">Now</button>
</div>
</div>
<div class="group">
<label class="label">検査終了時間</label>
<div class="time-group">
<input type="time" class="input" id="et">
<button class="btn-now" onclick="setNow('et')">Now</button>
</div>
</div>
<div class="group">
<label class="label">検査員名</label>
<div class="inspector-grid">
<label class="inspector-item">
<input type="checkbox" id="in_A" value="検査員A" onchange="updateInspectors()">A
</label>
<label class="inspector-item">
<input type="checkbox" id="in_B" value="検査員B" onchange="updateInspectors()">B
</label>
<label class="inspector-item">
<input type="checkbox" id="in_C" value="検査員C" onchange="updateInspectors()">C
</label>
<label class="inspector-item">
<input type="checkbox" id="in_D" value="検査員D" onchange="updateInspectors()">D
</label>
<label class="inspector-item">
<input type="checkbox" id="in_E" value="検査員E" onchange="updateInspectors()">E
</label>
<label class="inspector-item">
<input type="checkbox" id="in_F" value="検査員F" onchange="updateInspectors()">F
</label>
<label class="inspector-item">
<input type="checkbox" id="in_G" value="検査員G" onchange="updateInspectors()">G
</label>
<label class="inspector-item">
<input type="checkbox" id="in_H" value="検査員H" onchange="updateInspectors()">H
</label>
</div>
<input type="text" class="input" id="in_custom" placeholder="その他の検査員名" onchange="updateInspectors()">
<div style="font-size:8px;color:#6c757d;margin-top:1px">選択: <span id="in_display">なし</span></div>
</div>
<div class="ng-section">
<div class="ng-title">🚫 NG項目カウンター</div>
<div id="ng">
<p style="color:#6c757d;text-align:center;font-size:9px">整理Noを選択してください</p>
</div>
</div>
<div class="group" style="margin-top:5px">
<label class="label">備考</label>
<textarea class="textarea" id="rm" placeholder="メモや特記事項を入力"></textarea>
</div>
<div class="btn-row">
<button class="btn btn-success" onclick="add()">➕ 追加</button>
<button class="btn btn-primary" onclick="update()">✏️ 更新</button>
</div>
<div class="btn-row">
<button class="btn btn-danger" onclick="del()">🗑️ 削除</button>
<button class="btn btn-secondary" onclick="clear()">🔄 クリア</button>
</div>
<div style="border-top:1px solid #e9ecef;margin:5px 0;padding-top:5px">
<h4 style="margin-bottom:3px;color:#2c3e50;font-size:11px">📊 Excel連携</h4>
<div class="btn-row">
<button class="btn btn-primary" onclick="exp()">📤 CSV出力</button>
<label class="btn btn-secondary" style="margin:0">
📥 CSV取込
<input type="file" accept=".csv" onchange="imp(event)" style="display:none">
</label>
</div>
</div>
</div>
</div>
<div class="status">
<span id="stat">データ入力準備完了</span>
<span id="cnt">行数: 0</span>
</div>
</div>

<script>
let sel=-1,data=[],items=[],cols=new Map();
const master={N0008:[{code:"125",name:"クラック黒"},{code:"126",name:"クラックグレー"},{code:"31",name:"落下"},{code:"54",name:"その他"}],N0006:[{code:"125",name:"クラック黒"},{code:"126",name:"クラックグレー"},{code:"31",name:"落下"},{code:"54",name:"その他"}],N0007:[{code:"125",name:"クラック黒"},{code:"126",name:"クラックグレー"},{code:"31",name:"落下"},{code:"54",name:"その他"}]};

function updateInspectors(){
try{
const s=[];
['A','B','C','D','E','F','G','H'].forEach(id=>{
const cb=document.getElementById(`in_${id}`);
if(cb?.checked)s.push(cb.value);
});
const c=document.getElementById('in_custom').value.trim();
if(c)s.push(c);
document.getElementById('in_display').textContent=s.length?s.join(', '):'なし';
}catch(e){console.error(e)}
}

function getInspectors(){
try{
const s=[];
['A','B','C','D','E','F','G','H'].forEach(id=>{
const cb=document.getElementById(`in_${id}`);
if(cb?.checked)s.push(cb.value);
});
const c=document.getElementById('in_custom').value.trim();
if(c)s.push(c);
return s.join(', ');
}catch(e){return ''}
}

function init(){
try{
document.getElementById('pd').value=new Date().toISOString().split('T')[0];
document.getElementById('on').addEventListener('change',updateNG);
document.getElementById('st').addEventListener('change',calcTime);
document.getElementById('et').addEventListener('change',calcTime);
updateCols();showEmpty();renderHeader();status('システム起動完了');
}catch(e){console.error(e)}
}

function status(m){
try{
document.getElementById('stat').textContent=m;
setTimeout(()=>document.getElementById('stat').textContent='データ入力準備完了',3000);
}catch(e){console.error(e)}
}

function updateCnt(){try{document.getElementById('cnt').textContent=`行数: ${data.length}`}catch(e){console.error(e)}}

function setNow(f){
try{
const n=new Date();
document.getElementById(f).value=String(n.getHours()).padStart(2,'0')+':'+String(n.getMinutes()).padStart(2,'0');
calcTime();
}catch(e){console.error(e)}
}

function calcTime(){
try{
const s=document.getElementById('st').value,e=document.getElementById('et').value;
if(s&&e){
const[sh,sm]=s.split(':').map(Number),[eh,em]=e.split(':').map(Number);
let sm2=sh*60+sm,em2=eh*60+em;
if(em2<sm2)em2+=1440;
return em2-sm2;
}
return '';
}catch(e){return ''}}

function changeCnt(id,c){
try{
const i=document.getElementById(id);
if(i)i.value=Math.max(0,(parseInt(i.value)||0)+c);
}catch(e){console.error(e)}
}

function validateCnt(i){try{if(parseInt(i.value)<0)i.value=0}catch(e){console.error(e)}}

function updateCols(){
try{
cols.clear();
Object.values(master).forEach(its=>its.forEach(it=>cols.set(it.code,it.name)));
}catch(e){console.error(e)}
}

function updateNG(){
try{
const o=document.getElementById('on').value,c=document.getElementById('ng');
if(!o){c.innerHTML='<p style="color:#6c757d;text-align:center;font-size:9px">整理Noを選択してください</p>';items=[];return}
const its=master[o]||[];
const sorted=[],bottom=['31','54'];
its.forEach(it=>{if(!bottom.includes(it.code))sorted.push(it)});
its.forEach(it=>{if(it.code==='31')sorted.push(it)});
its.forEach(it=>{if(it.code==='54')sorted.push(it)});
items=sorted;
c.innerHTML=`<div class="ng-info">📌 整理No「${o}」のNG項目（${its.length}項目）</div>`;
sorted.forEach((it,i)=>{
const d=document.createElement('div');d.className='counter-item';
d.innerHTML=`<label class="label">${it.code}（${it.name}）</label><div class="counter"><button class="counter-btn minus" onclick="changeCnt('ng_${i}',-1)">−</button><input type="number" class="counter-input" id="ng_${i}" value="0" min="0" onchange="validateCnt(this)"><button class="counter-btn plus" onclick="changeCnt('ng_${i}',1)">＋</button></div>`;
c.appendChild(d);
});
}catch(e){console.error(e)}
}

function renderHeader(){
try{
const h=document.getElementById('thead');h.innerHTML='';
const r=document.createElement('tr');
['生産日付','整理No','検査数','検査時間（分）','ロットNo','検査開始時間','検査終了時間','検査種類','検査員名'].forEach(t=>{
const th=document.createElement('th');th.textContent=t;r.appendChild(th);
});
Array.from(cols.entries()).sort().forEach(([c,n])=>{
const th=document.createElement('th');th.className='ng';th.innerHTML=`${c}<br>${n}`;r.appendChild(th);
});
const th=document.createElement('th');th.textContent='備考';r.appendChild(th);h.appendChild(r);
}catch(e){console.error(e)}
}

function render(){
try{
const b=document.getElementById('tbody');b.innerHTML='';
data.forEach((d,i)=>{
const r=document.createElement('tr');r.onclick=()=>select(i);
[d.pd,d.on,d.ic,d.it,d.ln,d.st,d.et,d.it2,d.in].forEach(v=>{
const td=document.createElement('td');td.textContent=v||'';r.appendChild(td);
});
Array.from(cols.keys()).sort().forEach(c=>{
const td=document.createElement('td');td.className='ng';td.textContent=d.ngMap?.get(c)||'0';r.appendChild(td);
});
const td=document.createElement('td');td.textContent=d.rm||'';r.appendChild(td);b.appendChild(r);
});
showEmpty();
}catch(e){console.error(e)}
}

function showEmpty(){try{document.getElementById('empty').style.display=data.length===0?'block':'none'}catch(e){console.error(e)}}

function select(i){
try{
document.querySelectorAll('#tbody tr').forEach(r=>r.classList.remove('selected'));
document.querySelectorAll('#tbody tr')[i]?.classList.add('selected');
sel=i;
const d=data[i];
document.getElementById('pd').value=d.pd.replace(/\//g,'-');
document.getElementById('on').value=d.on;
document.getElementById('ic').value=d.ic;
document.getElementById('ln').value=d.ln||'';
document.getElementById('st').value=d.st||'';
document.getElementById('et').value=d.et||'';
document.getElementById('it2').value=d.it2||'';
document.getElementById('rm').value=d.rm||'';
['A','B','C','D','E','F','G','H'].forEach(id=>document.getElementById(`in_${id}`).checked=false);
document.getElementById('in_custom').value='';
const ins=d.in||'';
if(ins){
const iList=ins.split(', ').filter(n=>n.trim());
const cNames=[];
iList.forEach(n=>{
if(n==='検査員A')document.getElementById('in_A').checked=true;
else if(n==='検査員B')document.getElementById('in_B').checked=true;
else if(n==='検査員C')document.getElementById('in_C').checked=true;
else if(n==='検査員D')document.getElementById('in_D').checked=true;
else if(n==='検査員E')document.getElementById('in_E').checked=true;
else if(n==='検査員F')document.getElementById('in_F').checked=true;
else if(n==='検査員G')document.getElementById('in_G').checked=true;
else if(n==='検査員H')document.getElementById('in_H').checked=true;
else if(n.trim())cNames.push(n);
});
if(cNames.length>0)document.getElementById('in_custom').value=cNames.join(', ');
}
updateInspectors();updateNG();
if(d.ngMap){
items.forEach((it,idx)=>{
const c=document.getElementById(`ng_${idx}`);
if(c)c.value=d.ngMap.get(it.code)||'0';
});
}
}catch(e){console.error(e)}
}

function add(){
try{
const o=document.getElementById('on').value;
if(!o){alert('整理Noを選択してください');return}
const m=new Map();
items.forEach((it,i)=>{
const v=document.getElementById(`ng_${i}`)?.value;
if(v&&v!=='0')m.set(it.code,v);
});
const ct=calcTime();
data.push({pd:document.getElementById('pd').value.replace(/-/g,'/'),on:o,ic:document.getElementById('ic').value||'0',it:ct||'0',ln:document.getElementById('ln').value||'',st:document.getElementById('st').value||'',et:document.getElementById('et').value||'',it2:document.getElementById('it2').value||'',in:getInspectors(),ngMap:m,rm:document.getElementById('rm').value||''});
renderHeader();render();clear();status('新しい行を追加しました');updateCnt();
}catch(e){console.error(e);alert('データの追加に失敗しました')}}

function update(){
try{
if(sel<0){status('更新する行を選択してください');return}
const o=document.getElementById('on').value;
if(!o){alert('整理Noを選択してください');return}
const m=new Map();
items.forEach((it,i)=>{
const v=document.getElementById(`ng_${i}`)?.value;
if(v&&v!=='0')m.set(it.code,v);
});
const ct=calcTime();
data[sel]={pd:document.getElementById('pd').value.replace(/-/g,'/'),on:o,ic:document.getElementById('ic').value||'0',it:ct||'0',ln:document.getElementById('ln').value||'',st:document.getElementById('st').value||'',et:document.getElementById('et').value||'',it2:document.getElementById('it2').value||'',in:getInspectors(),ngMap:m,rm:document.getElementById('rm').value||''};
renderHeader();render();status('行を更新しました');
}catch(e){console.error(e);alert('データの更新に失敗しました')}}

function del(){
try{
if(sel<0){status('削除する行を選択してください');return}
if(confirm('選択した行を削除しますか？')){
data.splice(sel,1);sel=-1;renderHeader();render();clear();status('行を削除しました');updateCnt();
}
}catch(e){console.error(e);alert('データの削除に失敗しました')}}

function clear(){
try{
document.getElementById('pd').value=new Date().toISOString().split('T')[0];
document.getElementById('on').value='';
document.getElementById('ic').value='';
document.getElementById('ln').value='';
document.getElementById('st').value='';
document.getElementById('et').value='';
document.getElementById('it2').value='';
['A','B','C','D','E','F','G','H'].forEach(id=>document.getElementById(`in_${id}`).checked=false);
document.getElementById('in_custom').value='';
updateInspectors();
document.getElementById('rm').value='';
updateNG();sel=-1;
}catch(e){console.error(e)}
}

function exp(){
try{
if(data.length===0){status('エクスポートするデータがありません');return}
const h=['生産日付','整理No','検査数','検査時間（分）','ロットNo','検査開始時間','検査終了時間','検査種類','検査員名'];
const nc=Array.from(cols.keys()).sort();
const usedNgCodes=new Set();
data.forEach(row=>{
if(row.ngMap){
row.ngMap.forEach((value,code)=>{
if(value&&value!=='0')usedNgCodes.add(code);
});
}
});
const filteredNc=nc.filter(code=>usedNgCodes.has(code));
const ah=[...h,...filteredNc,'備考'];
const r=data.map(row=>{
const bd=[row.pd||'',row.on||'',row.ic||'0',row.it||'0',row.ln||'',row.st||'',row.et||'',row.it2||'',row.in||''];
const nd=filteredNc.map(c=>row.ngMap?.get(c)||'0');
return[...bd,...nd,row.rm||''];
});
const csv=[ah.join(','),...r.map(row=>row.map(c=>`"${c}"`).join(','))].join('\n');
const b=new Blob([new Uint8Array([0xEF,0xBB,0xBF]),csv],{type:'text/csv;charset=utf-8'});
const l=document.createElement('a');
l.href=URL.createObjectURL(b);
l.download=`inspection_data_${new Date().toISOString().replace(/[:.]/g,'-').slice(0,-5)}.csv`;
l.click();
const totalNg=nc.length,exportedNg=filteredNc.length;
status(`CSVファイルをエクスポートしました（NG項目: ${exportedNg}/${totalNg}列）`);
}catch(e){console.error(e);alert('CSV出力に失敗しました')}}

function imp(e){
try{
const f=e.target.files[0];
if(!f)return;
const r=new FileReader();
r.onload=function(ev){
try{
let t=ev.target.result;
if(t.charCodeAt(0)===0xFEFF)t=t.substring(1);
const l=t.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n');
if(l.length<2)throw new Error('CSVファイルにデータがありません');
const h=l[0].split(',').map(h=>h.replace(/^"|"$/g,'').trim());
const id=[];
for(let i=1;i<l.length;i++){
const ln=l[i].trim();
if(!ln)continue;
const v=ln.split(',').map(v=>v.replace(/^"|"$/g,'').trim());
if(v.length<9)continue;
const m=new Map();
for(let j=9;j<h.length-1;j++){
const hd=h[j];
if(hd.match(/^\d+$/)){
const vl=v[j]||'0';
if(vl!=='0')m.set(hd,vl);
}
}
id.push({pd:v[0]||'',on:v[1]||'',ic:v[2]||'0',it:v[3]||'0',ln:v[4]||'',st:v[5]||'',et:v[6]||'',it2:v[7]||'',in:v[8]||'',ngMap:m,rm:v[v.length-1]||''});
}
if(id.length===0)throw new Error('有効なデータが見つかりませんでした');
if(confirm(`${id.length}件のデータをインポートしますか？`)){
data=id;sel=-1;updateCols();renderHeader();render();clear();updateCnt();status(`${id.length}件のデータをインポートしました`);
}
}catch(err){alert(`CSVファイルの読み込みに失敗しました：${err.message}`)}
};
r.readAsText(f,'UTF-8');e.target.value='';
}catch(e){console.error(e);alert('ファイル読み込みに失敗しました')}}

document.addEventListener('DOMContentLoaded',init);
</script>

</body>
</html>
