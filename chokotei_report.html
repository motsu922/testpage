<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ§ã‚³åœè¨˜éŒ²ã‚¢ãƒ—ãƒª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .nav-tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: bold;
            color: #666;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .content {
            padding: 20px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 15px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            text-align: center;
        }

        .btn:hover {
            background: #f0f4ff;
        }

        .btn.selected {
            background: #667eea;
            color: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            width: 100%;
            font-size: 16px;
            margin-top: 10px;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-success {
            background: #28a745;
            color: white;
            border: none;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            font-size: 12px;
            padding: 5px 10px;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea.input-field {
            min-height: 80px;
            resize: vertical;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .period-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .period-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .period-btn.active {
            background: #667eea;
            color: white;
        }

        .master-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .master-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .anomaly-btn {
            position: relative;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .anomaly-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        .date-range {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .date-range input {
            flex: 1;
        }

        canvas {
            max-width: 100%;
        }

        .equipment-detail {
            margin-top: 20px;
        }

        .optional-fields {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .optional-field-group {
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ ãƒãƒ§ã‚³åœè¨˜éŒ²ã‚¢ãƒ—ãƒª</h1>
            <p>è¨­å‚™ç•°å¸¸ã®å³æ™‚è¨˜éŒ²ãƒ»å¯è¦–åŒ–ã‚·ã‚¹ãƒ†ãƒ </p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('input', this)">å…¥åŠ›</button>
            <button class="nav-tab" onclick="switchTab('view', this)">ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</button>
            <button class="nav-tab" onclick="switchTab('master', this)">ãƒã‚¹ã‚¿ãƒ¼ç®¡ç†</button>
        </div>

        <div class="content">
            <!-- å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="input-section" class="section active">
                <div id="success-msg" class="success-message"></div>
                
                <div class="form-group">
                    <label class="form-label">å‡¦ç½®è€…ã‚’é¸æŠ</label>
                    <div id="operator-buttons" class="button-group"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">è¨­å‚™åã‚’é¸æŠ</label>
                    <div id="equipment-buttons" class="button-group"></div>
                </div>

                <div id="anomaly-section" class="form-group hidden">
                    <label class="form-label">ç•°å¸¸åã‚’é¸æŠ</label>
                    <div id="anomaly-buttons" class="button-group"></div>
                </div>

                <div id="organization-no-section" class="form-group hidden">
                    <label class="form-label">æ•´ç†Noã‚’é¸æŠ</label>
                    <div id="organization-no-buttons" class="button-group"></div>
                </div>

                <div id="optional-fields-section" class="optional-fields hidden">
                    <label class="form-label">ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®</label>
                    <div id="optional-fields-container"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
                    <textarea id="remarks" class="input-field" placeholder="å‚™è€ƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                </div>

                <button class="btn btn-primary" onclick="saveRecord()">ä¿å­˜</button>
            </div>

            <!-- ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="view-section" class="section">
                <div class="form-group">
                    <label class="form-label">è¨­å‚™ã‚’é¸æŠ</label>
                    <div id="view-equipment-buttons" class="button-group"></div>
                </div>

                <div id="stats-container" class="hidden">
                    <div class="stats-card">
                        <h3>ğŸ“Š ç•°å¸¸ç™ºç”Ÿçµ±è¨ˆ</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="today-count">0</div>
                                <div class="stat-label">ä»Šæ—¥ã®ç•°å¸¸ä»¶æ•°</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="yesterday-count">0</div>
                                <div class="stat-label">æ˜¨æ—¥ã®ç•°å¸¸ä»¶æ•°<br>(åœŸæ—¥é™¤ã)</div>
                            </div>
                        </div>
                    </div>

                    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="chart-container">
                        <h4>ğŸ” ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h4>
                        <div class="form-group">
                            <label class="form-label">ç•°å¸¸åã§çµã‚Šè¾¼ã¿</label>
                            <select id="filter-anomaly" class="input-field" onchange="applyFilters()">
                                <option value="">ã™ã¹ã¦</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ•´ç†Noã§çµã‚Šè¾¼ã¿</label>
                            <select id="filter-organization-no" class="input-field" onchange="applyFilters()">
                                <option value="">ã™ã¹ã¦</option>
                            </select>
                        </div>
                        <button class="btn" onclick="clearFilters()" style="width: 100%;">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢</button>
                    </div>

                    <div class="chart-container">
                        <h4>ğŸ“ˆ ç•°å¸¸ä»¶æ•°æ¨ç§»</h4>
                        <div class="period-selector">
                            <button class="period-btn active" onclick="changePeriod('day', this)">æ—¥åˆ¥</button>
                            <button class="period-btn" onclick="changePeriod('week', this)">é€±åˆ¥</button>
                            <button class="period-btn" onclick="changePeriod('month', this)">æœˆåˆ¥</button>
                        </div>
                        <div class="date-range">
                            <input type="date" id="start-date" class="input-field" onchange="updateChart()">
                            <input type="date" id="end-date" class="input-field" onchange="updateChart()">
                        </div>
                        <canvas id="trend-chart"></canvas>
                    </div>

                    <!-- ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« -->
                    <div class="chart-container">
                        <h4>ğŸ“‹ è¨˜éŒ²ä¸€è¦§</h4>
                        <div id="records-table-container" style="overflow-x: auto;">
                            <table id="records-table" style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f5f5f5; text-align: left;">
                                        <th style="padding: 10px; border-bottom: 2px solid #ddd;">æ—¥æ™‚</th>
                                        <th style="padding: 10px; border-bottom: 2px solid #ddd;">ç•°å¸¸å</th>
                                        <th style="padding: 10px; border-bottom: 2px solid #ddd;">æ•´ç†No</th>
                                        <th style="padding: 10px; border-bottom: 2px solid #ddd;">å‡¦ç½®è€…</th>
                                    </tr>
                                </thead>
                                <tbody id="records-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒã‚¹ã‚¿ãƒ¼ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="master-section" class="section">
                <div class="form-group">
                    <h3>ğŸ‘¥ å‡¦ç½®è€…ç®¡ç†</h3>
                    <div class="master-controls">
                        <input type="text" id="new-operator" class="input-field" placeholder="å‡¦ç½®è€…åã‚’å…¥åŠ›" style="flex: 1;">
                        <button class="btn btn-success" onclick="addOperator()">è¿½åŠ </button>
                    </div>
                    <div id="operator-list"></div>
                </div>

                <div class="form-group">
                    <h3>ğŸ­ è¨­å‚™åç®¡ç†</h3>
                    <div class="master-controls">
                        <input type="text" id="new-equipment" class="input-field" placeholder="è¨­å‚™åã‚’å…¥åŠ›" style="flex: 1;">
                        <button class="btn btn-success" onclick="addEquipment()">è¿½åŠ </button>
                    </div>
                    <div id="equipment-list"></div>
                </div>

                <div class="form-group">
                    <h3>ğŸ”¢ æ•´ç†Noç®¡ç†</h3>
                    <div class="master-controls">
                        <select id="equipment-select-no" class="input-field" style="flex: 1;" onchange="loadOrganizationNos()">
                            <option value="">è¨­å‚™ã‚’é¸æŠ</option>
                        </select>
                    </div>
                    <div id="organization-no-management" class="hidden">
                        <div class="master-controls">
                            <input type="text" id="new-organization-no" class="input-field" placeholder="æ•´ç†No" style="flex: 1;">
                            <button class="btn btn-success" onclick="addOrganizationNo()">è¿½åŠ </button>
                        </div>
                        <div id="organization-no-list"></div>
                    </div>
                </div>

                <div class="form-group">
                    <h3>âš ï¸ ç•°å¸¸åç®¡ç†</h3>
                    <div class="master-controls">
                        <select id="equipment-select" class="input-field" style="flex: 1;" onchange="loadAnomalies()">
                            <option value="">è¨­å‚™ã‚’é¸æŠ</option>
                        </select>
                    </div>
                    <div id="anomaly-management" class="hidden">
                        <div class="master-controls">
                            <input type="text" id="new-anomaly-name" class="input-field" placeholder="ç•°å¸¸å" style="flex: 1;">
                            <button class="btn btn-success" onclick="addAnomaly()">è¿½åŠ </button>
                        </div>
                        
                        <div class="optional-field-group">
                            <h4>ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®è¨­å®š</h4>
                            <div id="optional-field-settings" style="font-size: 13px; color: #555;">
                                ç•°å¸¸åã‚’é¸æŠã™ã‚‹ã¨ã€ã“ã“ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                            </div>
                            <button class="btn" onclick="addOptionalField()" style="width: 100%; margin-top: 10px;">+ ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®ã‚’è¿½åŠ </button>
                        </div>
                        
                        <div id="anomaly-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://unpkg.com/chart.js@3.9.1/dist/chart.min.js"></script>

    <script>
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBP_PxZ6Gio7BJW2F-UCIfrKy5t7y3WGhM",
            authDomain: "chokoteiapp.firebaseapp.com",
            databaseURL: "https://chokoteiapp-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "chokoteiapp",
            storageBucket: "chokoteiapp.firebasestorage.app",
            messagingSenderId: "668171085030",
            appId: "1:668171085030:web:f34cbbb7fa56d59191c727"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let selectedOperator = null;
        let selectedEquipment = null;
        let selectedAnomaly = null; // { ...anomaly, id }
        let selectedOrganizationNo = null;
        let currentViewEquipment = null;
        let currentPeriod = 'day';
        let chart = null;
        let todayAnomalyCounts = {};
        let allRecords = [];
        let currentFilterAnomaly = '';
        let currentFilterOrganizationNo = '';

        // ãƒã‚¹ã‚¿ãƒ¼ç”»é¢ç”¨ï¼šã©ã®ç•°å¸¸ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç·¨é›†ã—ã¦ã„ã‚‹ã‹
        let masterSelectedEquipmentForOptions = null;
        let masterSelectedAnomalyForOptions = null;

        // ã‚¿ãƒ–åˆ‡æ›¿
        function switchTab(tabName, clickedButton) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            
            clickedButton.classList.add('active');
            document.getElementById(`${tabName}-section`).classList.add('active');
            
            if (tabName === 'input') {
                loadInputScreen();
            } else if (tabName === 'view') {
                loadViewScreen();
            } else if (tabName === 'master') {
                loadMasterScreen();
            }
        }

        // å…¥åŠ›ç”»é¢èª­ã¿è¾¼ã¿
        function loadInputScreen() {
            loadOperators();
            loadEquipments();
        }

        // å‡¦ç½®è€…èª­ã¿è¾¼ã¿
        function loadOperators() {
            database.ref('masters/operators').once('value', snapshot => {
                const operators = snapshot.val() || {};
                const container = document.getElementById('operator-buttons');
                container.innerHTML = '';
                
                Object.keys(operators).forEach(key => {
                    const btn = document.createElement('button');
                    btn.className = 'btn';
                    btn.textContent = operators[key].name;
                    btn.onclick = () => selectOperator(operators[key].name, btn);
                    container.appendChild(btn);
                });
            });
        }

        // è¨­å‚™èª­ã¿è¾¼ã¿
        function loadEquipments() {
            database.ref('masters/equipments').once('value', snapshot => {
                const equipments = snapshot.val() || {};
                const container = document.getElementById('equipment-buttons');
                container.innerHTML = '';
                
                Object.keys(equipments).forEach(key => {
                    const btn = document.createElement('button');
                    btn.className = 'btn';
                    btn.textContent = equipments[key].name;
                    btn.onclick = () => selectEquipment(equipments[key].name, key, btn);
                    container.appendChild(btn);
                });
            });
        }

        // å‡¦ç½®è€…é¸æŠ
        function selectOperator(name, btn) {
            document.querySelectorAll('#operator-buttons .btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedOperator = name;
        }

        // è¨­å‚™é¸æŠ
        function selectEquipment(name, id, btn) {
            document.querySelectorAll('#equipment-buttons .btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedEquipment = id;

            // ä¸€æ—¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç³»ã‚’ãƒªã‚»ãƒƒãƒˆ
            selectedAnomaly = null;
            selectedOrganizationNo = null;
            document.getElementById('organization-no-section').classList.add('hidden');
            document.getElementById('optional-fields-section').classList.add('hidden');

            // ã¾ãšä»¶æ•°ãªã—ã§ç•°å¸¸ãƒœã‚¿ãƒ³è¡¨ç¤º
            todayAnomalyCounts = {};
            loadAnomalyButtons(id);

            // ä»Šæ—¥ã®ä»¶æ•°ã‚’å–å¾—ã—ã¦ã‹ã‚‰ãƒãƒƒã‚¸æç”»
            const today = new Date().toISOString().split('T')[0];
            database
                .ref('records')
                .orderByChild('date')
                .equalTo(today)
                .once('value')
                .then(snapshot => {
                    todayAnomalyCounts = {};
                    snapshot.forEach(child => {
                        const record = child.val();
                        if (record.equipmentId === id) {
                            const anomalyName = record.anomalyName;
                            todayAnomalyCounts[anomalyName] = (todayAnomalyCounts[anomalyName] || 0) + 1;
                        }
                    });
                    loadAnomalyButtons(id);
                })
                .catch(error => {
                    console.error('ä»Šæ—¥ã®ä»¶æ•°ã®å–å¾—ã«å¤±æ•—:', error);
                });
        }

        // ç•°å¸¸ãƒœã‚¿ãƒ³èª­ã¿è¾¼ã¿
        function loadAnomalyButtons(equipmentId) {
            database.ref(`masters/equipments/${equipmentId}/anomalies`).once('value', snapshot => {
                const anomalies = snapshot.val() || {};
                const container = document.getElementById('anomaly-buttons');
                const section = document.getElementById('anomaly-section');
                container.innerHTML = '';
                
                if (Object.keys(anomalies).length > 0) {
                    section.classList.remove('hidden');
                    
                    Object.keys(anomalies).forEach(key => {
                        const anomaly = anomalies[key];
                        const btn = document.createElement('button');
                        btn.className = 'btn anomaly-btn';
                        btn.textContent = anomaly.name;
                        
                        const count = todayAnomalyCounts[anomaly.name] || 0;
                        if (count > 0) {
                            const badge = document.createElement('div');
                            badge.className = 'anomaly-count';
                            badge.textContent = count;
                            btn.appendChild(badge);
                        }
                        
                        btn.onclick = () => selectAnomaly(anomaly, key, btn);
                        container.appendChild(btn);
                    });
                } else {
                    section.classList.add('hidden');
                }
            });
        }

        // ç•°å¸¸é¸æŠ
        function selectAnomaly(anomaly, id, btn) {
            document.querySelectorAll('#anomaly-buttons .btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedAnomaly = { ...anomaly, id };

            // æ•´ç†No
            loadOrganizationNoButtons(selectedEquipment);

            // ç•°å¸¸ã”ã¨ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®
            loadOptionalFields(selectedEquipment, id);
        }

        // æ•´ç†Noãƒœã‚¿ãƒ³
        function loadOrganizationNoButtons(equipmentId) {
            database.ref(`masters/equipments/${equipmentId}/organizationNos`).once('value', snapshot => {
                const organizationNos = snapshot.val() || {};
                const container = document.getElementById('organization-no-buttons');
                const section = document.getElementById('organization-no-section');
                container.innerHTML = '';
                
                if (Object.keys(organizationNos).length > 0) {
                    section.classList.remove('hidden');
                    
                    Object.keys(organizationNos).forEach(key => {
                        const orgNo = organizationNos[key];
                        const btn = document.createElement('button');
                        btn.className = 'btn';
                        btn.textContent = orgNo.no;
                        btn.onclick = () => selectOrganizationNo(orgNo.no, btn);
                        container.appendChild(btn);
                    });
                } else {
                    section.classList.add('hidden');
                }
            });
        }

        function selectOrganizationNo(no, btn) {
            document.querySelectorAll('#organization-no-buttons .btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedOrganizationNo = no;
        }

        // ç•°å¸¸ã”ã¨ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®ã‚’èª­ã¿è¾¼ã¿
        function loadOptionalFields(equipmentId, anomalyId) {
            const container = document.getElementById('optional-fields-container');
            const section = document.getElementById('optional-fields-section');

            if (!equipmentId || !anomalyId) {
                section.classList.add('hidden');
                container.innerHTML = '';
                return;
            }

            database
                .ref(`masters/equipments/${equipmentId}/anomalies/${anomalyId}/optionalFields`)
                .once('value')
                .then(snapshot => {
                    const fields = snapshot.val() || {};
                    container.innerHTML = '';

                    const keys = Object.keys(fields);
                    if (keys.length === 0) {
                        section.classList.add('hidden');
                        return;
                    }

                    section.classList.remove('hidden');

                    keys.forEach(key => {
                        const field = fields[key];
                        const fieldDiv = document.createElement('div');
                        fieldDiv.className = 'form-group';

                        const label = document.createElement('label');
                        label.className = 'form-label';
                        label.textContent = field.name;

                        const select = document.createElement('select');
                        select.className = 'input-field';
                        select.id = `optional-${key}`;

                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = 'é¸æŠã—ã¦ãã ã•ã„';
                        select.appendChild(defaultOption);

                        (field.options || []).forEach(option => {
                            const opt = document.createElement('option');
                            opt.value = option;
                            opt.textContent = option;
                            select.appendChild(opt);
                        });

                        fieldDiv.appendChild(label);
                        fieldDiv.appendChild(select);
                        container.appendChild(fieldDiv);
                    });
                })
                .catch(error => {
                    console.error('ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®èª­è¾¼ã‚¨ãƒ©ãƒ¼:', error);
                });
        }

        // è¨˜éŒ²ä¿å­˜
        function saveRecord() {
            if (!selectedOperator || !selectedEquipment || !selectedAnomaly) {
                alert('å‡¦ç½®è€…ã€è¨­å‚™åã€ç•°å¸¸åã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const now = new Date();
            const timestamp = now.toISOString();
            const date = timestamp.split('T')[0];
            const time = now.toTimeString().split(' ')[0];

            const optionalData = {};
            document.querySelectorAll('[id^="optional-"]').forEach(select => {
                if (select.value) {
                    const fieldKey = select.id.replace('optional-', '');
                    optionalData[fieldKey] = select.value;
                }
            });

            const record = {
                operator: selectedOperator,
                equipmentId: selectedEquipment,
                anomalyId: selectedAnomaly.id,
                anomalyName: selectedAnomaly.name,
                organizationNo: selectedOrganizationNo || '',
                timestamp,
                date,
                time,
                remarks: document.getElementById('remarks').value,
                optionalData
            };

            database.ref('records').push(record).then(() => {
                showSuccess('è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ');

                // ãƒãƒƒã‚¸æ›´æ–°
                if (selectedEquipment) {
                    const today = new Date().toISOString().split('T')[0];
                    database.ref('records').orderByChild('date').equalTo(today).once('value', snapshot => {
                        todayAnomalyCounts = {};
                        snapshot.forEach(child => {
                            const record = child.val();
                            if (record.equipmentId === selectedEquipment) {
                                const anomalyName = record.anomalyName;
                                todayAnomalyCounts[anomalyName] = (todayAnomalyCounts[anomalyName] || 0) + 1;
                            }
                        });
                        loadAnomalyButtons(selectedEquipment);
                    });
                }

                resetInputForm();
            }).catch(error => {
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            });
        }

        function resetInputForm() {
            selectedOperator = null;
            selectedEquipment = null;
            selectedAnomaly = null;
            selectedOrganizationNo = null;
            document.querySelectorAll('.btn.selected').forEach(b => b.classList.remove('selected'));
            document.getElementById('remarks').value = '';
            document.getElementById('anomaly-section').classList.add('hidden');
            document.getElementById('organization-no-section').classList.add('hidden');
            document.getElementById('optional-fields-section').classList.add('hidden');
        }

        function showSuccess(message) {
            const msg = document.getElementById('success-msg');
            msg.textContent = message;
            msg.style.display = 'block';
            setTimeout(() => {
                msg.style.display = 'none';
            }, 3000);
        }

        // ===== ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¿ãƒ–é–¢é€£ =====

        function loadViewScreen() {
            database.ref('masters/equipments').once('value', snapshot => {
                const equipments = snapshot.val() || {};
                const container = document.getElementById('view-equipment-buttons');
                container.innerHTML = '';
                
                Object.keys(equipments).forEach(key => {
                    const btn = document.createElement('button');
                    btn.className = 'btn';
                    btn.textContent = equipments[key].name;
                    btn.onclick = () => selectViewEquipment(key, btn);
                    container.appendChild(btn);
                });
            });
        }

        function selectViewEquipment(equipmentId, btn) {
            document.querySelectorAll('#view-equipment-buttons .btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            currentViewEquipment = equipmentId;
            
            document.getElementById('stats-container').classList.remove('hidden');
            
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('end-date').valueAsDate = endDate;
            document.getElementById('start-date').valueAsDate = startDate;
            
            currentFilterAnomaly = '';
            currentFilterOrganizationNo = '';
            
            loadFilterOptions(equipmentId);
            loadStats();
            updateChart();
            loadRecordsTable();
        }

        function loadFilterOptions(equipmentId) {
            database.ref(`masters/equipments/${equipmentId}/anomalies`).once('value', snapshot => {
                const anomalies = snapshot.val() || {};
                const select = document.getElementById('filter-anomaly');
                select.innerHTML = '<option value="">ã™ã¹ã¦</option>';
                
                Object.keys(anomalies).forEach(key => {
                    const option = document.createElement('option');
                    option.value = anomalies[key].name;
                    option.textContent = anomalies[key].name;
                    select.appendChild(option);
                });
            });
            
            database.ref(`masters/equipments/${equipmentId}/organizationNos`).once('value', snapshot => {
                const organizationNos = snapshot.val() || {};
                const select = document.getElementById('filter-organization-no');
                select.innerHTML = '<option value="">ã™ã¹ã¦</option>';
                
                Object.keys(organizationNos).forEach(key => {
                    const option = document.createElement('option');
                    option.value = organizationNos[key].no;
                    option.textContent = organizationNos[key].no;
                    select.appendChild(option);
                });
            });
        }

        function applyFilters() {
            currentFilterAnomaly = document.getElementById('filter-anomaly').value;
            currentFilterOrganizationNo = document.getElementById('filter-organization-no').value;
            
            updateChart();
            loadRecordsTable();
            updateFilteredStats();
        }

        function clearFilters() {
            document.getElementById('filter-anomaly').value = '';
            document.getElementById('filter-organization-no').value = '';
            currentFilterAnomaly = '';
            currentFilterOrganizationNo = '';
            
            updateChart();
            loadRecordsTable();
            loadStats();
        }

        function updateFilteredStats() {
            if (!currentViewEquipment) return;
            
            const today = new Date().toISOString().split('T')[0];
            const yesterday = getLastWorkday();
            
            let todayCount = 0;
            let yesterdayCount = 0;
            
            allRecords.forEach(record => {
                if (record.equipmentId !== currentViewEquipment) return;
                
                const matchAnomaly = !currentFilterAnomaly || record.anomalyName === currentFilterAnomaly;
                const matchOrgNo = !currentFilterOrganizationNo || record.organizationNo === currentFilterOrganizationNo;
                
                if (matchAnomaly && matchOrgNo) {
                    if (record.date === today) todayCount++;
                    if (record.date === yesterday) yesterdayCount++;
                }
            });
            
            document.getElementById('today-count').textContent = todayCount;
            document.getElementById('yesterday-count').textContent = yesterdayCount;
        }

        function loadStats() {
            if (!currentViewEquipment) return;
            
            const today = new Date().toISOString().split('T')[0];
            const yesterday = getLastWorkday();
            
            database.ref('records').once('value', snapshot => {
                allRecords = [];
                snapshot.forEach(child => {
                    allRecords.push(child.val());
                });
                
                let todayCount = 0;
                let yesterdayCount = 0;
                
                allRecords.forEach(record => {
                    if (record.equipmentId === currentViewEquipment) {
                        if (record.date === today) todayCount++;
                        if (record.date === yesterday) yesterdayCount++;
                    }
                });
                
                document.getElementById('today-count').textContent = todayCount;
                document.getElementById('yesterday-count').textContent = yesterdayCount;
            });
        }

        function getLastWorkday() {
            const date = new Date();
            date.setDate(date.getDate() - 1);
            
            while (date.getDay() === 0 || date.getDay() === 6) {
                date.setDate(date.getDate() - 1);
            }
            
            return date.toISOString().split('T')[0];
        }

        function changePeriod(period, clickedButton) {
            currentPeriod = period;
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            clickedButton.classList.add('active');
            updateChart();
        }

        function updateChart() {
            if (!currentViewEquipment) return;
            
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) return;
            
            database.ref('records').orderByChild('equipmentId').equalTo(currentViewEquipment).once('value', snapshot => {
                const records = [];
                snapshot.forEach(child => {
                    const record = child.val();
                    if (record.date >= startDate && record.date <= endDate) {
                        const matchAnomaly = !currentFilterAnomaly || record.anomalyName === currentFilterAnomaly;
                        const matchOrgNo = !currentFilterOrganizationNo || record.organizationNo === currentFilterOrganizationNo;
                        if (matchAnomaly && matchOrgNo) {
                            records.push(record);
                        }
                    }
                });
                
                const chartData = aggregateData(records, startDate, endDate, currentPeriod);
                renderChart(chartData);
            });
        }

        function loadRecordsTable() {
            if (!currentViewEquipment) return;
            
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) return;
            
            database.ref('records').orderByChild('equipmentId').equalTo(currentViewEquipment).once('value', snapshot => {
                const records = [];
                snapshot.forEach(child => {
                    const record = child.val();
                    if (record.date >= startDate && record.date <= endDate) {
                        const matchAnomaly = !currentFilterAnomaly || record.anomalyName === currentFilterAnomaly;
                        const matchOrgNo = !currentFilterOrganizationNo || record.organizationNo === currentFilterOrganizationNo;
                        if (matchAnomaly && matchOrgNo) {
                            records.push(record);
                        }
                    }
                });
                
                records.sort((a, b) => b.timestamp.localeCompare(a.timestamp));
                
                const tbody = document.getElementById('records-tbody');
                tbody.innerHTML = '';
                
                if (records.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #999;">è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                    return;
                }
                
                records.forEach(record => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #eee';
                    row.innerHTML = `
                        <td style="padding: 10px;">${record.date} ${record.time}</td>
                        <td style="padding: 10px;">${record.anomalyName}</td>
                        <td style="padding: 10px;">${record.organizationNo || '-'}</td>
                        <td style="padding: 10px;">${record.operator}</td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        function aggregateData(records, startDate, endDate, period) {
            const counts = {};
            
            records.forEach(record => {
                let key;
                const date = new Date(record.date);
                
                if (period === 'day') {
                    key = record.date;
                } else if (period === 'week') {
                    const weekStart = new Date(date);
                    weekStart.setDate(date.getDate() - date.getDay());
                    key = weekStart.toISOString().split('T')[0];
                } else if (period === 'month') {
                    key = record.date.substring(0, 7);
                }
                
                counts[key] = (counts[key] || 0) + 1;
            });
            
            const labels = [];
            const values = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (period === 'day') {
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const key = d.toISOString().split('T')[0];
                    labels.push(key);
                    values.push(counts[key] || 0);
                }
            } else if (period === 'week') {
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 7)) {
                    const key = d.toISOString().split('T')[0];
                    labels.push(key);
                    values.push(counts[key] || 0);
                }
            } else if (period === 'month') {
                for (let d = new Date(start); d <= end; d.setMonth(d.getMonth() + 1)) {
                    const key = d.toISOString().substring(0, 7);
                    labels.push(key);
                    values.push(counts[key] || 0);
                }
            }
            
            return { labels, values };
        }

        function renderChart(data) {
            const ctx = document.getElementById('trend-chart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'ç•°å¸¸ä»¶æ•°',
                        data: data.values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // ===== ãƒã‚¹ã‚¿ãƒ¼ç”»é¢é–¢é€£ =====

        function loadMasterScreen() {
            loadOperatorList();
            loadEquipmentList();
            loadEquipmentSelect();
            loadEquipmentSelectForNo();
        }

        function loadOperatorList() {
            database.ref('masters/operators').once('value', snapshot => {
                const operators = snapshot.val() || {};
                const container = document.getElementById('operator-list');
                container.innerHTML = '';
                
                Object.keys(operators).forEach(key => {
                    const div = document.createElement('div');
                    div.className = 'master-item';
                    div.innerHTML = `
                        <span>${operators[key].name}</span>
                        <button class="btn btn-danger" onclick="deleteOperator('${key}')">å‰Šé™¤</button>
                    `;
                    container.appendChild(div);
                });
            });
        }

        function addOperator() {
            const name = document.getElementById('new-operator').value.trim();
            if (!name) {
                alert('å‡¦ç½®è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            database.ref('masters/operators').push({ name }).then(() => {
                document.getElementById('new-operator').value = '';
                loadOperatorList();
                loadOperators();
            });
        }

        function deleteOperator(key) {
            if (confirm('ã“ã®å‡¦ç½®è€…ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
                database.ref(`masters/operators/${key}`).remove().then(() => {
                    loadOperatorList();
                    loadOperators();
                });
            }
        }

        function loadEquipmentList() {
            database.ref('masters/equipments').once('value', snapshot => {
                const equipments = snapshot.val() || {};
                const container = document.getElementById('equipment-list');
                container.innerHTML = '';
                
                Object.keys(equipments).forEach(key => {
                    const div = document.createElement('div');
                    div.className = 'master-item';
                    div.innerHTML = `
                        <span>${equipments[key].name}</span>
                        <button class="btn btn-danger" onclick="deleteEquipment('${key}')">å‰Šé™¤</button>
                    `;
                    container.appendChild(div);
                });
            });
        }

        function addEquipment() {
            const name = document.getElementById('new-equipment').value.trim();
            if (!name) {
                alert('è¨­å‚™åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            database.ref('masters/equipments').push({ 
                name,
                anomalies: {}
            }).then(() => {
                document.getElementById('new-equipment').value = '';
                loadEquipmentList();
                loadEquipments();
                loadEquipmentSelect();
                loadEquipmentSelectForNo();
            });
        }

        function deleteEquipment(key) {
            if (confirm('ã“ã®è¨­å‚™ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
                database.ref(`masters/equipments/${key}`).remove().then(() => {
                    loadEquipmentList();
                    loadEquipments();
                    loadEquipmentSelect();
                    loadEquipmentSelectForNo();
                });
            }
        }

        function loadEquipmentSelectForNo() {
            database.ref('masters/equipments').once('value', snapshot => {
                const equipments = snapshot.val() || {};
                const select = document.getElementById('equipment-select-no');
                select.innerHTML = '<option value="">è¨­å‚™ã‚’é¸æŠ</option>';
                
                Object.keys(equipments).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = equipments[key].name;
                    select.appendChild(option);
                });
            });
        }

        function loadOrganizationNos() {
            const equipmentId = document.getElementById('equipment-select-no').value;
            if (!equipmentId) {
                document.getElementById('organization-no-management').classList.add('hidden');
                return;
            }
            
            document.getElementById('organization-no-management').classList.remove('hidden');
            
            database.ref(`masters/equipments/${equipmentId}/organizationNos`).once('value', snapshot => {
                const organizationNos = snapshot.val() || {};
                const container = document.getElementById('organization-no-list');
                container.innerHTML = '';
                
                Object.keys(organizationNos).forEach(key => {
                    const div = document.createElement('div');
                    div.className = 'master-item';
                    div.innerHTML = `
                        <span>${organizationNos[key].no}</span>
                        <button class="btn btn-danger" onclick="deleteOrganizationNo('${equipmentId}', '${key}')">å‰Šé™¤</button>
                    `;
                    container.appendChild(div);
                });
            });
        }

        function addOrganizationNo() {
            const equipmentId = document.getElementById('equipment-select-no').value;
            const no = document.getElementById('new-organization-no').value.trim();
            
            if (!no) {
                alert('æ•´ç†Noã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            database.ref(`masters/equipments/${equipmentId}/organizationNos`).push({
                no: no
            }).then(() => {
                document.getElementById('new-organization-no').value = '';
                loadOrganizationNos();
            });
        }

        function deleteOrganizationNo(equipmentId, key) {
            if (confirm('ã“ã®æ•´ç†Noã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
                database.ref(`masters/equipments/${equipmentId}/organizationNos/${key}`).remove().then(() => {
                    loadOrganizationNos();
                });
            }
        }

        function loadEquipmentSelect() {
            database.ref('masters/equipments').once('value', snapshot => {
                const equipments = snapshot.val() || {};
                const select = document.getElementById('equipment-select');
                select.innerHTML = '<option value="">è¨­å‚™ã‚’é¸æŠ</option>';
                
                Object.keys(equipments).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = equipments[key].name;
                    select.appendChild(option);
                });
            });
        }

        function loadAnomalies() {
            const equipmentId = document.getElementById('equipment-select').value;
            const anomalyMgmt = document.getElementById('anomaly-management');
            const optionalSettings = document.getElementById('optional-field-settings');

            if (!equipmentId) {
                anomalyMgmt.classList.add('hidden');
                masterSelectedEquipmentForOptions = null;
                masterSelectedAnomalyForOptions = null;
                optionalSettings.innerHTML = 'ç•°å¸¸åã‚’é¸æŠã™ã‚‹ã¨ã€ã“ã“ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';
                return;
            }
            
            anomalyMgmt.classList.remove('hidden');
            masterSelectedEquipmentForOptions = equipmentId;
            masterSelectedAnomalyForOptions = null;
            optionalSettings.innerHTML = 'ç•°å¸¸åã‚’é¸æŠã™ã‚‹ã¨ã€ã“ã“ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';
            
            database.ref(`masters/equipments/${equipmentId}/anomalies`).once('value', snapshot => {
                const anomalies = snapshot.val() || {};
                const container = document.getElementById('anomaly-list');
                container.innerHTML = '';
                
                Object.keys(anomalies).forEach(key => {
                    const anomaly = anomalies[key];
                    const div = document.createElement('div');
                    div.className = 'master-item';
                    div.innerHTML = `
                        <span>${anomaly.name}</span>
                        <div style="display:flex; gap:8px;">
                            <button class="btn" style="padding:6px 10px; font-size:12px;" onclick="selectAnomalyForOptions('${equipmentId}','${key}')">ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š</button>
                            <button class="btn btn-danger" onclick="deleteAnomaly('${equipmentId}', '${key}')">å‰Šé™¤</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            });
        }

        // ãƒã‚¹ã‚¿ãƒ¼ç”»é¢ã§ã€ã©ã®ç•°å¸¸ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç·¨é›†ã™ã‚‹ã‹é¸æŠ
        function selectAnomalyForOptions(equipmentId, anomalyKey) {
            masterSelectedEquipmentForOptions = equipmentId;
            masterSelectedAnomalyForOptions = anomalyKey;
            loadOptionalFieldSettings(equipmentId, anomalyKey);
        }

        function addAnomaly() {
            const equipmentId = document.getElementById('equipment-select').value;
            const name = document.getElementById('new-anomaly-name').value.trim();
            
            if (!equipmentId) {
                alert('è¨­å‚™ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            if (!name) {
                alert('ç•°å¸¸åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            database.ref(`masters/equipments/${equipmentId}/anomalies`).push({
                name
            }).then(() => {
                document.getElementById('new-anomaly-name').value = '';
                loadAnomalies();
            });
        }

        function deleteAnomaly(equipmentId, anomalyKey) {
            if (confirm('ã“ã®ç•°å¸¸åã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
                database.ref(`masters/equipments/${equipmentId}/anomalies/${anomalyKey}`).remove().then(() => {
                    if (masterSelectedEquipmentForOptions === equipmentId &&
                        masterSelectedAnomalyForOptions === anomalyKey) {
                        masterSelectedAnomalyForOptions = null;
                        document.getElementById('optional-field-settings').innerHTML =
                            'ç•°å¸¸åã‚’é¸æŠã™ã‚‹ã¨ã€ã“ã“ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';
                    }
                    loadAnomalies();
                });
            }
        }

        // ç•°å¸¸ã”ã¨ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®ä¸€è¦§ï¼ˆãƒã‚¹ã‚¿ãƒ¼ç”»é¢ï¼‰
        function loadOptionalFieldSettings(equipmentId, anomalyKey) {
            const container = document.getElementById('optional-field-settings');
            if (!equipmentId || !anomalyKey) {
                container.innerHTML = 'ç•°å¸¸åã‚’é¸æŠã™ã‚‹ã¨ã€ã“ã“ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';
                return;
            }

            database
                .ref(`masters/equipments/${equipmentId}/anomalies/${anomalyKey}/optionalFields`)
                .once('value')
                .then(snapshot => {
                    const fields = snapshot.val() || {};
                    const keys = Object.keys(fields);

                    if (keys.length === 0) {
                        container.innerHTML = 'ã“ã®ç•°å¸¸ã«ã¯ã€ã¾ã ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                        return;
                    }

                    container.innerHTML = '';
                    keys.forEach(key => {
                        const field = fields[key];
                        const div = document.createElement('div');
                        div.className = 'master-item';
                        div.style.flexDirection = 'column';
                        div.style.alignItems = 'flex-start';

                        div.innerHTML = `
                            <div style="display:flex; justify-content:space-between; width:100%; margin-bottom:6px;">
                                <strong>${field.name}</strong>
                                <button class="btn btn-danger" style="padding:4px 8px; font-size:11px;"
                                    onclick="deleteOptionalField('${equipmentId}','${anomalyKey}','${key}')">
                                    å‰Šé™¤
                                </button>
                            </div>
                            <div style="font-size:12px; color:#666;">
                                é¸æŠè‚¢: ${(field.options || []).join(', ')}
                            </div>
                        `;
                        container.appendChild(div);
                    });
                })
                .catch(error => {
                    console.error('ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®è¨­å®šã®èª­è¾¼ã‚¨ãƒ©ãƒ¼:', error);
                    container.innerHTML = 'ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                });
        }

        // ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®è¿½åŠ ï¼ˆç•°å¸¸å˜ä½ï¼‰
        function addOptionalField() {
            const equipmentId = masterSelectedEquipmentForOptions;
            const anomalyKey = masterSelectedAnomalyForOptions;

            if (!equipmentId || !anomalyKey) {
                alert('ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®ã‚’è¨­å®šã™ã‚‹ç•°å¸¸åã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const fieldName = prompt('ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!fieldName) return;
            
            const optionsStr = prompt('é¸æŠè‚¢ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã—ã¦ãã ã•ã„:\nä¾‹: é¸æŠè‚¢1,é¸æŠè‚¢2,é¸æŠè‚¢3');
            if (!optionsStr) return;
            
            const options = optionsStr
                .split(',')
                .map(s => s.trim())
                .filter(s => s);

            database
                .ref(`masters/equipments/${equipmentId}/anomalies/${anomalyKey}/optionalFields`)
                .push({
                    name: fieldName,
                    options: options
                })
                .then(() => {
                    loadOptionalFieldSettings(equipmentId, anomalyKey);

                    // å…¥åŠ›ç”»é¢ã§åŒã˜è¨­å‚™ãƒ»ç•°å¸¸ãŒé¸æŠä¸­ãªã‚‰å³åæ˜ 
                    if (selectedEquipment === equipmentId &&
                        selectedAnomaly &&
                        selectedAnomaly.id === anomalyKey) {
                        loadOptionalFields(equipmentId, anomalyKey);
                    }
                })
                .catch(error => {
                    console.error('ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                });
        }

        // ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®å‰Šé™¤
        function deleteOptionalField(equipmentId, anomalyKey, fieldKey) {
            if (!confirm('ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            database
                .ref(`masters/equipments/${equipmentId}/anomalies/${anomalyKey}/optionalFields/${fieldKey}`)
                .remove()
                .then(() => {
                    loadOptionalFieldSettings(equipmentId, anomalyKey);

                    if (selectedEquipment === equipmentId &&
                        selectedAnomaly &&
                        selectedAnomaly.id === anomalyKey) {
                        loadOptionalFields(equipmentId, anomalyKey);
                    }
                })
                .catch(error => {
                    console.error('ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ã‚ªãƒ—ã‚·ãƒ§ãƒ³é …ç›®ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                });
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadInputScreen();
        });
    </script>
</body>
</html>
