<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„ÉÅ„Éß„Ç≥ÂÅúË®òÈå≤„Ç¢„Éó„É™</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+1:wght@400;500;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #eef2ff;
            --surface: #ffffff;
            --surface2: #f5f7ff;
            --surface3: #e8ecfa;
            --border: rgba(0,0,0,0.09);
            --accent: #4a7eff;
            --accent2: #ff4d4d;
            --accent3: #00b894;
            --text: #1a1f3c;
            --text2: #4a5280;
            --text3: #9098bb;
            --radius: 10px;
            --sidebar-w: 72px;
            --left-w: 340px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'M PLUS 1', sans-serif;
            background: var(--bg);
            color: var(--text);
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: var(--sidebar-w);
            height: 100vh;
            background: #1e2a5e;
            border-right: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 0;
            gap: 4px;
            flex-shrink: 0;
            z-index: 10;
            box-shadow: 2px 0 12px rgba(0,0,0,0.12);
        }

        .sidebar-logo {
            font-family: 'Rajdhani', sans-serif;
            font-size: 11px;
            font-weight: 700;
            color: #7eb3ff;
            letter-spacing: 0.05em;
            text-align: center;
            padding: 8px 4px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            width: 100%;
        }

        .nav-btn {
            width: 52px;
            height: 52px;
            border: none;
            background: transparent;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s;
            color: rgba(255,255,255,0.5);
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.04em;
        }

        .nav-btn svg { opacity: 0.6; transition: all 0.2s; }
        .nav-btn:hover { background: rgba(255,255,255,0.12); color: rgba(255,255,255,0.9); }
        .nav-btn:hover svg { opacity: 0.8; }
        .nav-btn.active { background: rgba(74,126,255,0.35); color: #fff; }
        .nav-btn.active svg { opacity: 1; }

        .nav-indicator {
            width: 3px;
            height: 32px;
            border-radius: 2px;
            background: #7eb3ff;
            position: absolute;
            left: 0;
            opacity: 0;
            transition: all 0.2s;
        }
        .nav-btn.active .nav-indicator { opacity: 1; }

        .nav-btn-wrap { position: relative; display: flex; align-items: center; }

        .sidebar-link {
            margin-top: auto;
            width: 52px;
            height: 40px;
            border-radius: 8px;
            background: rgba(74,126,255,0.2);
            border: 1px solid rgba(126,179,255,0.4);
            color: #7eb3ff;
            font-size: 8px;
            font-weight: 700;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            text-decoration: none;
            letter-spacing: 0.02em;
            text-align: center;
            transition: all 0.2s;
            line-height: 1.2;
        }
        .sidebar-link:hover { background: rgba(91,140,255,0.2); }

        /* ===== MAIN LAYOUT ===== */
        .app-main { flex: 1; height: 100vh; display: flex; overflow: hidden; }

        /* ===== SECTION BASE ===== */
        .section { display: none; width: 100%; height: 100%; }
        .section.active { display: flex; }

        /* ===== INPUT SECTION ===== */
        #input-section { flex-direction: row; gap: 0; }

        .inp-col {
            flex: 1;
            min-width: 0;
            min-height: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-right: 1px solid var(--border);
            background: var(--surface);
        }
        .inp-col:first-child { background: var(--surface2); }
        .inp-col:last-child { border-right: none; }
        .inp-col-save { background: var(--surface) !important; }

        .panel-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text3);
            flex-shrink: 0;
        }

        .panel-body {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .panel-body::-webkit-scrollbar { width: 4px; }
        .panel-body::-webkit-scrollbar-track { background: transparent; }
        .panel-body::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 2px; }

        /* ===== GRID BUTTONS ===== */
        .form-label {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text2);
            margin-bottom: 8px;
            margin-top: 14px;
            display: block;
        }
        .form-label:first-child { margin-top: 0; }

        .btn-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; }

        .sel-btn {
            padding: 13px 10px;
            border: 2px solid #c8d0ef;
            background: var(--surface2);
            color: var(--text);
            border-radius: 8px;
            cursor: pointer;
            font-family: 'M PLUS 1', sans-serif;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.15s;
            text-align: center;
            line-height: 1.3;
            position: relative;
        }
        .sel-btn:hover { background: var(--surface3); border-color: #8aabff; }
        .sel-btn.selected { background: rgba(74,126,255,0.12); border-color: var(--accent); color: var(--accent); }

        .badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--accent2);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
        }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        .form-box {
            background: #f0f4ff;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }
        .form-box .panel-header { padding: 10px 14px; font-size: 13px; }
        .form-box .btn-grid { padding: 10px; grid-template-columns: repeat(3, 1fr); }
        .form-box-full { grid-column: 1 / -1; }
        .remarks-box { grid-column: 1 / -1; }

        textarea.input-field {
            width: 100%;
            background: var(--surface2);
            border: 2px solid #c8d0ef;
            border-radius: 8px;
            padding: 10px 12px;
            color: var(--text);
            font-family: 'M PLUS 1', sans-serif;
            font-size: 15px;
            resize: none;
            height: 70px;
            outline: none;
            transition: border-color 0.2s;
        }
        textarea.input-field:focus { border-color: var(--accent); }
        textarea.input-field::placeholder { color: var(--text3); }

        .save-bar {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .btn-save {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #4a7eff 0%, #6a5aff 100%);
            border: none;
            border-radius: var(--radius);
            color: white;
            font-family: 'M PLUS 1', sans-serif;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.05em;
        }
        .btn-save:hover { filter: brightness(1.08); transform: translateY(-1px); }
        .btn-save:active { transform: translateY(0); }

        .success-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #00b894;
            color: #fff;
            padding: 10px 24px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 14px;
            z-index: 999;
            display: none;
            box-shadow: 0 4px 20px rgba(0,212,170,0.3);
        }

        /* ===== MINI CHART (Input Screen) ===== */
        .input-mini-chart {
            margin-top: 14px;
            background: #f0f4ff;
            border: 1px solid #c8d0ef;
            border-radius: 10px;
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-mini-chart.hidden { display: none; }

        .mini-chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .mini-chart-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text2);
        }

        .mini-chart-equip-name {
            font-size: 11px;
            color: var(--accent);
            font-weight: 700;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .mini-chart-wrap {
            height: 110px;
            position: relative;
        }

        .mini-chart-wrap canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .mini-chart-total {
            font-size: 11px;
            color: var(--text3);
            text-align: right;
        }

        .mini-chart-total span {
            font-family: 'Rajdhani', sans-serif;
            font-size: 15px;
            font-weight: 700;
            color: var(--accent);
        }

        /* ===== VIEW SECTION ===== */
        #view-section { flex-direction: row; }

        .view-left {
            width: 260px;
            flex-shrink: 0;
            height: 100%;
            background: var(--surface2);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .view-right { flex: 1; height: 100%; display: flex; flex-direction: column; overflow: hidden; }

        .view-filters { padding: 0 12px 12px; display: flex; flex-direction: column; gap: 8px; }

        .filter-label {
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 0.06em;
            color: var(--text2);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        select.input-field {
            width: 100%;
            background: var(--surface2);
            border: 2px solid #c8d0ef;
            border-radius: 8px;
            padding: 9px 10px;
            color: var(--text);
            font-family: 'M PLUS 1', sans-serif;
            font-size: 14px;
            outline: none;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
        }
        select.input-field:focus { border-color: var(--accent); }

        .input-field-wrap { position: relative; }
        .input-field-wrap::after {
            content: '‚ñæ';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text3);
            pointer-events: none;
            font-size: 11px;
        }

        .date-pair { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }

        input[type="date"].input-field {
            width: 100%;
            background: var(--surface2);
            border: 2px solid #c8d0ef;
            border-radius: 8px;
            padding: 8px 6px;
            color: var(--text);
            font-family: 'M PLUS 1', sans-serif;
            font-size: 13px;
            outline: none;
            color-scheme: dark;
        }
        input[type="date"].input-field:focus { border-color: var(--accent); }

        .clear-btn {
            width: 100%;
            padding: 8px;
            background: transparent;
            border: 2px solid #c8d0ef;
            border-radius: 8px;
            color: var(--text2);
            font-family: 'M PLUS 1', sans-serif;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .clear-btn:hover { border-color: var(--accent2); color: var(--accent2); }

        .view-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        .chart-row {
            height: 200px;
            flex-shrink: 0;
            padding: 12px 16px;
            background: #f8faff;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chart-toolbar { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }

        .chart-title {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text2);
            flex: 1;
        }

        .period-group { display: flex; gap: 4px; }

        .period-pill {
            padding: 4px 10px;
            border-radius: 999px;
            border: 2px solid #c8d0ef;
            background: transparent;
            color: var(--text2);
            font-family: 'M PLUS 1', sans-serif;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
        }
        .period-pill.active { background: var(--accent); border-color: var(--accent); color: white; }
        .period-pill:hover:not(.active) { border-color: var(--accent); color: var(--accent); }

        .chart-wrap { flex: 1; position: relative; overflow: hidden; }
        .chart-wrap canvas { width: 100% !important; height: 100% !important; }

        .table-area { flex: 1; overflow: hidden; display: flex; flex-direction: column; }

        .table-toolbar {
            padding: 8px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .table-toolbar span {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text2);
            flex: 1;
        }

        .small-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: 2px solid #c8d0ef;
            background: var(--surface);
            color: var(--text2);
            font-family: 'M PLUS 1', sans-serif;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .small-btn:hover { border-color: var(--accent); color: var(--accent); }

        .table-scroll { flex: 1; overflow-y: auto; overflow-x: auto; }
        .table-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .table-scroll::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 2px; }

        table { width: 100%; border-collapse: collapse; font-size: 14px; }

        thead th {
            padding: 8px 12px;
            text-align: left;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text3);
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        tbody td { padding: 9px 12px; border-bottom: 1px solid #d0d8f0; color: var(--text); white-space: nowrap; }
        tbody tr:hover td { background: var(--surface2); color: var(--text); }

        .no-data { text-align: center; padding: 30px; color: var(--text3); font-size: 13px; }

        /* ===== MASTER SECTION ===== */
        #master-section { flex-direction: row; }

        .master-nav {
            width: 200px;
            flex-shrink: 0;
            height: 100%;
            background: var(--surface2);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .master-nav-item {
            padding: 14px 16px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: var(--text2);
            border-bottom: 2px solid #d8dfff;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .master-nav-item:hover { background: var(--surface2); color: var(--text); }
        .master-nav-item.active { background: rgba(91,140,255,0.1); color: var(--accent); border-right: 4px solid var(--accent); }

        .master-content { flex: 1; height: 100%; display: flex; flex-direction: column; overflow: hidden; }

        .master-panel { display: none; flex: 1; flex-direction: column; overflow: hidden; }
        .master-panel.active { display: flex; }

        .master-panel .panel-header { padding: 14px 20px; font-size: 16px; font-weight: 700; color: var(--text); text-transform: none; letter-spacing: 0; }

        .master-body {
            flex: 1;
            padding: 16px 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: row;
            gap: 20px;
        }
        .master-body::-webkit-scrollbar { width: 4px; }
        .master-body::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 2px; }

        .master-add-col { width: 260px; flex-shrink: 0; }
        .master-list-col { flex: 1; overflow-y: auto; }
        .master-list-col::-webkit-scrollbar { width: 4px; }
        .master-list-col::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 2px; }

        .add-row { display: flex; gap: 8px; margin-bottom: 20px; }

        input[type="text"].input-field {
            flex: 1;
            background: var(--surface2);
            border: 2px solid #c8d0ef;
            border-radius: 8px;
            padding: 10px 12px;
            color: var(--text);
            font-family: 'M PLUS 1', sans-serif;
            font-size: 15px;
            outline: none;
            transition: border-color 0.2s;
            width: 100%;
        }
        input[type="text"].input-field:focus { border-color: var(--accent); }
        input[type="text"].input-field::placeholder { color: var(--text3); }

        .btn-add {
            padding: 10px 16px;
            background: var(--accent3);
            border: none;
            border-radius: 8px;
            color: #000;
            font-family: 'M PLUS 1', sans-serif;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s;
        }
        .btn-add:hover { filter: brightness(1.1); }

        .master-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--surface);
            border: 2px solid #c8d0ef;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .master-item span { font-size: 15px; color: var(--text); font-weight: 500; }
        .master-item-actions { display: flex; gap: 6px; }

        .btn-opt {
            padding: 5px 10px;
            border-radius: 6px;
            border: 2px solid #c8d0ef;
            background: transparent;
            color: var(--text2);
            font-family: 'M PLUS 1', sans-serif;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .btn-opt:hover { border-color: var(--accent); color: var(--accent); }

        .btn-del {
            padding: 5px 10px;
            border-radius: 6px;
            border: 2px solid rgba(255,77,77,0.5);
            background: transparent;
            color: var(--accent2);
            font-family: 'M PLUS 1', sans-serif;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .btn-del:hover { background: rgba(255,107,107,0.1); }

        .master-select-bar {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
        }

        .master-select-bar label {
            font-size: 13px;
            font-weight: 700;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            white-space: nowrap;
        }

        .optional-pane {
            margin-top: 20px;
            background: var(--surface3);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
        }

        .optional-pane-title {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text2);
            margin-bottom: 10px;
        }

        .opt-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 10px;
            background: var(--surface);
            border: 2px solid #c8d0ef;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .opt-item-head { display: flex; justify-content: space-between; align-items: center; }
        .opt-item-name { font-size: 14px; font-weight: 700; color: var(--text); }
        .opt-item-opts { font-size: 13px; color: var(--text2); }

        .btn-add-opt {
            width: 100%;
            padding: 8px;
            background: transparent;
            border: 2px dashed rgba(74,126,255,0.6);
            border-radius: 8px;
            color: var(--accent);
            font-family: 'M PLUS 1', sans-serif;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
            margin-top: 8px;
        }
        .btn-add-opt:hover { background: rgba(91,140,255,0.08); }

        .opt-select-wrap { display: flex; flex-direction: column; gap: 8px; padding: 10px; }
        .opt-select-row { display: flex; align-items: center; gap: 8px; }
        .opt-select-row label { font-size: 11px; font-weight: 700; color: var(--text3); white-space: nowrap; min-width: 80px; }

        .hidden { display: none !important; }

        .equip-scroll { padding: 8px 12px; overflow-y: auto; flex: 1; }
        .equip-scroll::-webkit-scrollbar { width: 4px; }
        .equip-scroll::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 2px; }

        .equip-sel-btn {
            width: 100%;
            text-align: left;
            padding: 10px 12px;
            background: var(--surface);
            border: 2px solid #c8d0ef;
            border-radius: 8px;
            color: var(--text);
            font-family: 'M PLUS 1', sans-serif;
            font-size: 15px;
            cursor: pointer;
            margin-bottom: 6px;
            transition: all 0.15s;
        }
        .equip-sel-btn:hover { border-color: rgba(91,140,255,0.4); color: var(--text); }
        .equip-sel-btn.selected { background: rgba(74,126,255,0.1); border-color: var(--accent); color: var(--accent); }

        .placeholder-msg {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 12px;
            color: var(--text3);
            font-size: 16px;
        }
        .placeholder-msg svg { opacity: 0.3; }

        /* bottom nav hidden on desktop */
        .bottom-nav { display: none; }

        /* mobile floating save button - hidden on desktop */
        .mobile-save-btn { display: none; }

        /* ================================================
           MOBILE PORTRAIT  (max-width: 700px)
        ================================================ */
        @media (max-width: 700px) {
            /* ===== „É¢„Éê„Ç§„É´Âü∫Êú¨„É¨„Ç§„Ç¢„Ç¶„Éà =====
               body „Çí„Çπ„ÇØ„É≠„Éº„É´„Ç≥„É≥„ÉÜ„Éä„Å´„Åó„Å¶„ÄÅÂÖ®„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíËá™ÁÑ∂„Å´ÊµÅ„Åô */
            body {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
                overflow-x: hidden;
                overflow-y: auto;          /* ‚Üê body„Åß„Çπ„ÇØ„É≠„Éº„É´ */
            }
            .sidebar { display: none; }

            /* app-main „ÅØÈ´ò„Åï„ÇíÁîªÈù¢„Åã„Çâ bottom-nav ÂàÜ„ÇíÂºï„ÅÑ„ÅüÂõ∫ÂÆö„Åß„ÅØ„Å™„Åè auto „Å´ */
            .app-main {
                flex: 1;
                height: auto;
                overflow: visible;
                padding-bottom: 70px;      /* bottom-nav „ÅÆÈ´ò„ÅïÂàÜ‰ΩôÁôΩ */
            }

            /* ÂÖ® section „Çí auto È´ò„Åï„Éª„Çπ„ÇØ„É≠„Éº„É´„Å™„Åó„Å´„Åô„ÇãÔºàbody„Åå„Çπ„ÇØ„É≠„Éº„É´„Åô„ÇãÔºâ */
            .section {
                height: auto;
                min-height: 0;
                overflow: visible;
                width: 100%;
            }

            /* ===== „Éú„Éà„É†„Éä„Éì ===== */
            .bottom-nav {
                display: flex;
                position: fixed;
                bottom: 0; left: 0; right: 0;
                height: 62px;
                background: #1e2a5e;
                border-top: 2px solid rgba(255,255,255,0.12);
                z-index: 100;
                box-shadow: 0 -3px 16px rgba(0,0,0,0.18);
            }

            .bnav-btn {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 3px;
                border: none;
                background: transparent;
                color: rgba(255,255,255,0.45);
                font-family: 'M PLUS 1', sans-serif;
                font-size: 11px;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.2s;
                padding-bottom: env(safe-area-inset-bottom, 0);
            }
            .bnav-btn.active { color: #7eb3ff; border-top: 3px solid #7eb3ff; }
            .bnav-btn svg { opacity: 0.7; }
            .bnav-btn.active svg { opacity: 1; }

            /* ===== ÂÖ•ÂäõÁîªÈù¢ ===== */
            #input-section { flex-direction: column; }

            .inp-col { flex: none; width: 100%; height: auto; border-right: none; border-bottom: 2px solid #c8d0ef; overflow: visible; }
            .inp-col .panel-body { overflow: visible; }
            .inp-col-save { border-bottom: none; }
            .btn-grid { grid-template-columns: repeat(2, 1fr); }

            /* „É¢„Éê„Ç§„É´‰øùÂ≠ò„Éú„Çø„É≥ÔºàÂè≥‰∏äÂõ∫ÂÆöÔºâ */
            .btn-save { display: none !important; }
            .mobile-save-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                position: fixed;
                top: 10px;
                right: 12px;
                z-index: 200;
                background: linear-gradient(135deg, #4a7eff 0%, #6a5aff 100%);
                color: white;
                border: none;
                border-radius: 24px;
                padding: 10px 18px;
                font-family: 'M PLUS 1', sans-serif;
                font-size: 14px;
                font-weight: 700;
                box-shadow: 0 4px 16px rgba(74,126,255,0.45);
                cursor: pointer;
                gap: 6px;
                letter-spacing: 0.04em;
                transition: all 0.2s;
            }
            .mobile-save-btn:active { transform: scale(0.96); filter: brightness(1.1); }
            .input-mini-chart { padding: 10px 12px; }
            .mini-chart-wrap { height: 90px; }

            /* ===== „Éá„Éº„ÇøÁîªÈù¢ ===== */
            #view-section { flex-direction: column; }

            .view-left { width: 100%; height: auto; border-right: none; border-bottom: 2px solid #c8d0ef; }
            .view-left .panel-header { padding: 10px 12px; }

            #view-equipment-buttons.equip-scroll {
                display: flex;
                flex-direction: row;
                overflow-x: auto;
                overflow-y: visible;
                flex: none;
                padding: 8px 12px;
                gap: 8px;
                -webkit-overflow-scrolling: touch;
            }
            #view-equipment-buttons.equip-scroll::-webkit-scrollbar { display: none; }
            .equip-sel-btn { flex-shrink: 0; width: auto; padding: 10px 16px; margin-bottom: 0; white-space: nowrap; }

            #stats-area { border-top: 1px solid var(--border); }
            .view-filters { padding: 0 12px 10px; }

            .view-right { flex: none; height: auto; }
            #view-placeholder { padding: 40px 20px; height: auto; }
            #view-content { height: auto; }
            .chart-row { height: 180px; flex-shrink: 0; }
            .table-area { height: auto; overflow: visible; }
            .table-scroll { overflow-x: auto; overflow-y: visible; }
            thead th { font-size: 11px; padding: 8px 10px; }
            tbody td { font-size: 13px; padding: 8px 10px; }

            /* ===== ÁÆ°ÁêÜÁîªÈù¢ ===== */
            #master-section { flex-direction: column; }
            .master-nav { width: 100%; height: auto; border-right: none; border-bottom: 2px solid #c8d0ef; flex-direction: row; overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .master-nav::-webkit-scrollbar { display: none; }
            .master-nav .panel-header { display: none; }
            .master-nav-item { flex-shrink: 0; padding: 12px 16px; border-bottom: none; border-right: 1px solid var(--border); font-size: 13px; white-space: nowrap; }
            .master-nav-item.active { border-right: 1px solid var(--border); border-bottom: 3px solid var(--accent); color: var(--accent); background: rgba(74,126,255,0.08); }
            .master-content { height: auto; overflow: visible; }
            .master-panel { height: auto; overflow: visible; }
            .master-panel .panel-header { padding: 12px 16px; }
            .master-select-bar { padding: 10px 16px; }
            .master-body { flex-direction: column; padding: 12px 16px; overflow: visible; }
            .master-add-col { width: 100%; }
            .optional-pane { margin-top: 12px; }
            .add-row input { font-size: 14px; }
        }

        @media (max-width: 900px) { :root { --left-w: 280px; } }

        .rec-del-btn {
            padding: 5px 12px;
            border: 2px solid rgba(255,77,77,0.5);
            border-radius: 6px;
            background: transparent;
            color: var(--accent2);
            font-family: 'M PLUS 1', sans-serif;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s;
        }
        .rec-del-btn:hover { background: rgba(255,77,77,0.1); border-color: var(--accent2); }
    </style>
</head>
<body>
    <!-- ===== SIDEBAR ===== -->
    <nav class="sidebar">
        <div class="sidebar-logo">CHK<br>APP</div>

        <div class="nav-btn-wrap">
            <div class="nav-indicator"></div>
            <button class="nav-btn active" data-tab="input" onclick="switchTab('input', this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                ÂÖ•Âäõ
            </button>
        </div>

        <div class="nav-btn-wrap">
            <div class="nav-indicator"></div>
            <button class="nav-btn" data-tab="view" onclick="switchTab('view', this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3zM9 9h6m-6 4h6m-6 4h4"/></svg>
                „Éá„Éº„Çø
            </button>
        </div>

        <div class="nav-btn-wrap">
            <div class="nav-indicator"></div>
            <button class="nav-btn" data-tab="master" onclick="switchTab('master', this)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>
                ÁÆ°ÁêÜ
            </button>
        </div>

        <a href="https://motsu922.github.io/testpage/abnreports.html" class="sidebar-link" target="_blank" rel="noopener noreferrer">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
            Áï∞Â∏∏<br>Â±•Ê≠¥
        </a>
    </nav>

    <!-- ===== MAIN ===== -->
    <main class="app-main">
        <div id="success-toast" class="success-toast">‚úì Ë®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü</div>

        <!-- ===== INPUT SECTION ===== -->
        <div id="input-section" class="section active">

            <!-- COL 1: Âá¶ÁΩÆËÄÖ + Ë®≠ÂÇôÂêç -->
            <div class="inp-col">
                <div class="panel-header">Âá¶ÁΩÆËÄÖ / Ë®≠ÂÇôÂêç</div>
                <div class="panel-body">
                    <span class="form-label">Âá¶ÁΩÆËÄÖ</span>
                    <div id="operator-buttons" class="btn-grid"></div>
                    <span class="form-label">Ë®≠ÂÇôÂêç</span>
                    <div id="equipment-buttons" class="btn-grid"></div>

                    <!-- „Éü„Éã„Ç∞„É©„Éï (Ë®≠ÂÇôÈÅ∏ÊäûÊôÇ„Å´Ë°®Á§∫) -->
                    <div id="input-mini-chart" class="input-mini-chart hidden">
                        <div class="mini-chart-header">
                            <div class="mini-chart-title">üìà Áõ¥Ëøë7Êó•Èñì„ÅÆÁï∞Â∏∏‰ª∂Êï∞</div>
                            <div class="mini-chart-equip-name" id="mini-chart-equip-name"></div>
                        </div>
                        <div class="mini-chart-wrap">
                            <canvas id="mini-trend-chart"></canvas>
                        </div>
                        <div class="mini-chart-total">7Êó•ÂêàË®àÔºö<span id="mini-chart-total">0</span> ‰ª∂</div>
                    </div>
                </div>
            </div>

            <!-- COL 2: Áï∞Â∏∏Âêç + Êï¥ÁêÜNo -->
            <div class="inp-col">
                <div class="panel-header">Áï∞Â∏∏Âêç / Êï¥ÁêÜ No</div>
                <div class="panel-body">
                    <div id="anomaly-section">
                        <span class="form-label">Áï∞Â∏∏Âêç</span>
                        <div id="anomaly-buttons" class="btn-grid"></div>
                    </div>
                    <div id="organization-no-section" class="hidden">
                        <span class="form-label">Êï¥ÁêÜ No</span>
                        <div id="organization-no-buttons" class="btn-grid" style="grid-template-columns: repeat(3,1fr);"></div>
                    </div>
                </div>
            </div>

            <!-- COL 3: „Ç™„Éó„Ç∑„Éß„É≥ + ÂÇôËÄÉ + ‰øùÂ≠ò + „Éü„Éã„Ç∞„É©„Éï -->
            <div class="inp-col inp-col-save">
                <div class="panel-header">„Ç™„Éó„Ç∑„Éß„É≥ / ÂÇôËÄÉ</div>
                <div class="panel-body">
                    <div id="optional-fields-section" class="hidden">
                        <span class="form-label">„Ç™„Éó„Ç∑„Éß„É≥È†ÖÁõÆ</span>
                        <div id="optional-fields-container" class="opt-select-wrap" style="padding:0;"></div>
                    </div>
                    <span class="form-label">ÂÇôËÄÉÔºà‰ªªÊÑèÔºâ</span>
                    <textarea id="remarks" class="input-field" placeholder="ÂÇôËÄÉ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ‚Ä¶" style="height:80px;"></textarea>
                    <button class="btn-save" onclick="saveRecord()" style="margin-top:16px;">üíæ„ÄÄ‰øùÂ≠ò„Åô„Çã</button>
                </div>

            </div>
        </div>

        <!-- ===== VIEW SECTION ===== -->
        <div id="view-section" class="section">
            <div class="view-left">
                <div class="panel-header">Ë®≠ÂÇôÈÅ∏Êäû</div>
                <div id="view-equipment-buttons" class="equip-scroll"></div>

                <div id="stats-area" style="border-top:1px solid var(--border);">
                    <div class="view-filters">
                        <div>
                            <div class="filter-label">Áï∞Â∏∏Âêç</div>
                            <div class="input-field-wrap">
                                <select id="filter-anomaly" class="input-field" onchange="applyFilters()">
                                    <option value="">„Åô„Åπ„Å¶</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <div class="filter-label">Êï¥ÁêÜ No</div>
                            <div class="input-field-wrap">
                                <select id="filter-organization-no" class="input-field" onchange="applyFilters()">
                                    <option value="">„Åô„Åπ„Å¶</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <div class="filter-label">ÊúüÈñì</div>
                            <div class="date-pair">
                                <input type="date" id="start-date" class="input-field" onchange="updateChart()">
                                <input type="date" id="end-date" class="input-field" onchange="updateChart()">
                            </div>
                        </div>
                        <button class="clear-btn" onclick="clearFilters()">„Éï„Ç£„É´„Çø„Éº„Çí„ÇØ„É™„Ç¢</button>
                    </div>
                </div>
            </div>

            <div class="view-right">
                <div id="view-placeholder" class="placeholder-msg">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6m-6 4h6m-6 4h4"/></svg>
                    <span>Ë®≠ÂÇô„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
                </div>

                <div id="view-content" class="view-content hidden">
                    <div class="chart-row">
                        <div class="chart-toolbar">
                            <span class="chart-title">üìà Áï∞Â∏∏‰ª∂Êï∞Êé®Áßª</span>
                            <div class="period-group">
                                <button class="period-pill active" onclick="changePeriod('day', this)">Êó•Âà•</button>
                                <button class="period-pill" onclick="changePeriod('week', this)">ÈÄ±Âà•</button>
                                <button class="period-pill" onclick="changePeriod('month', this)">ÊúàÂà•</button>
                            </div>
                        </div>
                        <div class="chart-wrap">
                            <canvas id="trend-chart"></canvas>
                        </div>
                    </div>

                    <div class="table-area">
                        <div class="table-toolbar">
                            <span>üìã Ë®òÈå≤‰∏ÄË¶ß</span>
                            <button class="small-btn" onclick="exportCSV()">‚¨á CSV</button>
                            <button class="small-btn" onclick="emailCSV()">‚úâ „É°„Éº„É´</button>
                        </div>
                        <div class="table-scroll">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Êó•ÊôÇ</th>
                                        <th>Áï∞Â∏∏Âêç</th>
                                        <th>Êï¥ÁêÜNo</th>
                                        <th>„Ç™„Éó„Ç∑„Éß„É≥</th>
                                        <th>Âá¶ÁΩÆËÄÖ</th>
                                        <th>ÂÇôËÄÉ</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="records-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== MASTER SECTION ===== -->
        <div id="master-section" class="section">
            <div class="master-nav">
                <div class="panel-header">„Éû„Çπ„Çø„ÉºÁÆ°ÁêÜ</div>
                <div class="master-nav-item active" onclick="showMasterPanel('operators', this)">üë• Âá¶ÁΩÆËÄÖ</div>
                <div class="master-nav-item" onclick="showMasterPanel('equipments', this)">üè≠ Ë®≠ÂÇôÂêç</div>
                <div class="master-nav-item" onclick="showMasterPanel('orgno', this)">üî¢ Êï¥ÁêÜ No</div>
                <div class="master-nav-item" onclick="showMasterPanel('anomalies', this)">‚ö†Ô∏è Áï∞Â∏∏Âêç</div>
            </div>

            <div class="master-content">
                <div id="panel-operators" class="master-panel active">
                    <div class="panel-header">Âá¶ÁΩÆËÄÖÁÆ°ÁêÜ</div>
                    <div class="master-body">
                        <div class="master-add-col">
                            <div class="add-row">
                                <input type="text" id="new-operator" class="input-field" placeholder="Âá¶ÁΩÆËÄÖÂêç„ÇíÂÖ•Âäõ">
                                <button class="btn-add" onclick="addOperator()">ËøΩÂä†</button>
                            </div>
                        </div>
                        <div class="master-list-col" id="operator-list"></div>
                    </div>
                </div>

                <div id="panel-equipments" class="master-panel">
                    <div class="panel-header">Ë®≠ÂÇôÂêçÁÆ°ÁêÜ</div>
                    <div class="master-body">
                        <div class="master-add-col">
                            <div class="add-row">
                                <input type="text" id="new-equipment" class="input-field" placeholder="Ë®≠ÂÇôÂêç„ÇíÂÖ•Âäõ">
                                <button class="btn-add" onclick="addEquipment()">ËøΩÂä†</button>
                            </div>
                        </div>
                        <div class="master-list-col" id="equipment-list"></div>
                    </div>
                </div>

                <div id="panel-orgno" class="master-panel">
                    <div class="master-select-bar">
                        <label>Ë®≠ÂÇôÔºö</label>
                        <div class="input-field-wrap" style="flex:1;">
                            <select id="equipment-select-no" class="input-field" onchange="loadOrganizationNos()">
                                <option value="">Ë®≠ÂÇô„ÇíÈÅ∏Êäû</option>
                            </select>
                        </div>
                    </div>
                    <div class="master-body">
                        <div class="master-add-col">
                            <div class="add-row">
                                <input type="text" id="new-organization-no" class="input-field" placeholder="Êï¥ÁêÜNo„ÇíÂÖ•Âäõ">
                                <button class="btn-add" onclick="addOrganizationNo()">ËøΩÂä†</button>
                            </div>
                        </div>
                        <div class="master-list-col" id="organization-no-list"></div>
                    </div>
                </div>

                <div id="panel-anomalies" class="master-panel">
                    <div class="master-select-bar">
                        <label>Ë®≠ÂÇôÔºö</label>
                        <div class="input-field-wrap" style="flex:1;">
                            <select id="equipment-select" class="input-field" onchange="loadAnomalies()">
                                <option value="">Ë®≠ÂÇô„ÇíÈÅ∏Êäû</option>
                            </select>
                        </div>
                    </div>
                    <div class="master-body">
                        <div class="master-add-col">
                            <div class="add-row">
                                <input type="text" id="new-anomaly-name" class="input-field" placeholder="Áï∞Â∏∏Âêç„ÇíÂÖ•Âäõ">
                                <button class="btn-add" onclick="addAnomaly()">ËøΩÂä†</button>
                            </div>
                            <div class="optional-pane">
                                <div class="optional-pane-title">„Ç™„Éó„Ç∑„Éß„É≥È†ÖÁõÆË®≠ÂÆö</div>
                                <div id="optional-field-settings" style="font-size:12px; color:var(--text3);">
                                    Áï∞Â∏∏Âêç„ÅÆ„Äå„Ç™„Éó„Ç∑„Éß„É≥Ë®≠ÂÆö„Äç„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                                </div>
                                <button class="btn-add-opt" onclick="addOptionalField()">Ôºã „Ç™„Éó„Ç∑„Éß„É≥È†ÖÁõÆ„ÇíËøΩÂä†</button>
                            </div>
                        </div>
                        <div class="master-list-col" id="anomaly-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- „É¢„Éê„Ç§„É´Â∞ÇÁî®‰øùÂ≠ò„Éú„Çø„É≥ÔºàÂè≥‰∏äÂõ∫ÂÆöÔºâ -->
        <button class="mobile-save-btn" onclick="saveRecord()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            ‰øùÂ≠ò
        </button>

        <!-- ===== BOTTOM NAV (mobile only) ===== -->
        <nav class="bottom-nav">
            <button class="bnav-btn active" onclick="switchTab('input', this)" data-tab="input">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                <span>ÂÖ•Âäõ</span>
            </button>
            <button class="bnav-btn" onclick="switchTab('view', this)" data-tab="view">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3zM9 9h6m-6 4h6m-6 4h4"/></svg>
                <span>„Éá„Éº„Çø</span>
            </button>
            <button class="bnav-btn" onclick="switchTab('master', this)" data-tab="master">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>
                <span>ÁÆ°ÁêÜ</span>
            </button>
        </nav>
    </main>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!-- Chart.js -->
    <script src="https://unpkg.com/chart.js@3.9.1/dist/chart.min.js"></script>

    <script>
        // ===== Firebase =====
        const firebaseConfig = {
            apiKey: "AIzaSyBP_PxZ6Gio7BJW2F-UCIfrKy5t7y3WGhM",
            authDomain: "chokoteiapp.firebaseapp.com",
            databaseURL: "https://chokoteiapp-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "chokoteiapp",
            storageBucket: "chokoteiapp.firebasestorage.app",
            messagingSenderId: "668171085030",
            appId: "1:668171085030:web:f34cbbb7fa56d59191c727"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ===== State =====
        let selectedOperator = null;
        let selectedEquipment = null;
        let selectedEquipmentName = null;
        let selectedAnomaly = null;
        let selectedOrganizationNo = null;
        let currentViewEquipment = null;
        let currentPeriod = 'day';
        let chart = null;
        let miniChart = null;
        let todayAnomalyCounts = {};
        let allRecords = [];
        let currentFilterAnomaly = '';
        let currentFilterOrganizationNo = '';
        let masterSelectedEquipmentForOptions = null;
        let masterSelectedAnomalyForOptions = null;

        // ===== „É≠„Éº„Ç´„É´Êó•‰ªò„Éò„É´„Éë„ÉºÔºàtoISOString „ÅØUTC„ÅÆ„Åü„ÇÅÊó•Êú¨ÊôÇÈñì„Åß„ÅØÊó•‰ªò„Åå„Ç∫„É¨„ÇãÂïèÈ°å„ÇíÂõûÈÅøÔºâ=====
        function getLocalDateStr(d) {
            const date = d || new Date();
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return y + '-' + m + '-' + day;
        }

        // ===== TAB =====
        function switchTab(tabName, clickedBtn) {
            document.querySelectorAll('.nav-btn, .bnav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn, .bnav-btn').forEach(b => {
                if ((b.dataset.tab === tabName) || b === clickedBtn) b.classList.add('active');
            });
            document.getElementById(`${tabName}-section`).classList.add('active');
            // „É¢„Éê„Ç§„É´„Åß„Çø„ÉñÂàá„ÇäÊõø„ÅàÊôÇ„Å´„Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„Çí„É™„Çª„ÉÉ„Éà
            window.scrollTo(0, 0);
            if (tabName === 'input') loadInputScreen();
            else if (tabName === 'view') loadViewScreen();
            else if (tabName === 'master') loadMasterScreen();
        }

        // ===== INPUT =====
        function loadInputScreen() {
            loadOperators();
            loadEquipments();
        }

        function loadOperators() {
            database.ref('masters/operators').once('value', snap => {
                const ops = snap.val() || {};
                const c = document.getElementById('operator-buttons');
                c.innerHTML = '';
                Object.keys(ops).forEach(k => {
                    const b = makeBtn(ops[k].name, () => selectOperator(ops[k].name, b));
                    c.appendChild(b);
                });
            });
        }

        function loadEquipments() {
            database.ref('masters/equipments').once('value', snap => {
                const eqs = snap.val() || {};
                const c = document.getElementById('equipment-buttons');
                c.innerHTML = '';
                Object.keys(eqs).forEach(k => {
                    const b = makeBtn(eqs[k].name, () => selectEquipment(eqs[k].name, k, b));
                    c.appendChild(b);
                });
            });
        }

        function makeBtn(text, onClick) {
            const b = document.createElement('button');
            b.className = 'sel-btn';
            b.textContent = text;
            b.onclick = onClick;
            return b;
        }

        function selectOperator(name, btn) {
            document.querySelectorAll('#operator-buttons .sel-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedOperator = name;
        }

        function selectEquipment(name, id, btn) {
            document.querySelectorAll('#equipment-buttons .sel-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedEquipment = id;
            selectedEquipmentName = name;
            selectedAnomaly = null;
            selectedOrganizationNo = null;
            document.getElementById('organization-no-section').classList.add('hidden');
            document.getElementById('optional-fields-section').classList.add('hidden');
            todayAnomalyCounts = {};
            loadAnomalyButtons(id);

            // „Éü„Éã„Ç∞„É©„ÉïÊõ¥Êñ∞
            loadMiniChart(id, name);

            const today = getLocalDateStr();
            database.ref('records').orderByChild('date').equalTo(today).once('value').then(snap => {
                todayAnomalyCounts = {};
                snap.forEach(c => {
                    const r = c.val();
                    if (r.equipmentId === id) todayAnomalyCounts[r.anomalyName] = (todayAnomalyCounts[r.anomalyName] || 0) + 1;
                });
                loadAnomalyButtons(id);
            });
        }

        // ===== MINI CHART =====
        function loadMiniChart(equipmentId, equipmentName) {
            const chartEl = document.getElementById('input-mini-chart');
            const nameEl = document.getElementById('mini-chart-equip-name');
            nameEl.textContent = equipmentName;

            // Áõ¥Ëøë7Êó•ÂàÜ„ÅÆ„É©„Éô„É´ÁîüÊàê
            const labels = [];
            const dateCounts = {};
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const key = getLocalDateStr(d);
                labels.push(key.slice(5)); // MM-DDÂΩ¢Âºè
                dateCounts[key] = 0;
            }

            const sevenDaysAgo = Object.keys(dateCounts)[0];

            database.ref('records')
                .orderByChild('equipmentId')
                .equalTo(equipmentId)
                .once('value', snap => {
                    snap.forEach(c => {
                        const r = c.val();
                        if (r.date >= sevenDaysAgo && dateCounts.hasOwnProperty(r.date)) {
                            dateCounts[r.date]++;
                        }
                    });

                    const values = Object.values(dateCounts);
                    const total = values.reduce((a, b) => a + b, 0);
                    document.getElementById('mini-chart-total').textContent = total;

                    renderMiniChart(labels, values);
                    chartEl.classList.remove('hidden');
                });
        }

        function renderMiniChart(labels, values) {
            const ctx = document.getElementById('mini-trend-chart').getContext('2d');
            if (miniChart) miniChart.destroy();

            // ‰ªäÊó•„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÔºàÊúÄÂæå„ÅÆ„Éê„ÉºÔºâ„ÇíÂº∑Ë™ø
            const bgColors = values.map((_, i) =>
                i === values.length - 1
                    ? 'rgba(74,126,255,0.85)'
                    : 'rgba(74,126,255,0.3)'
            );
            const borderColors = values.map((_, i) =>
                i === values.length - 1
                    ? '#4a7eff'
                    : 'rgba(74,126,255,0.5)'
            );

            miniChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        data: values,
                        backgroundColor: bgColors,
                        borderColor: borderColors,
                        borderWidth: 1.5,
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => ` ${ctx.raw} ‰ª∂`
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#9098bb',
                                font: { size: 10 },
                                maxRotation: 0
                            },
                            grid: { display: false }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9098bb',
                                stepSize: 1,
                                font: { size: 10 }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        }
                    }
                }
            });
        }

        function loadAnomalyButtons(equipmentId) {
            database.ref(`masters/equipments/${equipmentId}/anomalies`).once('value', snap => {
                const anomalies = snap.val() || {};
                const c = document.getElementById('anomaly-buttons');
                const sec = document.getElementById('anomaly-section');
                c.innerHTML = '';
                const keys = Object.keys(anomalies);
                if (keys.length === 0) { sec.classList.add('hidden'); return; }
                sec.classList.remove('hidden');
                keys.forEach(k => {
                    const a = anomalies[k];
                    const b = document.createElement('button');
                    b.className = 'sel-btn';
                    b.textContent = a.name;
                    const cnt = todayAnomalyCounts[a.name] || 0;
                    if (cnt > 0) {
                        const badge = document.createElement('div');
                        badge.className = 'badge';
                        badge.textContent = cnt;
                        b.appendChild(badge);
                    }
                    b.onclick = () => selectAnomaly(a, k, b);
                    c.appendChild(b);
                });
            });
        }

        function selectAnomaly(anomaly, id, btn) {
            document.querySelectorAll('#anomaly-buttons .sel-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedAnomaly = { ...anomaly, id };
            loadOrganizationNoButtons(selectedEquipment);
            loadOptionalFields(selectedEquipment, id);
        }

        function loadOrganizationNoButtons(equipmentId) {
            database.ref(`masters/equipments/${equipmentId}/organizationNos`).once('value', snap => {
                const nos = snap.val() || {};
                const c = document.getElementById('organization-no-buttons');
                const sec = document.getElementById('organization-no-section');
                c.innerHTML = '';
                const keys = Object.keys(nos);
                if (keys.length === 0) { sec.classList.add('hidden'); return; }
                sec.classList.remove('hidden');
                keys.forEach(k => {
                    const b = makeBtn(nos[k].no, () => selectOrganizationNo(nos[k].no, b));
                    c.appendChild(b);
                });
            });
        }

        function selectOrganizationNo(no, btn) {
            document.querySelectorAll('#organization-no-buttons .sel-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedOrganizationNo = no;
        }

        function loadOptionalFields(equipmentId, anomalyId) {
            const c = document.getElementById('optional-fields-container');
            const sec = document.getElementById('optional-fields-section');
            if (!equipmentId || !anomalyId) { sec.classList.add('hidden'); c.innerHTML = ''; return; }

            database.ref(`masters/equipments/${equipmentId}/anomalies/${anomalyId}/optionalFields`).once('value').then(snap => {
                const fields = snap.val() || {};
                c.innerHTML = '';
                const keys = Object.keys(fields);
                if (keys.length === 0) { sec.classList.add('hidden'); return; }
                sec.classList.remove('hidden');
                keys.forEach(k => {
                    const f = fields[k];
                    const row = document.createElement('div');
                    row.className = 'opt-select-row';

                    const lbl = document.createElement('label');
                    lbl.textContent = f.name;

                    const wrap = document.createElement('div');
                    wrap.className = 'input-field-wrap';
                    wrap.style.flex = '1';

                    const sel = document.createElement('select');
                    sel.className = 'input-field';
                    sel.id = `optional-${k}`;

                    const def = document.createElement('option');
                    def.value = ''; def.textContent = 'ÈÅ∏Êäû';
                    sel.appendChild(def);

                    (f.options || []).forEach(o => {
                        const opt = document.createElement('option');
                        opt.value = o; opt.textContent = o;
                        sel.appendChild(opt);
                    });

                    wrap.appendChild(sel);
                    row.appendChild(lbl);
                    row.appendChild(wrap);
                    c.appendChild(row);
                });
            });
        }

        function saveRecord() {
            if (!selectedOperator || !selectedEquipment || !selectedAnomaly) {
                alert('Âá¶ÁΩÆËÄÖ„ÄÅË®≠ÂÇôÂêç„ÄÅÁï∞Â∏∏Âêç„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            const now = new Date();
            const timestamp = now.toISOString();
            const date = getLocalDateStr(now);
            const time = now.toTimeString().split(' ')[0];

            const optionalData = {};
            document.querySelectorAll('[id^="optional-"]').forEach(sel => {
                if (sel.value) optionalData[sel.id.replace('optional-', '')] = sel.value;
            });

            const record = {
                operator: selectedOperator,
                equipmentId: selectedEquipment,
                anomalyId: selectedAnomaly.id,
                anomalyName: selectedAnomaly.name,
                organizationNo: selectedOrganizationNo || '',
                timestamp, date, time,
                remarks: document.getElementById('remarks').value,
                optionalData
            };

            database.ref('records').push(record).then(() => {
                showToast('‚úì Ë®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                if (selectedEquipment) {
                    const today = getLocalDateStr();
                    database.ref('records').orderByChild('date').equalTo(today).once('value', snap => {
                        todayAnomalyCounts = {};
                        snap.forEach(c => {
                            const r = c.val();
                            if (r.equipmentId === selectedEquipment) todayAnomalyCounts[r.anomalyName] = (todayAnomalyCounts[r.anomalyName] || 0) + 1;
                        });
                        loadAnomalyButtons(selectedEquipment);
                    });
                    // „Éü„Éã„Ç∞„É©„Éï„ÇÇÊõ¥Êñ∞
                    loadMiniChart(selectedEquipment, selectedEquipmentName);
                }
                resetInputForm();
            }).catch(e => alert('‰øùÂ≠òÂ§±Êïó: ' + e.message));
        }

        function resetInputForm() {
            selectedOperator = null;
            selectedAnomaly = null;
            selectedOrganizationNo = null;
            document.querySelectorAll('.sel-btn.selected').forEach(b => b.classList.remove('selected'));
            document.getElementById('remarks').value = '';
            document.getElementById('anomaly-section').classList.add('hidden');
            document.getElementById('organization-no-section').classList.add('hidden');
            document.getElementById('optional-fields-section').classList.add('hidden');
        }

        function showToast(msg) {
            const t = document.getElementById('success-toast');
            t.textContent = msg;
            t.style.display = 'block';
            setTimeout(() => { t.style.display = 'none'; }, 2500);
        }

        // ===== VIEW =====
        function loadViewScreen() {
            database.ref('masters/equipments').once('value', snap => {
                const eqs = snap.val() || {};
                const c = document.getElementById('view-equipment-buttons');
                c.innerHTML = '';
                Object.keys(eqs).forEach(k => {
                    const b = document.createElement('button');
                    b.className = 'equip-sel-btn';
                    b.textContent = eqs[k].name;
                    b.onclick = () => selectViewEquipment(k, b);
                    c.appendChild(b);
                });
            });
        }

        function selectViewEquipment(equipmentId, btn) {
            document.querySelectorAll('.equip-sel-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            currentViewEquipment = equipmentId;

            document.getElementById('view-placeholder').classList.add('hidden');
            document.getElementById('view-content').classList.remove('hidden');

            const endDateStr = getLocalDateStr();
            const startD = new Date(); startD.setDate(startD.getDate() - 30);
            const startDateStr = getLocalDateStr(startD);
            document.getElementById('end-date').value = endDateStr;
            document.getElementById('start-date').value = startDateStr;

            currentFilterAnomaly = '';
            currentFilterOrganizationNo = '';
            loadFilterOptions(equipmentId);
            loadStats();
            updateChart();
            loadRecordsTable();
        }

        function loadFilterOptions(equipmentId) {
            database.ref(`masters/equipments/${equipmentId}/anomalies`).once('value', snap => {
                const anomalies = snap.val() || {};
                const sel = document.getElementById('filter-anomaly');
                sel.innerHTML = '<option value="">„Åô„Åπ„Å¶</option>';
                Object.keys(anomalies).forEach(k => {
                    const o = document.createElement('option');
                    o.value = anomalies[k].name; o.textContent = anomalies[k].name;
                    sel.appendChild(o);
                });
            });
            database.ref(`masters/equipments/${equipmentId}/organizationNos`).once('value', snap => {
                const nos = snap.val() || {};
                const sel = document.getElementById('filter-organization-no');
                sel.innerHTML = '<option value="">„Åô„Åπ„Å¶</option>';
                Object.keys(nos).forEach(k => {
                    const o = document.createElement('option');
                    o.value = nos[k].no; o.textContent = nos[k].no;
                    sel.appendChild(o);
                });
            });
        }

        function applyFilters() {
            currentFilterAnomaly = document.getElementById('filter-anomaly').value;
            currentFilterOrganizationNo = document.getElementById('filter-organization-no').value;
            updateChart();
            loadRecordsTable();
            updateFilteredStats();
        }

        function clearFilters() {
            document.getElementById('filter-anomaly').value = '';
            document.getElementById('filter-organization-no').value = '';
            currentFilterAnomaly = '';
            currentFilterOrganizationNo = '';
            updateChart();
            loadRecordsTable();
            loadStats();
        }

        function updateFilteredStats() {
            if (!currentViewEquipment) return;
            const today = getLocalDateStr();
            const yesterday = getLastWorkday();
            let tc = 0, yc = 0;
            allRecords.forEach(r => {
                if (r.equipmentId !== currentViewEquipment) return;
                const ma = !currentFilterAnomaly || r.anomalyName === currentFilterAnomaly;
                const mo = !currentFilterOrganizationNo || r.organizationNo === currentFilterOrganizationNo;
                if (ma && mo) {
                    if (r.date === today) tc++;
                    if (r.date === yesterday) yc++;
                }
            });
            // stat cards removed
        }

        function loadStats() {
            if (!currentViewEquipment) return;
            const today = getLocalDateStr();
            const yesterday = getLastWorkday();
            // equipmentId „ÅßFirebaseÂÅ¥„Éï„Ç£„É´„Çø„Åó„Å¶ÂÖ®‰ª∂ÂèñÂæó„ÇíÂõûÈÅø
            database.ref('records')
                .orderByChild('equipmentId')
                .equalTo(currentViewEquipment)
                .once('value', snap => {
                    allRecords = [];
                    snap.forEach(c => allRecords.push(c.val()));
                    let tc = 0, yc = 0;
                    allRecords.forEach(r => {
                        if (r.date === today) tc++;
                        if (r.date === yesterday) yc++;
                    });
                    // stat cards removed
                });
        }

        function getLastWorkday() {
            const d = new Date();
            d.setDate(d.getDate() - 1);
            while (d.getDay() === 0 || d.getDay() === 6) d.setDate(d.getDate() - 1);
            return getLocalDateStr(d);
        }

        function changePeriod(period, btn) {
            currentPeriod = period;
            document.querySelectorAll('.period-pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateChart();
        }

        function updateChart() {
            if (!currentViewEquipment) return;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            if (!startDate || !endDate) return;

            database.ref('records').orderByChild('equipmentId').equalTo(currentViewEquipment).once('value', snap => {
                const records = [];
                snap.forEach(c => {
                    const r = c.val();
                    if (r.date >= startDate && r.date <= endDate) {
                        const ma = !currentFilterAnomaly || r.anomalyName === currentFilterAnomaly;
                        const mo = !currentFilterOrganizationNo || r.organizationNo === currentFilterOrganizationNo;
                        if (ma && mo) records.push(r);
                    }
                });
                renderChart(aggregateData(records, startDate, endDate, currentPeriod));
            });
        }

        function loadRecordsTable() {
            if (!currentViewEquipment) return;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            if (!startDate || !endDate) return;

            database.ref('records').orderByChild('equipmentId').equalTo(currentViewEquipment).once('value', snap => {
                const records = [];
                snap.forEach(c => {
                    const r = c.val();
                    if (r.date >= startDate && r.date <= endDate) {
                        const ma = !currentFilterAnomaly || r.anomalyName === currentFilterAnomaly;
                        const mo = !currentFilterOrganizationNo || r.organizationNo === currentFilterOrganizationNo;
                        if (ma && mo) records.push({ _key: c.key, ...r });
                    }
                });
                records.sort((a, b) => b.timestamp.localeCompare(a.timestamp));
                const tbody = document.getElementById('records-tbody');
                tbody.innerHTML = '';
                if (records.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="no-data">Ë©≤ÂΩì„Éá„Éº„Çø„Å™„Åó</td></tr>';
                    return;
                }
                records.forEach(r => {
                    let optText = '-';
                    if (r.optionalData && Object.keys(r.optionalData).length > 0) optText = Object.values(r.optionalData).join(' / ');
                    const tr = document.createElement('tr');
                    const key = r._key;
                    tr.innerHTML =
                        '<td>' + r.date + ' ' + r.time + '</td>' +
                        '<td>' + r.anomalyName + '</td>' +
                        '<td>' + (r.organizationNo || '-') + '</td>' +
                        '<td>' + optText + '</td>' +
                        '<td>' + r.operator + '</td>' +
                        '<td>' + (r.remarks || '') + '</td>' +
                        '<td><button class="rec-del-btn" onclick="deleteRecord(this, \'' + key + '\')">ÂâäÈô§</button></td>';
                    tbody.appendChild(tr);
                });
            });
        }

        function deleteRecord(btn, key) {
            if (!confirm('„Åì„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ')) return;
            database.ref('records/' + key).remove().then(() => {
                const tr = btn.closest('tr');
                tr.style.transition = 'opacity 0.3s';
                tr.style.opacity = '0';
                setTimeout(() => tr.remove(), 300);
                showToast('üóë Â±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
                updateChart();
                loadStats();
            }).catch(e => alert('ÂâäÈô§Â§±Êïó: ' + e.message));
        }

        function buildCSV(records) {
            const headers = ['Êó•ÊôÇ', 'Áï∞Â∏∏Âêç', 'Êï¥ÁêÜNo', '„Ç™„Éó„Ç∑„Éß„É≥È†ÖÁõÆ', 'Âá¶ÁΩÆËÄÖ', 'ÂÇôËÄÉ'];
            const esc = v => `"${String(v ?? '').replace(/"/g, '""')}"`;
            const lines = [headers.map(esc).join(',')];
            records.forEach(r => {
                let optText = '';
                if (r.optionalData && Object.keys(r.optionalData).length > 0) optText = Object.values(r.optionalData).join(' / ');
                lines.push([`${r.date} ${r.time}`, r.anomalyName || '', r.organizationNo || '', optText, r.operator || '', r.remarks || ''].map(esc).join(','));
            });
            return lines.join('\r\n');
        }

        function exportCSV() {
            if (!currentViewEquipment) { alert('Ë®≠ÂÇô„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            const s = document.getElementById('start-date').value;
            const e = document.getElementById('end-date').value;
            if (!s || !e) { alert('ÊúüÈñì„ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            database.ref('records').orderByChild('equipmentId').equalTo(currentViewEquipment).once('value', snap => {
                const records = [];
                snap.forEach(c => {
                    const r = c.val();
                    if (r.date >= s && r.date <= e) {
                        const ma = !currentFilterAnomaly || r.anomalyName === currentFilterAnomaly;
                        const mo = !currentFilterOrganizationNo || r.organizationNo === currentFilterOrganizationNo;
                        if (ma && mo) records.push(r);
                    }
                });
                if (!records.length) { alert('Âá∫Âäõ„Éá„Éº„Çø„Å™„Åó'); return; }
                records.sort((a, b) => b.timestamp.localeCompare(a.timestamp));
                const blob = new Blob(['\uFEFF' + buildCSV(records)], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `chokotei_${new Date().toISOString().split('T')[0].replace(/-/g,'')}.csv`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }

        function emailCSV() {
            if (!currentViewEquipment) { alert('Ë®≠ÂÇô„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            const s = document.getElementById('start-date').value;
            const e = document.getElementById('end-date').value;
            if (!s || !e) { alert('ÊúüÈñì„ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            database.ref('records').orderByChild('equipmentId').equalTo(currentViewEquipment).once('value', snap => {
                const records = [];
                snap.forEach(c => {
                    const r = c.val();
                    if (r.date >= s && r.date <= e) {
                        const ma = !currentFilterAnomaly || r.anomalyName === currentFilterAnomaly;
                        const mo = !currentFilterOrganizationNo || r.organizationNo === currentFilterOrganizationNo;
                        if (ma && mo) records.push(r);
                    }
                });
                if (!records.length) { alert('ÈÄÅ‰ø°„Éá„Éº„Çø„Å™„Åó'); return; }
                records.sort((a, b) => b.timestamp.localeCompare(a.timestamp));
                const subject = encodeURIComponent(`„ÉÅ„Éß„Ç≥ÂÅúË®òÈå≤CSV (${s} ÔΩû ${e})`);
                const body = encodeURIComponent('‚Äª„ÉÅ„Éß„Ç≥ÂÅúË®òÈå≤„Ç¢„Éó„É™„Çà„ÇäËá™Âãï‰ΩúÊàê\n\n' + buildCSV(records));
                window.location.href = `mailto:?subject=${subject}&body=${body}`;
            });
        }

        function aggregateData(records, startDate, endDate, period) {
            const counts = {};
            records.forEach(r => {
                const d = new Date(r.date);
                let key;
                if (period === 'day') key = r.date;
                else if (period === 'week') {
                    const ws = new Date(d); ws.setDate(d.getDate() - d.getDay()); key = ws.toISOString().split('T')[0];
                } else key = r.date.substring(0, 7);
                counts[key] = (counts[key] || 0) + 1;
            });
            const labels = [], values = [];
            const start = new Date(startDate), end = new Date(endDate);
            if (period === 'day') {
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const k = d.toISOString().split('T')[0]; labels.push(k); values.push(counts[k] || 0);
                }
            } else if (period === 'week') {
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 7)) {
                    const k = d.toISOString().split('T')[0]; labels.push(k); values.push(counts[k] || 0);
                }
            } else {
                for (let d = new Date(start); d <= end; d.setMonth(d.getMonth() + 1)) {
                    const k = d.toISOString().substring(0, 7); labels.push(k); values.push(counts[k] || 0);
                }
            }
            return { labels, values };
        }

        function renderChart(data) {
            const ctx = document.getElementById('trend-chart').getContext('2d');
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Áï∞Â∏∏‰ª∂Êï∞',
                        data: data.values,
                        borderColor: '#5b8cff',
                        backgroundColor: 'rgba(91,140,255,0.1)',
                        tension: 0.4, fill: true,
                        pointBackgroundColor: '#5b8cff',
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            ticks: { color: '#5c6380', font: { size: 10 }, maxTicksLimit: 10 },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#5c6380', stepSize: 1, font: { size: 10 } },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        }
                    }
                }
            });
        }

        // ===== MASTER =====
        function showMasterPanel(name, clickedItem) {
            document.querySelectorAll('.master-nav-item').forEach(i => i.classList.remove('active'));
            document.querySelectorAll('.master-panel').forEach(p => p.classList.remove('active'));
            clickedItem.classList.add('active');
            document.getElementById(`panel-${name}`).classList.add('active');
        }

        function loadMasterScreen() {
            loadOperatorList();
            loadEquipmentList();
            loadEquipmentSelect();
            loadEquipmentSelectForNo();
        }

        function loadOperatorList() {
            database.ref('masters/operators').once('value', snap => {
                const ops = snap.val() || {};
                const c = document.getElementById('operator-list');
                c.innerHTML = '';
                Object.keys(ops).forEach(k => {
                    c.appendChild(makeMasterItem(ops[k].name, [], () => deleteOperator(k)));
                });
            });
        }

        function addOperator() {
            const name = document.getElementById('new-operator').value.trim();
            if (!name) { alert('Âá¶ÁΩÆËÄÖÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            database.ref('masters/operators').push({ name }).then(() => {
                document.getElementById('new-operator').value = '';
                loadOperatorList(); loadOperators();
            });
        }

        function deleteOperator(k) {
            if (confirm('„Åì„ÅÆÂá¶ÁΩÆËÄÖ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) database.ref(`masters/operators/${k}`).remove().then(() => { loadOperatorList(); loadOperators(); });
        }

        function loadEquipmentList() {
            database.ref('masters/equipments').once('value', snap => {
                const eqs = snap.val() || {};
                const c = document.getElementById('equipment-list');
                c.innerHTML = '';
                Object.keys(eqs).forEach(k => {
                    c.appendChild(makeMasterItem(eqs[k].name, [], () => deleteEquipment(k)));
                });
            });
        }

        function addEquipment() {
            const name = document.getElementById('new-equipment').value.trim();
            if (!name) { alert('Ë®≠ÂÇôÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            database.ref('masters/equipments').push({ name, anomalies: {} }).then(() => {
                document.getElementById('new-equipment').value = '';
                loadEquipmentList(); loadEquipments(); loadEquipmentSelect(); loadEquipmentSelectForNo();
            });
        }

        function deleteEquipment(k) {
            if (confirm('„Åì„ÅÆË®≠ÂÇô„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) database.ref(`masters/equipments/${k}`).remove().then(() => {
                loadEquipmentList(); loadEquipments(); loadEquipmentSelect(); loadEquipmentSelectForNo();
            });
        }

        function makeMasterItem(text, extraBtns, onDelete) {
            const div = document.createElement('div');
            div.className = 'master-item';
            const span = document.createElement('span'); span.textContent = text;
            const actions = document.createElement('div'); actions.className = 'master-item-actions';
            extraBtns.forEach(({ label, fn }) => {
                const b = document.createElement('button'); b.className = 'btn-opt'; b.textContent = label; b.onclick = fn;
                actions.appendChild(b);
            });
            const del = document.createElement('button'); del.className = 'btn-del'; del.textContent = 'ÂâäÈô§'; del.onclick = onDelete;
            actions.appendChild(del);
            div.appendChild(span); div.appendChild(actions);
            return div;
        }

        function loadEquipmentSelectForNo() {
            database.ref('masters/equipments').once('value', snap => {
                const eqs = snap.val() || {};
                const sel = document.getElementById('equipment-select-no');
                sel.innerHTML = '<option value="">Ë®≠ÂÇô„ÇíÈÅ∏Êäû</option>';
                Object.keys(eqs).forEach(k => {
                    const o = document.createElement('option'); o.value = k; o.textContent = eqs[k].name; sel.appendChild(o);
                });
            });
        }

        function loadOrganizationNos() {
            const equipmentId = document.getElementById('equipment-select-no').value;
            if (!equipmentId) return;
            database.ref(`masters/equipments/${equipmentId}/organizationNos`).once('value', snap => {
                const nos = snap.val() || {};
                const c = document.getElementById('organization-no-list');
                c.innerHTML = '';
                Object.keys(nos).forEach(k => {
                    c.appendChild(makeMasterItem(nos[k].no, [], () => deleteOrganizationNo(equipmentId, k)));
                });
            });
        }

        function addOrganizationNo() {
            const equipmentId = document.getElementById('equipment-select-no').value;
            const no = document.getElementById('new-organization-no').value.trim();
            if (!no) { alert('Êï¥ÁêÜNo„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            database.ref(`masters/equipments/${equipmentId}/organizationNos`).push({ no }).then(() => {
                document.getElementById('new-organization-no').value = '';
                loadOrganizationNos();
            });
        }

        function deleteOrganizationNo(equipmentId, k) {
            if (confirm('„Åì„ÅÆÊï¥ÁêÜNo„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) database.ref(`masters/equipments/${equipmentId}/organizationNos/${k}`).remove().then(() => loadOrganizationNos());
        }

        function loadEquipmentSelect() {
            database.ref('masters/equipments').once('value', snap => {
                const eqs = snap.val() || {};
                const sel = document.getElementById('equipment-select');
                sel.innerHTML = '<option value="">Ë®≠ÂÇô„ÇíÈÅ∏Êäû</option>';
                Object.keys(eqs).forEach(k => {
                    const o = document.createElement('option'); o.value = k; o.textContent = eqs[k].name; sel.appendChild(o);
                });
            });
        }

        function loadAnomalies() {
            const equipmentId = document.getElementById('equipment-select').value;
            masterSelectedEquipmentForOptions = equipmentId || null;
            masterSelectedAnomalyForOptions = null;
            document.getElementById('optional-field-settings').innerHTML = 'Áï∞Â∏∏Âêç„ÅÆ„Äå„Ç™„Éó„Ç∑„Éß„É≥Ë®≠ÂÆö„Äç„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
            if (!equipmentId) { document.getElementById('anomaly-list').innerHTML = ''; return; }

            database.ref(`masters/equipments/${equipmentId}/anomalies`).once('value', snap => {
                const anomalies = snap.val() || {};
                const c = document.getElementById('anomaly-list');
                c.innerHTML = '';
                Object.keys(anomalies).forEach(k => {
                    const a = anomalies[k];
                    c.appendChild(makeMasterItem(a.name, [
                        { label: '„Ç™„Éó„Ç∑„Éß„É≥Ë®≠ÂÆö', fn: () => selectAnomalyForOptions(equipmentId, k) }
                    ], () => deleteAnomaly(equipmentId, k)));
                });
            });
        }

        function selectAnomalyForOptions(equipmentId, anomalyKey) {
            masterSelectedEquipmentForOptions = equipmentId;
            masterSelectedAnomalyForOptions = anomalyKey;
            loadOptionalFieldSettings(equipmentId, anomalyKey);
        }

        function addAnomaly() {
            const equipmentId = document.getElementById('equipment-select').value;
            const name = document.getElementById('new-anomaly-name').value.trim();
            if (!equipmentId) { alert('Ë®≠ÂÇô„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            if (!name) { alert('Áï∞Â∏∏Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            database.ref(`masters/equipments/${equipmentId}/anomalies`).push({ name }).then(() => {
                document.getElementById('new-anomaly-name').value = '';
                loadAnomalies();
            });
        }

        function deleteAnomaly(equipmentId, anomalyKey) {
            if (confirm('„Åì„ÅÆÁï∞Â∏∏Âêç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                database.ref(`masters/equipments/${equipmentId}/anomalies/${anomalyKey}`).remove().then(() => {
                    if (masterSelectedAnomalyForOptions === anomalyKey) {
                        masterSelectedAnomalyForOptions = null;
                        document.getElementById('optional-field-settings').innerHTML = 'Áï∞Â∏∏Âêç„ÅÆ„Äå„Ç™„Éó„Ç∑„Éß„É≥Ë®≠ÂÆö„Äç„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    }
                    loadAnomalies();
                });
            }
        }

        function loadOptionalFieldSettings(equipmentId, anomalyKey) {
            const c = document.getElementById('optional-field-settings');
            if (!equipmentId || !anomalyKey) { c.innerHTML = 'Áï∞Â∏∏Âêç„ÅÆ„Äå„Ç™„Éó„Ç∑„Éß„É≥Ë®≠ÂÆö„Äç„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'; return; }
            database.ref(`masters/equipments/${equipmentId}/anomalies/${anomalyKey}/optionalFields`).once('value').then(snap => {
                const fields = snap.val() || {};
                const keys = Object.keys(fields);
                c.innerHTML = '';
                if (keys.length === 0) { c.textContent = '„Ç™„Éó„Ç∑„Éß„É≥È†ÖÁõÆ„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ'; return; }
                keys.forEach(k => {
                    const f = fields[k];
                    const div = document.createElement('div'); div.className = 'opt-item';
                    div.innerHTML = `
                        <div class="opt-item-head">
                            <span class="opt-item-name">${f.name}</span>
                            <button class="btn-del" style="font-size:10px; padding:4px 8px;" onclick="deleteOptionalField('${equipmentId}','${anomalyKey}','${k}')">ÂâäÈô§</button>
                        </div>
                        <div class="opt-item-opts">ÈÅ∏ÊäûËÇ¢: ${(f.options || []).join(', ')}</div>
                    `;
                    c.appendChild(div);
                });
            });
        }

        function addOptionalField() {
            const equipmentId = masterSelectedEquipmentForOptions;
            const anomalyKey = masterSelectedAnomalyForOptions;
            if (!equipmentId || !anomalyKey) { alert('„Ç™„Éó„Ç∑„Éß„É≥È†ÖÁõÆ„ÇíË®≠ÂÆö„Åô„ÇãÁï∞Â∏∏Âêç„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'); return; }
            const fieldName = prompt('„Ç™„Éó„Ç∑„Éß„É≥È†ÖÁõÆÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
            if (!fieldName) return;
            const optionsStr = prompt('ÈÅ∏ÊäûËÇ¢„Çí„Ç´„É≥„ÉûÂå∫Âàá„Çä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:\n‰æã: ÈÅ∏ÊäûËÇ¢1,ÈÅ∏ÊäûËÇ¢2,ÈÅ∏ÊäûËÇ¢3');
            if (!optionsStr) return;
            const options = optionsStr.split(',').map(s => s.trim()).filter(s => s);
            database.ref(`masters/equipments/${equipmentId}/anomalies/${anomalyKey}/optionalFields`).push({ name: fieldName, options })
                .then(() => {
                    loadOptionalFieldSettings(equipmentId, anomalyKey);
                    if (selectedEquipment === equipmentId && selectedAnomaly && selectedAnomaly.id === anomalyKey) loadOptionalFields(equipmentId, anomalyKey);
                });
        }

        function deleteOptionalField(equipmentId, anomalyKey, fieldKey) {
            if (!confirm('„Åì„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥È†ÖÁõÆ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
            database.ref(`masters/equipments/${equipmentId}/anomalies/${anomalyKey}/optionalFields/${fieldKey}`).remove().then(() => {
                loadOptionalFieldSettings(equipmentId, anomalyKey);
                if (selectedEquipment === equipmentId && selectedAnomaly && selectedAnomaly.id === anomalyKey) loadOptionalFields(equipmentId, anomalyKey);
            });
        }

        document.addEventListener('DOMContentLoaded', () => { loadInputScreen(); });
    </script>
</body>
</html>
