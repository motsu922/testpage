<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å“è³ªå‘¼ã³å‡ºã—ãƒ¢ãƒ‹ã‚¿ãƒ¼</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', 'Hiragino Sans', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    /* æ¨ªã«é–“å»¶ã³é˜²æ­¢ï¼šæœ€å¤§å¹…ï¼‹ä¸­å¤®å¯„ã› */
.page{
  max-width: none;
  width: 100%;
  margin: 0;
}



    .header {
      background: rgba(255, 255, 255, 0.95);
      padding: 20px 30px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .header h1 {
      font-size: 2rem;
      color: #333;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .sound-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #fff3e0;
      padding: 12px 16px;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
      border: 1px solid rgba(0,0,0,.06);
    }
    .sound-toggle input {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .btn{
      border: none;
      border-radius: 10px;
      padding: 12px 14px;
      font-weight: 800;
      cursor: pointer;
      transition: .15s;
      box-shadow: 0 3px 10px rgba(0,0,0,.12);
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0); }
    .btn-secondary{ background: #eceff1; color:#263238; }
    .btn-secondary:hover{ background:#e3e7ea; }
    .btn-logout{ background:#ef5350; color:#fff; }
    .btn-logout:hover{ background:#e53935; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      text-align: center;
      transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-label {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 15px;
      color: #666;
    }
    .stat-value {
      font-size: 3.5rem;
      font-weight: bold;
      color: #333;
    }
    .stat-card.urgent .stat-value { color: #ef5350; }
    .stat-card.normal .stat-value { color: #ffa726; }
    .stat-card.inprogress .stat-value { color: #42a5f5; }
    .stat-card.completed .stat-value { color: #66bb6a; }

    .filter-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .filter-btn {
      flex: 1;
      min-width: 120px;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      background: rgba(255, 255, 255, 0.8);
      color: #333;
    }
    .filter-btn.active {
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      transform: translateY(-2px);
    }

    /* âœ… æœ€å¤§3åˆ—ã‚°ãƒªãƒƒãƒ‰ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã§2â†’1åˆ—ï¼‰ */
.cases-container{
  display: grid;
  gap: 15px;

  /* âœ… æ¨ªå¹…ã‚’ä½¿ã„åˆ‡ã‚‹ï¼šæœ€å°å¹…320pxã‚’åŸºæº–ã«ã€å…¥ã‚‹ã ã‘åˆ—ã‚’å¢—ã‚„ã™ */
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  align-items: stretch;
}

    @media (max-width: 980px){
      .cases-container{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 560px){
      .cases-container{ grid-template-columns: 1fr; }
    }

    .case-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: transform 0.2s;
      position: relative;
      overflow: hidden;

      height: 100%;
      display: flex;
      flex-direction: column;
    }
    .case-card:hover { transform: translateY(-3px); }
    .case-card.completed {
      opacity: 0.65;
      filter: saturate(.9);
    }

    .priority-bar {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 6px;
    }
    .priority-bar.urgent { background: #ef5350; }
    .priority-bar.normal { background: #ffa726; }

    .case-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      gap: 12px;
    }
    .case-title {
      font-size: 1.2rem;
      font-weight: 900;
      color: #333;
      line-height: 1.2;
    }
    .case-time {
      color: #666;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .case-info {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }
    .info-item {
      display: flex;
      gap: 8px;
      align-items: baseline;
    }
    .info-label {
      font-weight: 900;
      color: #555;
      white-space: nowrap;
    }
    .info-value {
      color: #333;
      word-break: break-word;
    }

    .message-box {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 15px;
      white-space: pre-wrap;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 900;
      margin-bottom: 10px;
    }
    .status-badge.pending { background: #ffebee; color: #c62828; }
    .status-badge.inprogress { background: #e3f2fd; color: #1565c0; }
    .status-badge.completed { background: #e8f5e9; color: #2e7d32; }

    /* âœ… å¯¾å¿œä¸­ æ‹…å½“è€… å¼·èª¿è¡¨ç¤º + é ­æ–‡å­—ãƒãƒƒã‚¸ */
    .responder-highlight{
      margin: 6px 0 14px;
      padding: 12px 14px;
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      border-left: 6px solid #1e88e5;
      border-radius: 10px;
      font-size: 1.25rem;
      font-weight: 1000;
      color: #0d47a1;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .initial-badge{
      width: 44px;
      height: 44px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 1000;
      font-size: 1.05rem;
      letter-spacing: .5px;
      color: #ffffff;
      background: radial-gradient(circle at 30% 30%, #6a5cff, #2a1b8f);
      box-shadow: 0 6px 14px rgba(13,71,161,.25);
      flex: 0 0 auto;
      user-select: none;
    }
    .responder-name{
      line-height: 1.15;
      min-width: 0;
    }
    .responder-name .sub{
      display:block;
      margin-top: 2px;
      font-size: .92rem;
      font-weight: 900;
      color: rgba(13,71,161,.85);
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: auto; /* âœ… ãƒœã‚¿ãƒ³ã‚’ä¸‹ã«å¯„ã›ã‚‹ */
    }
    .actions .btn {
      flex: 1;
      min-width: 110px;
      padding: 12px;
      border-radius: 10px;
      font-weight: 900;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      box-shadow: none;
    }
    .btn-inprogress { background: #42a5f5; color: #fff; }
    .btn-inprogress:hover { background: #1e88e5; }
    .btn-complete { background: #66bb6a; color: #fff; }
    .btn-complete:hover { background: #43a047; }
    .btn-open-anomaly { background: #7e57c2; color: #fff; }
    .btn-open-anomaly:hover { background: #5e35b1; }

    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 20px;
      color: rgba(255, 255, 255, 0.95);
      font-size: 1.2rem;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 16px;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: #fff;
      padding: 24px;
      border-radius: 15px;
      width: 100%;
      max-width: 520px;
      max-height: 85vh;
      overflow: auto;
    }
    .modal-content h3 {
      margin-bottom: 15px;
      color: #333;
      font-size: 1.4rem;
      font-weight: 1000;
    }
    .modal-content textarea {
      width: 100%;
      min-height: 110px;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 10px;
      resize: vertical;
      font-family: inherit;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .modal-actions .btn {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      border: none;
      font-weight: 900;
      cursor: pointer;
      box-shadow:none;
    }
    .btn-cancel { background: #e0e0e0; }
    .btn-save { background: #667eea; color: #fff; }

    /* QCãƒ¡ãƒ³ãƒãƒ¼ç®¡ç† */
    .panel{
      background:#f8f9fa;
      border:1px solid rgba(0,0,0,.06);
      border-radius: 12px;
      padding: 14px;
      margin: 12px 0;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
    }
    .row > *{
      flex: 1;
      min-width: 160px;
    }
    .input, .select{
      width:100%;
      padding: 12px;
      border:2px solid #ddd;
      border-radius: 10px;
      font-size: 1rem;
    }
    .list{
      display:flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }
    .item{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px;
      background:#fff;
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }
    .item small{ color:#666; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:#eef2ff;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight:1000;
      color:#3949ab;
      font-size: .85rem;
      white-space: nowrap;
    }
    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      white-space: nowrap;
      user-select:none;
      font-weight: 900;
    }

    @media (max-width: 768px) {
  body{
    padding: clamp(10px, 1.8vw, 22px);
  }
}
  </style>
</head>

<body>
  <div class="page">
    <div class="header">
      <h1>ğŸ“¢ å“è³ªå‘¼ã³å‡ºã—ãƒ¢ãƒ‹ã‚¿ãƒ¼</h1>

      <div class="header-actions">
        <label class="sound-toggle" title="ONã«ã™ã‚‹ã¨éŸ³å£°ãŒé³´ã‚Šã¾ã™ï¼ˆåˆå›ã¯éŸ³ã®è§£éŒ ãŒå¿…è¦ã§ã™ï¼‰">
          <input type="checkbox" id="soundNotification">
          <span>ğŸ”Š éŸ³å£°é€šçŸ¥</span>
        </label>

        <button class="btn btn-secondary" id="qcMembersBtn">ğŸ‘¥ QCãƒ¡ãƒ³ãƒãƒ¼</button>
        <button class="btn btn-logout" id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card urgent">
        <div class="stat-label">ç·Šæ€¥ãƒ»æœªå¯¾å¿œ</div>
        <div class="stat-value" id="statUrgentPending">0</div>
      </div>
      <div class="stat-card normal">
        <div class="stat-label">é€šå¸¸ãƒ»æœªå¯¾å¿œ</div>
        <div class="stat-value" id="statNormalPending">0</div>
      </div>
      <div class="stat-card inprogress">
        <div class="stat-label">å¯¾å¿œä¸­</div>
        <div class="stat-value" id="statInProgress">0</div>
      </div>
      <div class="stat-card completed">
        <div class="stat-label">æœ¬æ—¥å®Œäº†</div>
        <div class="stat-value" id="statCompletedToday">0</div>
      </div>
    </div>

    <div class="filter-bar">
      <button class="filter-btn active" data-filter="all">ã™ã¹ã¦</button>
      <button class="filter-btn" data-filter="pending">æœªå¯¾å¿œ</button>
      <button class="filter-btn" data-filter="inprogress">å¯¾å¿œä¸­</button>
      <button class="filter-btn" data-filter="completed">å®Œäº†</button>
    </div>

    <div id="casesContainer" class="cases-container"></div>

    <!-- å¯¾å¿œï¼ˆé–‹å§‹/å®Œäº†ï¼‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="completeModal" class="modal">
      <div class="modal-content">
        <h3 id="completeModalTitle">å¯¾å¿œå®Œäº†</h3>

        <div style="margin-bottom:15px;">
          <label style="display:block;font-weight:1000;margin-bottom:8px;">æ‹…å½“è€… *</label>
          <select id="completeBySelect" class="select">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
          <div style="margin-top:8px;color:#666;font-size:.85rem;">
            â€» å€™è£œã¯ <b>qc_members</b>ï¼ˆenabled=trueï¼‰ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã™
          </div>
        </div>

        <div>
          <label style="display:block;font-weight:1000;margin-bottom:8px;">å¯¾å¿œå†…å®¹ï¼ˆä»»æ„ï¼‰</label>
          <textarea id="completeMessage" placeholder="å®Ÿæ–½ã—ãŸå¯¾å¿œå†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„."></textarea>
        </div>

        <div class="modal-actions">
          <button class="btn btn-save" id="confirmComplete">ä¿å­˜</button>
          <button class="btn btn-cancel" id="cancelComplete">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
    </div>

    <!-- QCãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="qcMembersModal" class="modal">
      <div class="modal-content">
        <h3>ğŸ‘¥ QCãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</h3>

        <div class="panel">
          <div style="font-weight:1000;color:#3949ab;margin-bottom:10px;">æ–°è¦è¿½åŠ </div>
          <div class="row">
            <input id="qcNewName" class="input" placeholder="æ°åï¼ˆä¾‹ï¼šæ‰æœ¬ï¼‰">
            <input id="qcNewEmail" class="input" placeholder="ãƒ¡ãƒ¼ãƒ«ï¼ˆä¾‹ï¼šxxx@miyama...ï¼‰">
          </div>
          <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-secondary" id="qcCloseBtn" style="flex:1;">é–‰ã˜ã‚‹</button>
            <button class="btn btn-save" id="qcAddBtn" style="flex:1;">è¿½åŠ </button>
          </div>
          <div style="margin-top:10px;color:#666;font-size:.85rem;">
            â€» enabled=true ã®ãƒ¡ãƒ³ãƒãƒ¼ã ã‘ãŒã€Œæ‹…å½“è€…é¸æŠã€ã«å‡ºã¾ã™
          </div>
        </div>

        <div class="panel">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <div style="font-weight:1000;color:#3949ab;">ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§</div>
            <span class="pill">ä»¶æ•°: <span id="qcCount">0</span></span>
          </div>
          <div id="qcList" class="list"></div>
        </div>
      </div>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
    import {
      getFirestore,
      collection, onSnapshot, query, orderBy,
      addDoc, updateDoc, setDoc, deleteDoc, doc, serverTimestamp, getDoc
    } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyA0YUIpIDh4WB4p1ewiNB0XfwHve0ByljU",
      authDomain: "abnreport-fd733.firebaseapp.com",
      projectId: "abnreport-fd733",
      storageBucket: "abnreport-fd733.firebasestorage.app",
      messagingSenderId: "349748947315",
      appId: "1:349748947315:web:010cb671d2a95bcf1f7d06"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ç•°å¸¸å±¥æ­´ã‚¢ãƒ—ãƒªURLï¼ˆåŒéšå±¤ï¼‰
    const ANOMALY_APP_URL = './abnreports.html';

    let casesCache = [];
    let currentCompleteCase = null;
    let modalMode = 'complete'; // 'inprogress' or 'complete'

    // ===== sound =====
    let soundEnabled = localStorage.getItem('sound_enabled') === 'true';
    const soundCheckbox = document.getElementById('soundNotification');
    soundCheckbox.checked = soundEnabled;

    // æ–°è¦æ¤œçŸ¥ç”¨
    let previousCaseIds = new Set();

    // ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒ åˆ¶å¾¡
    let urgentAlarmTimer = null;
    let hasUrgentPending = false;
    let prevHasUrgentPending = false;
    const URGENT_ALARM_INTERVAL_MS = 8000; // 8ç§’ã”ã¨ï¼ˆå¥½ã¿ã§å¤‰æ›´OKï¼‰

    // Audio
    let audioCtx = null;

    async function unlockAudio() {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if (!AudioCtx) return false;
      try {
        audioCtx = audioCtx || new AudioCtx();
        if (audioCtx.state === 'suspended') await audioCtx.resume();

        // ç„¡éŸ³ãƒãƒƒãƒ•ã‚¡ã§è§£éŒ 
        const buffer = audioCtx.createBuffer(1, 1, audioCtx.sampleRate);
        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(audioCtx.destination);
        source.start(0);
        return true;
      } catch (e) {
        console.warn(e);
        return false;
      }
    }

    // âœ… 2ç¨®é¡ãƒãƒ£ã‚¤ãƒ ï¼ˆé€šå¸¸ / ç·Šæ€¥ï¼‰
    function playChime(type = 'normal') {
      if (!soundEnabled) return;
      if (!audioCtx) return;

      const ctx = audioCtx;
      const t0 = ctx.currentTime;

      const master = ctx.createGain();
      master.connect(ctx.destination);

      const peak = (type === 'urgent') ? 0.34 : 0.28;
      master.gain.setValueAtTime(0.0001, t0);
      master.gain.exponentialRampToValueAtTime(peak, t0 + 0.02);
      master.gain.exponentialRampToValueAtTime(0.0001, t0 + 1.6);

      const filter = ctx.createBiquadFilter();
      filter.type = "highpass";
      filter.frequency.setValueAtTime(type === 'urgent' ? 320 : 380, t0);
      filter.connect(master);

      function note(freq, start, dur, oscType="sine", vel=1.0) {
        const osc = ctx.createOscillator();
        const g = ctx.createGain();

        osc.type = oscType;
        osc.frequency.setValueAtTime(freq, t0 + start);

        g.gain.setValueAtTime(0.0001, t0 + start);
        g.gain.exponentialRampToValueAtTime(0.24 * vel, t0 + start + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + start + dur);

        osc.connect(g);
        g.connect(filter);

        osc.start(t0 + start);
        osc.stop(t0 + start + dur);
      }

      if (type === 'normal') {
        // é€šå¸¸ï¼šã‚­ãƒ©ãƒƒï¼ˆä¸Šæ˜‡ãƒãƒ£ã‚¤ãƒ ï¼‰
        note(1046.5, 0.00, 0.28, "sine", 0.95); // C6
        note(1318.5, 0.14, 0.28, "sine", 0.90); // E6
        note(1568.0, 0.28, 0.30, "sine", 0.85); // G6
        note(2093.0, 0.46, 0.52, "sine", 0.80); // C7
        note(523.25, 0.00, 0.95, "triangle", 0.20); // ä½™éŸ»
      } else {
        // ç·Šæ€¥ï¼šæ³¨æ„å–šèµ·ï¼ˆ2å›ãƒãƒ£ã‚¤ãƒ ï¼‰
        note(880.0,  0.00, 0.18, "square", 0.70);   // A5
        note(1174.7, 0.06, 0.22, "sawtooth", 0.75); // D6
        note(1568.0, 0.16, 0.35, "sine", 0.85);     // G6

        note(880.0,  0.62, 0.18, "square", 0.78);
        note(1318.5, 0.68, 0.22, "sawtooth", 0.82); // E6
        note(1760.0, 0.78, 0.45, "sine", 0.95);     // A6

        note(440.0,  0.00, 1.20, "triangle", 0.18); // æ”¯ãˆ
      }
    }

    function stopUrgentAlarm(){
      if (urgentAlarmTimer) {
        clearInterval(urgentAlarmTimer);
        urgentAlarmTimer = null;
      }
    }

    function startUrgentAlarm(){
      if (urgentAlarmTimer) return;
      playChime('urgent');
      urgentAlarmTimer = setInterval(() => {
        if (!soundEnabled || !hasUrgentPending) {
          stopUrgentAlarm();
          return;
        }
        playChime('urgent');
      }, URGENT_ALARM_INTERVAL_MS);
    }

    function updateUrgentAlarmState(){
      if (!soundEnabled) { stopUrgentAlarm(); return; }
      if (!audioCtx) return;
      if (hasUrgentPending) startUrgentAlarm();
      else stopUrgentAlarm();
    }

    soundCheckbox.addEventListener('change', async (e) => {
      soundEnabled = e.target.checked;
      localStorage.setItem('sound_enabled', soundEnabled);

      if (soundEnabled) {
        const ok = await unlockAudio();
        if (!ok) {
          alert('ã“ã®ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŸ³å£°å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚åˆ¥ãƒ–ãƒ©ã‚¦ã‚¶ã‹è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
          return;
        }
        updateUrgentAlarmState();
        if (!hasUrgentPending) playChime('normal'); // ONç¢ºèª
      } else {
        stopUrgentAlarm();
      }
    });

    // ===== QC members =====
    let qcMembers = []; // {id,name,email,enabled,updatedAt}

    function openQcMembersModal(){
      document.getElementById('qcMembersModal').classList.add('active');
    }
    function closeQcMembersModal(){
      document.getElementById('qcMembersModal').classList.remove('active');
    }

    document.getElementById('qcMembersBtn').addEventListener('click', (e)=>{
      e.preventDefault();
      openQcMembersModal();
    });
    document.getElementById('qcCloseBtn').addEventListener('click', closeQcMembersModal);

    function setupQcMembersListener(){
      const q = query(collection(db,'qc_members'), orderBy('name','asc'));
      onSnapshot(q, (snap)=>{
        qcMembers = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        renderQcMembers();
        renderResponderSelect();
      });
    }

    function renderQcMembers(){
      const list = document.getElementById('qcList');
      const count = document.getElementById('qcCount');
      count.textContent = String(qcMembers.length);

      if(qcMembers.length === 0){
        list.innerHTML = `<div style="color:#777;text-align:center;padding:14px;">ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“</div>`;
        return;
      }

      list.innerHTML = qcMembers.map(m=>{
        const name = escapeHtml(m.name || '');
        const email = escapeHtml(m.email || '');
        const enabled = !!m.enabled;
        return `
          <div class="item">
            <div style="min-width:0;">
              <div style="font-weight:1000;color:#263238;">${name}</div>
              <small>${email}</small>
            </div>
            <div style="display:flex;align-items:center;gap:10px;">
              <label class="toggle">
                <input type="checkbox" data-qc-toggle="${m.id}" ${enabled ? 'checked':''}>
                <span>æœ‰åŠ¹</span>
              </label>
              <button class="btn btn-secondary" data-qc-del="${m.id}" style="padding:10px 12px;">å‰Šé™¤</button>
            </div>
          </div>
        `;
      }).join('');
    }

    document.getElementById('qcAddBtn').addEventListener('click', async ()=>{
      const name = document.getElementById('qcNewName').value.trim();
      const email = document.getElementById('qcNewEmail').value.trim();

      if(!name){
        alert('æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      if(email && !email.includes('@')){
        alert('ãƒ¡ãƒ¼ãƒ«ãŒä¸æ­£ã§ã™ï¼ˆç©ºã§ã‚‚OKï¼‰');
        return;
      }

      try{
        await addDoc(collection(db,'qc_members'),{
          name,
          email: email || '',
          enabled: true,
          updatedAt: serverTimestamp()
        });
        document.getElementById('qcNewName').value = '';
        document.getElementById('qcNewEmail').value = '';
      }catch(e){
        console.error(e);
        alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e.message || e));
      }
    });

    document.addEventListener('change', async (e)=>{
      const el = e.target;
      const id = el?.getAttribute?.('data-qc-toggle');
      if(!id) return;

      try{
        await updateDoc(doc(db,'qc_members',id),{
          enabled: !!el.checked,
          updatedAt: serverTimestamp()
        });
      }catch(err){
        console.error(err);
        alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });

    document.addEventListener('click', async (e)=>{
      const delBtn = e.target.closest('[data-qc-del]');
      if(!delBtn) return;

      const id = delBtn.getAttribute('data-qc-del');
      const m = qcMembers.find(x=>x.id===id);
      if(!id) return;

      const name = m?.name || '';
      if(!confirm(`å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n${name}`)) return;

      try{
        await deleteDoc(doc(db,'qc_members',id));
      }catch(err){
        console.error(err);
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });

    document.getElementById('qcMembersModal').addEventListener('click', (e)=>{
      if(e.target.id === 'qcMembersModal') closeQcMembersModal();
    });

    function renderResponderSelect(){
      const sel = document.getElementById('completeBySelect');
      if(!sel) return;

      const prev = sel.value || '';
      const responders = qcMembers
        .filter(m=>!!m.enabled)
        .map(m=>String(m.name||'').trim())
        .filter(Boolean);

      sel.innerHTML = [
        `<option value="">é¸æŠã—ã¦ãã ã•ã„</option>`,
        ...responders.map(n=>`<option value="${escapeAttr(n)}">${escapeHtml(n)}</option>`)
      ].join('');

      if(prev && responders.includes(prev)) sel.value = prev;
    }

    // ===== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ =====
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        stopUrgentAlarm();
        await signOut(auth);
        window.location.href = './quality_andon.html';
      }
    });

    // ===== èªè¨¼ãƒã‚§ãƒƒã‚¯ =====
    onAuthStateChanged(auth, (user) => {
      if (user) {
        setupQcMembersListener();
        setupRealtimeListener();
      } else {
        alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
        window.location.href = './quality_andon.html';
      }
    });

    // ===== ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ï¼ˆquality_casesï¼‰ =====
    let currentFilter = 'all';

    function setupRealtimeListener() {
      const q = query(collection(db, 'quality_cases'), orderBy('createdAt', 'desc'));

      onSnapshot(q, (snapshot) => {
        const newCases = [];
        const newlyDetectedNormalPending = [];

        snapshot.forEach(docSnap => {
          const data = { _id: docSnap.id, ...docSnap.data() };
          newCases.push(data);

          // æ–°è¦æ¤œçŸ¥ï¼ˆpendingã®ã¿ï¼‰
          if ((data.status || 'pending') === 'pending' && !previousCaseIds.has(docSnap.id)) {
            if ((data.priority || 'normal') !== 'urgent') {
              newlyDetectedNormalPending.push(docSnap.id);
            }
          }
          previousCaseIds.add(docSnap.id);
        });

        casesCache = newCases;
        renderCases();
        updateStats();

        // ç·Šæ€¥pendingã®æœ‰ç„¡ï¼ˆå¯¾å¿œé–‹å§‹=inprogressã«ãªã‚‹ã¾ã§é³´ã‚‹ï¼‰
        prevHasUrgentPending = hasUrgentPending;
        hasUrgentPending = casesCache.some(c => (c.priority || 'normal') === 'urgent' && (c.status || 'pending') === 'pending');

        // é€šå¸¸ã®æ–°è¦pendingï¼šç·Šæ€¥ãŒç„¡ã„æ™‚ã ã‘é€šå¸¸ãƒãƒ£ã‚¤ãƒ 
        if (soundEnabled && audioCtx && newlyDetectedNormalPending.length > 0 && !hasUrgentPending) {
          playChime('normal');
        }

        // ç·Šæ€¥pendingã®é–‹å§‹/åœæ­¢
        if (soundEnabled && audioCtx) {
          if (!prevHasUrgentPending && hasUrgentPending) startUrgentAlarm();
          if (prevHasUrgentPending && !hasUrgentPending) stopUrgentAlarm();
        }
      });
    }

    // ===== æ¡ˆä»¶è¡¨ç¤º =====
    function renderCases() {
      const container = document.getElementById('casesContainer');

      // è¡¨ç¤ºé †ï¼šæœªå¯¾å¿œ â†’ å¯¾å¿œä¸­ â†’ å®Œäº†
      const statusOrder = { pending: 1, inprogress: 2, completed: 3 };

      let list = casesCache.slice();
      list.sort((a,b)=>{
        const oa = statusOrder[a.status] ?? 9;
        const ob = statusOrder[b.status] ?? 9;
        if (oa !== ob) return oa - ob;
        const ta = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
        const tb = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
        return tb - ta;
      });

      if(currentFilter !== 'all'){
        list = list.filter(c => (c.status || 'pending') === currentFilter);
      }

      if (list.length === 0) {
        container.innerHTML = '<div class="empty-state">ç¾åœ¨ã€è©²å½“ã™ã‚‹å‘¼ã³å‡ºã—ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      container.innerHTML = list.map(c => renderCallCard(c)).join('');

      list.forEach(c => {
        const card = document.querySelector(`[data-id="${c._id}"]`);
        if (!card) return;

        const inprogressBtn = card.querySelector('.btn-inprogress');
        const completeBtn = card.querySelector('.btn-complete');
        const openBtn = card.querySelector('.btn-open-anomaly');

        if (inprogressBtn) {
          inprogressBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            showCompleteModal(c, 'inprogress');
          });
        }

        if (completeBtn) {
          completeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            showCompleteModal(c, 'complete');
          });
        }

        if (openBtn) {
          openBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openAnomalyAppFromCase(c);
          });
        }

        card.addEventListener('click', () => openAnomalyAppFromCase(c));
      });
    }

    function renderCallCard(c){
      const priority = c.priority || 'normal';
      const status = c.status || 'pending';

      const createdAt = c.createdAt?.toDate ? c.createdAt.toDate() : null;
      const timeStr = createdAt ? formatDateTime(createdAt) : '---';

      const statusLabel = status === 'pending' ? 'æœªå¯¾å¿œ' : (status === 'inprogress' ? 'å¯¾å¿œä¸­' : 'å®Œäº†');

      const message = (c.message || '').trim();
      const showMessage = message ? `<div class="message-box">${escapeHtml(message)}</div>` : '';

      // âœ… å¯¾å¿œä¸­ã®æ‹…å½“è€…ã‚’ã€Œé ­æ–‡å­—ãƒãƒƒã‚¸ã€ã§å¼·èª¿
      const responderHighlight =
        (status === 'inprogress' && c.respondedBy)
          ? `
            <div class="responder-highlight">
              <span class="initial-badge" title="${escapeAttr(c.respondedBy)}">${escapeHtml(makeInitials(c.respondedBy))}</span>
              <div class="responder-name">
                å¯¾å¿œä¸­ï¼š${escapeHtml(c.respondedBy)}
             
              </div>
            </div>
          `
          : '';

      return `
        <div class="case-card ${status === 'completed' ? 'completed':''}" data-id="${c._id}">
          <div class="priority-bar ${priority}"></div>

          <div class="case-header">
            <div class="case-title">
              ${priority === 'urgent' ? 'ğŸš¨ ç·Šæ€¥' : 'âš ï¸ é€šå¸¸'}
              / ${escapeHtml(c.department || '---')}
            </div>
            <div class="case-time">${escapeHtml(timeStr)}</div>
          </div>

          <div class="status-badge ${status}">
            ${escapeHtml(statusLabel)}
          </div>

          ${responderHighlight}

          <div class="case-info">
            <div class="info-item"><div class="info-label">ãƒ©ã‚¤ãƒ³:</div><div class="info-value">${escapeHtml(c.lineName || '---')}</div></div>
            <div class="info-item"><div class="info-label">æ•´ç†No:</div><div class="info-value">${escapeHtml(c.serialNo || '---')}</div></div>
            <div class="info-item"><div class="info-label">ç™ºä¿¡è€…:</div><div class="info-value">${escapeHtml(c.callerName || '---')}</div></div>
          </div>

          ${showMessage}

          <div class="actions">
            ${status !== 'completed'
              ? `<button class="btn btn-inprogress">å¯¾å¿œé–‹å§‹</button>`
              : `<button class="btn btn-inprogress" disabled style="opacity:.5;cursor:not-allowed;">å¯¾å¿œé–‹å§‹</button>`}
            ${status !== 'completed'
              ? `<button class="btn btn-complete">å®Œäº†</button>`
              : `<button class="btn btn-complete" disabled style="opacity:.5;cursor:not-allowed;">å®Œäº†</button>`}
            <button class="btn btn-open-anomaly">ç•°å¸¸å±¥æ­´ã‚’é–‹ã</button>
          </div>
        </div>
      `;
    }

    function openAnomalyAppFromCase(c){
      const anomalyPreFillData = {
        fromAndon: true,
        andonCaseId: c._id,
        department: c.department || '',
        lineName: c.lineName || '',
        serialNo: c.serialNo || `QA-${String(c._id).slice(-6)}`,
        handler: c.callerName || '',
        anomalyContent: c.message || '',
        priority: c.priority || 'normal',
        timestamp: Date.now()
      };

      try{
        localStorage.setItem('anomaly_prefill_data', JSON.stringify(anomalyPreFillData));
      }catch(e){}

      window.open(ANOMALY_APP_URL, '_blank');
    }

    // ===== å¯¾å¿œãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆé–‹å§‹/å®Œäº†ï¼‰ =====
function showCompleteModal(caseData, mode){
  currentCompleteCase = caseData || {};

  // mode ãŒç„¡ã„å ´åˆã®æ—¢å®šå€¤
  const effectiveMode = (mode === 'completed' || mode === 'complete') ? 'completed' : 'inprogress';
  modalMode = (effectiveMode === 'inprogress') ? 'inprogress' : 'complete';

  // ã‚¿ã‚¤ãƒˆãƒ«
  const titleEl = document.getElementById('completeModalTitle');
  if (titleEl) titleEl.textContent = (effectiveMode === 'inprogress') ? 'å¯¾å¿œé–‹å§‹' : 'å¯¾å¿œå®Œäº†';

  // ç¢ºå®šãƒœã‚¿ãƒ³ï¼ˆconfirmComplete / btnCompleteConfirm ã©ã¡ã‚‰ã§ã‚‚OKï¼‰
  const btn =
    document.getElementById('confirmComplete') ||
    document.getElementById('btnCompleteConfirm');
  if (btn) btn.textContent = (effectiveMode === 'inprogress') ? 'é–‹å§‹ã™ã‚‹' : 'å®Œäº†ã™ã‚‹';

  // å¯¾å¿œè€…ï¼ˆselectç‰ˆ / inputç‰ˆ ã©ã¡ã‚‰ã§ã‚‚æ‹¾ã†ï¼‰
  const byEl =
    document.getElementById('completeBySelect') ||
    document.getElementById('completeBy') ||
    document.getElementById('completeByInput');

  if (byEl) {
    // caseDataå´ã®å€™è£œã‚‚è¤‡æ•°ã‚’è¦‹ã¦å…¥ã‚Œã‚‹
    byEl.value = (caseData.assignedTo || caseData.completedBy || caseData.handler || '') || '';
  } else {
    console.warn('[showCompleteModal] å¯¾å¿œè€…å…¥åŠ›æ¬„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆcompleteBySelect / completeBy / completeByInputï¼‰');
  }

  // å¯¾å¿œå†…å®¹ï¼ˆtextareaç‰ˆ / inputç‰ˆ ã©ã¡ã‚‰ã§ã‚‚æ‹¾ã†ï¼‰
  const msgEl =
    document.getElementById('completeMessage') ||
    document.getElementById('completeMessageInput') ||
    document.getElementById('completeMessageText');

  if (msgEl) {
    msgEl.value = (caseData.completedMessage || '') || '';
  } else {
    console.warn('[showCompleteModal] å¯¾å¿œå†…å®¹å…¥åŠ›æ¬„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆcompleteMessage / completeMessageInput / completeMessageTextï¼‰');
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  const modal = document.getElementById('completeModal');
  if (modal){ modal.style.display = 'flex'; modal.classList.add('active'); }
  else console.warn('[showCompleteModal] completeModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
// ===== ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ç¢ºå®Ÿã«é–‰ã˜ã‚‹ï¼ˆdisplay/classä¸¡å¯¾å¿œï¼‰ =====
function closeCompleteModal(){
  const modal = document.getElementById('completeModal');
  if(!modal) return;
  modal.classList.remove('active');
  modal.style.display = 'none';
  currentCompleteCase = null;
}

// ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§é–‰ã˜ã‚‹
document.getElementById('cancelComplete')?.addEventListener('click', () => {
  closeCompleteModal();
});

// èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.getElementById('completeModal')?.addEventListener('click', (e) => {
  if(e.target && e.target.id === 'completeModal'){
    closeCompleteModal();
  }
});


}


    document.getElementById('confirmComplete').addEventListener('click', async () => {
      const by = (document.getElementById('completeBySelect')?.value || '').trim();
      const content = (document.getElementById('completeMessage')?.value || '').trim();

      // âœ… ä½¿ã„å‹æ‰‹æ”¹å–„ï¼šé–‹å§‹ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚å®Œäº†å†…å®¹ãŒå…¥ã£ã¦ã„ã‚Œã°ã€Œå®Œäº†ã€ã¨ã—ã¦æ‰±ã†
      const effectiveMode = (modalMode === 'inprogress' && content.trim()) ? 'completed' : modalMode;

      if (!currentCompleteCase) return;

      if (!by) {
        alert('æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      try {
        if(effectiveMode === 'inprogress'){
          await updateDoc(doc(db, 'quality_cases', currentCompleteCase._id), {
            status: 'inprogress',
            respondedBy: by,
            respondedAt: serverTimestamp()
          });
        }else{
          await updateDoc(doc(db, 'quality_cases', currentCompleteCase._id), {
            status: 'completed',
            completedBy: by,
            completedContent: content,
            completedAt: serverTimestamp()
          });

          // ç•°å¸¸å±¥æ­´ã‚¢ãƒ—ãƒªå´ã¸ã®é€†æµï¼ˆåŒä¸€ç«¯æœ«å‘ã‘ï¼‰
          try {
            const completionPayload = {
              timestamp: Date.now(),
              caseId: currentCompleteCase._id,
              tempLinkId: currentCompleteCase.tempLinkId || '',
              launchId: currentCompleteCase.launchId || '',
              department: currentCompleteCase.department || '',
              lineName: currentCompleteCase.lineName || '',
              serialNo: currentCompleteCase.serialNo || '',
              completedBy: by,
              completedContent: content,
              completedAt: new Date().toISOString()
            };
            localStorage.setItem('andon_completion_data', JSON.stringify(completionPayload));
          } catch (e) {}
          // ===== DB(anomalies) ã® qualityResponse ã‚’æ›´æ–°ï¼ˆquality_cases ã¨åŒã˜IDé‹ç”¨ï¼‰ =====
          try{
            const anomalyId = currentCompleteCase._id; // â˜…åŒIDé‹ç”¨ï¼šquality_cases ã®ID = anomalies ã®ID
            const aRef = doc(db, 'anomalies', anomalyId);
            const snap = await getDoc(aRef);
            const prev = (snap.exists() ? (snap.data().qualityResponse || '') : '');

            const stampJp = new Date().toLocaleString('ja-JP');
            const addText =
              `ã€ã‚¢ãƒ³ãƒ‰ãƒ³å®Œäº†ã€‘${stampJp}\n` +
              `å¯¾å¿œè€…: ${by}\n` +
              `å¯¾å¿œå†…å®¹: ${content || 'ï¼ˆãªã—ï¼‰'}\n` +
              `æ¡ˆä»¶ID: ${anomalyId}\n`;

            const next = [String(prev || '').trim(), addText.trim()].filter(Boolean).join('\n\n');

            await setDoc(aRef, {
              qualityResponse: next,
              updatedAt: serverTimestamp(),
              lastAndonComplete: {
                by,
                content: content || '',
                caseId: anomalyId,
                at: serverTimestamp()
              }
            }, { merge: true });
          }catch(e){
            console.warn('failed to sync anomalies.qualityResponse', e);
            alert('ç•°å¸¸å±¥æ­´ï¼ˆanomaliesï¼‰ã®qualityResponseæ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          }
        }

        closeCompleteModal();
      } catch (error) {
        console.error('Error:', error);
        alert((effectiveMode === 'inprogress' ? 'å¯¾å¿œé–‹å§‹' : 'å¯¾å¿œå®Œäº†') + 'ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });

    // ===== çµ±è¨ˆ =====
    function updateStats() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const urgentPending = casesCache.filter(c => (c.priority || 'normal') === 'urgent' && (c.status || 'pending') === 'pending').length;
      const normalPending = casesCache.filter(c => (c.priority || 'normal') === 'normal' && (c.status || 'pending') === 'pending').length;
      const inProgress = casesCache.filter(c => (c.status || 'pending') === 'inprogress').length;

      const completedToday = casesCache.filter(c => {
        if ((c.status || 'pending') !== 'completed' || !c.completedAt) return false;
        const completedDate = c.completedAt.toDate();
        return completedDate >= today;
      }).length;

      document.getElementById('statUrgentPending').textContent = urgentPending;
      document.getElementById('statNormalPending').textContent = normalPending;
      document.getElementById('statInProgress').textContent = inProgress;
      document.getElementById('statCompletedToday').textContent = completedToday;
    }

    // ===== ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ =====
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.getAttribute('data-filter');
        renderCases();
      });
    });

    // ===== util =====
    function formatDateTime(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      const h = String(date.getHours()).padStart(2, '0');
      const min = String(date.getMinutes()).padStart(2, '0');
      return `${y}/${m}/${d} ${h}:${min}`;
    }

    // âœ… QCãƒ¡ãƒ³ãƒãƒ¼ã®é ­æ–‡å­—ï¼ˆæ—¥æœ¬èªã¯å…ˆé ­1æ–‡å­—ã€è‹±å­—ã¯æœ€å¤§2æ–‡å­—ï¼‰
    function makeInitials(name){
      const s = String(name || '').trim();
      if (!s) return '?';

      // è‹±å­—ãŒå«ã¾ã‚Œã‚‹å ´åˆï¼šå˜èªã®å…ˆé ­ã‚’æœ€å¤§2ã¤
      const hasLatin = /[A-Za-z]/.test(s);
      if (hasLatin) {
        const parts = s.replace(/\s+/g,' ').split(' ').filter(Boolean);
        const a = (parts[0] || '').charAt(0).toUpperCase();
        const b = (parts[1] || '').charAt(0).toUpperCase();
        const ab = (a + b).trim();
        return ab || a || '?';
      }

      // æ—¥æœ¬èªãªã©ï¼šå…ˆé ­1æ–‡å­—ï¼ˆå¿…è¦ãªã‚‰2æ–‡å­—ã«ã—ã¦ã‚‚OKï¼‰
      return s.charAt(0);
    }

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s){
      return escapeHtml(String(s ?? '')).replaceAll('\n',' ').replaceAll('\r',' ');
    }
  </script>
</body>
</html>
