<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å“è³ªç•°å¸¸ã‚¢ãƒ³ãƒ‰ãƒ³ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body{
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
  }

  .header{
    background: rgba(255,255,255,.95);
    padding: 16px 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,.1);
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .header-title{
    font-size: 1.4rem;
    font-weight: 800;
    color:#667eea;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .user-info{
    display:flex;
    align-items:center;
    gap:12px;
    font-size:.9rem;
    color:#666;
  }

  .container{ max-width: 1100px; margin: 0 auto; padding: 20px; }

  .tabs{
    display:flex; gap:8px; margin-bottom:20px;
  }
  .tab{
    flex:1;
    padding: 14px;
    background: rgba(255,255,255,.9);
    border:none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 800;
    cursor:pointer;
    transition: .2s;
    color:#666;
  }
  .tab.active{
    background:#fff;
    color:#667eea;
    box-shadow: 0 4px 12px rgba(102,126,234,.25);
  }

  .tab-content{
    display:none;
    background:#fff;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 4px 20px rgba(0,0,0,.15);
  }
  .tab-content.active{ display:block; }

  .call-buttons{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:20px;
    margin-bottom: 22px;
  }
  .call-btn{
    padding: 38px 18px;
    border:none;
    border-radius: 12px;
    font-size: 1.25rem;
    font-weight: 900;
    cursor:pointer;
    transition: .2s;
    color:#fff;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
    box-shadow: 0 4px 15px rgba(0,0,0,.18);
  }
  .call-btn:hover{ transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,.25); }
  .call-btn:active{ transform: translateY(0); }

  .btn-urgent{ background: linear-gradient(135deg, #ef5350 0%, #d32f2f 100%); }
  .btn-normal{ background: linear-gradient(135deg, #ffa726 0%, #f57c00 100%); }

  .call-icon{ font-size: 2.8rem; }

  .form-group{ margin-bottom: 16px; }
  .form-group label{
    display:block;
    margin-bottom: 8px;
    font-weight: 800;
    color:#333;
    font-size: .95rem;
  }
  .form-group input, .form-group select, .form-group textarea{
    width:100%;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1rem;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus{
    outline:none;
    border-color:#667eea;
  }
  .form-group textarea{ min-height: 100px; resize: vertical; }

  .template-buttons{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top:10px;
  }
  .template-btn{
    padding: 8px 14px;
    background:#e3f2fd;
    border: 2px solid #2196f3;
    border-radius: 20px;
    font-size: .85rem;
    cursor:pointer;
    transition:.15s;
    color:#1976d2;
    font-weight: 700;
    user-select:none;
  }
  .template-btn:hover{ background:#2196f3; color:#fff; transform: translateY(-1px); }

  .btn{
    padding: 10px 16px;
    border:none;
    border-radius: 8px;
    font-size:.95rem;
    font-weight: 800;
    cursor:pointer;
    transition:.2s;
  }
  .btn-primary{ background:#667eea; color:#fff; }
  .btn-primary:hover{ background:#5568d3; }
  .btn-danger{ background:#ef5350; color:#fff; }
  .btn-danger:hover{ background:#e53935; }

  #authGate{
    position:fixed;
    inset:0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index: 2000;
  }
  #authCard{
    background:#fff;
    max-width: 420px;
    width: 92%;
    padding: 32px;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,.3);
  }
  #authCard h2{
    margin-bottom: 22px;
    text-align:center;
    color:#667eea;
  }
  .sign-out-btn{
    background:#ef5350;
    color:#fff;
    border:none;
    border-radius: 8px;
    padding: 8px 14px;
    cursor:pointer;
    font-size:.9rem;
    font-weight: 800;
  }
  .sign-out-btn:hover{ background:#e53935; }

  .panel{
    background:#f8f9fa;
    padding: 18px;
    border-radius: 12px;
    margin-bottom: 18px;
  }
  .row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .row > *{ flex: 1; min-width: 220px; }

  .list{
    display:grid;
    gap:10px;
    margin-top: 10px;
  }
  .list-item{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    padding: 12px 14px;
    background:#fff;
    border-radius: 10px;
    border-left: 4px solid #667eea;
  }

  @media (max-width: 768px){
    .call-buttons{ grid-template-columns: 1fr; }
    .call-btn{ padding: 30px 16px; font-size: 1.1rem; }
    .call-icon{ font-size: 2.4rem; }
  }
</style>
</head>

<body>
  <!-- èªè¨¼ã‚²ãƒ¼ãƒˆ -->
  <div id="authGate">
    <div id="authCard">
      <h2>ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <div class="form-group">
        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="email" id="authEmail" placeholder="user@example.com" />
      </div>
      <div class="form-group">
        <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="authPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
      </div>
      <button class="btn btn-primary" style="width:100%;" id="authLoginBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <p id="authMsg" style="color:#c62828;margin-top:12px;"></p>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ -->
  <div id="appRoot" style="display:none;">
    <div class="header">
      <div class="header-title">
        <span>ğŸš¨</span><span>å“è³ªç•°å¸¸ã‚¢ãƒ³ãƒ‰ãƒ³</span>
      </div>
      <div class="user-info">
        <span id="userEmail"></span>
        <button class="sign-out-btn" id="signOutBtn">ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>

    <div class="container">
      <!-- ã‚¿ãƒ–ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰ -->
      <div class="tabs">
        <button class="tab active" data-tab="call">ğŸ“ å‘¼ã³å‡ºã—</button>
        <button class="tab" data-tab="settings">âš™ï¸ è¨­å®š</button>
      </div>

      <!-- å‘¼ã³å‡ºã— -->
      <div id="call" class="tab-content active">
        <h2 style="margin-bottom:18px;color:#667eea;">å“è³ªæ‹…å½“è€…ã‚’å‘¼ã³å‡ºã™</h2>

        <div class="call-buttons">
          <button class="call-btn btn-urgent" id="btnCallUrgent">
            <div class="call-icon">ğŸš¨</div>
            <div>ç·Šæ€¥å‘¼ã³å‡ºã—</div>
            <div style="font-size:.85rem;font-weight:normal;opacity:.9;">å³å¯¾å¿œãŒå¿…è¦</div>
          </button>
          <button class="call-btn btn-normal" id="btnCallNormal">
            <div class="call-icon">âš ï¸</div>
            <div>é€šå¸¸å‘¼ã³å‡ºã—</div>
            <div style="font-size:.85rem;font-weight:normal;opacity:.9;">æ™‚é–“ã«ä½™è£•ã‚ã‚Š</div>
          </button>
        </div>

        <div class="form-group">
          <label>ç™ºä¿¡éƒ¨ç½² *</label>
          <select id="callDepartment" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>

        <div class="form-group">
          <label>ãƒ©ã‚¤ãƒ³å</label>
          <select id="callLine">
            <option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>

        <div class="form-group">
          <label>æ•´ç†No</label>
          <input type="text" id="callSerialNo" placeholder="ä¾‹: 6769" />
        </div>

        <div class="form-group">
          <label>ç™ºä¿¡è€…å *</label>
          <input type="text" id="callName" placeholder="ä¾‹: å±±ç”°å¤ªéƒ" required />
        </div>

        <div class="form-group">
          <label>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰</label>
          <textarea id="callMessage" placeholder="ç•°å¸¸ã®è©³ç´°ã‚„çŠ¶æ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
          <div class="template-buttons" id="templateButtons"></div>
        </div>

        <div class="form-group">
          <label style="display:flex;align-items:center;gap:10px;font-weight:800;">
            <input type="checkbox" id="linkToAnomaly" style="width:auto;" />
            ç•°å¸¸å±¥æ­´ã‚¢ãƒ—ãƒªã¨é€£æºã™ã‚‹ï¼ˆå‘¼ã³å‡ºã—å¾Œã«ç•°å¸¸å±¥æ­´ã‚¢ãƒ—ãƒªã‚’é–‹ãï¼‰
          </label>
          <div style="color:#666;font-size:.85rem;margin-top:6px;">
            â€» æœ¬ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆã§ã¯ã€Œå¯¾å¿œå®Œäº†â†’ç•°å¸¸å±¥æ­´è‡ªå‹•ä½œæˆã€ã¯è¡Œã„ã¾ã›ã‚“ï¼ˆå‘¼ã³å‡ºã—ç™ºè¡Œï¼‹å¿…è¦ãªã‚‰å±¥æ­´ã‚¢ãƒ—ãƒªèµ·å‹•ã®ã¿ï¼‰
          </div>
        </div>
      </div>

      <!-- è¨­å®š -->
      <div id="settings" class="tab-content">
        <h2 style="margin-bottom:18px;color:#667eea;">è¨­å®š</h2>

        <div class="panel">
          <h3 style="color:#667eea;margin-bottom:12px;">éƒ¨ç½²ãƒã‚¹ã‚¿</h3>
          <div class="row">
            <input type="text" id="newDepartment" placeholder="æ–°ã—ã„éƒ¨ç½²å" />
            <button class="btn btn-primary" id="btnAddDept" style="flex:0 0 140px;">è¿½åŠ </button>
          </div>
          <div id="departmentList" class="list"></div>
        </div>

        <div class="panel">
          <h3 style="color:#667eea;margin-bottom:12px;">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h3>
          <div class="row">
            <input type="text" id="newTemplate" placeholder="æ–°ã—ã„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ" />
            <button class="btn btn-primary" id="btnAddTemplate" style="flex:0 0 140px;">è¿½åŠ </button>
          </div>
          <div id="templateList" class="list"></div>
          <div style="color:#666;font-size:.85rem;margin-top:10px;">
            â€» å‘¼ã³å‡ºã—ç”»é¢ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒœã‚¿ãƒ³ã«åæ˜ ã•ã‚Œã¾ã™
          </div>
        </div>

        <div class="panel">
          <h3 style="color:#667eea;margin-bottom:12px;">é€šçŸ¥ã«ã¤ã„ã¦</h3>
          <div style="color:#444;line-height:1.6;">
            ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã¯ <strong>Firestoreï¼ˆå‘¼ã³å‡ºã—è¿½åŠ ï¼‰â†’ Cloud Functions â†’ Power Automateï¼ˆç¤¾å†…Outlooké€ä¿¡ï¼‰</strong> ã§è¡Œã†æƒ³å®šã§ã™ã€‚<br />
            ã“ã®ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆã§ã¯ã€ã‚¢ãƒ—ãƒªå†…ã«å®›å…ˆå…¥åŠ›æ¬„ã¯ç½®ãã¾ã›ã‚“ï¼ˆå®›å…ˆã¯åˆ¥é€” `andon_recipients` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ç®¡ç†ã™ã‚‹é‹ç”¨ãŒå®‰å…¨ã§ã™ï¼‰ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getAuth, signInWithEmailAndPassword, onAuthStateChanged,
    setPersistence, browserLocalPersistence, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, getDocs, query, where, doc, deleteDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // Firebaseè¨­å®šï¼ˆå…ƒãƒ•ã‚¡ã‚¤ãƒ«ã¨åŒã˜ï¼‰
  const firebaseConfig = {
    apiKey: "AIzaSyA0YUIpIDh4WB4p1ewiNB0XfwHve0ByljU",
    authDomain: "abnreport-fd733.firebaseapp.com",
    databaseURL: "https://abnreport-fd733-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "abnreport-fd733",
    storageBucket: "abnreport-fd733.firebasestorage.app",
    messagingSenderId: "349748947315",
    appId: "1:349748947315:web:010cb671d2a95bcf1f7d06"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let currentUser = null;
  let departmentsCache = [];
  let templatesCache = [];
  let lastLaunchContext = null;

  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ï¼ˆç™ºä¿¡éƒ¨ç½²ã¨åå‰ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
  const LS_KEYS = {
    DEPARTMENT: "andon_department",
    LINE: "andon_line",
    SERIAL_NO: "andon_serialno",
    NAME: "andon_name"
  };

  // ===== èªè¨¼ =====
  document.getElementById("authLoginBtn").addEventListener("click", async () => {
    const email = document.getElementById("authEmail").value.trim();
    const pw = document.getElementById("authPassword").value;
    try{
      await setPersistence(auth, browserLocalPersistence);
      await signInWithEmailAndPassword(auth, email, pw);
    }catch(e){
      document.getElementById("authMsg").textContent = "ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + (e.code || e.message);
    }
  });

  document.getElementById("signOutBtn").addEventListener("click", () => signOut(auth));

  onAuthStateChanged(auth, (user) => {
    if(user){
      currentUser = user;
      document.getElementById("authGate").style.display = "none";
      document.getElementById("appRoot").style.display = "block";
      document.getElementById("userEmail").textContent = user.email;
      bootAfterLogin();
    }else{
      currentUser = null;
      document.getElementById("appRoot").style.display = "none";
      document.getElementById("authGate").style.display = "flex";
    }
  });

  async function bootAfterLogin(){
    await loadDepartments();
    await loadTemplates();
    restoreFormData();
  }

  // ===== ã‚¿ãƒ–åˆ‡æ›¿ =====
  document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
      tab.classList.add("active");
      document.getElementById(tab.getAttribute("data-tab")).classList.add("active");
    });
  });

  // ===== å‘¼ã³å‡ºã— =====
  document.getElementById("btnCallUrgent").addEventListener("click", () => createCall("urgent"));
  document.getElementById("btnCallNormal").addEventListener("click", () => createCall("normal"));

  async function createCall(priority){
    const department = document.getElementById("callDepartment").value;
    const lineName = document.getElementById("callLine").value;
    const serialNo = document.getElementById("callSerialNo").value.trim();
    const name = document.getElementById("callName").value.trim();
    const message = document.getElementById("callMessage").value.trim();
    const linkToAnomaly = document.getElementById("linkToAnomaly").checked;

    if(!department || !name){
      alert("éƒ¨ç½²ã¨ç™ºä¿¡è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    const priorityLabel = (priority === "urgent") ? "ç·Šæ€¥" : "é€šå¸¸";
    if(!confirm(`${priorityLabel}å‘¼ã³å‡ºã—ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`)) return;

    try{
      const caseData = {
        priority,
        department,
        lineName: lineName || "",
        serialNo: serialNo || "",
        callerName: name,
        message,
        status: "pending",
        linkToAnomaly,
        launchId: (lastLaunchContext && lastLaunchContext.launchId) ? lastLaunchContext.launchId : "",
        createdAt: serverTimestamp(),
        createdBy: currentUser?.email || ""
      };

      const docRef = await addDoc(collection(db, "quality_cases"), caseData);

      // å…¥åŠ›ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      localStorage.setItem(LS_KEYS.DEPARTMENT, department);
      localStorage.setItem(LS_KEYS.LINE, lineName || "");
      localStorage.setItem(LS_KEYS.SERIAL_NO, serialNo || "");
      localStorage.setItem(LS_KEYS.NAME, name);

      // ã“ã“ã¯ Functions/PowerAutomate å´ã§é€šçŸ¥ã™ã‚‹æƒ³å®šï¼ˆã‚¢ãƒ—ãƒªå†…ã§ã¯ä½•ã‚‚ã—ãªã„ï¼‰
      // sendNotification(caseData);

      if(linkToAnomaly){
        const fullCaseData = { ...caseData, _id: docRef.id };
        const shouldOpen = confirm(
          `${priorityLabel}å‘¼ã³å‡ºã—ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚\n\nç•°å¸¸å±¥æ­´ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¦è©³ç´°ã‚’å…¥åŠ›ã—ã¾ã™ã‹ï¼Ÿ`
        );
        if(shouldOpen){
          launchAnomalyApp(fullCaseData);
          clearCallForm(true);
          return;
        }
      }

      clearCallForm(false);
      alert(`${priorityLabel}å‘¼ã³å‡ºã—ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚`);

    }catch(err){
      console.error(err);
      alert("å‘¼ã³å‡ºã—ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (err?.message || err));
    }
  }

  function clearCallForm(keepLinkCheck){
    document.getElementById("callMessage").value = "";
    if(!keepLinkCheck){
      document.getElementById("linkToAnomaly").checked = false;
    }
  }

  function launchAnomalyApp(caseData){
    // ç•°å¸¸å±¥æ­´ã‚¢ãƒ—ãƒªå´ãŒèª­ã‚€æƒ³å®šï¼ˆæ—¢å­˜ä»•æ§˜è¸è¥²ï¼‰
    const anomalyPreFillData = {
      fromAndon: true,
      andonCaseId: caseData._id,
      department: caseData.department,
      lineName: caseData.lineName || "",
      serialNo: caseData.serialNo || `QA-${caseData._id.slice(-6)}`,
      handler: caseData.callerName,
      anomalyContent: caseData.message || "",
      priority: caseData.priority,
      timestamp: Date.now()
    };
    localStorage.setItem("anomaly_prefill_data", JSON.stringify(anomalyPreFillData));

    const anomalyAppUrl = "./abnreports.html";
    window.open(anomalyAppUrl, "_blank");
  }

  // ===== ãƒã‚¹ã‚¿ï¼ˆéƒ¨ç½²/ãƒ©ã‚¤ãƒ³ï¼‰ =====
  async function loadDepartments(){
    const snap = await getDocs(collection(db, "masters", "department", "items"));
    departmentsCache = snap.docs.map(d => d.data().name).filter(Boolean).sort();

    const select = document.getElementById("callDepartment");
    select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    departmentsCache.forEach(dept => {
      select.innerHTML += `<option value="${escapeHtml(dept)}">${escapeHtml(dept)}</option>`;
    });

    renderDepartmentList();
  }

  async function loadLinesForDepartment(department){
    const lineSelect = document.getElementById("callLine");
    if(!department){
      lineSelect.innerHTML = '<option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>';
      return;
    }
    try{
      const q = query(collection(db, "masters", "line", "items"), where("department", "==", department));
      const snap = await getDocs(q);
      const lines = snap.docs.map(d => d.data().name).filter(Boolean).sort();

      lineSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      lines.forEach(line => {
        lineSelect.innerHTML += `<option value="${escapeHtml(line)}">${escapeHtml(line)}</option>`;
      });

      const cachedLine = localStorage.getItem(LS_KEYS.LINE);
      if(cachedLine && lines.includes(cachedLine)){
        lineSelect.value = cachedLine;
      }
    }catch(e){
      console.error(e);
      lineSelect.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</option>';
    }
  }

  document.getElementById("callDepartment").addEventListener("change", (e) => {
    loadLinesForDepartment(e.target.value);
    localStorage.setItem(LS_KEYS.DEPARTMENT, e.target.value || "");
  });

  function renderDepartmentList(){
    const list = document.getElementById("departmentList");
    if(departmentsCache.length === 0){
      list.innerHTML = '<div style="color:#999;text-align:center;">éƒ¨ç½²ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
      return;
    }
    list.innerHTML = departmentsCache.map(dept => `
      <div class="list-item">
        <div style="font-weight:800;color:#333;">${escapeHtml(dept)}</div>
      </div>
    `).join("");
  }

  document.getElementById("btnAddDept").addEventListener("click", async () => {
    const name = document.getElementById("newDepartment").value.trim();
    if(!name){ alert("éƒ¨ç½²åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    await addDoc(collection(db, "masters", "department", "items"), { name });
    document.getElementById("newDepartment").value = "";
    await loadDepartments();
  });

  // ===== ãƒ†ãƒ³ãƒ—ãƒ¬ =====
  async function loadTemplates(){
    const snap = await getDocs(collection(db, "andon_templates"));
    templatesCache = snap.docs.map(d => ({ _id: d.id, ...d.data() }))
      .filter(x => x.text && String(x.text).trim() !== "");

    renderTemplateButtons();
    renderTemplateList();
  }

  function renderTemplateButtons(){
    const container = document.getElementById("templateButtons");
    container.innerHTML = templatesCache.map(t => `
      <span class="template-btn" data-template="${escapeAttr(t.text)}">${escapeHtml(t.text)}</span>
    `).join("");
  }

  function renderTemplateList(){
    const list = document.getElementById("templateList");
    if(templatesCache.length === 0){
      list.innerHTML = '<div style="color:#999;text-align:center;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
      return;
    }
    list.innerHTML = templatesCache.map(t => `
      <div class="list-item">
        <div style="flex:1;font-weight:700;color:#333;">${escapeHtml(t.text)}</div>
        <button class="btn btn-danger" data-del-template="${t._id}">å‰Šé™¤</button>
      </div>
    `).join("");
  }

  document.addEventListener("click", (e) => {
    const tpl = e.target.closest(".template-btn");
    if(tpl){
      const text = tpl.getAttribute("data-template") || "";
      const ta = document.getElementById("callMessage");
      ta.value = ta.value ? (ta.value + "\n" + text) : text;
    }

    const del = e.target.closest('button[data-del-template]');
    if(del){
      const id = del.getAttribute("data-del-template");
      if(confirm("ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
        deleteDoc(doc(db, "andon_templates", id)).then(loadTemplates);
      }
    }
  });

  document.getElementById("btnAddTemplate").addEventListener("click", async () => {
    const text = document.getElementById("newTemplate").value.trim();
    if(!text){ alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    await addDoc(collection(db, "andon_templates"), { text });
    document.getElementById("newTemplate").value = "";
    await loadTemplates();
  });

  // ===== ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¾©å…ƒ =====
  function restoreFormData(){
    const dept = localStorage.getItem(LS_KEYS.DEPARTMENT);
    const line = localStorage.getItem(LS_KEYS.LINE);
    const serialNo = localStorage.getItem(LS_KEYS.SERIAL_NO);
    const name = localStorage.getItem(LS_KEYS.NAME);

    if(dept){
      document.getElementById("callDepartment").value = dept;
      loadLinesForDepartment(dept).then(() => {
        if(line) document.getElementById("callLine").value = line;
      });
    }
    if(serialNo) document.getElementById("callSerialNo").value = serialNo;
    if(name) document.getElementById("callName").value = name;
  }

  // ===== util =====
  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(s){
    // attributeå‘ã‘ï¼ˆæ”¹è¡Œãªã©ã‚‚æ½°ã™ï¼‰
    return escapeHtml(String(s)).replaceAll("\n"," ").replaceAll("\r"," ");
  }
</script>
</body>
</html>
