<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•°å¸¸å±¥æ­´åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Hiragino Sans',sans-serif;background:#f5f5f5}
  .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  .header h1{font-size:1.6rem;margin-bottom:5px}
  .container{max-width:1400px;margin:0 auto;padding:20px}

  /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
  .control-panel{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);margin-bottom:20px}
  .control-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:15px}
  .control-group label{display:block;font-weight:600;color:#333;margin-bottom:6px;font-size:.9rem}
  .control-group select,.control-group input{width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;font-size:.95rem}
  .control-group select:focus,.control-group input:focus{outline:none;border-color:#667eea}
  .period-tabs{display:flex;gap:8px;margin-bottom:15px}
  .period-tab{flex:1;padding:12px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:8px;cursor:pointer;font-weight:bold;transition:.2s;text-align:center}
  .period-tab.active{background:#667eea;color:#fff}
  .date-btn{padding:8px 10px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:6px;cursor:pointer;font-weight:600;font-size:.9rem}
  .date-btn:hover{background:#667eea;color:#fff}

  /* ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ– */
  .view-tab{transition:.2s}
  .view-tab:hover{background:#f8f9ff}
  .view-tab.active{background:#fff!important;border-bottom-color:#667eea!important;color:#667eea}

  /* ====== ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ ====== */
  .table-container{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);margin-bottom:20px;overflow-x:auto}
  .data-table{table-layout:fixed;width:100%;min-width:1800px;border-collapse:collapse}
  .data-table th{background:#667eea;color:#fff;padding:8px 10px;text-align:left;font-weight:700;position:sticky;top:0;z-index:2;font-size:12px;line-height:1.2;white-space:nowrap}
  .data-table th .sort-btn{margin-left:6px;background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.5);color:#fff;padding:1px 4px;border-radius:4px;cursor:pointer;font-size:10px}
  .data-table td{padding:10px;border-bottom:1px solid #f0f0f0;vertical-align:top}
  .data-table tr:nth-child(even){background:#fafbff}
  .data-table tr:hover{background:#eef2ff}
  td.cell-nowrap{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  td.cell-memo>div{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;white-space:normal;max-height:4.6em}

  /* è¡¨ç¤ºå¯†åº¦ */
  .density-compact .data-table th,
  .density-compact .data-table td{padding:6px 8px;font-size:12px}
  .density-ultra .data-table th,
  .density-ultra .data-table td{padding:4px 6px;font-size:11px}

  /* åˆ—å¹…ç›®å®‰ */
  th[data-col="occurrenceDate"], td[data-col="occurrenceDate"]{width:90px}
  th[data-col="lineName"], td[data-col="lineName"]{width:110px}
  th[data-col="serialNo"], td[data-col="serialNo"]{width:90px}
  th[data-col="occurrenceTime"], td[data-col="occurrenceTime"],
  th[data-col="restartTime"], td[data-col="restartTime"]{width:70px}
  th[data-col="handler"], td[data-col="handler"]{width:80px}
  th[data-col="stopMinutes"], td[data-col="stopMinutes"]{width:90px}
  th[data-col="discoveryTiming"], td[data-col="discoveryTiming"]{width:110px}
  th[data-col="anomalyContent"], td[data-col="anomalyContent"],
  th[data-col="actionTaken"], td[data-col="actionTaken"],
  th[data-col="rootCauseAction"], td[data-col="rootCauseAction"]{width:320px}

  /* æ¨ªå¹…æ‹¡å¤§ãƒ¢ãƒ¼ãƒ‰ */
  .body-sheet-wide .container{max-width:96vw}
  .body-sheet-wide .data-table{min-width:2400px}
  .body-sheet-ultra .data-table{min-width:3000px}

  /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼†ã‚µã‚¤ãƒ³ã‚¤ãƒ³ */
  #authGate{position:fixed;inset:0;background:#f5f5f5;display:flex;align-items:center;justify-content:center;z-index:2000}
  #authCard{background:#fff;max-width:380px;width:92%;padding:24px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
  #signOutBtn{position:fixed;right:12px;top:12px;background:#ef5350;color:#fff;border:none;border-radius:6px;padding:8px 12px;cursor:pointer;z-index:1500;font-weight:600}
  .loading{display:none;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:1000;align-items:center;justify-content:center}
  .loading.active{display:flex}
  .loading-spinner{width:60px;height:60px;border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
</style>
</head>
<body>
  <button id="signOutBtn" style="display:none;">ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ</button>

  <div id="authGate">
    <div id="authCard">
      <h2 style="margin-bottom:10px;color:#667eea;">ğŸ” ã‚µã‚¤ãƒ³ã‚¤ãƒ³</h2>
      <p style="color:#666;margin-bottom:15px;">ç¤¾å†…ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
      <div style="margin-bottom:15px;">
        <label style="display:block;font-weight:600;margin-bottom:6px;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="email" id="authEmail" placeholder="user@miyama-unitec.co.jp" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
      </div>
      <div style="margin-bottom:15px;">
        <label style="display:block;font-weight:600;margin-bottom:6px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="authPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
      </div>
      <button id="authLoginBtn" style="width:100%;padding:12px;background:#667eea;color:#fff;border:none;border-radius:6px;font-weight:bold;cursor:pointer;">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <p id="authMsg" style="color:#c62828;margin-top:10px;"></p>
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
  </div>

  <div class="header">
    <h1>ğŸ“Š ç•°å¸¸å±¥æ­´åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    <p>ãƒ‡ãƒ¼ã‚¿ãƒ‰ãƒªãƒ–ãƒ³ã«ã‚ˆã‚‹ç•°å¸¸ä½æ¸›æ´»å‹•æ”¯æ´</p>
  </div>

  <div class="container" style="display:none" id="appRoot">
    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div class="control-panel">
      <div class="period-tabs">
        <button class="period-tab active" data-period="day">ğŸ“… æ—¥æ¬¡</button>
        <button class="period-tab" data-period="week">ğŸ“† é€±æ¬¡</button>
        <button class="period-tab" data-period="month">ğŸ“Š æœˆæ¬¡</button>
      </div>

      <div style="margin-bottom:15px;">
        <label style="display:block;font-weight:600;color:#333;margin-bottom:8px;">ã‚¯ã‚¤ãƒƒã‚¯é¸æŠ</label>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;">
          <button class="date-btn" data-quick="today">ä»Šæ—¥</button>
          <button class="date-btn" data-quick="yesterday">æ˜¨æ—¥</button>
          <button class="date-btn" data-quick="thisWeek">ä»Šé€±</button>
          <button class="date-btn" data-quick="lastWeek">å…ˆé€±</button>
          <button class="date-btn" data-quick="thisMonth">ä»Šæœˆ</button>
          <button class="date-btn" data-quick="lastMonth">å…ˆæœˆ</button>
        </div>
      </div>

      <div class="control-group" style="margin-bottom:15px;max-width:320px;">
        <label>å¯¾è±¡æœˆé¸æŠ</label>
        <input type="month" id="monthSelect">
      </div>

      <div class="control-grid">
        <div class="control-group">
          <label>é–‹å§‹æ—¥</label>
          <input type="date" id="startDate">
        </div>
        <div class="control-group">
          <label>çµ‚äº†æ—¥</label>
          <input type="date" id="endDate">
        </div>
        <div class="control-group">
          <label>éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
          <select id="deptFilter">
            <option value="">å…¨éƒ¨ç½²</option>
          </select>
        </div>
        <div class="control-group">
          <label>çµã‚Šè¾¼ã¿</label>
          <label style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="moldTechOnly"> é‡‘å‹æŠ€è¡“ã®ã¿ï¼ˆä¿å…¨å˜ä½1ä»¥ä¸Šï¼‰
          </label>
        </div>
      </div>

      <button class="date-btn" id="btnAnalyze" style="width:100%;padding:12px;">ğŸ” åˆ†æå®Ÿè¡Œ</button>
    </div>

    <!-- ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿ -->
    <div class="control-panel" style="padding:0;overflow:hidden;">
      <div style="display:flex;border-bottom:2px solid #e0e0e0;">
        <button class="view-tab active" data-view="chart" style="flex:1;padding:15px;border:none;background:#fff;cursor:pointer;font-weight:bold;border-bottom:3px solid #667eea;">ğŸ“Š ã‚°ãƒ©ãƒ•ãƒ“ãƒ¥ãƒ¼</button>
        <button class="view-tab" data-view="sheet" style="flex:1;padding:15px;border:none;background:#f5f5f5;cursor:pointer;font-weight:bold;border-bottom:3px solid transparent;">ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ</button>
      </div>
    </div>

    <!-- ã‚°ãƒ©ãƒ•ãƒ“ãƒ¥ãƒ¼ -->
    <div id="chartView">
      <div class="control-panel">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;">
          <div style="background:#fff;padding:16px;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,.06);height:320px">
            <canvas id="trendChart"></canvas>
          </div>
          <div style="background:#fff;padding:16px;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,.06);height:320px">
            <canvas id="deptChart"></canvas>
          </div>
          <div style="background:#fff;padding:16px;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,.06);height:320px">
            <canvas id="stopTimeChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ -->
    <div id="sheetView" style="display:none;">
      <div class="table-container">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:15px;">
          <h3 style="color:#333;font-size:1.1rem;margin:0;">ğŸ“‹ ç•°å¸¸å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆï¼ˆå›ºå®š11åˆ—ï¼‰</h3>
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
            <button id="btnExportCSV" style="padding:10px 20px;background:#28a745;color:#fff;border:none;border-radius:6px;font-weight:bold;cursor:pointer;">ğŸ“¥ CSVå‡ºåŠ›</button>
            <div style="display:flex;gap:8px;align-items:center;">
              <div style="font-size:.85rem;color:#555;">è¡¨ç¤ºå¯†åº¦:</div>
              <button id="denseNormal"  class="date-btn" style="padding:6px 10px;">æ¨™æº–</button>
              <button id="denseCompact" class="date-btn" style="padding:6px 10px;">é«˜å¯†åº¦</button>
              <button id="denseUltra"   class="date-btn" style="padding:6px 10px;">è¶…é«˜å¯†åº¦</button>
            </div>
            <label style="display:flex;align-items:center;gap:6px;font-size:.9rem;white-space:nowrap;">
              <input type="checkbox" id="toggleClamp" checked> é•·æ–‡ã‚’3è¡Œã§æŠ˜ã‚ŠãŸãŸã‚€
            </label>
            <button id="btnSheetWide"  class="date-btn" style="padding:6px 10px;">å¹…ã‚’æ‹¡å¤§</button>
            <button id="btnSheetNorm"  class="date-btn" style="padding:6px 10px;">å…ƒã«æˆ»ã™</button>
          </div>
        </div>

        <div style="overflow-x:auto;">
          <table class="data-table" id="dataSheet">
            <thead>
              <tr id="dataSheetHeadRow"><!-- JSã§ç”Ÿæˆ --></tr>
            </thead>
            <tbody id="dataSheetBody"><!-- JSã§ç”Ÿæˆ --></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
  import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

  /* ===== Firebase ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyA0YUIpIDh4WB4p1ewiNB0XfwHve0ByljU",
    authDomain: "abnreport-fd733.firebaseapp.com",
    projectId: "abnreport-fd733",
    storageBucket: "abnreport-fd733.appspot.com",
    messagingSenderId: "349748947315",
    appId: "1:349748947315:web:010cb671d2a95bcf1f7d06"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const gate = document.getElementById('authGate');
  const appRoot = document.getElementById('appRoot');
  const signOutBtn = document.getElementById('signOutBtn');
  const loading = document.getElementById('loading');

  let allData = [];
  let currentPeriod = 'day';
  // ã‚°ãƒ©ãƒ•ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
  let charts = { trend:null, dept:null, stop:null };

  /* ===== Utils ===== */
  function normalizeDate(dateStr) {
    if (!dateStr) return '';
    if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(dateStr)) {
      const p = dateStr.split('-'); return `${p[0]}-${p[1].padStart(2,'0')}-${p[2].padStart(2,'0')}`;
    }
    if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(dateStr)) {
      const p = dateStr.split('/'); return `${p[0]}-${p[1].padStart(2,'0')}-${p[2].padStart(2,'0')}`;
    }
    try {
      const d = new Date(dateStr);
      if (!isNaN(d.getTime())) {
        const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), d2=String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${d2}`;
      }
    } catch(_e) {}
    return dateStr;
  }
  function formatDate(date){ return date.toISOString().split('T')[0]; }
  function calcStopMinutes(item){
    if(!item.occurrenceTime || !item.restartTime) return null;
    const [oh,om] = item.occurrenceTime.split(':').map(Number);
    const [rh,rm] = item.restartTime.split(':').map(Number);
    let diff = (rh*60+rm) - (oh*60+om);
    if(isNaN(diff)) return null;
    if(diff < 0) diff += 1440; // æ—¥è·¨ãç°¡æ˜“å¯¾å¿œ
    return diff;
  }
  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  /* ===== Auth ===== */
  document.getElementById('authLoginBtn').addEventListener('click', async ()=>{
    const email = (document.getElementById('authEmail').value||'').trim();
    const pw = document.getElementById('authPassword').value;
    try{
      await setPersistence(auth, browserLocalPersistence);
      await signInWithEmailAndPassword(auth, email, pw);
    }catch(e){
      document.getElementById('authMsg').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ' + (e.code||e.message);
    }
  });
  signOutBtn.addEventListener('click', ()=> signOut(auth));

  onAuthStateChanged(auth, async (user)=>{
    if (user){
      gate.style.display='none';
      appRoot.style.display='block';
      signOutBtn.style.display='inline-block';
      await loadData();
      initializeControls();
      runAnalysis();
    }else{
      appRoot.style.display='none';
      gate.style.display='flex';
      signOutBtn.style.display='none';
    }
  });

  /* ===== Data ===== */
  async function loadData(){
    loading.classList.add('active');
    try{
      const snap = await getDocs(collection(db,'anomalies'));
      const rawData = snap.docs.map(d=>{
        const data = d.data();
        if(data.occurrenceDate) data.occurrenceDate = normalizeDate(data.occurrenceDate);
        if(data.createdAt) data.createdAt = normalizeDate(data.createdAt);
        if(data.updatedAt) data.updatedAt = normalizeDate(data.updatedAt);
        return { _firebaseId: d.id, ...data };
      });

      allData = rawData.filter(x=>x.occurrenceDate);
      allData.sort((a,b)=> (b.occurrenceDate||'').localeCompare(a.occurrenceDate||''));

      // éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿
      const depts = [...new Set(allData.map(x=>x.department).filter(Boolean))].sort();
      const deptSelect = document.getElementById('deptFilter');
      if (deptSelect){
        deptSelect.innerHTML = '<option value="">å…¨éƒ¨ç½²</option>';
        depts.forEach(d=>{
          const opt = document.createElement('option');
          opt.value = opt.textContent = d;
          deptSelect.appendChild(opt);
        });
      }
    }catch(e){
      console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      alert('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
    }finally{
      loading.classList.remove('active');
    }
  }

  /* ===== Sheetï¼ˆå›ºå®š11åˆ—ï¼‰ ===== */
  let dataSheetColumns = [];
  let dataSheetColumnLabels = {};
  let dataSheetOriginalOrder = null;
  let dataSheetCurrentSortKey = null;

  function buildDataSheetColumns(){
    dataSheetColumns = [
      'occurrenceDate',   // ç™ºç”Ÿæ—¥
      'lineName',         // ãƒ©ã‚¤ãƒ³å
      'serialNo',         // æ•´ç†No
      'anomalyContent',   // ç•°å¸¸å†…å®¹
      'actionTaken',      // å¯¾å¿œå†…å®¹
      'occurrenceTime',   // ç™ºç”Ÿæ™‚åˆ»
      'restartTime',      // å†é–‹æ™‚åˆ»
      'handler',          // å‡¦ç½®è€…
      'stopMinutes',      // åœæ­¢æ™‚é–“(åˆ†)â€»æ´¾ç”Ÿ
      'discoveryTiming',  // ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°
      'rootCauseAction'   // æ˜¯æ­£å‡¦ç½®
    ];
    dataSheetColumnLabels = {
      occurrenceDate:'ç™ºç”Ÿæ—¥', lineName:'ãƒ©ã‚¤ãƒ³å', serialNo:'æ•´ç†No',
      anomalyContent:'ç•°å¸¸å†…å®¹', actionTaken:'å¯¾å¿œå†…å®¹',
      occurrenceTime:'ç™ºç”Ÿæ™‚åˆ»', restartTime:'å†é–‹æ™‚åˆ»',
      handler:'å‡¦ç½®è€…', stopMinutes:'åœæ­¢æ™‚é–“(åˆ†)',
      discoveryTiming:'ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°', rootCauseAction:'æ˜¯æ­£å‡¦ç½®'
    };

    const headRow = document.getElementById('dataSheetHeadRow');
    if (!headRow){
      console.warn('[buildDataSheetColumns] #dataSheetHeadRow ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    headRow.innerHTML = dataSheetColumns.map(col=>{
      const label = dataSheetColumnLabels[col] || col;
      return `<th data-col="${col}">${label} <button class="sort-btn" data-table="sheet" data-key="${col}">â–²</button></th>`;
    }).join('');

    dataSheetOriginalOrder = null;
    dataSheetCurrentSortKey = null;
  }

  function renderDataSheet(data){
    const tbody = document.getElementById('dataSheetBody');
    if (!tbody){
      console.warn('[renderDataSheet] #dataSheetBody ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    if(!data || data.length === 0){
      tbody.innerHTML = '<tr><td colspan="999" style="text-align:center;padding:40px;color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }
    if(!dataSheetOriginalOrder) dataSheetOriginalOrder = data.map((_,i)=>i);

    const memoCols = new Set(['anomalyContent','actionTaken','rootCauseAction']);
    const html = data.map(item=>{
      return `<tr>${dataSheetColumns.map(col=>{
        let val = '';
        let klass = memoCols.has(col) ? 'cell-memo' : 'cell-nowrap';
        if(col === 'stopMinutes'){
          const m = calcStopMinutes(item); val = (m===null||m===undefined)?'':m;
        }else{
          val = item[col];
          if(Array.isArray(val)) val = val.join(' | ');
          else if(typeof val === 'object' && val !== null) val = JSON.stringify(val);
          val = (val===undefined||val===null)?'':String(val);
          val = memoCols.has(col) ? `<div title="${escapeHTML(val)}">${escapeHTML(val)}</div>` : escapeHTML(val);
        }
        return `<td data-col="${col}" class="${klass}">${val || (col==='stopMinutes'?'':'-')}</td>`;
      }).join('')}</tr>`;
    }).join('');
    tbody.innerHTML = html;
  }

  function compareAsc(a,b){
    const dateLike = v => typeof v==='string' && /^\d{4}-\d{2}-\d{2}$/.test(v);
    if(dateLike(a) && dateLike(b)) return a.localeCompare(b);
    const na = parseFloat(a), nb = parseFloat(b);
    if(!isNaN(na) && !isNaN(nb)) return na-nb;
    const timeLike = v => typeof v==='string' && /^\d{1,2}:\d{2}$/.test(v);
    if(timeLike(a) && timeLike(b)){
      const [ah,am]=a.split(':').map(Number), [bh,bm]=b.split(':').map(Number);
      return (ah*60+am)-(bh*60+bm);
    }
    return String(a).localeCompare(String(b), 'ja');
  }

  function sortDataSheetBy(key){
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const dept = document.getElementById('deptFilter').value;
    const moldTechOnly = document.getElementById('moldTechOnly').checked;

    let data = allData.filter(x=> x.occurrenceDate && x.occurrenceDate >= startDate && x.occurrenceDate <= endDate);
    if(dept) data = data.filter(x=> x.department === dept);
    if(moldTechOnly) data = data.filter(x=> Number(x?.maintenanceUnit ?? 0) >= 1);

    if(dataSheetCurrentSortKey === key){
      dataSheetCurrentSortKey = null;
      data.sort((a,b)=> (b.occurrenceDate||'').localeCompare(a.occurrenceDate||'')); // å…ƒã«æˆ»ã™ï¼ˆæ—¥ä»˜é™é †ï¼‰
      renderDataSheet(data);
      return;
    }
    dataSheetCurrentSortKey = key;
    const getter = (row)=> key==='stopMinutes' ? calcStopMinutes(row) : (row[key] ?? '');
    data.sort((a,b)=> compareAsc(getter(a), getter(b)));
    renderDataSheet(data);
  }

  // ãƒ˜ãƒƒãƒ€ãƒ¼ã®â–²ã‚¯ãƒªãƒƒã‚¯ï¼ˆå§”ä»»ï¼‰
  document.addEventListener('click', (evt)=>{
    const btn = evt.target.closest('.sort-btn');
    if(!btn) return;
    if(btn.dataset.table === 'sheet'){
      sortDataSheetBy(btn.dataset.key);
    }
  });

  /* ===== ã‚°ãƒ©ãƒ•é–¢æ•° ===== */
  function isoWeekKey(dateStr){
    const d = new Date(dateStr + 'T00:00:00');
    if (isNaN(d)) return dateStr;
    const target = new Date(d.valueOf());
    const dayNr = (d.getDay() + 6) % 7; // æœˆ:0 â€¦ æ—¥:6
    target.setDate(target.getDate() - dayNr + 3);
    const firstThursday = new Date(target.getFullYear(),0,4);
    const firstDayNr = (firstThursday.getDay() + 6) % 7;
    firstThursday.setDate(firstThursday.getDate() - firstDayNr + 3);
    const weekNo = 1 + Math.round((target - firstThursday) / (7*24*3600*1000));
    return `${target.getFullYear()}-W${String(weekNo).padStart(2,'0')}`;
  }

  function renderTrendChart(data){
    const canvas = document.getElementById('trendChart');
    if (!canvas) return;

    const grouped = {};
    data.forEach(x=>{
      if(!x.occurrenceDate) return;
      let key;
      if (currentPeriod === 'day') key = x.occurrenceDate;
      else if (currentPeriod === 'week') key = isoWeekKey(x.occurrenceDate);
      else key = x.occurrenceDate.slice(0,7);
      grouped[key] = (grouped[key]||0) + 1;
    });

    const labels = Object.keys(grouped).sort();
    const values = labels.map(k=>grouped[k]);

    if (charts.trend) charts.trend.destroy();
    charts.trend = new Chart(canvas, {
      type: 'line',
      data: { labels, datasets: [{ label: 'ç•°å¸¸ä»¶æ•°', data: values, borderColor: '#667eea', backgroundColor: 'rgba(102,126,234,0.12)', tension: 0.35, fill: true, pointRadius: 2 }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: true }, tooltip: { mode: 'index', intersect: false } },
        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
      }
    });
  }

  function renderDeptChart(data){
    const canvas = document.getElementById('deptChart');
    if (!canvas) return;

    const counts = {};
    data.forEach(x=>{
      const dept = x.department || '(æœªè¨­å®š)';
      counts[dept] = (counts[dept]||0) + 1;
    });

    const labels = Object.keys(counts).sort((a,b)=>counts[b]-counts[a]);
    const values = labels.map(k=>counts[k]);

    if (charts.dept) charts.dept.destroy();
    charts.dept = new Chart(canvas, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'ä»¶æ•°', data: values }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
        scales: {
          x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 } },
          y: { beginAtZero: true, ticks: { precision: 0 } }
        }
      }
    });
  }

  function renderStopTimeChart(data){
    const canvas = document.getElementById('stopTimeChart');
    if (!canvas) return;

    const bins = { '0-10åˆ†':0, '10-30åˆ†':0, '30-60åˆ†':0, '60åˆ†ä»¥ä¸Š':0, 'æœªè¨˜éŒ²':0 };
    data.forEach(x=>{
      const m = calcStopMinutes(x);
      if (m === null || m === undefined) bins['æœªè¨˜éŒ²']++;
      else if (m < 10)  bins['0-10åˆ†']++;
      else if (m < 30)  bins['10-30åˆ†']++;
      else if (m < 60)  bins['30-60åˆ†']++;
      else              bins['60åˆ†ä»¥ä¸Š']++;
    });

    if (charts.stop) charts.stop.destroy();
    charts.stop = new Chart(canvas, {
      type: 'doughnut',
      data: { labels: Object.keys(bins), datasets: [{ data: Object.values(bins) }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, cutout: '55%' }
    });
  }

  /* ===== å®Ÿè¡Œç³» ===== */
  function runAnalysis(){
    loading.classList.add('active');
    setTimeout(()=>{
      try{
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const dept = document.getElementById('deptFilter').value;
        const moldTechOnly = document.getElementById('moldTechOnly').checked;

        let filtered = allData.filter(x=> x.occurrenceDate && x.occurrenceDate >= startDate && x.occurrenceDate <= endDate);
        if(dept) filtered = filtered.filter(x=> x.department === dept);
        if(moldTechOnly) filtered = filtered.filter(x => Number(x?.maintenanceUnit ?? 0) >= 1);

        renderDataSheet(filtered);
        renderTrendChart(filtered);
        renderDeptChart(filtered);
        renderStopTimeChart(filtered);
      }finally{
        loading.classList.remove('active');
      }
    }, 50);
  }

  /* ===== CSV ===== */
  function exportCSV(){
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const dept = document.getElementById('deptFilter').value;
    const moldTechOnly = document.getElementById('moldTechOnly').checked;

    let data = allData.filter(x=> x.occurrenceDate && x.occurrenceDate >= startDate && x.occurrenceDate <= endDate);
    if(dept) data = data.filter(x=> x.department === dept);
    if(moldTechOnly) data = data.filter(x => Number(x?.maintenanceUnit ?? 0) >= 1);
    if(data.length === 0){ alert('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

    const headers = dataSheetColumns.map(k => dataSheetColumnLabels[k] || k);
    const rows = data.map(item=>{
      return dataSheetColumns.map(col=>{
        if(col==='stopMinutes'){
          const m = calcStopMinutes(item); return (m===null||m===undefined)?'':m;
        }else{
          let v = item[col];
          if(Array.isArray(v)) v = v.join(' | ');
          else if(typeof v === 'object' && v !== null) v = JSON.stringify(v);
          return (v===undefined||v===null)?'':String(v);
        }
      });
    });
    let csv = '\uFEFF' + headers.join(',') + '\n';
    rows.forEach(r=>{ csv += r.map(c=>`"${(c??'').toString().replace(/"/g,'""')}"`).join(',')+'\n'; });
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `ç•°å¸¸å±¥æ­´_${startDate}_${endDate}.csv`;
    a.click();
  }

  /* ===== Init / Events ===== */
  function initializeControls(){
    const today = new Date();
    const endStr = formatDate(today);
    const startStr = formatDate(new Date(today.getFullYear(), today.getMonth(), 1));
    document.getElementById('endDate').value = endStr;
    document.getElementById('startDate').value = startStr;
    document.getElementById('monthSelect').value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;

    // æœŸé–“ã‚¿ãƒ–
    document.querySelectorAll('.period-tab').forEach(tab=>{
      tab.addEventListener('click', ()=>{
        document.querySelectorAll('.period-tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        currentPeriod = tab.dataset.period;
        runAnalysis();
      });
    });

    // ã‚¯ã‚¤ãƒƒã‚¯æœŸé–“
    document.querySelectorAll('[data-quick]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const type = btn.dataset.quick;
        const t = new Date();
        let s, e;
        if(type === 'today'){ s = e = formatDate(t); }
        else if(type === 'yesterday'){ const y=new Date(t); y.setDate(y.getDate()-1); s=e=formatDate(y); }
        else if(type === 'thisWeek'){ const day=t.getDay(); const diff=t.getDate()-day+(day===0?-6:1); s=formatDate(new Date(t.getFullYear(),t.getMonth(),diff)); e=formatDate(t); }
        else if(type === 'lastWeek'){ const day=t.getDay(); const diff=t.getDate()-day+(day===0?-6:1)-7; s=formatDate(new Date(t.getFullYear(),t.getMonth(),diff)); e=formatDate(new Date(t.getFullYear(),t.getMonth(),diff+6)); }
        else if(type === 'thisMonth'){ s=formatDate(new Date(t.getFullYear(),t.getMonth(),1)); e=formatDate(t); }
        else if(type === 'lastMonth'){ s=formatDate(new Date(t.getFullYear(),t.getMonth()-1,1)); e=formatDate(new Date(t.getFullYear(),t.getMonth(),0)); }
        document.getElementById('startDate').value = s;
        document.getElementById('endDate').value = e;
        document.querySelectorAll('[data-quick]').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        runAnalysis();
      });
    });

    // æœˆé¸æŠ
    document.getElementById('monthSelect').addEventListener('change', (ev)=>{
      const [year, month] = ev.target.value.split('-').map(Number);
      const s = formatDate(new Date(year, month - 1, 1));
      const eStr = formatDate(new Date(year, month, 0));
      document.getElementById('startDate').value = s;
      document.getElementById('endDate').value = eStr;
      runAnalysis();
    });

    // ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿
    document.querySelectorAll('.view-tab').forEach(tab=>{
      tab.addEventListener('click', ()=>{
        document.querySelectorAll('.view-tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        const view = tab.dataset.view;
        document.getElementById('chartView').style.display = view === 'chart' ? 'block' : 'none';
        document.getElementById('sheetView').style.display = view === 'sheet' ? 'block' : 'none';
      });
    });

    // å®Ÿè¡Œï¼†CSV
    document.getElementById('btnAnalyze').addEventListener('click', runAnalysis);
    document.getElementById('btnExportCSV').addEventListener('click', exportCSV);

    // è¡¨ç¤ºå¯†åº¦
    const dn = document.getElementById('denseNormal');
    const dc = document.getElementById('denseCompact');
    const du = document.getElementById('denseUltra');
    if (dn) dn.addEventListener('click', ()=>{ document.body.classList.remove('density-compact','density-ultra'); });
    if (dc) dc.addEventListener('click', ()=>{ document.body.classList.add('density-compact'); document.body.classList.remove('density-ultra'); });
    if (du) du.addEventListener('click', ()=>{ document.body.classList.add('density-compact','density-ultra'); });

    // é•·æ–‡æŠ˜ã‚ŠãŸãŸã¿
    const clamp = document.getElementById('toggleClamp');
    if (clamp) clamp.addEventListener('change', (ev)=>{
      const on = ev.target.checked;
      document.querySelectorAll('td.cell-memo > div').forEach(el=>{
        if(on){ el.style.setProperty('-webkit-line-clamp','3'); el.style.maxHeight = '4.6em'; }
        else  { el.style.setProperty('-webkit-line-clamp','unset'); el.style.maxHeight = 'none'; }
      });
    });

    // è¡¨ç¤ºå¹…åˆ‡æ›¿
    const btnWide = document.getElementById('btnSheetWide');
    const btnNorm = document.getElementById('btnSheetNorm');
    if (btnWide) btnWide.addEventListener('click', ()=>{
      document.body.classList.add('body-sheet-wide');
      document.body.classList.remove('body-sheet-ultra');
    });
    if (btnNorm) btnNorm.addEventListener('click', ()=>{
      document.body.classList.remove('body-sheet-wide','body-sheet-ultra');
    });

    // åˆå›ãƒ˜ãƒƒãƒ€ãƒ¼ç”Ÿæˆ
    buildDataSheetColumns();
  }

</script>
</body>
</html>
