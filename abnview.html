<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•°å¸¸å±¥æ­´åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Hiragino Sans',sans-serif;background:#f5f5f5}
  .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  .header h1{font-size:1.8rem;margin-bottom:5px}
  .container{max-width:1400px;margin:0 auto;padding:20px}
  
  /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
  .control-panel{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);margin-bottom:20px}
  .control-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:15px}
  .control-group label{display:block;font-weight:600;color:#333;margin-bottom:6px;font-size:.9rem}
  .control-group select,.control-group input{width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;font-size:.95rem}
  .control-group select:focus,.control-group input:focus{outline:none;border-color:#667eea}
  .period-tabs{display:flex;gap:8px;margin-bottom:15px}
  .period-tab{flex:1;padding:12px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:8px;cursor:pointer;font-weight:bold;transition:.2s;text-align:center}
  .period-tab.active{background:#667eea;color:#fff}
  .period-tab:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,.3)}
  .btn-analyze{width:100%;padding:14px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:bold;cursor:pointer;transition:.3s}
  .btn-analyze:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,.4)}
  
  /* ã‚¯ã‚¤ãƒƒã‚¯æ—¥ä»˜é¸æŠãƒœã‚¿ãƒ³ */
  .date-btn{padding:10px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:6px;cursor:pointer;font-weight:600;font-size:.9rem;transition:.2s;text-align:center}
  .date-btn:hover{background:#667eea;color:#fff;transform:translateY(-2px)}
  .date-btn.active{background:#667eea;color:#fff}
  
  /* ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ– */
  .view-tab{transition:.2s}
  .view-tab:hover{background:#f8f9ff}
  .view-tab.active{background:#fff!important;border-bottom-color:#667eea!important;color:#667eea}
  
  /* KPIã‚«ãƒ¼ãƒ‰ */
  .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:15px;margin-bottom:20px}
  .kpi-card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);position:relative;overflow:hidden}
  .kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--accent-color),var(--accent-color-light))}
  .kpi-card.blue{--accent-color:#2196f3;--accent-color-light:#64b5f6}
  .kpi-card.green{--accent-color:#4caf50;--accent-color-light:#81c784}
  .kpi-card.orange{--accent-color:#ff9800;--accent-color-light:#ffb74d}
  .kpi-card.red{--accent-color:#f44336;--accent-color-light:#e57373}
  .kpi-card.purple{--accent-color:#9c27b0;--accent-color-light:#ba68c8}
  .kpi-label{font-size:.85rem;color:#666;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px}
  .kpi-value{font-size:2.2rem;font-weight:700;color:#333;line-height:1}
  .kpi-change{font-size:.85rem;margin-top:8px;padding:4px 8px;border-radius:12px;display:inline-block;font-weight:600}
  .kpi-change.up{background:#ffebee;color:#c62828}
  .kpi-change.down{background:#e8f5e9;color:#2e7d32}
  .kpi-change.neutral{background:#f5f5f5;color:#666}
  
  /* ãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠ */
  .chart-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(500px,1fr));gap:20px;margin-bottom:20px}
  .chart-container{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
  .chart-title{font-size:1.1rem;font-weight:700;color:#333;margin-bottom:15px;display:flex;align-items:center;gap:10px}
  .chart-title .icon{font-size:1.3rem}
  .chart-wrapper{position:relative;height:300px}
  .chart-container.large{grid-column:1/-1}
  .chart-wrapper.large{height:400px}
  
  /* ãƒ†ãƒ¼ãƒ–ãƒ« */
  .table-container{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);margin-bottom:20px}
  .table-header-actions{font-size:.8rem;font-weight:600;display:flex;gap:8px;align-items:center}
  .data-table{width:100%;border-collapse:collapse}
  .data-table th{background:#667eea;color:#fff;padding:12px;text-align:left;font-weight:600;position:sticky;top:0}
  .data-table th .sort-btn{margin-left:6px;background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.5);color:#fff;padding:2px 6px;border-radius:4px;cursor:pointer;font-size:.8rem}
  .data-table th .sort-btn:hover{background:rgba(255,255,255,.35)}
  .data-table td{padding:12px;border-bottom:1px solid #f0f0f0;vertical-align:top}
  .data-table tr:hover{background:#f8f9ff}
  .rank-badge{display:inline-block;width:28px;height:28px;border-radius:50%;text-align:center;line-height:28px;font-weight:bold;font-size:.9rem}
  .rank-1{background:linear-gradient(135deg,#ffd700,#ffed4e);color:#333}
  .rank-2{background:linear-gradient(135deg,#c0c0c0,#e8e8e8);color:#333}
  .rank-3{background:linear-gradient(135deg,#cd7f32,#e9a66e);color:#fff}
  .rank-other{background:#f0f0f0;color:#666}
  
  /* ã‚¢ãƒ©ãƒ¼ãƒˆ */
  .alert-container{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);margin-bottom:20px}
  .alert-item{padding:15px;margin-bottom:10px;border-radius:8px;border-left:4px solid;display:flex;align-items:center;gap:15px}
  .alert-item:last-child{margin-bottom:0}
  .alert-danger{background:#ffebee;border-color:#c62828;color:#b71c1c}
  .alert-warning{background:#fff3e0;border-color:#f57c00;color:#e65100}
  .alert-success{background:#e8f5e9;border-color:#2e7d32;color:#1b5e20}
  .alert-icon{font-size:1.5rem;flex-shrink:0}
  .alert-content{flex:1}
  .alert-title{font-weight:700;margin-bottom:4px}
  .alert-desc{font-size:.9rem;opacity:.9}
  
  /* ç©ºçŠ¶æ…‹ */
  .empty-state{text-align:center;padding:60px 20px;color:#999}
  .empty-state-icon{font-size:4rem;margin-bottom:15px;opacity:.5}
  .empty-state-text{font-size:1.1rem}
  
  /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
  .loading{display:none;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:1000;align-items:center;justify-content:center}
  .loading.active{display:flex}
  .loading-spinner{width:60px;height:60px;border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  
  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
  @media (max-width:768px){
    .chart-grid{grid-template-columns:1fr}
    .kpi-grid{grid-template-columns:1fr}
    .control-grid{grid-template-columns:1fr}
    .table-header-actions{display:block}
  }
  
  #authGate{position:fixed;inset:0;background:#f5f5f5;display:flex;align-items:center;justify-content:center;z-index:2000}
  #authCard{background:#fff;max-width:380px;width:92%;padding:24px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
  #signOutBtn{position:fixed;right:12px;top:12px;background:#ef5350;color:#fff;border:none;border-radius:6px;padding:8px 12px;cursor:pointer;z-index:1500;font-weight:600}
</style>
</head>
<body>
  <button id="signOutBtn" style="display:none;">ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ</button>

  <div id="authGate">
    <div id="authCard">
      <h2 style="margin-bottom:10px;color:#667eea;">ğŸ” ã‚µã‚¤ãƒ³ã‚¤ãƒ³</h2>
      <p style="color:#666;margin-bottom:15px;">ç¤¾å†…ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
      <div style="margin-bottom:15px;">
        <label style="display:block;font-weight:600;margin-bottom:6px;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="email" id="authEmail" placeholder="user@miyama-unitec.co.jp" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
      </div>
      <div style="margin-bottom:15px;">
        <label style="display:block;font-weight:600;margin-bottom:6px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="authPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
      </div>
      <button id="authLoginBtn" style="width:100%;padding:12px;background:#667eea;color:#fff;border:none;border-radius:6px;font-weight:bold;cursor:pointer;">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <p id="authMsg" style="color:#c62828;margin-top:10px;"></p>
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
  </div>

  <div class="header">
    <h1>ğŸ“Š ç•°å¸¸å±¥æ­´åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    <p>ãƒ‡ãƒ¼ã‚¿ãƒ‰ãƒªãƒ–ãƒ³ã«ã‚ˆã‚‹ç•°å¸¸ä½æ¸›æ´»å‹•æ”¯æ´</p>
  </div>

  <div class="container" style="display:none" id="appRoot">
    <!-- ãƒ‡ãƒ¼ã‚¿ç¢ºèªãƒ‘ãƒãƒ« -->
    <div class="control-panel" style="background:#e3f2fd;border:2px solid #2196f3;">
      <h3 style="color:#1976d2;margin-bottom:10px;display:flex;align-items:center;gap:8px;">
        <span>â„¹ï¸</span>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿çŠ¶æ³
      </h3>
      <div style="display:grid;gap:10px;font-size:.95rem;">
        <div><strong>ç·ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:</strong> <span id="debugTotalCount" style="color:#1976d2;font-weight:700;">0</span></div>
        <div><strong>æ•´ç†Noã‚ã‚Š:</strong> <span id="debugWithSerial">0</span></div>
        <div><strong>æ•´ç†Noãªã—:</strong> <span id="debugNoSerial">0</span></div>
        <div><strong>ç™ºç”Ÿæ—¥ã®ç¯„å›²:</strong> <span id="debugDateRange">-</span></div>
        <div><strong>éƒ¨ç½²ä¸€è¦§:</strong> <span id="debugDepts">-</span></div>
      </div>
      <button id="btnReload" style="margin-top:10px;width:100%;padding:10px;background:#2196f3;color:#fff;border:none;border-radius:6px;font-weight:bold;cursor:pointer;">
        ğŸ”„ ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
      </button>
    </div>
    
    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
    <div class="control-panel">
      <div class="period-tabs">
        <button class="period-tab active" data-period="day">ğŸ“… æ—¥æ¬¡</button>
        <button class="period-tab" data-period="week">ğŸ“† é€±æ¬¡</button>
        <button class="period-tab" data-period="month">ğŸ“Š æœˆæ¬¡</button>
      </div>
      
      <!-- ã‚¯ã‚¤ãƒƒã‚¯æœŸé–“é¸æŠ -->
      <div style="margin-bottom:15px;">
        <label style="display:block;font-weight:600;color:#333;margin-bottom:8px;">ã‚¯ã‚¤ãƒƒã‚¯é¸æŠ</label>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;">
          <button class="date-btn" data-quick="today">ä»Šæ—¥</button>
          <button class="date-btn" data-quick="yesterday">æ˜¨æ—¥</button>
          <button class="date-btn" data-quick="thisWeek">ä»Šé€±</button>
          <button class="date-btn" data-quick="lastWeek">å…ˆé€±</button>
          <button class="date-btn" data-quick="thisMonth">ä»Šæœˆ</button>
          <button class="date-btn" data-quick="lastMonth">å…ˆæœˆ</button>
        </div>
      </div>
      
      <!-- æœˆé¸æŠ -->
      <div class="control-group" style="margin-bottom:15px;">
        <label>å¯¾è±¡æœˆé¸æŠ</label>
        <input type="month" id="monthSelect" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
      </div>
      
      <div class="control-grid">
        <div class="control-group">
          <label>é–‹å§‹æ—¥</label>
          <input type="date" id="startDate">
        </div>
        <div class="control-group">
          <label>çµ‚äº†æ—¥</label>
          <input type="date" id="endDate">
        </div>
       <div class="control-group">
  <label>çµã‚Šè¾¼ã¿</label>
  <label style="display:flex;align-items:center;gap:8px;">
    <input type="checkbox" id="moldTechOnly">
    é‡‘å‹æŠ€è¡“ã®ã¿ï¼ˆä¿å…¨å˜ä½1ä»¥ä¸Šï¼‰
  </label>
</div>

        <div class="control-group">
          <label>éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
          <select id="deptFilter">
            <option value="">å…¨éƒ¨ç½²</option>
          </select>
        </div>
      </div>
      
      <button class="btn-analyze" id="btnAnalyze">ğŸ” åˆ†æå®Ÿè¡Œ</button>
    </div>

    <!-- KPIã‚«ãƒ¼ãƒ‰ -->
    <div class="kpi-grid" id="kpiGrid"></div>

    <!-- ã‚¢ãƒ©ãƒ¼ãƒˆ -->
    <div class="alert-container" id="alertContainer" style="display:none;">
      <h3 style="color:#333;margin-bottom:15px;font-size:1.2rem;">ğŸš¨ ã‚¢ãƒ©ãƒ¼ãƒˆ</h3>
      <div id="alertList"></div>
    </div>

    <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
    <div class="control-panel" style="padding:0;overflow:hidden;">
      <div style="display:flex;border-bottom:2px solid #e0e0e0;">
        <button class="view-tab active" data-view="chart" style="flex:1;padding:15px;border:none;background:#fff;cursor:pointer;font-weight:bold;border-bottom:3px solid #667eea;">
          ğŸ“Š ã‚°ãƒ©ãƒ•ãƒ“ãƒ¥ãƒ¼
        </button>
        <button class="view-tab" data-view="sheet" style="flex:1;padding:15px;border:none;background:#f5f5f5;cursor:pointer;font-weight:bold;border-bottom:3px solid transparent;">
          ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ
        </button>
      </div>
    </div>

    <!-- ã‚°ãƒ©ãƒ•ãƒ“ãƒ¥ãƒ¼ -->
    <div id="chartView">
      <div class="chart-grid">
        <div class="chart-container large">
          <div class="chart-title"><span class="icon">ğŸ“ˆ</span>ç•°å¸¸ä»¶æ•°æ¨ç§»</div>
          <div class="chart-wrapper large">
            <canvas id="trendChart"></canvas>
          </div>
        </div>
        
        <div class="chart-container">
          <div class="chart-title"><span class="icon">ğŸ­</span>éƒ¨ç½²åˆ¥ç•°å¸¸ä»¶æ•°</div>
          <div class="chart-wrapper">
            <canvas id="deptChart"></canvas>
          </div>
        </div>
        
        <div class="chart-container">
          <div class="chart-title"><span class="icon">â±ï¸</span>åœæ­¢æ™‚é–“åˆ†å¸ƒ</div>
          <div class="chart-wrapper">
            <canvas id="stopTimeChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Top10ãƒ†ãƒ¼ãƒ–ãƒ« -->
      <div class="table-container">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
          <h3 style="color:#333;margin:0;font-size:1.2rem;">ğŸ† ç•°å¸¸ä»¶æ•°Top10ï¼ˆæ•´ç†Noåˆ¥ï¼‰</h3>
          <div class="table-header-actions">åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼ã®â–²ã§æ˜‡é † / ã‚‚ã†ä¸€åº¦ã§å…ƒã«æˆ»ã™</div>
        </div>
        <div style="overflow-x:auto;">
          <table class="data-table" id="top10Table">
            <thead>
              <tr>
                <th>é †ä½</th>
                <th>æ•´ç†No <button class="sort-btn" data-table="top10" data-key="serialNo">â–²</button></th>
                <th>ä»¶æ•° <button class="sort-btn" data-table="top10" data-key="count">â–²</button></th>
                <th>å…ˆæœˆæ¯”(%) <button class="sort-btn" data-table="top10" data-key="change">â–²</button></th>
                <th>ä¸»è¦éƒ¨ç½² <button class="sort-btn" data-table="top10" data-key="mainDept">â–²</button></th>
                <th>å¹³å‡åœæ­¢æ™‚é–“(åˆ†) <button class="sort-btn" data-table="top10" data-key="avgStopNum">â–²</button></th>
                <th>ãƒˆãƒ¬ãƒ³ãƒ‰ <button class="sort-btn" data-table="top10" data-key="trendRank">â–²</button></th>
              </tr>
            </thead>
            <tbody id="top10Body"></tbody>
          </table>
        </div>
      </div>

      <!-- æ•´ç†Noè©³ç´°åˆ†æ -->
      <div class="table-container">
        <h3 style="color:#333;margin-bottom:15px;font-size:1.2rem;">ğŸ” æ•´ç†Noè©³ç´°åˆ†æ</h3>
        <div class="control-group" style="margin-bottom:15px;max-width:400px;">
          <label>æ•´ç†Noã‚’é¸æŠ</label>
          <select id="serialNoSelect">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
        <div id="serialNoDetail" style="display:none;">
          <div class="chart-container">
            <div class="chart-title"><span class="icon">ğŸ“‰</span>æœŸé–“åˆ¥æ¨ç§»</div>
            <div class="chart-wrapper">
              <canvas id="serialNoTrendChart"></canvas>
            </div>
          </div>
          <div style="margin-top:20px;">
            <h4 style="color:#667eea;margin-bottom:10px;">é »å‡ºã™ã‚‹ç•°å¸¸å†…å®¹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</h4>
            <div id="keywordCloud" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ -->
    <div id="sheetView" style="display:none;">
      <div class="table-container">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
          <h3 style="color:#333;font-size:1.2rem;margin:0;">ğŸ“‹ ç•°å¸¸å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆï¼ˆå…¨é …ç›®è¡¨ç¤ºãƒ»çŠ¶æ…‹ã¯é™¤å¤–ï¼‰</h3>
          <div>
            <button id="btnExportCSV" style="padding:10px 20px;background:#28a745;color:#fff;border:none;border-radius:6px;font-weight:bold;cursor:pointer;">
              ğŸ“¥ CSVå‡ºåŠ›
            </button>
          </div>
        </div>
        <div style="overflow-x:auto;">
          <table class="data-table" id="dataSheet">
            <thead>
              <tr id="dataSheetHeadRow"><!-- å‹•çš„ç”Ÿæˆï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‹â–²ã‚½ãƒ¼ãƒˆï¼‰ --></tr>
            </thead>
            <tbody id="dataSheetBody"><!-- å‹•çš„ç”Ÿæˆ --></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
  import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyA0YUIpIDh4WB4p1ewiNB0XfwHve0ByljU",
    authDomain: "abnreport-fd733.firebaseapp.com",
    projectId: "abnreport-fd733",
    storageBucket: "abnreport-fd733.appspot.com",
    messagingSenderId: "349748947315",
    appId: "1:349748947315:web:010cb671d2a95bcf1f7d06"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const gate = document.getElementById('authGate');
  const appRoot = document.getElementById('appRoot');
  const signOutBtn = document.getElementById('signOutBtn');
  const loading = document.getElementById('loading');

  let allData = [];
  let charts = {};
  let currentPeriod = 'day';

  // ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã®åˆ—ç®¡ç†ï¼ˆå‹•çš„ï¼‰
  let dataSheetColumns = [];        // å®Ÿéš›ã«è¡¨ç¤ºã™ã‚‹åˆ—ã‚­ãƒ¼é…åˆ—
  let dataSheetColumnLabels = {};   // æ—¥æœ¬èªãƒ©ãƒ™ãƒ«
  let dataSheetOriginalOrder = [];  // å…ƒã®ä¸¦ã³ç”¨ï¼ˆã‚½ãƒ¼ãƒˆè§£é™¤æ™‚ã«æˆ»ã™ï¼‰
  let dataSheetCurrentSortKey = null;

  // Top10 ã‚½ãƒ¼ãƒˆç”¨
  let computedTop10Rows = [];       // æç”»ç”¨ãƒ‡ãƒ¼ã‚¿
  let top10OriginalOrder = [];      // å…ƒä¸¦ã³
  let top10CurrentSortKey = null;

  // æ—¥ä»˜æ­£è¦åŒ–ï¼ˆYYYY-MM-DDï¼‰
  function normalizeDate(dateStr) {
    if (!dateStr) return '';
    if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(dateStr)) {
      const p = dateStr.split('-'); return `${p[0]}-${p[1].padStart(2,'0')}-${p[2].padStart(2,'0')}`;
    }
    if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(dateStr)) {
      const p = dateStr.split('/'); return `${p[0]}-${p[1].padStart(2,'0')}-${p[2].padStart(2,'0')}`;
    }
    try {
      const d = new Date(dateStr);
      if (!isNaN(d.getTime())) {
        const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), d2=String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${d2}`;
      }
    } catch(e) {}
    return dateStr;
  }

  // èªè¨¼
  document.getElementById('authLoginBtn').addEventListener('click', async ()=>{
    const email = (document.getElementById('authEmail').value||'').trim();
    const pw = document.getElementById('authPassword').value;
    try{
      await setPersistence(auth, browserLocalPersistence);
      await signInWithEmailAndPassword(auth, email, pw);
    }catch(e){
      document.getElementById('authMsg').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ' + (e.code||e.message);
    }
  });
  signOutBtn.addEventListener('click', ()=> signOut(auth));

  onAuthStateChanged(auth, async (user)=>{
    if (user){
      gate.style.display='none';
      appRoot.style.display='block';
      signOutBtn.style.display='inline-block';
      await loadData();
      initializeControls();
      runAnalysis();
    }else{
      appRoot.style.display='none';
      gate.style.display='flex';
      signOutBtn.style.display='none';
    }
  });
  
  async function reloadData(){
    await loadData();
    runAnalysis();
  }

  // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  async function loadData(){
    loading.classList.add('active');
    try{
      const snap = await getDocs(collection(db,'anomalies'));
      const rawData = snap.docs.map(d=> {
        const data = d.data();
        if (data.occurrenceDate) data.occurrenceDate = normalizeDate(data.occurrenceDate);
        if (data.createdAt) data.createdAt = normalizeDate(data.createdAt);
        if (data.updatedAt) data.updatedAt = normalizeDate(data.updatedAt);
        return { _firebaseId: d.id, ...data };
      });

      allData = rawData.filter(x => x.occurrenceDate);
      allData.sort((a,b) => (b.occurrenceDate||'').localeCompare(a.occurrenceDate||''));

      updateDebugInfo(rawData, allData);

      // éƒ¨ç½²ãƒªã‚¹ãƒˆ
      const depts = [...new Set(allData.map(x=>x.department).filter(Boolean))].sort();
      const deptSelect = document.getElementById('deptFilter');
      deptSelect.innerHTML = '<option value="">å…¨éƒ¨ç½²</option>';
      depts.forEach(d=>{
        const opt = document.createElement('option');
        opt.value = opt.textContent = d;
        deptSelect.appendChild(opt);
      });

      // ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆåˆ—ã®è‡ªå‹•æ§‹æˆï¼ˆå…¨é …ç›®è¡¨ç¤ºï¼šstatus/_firebaseIdã¯é™¤å¤–ã€åœæ­¢æ™‚é–“(åˆ†)ã¯æ´¾ç”Ÿåˆ—ï¼‰
      buildDataSheetColumns(allData);

    }catch(e){
      console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      alert('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
    }finally{
      loading.classList.remove('active');
    }
  }
  
  function updateDebugInfo(rawData, validData){
    document.getElementById('debugTotalCount').textContent = rawData.length;
    const withSerial = validData.filter(x => x.serialNo && x.serialNo.trim() !== '').length;
    const noSerial = validData.length - withSerial;
    document.getElementById('debugWithSerial').textContent = withSerial;
    document.getElementById('debugNoSerial').textContent = noSerial;
    if(validData.length > 0){
      const dates = validData.map(x => x.occurrenceDate).filter(Boolean).sort();
      const minDate = dates[0], maxDate = dates[dates.length - 1];
      document.getElementById('debugDateRange').textContent = `${minDate} ã€œ ${maxDate}`;
      const depts = [...new Set(validData.map(x=>x.department).filter(Boolean))];
      document.getElementById('debugDepts').textContent = depts.length > 0 ? depts.join(', ') : '(ãªã—)';
    }else{
      document.getElementById('debugDateRange').textContent = 'ãƒ‡ãƒ¼ã‚¿ãªã—';
      document.getElementById('debugDepts').textContent = '(ãªã—)';
    }
  }

  function initializeControls(){
    const today = new Date();
    const endDate = formatDate(today);
    const startDate = formatDate(new Date(today.getFullYear(), today.getMonth(), 1));
    document.getElementById('endDate').value = endDate;
    document.getElementById('startDate').value = startDate;
    document.getElementById('monthSelect').value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
    
    document.querySelectorAll('.period-tab').forEach(tab=>{
      tab.addEventListener('click', ()=>{
        document.querySelectorAll('.period-tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        currentPeriod = tab.dataset.period;
      });
    });
    
    document.querySelectorAll('[data-quick]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const type = btn.dataset.quick;
        const t = new Date();
        let start, end;
        if(type === 'today'){ start = end = formatDate(t); }
        else if(type === 'yesterday'){ const y=new Date(t); y.setDate(y.getDate()-1); start=end=formatDate(y); }
        else if(type === 'thisWeek'){ const day=t.getDay(); const diff=t.getDate()-day+(day===0?-6:1); start=formatDate(new Date(t.getFullYear(),t.getMonth(),diff)); end=formatDate(t); }
        else if(type === 'lastWeek'){ const day=t.getDay(); const diff=t.getDate()-day+(day===0?-6:1)-7; start=formatDate(new Date(t.getFullYear(),t.getMonth(),diff)); end=formatDate(new Date(t.getFullYear(),t.getMonth(),diff+6)); }
        else if(type === 'thisMonth'){ start=formatDate(new Date(t.getFullYear(),t.getMonth(),1)); end=formatDate(t); }
        else if(type === 'lastMonth'){ start=formatDate(new Date(t.getFullYear(),t.getMonth()-1,1)); end=formatDate(new Date(t.getFullYear(),t.getMonth(),0)); }
        document.getElementById('startDate').value = start;
        document.getElementById('endDate').value = end;
        document.querySelectorAll('[data-quick]').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
      });
    });
    
    document.getElementById('monthSelect').addEventListener('change', (e)=>{
      const [year, month] = e.target.value.split('-').map(Number);
      const start = formatDate(new Date(year, month - 1, 1));
      const end = formatDate(new Date(year, month, 0));
      document.getElementById('startDate').value = start;
      document.getElementById('endDate').value = end;
    });
    
    document.querySelectorAll('.view-tab').forEach(tab=>{
      tab.addEventListener('click', ()=>{
        document.querySelectorAll('.view-tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        const view = tab.dataset.view;
        document.getElementById('chartView').style.display = view === 'chart' ? 'block' : 'none';
        document.getElementById('sheetView').style.display = view === 'sheet' ? 'block' : 'none';
      });
    });
    
    document.getElementById('btnAnalyze').addEventListener('click', runAnalysis);
    document.getElementById('serialNoSelect').addEventListener('change', showSerialNoDetail);
    document.getElementById('btnReload').addEventListener('click', reloadData);
    document.getElementById('btnExportCSV').addEventListener('click', exportCSV);

    // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚½ãƒ¼ãƒˆãƒœã‚¿ãƒ³ï¼ˆTop10ã¯é™çš„ã«å­˜åœ¨ï¼‰
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.sort-btn');
      if(!btn) return;
      const table = btn.dataset.table;
      const key = btn.dataset.key;
      if(table === 'top10') {
        sortTop10By(key);
      } else if (table === 'sheet') {
        sortDataSheetBy(key);
      }
    });
  }

  function formatDate(date){ return date.toISOString().split('T')[0]; }

  function calcStopMinutes(item){
    if(!item.occurrenceTime || !item.restartTime) return null;
    const [oh,om] = item.occurrenceTime.split(':').map(Number);
    const [rh,rm] = item.restartTime.split(':').map(Number);
    let diff = (rh*60+rm) - (oh*60+om);
    if(isNaN(diff)) return null;
    if(diff < 0) diff += 1440;
    return diff;
  }

  function runAnalysis(){
    loading.classList.add('active');
    setTimeout(()=>{
      try{
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const dept = document.getElementById('deptFilter').value;

        let filtered = allData.filter(x=> x.occurrenceDate && x.occurrenceDate >= startDate && x.occurrenceDate <= endDate);
        if(dept) filtered = filtered.filter(x=> x.department === dept);

/* â–¼ è¿½åŠ ï¼šé‡‘å‹æŠ€è¡“ã®ã¿ï¼ˆä¿å…¨å˜ä½1ä»¥ä¸Šï¼‰ */
const moldTechOnly = document.getElementById('moldTechOnly').checked;
if (moldTechOnly) filtered = filtered.filter(x => Number(x?.maintenanceUnit ?? 0) >= 1);

// å…ˆæœˆï¼ˆæ¯”è¼ƒç”¨ï¼‰
const startD = new Date(startDate);
const lastMonthStart = formatDate(new Date(startD.getFullYear(), startD.getMonth() - 1, startD.getDate()));
const lastMonthEnd = formatDate(new Date(startD.getTime() - 24*60*60*1000));
let lastMonthData = allData.filter(x=> x.occurrenceDate && x.occurrenceDate >= lastMonthStart && x.occurrenceDate <= lastMonthEnd);
if(dept) lastMonthData = lastMonthData.filter(x=> x.department === dept);

/* â–¼ è¿½åŠ ï¼šé‡‘å‹æŠ€è¡“ã®ã¿ï¼ˆä¿å…¨å˜ä½1ä»¥ä¸Šï¼‰ã‚’å…ˆæœˆå´ã«ã‚‚ */
if (moldTechOnly) lastMonthData = lastMonthData.filter(x => Number(x?.maintenanceUnit ?? 0) >= 1);
        // å…ˆæœˆï¼ˆæ¯”è¼ƒç”¨ï¼‰
 
      
        let lastMonthData = allData.filter(x=> x.occurrenceDate && x.occurrenceDate >= lastMonthStart && x.occurrenceDate <= lastMonthEnd);
        if(dept) lastMonthData = lastMonthData.filter(x=> x.department === dept);

        if(filtered.length === 0){
          alert('æŒ‡å®šæœŸé–“ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœŸé–“ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚');
        }

        renderKPIs(filtered, lastMonthData);
        renderAlerts(filtered, lastMonthData);
        renderTrendChart(filtered);
        renderDeptChart(filtered);
        renderStopTimeChart(filtered);
        renderTop10Table(filtered, lastMonthData);
        updateSerialNoSelect(filtered);
        renderDataSheet(filtered); // å‹•çš„åˆ—ã§å…¨é …ç›®è¡¨ç¤º
      }finally{
        loading.classList.remove('active');
      }
    }, 100);
  }

  /*========================
    ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆï¼ˆå…¨é …ç›®è¡¨ç¤ºï¼‰
  ========================*/
  function buildDataSheetColumns(data){
    const exclude = new Set(['status','_firebaseId']);
    const basePreferred = [
      'occurrenceDate','department','lineName','serialNo','anomalyContent','actionTaken',
      'occurrenceTime','restartTime','handler','techRequest'
    ];
    const labels = {
      occurrenceDate:'ç™ºç”Ÿæ—¥', department:'éƒ¨ç½²', lineName:'ãƒ©ã‚¤ãƒ³å', serialNo:'æ•´ç†No',
      anomalyContent:'ç•°å¸¸å†…å®¹', actionTaken:'å¯¾å¿œå†…å®¹', occurrenceTime:'ç™ºç”Ÿæ™‚åˆ»',
      restartTime:'å†é–‹æ™‚åˆ»', handler:'å‡¦ç½®è€…', techRequest:'æŠ€è¡“è¦è«‹', discoveryTiming:'ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°',
      defectType:'ä¸è‰¯åŒºåˆ†', cause:'åŸå› ', countermeasure:'å¯¾ç­–', lotNo:'ãƒ­ãƒƒãƒˆNo',
      quantity:'æ•°é‡', unit:'å˜ä½', location:'ç™ºç”Ÿå ´æ‰€', reporter:'è¨˜éŒ²è€…', createdAt:'ä½œæˆæ—¥',
      updatedAt:'æ›´æ–°æ—¥', equipment:'è¨­å‚™', lineStop:'åœæ­¢æœ‰ç„¡', photoUrl:'å†™çœŸURL', photoUrls:'å†™çœŸURLä¸€è¦§',maintenanceUnit:'ä¿å…¨å˜ä½'
    };

    // ã™ã¹ã¦ã®ã‚­ãƒ¼ã‚’åé›†
    const keySet = new Set();
    data.forEach(row=>{
      Object.keys(row||{}).forEach(k=>{
        if(!exclude.has(k)) keySet.add(k);
      });
    });

    // è¡¨ç¤ºé †ï¼šå„ªå…ˆåˆ— â†’ åœæ­¢æ™‚é–“(åˆ†ï¼šæ´¾ç”Ÿ) â†’ ãã®ä»–
    const keysAll = Array.from(keySet);
    const others = keysAll.filter(k => !basePreferred.includes(k));
    dataSheetColumns = [...basePreferred, 'stopMinutes', ...others];
    dataSheetColumnLabels = {...labels, stopMinutes:'åœæ­¢æ™‚é–“(åˆ†)'};

    // ãƒ˜ãƒƒãƒ€ãƒ¼ç”Ÿæˆï¼ˆâ–²ãƒœã‚¿ãƒ³ä»˜ãï¼‰
    const headRow = document.getElementById('dataSheetHeadRow');
    headRow.innerHTML = dataSheetColumns.map(k=>{
      return `<th>${(dataSheetColumnLabels[k]||k)} ${k==='(rank)'?'':`<button class="sort-btn" data-table="sheet" data-key="${k}">â–²</button>`}</th>`;
    }).join('');

    // åˆæœŸä¸¦ã³ä¿å­˜
    dataSheetOriginalOrder = null;
    dataSheetCurrentSortKey = null;
  }

  function renderDataSheet(data){
    const tbody = document.getElementById('dataSheetBody');
    if(data.length === 0){
      tbody.innerHTML = '<tr><td colspan="999" style="text-align:center;padding:40px;color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }
    // åˆå›ã®ã‚ªãƒªã‚¸ãƒŠãƒ«é †ä¿å­˜
    if(!dataSheetOriginalOrder) dataSheetOriginalOrder = data.map((_,i)=>i);

    // è¡Œæç”»
    const html = data.map(item=>{
      return `<tr>${dataSheetColumns.map(col=>{
        let val = '';
        if(col === 'stopMinutes'){
          const m = calcStopMinutes(item); val = (m===null||m===undefined)?'':m;
        }else{
          val = item[col];
          // é…åˆ—/ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯JSONã«
          if(Array.isArray(val)) val = val.join(' | ');
          else if(typeof val === 'object' && val !== null) val = JSON.stringify(val);
          val = (val===undefined||val===null)?'':String(val);
          if(col==='anomalyContent' || col==='actionTaken'){
            val = `<div style="max-width:380px;white-space:pre-wrap;">${escapeHTML(val)}</div>`;
          }
        }
        return `<td>${val || (col==='stopMinutes'?'': '-')}</td>`;
      }).join('')}</tr>`;
    }).join('');
    tbody.innerHTML = html;
  }

  // ã‚½ãƒ¼ãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆï¼šæ˜‡é †â†’è§£é™¤ï¼‰
  function sortDataSheetBy(key){
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const dept = document.getElementById('deptFilter').value;
    let data = allData.filter(x=> x.occurrenceDate && x.occurrenceDate >= startDate && x.occurrenceDate <= endDate);
    if(dept) data = data.filter(x=> x.department === dept);
const moldTechOnly = document.getElementById('moldTechOnly')?.checked;
if (moldTechOnly) data = data.filter(x => Number(x?.maintenanceUnit ?? 0) >= 1);

    if(dataSheetCurrentSortKey === key){
      // è§£é™¤ï¼ˆå…ƒã«æˆ»ã™ï¼‰
      dataSheetCurrentSortKey = null;
      // æœŸé–“é™é †ã®å…ƒæç”»ã«æˆ»ã™ï¼ˆåˆæœŸä»•æ§˜ã«åˆã‚ã›ã‚‹ï¼‰
      data.sort((a,b)=> (b.occurrenceDate||'').localeCompare(a.occurrenceDate||''));
      renderDataSheet(data);
      return;
    }
    dataSheetCurrentSortKey = key;

    const getter = (row)=>{
      if(key==='stopMinutes') return calcStopMinutes(row);
      const v = row[key];
      return (v===undefined||v===null)?'':v;
    };
    data.sort((a,b)=> compareAsc(getter(a), getter(b), key));
    renderDataSheet(data);
  }

  function compareAsc(a,b,key){
    // æ—¥ä»˜
    const dateLike = (v)=> typeof v==='string' && /^\d{4}-\d{2}-\d{2}$/.test(v);
    if(dateLike(a) && dateLike(b)) return a.localeCompare(b);
    // æ•°å€¤
    const na = parseFloat(a); const nb = parseFloat(b);
    if(!isNaN(na) && !isNaN(nb)) return na-nb;
    // æ™‚åˆ»ï¼ˆHH:MMï¼‰
    const timeLike = (v)=> typeof v==='string' && /^\d{1,2}:\d{2}$/.test(v);
    if(timeLike(a) && timeLike(b)){
      const [ah,am]=a.split(':').map(Number), [bh,bm]=b.split(':').map(Number);
      return (ah*60+am)-(bh*60+bm);
    }
    // æ–‡å­—åˆ—
    return String(a).localeCompare(String(b), 'ja');
  }

  /*========================
        Top10ãƒ†ãƒ¼ãƒ–ãƒ«
  ========================*/
  function renderTop10Table(data, lastMonthData){
    const serialNoCounts = {};
    const prevSerialNoCounts = {};
    const serialDepts = {};
    const serialStops = {};
    
    data.forEach(x=>{
      const no = x.serialNo || '(æœªè¨­å®š)';
      serialNoCounts[no] = (serialNoCounts[no]||0) + 1;
      if(!serialDepts[no]) serialDepts[no] = {};
      if(x.department) serialDepts[no][x.department] = (serialDepts[no][x.department]||0) + 1;
      const stop = calcStopMinutes(x);
      if(stop !== null){
        if(!serialStops[no]) serialStops[no] = [];
        serialStops[no].push(stop);
      }
    });
    lastMonthData.forEach(x=>{
      const no = x.serialNo || '(æœªè¨­å®š)';
      prevSerialNoCounts[no] = (prevSerialNoCounts[no]||0) + 1;
    });

    const top = Object.keys(serialNoCounts)
      .sort((a,b)=>serialNoCounts[b]-serialNoCounts[a])
      .slice(0,10);

    computedTop10Rows = top.map((no,idx)=>{
      const count = serialNoCounts[no];
      const prevCount = prevSerialNoCounts[no] || 0;
      const change = prevCount ? ((count - prevCount) / prevCount * 100) : 0;
      const depts = serialDepts[no]||{};
      const mainDept = Object.keys(depts).sort((a,b)=>(depts[b]||0)-(depts[a]||0))[0] || '-';
      const stops = serialStops[no] || [];
      const avgStopNum = stops.length ? (stops.reduce((a,b)=>a+b,0)/stops.length) : NaN;
      const avgStop = isNaN(avgStopNum) ? '-' : avgStopNum.toFixed(1);
      const trendRank = change > 20 ? 2 : change < -20 ? 0 : 1; // æ”¹å–„(0) æ¨ªã°ã„(1) æ€¥å¢—(2) ã®é †åºä»˜ã‘
      const trend = change > 20 ? 'ğŸ“ˆ æ€¥å¢—' : change < -20 ? 'ğŸ“‰ æ”¹å–„' : 'â†’ æ¨ªã°ã„';
      return {rank: idx+1, serialNo:no, count, change: Number.isFinite(change)? Math.round(change):0, mainDept, avgStop, avgStopNum: Number.isFinite(avgStopNum)?avgStopNum:NaN, trend, trendRank};
    });

    top10OriginalOrder = computedTop10Rows.map(r=>r); // ã‚·ãƒ£ãƒ­ãƒ¼ã‚³ãƒ”ãƒ¼

    drawTop10Rows(computedTop10Rows);
  }

  function drawTop10Rows(rows){
    const tbody = document.getElementById('top10Body');
    tbody.innerHTML = rows.map((r,idx)=>{
      let rankBadge;
      if(idx === 0) rankBadge = `<span class="rank-badge rank-1">1</span>`;
      else if(idx === 1) rankBadge = `<span class="rank-badge rank-2">2</span>`;
      else if(idx === 2) rankBadge = `<span class="rank-badge rank-3">3</span>`;
      else rankBadge = `<span class="rank-badge rank-other">${idx+1}</span>`;
      const changeColor = r.change>0?'#c62828':r.change<0?'#2e7d32':'#666';
      const changeArrow = r.change>0?'â–²':'â–¼';
      return `
        <tr>
          <td>${rankBadge}</td>
          <td><strong>${r.serialNo}</strong></td>
          <td><strong style="font-size:1.1rem;color:#667eea;">${r.count}</strong></td>
          <td><span style="color:${changeColor};">${changeArrow}${Math.abs(r.change)}%</span></td>
          <td>${r.mainDept}</td>
          <td>${r.avgStop}${r.avgStop!=='-'?' åˆ†':''}</td>
          <td>${r.trend}</td>
        </tr>
      `;
    }).join('');
  }

  // ã‚½ãƒ¼ãƒˆï¼ˆTop10ï¼šæ˜‡é †â†’è§£é™¤ï¼‰
  function sortTop10By(key){
    if(top10CurrentSortKey === key){
      top10CurrentSortKey = null;
      drawTop10Rows(top10OriginalOrder);
      return;
    }
    top10CurrentSortKey = key;
    const sorted = [...computedTop10Rows].sort((a,b)=> compareAsc(a[key], b[key], key));
    drawTop10Rows(sorted);
  }

  /*========================
         ã‚°ãƒ©ãƒ•é¡
  ========================*/
  function renderTrendChart(data){
    const ctx = document.getElementById('trendChart');
    if(charts.trend) charts.trend.destroy();
    const grouped = {}, details = {};
    data.forEach(x=>{
      if(!x.occurrenceDate) return;
      let key;
      if(currentPeriod === 'day'){
        key = x.occurrenceDate;
      }else if(currentPeriod === 'week'){
        const d = new Date(x.occurrenceDate);
        const week = Math.ceil((d.getDate() + new Date(d.getFullYear(), d.getMonth(), 1).getDay()) / 7);
        key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-W${week}`;
      }else{
        key = x.occurrenceDate.substring(0,7);
      }
      grouped[key] = (grouped[key]||0) + 1;
      if(!details[key]) details[key] = [];
      details[key].push({serialNo: x.serialNo || '(æœªè¨­å®š)', content: x.anomalyContent || ''});
    });
    const labels = Object.keys(grouped).sort();
    const values = labels.map(k=>grouped[k]);

    charts.trend = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label:'ç•°å¸¸ä»¶æ•°', data: values, borderColor:'#667eea', backgroundColor:'rgba(102,126,234,0.1)', tension:0.4, fill:true }] },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:true},
          tooltip:{ callbacks:{ afterBody: function(context){
            const key = context[0].label;
            const items = details[key] || [];
            if(items.length === 0) return '';
            const serialCounts = {};
            items.forEach(it=>{ serialCounts[it.serialNo] = (serialCounts[it.serialNo]||0)+1; });
            const top3 = Object.entries(serialCounts).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([no,c])=>`${no}: ${c}ä»¶`);
            return ['\nä¸»ãªæ•´ç†No:', ...top3];
          }}}
        },
        scales:{ y:{beginAtZero:true, ticks:{stepSize:1} } }
      }
    });
  }

  function renderDeptChart(data){
    const ctx = document.getElementById('deptChart');
    if(charts.dept) charts.dept.destroy();
    const grouped = {}, details = {};
    data.forEach(x=>{
      const dept = x.department || '(æœªè¨­å®š)';
      grouped[dept] = (grouped[dept]||0) + 1;
      if(!details[dept]) details[dept] = [];
      details[dept].push({serialNo: x.serialNo || '(æœªè¨­å®š)', content: x.anomalyContent || ''});
    });
    const labels = Object.keys(grouped).sort((a,b)=>grouped[b]-grouped[a]);
    const values = labels.map(k=>grouped[k]);

    charts.dept = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets:[{ label:'ä»¶æ•°', data: values, backgroundColor:['#667eea','#764ba2','#f093fb','#4facfe','#43e97b','#fa709a'] }] },
      options: {
        responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false},
          tooltip:{ callbacks:{ afterBody: function(context){
            const dept = context[0].label;
            const items = details[dept] || [];
            const serialCounts = {};
            items.forEach(it=>{ serialCounts[it.serialNo] = (serialCounts[it.serialNo]||0)+1; });
            const top3 = Object.entries(serialCounts).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([no,c])=>`${no}: ${c}ä»¶`);
            return ['\nTopæ•´ç†No:', ...top3];
          }}}
        },
        scales:{ y:{beginAtZero:true} }
      }
    });
  }

  function renderStopTimeChart(data){
    const ctx = document.getElementById('stopTimeChart');
    if(charts.stopTime) charts.stopTime.destroy();
    const bins = {'0-10åˆ†':0,'10-30åˆ†':0,'30-60åˆ†':0,'60åˆ†ä»¥ä¸Š':0,'æœªè¨˜éŒ²':0};
    data.forEach(x=>{
      const m = calcStopMinutes(x);
      if(m === null) bins['æœªè¨˜éŒ²']++;
      else if(m < 10) bins['0-10åˆ†']++;
      else if(m < 30) bins['10-30åˆ†']++;
      else if(m < 60) bins['30-60åˆ†']++;
      else bins['60åˆ†ä»¥ä¸Š']++;
    });
    charts.stopTime = new Chart(ctx, {
      type:'doughnut',
      data:{ labels:Object.keys(bins), datasets:[{ data:Object.values(bins), backgroundColor:['#4caf50','#ff9800','#f44336','#9c27b0','#e0e0e0'] }] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{position:'bottom'} } }
    });
  }

  /*========================
     æ•´ç†Noè©³ç´° / ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
  ========================*/
  function updateSerialNoSelect(data){
    const select = document.getElementById('serialNoSelect');
    const serialNos = [...new Set(data.map(x=>x.serialNo || '(æœªè¨­å®š)'))].sort();
    select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    serialNos.forEach(no=>{
      const opt = document.createElement('option');
      opt.value = opt.textContent = no;
      select.appendChild(opt);
    });
  }

  function showSerialNoDetail(){
    const no = document.getElementById('serialNoSelect').value;
    const detail = document.getElementById('serialNoDetail');
    if(!no){ detail.style.display='none'; return; }
    detail.style.display='block';
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    let filtered = allData.filter(x=> (x.serialNo||'(æœªè¨­å®š)')===no && x.occurrenceDate && x.occurrenceDate >= startDate && x.occurrenceDate <= endDate);

    // æ¨ç§»ãƒãƒ£ãƒ¼ãƒˆ
    const ctx = document.getElementById('serialNoTrendChart');
    if(charts.serialTrend) charts.serialTrend.destroy();
    const grouped = {};
    filtered.forEach(x=>{
      let key;
      if(currentPeriod==='day'){ key = x.occurrenceDate; }
      else if(currentPeriod==='week'){
        const d = new Date(x.occurrenceDate);
        const week = Math.ceil((d.getDate() + new Date(d.getFullYear(), d.getMonth(), 1).getDay()) / 7);
        key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-W${week}`;
      }else{
        key = x.occurrenceDate.substring(0,7);
      }
      grouped[key] = (grouped[key]||0)+1;
    });
    const labels = Object.keys(grouped).sort();
    const values = labels.map(k=>grouped[k]);
    charts.serialTrend = new Chart(ctx, {
      type:'bar',
      data:{ labels, datasets:[{ label:'ä»¶æ•°', data:values, backgroundColor:'#f093fb' }] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} }, scales:{ y:{beginAtZero:true} } }
    });

    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º
    const keywords = {};
    filtered.forEach(x=>{
      const text = (x.anomalyContent||'') + ' ' + (x.actionTaken||'');
      const words = text.split(/[\sã€ã€‚ã€\n]/).filter(w=>w.length>=2 && w.length<=20);
      words.forEach(w=>{ keywords[w] = (keywords[w]||0)+1; });
    });
    const topKeywords = Object.keys(keywords).sort((a,b)=>keywords[b]-keywords[a]).slice(0,20);
    const cloud = document.getElementById('keywordCloud');
    cloud.innerHTML = topKeywords.map(w=>`
      <span style="padding:6px 12px;background:#f0f7ff;color:#667eea;border-radius:16px;font-size:${0.85 + Math.min(keywords[w]/10, 0.4)}rem;font-weight:600;">
        ${escapeHTML(w)} (${keywords[w]})
      </span>
    `).join('');
  }

  /*========================
            KPI / ã‚¢ãƒ©ãƒ¼ãƒˆ
  ========================*/
  function renderKPIs(data, lastMonthData){
    const total = data.length;
    const prevTotal = lastMonthData.length;
    const change = prevTotal ? ((total - prevTotal) / prevTotal * 100).toFixed(1) : 0;

    const techRequests = data.filter(x=> x.techRequest === 'è¦è«‹').length;
    const prevTechRequests = lastMonthData.filter(x=> x.techRequest === 'è¦è«‹').length;
    const techChange = prevTechRequests ? ((techRequests - prevTechRequests) / prevTechRequests * 100).toFixed(1) : 0;

    const avgStop = data.map(x=>calcStopMinutes(x)).filter(x=>x!==null);
    const avgStopTime = avgStop.length ? (avgStop.reduce((a,b)=>a+b,0) / avgStop.length).toFixed(1) : 0;
    const prevAvgStop = lastMonthData.map(x=>calcStopMinutes(x)).filter(x=>x!==null);
    const prevAvgStopTime = prevAvgStop.length ? (prevAvgStop.reduce((a,b)=>a+b,0) / prevAvgStop.length).toFixed(1) : 0;
    const stopChange = prevAvgStopTime ? ((avgStopTime - prevAvgStopTime) / prevAvgStopTime * 100).toFixed(1) : 0;

    const serialNos = [...new Set(data.map(x=>x.serialNo || '(æœªè¨­å®š)'))];
    const prevSerialNos = [...new Set(lastMonthData.map(x=>x.serialNo || '(æœªè¨­å®š)'))];
    const serialChange = prevSerialNos.length ? ((serialNos.length - prevSerialNos.length) / prevSerialNos.length * 100).toFixed(1) : 0;

    const completeRate = total ? (data.filter(x=>x.status==='complete').length / total * 100).toFixed(1) : 0;
    const prevCompleteRate = prevTotal ? (lastMonthData.filter(x=>x.status==='complete').length / prevTotal * 100).toFixed(1) : 0;
    const completeChange = prevCompleteRate ? (completeRate - prevCompleteRate).toFixed(1) : 0;

    const html = `
      <div class="kpi-card blue">
        <div class="kpi-label">ç·ç•°å¸¸ä»¶æ•°</div>
        <div class="kpi-value">${total}</div>
        <div class="kpi-change ${change > 0 ? 'up' : change < 0 ? 'down' : 'neutral'}">
          ${change > 0 ? 'â–²' : change < 0 ? 'â–¼' : 'â†’'} ${Math.abs(change)}% å…ˆæœˆæ¯”
        </div>
      </div>
      <div class="kpi-card red">
        <div class="kpi-label">æŠ€è¡“è¦è«‹ä»¶æ•°</div>
        <div class="kpi-value">${techRequests}</div>
        <div class="kpi-change ${techChange > 0 ? 'up' : techChange < 0 ? 'down' : 'neutral'}">
          ${techChange > 0 ? 'â–²' : techChange < 0 ? 'â–¼' : 'â†’'} ${Math.abs(techChange)}% å…ˆæœˆæ¯”
        </div>
      </div>
      <div class="kpi-card orange">
        <div class="kpi-label">å¹³å‡åœæ­¢æ™‚é–“</div>
        <div class="kpi-value">${avgStopTime}<span style="font-size:1rem;color:#666;margin-left:5px;">åˆ†</span></div>
        <div class="kpi-change ${stopChange > 0 ? 'up' : stopChange < 0 ? 'down' : 'neutral'}">
          ${stopChange > 0 ? 'â–²' : stopChange < 0 ? 'â–¼' : 'â†’'} ${Math.abs(stopChange)}% å…ˆæœˆæ¯”
        </div>
      </div>
      <div class="kpi-card purple">
        <div class="kpi-label">ç•°å¸¸å“ç•ªæ•°</div>
        <div class="kpi-value">${serialNos.length}</div>
        <div class="kpi-change ${serialChange > 0 ? 'up' : serialChange < 0 ? 'down' : 'neutral'}">
          ${serialChange > 0 ? 'â–²' : serialChange < 0 ? 'â–¼' : 'â†’'} ${Math.abs(serialChange)}% å…ˆæœˆæ¯”
        </div>
      </div>
      <div class="kpi-card green">
        <div class="kpi-label">å®Œäº†ç‡</div>
        <div class="kpi-value">${completeRate}<span style="font-size:1rem;color:#666;margin-left:5px;">%</span></div>
        <div class="kpi-change ${completeChange > 0 ? 'down' : completeChange < 0 ? 'up' : 'neutral'}">
          ${completeChange > 0 ? 'â–²' : completeChange < 0 ? 'â–¼' : 'â†’'} ${Math.abs(completeChange)}% å…ˆæœˆæ¯”
        </div>
      </div>
    `;
    document.getElementById('kpiGrid').innerHTML = html;
  }

  function renderAlerts(data, lastMonthData){
    const alerts = [];
    const serialNoCounts = {};
    const prevSerialNoCounts = {};
    data.forEach(x=>{
      const no = x.serialNo || '(æœªè¨­å®š)';
      serialNoCounts[no] = (serialNoCounts[no]||0) + 1;
    });
    lastMonthData.forEach(x=>{
      const no = x.serialNo || '(æœªè¨­å®š)';
      prevSerialNoCounts[no] = (prevSerialNoCounts[no]||0) + 1;
    });

    Object.keys(serialNoCounts).forEach(no=>{
      const curr = serialNoCounts[no];
      const prev = prevSerialNoCounts[no] || 0;
      if(prev > 0 && curr >= prev * 2 && curr >= 3){
        alerts.push({ type:'danger', icon:'ğŸ”´', title:`æ€¥å¢—è­¦å‘Š: æ•´ç†No ${no}`, desc:`å…ˆæœˆ${prev}ä»¶ â†’ ä»ŠæœŸ${curr}ä»¶ï¼ˆ${((curr-prev)/prev*100).toFixed(0)}%å¢—ï¼‰` });
      }
    });
    Object.keys(prevSerialNoCounts).forEach(no=>{
      const prev = prevSerialNoCounts[no];
      const curr = serialNoCounts[no] || 0;
      if(prev >= 5 && curr <= prev * 0.5){
        alerts.push({ type:'success', icon:'ğŸŸ¢', title:`æ”¹å–„æ¤œçŸ¥: æ•´ç†No ${no}`, desc:`å…ˆæœˆ${prev}ä»¶ â†’ ä»ŠæœŸ${curr}ä»¶ï¼ˆ${((prev-curr)/prev*100).toFixed(0)}%æ¸›ï¼‰` });
      }
    });
    Object.keys(serialNoCounts).forEach(no=>{
      if(serialNoCounts[no] >= 10){
        alerts.push({ type:'warning', icon:'ğŸŸ¡', title:`é«˜é »åº¦æ³¨æ„: æ•´ç†No ${no}`, desc:`ä»ŠæœŸ${serialNoCounts[no]}ä»¶ã®ç•°å¸¸ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™` });
      }
    });

    const container = document.getElementById('alertContainer');
    const list = document.getElementById('alertList');
    if(alerts.length === 0){ container.style.display='none'; }
    else{
      container.style.display='block';
      list.innerHTML = alerts.map(a=>`
        <div class="alert-item alert-${a.type}">
          <div class="alert-icon">${a.icon}</div>
          <div class="alert-content">
            <div class="alert-title">${a.title}</div>
            <div class="alert-desc">${a.desc}</div>
          </div>
        </div>
      `).join('');
    }
  }

  /*========================
           CSV å‡ºåŠ›
  ========================*/
  function exportCSV(){
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const dept = document.getElementById('deptFilter').value;
    let data = allData.filter(x=> x.occurrenceDate && x.occurrenceDate >= startDate && x.occurrenceDate <= endDate);
    if(dept) data = data.filter(x=> x.department === dept);
    if(data.length === 0){ alert('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

    // ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã¨åŒã˜åˆ—é †ãƒ»ãƒ©ãƒ™ãƒ«ã§å‡ºåŠ›ï¼ˆstatusé™¤å¤–ï¼‰
    const headers = dataSheetColumns.map(k => dataSheetColumnLabels[k] || k);
    const rows = data.map(item=>{
      return dataSheetColumns.map(col=>{
        if(col==='stopMinutes'){
          const m = calcStopMinutes(item); return (m===null||m===undefined)?'':m;
        }else{
          let v = item[col];
          if(Array.isArray(v)) v = v.join(' | ');
          else if(typeof v === 'object' && v !== null) v = JSON.stringify(v);
          return (v===undefined||v===null)?'':String(v);
        }
      });
    });

    let csv = '\uFEFF' + headers.join(',') + '\n';
    rows.forEach(r=>{ csv += r.map(c=>`"${(c??'').toString().replace(/"/g,'""')}"`).join(',')+'\n'; });
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `ç•°å¸¸å±¥æ­´_${startDate}_${endDate}.csv`;
    a.click();
  }

  /*========================
           ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  ========================*/
  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }
</script>
</body>
</html>
