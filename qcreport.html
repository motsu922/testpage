<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>客先不具合管理</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.5;
    }

    /* ヘッダー */
    header {
      background: #2c3e50;
      color: white;
      padding: 0.75rem 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    header h1 {
      font-size: 1.2rem;
      font-weight: 600;
    }

    nav {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    nav button {
      background: none;
      border: none;
      color: white;
      padding: 0.4rem 0.8rem;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.85rem;
      transition: background 0.2s;
      white-space: nowrap;
    }

    nav button:hover {
      background: rgba(255,255,255,0.1);
    }

    nav button.active {
      background: rgba(255,255,255,0.2);
    }

    /* メインコンテンツ */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem;
    }

    /* ページ切り替え */
    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    /* カード */
    .card {
      background: white;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* ボタン */
    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
    }

    .btn-secondary {
      background: #95a5a6;
      color: white;
    }

    .btn-secondary:hover {
      background: #7f8c8d;
    }

    .btn-small {
      padding: 0.3rem 0.6rem;
      font-size: 0.8rem;
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    /* グリッド */
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
    }

    /* フォーム */
    input, textarea, select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
      font-family: inherit;
    }

    label {
      display: block;
      margin-bottom: 0.3rem;
      font-size: 0.85rem;
      font-weight: 600;
      color: #555;
    }

    .form-group {
      margin-bottom: 0.75rem;
    }

    /* モーダル */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      margin: 2rem;
    }

    .modal-header {
      padding: 1rem;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-body {
      padding: 1rem;
    }

    .modal-footer {
      padding: 1rem;
      border-top: 1px solid #eee;
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
    }

    /* テーブル */
    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin: 0 -1rem;
      padding: 0 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      min-width: 600px;
    }

    th, td {
      padding: 0.5rem;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #555;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    tr:hover {
      background: #f8f9fa;
    }

    /* タブ */
    .tabs {
      display: flex;
      gap: 0.5rem;
      border-bottom: 2px solid #eee;
      margin-bottom: 1rem;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none; /* Firefox */
    }

    .tabs::-webkit-scrollbar {
      display: none; /* Chrome, Safari */
    }

    .tab {
      padding: 0.5rem 1rem;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 0.9rem;
      color: #666;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .tab:hover {
      color: #3498db;
    }

    .tab.active {
      color: #3498db;
      border-bottom-color: #3498db;
      font-weight: 600;
    }

    /* バッジ */
    .badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 3px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-success {
      background: #d4edda;
      color: #155724;
    }

    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }

    /* アラート */
    .alert {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: 0.75rem 1rem;
      background: #2c3e50;
      color: white;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 2000;
      animation: slideIn 0.3s;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
      }
      to {
        transform: translateX(0);
      }
    }

    /* ユーティリティ */
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .text-right {
      text-align: right;
    }

    .text-center {
      text-align: center;
    }

    .mb-1 {
      margin-bottom: 1rem;
    }

    /* レスポンシブ */
    @media (max-width: 768px) {
      /* 基本レイアウト */
      .container {
        padding: 0.5rem;
      }

      .card {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
      }

      /* ヘッダー */
      header {
        padding: 0.5rem;
      }

      header h1 {
        font-size: 1rem;
      }

      nav {
        flex-wrap: wrap;
        gap: 0.25rem;
      }

      nav button {
        font-size: 0.75rem;
        padding: 0.4rem 0.6rem;
      }

      /* グリッド */
      .grid-2, .grid-3 {
        grid-template-columns: 1fr;
      }

      /* ボタン */
      .btn {
        padding: 0.6rem 0.8rem;
        font-size: 0.85rem;
        min-height: 44px;
      }

      .btn-small {
        padding: 0.5rem 0.7rem;
        font-size: 0.8rem;
        min-height: 40px;
      }

      /* フォーム */
      input, textarea, select {
        font-size: 16px; /* iOS zoom防止 */
        padding: 0.6rem;
      }

      label {
        font-size: 0.85rem;
        margin-bottom: 0.3rem;
      }

      /* モーダル */
      .modal-content {
        width: 95%;
        max-width: 95vw;
        max-height: 90vh;
        margin: 0.5rem auto;
      }

      .modal-header h3 {
        font-size: 1rem;
      }

      .modal-body {
        padding: 0.75rem;
        max-height: calc(90vh - 120px);
        overflow-y: auto;
      }

      .modal-footer {
        padding: 0.75rem;
        position: sticky;
        bottom: 0;
        background: white;
        border-top: 1px solid #eee;
      }

      /* テーブル */
      table {
        font-size: 0.75rem;
      }

      th, td {
        padding: 0.4rem 0.25rem;
      }

      /* タブ */
      .tab {
        font-size: 0.85rem;
        padding: 0.5rem 0.7rem;
        min-height: 44px;
      }

      /* タイトル */
      h2 {
        font-size: 1.1rem !important;
      }

      h3 {
        font-size: 0.95rem !important;
      }

      /* 案件情報カードのボタン配置 */
      .card .flex-between > div:last-child {
        width: 100%;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.3rem;
      }

      .card .flex-between > div:last-child button {
        width: 100%;
        white-space: nowrap;
      }

      .card .flex-between > div:last-child button:first-child {
        grid-column: 1 / -1;
      }

      /* 在庫場所コンテンツ */
      #locationContent > div:first-child > div:first-child {
        flex-direction: column !important;
        align-items: stretch !important;
      }

      #locationContent > div:first-child > div:first-child > div:first-child {
        width: 100% !important;
        margin-bottom: 0.5rem;
      }

      #locationContent > div:first-child > div:first-child > div:last-child {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.3rem;
      }

      #locationContent > div:first-child > div:first-child > div:last-child button {
        font-size: 0.75rem;
        padding: 0.5rem 0.3rem;
        white-space: nowrap;
      }

      #locationContent > div:first-child > div:first-child > div:last-child button:first-child {
        grid-column: 1 / -1;
      }

      /* テーブルスクロール対応 */
      .table-wrapper {
        margin: 0;
        padding: 0;
      }

      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }

      thead, tbody {
        display: table;
        width: 100%;
      }

      tr {
        display: table-row;
      }

      /* 進捗カード */
      #stepsProgress .card {
        padding: 0.5rem;
      }

      #stepsProgress .card > div:first-child {
        font-size: 0.7rem;
      }

      #stepsProgress .card > div:last-child {
        font-size: 1.2rem;
      }

      /* 連絡事項 */
      #whiteboardText {
        min-height: 150px !important;
        font-size: 16px !important;
        padding: 0.6rem !important;
      }

      #whiteboardPhotosList {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)) !important;
      }

      #whiteboardPhotosList img {
        height: 100px !important;
      }

      /* バッジ */
      .badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
      }

      /* アラート */
      .alert {
        font-size: 0.85rem;
        padding: 0.7rem 0.9rem;
        top: 0.5rem;
        right: 0.5rem;
        left: 0.5rem;
        max-width: calc(100% - 1rem);
      }

      /* ダッシュボードカード */
      #incompleteSteps > div,
      #incompleteInspections > div {
        padding: 0.75rem;
        font-size: 0.85rem;
      }

      /* ダッシュボード - 未完了ステップのチェックボックス */
      #incompleteSteps input[type="checkbox"] {
        width: 18px;
        height: 18px;
        flex-shrink: 0;
      }

      /* ダッシュボード - 選別未完了のボタン配置 */
      #incompleteInspections > div > div:last-child {
        display: grid !important;
        grid-template-columns: auto 1fr auto;
        gap: 0.3rem;
        width: 100%;
      }

      #incompleteInspections label {
        grid-column: 1;
      }

      #incompleteInspections > div > div:last-child > button:first-of-type {
        grid-column: 2;
      }

      #incompleteInspections > div > div:last-child > button:last-of-type {
        grid-column: 3;
      }

      /* 案件一覧カード */
      #casesList .card,
      #dashCasesList > div {
        padding: 0.6rem;
      }

      #casesList .flex-between,
      #dashCasesList .flex-between {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      #casesList .flex-between > div,
      #dashCasesList .flex-between > div {
        width: 100%;
      }

      /* タブコンテンツのマージン調整 */
      .tab-content {
        margin-top: 0.5rem !important;
      }

      /* 写真プレビュー */
      #inspectionPhotoPreview img,
      #casePhotoPreview img {
        width: 70px !important;
        height: 70px !important;
      }

      /* ステップテンプレートリスト */
      #stepTemplateList .card {
        padding: 0.6rem;
      }

      #stepTemplateList .flex-between {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      #stepTemplateList button {
        width: 100%;
      }

      /* ステップリスト */
      #stepsList > div {
        padding: 0.6rem !important;
      }

      #stepsList .flex-between {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 0.5rem;
      }

      #stepsList button {
        width: 100%;
      }

      /* タッチ操作しやすく */
      button, a, .tab {
        min-height: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      input[type="checkbox"] {
        min-width: 20px;
        min-height: 20px;
      }

      /* モーダル内のボタン */
      .modal-footer button {
        flex: 1;
        min-width: 100px;
      }

      /* フォームグループのマージン */
      .form-group {
        margin-bottom: 0.75rem;
      }

      /* 案件詳細の戻るボタン */
      #caseDetailPage > .container > button {
        width: 100%;
        margin-bottom: 0.75rem;
        justify-content: center;
      }
    }

    /* 極小画面（iPhone SE等） */
    @media (max-width: 375px) {
      .container {
        padding: 0.25rem;
      }

      .card {
        padding: 0.5rem;
      }

      header h1 {
        font-size: 0.9rem;
      }

      nav button {
        font-size: 0.7rem;
        padding: 0.3rem 0.5rem;
      }

      table {
        font-size: 0.7rem;
      }

      th, td {
        padding: 0.3rem 0.15rem;
      }

      .btn {
        font-size: 0.8rem;
        padding: 0.5rem 0.6rem;
      }

      .btn-small {
        font-size: 0.75rem;
        padding: 0.4rem 0.5rem;
      }
    }
  </style>
</head>
<body>
  <!-- ログイン画面 -->
  <div id="loginPage" class="page active">
    <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
      <div class="card" style="max-width: 400px; width: 90%; padding: 2rem;">
        <h2 style="text-align: center; margin-bottom: 1.5rem;">客先不具合管理</h2>
        <form id="loginForm">
          <div class="form-group">
            <label>メールアドレス</label>
            <input type="email" id="loginEmail" required>
          </div>
          <div class="form-group">
            <label>パスワード</label>
            <input type="password" id="loginPassword" required>
          </div>
          <button type="submit" class="btn btn-primary" style="width: 100%;">ログイン</button>
        </form>
      </div>
    </div>
  </div>

  <!-- メインアプリ -->
  <div id="mainApp" class="page">
    <header>
      <div class="header-content">
        <h1>客先不具合管理</h1>
        <nav>
          <button onclick="showPage('dashboardPage')" class="active">ダッシュボード</button>
          <button onclick="showPage('casesPage')">過去の案件</button>
          <button onclick="showModal('personMasterModal')">👤 担当者</button>
          <button onclick="logout()">ログアウト</button>
        </nav>
      </div>
    </header>

    <!-- ダッシュボードページ -->
    <div id="dashboardPage" class="page active">
      <div class="container">
        <div class="flex-between mb-1">
          <h2 style="font-size: 1.3rem;">ダッシュボード</h2>
          <div style="display: flex; gap: 0.5rem;">
            <button onclick="showModal('newCaseModal')" class="btn btn-primary">+ 新規案件</button>
            <button onclick="showModal('stepTemplateModal')" class="btn btn-secondary btn-small">ステップテンプレート管理</button>
            <button onclick="exportSummaryReport()" class="btn btn-secondary btn-small">📊 集計レポート出力</button>
          </div>
        </div>
        
        <!-- 未完了項目リスト -->
        <div class="grid-2 mb-1" style="align-items: start;">
          <!-- 未完了ステップ -->
          <div class="card">
            <h3 style="font-size: 1.1rem; margin-bottom: 0.75rem; color: #e74c3c;">⚠️ 未完了ステップ</h3>
            <div id="incompleteSteps"></div>
          </div>

          <!-- 未完了選別 -->
          <div class="card">
            <h3 style="font-size: 1.1rem; margin-bottom: 0.75rem; color: #f39c12;">📋 選別未完了</h3>
            <div id="incompleteInspections"></div>
          </div>
        </div>

        <!-- 案件一覧 -->
        <div class="card">
          <h3 style="margin-bottom: 0.75rem; font-size: 1.1rem;">対応中の案件</h3>
          <div id="dashCasesList"></div>
        </div>
      </div>
    </div>

    <!-- 案件一覧ページ（過去の案件） -->
    <div id="casesPage" class="page">
      <div class="container">
        <div class="flex-between mb-1">
          <h2 style="font-size: 1.3rem;">過去の案件</h2>
          <div style="display: flex; gap: 0.5rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
              <input type="checkbox" id="showCompletedCases" onchange="loadCases()" style="width: auto;">
              完了案件も表示
            </label>
          </div>
        </div>
        <div id="casesList"></div>
      </div>
    </div>

    <!-- 案件詳細ページ -->
    <div id="caseDetailPage" class="page">
      <div class="container">
        <button onclick="showPage('dashboardPage')" class="btn btn-secondary btn-small mb-1">← 戻る</button>
        
        <!-- 2カラムレイアウト -->
        <div class="grid-2" style="align-items: start;">
          <!-- 左: 案件情報 + 連絡事項 -->
          <div>
            <!-- 案件情報 -->
            <div class="card mb-1">
              <div class="flex-between mb-1">
                <h3 style="font-size: 1.1rem;">案件情報</h3>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                  <button onclick="openEmailModal()" class="btn btn-primary btn-small" style="background: #e67e22;">📧 メール</button>
                  <button onclick="showModal('addLocationModal')" class="btn btn-primary btn-small">+ 在庫場所</button>
                  <button onclick="toggleCaseStatus()" id="caseStatusBtn" class="btn btn-small">完了にする</button>
                  <button onclick="openEditCaseModal()" class="btn btn-secondary btn-small">編集</button>
                </div>
              </div>
              <div id="caseInfo"></div>
            </div>

            <!-- 連絡事項（旧ホワイトボード） -->
            <div class="card">
              <div class="flex-between mb-1">
                <h3 style="font-size: 1.1rem;">📢 連絡事項</h3>
                <button onclick="saveWhiteboard()" class="btn btn-primary btn-small">保存</button>
              </div>
              
              <textarea id="whiteboardText" 
                        style="width: 100%; min-height: 200px; padding: 0.75rem; border: 2px solid #ddd; border-radius: 6px; font-family: inherit; font-size: 0.9rem; margin-bottom: 0.75rem;"
                        placeholder="連絡事項や重要なメモを記入してください...

例:
- 対策会議の決定事項
- 顧客からの要望・指摘
- 次回確認事項
- 注意点・申し送り事項"></textarea>
              
              <div style="margin-bottom: 0.75rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 600;">📎 添付写真・資料</label>
                <input type="file" id="whiteboardPhotos" accept="image/*" multiple style="margin-bottom: 0.5rem; font-size: 0.85rem;">
                <button onclick="uploadWhiteboardPhotos()" class="btn btn-secondary btn-small">写真をアップロード</button>
              </div>
              
              <div id="whiteboardPhotosList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.75rem;"></div>
            </div>
          </div>

          <!-- 右: ステップ進捗と対応状況 -->
          <div>
            <div class="card mb-1">
              <h3 style="font-size: 1.1rem; margin-bottom: 0.75rem;">進捗状況</h3>
              <div id="stepsProgress"></div>
            </div>
            
            <!-- 対応状況カード -->
            <div class="card">
              <div class="flex-between mb-1">
                <h3 style="font-size: 1.1rem;">誰が何を対応中？</h3>
                <button onclick="showModal('addAssignmentModal')" class="btn btn-primary btn-small">+ 対応追加</button>
              </div>
              <div id="assignmentsList"></div>
            </div>
          </div>
        </div>

        <!-- メインタブエリア -->
        <div class="card">
          <div class="tabs" style="border-bottom: 2px solid #eee;">
            <button class="tab active" onclick="switchMainTab('inspection')">選別実績</button>
            <button class="tab" onclick="switchMainTab('steps')">ステップ管理</button>
          </div>

          <!-- 選別実績タブ -->
          <div id="inspectionTab" class="tab-content" style="display: block;">
            <div style="margin-top: 1rem;">
              <h3 style="font-size: 1.1rem; margin-bottom: 0.75rem;">選別実績</h3>
            </div>
            
            <div class="tabs" id="locationTabs"></div>
            <div id="locationContent"></div>
          </div>

          <!-- ステップ管理タブ -->
          <div id="stepsTab" class="tab-content" style="display: none; margin-top: 1rem;">
            <div class="flex-between mb-1">
              <h3 style="font-size: 1.1rem;">対応ステップ</h3>
              <button onclick="addStep()" class="btn btn-primary btn-small">+ ステップ追加</button>
            </div>
            <div id="stepsList"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 新規案件モーダル -->
  <div id="newCaseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>新規案件登録</h3>
        <button onclick="hideModal('newCaseModal')" class="btn btn-secondary btn-small">✕</button>
      </div>
      <form id="newCaseForm">
        <div class="modal-body">
          <div class="form-group">
            <label>案件名 *</label>
            <input type="text" id="caseName" required>
          </div>
          <div class="form-group">
            <label>得意先名 *</label>
            <input type="text" id="customerName" required>
          </div>
          <div class="form-group">
            <label>発生日 *</label>
            <input type="date" id="occurredDate" required>
          </div>
          <div class="form-group">
            <label>不具合内容</label>
            <textarea id="description" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label>対象整理No（複数可、Enterで追加）</label>
            <input type="text" id="serialNumberInput" placeholder="例: A-001">
            <div id="serialNumbersList" style="display: flex; flex-wrap: wrap; gap: 0.3rem; margin-top: 0.5rem;"></div>
          </div>
          <div class="form-group">
            <label>写真（複数選択可）</label>
            <input type="file" id="casePhotos" accept="image/*" multiple>
            <div id="casePhotoPreview" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;"></div>
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="useStepTemplate" style="width: auto; margin-right: 0.5rem;">
              基本ステップテンプレートを使用
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" onclick="hideModal('newCaseModal')" class="btn btn-secondary">キャンセル</button>
          <button type="submit" class="btn btn-primary">登録</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ステップテンプレート管理モーダル -->
  <div id="stepTemplateModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ステップテンプレート管理</h3>
        <button onclick="hideModal('stepTemplateModal')" class="btn btn-secondary btn-small">✕</button>
      </div>
      <div class="modal-body">
        <div class="mb-1">
          <h4 style="font-size: 1rem; margin-bottom: 0.5rem;">基本ステップ</h4>
          <div id="stepTemplateList"></div>
        </div>
        <div style="border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1rem;">
          <h4 style="font-size: 1rem; margin-bottom: 0.5rem;">新しいステップを追加</h4>
          <div class="form-group">
            <label>ステップ名</label>
            <input type="text" id="newStepTitle" placeholder="例: 原因調査">
          </div>
          <div class="form-group">
            <label>説明（任意）</label>
            <input type="text" id="newStepDescription" placeholder="例: 不具合の原因を特定する">
          </div>
          <button onclick="addStepToTemplate()" class="btn btn-primary btn-small">追加</button>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="hideModal('stepTemplateModal')" class="btn btn-secondary">閉じる</button>
      </div>
    </div>
  </div>

  <!-- 案件編集モーダル -->
  <div id="editCaseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>案件情報編集</h3>
        <button onclick="hideModal('editCaseModal')" class="btn btn-secondary btn-small">✕</button>
      </div>
      <form id="editCaseForm">
        <div class="modal-body">
          <div class="form-group">
            <label>案件名 *</label>
            <input type="text" id="editCaseName" required>
          </div>
          <div class="form-group">
            <label>得意先名 *</label>
            <input type="text" id="editCustomerName" required>
          </div>
          <div class="form-group">
            <label>発生日</label>
            <input type="date" id="editOccurredDate">
          </div>
          <div class="form-group">
            <label>不具合内容</label>
            <textarea id="editDescription" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label>対象整理No（カンマ区切り）</label>
            <input type="text" id="editTargetSerialNumbers" placeholder="例: A-001, A-002, A-003">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" onclick="hideModal('editCaseModal')" class="btn btn-secondary">キャンセル</button>
          <button type="submit" class="btn btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 在庫場所追加モーダル -->
  <div id="addLocationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>在庫場所追加</h3>
        <button onclick="hideModal('addLocationModal')" class="btn btn-secondary btn-small">✕</button>
      </div>
      <form id="addLocationForm">
        <div class="modal-body">
          <div class="form-group">
            <label>在庫場所 *</label>
            <input type="text" id="locationName" required placeholder="例: 倉庫A">
          </div>
          <div class="form-group">
            <label>かんばん</label>
            <input type="text" id="locationKanban" placeholder="例: K-12345">
          </div>
          <div class="form-group">
            <label>担当者</label>
            <input type="text" id="locationContact">
          </div>
          <div class="form-group">
            <label>メモ</label>
            <textarea id="locationMemo" rows="3" placeholder="例: 工程情報、注意事項など"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" onclick="hideModal('addLocationModal')" class="btn btn-secondary">キャンセル</button>
          <button type="submit" class="btn btn-primary">追加</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 在庫場所編集モーダル -->
  <div id="editLocationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>在庫場所編集</h3>
        <button onclick="hideModal('editLocationModal')" class="btn btn-secondary btn-small">✕</button>
      </div>
      <form id="editLocationForm">
        <div class="modal-body">
          <input type="hidden" id="editLocationIndex">
          <div class="form-group">
            <label>在庫場所 *</label>
            <input type="text" id="editLocationName" required placeholder="例: 倉庫A">
          </div>
          <div class="form-group">
            <label>かんばん</label>
            <input type="text" id="editLocationKanban" placeholder="例: K-12345">
          </div>
          <div class="form-group">
            <label>担当者</label>
            <input type="text" id="editLocationContact">
          </div>
          <div class="form-group">
            <label>メモ</label>
            <textarea id="editLocationMemo" rows="3" placeholder="例: 工程情報、注意事項など"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" onclick="hideModal('editLocationModal')" class="btn btn-secondary">キャンセル</button>
          <button type="submit" class="btn btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>

  <!-- メール送信モーダル -->
  <div id="emailModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h3>📧 不具合発生メール送信</h3>
        <button onclick="hideModal('emailModal')" class="btn btn-secondary btn-small">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>件名</label>
          <input type="text" id="emailSubject" readonly style="background: #f5f5f5;">
        </div>
        <div class="form-group">
          <label>本文プレビュー</label>
          <textarea id="emailBody" rows="20" readonly style="background: #f5f5f5; font-family: monospace; font-size: 0.85rem;"></textarea>
        </div>
        <div style="padding: 0.75rem; background: #fff3cd; border-radius: 4px; margin-top: 1rem;">
          <strong>📌 使い方:</strong><br>
          1. 下の「メールアプリで開く」をクリック<br>
          2. メールアプリが起動します<br>
          3. 宛先を追加して送信してください
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" onclick="hideModal('emailModal')" class="btn btn-secondary">閉じる</button>
        <button type="button" onclick="sendEmail()" class="btn btn-primary" style="background: #e67e22;">📧 メールアプリで開く</button>
      </div>
    </div>
  </div>

  <!-- 対応追加モーダル -->
  <div id="addAssignmentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>対応追加</h3>
        <button onclick="hideModal('addAssignmentModal')" class="btn btn-secondary btn-small">✕</button>
      </div>
      <form id="addAssignmentForm">
        <div class="modal-body">
          <div class="form-group">
            <label>担当者 *</label>
            <select id="assignmentPerson" required>
              <option value="">選択してください</option>
            </select>
            <button type="button" onclick="showModal('personMasterModal')" class="btn btn-secondary btn-small" style="margin-top: 0.5rem;">👤 担当者マスター管理</button>
          </div>
          <div class="form-group">
            <label>対応内容 *</label>
            <select id="assignmentTask" required>
              <option value="">選択してください</option>
              <option value="客先対応">客先対応</option>
              <option value="社内選別">社内選別</option>
              <option value="社外選別">社外選別</option>
              <option value="選別業者手配">選別業者手配</option>
            </select>
          </div>
          <div class="form-group">
            <label>備考</label>
            <textarea id="assignmentNote" rows="2" placeholder="例: 〇〇まで完了予定"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" onclick="hideModal('addAssignmentModal')" class="btn btn-secondary">キャンセル</button>
          <button type="submit" class="btn btn-primary">追加</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 担当者マスター管理モーダル -->
  <div id="personMasterModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>👤 担当者マスター管理</h3>
        <button onclick="hideModal('personMasterModal')" class="btn btn-secondary btn-small">✕</button>
      </div>
      <div class="modal-body">
        <!-- 担当者追加 -->
        <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f5f5f5; border-radius: 6px;">
          <h4 style="font-size: 0.95rem; margin-bottom: 0.75rem;">新規担当者追加</h4>
          <form id="addPersonForm" style="display: flex; gap: 0.5rem; align-items: end;">
            <div style="flex: 1;">
              <input type="text" id="newPersonName" placeholder="担当者名" required style="width: 100%;">
            </div>
            <button type="submit" class="btn btn-primary btn-small">追加</button>
          </form>
        </div>
        
        <!-- 担当者一覧 -->
        <div>
          <h4 style="font-size: 0.95rem; margin-bottom: 0.75rem;">登録済み担当者</h4>
          <div id="personMasterList"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" onclick="hideModal('personMasterModal')" class="btn btn-primary">閉じる</button>
      </div>
    </div>
  </div>

  <!-- 選別実績追加モーダル -->
  <div id="addInspectionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>選別実績追加</h3>
        <button onclick="hideModal('addInspectionModal')" class="btn btn-secondary btn-small">✕</button>
      </div>
      <form id="addInspectionForm">
        <div class="modal-body">
          <input type="hidden" id="inspectionLocationIndex">
          
          <div class="grid-2">
            <div class="form-group">
              <label>開始時刻</label>
              <input type="datetime-local" id="inspectionStartTime">
            </div>
            <div class="form-group">
              <label>完了時刻</label>
              <input type="datetime-local" id="inspectionEndTime">
            </div>
          </div>

          <div class="form-group">
            <label>かんばん（便）</label>
            <input type="text" id="inspectionKanban">
          </div>

          <div class="form-group">
            <label>選別した整理No（複数選択可）</label>
            <div id="inspectionSerialNumbers" style="max-height: 120px; overflow-y: auto; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;"></div>
          </div>

          <div class="grid-2">
            <div class="form-group">
              <label>選別数 *</label>
              <input type="number" id="inspectionCount" required min="0">
            </div>
            <div class="form-group">
              <label>NG数 *</label>
              <input type="number" id="inspectionNgCount" required min="0">
            </div>
          </div>

          <div class="form-group">
            <label>責任者</label>
            <input type="text" id="inspectionSupervisor">
          </div>

          <div class="form-group">
            <label>写真（複数選択可）</label>
            <input type="file" id="inspectionPhotos" accept="image/*" multiple>
            <div id="inspectionPhotoPreview" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" onclick="hideModal('addInspectionModal')" class="btn btn-secondary">キャンセル</button>
          <button type="submit" class="btn btn-primary">追加</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <script>
    // Firebase設定
    const firebaseConfig = {
      apiKey: "AIzaSyCr2A0kYdlJsCKnJhGXwEDViu2Ae08yKJc",
      authDomain: "qckyouyu.firebaseapp.com",
      projectId: "qckyouyu",
      storageBucket: "qckyouyu.firebasestorage.app",
      messagingSenderId: "884065987840",
      appId: "1:884065987840:web:2b12cc1204e484b999d7e5"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    let currentUser = null;
    let currentCaseId = null;
    let currentCaseData = null;
    let allCases = [];
    let serialNumbers = [];
    let selectedLocationIndex = 0;
    let stepTemplate = [];
    let personMaster = []; // 担当者マスター


    // 写真プレビュー
    document.addEventListener('DOMContentLoaded', () => {
      // 選別実績写真プレビュー
      const photoInput = document.getElementById('inspectionPhotos');
      if (photoInput) {
        photoInput.addEventListener('change', (e) => {
          const preview = document.getElementById('inspectionPhotoPreview');
          preview.innerHTML = '';
          
          Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
              const img = document.createElement('img');
              img.src = e.target.result;
              img.style.width = '80px';
              img.style.height = '80px';
              img.style.objectFit = 'cover';
              img.style.borderRadius = '4px';
              img.style.border = '2px solid #ddd';
              preview.appendChild(img);
            };
            reader.readAsDataURL(file);
          });
        });
      }

      // 案件写真プレビュー
      const casePhotoInput = document.getElementById('casePhotos');
      if (casePhotoInput) {
        casePhotoInput.addEventListener('change', (e) => {
          const preview = document.getElementById('casePhotoPreview');
          preview.innerHTML = '';
          
          Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
              const img = document.createElement('img');
              img.src = e.target.result;
              img.style.width = '80px';
              img.style.height = '80px';
              img.style.objectFit = 'cover';
              img.style.borderRadius = '4px';
              img.style.border = '2px solid #ddd';
              preview.appendChild(img);
            };
            reader.readAsDataURL(file);
          });
        });
      }

      // ステップテンプレート読み込み
      loadStepTemplate();
    });

    // 写真アップロード関数
    async function uploadPhotos(files, path) {
      const urls = [];
      
      for (const file of files) {
        const storageRef = storage.ref(`${path}/${Date.now()}_${file.name}`);
        await storageRef.put(file);
        const url = await storageRef.getDownloadURL();
        urls.push({ url, name: file.name, uploadedAt: new Date() });
      }
      
      return urls;
    }

    // 認証状態の監視
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        document.getElementById('loginPage').classList.remove('active');
        document.getElementById('mainApp').classList.add('active');
        loadPersonMaster(); // 担当者マスターを読み込み
        loadDashboard(); // ダッシュボードを最初に読み込み
      } else {
        currentUser = null;
        document.getElementById('loginPage').classList.add('active');
        document.getElementById('mainApp').classList.remove('active');
      }
    });

    // ログイン
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (error) {
        alert('ログインに失敗しました: ' + error.message);
      }
    });

    // ログアウト
    function logout() {
      auth.signOut();
    }

    // メインタブ切り替え
    function switchMainTab(tabName) {
      // タブボタンのアクティブ状態
      document.querySelectorAll('#caseDetailPage .tabs .tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      // タブコンテンツの表示切り替え
      document.getElementById('inspectionTab').style.display = tabName === 'inspection' ? 'block' : 'none';
      document.getElementById('stepsTab').style.display = tabName === 'steps' ? 'block' : 'none';
      
      // ステップタブを開いたときにステップをロード
      if (tabName === 'steps') {
        loadSteps();
      }
    }

    // ページ切り替え
    function showPage(pageId) {
      document.querySelectorAll('#mainApp .page').forEach(p => p.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
      
      // ナビゲーションボタンのアクティブ状態を更新
      if (pageId === 'casesPage' || pageId === 'dashboardPage') {
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        const buttons = document.querySelectorAll('nav button');
        if (pageId === 'dashboardPage' && buttons[0]) buttons[0].classList.add('active');
        if (pageId === 'casesPage' && buttons[1]) buttons[1].classList.add('active');
      }
      
      if (pageId === 'casesPage') loadCases();
      if (pageId === 'dashboardPage') loadDashboard();
    }

    // モーダル表示/非表示
    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.add('active');
      } else {
        console.error('Modal not found:', modalId);
      }
    }

    function hideModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('active');
      }
    }

    // アラート表示
    function showAlert(message) {
      const alert = document.createElement('div');
      alert.className = 'alert';
      alert.textContent = message;
      document.body.appendChild(alert);
      setTimeout(() => alert.remove(), 3000);
    }

    // 整理No管理
    document.getElementById('serialNumberInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addSerialNumber();
      }
    });

    function addSerialNumber() {
      const input = document.getElementById('serialNumberInput');
      const value = input.value.trim();
      
      if (value && !serialNumbers.includes(value)) {
        serialNumbers.push(value);
        input.value = '';
        displaySerialNumbers();
      }
    }

    function displaySerialNumbers() {
      const list = document.getElementById('serialNumbersList');
      list.innerHTML = serialNumbers.map(sn => `
        <span class="badge badge-success" style="cursor: pointer;" onclick="removeSerialNumber('${sn}')">
          ${sn} ✕
        </span>
      `).join('');
    }

    function removeSerialNumber(sn) {
      serialNumbers = serialNumbers.filter(s => s !== sn);
      displaySerialNumbers();
    }

    // 新規案件登録
    document.getElementById('newCaseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      try {
        // 写真アップロード
        const photoFiles = document.getElementById('casePhotos').files;
        let photoUrls = [];
        
        if (photoFiles.length > 0) {
          showAlert('写真をアップロード中...');
          photoUrls = await uploadPhotos(Array.from(photoFiles), `cases/${Date.now()}`);
        }

        // ステップテンプレート適用
        let steps = [];
        if (document.getElementById('useStepTemplate').checked) {
          steps = stepTemplate.map(step => ({
            ...step,
            completed: false,
            createdAt: new Date()
          }));
        }
        
        await db.collection('cases').add({
          caseName: document.getElementById('caseName').value,
          customerName: document.getElementById('customerName').value,
          occurredDate: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('occurredDate').value)),
          description: document.getElementById('description').value,
          targetSerialNumbers: serialNumbers,
          photos: photoUrls,
          steps: steps,
          status: 'inProgress',
          inventoryLocations: [],
          createdBy: currentUser.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showAlert('案件を登録しました');
        hideModal('newCaseModal');
        document.getElementById('newCaseForm').reset();
        document.getElementById('casePhotoPreview').innerHTML = '';
        serialNumbers = [];
        displaySerialNumbers();
        loadCases();
      } catch (error) {
        alert('登録エラー: ' + error.message);
      }
    });

    // 案件一覧読み込み（過去の案件）
    async function loadCases() {
      try {
        const showCompleted = document.getElementById('showCompletedCases').checked;
        
        let query = db.collection('cases').orderBy('updatedAt', 'desc');
        
        if (!showCompleted) {
          query = query.where('status', '==', 'inProgress');
        }
        
        const snapshot = await query.get();
        
        allCases = [];
        snapshot.forEach(doc => {
          allCases.push({ id: doc.id, ...doc.data() });
        });
        
        displayCases();
      } catch (error) {
        console.error('読み込みエラー:', error);
      }
    }

    // 案件一覧表示
    function displayCases() {
      const list = document.getElementById('casesList');
      
      if (allCases.length === 0) {
        list.innerHTML = '<div class="card text-center" style="color: #999;">案件がありません</div>';
        return;
      }
      
      list.innerHTML = allCases.map(c => {
        let totalCount = 0;
        let totalNG = 0;
        
        (c.inventoryLocations || []).forEach(loc => {
          (loc.inspectionResults || []).forEach(r => {
            totalCount += r.count || 0;
            totalNG += r.ngCount || 0;
          });
        });
        
        const ngRate = totalCount > 0 ? ((totalNG / totalCount) * 100).toFixed(2) : '0.00';
        const statusBadge = c.status === 'completed' 
          ? '<span class="badge badge-success">完了</span>' 
          : '<span class="badge badge-warning">対応中</span>';
        
        return `
          <div class="card" style="cursor: pointer; ${c.status === 'completed' ? 'opacity: 0.7;' : ''}" onclick="openCase('${c.id}')">
            <div class="flex-between">
              <div>
                <h3 style="font-size: 1rem; margin-bottom: 0.3rem;">${c.caseName} ${statusBadge}</h3>
                <div style="font-size: 0.8rem; color: #666;">
                  ${c.customerName} | 
                  ${c.occurredDate ? new Date(c.occurredDate.seconds * 1000).toLocaleDateString('ja-JP') : ''}
                </div>
              </div>
              <div class="text-right">
                <div style="font-size: 0.8rem; color: #666;">選別数: <strong>${totalCount.toLocaleString()}</strong></div>
                <div style="font-size: 0.8rem; color: #666;">NG率: <strong style="color: ${parseFloat(ngRate) > 1 ? '#e74c3c' : '#27ae60'};">${ngRate}%</strong></div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // 案件詳細を開く
    async function openCase(caseId) {
      currentCaseId = caseId;
      
      try {
        const doc = await db.collection('cases').doc(caseId).get();
        currentCaseData = { id: doc.id, ...doc.data() };
        
        displayCaseDetail();
        showPage('caseDetailPage');
      } catch (error) {
        alert('読み込みエラー: ' + error.message);
      }
    }

    // 案件詳細表示
    function displayCaseDetail() {
      // 完了ボタンの表示を更新
      const statusBtn = document.getElementById('caseStatusBtn');
      if (statusBtn) {
        if (currentCaseData.status === 'completed') {
          statusBtn.textContent = '未完了に戻す';
          statusBtn.className = 'btn btn-secondary btn-small';
        } else {
          statusBtn.textContent = '完了にする';
          statusBtn.className = 'btn btn-primary btn-small';
        }
      }

      // 案件情報
      const statusBadge = currentCaseData.status === 'completed' 
        ? '<span class="badge badge-success" style="font-size: 0.9rem;">✓ 完了</span>' 
        : '<span class="badge badge-warning" style="font-size: 0.9rem;">対応中</span>';
      
      const info = `
        <div style="display: grid; gap: 0.5rem; font-size: 0.85rem;">
          <div><strong>案件名:</strong> ${currentCaseData.caseName} ${statusBadge}</div>
          <div><strong>得意先:</strong> ${currentCaseData.customerName}</div>
          <div><strong>発生日:</strong> ${currentCaseData.occurredDate ? new Date(currentCaseData.occurredDate.seconds * 1000).toLocaleDateString('ja-JP') : ''}</div>
          ${currentCaseData.description ? `<div style="margin-top: 0.5rem; padding: 0.5rem; background: #fff3cd; border-radius: 4px;"><strong>内容:</strong> ${currentCaseData.description}</div>` : ''}
          ${currentCaseData.targetSerialNumbers && currentCaseData.targetSerialNumbers.length > 0 ? `
            <div style="margin-top: 0.5rem;">
              <strong>整理No:</strong>
              ${currentCaseData.targetSerialNumbers.map(sn => `<span class="badge badge-success">${sn}</span>`).join(' ')}
            </div>
          ` : ''}
        </div>
      `;
      document.getElementById('caseInfo').innerHTML = info;
      
      // 進捗状況（簡易版）
      const locations = currentCaseData.inventoryLocations || [];
      let totalCount = 0;
      let totalNG = 0;
      
      locations.forEach(loc => {
        (loc.inspectionResults || []).forEach(r => {
          totalCount += r.count || 0;
          totalNG += r.ngCount || 0;
        });
      });
      
      const ngRate = totalCount > 0 ? ((totalNG / totalCount) * 100).toFixed(2) : '0.00';
      
      const progress = `
        <div style="display: grid; gap: 0.5rem;">
          <div class="card" style="background: #e8f5e9; padding: 0.5rem;">
            <div style="font-size: 0.75rem; color: #666;">選別数</div>
            <div style="font-size: 1.3rem; font-weight: bold; color: #2e7d32;">${totalCount.toLocaleString()}</div>
          </div>
          <div class="card" style="background: #ffebee; padding: 0.5rem;">
            <div style="font-size: 0.75rem; color: #666;">NG数</div>
            <div style="font-size: 1.3rem; font-weight: bold; color: #c62828;">${totalNG.toLocaleString()}</div>
          </div>
          <div class="card" style="background: #e3f2fd; padding: 0.5rem;">
            <div style="font-size: 0.75rem; color: #666;">NG率</div>
            <div style="font-size: 1.3rem; font-weight: bold; color: #1565c0;">${ngRate}%</div>
          </div>
        </div>
      `;
      document.getElementById('stepsProgress').innerHTML = progress;
      
      // 在庫場所タブ
      displayLocationTabs();
      
      // 連絡事項（旧ホワイトボード）をロード - 常に表示されるため最初に読み込む
      loadWhiteboard();
      
      // ステップをロード
      loadSteps();
      
      // 対応状況を表示
      displayAssignments();
    }

    // 在庫場所タブ表示
    function displayLocationTabs() {
      const locations = currentCaseData.inventoryLocations || [];
      const tabs = document.getElementById('locationTabs');
      
      if (locations.length === 0) {
        tabs.innerHTML = '';
        document.getElementById('locationContent').innerHTML = '<div class="text-center" style="color: #999; padding: 2rem;">在庫場所が登録されていません</div>';
        return;
      }
      
      tabs.innerHTML = locations.map((loc, i) => `
        <button class="tab ${i === selectedLocationIndex ? 'active' : ''}" onclick="selectLocation(${i})">
          ${loc.location}
        </button>
      `).join('');
      
      displayLocationContent();
    }

    // 在庫場所選択
    function selectLocation(index) {
      selectedLocationIndex = index;
      displayLocationTabs();
    }

    // 在庫場所コンテンツ表示
    function displayLocationContent() {
      const location = currentCaseData.inventoryLocations[selectedLocationIndex];
      const results = location.inspectionResults || [];
      const isCompleted = location.completed || false;
      
      let html = `
        <div style="margin-bottom: 0.75rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: ${isCompleted ? '#e8f5e9' : '#f8f9fa'}; border-radius: 4px;">
            <div style="font-size: 0.85rem;">
              ${location.kanban ? `かんばん: <strong>${location.kanban}</strong> | ` : ''}
              ${location.customerContact ? `担当: <strong>${location.customerContact}</strong> | ` : ''}
              実績: <strong>${results.length}件</strong>
              ${isCompleted ? ' | <span style="color: #2e7d32; font-weight: bold;">✓ 完了</span>' : ''}
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button onclick="toggleLocationStatus()" class="btn ${isCompleted ? 'btn-secondary' : 'btn-primary'} btn-small">
                ${isCompleted ? '未完了に戻す' : '完了にする'}
              </button>
              <button onclick="openEditLocation()" class="btn btn-secondary btn-small">編集</button>
              <button onclick="openAddInspection()" class="btn btn-primary btn-small">+ 実績追加</button>
            </div>
          </div>
          ${location.memo ? `
            <div style="margin-top: 0.5rem; padding: 0.5rem; background: #fffbf0; border-left: 3px solid #ffc107; border-radius: 4px; font-size: 0.85rem;">
              <strong>📝 メモ:</strong> ${location.memo}
            </div>
          ` : ''}
        </div>
      `;
      
      if (results.length > 0) {
        html += `
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th style="min-width: 40px;">No</th>
                  <th style="min-width: 100px;">整理No</th>
                  <th style="min-width: 100px;">時刻</th>
                  <th style="min-width: 80px;">かんばん</th>
                  <th class="text-right" style="min-width: 70px;">選別数</th>
                  <th class="text-right" style="min-width: 60px;">NG数</th>
                  <th class="text-right" style="min-width: 70px;">NG率</th>
                  <th style="min-width: 80px;">責任者</th>
                  <th style="min-width: 60px;">写真</th>
                  <th class="text-center" style="min-width: 60px;">操作</th>
                </tr>
              </thead>
              <tbody>
                ${results.map((r, i) => {
                  const ngRate = r.count > 0 ? ((r.ngCount / r.count) * 100).toFixed(2) : '0.00';
                  const time = r.startTime && r.endTime ? 
                    `${formatTime(r.startTime)}-${formatTime(r.endTime)}` :
                    r.startTime ? formatTime(r.startTime) : '-';
                  
                  return `
                    <tr>
                      <td>#${i + 1}</td>
                      <td>${(r.serialNumbers || []).map(sn => `<span class="badge badge-success">${sn}</span>`).join(' ') || '-'}</td>
                      <td style="white-space: nowrap;">${time}</td>
                      <td>${r.kanban || '-'}</td>
                      <td class="text-right"><strong>${r.count.toLocaleString()}</strong></td>
                      <td class="text-right"><strong style="color: #e74c3c;">${r.ngCount.toLocaleString()}</strong></td>
                      <td class="text-right"><strong style="color: ${parseFloat(ngRate) > 1 ? '#e74c3c' : '#27ae60'};">${ngRate}%</strong></td>
                      <td>${r.supervisor || '-'}</td>
                      <td>
                        ${r.photos && r.photos.length > 0 ? `
                          <button onclick="showPhotos(${selectedLocationIndex}, ${i})" class="btn btn-secondary btn-small" style="padding: 0.3rem 0.5rem;">📷 ${r.photos.length}</button>
                        ` : '-'}
                      </td>
                      <td class="text-center">
                        <button onclick="deleteInspection(${i})" class="btn btn-danger btn-small" style="padding: 0.3rem 0.5rem; font-size: 0.75rem;">削除</button>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
      } else {
        html += '<div class="text-center" style="color: #999; padding: 2rem;">実績がありません</div>';
      }
      
      document.getElementById('locationContent').innerHTML = html;
    }

    // 在庫場所追加
    document.getElementById('addLocationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const newLocation = {
        location: document.getElementById('locationName').value,
        kanban: document.getElementById('locationKanban').value || '',
        customerContact: document.getElementById('locationContact').value || '',
        memo: document.getElementById('locationMemo').value || '',
        inspectionResults: []
      };
      
      const locations = [...(currentCaseData.inventoryLocations || [])];
      locations.push(newLocation);
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          inventoryLocations: locations,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.inventoryLocations = locations;
        selectedLocationIndex = locations.length - 1;
        
        showAlert('在庫場所を追加しました');
        hideModal('addLocationModal');
        document.getElementById('addLocationForm').reset();
        displayLocationTabs();
      } catch (error) {
        alert('エラー: ' + error.message);
      }
    });

    // 実績追加モーダルを開く
    function openAddInspection() {
      document.getElementById('inspectionLocationIndex').value = selectedLocationIndex;
      
      // 整理Noチェックボックス
      const serialNos = currentCaseData.targetSerialNumbers || [];
      const container = document.getElementById('inspectionSerialNumbers');
      
      if (serialNos.length === 0) {
        container.innerHTML = '<div style="color: #999; font-size: 0.85rem;">整理Noが登録されていません</div>';
      } else {
        container.innerHTML = serialNos.map(sn => `
          <label style="display: block; padding: 0.3rem; cursor: pointer;">
            <input type="checkbox" name="inspectionSerialNo" value="${sn}" style="width: auto; margin-right: 0.5rem;">
            ${sn}
          </label>
        `).join('');
      }
      
      // かんばん情報をプリフィル
      const location = currentCaseData.inventoryLocations[selectedLocationIndex];
      if (location.kanban) {
        document.getElementById('inspectionKanban').value = location.kanban;
      }
      
      showModal('addInspectionModal');
    }

    // 実績追加
    document.getElementById('addInspectionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const locationIndex = parseInt(document.getElementById('inspectionLocationIndex').value);
      const selectedSerialNos = Array.from(document.querySelectorAll('input[name="inspectionSerialNo"]:checked'))
        .map(cb => cb.value);
      
      try {
        // 写真アップロード
        const photoFiles = document.getElementById('inspectionPhotos').files;
        let photoUrls = [];
        
        if (photoFiles.length > 0) {
          showAlert('写真をアップロード中...');
          photoUrls = await uploadPhotos(Array.from(photoFiles), `inspections/${currentCaseId}/${Date.now()}`);
        }
        
        const newResult = {
          startTime: document.getElementById('inspectionStartTime').value ? 
            firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('inspectionStartTime').value)) : null,
          endTime: document.getElementById('inspectionEndTime').value ?
            firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('inspectionEndTime').value)) : null,
          kanban: document.getElementById('inspectionKanban').value || '',
          serialNumbers: selectedSerialNos,
          count: parseInt(document.getElementById('inspectionCount').value),
          ngCount: parseInt(document.getElementById('inspectionNgCount').value),
          supervisor: document.getElementById('inspectionSupervisor').value || '',
          photos: photoUrls,
          createdBy: currentUser.uid,
          createdAt: firebase.firestore.Timestamp.now()
        };
        
        const locations = [...currentCaseData.inventoryLocations];
        locations[locationIndex].inspectionResults.push(newResult);
        
        await db.collection('cases').doc(currentCaseId).update({
          inventoryLocations: locations,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.inventoryLocations = locations;
        
        showAlert('実績を追加しました');
        hideModal('addInspectionModal');
        document.getElementById('addInspectionForm').reset();
        document.getElementById('inspectionPhotoPreview').innerHTML = '';
        
        // 案件詳細ページが表示されていれば更新
        if (document.getElementById('caseDetailPage').classList.contains('active')) {
          displayLocationContent();
        }
        
        // ダッシュボードが表示されていれば更新
        if (document.getElementById('dashboardPage').classList.contains('active')) {
          loadDashboard();
        }
      } catch (error) {
        alert('エラー: ' + error.message);
      }
    });

    // 実績削除
    async function deleteInspection(index) {
      if (!confirm('この実績を削除しますか?')) return;
      
      const locations = [...currentCaseData.inventoryLocations];
      locations[selectedLocationIndex].inspectionResults.splice(index, 1);
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          inventoryLocations: locations,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.inventoryLocations = locations;
        
        showAlert('実績を削除しました');
        displayLocationContent();
      } catch (error) {
        alert('エラー: ' + error.message);
      }
    }

    // 案件編集モーダルを開く
    function openEditCaseModal() {
      if (!currentCaseData) {
        alert('案件データが読み込まれていません');
        return;
      }

      document.getElementById('editCaseName').value = currentCaseData.caseName || '';
      document.getElementById('editCustomerName').value = currentCaseData.customerName || '';
      
      // 発生日
      if (currentCaseData.occurredDate && currentCaseData.occurredDate.seconds) {
        const date = new Date(currentCaseData.occurredDate.seconds * 1000);
        document.getElementById('editOccurredDate').value = date.toISOString().split('T')[0];
      } else {
        document.getElementById('editOccurredDate').value = '';
      }
      
      document.getElementById('editDescription').value = currentCaseData.description || '';
      document.getElementById('editTargetSerialNumbers').value = (currentCaseData.targetSerialNumbers || []).join(', ');
      
      showModal('editCaseModal');
    }

    // 案件編集フォーム送信
    document.getElementById('editCaseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!currentCaseId) {
        alert('案件IDが見つかりません');
        return;
      }

      const caseName = document.getElementById('editCaseName').value;
      const customerName = document.getElementById('editCustomerName').value;
      const occurredDateStr = document.getElementById('editOccurredDate').value;
      const description = document.getElementById('editDescription').value;
      const serialNumbers = document.getElementById('editTargetSerialNumbers').value
        .split(',')
        .map(s => s.trim())
        .filter(s => s);

      try {
        const updateData = {
          caseName: caseName,
          customerName: customerName,
          description: description,
          targetSerialNumbers: serialNumbers,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        if (occurredDateStr) {
          updateData.occurredDate = firebase.firestore.Timestamp.fromDate(new Date(occurredDateStr));
        }

        await db.collection('cases').doc(currentCaseId).update(updateData);

        // currentCaseDataを更新
        currentCaseData = {
          ...currentCaseData,
          ...updateData
        };

        showAlert('案件情報を更新しました');
        hideModal('editCaseModal');
        displayCaseDetail();
      } catch (error) {
        alert('エラー: ' + error.message);
      }
    });

    // 案件の完了/未完了切り替え
    async function toggleCaseStatus() {
      const newStatus = currentCaseData.status === 'completed' ? 'inProgress' : 'completed';
      const message = newStatus === 'completed' ? 'この案件を完了にしますか?' : 'この案件を未完了に戻しますか?';
      
      if (!confirm(message)) return;
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          status: newStatus,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.status = newStatus;
        showAlert(newStatus === 'completed' ? '案件を完了にしました' : '案件を未完了に戻しました');
        displayCaseDetail();
      } catch (error) {
        alert('エラー: ' + error.message);
      }
    }

    // 在庫場所の完了/未完了切り替え
    async function toggleLocationStatus() {
      const locations = [...currentCaseData.inventoryLocations];
      const currentStatus = locations[selectedLocationIndex].completed || false;
      const newStatus = !currentStatus;
      
      const message = newStatus ? 'この在庫場所の選別を完了にしますか?' : 'この在庫場所の選別を未完了に戻しますか?';
      
      if (!confirm(message)) return;
      
      locations[selectedLocationIndex].completed = newStatus;
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          inventoryLocations: locations,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.inventoryLocations = locations;
        showAlert(newStatus ? '選別を完了にしました' : '選別を未完了に戻しました');
        displayLocationContent();
      } catch (error) {
        alert('エラー: ' + error.message);
      }
    }

    // 在庫場所編集モーダルを開く
    function openEditLocation() {
      const location = currentCaseData.inventoryLocations[selectedLocationIndex];
      
      document.getElementById('editLocationIndex').value = selectedLocationIndex;
      document.getElementById('editLocationName').value = location.location || '';
      document.getElementById('editLocationKanban').value = location.kanban || '';
      document.getElementById('editLocationContact').value = location.customerContact || '';
      document.getElementById('editLocationMemo').value = location.memo || '';
      
      showModal('editLocationModal');
    }

    // 在庫場所編集
    document.getElementById('editLocationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const locationIndex = parseInt(document.getElementById('editLocationIndex').value);
      const locations = [...currentCaseData.inventoryLocations];
      
      locations[locationIndex].location = document.getElementById('editLocationName').value;
      locations[locationIndex].kanban = document.getElementById('editLocationKanban').value || '';
      locations[locationIndex].customerContact = document.getElementById('editLocationContact').value || '';
      locations[locationIndex].memo = document.getElementById('editLocationMemo').value || '';
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          inventoryLocations: locations,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.inventoryLocations = locations;
        
        showAlert('在庫場所を更新しました');
        hideModal('editLocationModal');
        displayLocationTabs();
      } catch (error) {
        alert('エラー: ' + error.message);
      }
    });

    // ダッシュボード
    async function loadDashboard() {
      try {
        const snapshot = await db.collection('cases')
          .where('status', '==', 'inProgress')
          .get();
        
        const incompleteStepsList = [];
        const incompleteInspectionsList = [];
        const cases = [];
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const caseId = doc.id;
          const caseName = data.caseName || '';
          
          // 未完了ステップをチェック
          const steps = data.steps || [];
          const incompleteSteps = steps.filter(step => !step.completed);
          if (incompleteSteps.length > 0) {
            incompleteStepsList.push({
              caseId: caseId,
              caseName: caseName,
              steps: incompleteSteps,
              allSteps: steps
            });
          }
          
          // 未完了選別をチェック
          const locations = data.inventoryLocations || [];
          locations.forEach(location => {
            if (!location.completed) {
              incompleteInspectionsList.push({
                caseId: caseId,
                caseName: caseName,
                location: location.location,
                contact: location.customerContact || ''
              });
            }
          });
          
          // 案件情報を収集
          let caseCount = 0;
          let caseNG = 0;
          
          locations.forEach(loc => {
            (loc.inspectionResults || []).forEach(r => {
              caseCount += r.count || 0;
              caseNG += r.ngCount || 0;
            });
          });
          
          cases.push({
            id: caseId,
            ...data,
            totalCount: caseCount,
            totalNG: caseNG
          });
        });
        
        // 未完了ステップ表示（チェックボックス付き）
        const stepsContainer = document.getElementById('incompleteSteps');
        if (incompleteStepsList.length === 0) {
          stepsContainer.innerHTML = '<div style="color: #27ae60; font-size: 0.9rem; padding: 1rem; text-align: center;">✓ すべてのステップが完了しています</div>';
        } else {
          stepsContainer.innerHTML = incompleteStepsList.map(item => {
            const stepsHtml = item.steps.map((step, stepIndex) => {
              // 全ステップの中での実際のインデックスを取得
              const actualIndex = item.allSteps.findIndex(s => s.title === step.title && s.description === step.description);
              return `
                <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px; display: flex; align-items: start; gap: 0.5rem;">
                  <input type="checkbox" 
                         onchange="toggleStepFromDashboard('${item.caseId}', ${actualIndex})"
                         style="margin-top: 0.3rem; cursor: pointer; width: 18px; height: 18px; flex-shrink: 0;">
                  <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 0.85rem;">${step.title}</div>
                    ${step.description ? `<div style="font-size: 0.75rem; color: #666; margin-top: 0.2rem;">${step.description}</div>` : ''}
                  </div>
                </div>
              `;
            }).join('');
            
            return `
              <div style="padding: 0.75rem; border-left: 3px solid #e74c3c; background: #fff5f5; margin-bottom: 0.75rem; border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                  <div style="font-weight: 600; font-size: 0.9rem;">${item.caseName}</div>
                  <button onclick="openCase('${item.caseId}')" class="btn btn-secondary btn-small" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;">詳細 →</button>
                </div>
                ${stepsHtml}
              </div>
            `;
          }).join('');
        }
        
        // 未完了選別表示
        const inspectionsContainer = document.getElementById('incompleteInspections');
        if (incompleteInspectionsList.length === 0) {
          inspectionsContainer.innerHTML = '<div style="color: #27ae60; font-size: 0.9rem; padding: 1rem; text-align: center;">✓ すべての選別が完了しています</div>';
        } else {
          inspectionsContainer.innerHTML = incompleteInspectionsList.map((item, idx) => `
            <div style="padding: 0.75rem; border-left: 3px solid #f39c12; background: #fffaf0; margin-bottom: 0.5rem; border-radius: 4px;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                <div style="flex: 1;">
                  <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.3rem;">案件: ${item.caseName}</div>
                  <div style="font-size: 0.85rem; color: #666;">
                    場所: ${item.location}${item.contact ? ` (担当者: ${item.contact})` : ''}
                  </div>
                </div>
              </div>
              <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                <label style="flex: 0 0 auto; display: flex; align-items: center; gap: 0.3rem; padding: 0.3rem 0.6rem; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                  <input type="checkbox" 
                         onchange="toggleLocationFromDashboard('${item.caseId}', '${item.location}')"
                         style="width: 16px; height: 16px; margin: 0; cursor: pointer;">
                  <span>完了</span>
                </label>
                <button onclick="openInspectionFromDashboard('${item.caseId}', '${item.location}')" 
                        class="btn btn-primary btn-small" 
                        style="flex: 1; min-width: 80px; font-size: 0.75rem; padding: 0.3rem 0.6rem;">+ 実績入力</button>
                <button onclick="openCase('${item.caseId}')" 
                        class="btn btn-secondary btn-small" 
                        style="flex: 0 0 auto; font-size: 0.75rem; padding: 0.3rem 0.6rem;">詳細</button>
              </div>
            </div>
          `).join('');
        }
        
        // 案件一覧
        const list = document.getElementById('dashCasesList');
        if (cases.length === 0) {
          list.innerHTML = '<div style="color: #999; font-size: 0.9rem; padding: 1rem; text-align: center;">対応中の案件はありません</div>';
        } else {
          list.innerHTML = cases.map(c => {
            const ngRate = c.totalCount > 0 ? ((c.totalNG / c.totalCount) * 100).toFixed(2) : '0.00';
            return `
              <div style="padding: 0.5rem; border-bottom: 1px solid #eee; cursor: pointer;" onclick="openCase('${c.id}')">
                <div class="flex-between">
                  <strong style="font-size: 0.9rem;">${c.caseName}</strong>
                  <span style="font-size: 0.85rem;">
                    選別: ${c.totalCount.toLocaleString()} | 
                    NG: ${c.totalNG.toLocaleString()} | 
                    率: <strong style="color: ${parseFloat(ngRate) > 1 ? '#e74c3c' : '#27ae60'};">${ngRate}%</strong>
                  </span>
                </div>
              </div>
            `;
          }).join('');
        }
      } catch (error) {
        console.error('エラー:', error);
      }
    }

    // ダッシュボードから在庫場所を完了
    async function toggleLocationFromDashboard(caseId, locationName) {
      try {
        const doc = await db.collection('cases').doc(caseId).get();
        if (!doc.exists) {
          alert('案件が見つかりません');
          return;
        }
        
        const caseData = doc.data();
        const locations = [...(caseData.inventoryLocations || [])];
        const locationIndex = locations.findIndex(loc => loc.location === locationName);
        
        if (locationIndex === -1) {
          alert('在庫場所が見つかりません');
          return;
        }
        
        // 在庫場所を完了にする
        locations[locationIndex].completed = true;
        
        await db.collection('cases').doc(caseId).update({
          inventoryLocations: locations,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showAlert('選別を完了にしました');
        
        // ダッシュボードを再読み込み
        loadDashboard();
      } catch (error) {
        alert('エラー: ' + error.message);
      }
    }

    // メール送信モーダルを開く
    function openEmailModal() {
      if (!currentCaseData) {
        alert('案件データが読み込まれていません');
        return;
      }
      
      // 選別実績を集計
      const locations = currentCaseData.inventoryLocations || [];
      let totalCount = 0;
      let totalNG = 0;
      let locationSummary = [];
      
      locations.forEach(loc => {
        let locCount = 0;
        let locNG = 0;
        (loc.inspectionResults || []).forEach(r => {
          locCount += r.count || 0;
          locNG += r.ngCount || 0;
        });
        if (locCount > 0) {
          totalCount += locCount;
          totalNG += locNG;
          const ngRate = locCount > 0 ? ((locNG / locCount) * 100).toFixed(2) : '0.00';
          locationSummary.push(`  ${loc.location}: 選別${locCount}個、NG${locNG}個（NG率${ngRate}%）`);
        }
      });
      
      const totalNgRate = totalCount > 0 ? ((totalNG / totalCount) * 100).toFixed(2) : '0.00';
      
      // 件名
      const subject = `【客先不具合発生】${currentCaseData.caseName} - ${currentCaseData.customerName}`;
      
      // 本文
      const body = `関係者各位

お疲れ様です。
客先不具合が発生しましたので、ご連絡いたします。

■ 不具合概要
案件名: ${currentCaseData.caseName}
得意先: ${currentCaseData.customerName}
発生日: ${currentCaseData.occurredDate ? new Date(currentCaseData.occurredDate.seconds * 1000).toLocaleDateString('ja-JP') : ''}
${currentCaseData.description ? `内容: ${currentCaseData.description}` : ''}

■ 対象整理No
${(currentCaseData.targetSerialNumbers || []).join(', ') || 'なし'}

■ 現時点での選別実績（${new Date().toLocaleDateString('ja-JP')} ${new Date().toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}時点）
総選別数: ${totalCount.toLocaleString()}個
総NG数: ${totalNG.toLocaleString()}個
NG率: ${totalNgRate}%

${locationSummary.length > 0 ? '【在庫場所別】\n' + locationSummary.join('\n') : '※まだ選別実績がありません'}

■ 対応依頼
つきましては、下記について対応をお願いいたします。

1. 原因調査
2. 暫定対策の検討・実施

進捗がありましたら、共有をお願いいたします。

よろしくお願いいたします。

---
このメールは客先不具合管理システムより送信されています。`;
      
      const subjectField = document.getElementById('emailSubject');
      const bodyField = document.getElementById('emailBody');
      
      if (subjectField && bodyField) {
        subjectField.value = subject;
        bodyField.value = body;
        showModal('emailModal');
      } else {
        console.error('Email fields not found');
        alert('メールフォームの初期化に失敗しました');
      }
    }

    // メール送信
    function sendEmail() {
      const subject = document.getElementById('emailSubject').value;
      const body = document.getElementById('emailBody').value;
      
      // mailto: リンクを生成
      const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      
      // メールアプリを開く
      window.location.href = mailtoLink;
      
      showAlert('メールアプリを起動しました');
    }

    // ========================================
    // 担当者マスターと対応状況管理
    // ========================================

    // 担当者マスターを読み込み（Firestore版 - ルール設定後に使用）
    async function loadPersonMaster() {
      try {
        const doc = await db.collection('settings').doc('personMaster').get();
        if (doc.exists) {
          personMaster = doc.data().persons || [];
        } else {
          personMaster = [];
        }
        updatePersonSelects();
        displayPersonMasterList();
      } catch (error) {
        console.error('担当者マスター読み込みエラー:', error);
        // エラー時はローカルストレージから読み込み
        const stored = localStorage.getItem('personMaster');
        if (stored) {
          personMaster = JSON.parse(stored);
          updatePersonSelects();
          displayPersonMasterList();
        }
      }
    }

    // 担当者選択肢を更新
    function updatePersonSelects() {
      const select = document.getElementById('assignmentPerson');
      if (!select) return;
      
      const currentValue = select.value;
      select.innerHTML = '<option value="">選択してください</option>';
      
      personMaster.forEach(person => {
        const option = document.createElement('option');
        option.value = person;
        option.textContent = person;
        select.appendChild(option);
      });
      
      if (currentValue) {
        select.value = currentValue;
      }
    }

    // 担当者マスター一覧を表示
    function displayPersonMasterList() {
      const list = document.getElementById('personMasterList');
      if (!list) return;
      
      if (personMaster.length === 0) {
        list.innerHTML = '<div style="color: #999; padding: 1rem; text-align: center;">担当者が登録されていません</div>';
        return;
      }
      
      list.innerHTML = personMaster.map((person, index) => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid #eee;">
          <span style="font-size: 0.9rem;">${person}</span>
          <button onclick="deletePerson(${index})" class="btn btn-secondary btn-small" style="background: #e74c3c;">削除</button>
        </div>
      `).join('');
    }

    // 担当者追加フォーム
    document.getElementById('addPersonForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const personName = document.getElementById('newPersonName').value.trim();
      if (!personName) return;
      
      if (personMaster.includes(personName)) {
        alert('既に登録されている担当者です');
        return;
      }
      
      personMaster.push(personName);
      
      try {
        await db.collection('settings').doc('personMaster').set({
          persons: personMaster,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // ローカルストレージにもバックアップ
        localStorage.setItem('personMaster', JSON.stringify(personMaster));
        
        document.getElementById('newPersonName').value = '';
        displayPersonMasterList();
        updatePersonSelects();
        showAlert('担当者を追加しました');
      } catch (error) {
        alert('エラー: ' + error.message + '\nFirestoreのルール設定を確認してください');
      }
    });

    // 担当者削除
    async function deletePerson(index) {
      if (!confirm('この担当者を削除しますか？')) return;
      
      personMaster.splice(index, 1);
      
      try {
        await db.collection('settings').doc('personMaster').set({
          persons: personMaster,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // ローカルストレージにもバックアップ
        localStorage.setItem('personMaster', JSON.stringify(personMaster));
        
        displayPersonMasterList();
        updatePersonSelects();
        showAlert('担当者を削除しました');
      } catch (error) {
        alert('エラー: ' + error.message + '\nFirestoreのルール設定を確認してください');
      }
    }

    // 対応状況を表示
    function displayAssignments() {
      const container = document.getElementById('assignmentsList');
      if (!container) return;
      
      const assignments = currentCaseData.assignments || [];
      
      if (assignments.length === 0) {
        container.innerHTML = '<div style="color: #999; padding: 1rem; text-align: center; font-size: 0.85rem;">対応中のタスクはありません</div>';
        return;
      }
      
      // タスク種別ごとの色設定
      const taskColors = {
        '客先対応': '#e74c3c',
        '社内選別': '#3498db',
        '社外選別': '#9b59b6',
        '選別業者手配': '#f39c12'
      };
      
      container.innerHTML = assignments.map((assignment, index) => {
        const color = taskColors[assignment.task] || '#95a5a6';
        return `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; margin-bottom: 0.5rem; background: ${color}15; border-left: 3px solid ${color}; border-radius: 4px;">
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.3rem; flex-wrap: wrap;">
                <span style="font-weight: 700; font-size: 1.1rem; color: #2c3e50;">👤 ${assignment.person}</span>
                <span style="font-weight: 600; font-size: 0.85rem; color: ${color}; background: ${color}25; padding: 0.2rem 0.6rem; border-radius: 12px;">● ${assignment.task}</span>
              </div>
              ${assignment.note ? `<div style="font-size: 0.8rem; color: #666; margin-left: 1.5rem;">${assignment.note}</div>` : ''}
            </div>
            <button onclick="deleteAssignment(${index})" class="btn btn-secondary btn-small" style="background: #e74c3c; font-size: 0.75rem; padding: 0.3rem 0.5rem;">削除</button>
          </div>
        `;
      }).join('');
    }

    // 対応追加フォーム
    document.getElementById('addAssignmentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const person = document.getElementById('assignmentPerson').value;
      const task = document.getElementById('assignmentTask').value;
      const note = document.getElementById('assignmentNote').value.trim();
      
      if (!person || !task) {
        alert('担当者と対応内容を選択してください');
        return;
      }
      
      const newAssignment = {
        person: person,
        task: task,
        note: note,
        createdAt: firebase.firestore.Timestamp.now(),
        createdBy: currentUser.email
      };
      
      const assignments = [...(currentCaseData.assignments || [])];
      assignments.push(newAssignment);
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          assignments: assignments,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.assignments = assignments;
        
        showAlert('対応を追加しました');
        hideModal('addAssignmentModal');
        document.getElementById('addAssignmentForm').reset();
        displayAssignments();
      } catch (error) {
        alert('エラー: ' + error.message);
      }
    });

    // 対応削除
    async function deleteAssignment(index) {
      if (!confirm('この対応を削除しますか？')) return;
      
      const assignments = [...(currentCaseData.assignments || [])];
      assignments.splice(index, 1);
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          assignments: assignments,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.assignments = assignments;
        
        showAlert('対応を削除しました');
        displayAssignments();
      } catch (error) {
        alert('エラー: ' + error.message);
      }
    }

    // ダッシュボードから実績入力を開く
    async function openInspectionFromDashboard(caseId, locationName) {
      try {
        // 案件データを読み込み
        const doc = await db.collection('cases').doc(caseId).get();
        if (!doc.exists) {
          alert('案件が見つかりません');
          return;
        }
        
        const caseData = doc.data();
        currentCaseId = caseId;
        currentCaseData = { id: caseId, ...caseData };
        
        // 在庫場所のインデックスを取得
        const locations = caseData.inventoryLocations || [];
        const locationIndex = locations.findIndex(loc => loc.location === locationName);
        
        if (locationIndex === -1) {
          alert('在庫場所が見つかりません');
          return;
        }
        
        selectedLocationIndex = locationIndex;
        
        // 実績追加モーダルを開く
        openAddInspection();
        
      } catch (error) {
        alert('エラー: ' + error.message);
      }
    }

    // ダッシュボードからステップを完了
    async function toggleStepFromDashboard(caseId, stepIndex) {
      try {
        const doc = await db.collection('cases').doc(caseId).get();
        if (!doc.exists) {
          alert('案件が見つかりません');
          return;
        }
        
        const caseData = doc.data();
        const steps = [...(caseData.steps || [])];
        
        if (!steps[stepIndex]) {
          alert('ステップが見つかりません');
          return;
        }
        
        // ステップを完了にする
        steps[stepIndex].completed = true;
        
        await db.collection('cases').doc(caseId).update({
          steps: steps,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showAlert('ステップを完了にしました');
        
        // ダッシュボードを再読み込み
        loadDashboard();
      } catch (error) {
        alert('エラー: ' + error.message);
      }
    }

    // ユーティリティ関数
    function formatTime(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp.seconds * 1000);
      return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
    }

    // ホワイトボード機能（連絡事項）
    function loadWhiteboard() {
      const whiteboard = currentCaseData.whiteboard || '';
      const photos = currentCaseData.whiteboardPhotos || [];
      
      document.getElementById('whiteboardText').value = whiteboard;
      
      // 写真一覧表示
      const photosList = document.getElementById('whiteboardPhotosList');
      photosList.innerHTML = photos.map((photo, i) => `
        <div style="position: relative;">
          <a href="${photo.url}" target="_blank">
            <img src="${photo.url}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 4px; border: 2px solid #ddd;">
          </a>
          <button onclick="deleteWhiteboardPhoto(${i})" 
                  style="position: absolute; top: 5px; right: 5px; background: #e74c3c; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; justify-content: center;">✕</button>
        </div>
      `).join('');
    }

    async function uploadWhiteboardPhotos() {
      const files = document.getElementById('whiteboardPhotos').files;
      if (files.length === 0) {
        alert('写真を選択してください');
        return;
      }
      
      try {
        showAlert('写真をアップロード中...');
        const newPhotos = await uploadPhotos(Array.from(files), `whiteboard/${currentCaseId}/${Date.now()}`);
        
        const photos = [...(currentCaseData.whiteboardPhotos || []), ...newPhotos];
        
        await db.collection('cases').doc(currentCaseId).update({
          whiteboardPhotos: photos,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.whiteboardPhotos = photos;
        document.getElementById('whiteboardPhotos').value = '';
        
        showAlert('写真をアップロードしました');
        loadWhiteboard();
      } catch (error) {
        alert('エラー: ' + error.message);
      }
    }

    async function deleteWhiteboardPhoto(index) {
      if (!confirm('この写真を削除しますか?')) return;
      
      const photos = [...currentCaseData.whiteboardPhotos];
      photos.splice(index, 1);
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          whiteboardPhotos: photos,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.whiteboardPhotos = photos;
        showAlert('写真を削除しました');
        loadWhiteboard();
      } catch (error) {
        alert('エラー: ' + error.message);
      }
    }

    async function saveWhiteboard() {
      const text = document.getElementById('whiteboardText').value;
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          whiteboard: text,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.whiteboard = text;
        showAlert('ホワイトボードを保存しました');
      } catch (error) {
        alert('エラー: ' + error.message);
      }
    }

    // ステップ管理機能
    function loadSteps() {
      const steps = currentCaseData.steps || [];
      const list = document.getElementById('stepsList');
      
      if (steps.length === 0) {
        list.innerHTML = '<div class="text-center" style="color: #999; padding: 2rem;">ステップがありません</div>';
        return;
      }
      
      list.innerHTML = steps.map((step, i) => `
        <div class="card" style="padding: 0.75rem; margin-bottom: 0.5rem; ${step.completed ? 'background: #e8f5e9;' : ''}">
          <div class="flex-between">
            <div style="flex: 1;">
              <input type="checkbox" ${step.completed ? 'checked' : ''} 
                     onchange="toggleStep(${i})" 
                     style="width: auto; margin-right: 0.5rem;">
              <span style="${step.completed ? 'text-decoration: line-through; color: #999;' : ''}">${step.title}</span>
            </div>
            <button onclick="deleteStep(${i})" class="btn btn-danger btn-small">削除</button>
          </div>
          ${step.description ? `<div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666; margin-left: 1.5rem;">${step.description}</div>` : ''}
        </div>
      `).join('');
    }

    async function addStep() {
      const title = prompt('ステップ名を入力してください:');
      if (!title) return;
      
      const description = prompt('説明（任意）:');
      
      const steps = [...(currentCaseData.steps || [])];
      steps.push({
        title: title,
        description: description || '',
        completed: false,
        createdAt: new Date()
      });
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          steps: steps,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.steps = steps;
        loadSteps();
      } catch (error) {
        alert('エラー: ' + error.message);
      }
    }

    async function toggleStep(index) {
      const steps = [...currentCaseData.steps];
      steps[index].completed = !steps[index].completed;
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          steps: steps,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.steps = steps;
        loadSteps();
      } catch (error) {
        alert('エラー: ' + error.message);
      }
    }

    async function deleteStep(index) {
      if (!confirm('このステップを削除しますか?')) return;
      
      const steps = [...currentCaseData.steps];
      steps.splice(index, 1);
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          steps: steps,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.steps = steps;
        loadSteps();
      } catch (error) {
        alert('エラー: ' + error.message);
      }
    }

    // ステップテンプレート管理
    async function loadStepTemplate() {
      try {
        // まずローカルストレージから読み込み
        const localTemplate = localStorage.getItem('stepTemplate');
        if (localTemplate) {
          stepTemplate = JSON.parse(localTemplate);
          displayStepTemplate();
          return;
        }

        // Firestoreから読み込みを試みる
        try {
          const doc = await db.collection('settings').doc('stepTemplate').get();
          if (doc.exists) {
            stepTemplate = doc.data().steps || [];
            localStorage.setItem('stepTemplate', JSON.stringify(stepTemplate));
          } else {
            // デフォルトテンプレート
            stepTemplate = [
              { title: '不具合内容の確認', description: '発生状況と影響範囲を確認' },
              { title: '原因調査', description: '不具合の原因を特定' },
              { title: '暫定対策の実施', description: '一時的な対応を実施' },
              { title: '本対策の検討', description: '恒久的な対策を検討' },
              { title: '対策の実施・確認', description: '対策を実施し効果を確認' },
              { title: '完了報告', description: '顧客へ報告し承認を得る' }
            ];
            localStorage.setItem('stepTemplate', JSON.stringify(stepTemplate));
          }
        } catch (firestoreError) {
          // Firestoreアクセスエラー時はデフォルトテンプレートを使用
          console.log('Firestoreテンプレート読み込みスキップ（権限不足）、デフォルトテンプレートを使用');
          stepTemplate = [
            { title: '不具合内容の確認', description: '発生状況と影響範囲を確認' },
            { title: '原因調査', description: '不具合の原因を特定' },
            { title: '暫定対策の実施', description: '一時的な対応を実施' },
            { title: '本対策の検討', description: '恒久的な対策を検討' },
            { title: '対策の実施・確認', description: '対策を実施し効果を確認' },
            { title: '完了報告', description: '顧客へ報告し承認を得る' }
          ];
          localStorage.setItem('stepTemplate', JSON.stringify(stepTemplate));
        }
        
        displayStepTemplate();
      } catch (error) {
        console.error('テンプレート読み込みエラー:', error);
        // エラー時もデフォルトテンプレートで続行
        stepTemplate = [
          { title: '不具合内容の確認', description: '発生状況と影響範囲を確認' },
          { title: '原因調査', description: '不具合の原因を特定' },
          { title: '暫定対策の実施', description: '一時的な対応を実施' },
          { title: '本対策の検討', description: '恒久的な対策を検討' },
          { title: '対策の実施・確認', description: '対策を実施し効果を確認' },
          { title: '完了報告', description: '顧客へ報告し承認を得る' }
        ];
        displayStepTemplate();
      }
    }

    function displayStepTemplate() {
      const list = document.getElementById('stepTemplateList');
      if (!list) return;
      
      list.innerHTML = stepTemplate.map((step, i) => `
        <div class="card" style="padding: 0.75rem; margin-bottom: 0.5rem;">
          <div class="flex-between">
            <div>
              <div style="font-weight: 600;">${step.title}</div>
              ${step.description ? `<div style="font-size: 0.85rem; color: #666; margin-top: 0.3rem;">${step.description}</div>` : ''}
            </div>
            <button onclick="deleteStepFromTemplate(${i})" class="btn btn-danger btn-small">削除</button>
          </div>
        </div>
      `).join('');
    }

    async function addStepToTemplate() {
      const title = document.getElementById('newStepTitle').value.trim();
      if (!title) {
        alert('ステップ名を入力してください');
        return;
      }
      
      const description = document.getElementById('newStepDescription').value.trim();
      
      stepTemplate.push({ title, description });
      
      // ローカルストレージに保存
      localStorage.setItem('stepTemplate', JSON.stringify(stepTemplate));
      
      // Firestoreへの保存を試みる（失敗しても続行）
      try {
        await db.collection('settings').doc('stepTemplate').set({
          steps: stepTemplate,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (error) {
        console.log('Firestore保存スキップ（ローカルストレージに保存済み）');
      }
      
      document.getElementById('newStepTitle').value = '';
      document.getElementById('newStepDescription').value = '';
      
      showAlert('ステップをテンプレートに追加しました');
      displayStepTemplate();
    }

    async function deleteStepFromTemplate(index) {
      if (!confirm('このステップをテンプレートから削除しますか?')) return;
      
      stepTemplate.splice(index, 1);
      
      // ローカルストレージに保存
      localStorage.setItem('stepTemplate', JSON.stringify(stepTemplate));
      
      // Firestoreへの保存を試みる（失敗しても続行）
      try {
        await db.collection('settings').doc('stepTemplate').set({
          steps: stepTemplate,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (error) {
        console.log('Firestore保存スキップ（ローカルストレージに保存済み）');
      }
      
      showAlert('テンプレートから削除しました');
      displayStepTemplate();
    }

    // 写真表示
    function showPhotos(locationIndex, resultIndex) {
      const result = currentCaseData.inventoryLocations[locationIndex].inspectionResults[resultIndex];
      const photos = result.photos || [];
      
      if (photos.length === 0) return;
      
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3>写真 (${photos.length}枚)</h3>
            <button onclick="this.closest('.modal').remove()" class="btn btn-secondary btn-small">✕</button>
          </div>
          <div class="modal-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
              ${photos.map(photo => `
                <a href="${photo.url}" target="_blank">
                  <img src="${photo.url}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 4px; border: 2px solid #ddd;">
                </a>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }

    // 集計レポート出力
    async function exportSummaryReport() {
      try {
        showAlert('レポートを生成中...');
        
        const snapshot = await db.collection('cases')
          .where('status', '==', 'inProgress')
          .get();
        
        let csvContent = '\uFEFF'; // UTF-8 BOM
        csvContent += '案件名,得意先,発生日,在庫場所,整理No,選別数,NG数,NG率(%),実績件数\n';
        
        snapshot.forEach(doc => {
          const caseData = doc.data();
          const caseName = caseData.caseName || '';
          const customerName = caseData.customerName || '';
          const occurredDate = caseData.occurredDate ? 
            new Date(caseData.occurredDate.seconds * 1000).toLocaleDateString('ja-JP') : '';
          
          const locations = caseData.inventoryLocations || [];
          
          if (locations.length === 0) {
            csvContent += `"${caseName}","${customerName}","${occurredDate}","なし","",0,0,0.00,0\n`;
          } else {
            locations.forEach(location => {
              const results = location.inspectionResults || [];
              let totalCount = 0;
              let totalNG = 0;
              
              // 整理Noを集計
              const serialNumbersSet = new Set();
              results.forEach(r => {
                totalCount += r.count || 0;
                totalNG += r.ngCount || 0;
                (r.serialNumbers || []).forEach(sn => serialNumbersSet.add(sn));
              });
              
              const ngRate = totalCount > 0 ? ((totalNG / totalCount) * 100).toFixed(2) : '0.00';
              const serialNumbers = Array.from(serialNumbersSet).join(' ');
              
              csvContent += `"${caseName}","${customerName}","${occurredDate}","${location.location}","${serialNumbers}",${totalCount},${totalNG},${ngRate},${results.length}\n`;
            });
          }
        });
        
        // CSVダウンロード
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        const date = new Date().toISOString().split('T')[0];
        link.download = `選別実績集計_${date}.csv`;
        link.click();
        
        showAlert('レポートを出力しました');
      } catch (error) {
        alert('エラー: ' + error.message);
      }
    }
  </script>
</body>
</html>
