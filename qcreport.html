<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>客先不具合対応リスト</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }

    /* ページ切り替え */
    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    /* ヘッダー */
    header {
      background-color: #2c3e50;
      color: white;
      padding: 1rem 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 1.5rem;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    nav {
      margin-top: 0.5rem;
    }

    nav a {
      color: white;
      text-decoration: none;
      margin-left: 1rem;
      font-size: 0.9rem;
      opacity: 0.9;
      cursor: pointer;
    }

    nav a:hover {
      opacity: 1;
      text-decoration: underline;
    }

    /* コンテナ */
    .container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    /* カード */
    .card {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* ボタン */
    .btn {
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
      font-weight: 500;
    }

    .btn-primary {
      background-color: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background-color: #2980b9;
    }

    .btn-success {
      background-color: #27ae60;
      color: white;
    }

    .btn-success:hover {
      background-color: #229954;
    }

    .btn-danger {
      background-color: #e74c3c;
      color: white;
    }

    .btn-danger:hover {
      background-color: #c0392b;
    }

    .btn-secondary {
      background-color: #95a5a6;
      color: white;
    }

    .btn-secondary:hover {
      background-color: #7f8c8d;
    }

    .btn-small {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
    }

    /* フォーム */
    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.3rem;
      font-weight: 500;
      color: #555;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
      font-family: inherit;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    /* ステータスバッジ */
    .status-badge {
      display: inline-block;
      padding: 0.3rem 0.6rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .status-inProgress {
      background-color: #fff3cd;
      color: #856404;
    }

    .status-completed {
      background-color: #d4edda;
      color: #155724;
    }

    /* ステップ状態 */
    .step-state {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .state-notStarted {
      background-color: #f8f9fa;
      color: #6c757d;
    }

    .state-inProgress {
      background-color: #fff3cd;
      color: #856404;
    }

    .state-completed {
      background-color: #d4edda;
      color: #155724;
    }

    /* プログレスバー */
    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      margin: 0.5rem 0;
    }

    .progress-fill {
      height: 100%;
      background-color: #27ae60;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.75rem;
      font-weight: 500;
    }

    /* 案件リスト */
    .case-list {
      list-style: none;
    }

    .case-item {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.3s;
    }

    .case-item:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }

    .case-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .case-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: #2c3e50;
    }

    .case-info {
      display: flex;
      gap: 1rem;
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 0.5rem;
    }

    /* ステップリスト */
    .step-list {
      list-style: none;
    }

    .step-item {
      background: #f8f9fa;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 0.8rem;
      border-left: 4px solid #dee2e6;
    }

    .step-item.completed {
      border-left-color: #27ae60;
      background-color: #f0f9f4;
    }

    .step-item.inProgress {
      border-left-color: #f39c12;
      background-color: #fffbf0;
    }

    .step-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .step-name {
      font-weight: 600;
      color: #2c3e50;
    }

    .step-controls {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }

    .step-info {
      display: flex;
      gap: 1rem;
      font-size: 0.85rem;
      color: #666;
      margin-top: 0.5rem;
    }

    /* 管理画面用 */
    .step-item-admin {
      display: flex;
      align-items: center;
      gap: 1rem;
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 0.5rem;
    }

    .step-order {
      font-weight: 600;
      color: #666;
      min-width: 30px;
    }

    .step-content {
      flex: 1;
    }

    .step-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* モーダル */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-header h2 {
      margin: 0;
      color: #2c3e50;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #999;
    }

    .close-modal:hover {
      color: #333;
    }

    /* ユーティリティ */
    .flex {
      display: flex;
    }

    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .gap-1 {
      gap: 1rem;
    }

    .mb-1 {
      margin-bottom: 1rem;
    }

    .text-center {
      text-align: center;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .alert {
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }

    .alert-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* ログイン画面専用 */
    .login-container {
      max-width: 400px;
      margin: 5rem auto;
      padding: 2rem;
    }

    .login-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .login-header h1 {
      color: #2c3e50;
      margin-bottom: 0.5rem;
    }

    .login-header p {
      color: #666;
      font-size: 0.9rem;
    }

    /* レスポンシブ */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 0.5rem;
      }

      .container {
        margin: 1rem auto;
      }

      .case-info {
        flex-direction: column;
        gap: 0.3rem;
      }

      .step-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .step-controls {
        width: 100%;
      }

      .modal-content {
        width: 95%;
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- ログイン画面 -->
  <div id="loginPage" class="page active">
    <div class="login-container">
      <div class="card">
        <div class="login-header">
          <h1>客先不具合対応リスト</h1>
          <p>ログインしてください</p>
        </div>
        
        <form id="loginForm">
          <div class="form-group">
            <label for="email">メールアドレス</label>
            <input type="email" id="email" required>
          </div>
          
          <div class="form-group">
            <label for="password">パスワード</label>
            <input type="password" id="password" required>
          </div>
          
          <button type="submit" class="btn btn-primary" style="width: 100%;">ログイン</button>
        </form>
        
        <div id="loginError" style="margin-top: 1rem;"></div>
        
        <div style="margin-top: 2rem; text-align: center; font-size: 0.9rem; color: #666;">
          <p>初回ログイン時はアカウントが自動作成されます</p>
        </div>
      </div>
    </div>
  </div>

  <!-- メインアプリ（ログイン後） -->
  <div id="mainApp" class="page">
    <header>
      <div class="header-content">
        <div>
          <h1>客先不具合対応リスト</h1>
          <nav>
            <a onclick="showPage('casesPage')">案件一覧</a>
            <a onclick="showPage('historyPage')">過去履歴</a>
            <a onclick="showPage('adminPage')">管理画面</a>
          </nav>
        </div>
        <div class="user-info">
          <span class="user-name" id="userName">読み込み中...</span>
          <button onclick="logout()" class="btn btn-secondary btn-small">ログアウト</button>
        </div>
      </div>
    </header>

    <!-- 案件一覧ページ -->
    <div id="casesPage" class="page active">
      <div class="container">
        <div class="flex-between mb-1">
          <h2>案件一覧</h2>
          <button onclick="showModal('newCaseModal')" class="btn btn-primary">+ 新規案件</button>
        </div>

        <!-- フィルター -->
        <div class="card mb-1">
          <div class="flex gap-1" style="flex-wrap: wrap;">
            <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
              <label for="filterCustomer">客先名で絞り込み</label>
              <input type="text" id="filterCustomer" placeholder="客先名を入力">
            </div>
            <div class="form-group" style="margin-bottom: 0; width: 150px;">
              <label for="filterStatus">ステータス</label>
              <select id="filterStatus">
                <option value="">すべて</option>
                <option value="inProgress">進行中</option>
                <option value="completed">完了</option>
              </select>
            </div>
            <div style="display: flex; align-items: flex-end;">
              <button onclick="applyFilters()" class="btn btn-primary">絞り込み</button>
            </div>
          </div>
        </div>

        <!-- 案件リスト -->
        <div id="casesList">
          <div class="loading">読み込み中...</div>
        </div>
      </div>
    </div>

    <!-- 案件詳細ページ -->
    <div id="caseDetailPage" class="page">
      <div class="container">
        <div class="flex-between mb-1">
          <button onclick="showPage('casesPage')" class="btn btn-secondary">← 一覧に戻る</button>
          <div style="display: flex; gap: 0.5rem;">
            <button onclick="exportCaseSummaryCSV()" class="btn btn-success">まとめて出力(CSV)</button>
            <button onclick="showEditCaseInfoModal()" class="btn btn-primary">案件情報編集</button>
            <button onclick="toggleCaseStatus()" id="statusToggleBtn" class="btn btn-success" style="display: none;">案件を完了にする</button>
          </div>
        </div>

        <!-- 案件情報 -->
        <div class="card" id="caseInfo">
          <div class="loading">読み込み中...</div>
        </div>

        <!-- 選別実績 -->
        <div class="flex-between" style="margin-top: 2rem; margin-bottom: 1rem;">
          <h3>在庫場所と選別実績</h3>
          <div style="display: flex; gap: 0.5rem;">
            <button onclick="exportInspectionsCSV()" class="btn btn-success">CSV出力</button>
            <button onclick="showModal('addLocationModal')" class="btn btn-primary">+ 在庫場所を追加</button>
          </div>
        </div>
        <div id="inventoryLocationsList">
          <div class="loading">読み込み中...</div>
        </div>

        <!-- 対応ステップ一覧 -->
        <h3 style="margin-top: 2rem; margin-bottom: 1rem;">対応ステップ</h3>
        <div id="stepsList">
          <div class="loading">読み込み中...</div>
        </div>
      </div>
    </div>

    <!-- 過去履歴ページ -->
    <div id="historyPage" class="page">
      <div class="container">
        <h2>過去履歴（完了した案件）</h2>
        
        <!-- フィルター -->
        <div class="card" style="margin-bottom: 1rem;">
          <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
              <input type="text" id="historySearchCustomer" placeholder="客先名で検索..." style="width: 100%;">
            </div>
            <button onclick="loadHistory()" class="btn btn-primary">検索</button>
          </div>
        </div>

        <!-- 案件一覧 -->
        <div id="historyList">
          <div class="loading">読み込み中...</div>
        </div>
      </div>
    </div>

    <!-- 管理画面ページ -->
    <div id="adminPage" class="page">
      <div class="container">
        <h2>標準対応リスト管理</h2>
        <p style="color: #666; margin-bottom: 1rem;">ここで設定したステップは、新規案件作成時に自動で紐づきます。</p>

        <div class="card mb-1">
          <button onclick="showModal('newStepModal')" class="btn btn-primary">+ ステップを追加</button>
        </div>

        <div id="standardStepsList">
          <div class="loading">読み込み中...</div>
        </div>

        <!-- ユーザー管理セクション -->
        <h2 style="margin-top: 3rem;">ユーザー管理</h2>
        <div id="usersList">
          <div class="loading">読み込み中...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- モーダル: 新規案件 -->
  <div id="newCaseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>新規案件登録</h2>
        <button class="close-modal" onclick="hideModal('newCaseModal')">&times;</button>
      </div>
      
      <form id="newCaseForm">
        <div class="form-group">
          <label for="caseName">案件名 *</label>
          <input type="text" id="caseName" required>
        </div>
        
        <div class="form-group">
          <label for="customerName">客先名 *</label>
          <input type="text" id="customerName" required list="customerList">
          <datalist id="customerList"></datalist>
        </div>
        
        <div class="form-group">
          <label for="occurredDate">発生日 *</label>
          <input type="date" id="occurredDate" required>
        </div>
        
        <div class="form-group">
          <label for="description">不具合概要</label>
          <textarea id="description" rows="4"></textarea>
        </div>
        
        <div class="form-group">
          <label for="estimatedCause">推定原因の調査</label>
          <textarea id="estimatedCause" rows="3" placeholder="推定される原因や調査内容を記入"></textarea>
        </div>
        
        <div class="form-group">
          <label for="temporaryMeasures">暫定対策検討</label>
          <textarea id="temporaryMeasures" rows="3" placeholder="暫定的な対策を記入"></textarea>
        </div>
        
        <div class="form-group">
          <label for="casePhotos">写真アップロード（任意）</label>
          <input type="file" id="casePhotos" accept="image/*" multiple>
          <div style="font-size: 0.85rem; color: #666; margin-top: 0.3rem;">
            複数枚選択可能。JPG, PNG, GIF形式に対応
          </div>
          <div id="casePhotoPreview" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;"></div>
        </div>
        
        <div style="border: 2px solid #3498db; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #f8f9fa;">
          <div style="font-weight: 600; margin-bottom: 1rem; color: #2c3e50;">在庫場所リスト</div>
          <div id="inventoryLocationInputs">
            <div class="inventory-location-input" style="border: 1px solid #ddd; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; background: white;">
              <div class="form-group" style="margin-bottom: 0.5rem;">
                <label>在庫場所</label>
                <input type="text" class="location-name" placeholder="例: A工場 完成品倉庫">
              </div>
              <div class="form-group" style="margin-bottom: 0.5rem;">
                <label>得意先担当者</label>
                <input type="text" class="location-customer-contact" placeholder="例: 田中様">
              </div>
              <div class="form-group" style="margin-bottom: 0.5rem;">
                <label>かんばん情報</label>
                <input type="text" class="location-kanban" placeholder="例: K-12345">
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label>その他指示</label>
                <textarea class="location-instructions" rows="2" placeholder="特記事項があれば記入"></textarea>
              </div>
            </div>
          </div>
          <div style="display: flex; gap: 0.5rem;">
            <button type="button" onclick="addLocationInput()" class="btn btn-primary btn-small">+ 場所を追加</button>
            <button type="button" onclick="removeLastLocationInput()" class="btn btn-secondary btn-small">最後を削除</button>
          </div>
        </div>
        
        <div class="flex gap-1">
          <button type="submit" class="btn btn-primary" style="flex: 1;">登録</button>
          <button type="button" onclick="hideModal('newCaseModal')" class="btn btn-secondary" style="flex: 1;">キャンセル</button>
        </div>
      </form>
    </div>
  </div>

  <!-- モーダル: ステップ編集 -->
  <div id="editStepModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ステップ編集</h2>
        <button class="close-modal" onclick="hideModal('editStepModal')">&times;</button>
      </div>
      
      <form id="editStepForm">
        <input type="hidden" id="editStepIndex">
        
        <div class="form-group">
          <label>ステップ名</label>
          <div id="editStepName" style="font-weight: 600; padding: 0.6rem 0;"></div>
        </div>
        
        <div class="form-group">
          <label for="editAssignedTo">担当者</label>
          <select id="editAssignedTo"></select>
        </div>
        
        <div class="form-group">
          <label for="editDueDate">期限</label>
          <input type="date" id="editDueDate">
        </div>
        
        <div class="form-group">
          <label for="editComments">コメント</label>
          <textarea id="editComments" rows="4"></textarea>
        </div>
        
        <div class="flex gap-1">
          <button type="submit" class="btn btn-primary" style="flex: 1;">保存</button>
          <button type="button" onclick="hideModal('editStepModal')" class="btn btn-secondary" style="flex: 1;">キャンセル</button>
        </div>
      </form>
    </div>
  </div>

  <!-- モーダル: 新規標準ステップ -->
  <div id="newStepModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>新規ステップ追加</h2>
        <button class="close-modal" onclick="hideModal('newStepModal')">&times;</button>
      </div>
      
      <form id="newStepForm">
        <div class="form-group">
          <label for="stepName">ステップ名 *</label>
          <input type="text" id="stepName" required>
        </div>
        
        <div class="form-group">
          <label for="stepDescription">説明</label>
          <textarea id="stepDescription" rows="3"></textarea>
        </div>
        
        <div class="flex gap-1">
          <button type="submit" class="btn btn-primary" style="flex: 1;">追加</button>
          <button type="button" onclick="hideModal('newStepModal')" class="btn btn-secondary" style="flex: 1;">キャンセル</button>
        </div>
      </form>
    </div>
  </div>

  <!-- モーダル: 標準ステップ編集 -->
  <div id="editStandardStepModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ステップ編集</h2>
        <button class="close-modal" onclick="hideModal('editStandardStepModal')">&times;</button>
      </div>
      
      <form id="editStandardStepForm">
        <input type="hidden" id="editStandardStepId">
        
        <div class="form-group">
          <label for="editStandardStepName">ステップ名 *</label>
          <input type="text" id="editStandardStepName" required>
        </div>
        
        <div class="form-group">
          <label for="editStandardStepDescription">説明</label>
          <textarea id="editStandardStepDescription" rows="3"></textarea>
        </div>
        
        <div class="flex gap-1">
          <button type="submit" class="btn btn-primary" style="flex: 1;">保存</button>
          <button type="button" onclick="hideModal('editStandardStepModal')" class="btn btn-secondary" style="flex: 1;">キャンセル</button>
        </div>
      </form>
    </div>
  </div>

  <!-- モーダル: 案件情報編集 -->
  <div id="editCaseInfoModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>案件情報編集</h2>
        <button class="close-modal" onclick="hideModal('editCaseInfoModal')">&times;</button>
      </div>
      
      <form id="editCaseInfoForm">
        <div class="form-group">
          <label for="editDescription">不具合概要</label>
          <textarea id="editDescription" rows="4"></textarea>
        </div>
        
        <div class="form-group">
          <label for="editEstimatedCause">推定原因の調査</label>
          <textarea id="editEstimatedCause" rows="3"></textarea>
        </div>
        
        <div class="form-group">
          <label for="editTemporaryMeasures">暫定対策検討</label>
          <textarea id="editTemporaryMeasures" rows="3"></textarea>
        </div>
        
        <div class="flex gap-1">
          <button type="submit" class="btn btn-primary" style="flex: 1;">保存</button>
          <button type="button" onclick="hideModal('editCaseInfoModal')" class="btn btn-secondary" style="flex: 1;">キャンセル</button>
        </div>
      </form>
    </div>
  </div>

  <!-- モーダル: 在庫場所追加 -->
  <div id="addLocationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>在庫場所を追加</h2>
        <button class="close-modal" onclick="hideModal('addLocationModal')">&times;</button>
      </div>
      
      <form id="addLocationForm">
        <div class="form-group">
          <label for="newLocationName">在庫場所 *</label>
          <input type="text" id="newLocationName" required placeholder="例: A工場 完成品倉庫">
        </div>
        
        <div class="form-group">
          <label for="newLocationCustomerContact">得意先担当者</label>
          <input type="text" id="newLocationCustomerContact" placeholder="例: 田中様">
        </div>
        
        <div class="form-group">
          <label for="newLocationKanban">かんばん情報</label>
          <input type="text" id="newLocationKanban" placeholder="例: K-12345">
        </div>
        
        <div class="form-group">
          <label for="newLocationInstructions">その他指示</label>
          <textarea id="newLocationInstructions" rows="3" placeholder="特記事項があれば記入"></textarea>
        </div>
        
        <div class="flex gap-1">
          <button type="submit" class="btn btn-primary" style="flex: 1;">追加</button>
          <button type="button" onclick="hideModal('addLocationModal')" class="btn btn-secondary" style="flex: 1;">キャンセル</button>
        </div>
      </form>
    </div>
  </div>

  <!-- モーダル: 在庫場所編集 -->
  <div id="editLocationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>在庫場所を編集</h2>
        <button class="close-modal" onclick="hideModal('editLocationModal')">&times;</button>
      </div>
      
      <form id="editLocationForm">
        <input type="hidden" id="editLocationIndex">
        
        <div class="form-group">
          <label for="editLocationName">在庫場所 *</label>
          <input type="text" id="editLocationName" required>
        </div>
        
        <div class="form-group">
          <label for="editLocationCustomerContact">得意先担当者</label>
          <input type="text" id="editLocationCustomerContact">
        </div>
        
        <div class="form-group">
          <label for="editLocationKanban">かんばん情報</label>
          <input type="text" id="editLocationKanban">
        </div>
        
        <div class="form-group">
          <label for="editLocationInstructions">その他指示</label>
          <textarea id="editLocationInstructions" rows="3"></textarea>
        </div>
        
        <div class="flex gap-1">
          <button type="submit" class="btn btn-primary" style="flex: 1;">保存</button>
          <button type="button" onclick="hideModal('editLocationModal')" class="btn btn-secondary" style="flex: 1;">キャンセル</button>
        </div>
      </form>
    </div>
  </div>

  <!-- モーダル: 選別実績追加 -->
  <div id="addInspectionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="addInspectionModalTitle">選別実績追加</h2>
        <button class="close-modal" onclick="hideModal('addInspectionModal')">&times;</button>
      </div>
      
      <form id="addInspectionForm">
        <input type="hidden" id="inspectionLocationIndex">
        
        <div class="form-group">
          <label>対象場所</label>
          <div id="inspectionLocationName" style="font-weight: 600; padding: 0.6rem 0;"></div>
        </div>
        
        <div class="form-group">
          <label for="inspectionStartTime">開始時刻 *</label>
          <input type="datetime-local" id="inspectionStartTime" required>
        </div>
        
        <div class="form-group">
          <label for="inspectionEndTime">完了時刻 *</label>
          <input type="datetime-local" id="inspectionEndTime" required>
        </div>
        
        <div class="form-group">
          <label for="inspectionShift">便 *</label>
          <select id="inspectionShift" required>
            <option value="">選択してください</option>
            <option value="1直">1直</option>
            <option value="2直">2直</option>
            <option value="3直">3直</option>
            <option value="日勤">日勤</option>
            <option value="夜勤">夜勤</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="inspectionCount">選別数 *</label>
          <input type="number" id="inspectionCount" required min="0" placeholder="0">
        </div>
        
        <div class="form-group">
          <label for="inspectionNgCount">NG数 *</label>
          <input type="number" id="inspectionNgCount" required min="0" placeholder="0">
        </div>
        
        <div class="form-group">
          <label for="inspectionSupervisor">責任者 *</label>
          <input type="text" id="inspectionSupervisor" required placeholder="例: 山田太郎">
        </div>
        
        <div class="form-group">
          <label for="inspectionRemarks">備考</label>
          <textarea id="inspectionRemarks" rows="3" placeholder="特記事項があれば記入"></textarea>
        </div>
        
        <div class="form-group">
          <label for="inspectionPhotos">写真アップロード（任意）</label>
          <input type="file" id="inspectionPhotos" accept="image/*" multiple>
          <div style="font-size: 0.85rem; color: #666; margin-top: 0.3rem;">
            複数枚選択可能。JPG, PNG, GIF形式に対応
          </div>
          <div id="inspectionPhotoPreview" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;"></div>
        </div>
        
        <div class="flex gap-1">
          <button type="submit" class="btn btn-primary" style="flex: 1;">追加</button>
          <button type="button" onclick="hideModal('addInspectionModal')" class="btn btn-secondary" style="flex: 1;">キャンセル</button>
        </div>
      </form>
    </div>
  </div>

  <!-- モーダル: 選別実績編集 -->
  <div id="editInspectionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>選別実績編集</h2>
        <button class="close-modal" onclick="hideModal('editInspectionModal')">&times;</button>
      </div>
      
      <form id="editInspectionForm">
        <input type="hidden" id="editInspectionLocationIndex">
        <input type="hidden" id="editInspectionIndex">
        
        <div class="form-group">
          <label>対象場所</label>
          <div id="editInspectionLocationName" style="font-weight: 600; padding: 0.6rem 0;"></div>
        </div>
        
        <div class="form-group">
          <label for="editInspectionStartTime">開始時刻 *</label>
          <input type="datetime-local" id="editInspectionStartTime" required>
        </div>
        
        <div class="form-group">
          <label for="editInspectionEndTime">完了時刻 *</label>
          <input type="datetime-local" id="editInspectionEndTime" required>
        </div>
        
        <div class="form-group">
          <label for="editInspectionShift">便 *</label>
          <select id="editInspectionShift" required>
            <option value="">選択してください</option>
            <option value="1直">1直</option>
            <option value="2直">2直</option>
            <option value="3直">3直</option>
            <option value="日勤">日勤</option>
            <option value="夜勤">夜勤</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="editInspectionCount">選別数 *</label>
          <input type="number" id="editInspectionCount" required min="0">
        </div>
        
        <div class="form-group">
          <label for="editInspectionNgCount">NG数 *</label>
          <input type="number" id="editInspectionNgCount" required min="0">
        </div>
        
        <div class="form-group">
          <label for="editInspectionSupervisor">責任者 *</label>
          <input type="text" id="editInspectionSupervisor" required>
        </div>
        
        <div class="form-group">
          <label for="editInspectionRemarks">備考</label>
          <textarea id="editInspectionRemarks" rows="3"></textarea>
        </div>
        
        <div class="flex gap-1">
          <button type="submit" class="btn btn-primary" style="flex: 1;">保存</button>
          <button type="button" onclick="hideModal('editInspectionModal')" class="btn btn-secondary" style="flex: 1;">キャンセル</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <script>
    // ========================================
    // Firebase設定
    // ※ APIキーエラーが出る場合:
    // 1. Google Cloud Console → APIとサービス → 認証情報 でAPIキーの制限を「なし」に変更
    // 2. または Firebase Console → プロジェクトの設定 → ウェブAPIキー を確認して置き換え
    // ========================================
    const firebaseConfig = {
      apiKey: "AIzaSyCr2A0kYdlJsCKnJhGXwEDViu2Ae08yKJc",
      authDomain: "qckyouyu.firebaseapp.com",
      projectId: "qckyouyu",
      storageBucket: "qckyouyu.firebasestorage.app",
      messagingSenderId: "884065987840",
      appId: "1:884065987840:web:2b12cc1204e484b999d7e5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    // ========================================
    // 写真アップロード機能
    // ========================================
    
    // 案件登録用写真プレビュー
    document.getElementById('casePhotos')?.addEventListener('change', function(e) {
      const preview = document.getElementById('casePhotoPreview');
      preview.innerHTML = '';
      
      Array.from(e.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(event) {
          const img = document.createElement('img');
          img.src = event.target.result;
          img.style.cssText = 'width: 100px; height: 100px; object-fit: cover; border-radius: 4px; border: 2px solid #ddd;';
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });
    
    // 選別実績用写真プレビュー
    document.getElementById('inspectionPhotos')?.addEventListener('change', function(e) {
      const preview = document.getElementById('inspectionPhotoPreview');
      preview.innerHTML = '';
      
      Array.from(e.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(event) {
          const img = document.createElement('img');
          img.src = event.target.result;
          img.style.cssText = 'width: 100px; height: 100px; object-fit: cover; border-radius: 4px; border: 2px solid #ddd;';
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });
    
    // Firebase Storageに写真をアップロード
    async function uploadPhotos(files, path) {
      const photoUrls = [];
      
      for (const file of files) {
        try {
          const timestamp = Date.now();
          const randomStr = Math.random().toString(36).substring(7);
          const fileName = `${timestamp}_${randomStr}_${file.name}`;
          const storageRef = storage.ref(`${path}/${fileName}`);
          
          const snapshot = await storageRef.put(file);
          const downloadURL = await snapshot.ref.getDownloadURL();
          
          photoUrls.push({
            url: downloadURL,
            name: file.name,
            uploadedAt: new Date()
          });
        } catch (error) {
          console.error('写真アップロードエラー:', error);
          throw error;
        }
      }
      
      return photoUrls;
    }

    // ========================================
    // グローバル変数
    // ========================================
    let currentUser = null;
    let currentUserData = null;
    let allCases = [];
    let customerNames = new Set();
    let standardSteps = [];
    let currentCaseId = null;
    let currentCaseData = null;
    let allUsers = [];

    // ========================================
    // ページ切り替え
    // ========================================
    function showPage(pageId) {
      // mainApp内のすべてのページを非表示
      document.querySelectorAll('#mainApp .page').forEach(page => {
        page.classList.remove('active');
      });
      
      // 指定されたページを表示
      document.getElementById(pageId).classList.add('active');
      
      // ページごとの初期化処理
      if (pageId === 'casesPage') {
        loadCases();
      } else if (pageId === 'historyPage') {
        loadHistory();
      } else if (pageId === 'adminPage') {
        loadStandardSteps();
        loadUsersForAdmin();
      } else if (pageId === 'caseDetailPage') {
        loadCase();
      }
    }

    // ========================================
    // 認証
    // ========================================
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        
        // ユーザーデータを取得
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
          currentUserData = userDoc.data();
        } else {
          // ユーザードキュメントが存在しない場合は作成
          currentUserData = {
            email: user.email,
            displayName: user.email.split('@')[0],
            role: 'user',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          await db.collection('users').doc(user.uid).set(currentUserData);
        }
        
        updateUserDisplay();
        
        // メインアプリを表示
        document.getElementById('loginPage').classList.remove('active');
        document.getElementById('mainApp').classList.add('active');
        
        loadCases();
      } else {
        // ログインページを表示
        document.getElementById('mainApp').classList.remove('active');
        document.getElementById('loginPage').classList.add('active');
      }
    });

    function updateUserDisplay() {
      const userNameElement = document.getElementById('userName');
      if (userNameElement && currentUserData) {
        userNameElement.textContent = currentUserData.displayName || currentUserData.email;
      }
    }

    async function logout() {
      if (confirm('ログアウトしますか?')) {
        try {
          await auth.signOut();
        } catch (error) {
          console.error('ログアウトエラー:', error);
          alert('ログアウトに失敗しました');
        }
      }
    }

    // ログインフォーム
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('loginError');
      
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (error) {
        if (error.code === 'auth/user-not-found') {
          try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;
            
            await db.collection('users').doc(user.uid).set({
              email: email,
              displayName: email.split('@')[0],
              role: 'user',
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          } catch (createError) {
            console.error('アカウント作成エラー:', createError);
            errorDiv.innerHTML = '<div class="alert alert-error">アカウント作成に失敗しました</div>';
          }
        } else if (error.code === 'auth/wrong-password') {
          errorDiv.innerHTML = '<div class="alert alert-error">パスワードが正しくありません</div>';
        } else {
          console.error('ログインエラー:', error);
          errorDiv.innerHTML = '<div class="alert alert-error">ログインに失敗しました</div>';
        }
      }
    });

    // ========================================
    // ユーティリティ関数
    // ========================================
    function formatDate(timestamp) {
      if (!timestamp) return '';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}/${month}/${day}`;
    }

    function formatDateTime(timestamp) {
      if (!timestamp) return '';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}/${month}/${day} ${hours}:${minutes}`;
    }

    function dateToTimestamp(dateString) {
      if (!dateString) return null;
      return firebase.firestore.Timestamp.fromDate(new Date(dateString));
    }

    function getStatusText(status) {
      const statusMap = {
        'inProgress': '進行中',
        'completed': '完了'
      };
      return statusMap[status] || status;
    }

    function getStateText(state) {
      const stateMap = {
        'notStarted': '未着手',
        'inProgress': '対応中',
        'completed': '完了'
      };
      return stateMap[state] || state;
    }

    function calculateProgress(steps) {
      if (!steps || steps.length === 0) return 0;
      const completedSteps = steps.filter(step => step.state === 'completed').length;
      return Math.round((completedSteps / steps.length) * 100);
    }

    async function getAllUsers() {
      try {
        const snapshot = await db.collection('users').get();
        const users = [];
        snapshot.forEach(doc => {
          users.push({
            id: doc.id,
            ...doc.data()
          });
        });
        return users;
      } catch (error) {
        console.error('ユーザー取得エラー:', error);
        return [];
      }
    }

    function createUserOptions(users, selectedUserId = '') {
      let html = '<option value="">担当者を選択</option>';
      users.forEach(user => {
        const selected = user.id === selectedUserId ? 'selected' : '';
        html += `<option value="${user.id}" ${selected}>${user.displayName || user.email}</option>`;
      });
      return html;
    }

    function showAlert(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;
      
      const container = document.querySelector('.container');
      if (container) {
        container.insertBefore(alertDiv, container.firstChild);
        setTimeout(() => {
          alertDiv.remove();
        }, 3000);
      }
    }

    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.add('active');
      }
    }

    function hideModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('active');
      }
    }

    function isAdmin() {
      // 管理者権限チェックを廃止 - 全員が全機能を使用可能
      return true;
    }

    // ========================================
    // 案件一覧
    // ========================================
    async function loadCases() {
      if (!currentUser) return;
      
      document.getElementById('casesList').innerHTML = '<div class="loading">読み込み中...</div>';
      
      try {
        const snapshot = await db.collection('cases')
          .where('status', '==', 'inProgress')
          .orderBy('createdAt', 'desc')
          .get();
        
        allCases = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          allCases.push({
            id: doc.id,
            ...data
          });
          
          if (data.customerName) {
            customerNames.add(data.customerName);
          }
        });
        
        updateCustomerDatalist();
        displayCases(allCases);
      } catch (error) {
        console.error('案件読み込みエラー:', error);
        document.getElementById('casesList').innerHTML = '<div class="alert alert-error">案件の読み込みに失敗しました</div>';
      }
    }

    function displayCases(cases) {
      const casesList = document.getElementById('casesList');
      
      if (cases.length === 0) {
        casesList.innerHTML = '<div class="card text-center">案件がありません</div>';
        return;
      }
      
      let html = '<ul class="case-list">';
      
      cases.forEach(caseData => {
        const progress = calculateProgress(caseData.steps || []);
        const completedSteps = (caseData.steps || []).filter(s => s.state === 'completed').length;
        const totalSteps = (caseData.steps || []).length;
        
        html += `
          <li class="case-item" style="cursor: default;">
            <div class="case-header">
              <div class="case-name" onclick="goToCaseDetail('${caseData.id}')" style="cursor: pointer;">${caseData.caseName}</div>
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <span class="status-badge status-${caseData.status}">
                  ${getStatusText(caseData.status)}
                </span>
                <button onclick="deleteCase('${caseData.id}', '${caseData.caseName}')" class="btn btn-danger btn-small">削除</button>
              </div>
            </div>
            
            <div class="case-info" onclick="goToCaseDetail('${caseData.id}')" style="cursor: pointer;">
              <span>客先: ${caseData.customerName}</span>
              <span>発生日: ${formatDate(caseData.occurredDate)}</span>
              <span>進捗: ${completedSteps}/${totalSteps} 完了</span>
            </div>
            
            <div onclick="goToCaseDetail('${caseData.id}')" style="cursor: pointer;">
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${progress}%">
                  ${progress}%
                </div>
              </div>
              
              ${caseData.description ? `<div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">${caseData.description}</div>` : ''}
            </div>
          </li>
        `;
      });
      
      html += '</ul>';
      casesList.innerHTML = html;
    }

    // 案件削除
    async function deleteCase(caseId, caseName) {
      if (!confirm(`案件「${caseName}」を削除しますか?\n\nこの操作は取り消せません。`)) {
        return;
      }
      
      try {
        await db.collection('cases').doc(caseId).delete();
        showAlert('案件を削除しました');
        loadCases();
      } catch (error) {
        console.error('案件削除エラー:', error);
        alert('案件の削除に失敗しました');
      }
    }

    function goToCaseDetail(caseId) {
      currentCaseId = caseId;
      showPage('caseDetailPage');
    }

    function applyFilters() {
      const customerFilter = document.getElementById('filterCustomer').value.toLowerCase();
      const statusFilter = document.getElementById('filterStatus').value;
      
      let filteredCases = allCases;
      
      if (customerFilter) {
        filteredCases = filteredCases.filter(c => 
          c.customerName.toLowerCase().includes(customerFilter)
        );
      }
      
      if (statusFilter) {
        filteredCases = filteredCases.filter(c => c.status === statusFilter);
      }
      
      displayCases(filteredCases);
    }

    function updateCustomerDatalist() {
      const datalist = document.getElementById('customerList');
      let html = '';
      customerNames.forEach(name => {
        html += `<option value="${name}">`;
      });
      datalist.innerHTML = html;
    }

    // 在庫場所入力欄を追加
    function addLocationInput() {
      const container = document.getElementById('inventoryLocationInputs');
      const newInput = document.createElement('div');
      newInput.className = 'inventory-location-input';
      newInput.style.cssText = 'border: 1px solid #ddd; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; background: white;';
      newInput.innerHTML = `
        <div class="form-group" style="margin-bottom: 0.5rem;">
          <label>在庫場所</label>
          <input type="text" class="location-name" placeholder="例: A工場 完成品倉庫">
        </div>
        <div class="form-group" style="margin-bottom: 0.5rem;">
          <label>得意先担当者</label>
          <input type="text" class="location-customer-contact" placeholder="例: 田中様">
        </div>
        <div class="form-group" style="margin-bottom: 0.5rem;">
          <label>かんばん情報</label>
          <input type="text" class="location-kanban" placeholder="例: K-12345">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label>その他指示</label>
          <textarea class="location-instructions" rows="2" placeholder="特記事項があれば記入"></textarea>
        </div>
      `;
      container.appendChild(newInput);
    }

    // 最後の在庫場所入力欄を削除
    function removeLastLocationInput() {
      const container = document.getElementById('inventoryLocationInputs');
      const inputs = container.querySelectorAll('.inventory-location-input');
      if (inputs.length > 0) {
        inputs[inputs.length - 1].remove();
      }
    }

    // 新規案件登録
    document.getElementById('newCaseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const caseName = document.getElementById('caseName').value;
      const customerName = document.getElementById('customerName').value;
      const occurredDate = document.getElementById('occurredDate').value;
      const description = document.getElementById('description').value;
      const estimatedCause = document.getElementById('estimatedCause').value;
      const temporaryMeasures = document.getElementById('temporaryMeasures').value;
      
      // 在庫場所リストを取得
      const locationInputs = document.querySelectorAll('.inventory-location-input');
      const inventoryLocations = [];
      
      locationInputs.forEach((input, index) => {
        const locationName = input.querySelector('.location-name').value.trim();
        const customerContact = input.querySelector('.location-customer-contact').value.trim();
        const kanban = input.querySelector('.location-kanban').value.trim();
        const instructions = input.querySelector('.location-instructions').value.trim();
        
        if (locationName) {
          inventoryLocations.push({
            id: `loc_${Date.now()}_${index}`,
            location: locationName,
            customerContact: customerContact,
            kanban: kanban,
            instructions: instructions,
            inspectionResults: []
          });
        }
      });
      
      try {
        // 写真をアップロード
        const photoFiles = document.getElementById('casePhotos').files;
        let photoUrls = [];
        
        if (photoFiles.length > 0) {
          showAlert('写真をアップロード中...');
          photoUrls = await uploadPhotos(Array.from(photoFiles), `cases/${Date.now()}`);
        }
        
        const standardStepsSnapshot = await db.collection('standardSteps')
          .orderBy('order')
          .get();
        
        const steps = [];
        standardStepsSnapshot.forEach(doc => {
          const stepData = doc.data();
          steps.push({
            stepId: doc.id,
            stepName: stepData.stepName,
            assignedTo: '',
            assignedToName: '',
            state: 'notStarted',
            dueDate: null,
            comments: '',
            updatedAt: new Date(),
            updatedBy: currentUser.uid
          });
        });
        
        await db.collection('cases').add({
          caseName: caseName,
          customerName: customerName,
          occurredDate: dateToTimestamp(occurredDate),
          description: description,
          estimatedCause: estimatedCause,
          temporaryMeasures: temporaryMeasures,
          photos: photoUrls,
          status: 'inProgress',
          steps: steps,
          inventoryLocations: inventoryLocations,
          createdBy: currentUser.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showAlert('案件を登録しました');
        hideModal('newCaseModal');
        document.getElementById('newCaseForm').reset();
        document.getElementById('casePhotoPreview').innerHTML = '';
        
        // 在庫場所入力欄を初期化（1つだけ残す）
        const container = document.getElementById('inventoryLocationInputs');
        container.innerHTML = `
          <div class="inventory-location-input" style="border: 1px solid #ddd; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; background: white;">
            <div class="form-group" style="margin-bottom: 0.5rem;">
              <label>在庫場所</label>
              <input type="text" class="location-name" placeholder="例: A工場 完成品倉庫">
            </div>
            <div class="form-group" style="margin-bottom: 0.5rem;">
              <label>得意先担当者</label>
              <input type="text" class="location-customer-contact" placeholder="例: 田中様">
            </div>
            <div class="form-group" style="margin-bottom: 0.5rem;">
              <label>かんばん情報</label>
              <input type="text" class="location-kanban" placeholder="例: K-12345">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label>その他指示</label>
              <textarea class="location-instructions" rows="2" placeholder="特記事項があれば記入"></textarea>
            </div>
          </div>
        `;
        
        document.getElementById('occurredDate').valueAsDate = new Date();
        loadCases();
      } catch (error) {
        console.error('案件登録エラー:', error);
        alert('案件の登録に失敗しました');
      }
    });

    // 今日の日付をデフォルトに設定
    document.getElementById('occurredDate').valueAsDate = new Date();

    // フィルターのエンターキー対応
    document.getElementById('filterCustomer').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        applyFilters();
      }
    });

    // ========================================
    // 案件詳細
    // ========================================
    async function loadCase() {
      if (!currentUser || !currentCaseId) return;
      
      try {
        const doc = await db.collection('cases').doc(currentCaseId).get();
        
        if (!doc.exists) {
          alert('案件が見つかりません');
          showPage('casesPage');
          return;
        }
        
        currentCaseData = {
          id: doc.id,
          ...doc.data()
        };
        
        displayCaseInfo();
        displayInventoryLocations();
        displaySteps();
        updateStatusButton();
      } catch (error) {
        console.error('案件読み込みエラー:', error);
        document.getElementById('caseInfo').innerHTML = '<div class="alert alert-error">案件の読み込みに失敗しました</div>';
      }
    }

    function displayCaseInfo() {
      const progress = calculateProgress(currentCaseData.steps || []);
      const completedSteps = (currentCaseData.steps || []).filter(s => s.state === 'completed').length;
      const totalSteps = (currentCaseData.steps || []).length;
      
      const html = `
        <div class="flex-between" style="margin-bottom: 1rem;">
          <h2>${currentCaseData.caseName}</h2>
          <span class="status-badge status-${currentCaseData.status}">
            ${getStatusText(currentCaseData.status)}
          </span>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
          <div>
            <div style="font-size: 0.85rem; color: #666;">客先名</div>
            <div style="font-weight: 600;">${currentCaseData.customerName}</div>
          </div>
          <div>
            <div style="font-size: 0.85rem; color: #666;">発生日</div>
            <div style="font-weight: 600;">${formatDate(currentCaseData.occurredDate)}</div>
          </div>
          <div>
            <div style="font-size: 0.85rem; color: #666;">進捗</div>
            <div style="font-weight: 600;">${completedSteps}/${totalSteps} 完了</div>
          </div>
        </div>
        
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${progress}%">
            ${progress}%
          </div>
        </div>
        
        ${currentCaseData.description ? `
          <div style="margin-top: 1rem;">
            <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.3rem;">不具合概要</div>
            <div style="white-space: pre-wrap;">${currentCaseData.description}</div>
          </div>
        ` : ''}
        
        ${currentCaseData.estimatedCause ? `
          <div style="margin-top: 1rem;">
            <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.3rem;">推定原因の調査</div>
            <div style="padding: 0.8rem; background: #fff3cd; border-radius: 4px; white-space: pre-wrap;">${currentCaseData.estimatedCause}</div>
          </div>
        ` : ''}
        
        ${currentCaseData.temporaryMeasures ? `
          <div style="margin-top: 1rem;">
            <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.3rem;">暫定対策検討</div>
            <div style="padding: 0.8rem; background: #d1ecf1; border-radius: 4px; white-space: pre-wrap;">${currentCaseData.temporaryMeasures}</div>
          </div>
        ` : ''}
        
        ${currentCaseData.photos && currentCaseData.photos.length > 0 ? `
          <div style="margin-top: 1rem;">
            <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">添付写真</div>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
              ${currentCaseData.photos.map(photo => `
                <a href="${photo.url}" target="_blank">
                  <img src="${photo.url}" style="width: 120px; height: 120px; object-fit: cover; border-radius: 4px; border: 2px solid #ddd; cursor: pointer;">
                </a>
              `).join('')}
            </div>
          </div>
        ` : ''}
      `;
      
      document.getElementById('caseInfo').innerHTML = html;
    }

    function displaySteps() {
      if (!currentCaseData.steps || currentCaseData.steps.length === 0) {
        document.getElementById('stepsList').innerHTML = '<div class="card text-center">対応ステップがありません</div>';
        return;
      }
      
      let html = '<ul class="step-list">';
      
      currentCaseData.steps.forEach((step, index) => {
        const stateClass = step.state === 'completed' ? 'completed' : 
                          step.state === 'inProgress' ? 'inProgress' : '';
        
        html += `
          <li class="step-item ${stateClass}">
            <div class="step-header">
              <div class="step-name">${step.stepName}</div>
              <span class="step-state state-${step.state}">
                ${getStateText(step.state)}
              </span>
            </div>
            
            <div class="step-info">
              ${step.assignedToName ? `<span>担当: ${step.assignedToName}</span>` : '<span>担当: 未割当</span>'}
              ${step.dueDate ? `<span>期限: ${formatDate(step.dueDate)}</span>` : ''}
            </div>
            
            ${step.stateChangedBy ? `
              <div style="margin-top: 0.5rem; padding: 0.5rem; background: #e8f5e9; border-radius: 4px; font-size: 0.85rem;">
                <strong>最終更新:</strong> ${step.stateChangedBy} (${formatDateTime(step.stateChangedAt || step.updatedAt)})
              </div>
            ` : ''}
            
            ${step.comments ? `
              <div style="margin-top: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px; font-size: 0.9rem;">
                <strong>コメント:</strong><br>${step.comments}
              </div>
            ` : ''}
            
            <div class="step-controls">
              <button onclick="updateStepState(${index}, 'notStarted')" class="btn btn-secondary btn-small">未着手</button>
              <button onclick="updateStepState(${index}, 'inProgress')" class="btn btn-primary btn-small">対応中</button>
              <button onclick="updateStepState(${index}, 'completed')" class="btn btn-success btn-small">完了</button>
              <button onclick="openEditStepModal(${index})" class="btn btn-secondary btn-small">詳細編集</button>
            </div>
            
            ${step.updatedAt ? `
              <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #999;">
                最終更新: ${formatDateTime(step.updatedAt)}
              </div>
            ` : ''}
          </li>
        `;
      });
      
      html += '</ul>';
      document.getElementById('stepsList').innerHTML = html;
    }

    async function updateStepState(index, newState) {
      try {
        const steps = [...currentCaseData.steps];
        const userName = currentUserData.displayName || currentUserData.email;
        
        // 担当者が未割当の場合、または状態を変更した場合に自動設定
        const shouldUpdateAssignment = !steps[index].assignedTo || steps[index].state !== newState;
        
        steps[index] = {
          ...steps[index],
          state: newState,
          updatedAt: new Date(),
          updatedBy: currentUser.uid,
          updatedByName: userName,
          stateChangedAt: new Date(),
          stateChangedBy: userName
        };
        
        // 担当者を自動設定
        if (shouldUpdateAssignment) {
          steps[index].assignedTo = currentUser.uid;
          steps[index].assignedToName = userName;
        }
        
        await db.collection('cases').doc(currentCaseId).update({
          steps: steps,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showAlert('ステップを更新しました');
        loadCase();
      } catch (error) {
        console.error('ステップ更新エラー:', error);
        alert('ステップの更新に失敗しました');
      }
    }

    async function openEditStepModal(index) {
      if (allUsers.length === 0) {
        allUsers = await getAllUsers();
      }
      
      const step = currentCaseData.steps[index];
      
      document.getElementById('editStepIndex').value = index;
      document.getElementById('editStepName').textContent = step.stepName;
      document.getElementById('editAssignedTo').innerHTML = createUserOptions(allUsers, step.assignedTo);
      document.getElementById('editDueDate').value = step.dueDate ? formatDate(step.dueDate).replace(/\//g, '-') : '';
      document.getElementById('editComments').value = step.comments || '';
      
      showModal('editStepModal');
    }

    document.getElementById('editStepForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const index = parseInt(document.getElementById('editStepIndex').value);
      const assignedTo = document.getElementById('editAssignedTo').value;
      const dueDate = document.getElementById('editDueDate').value;
      const comments = document.getElementById('editComments').value;
      
      try {
        const steps = [...currentCaseData.steps];
        
        let assignedToName = '';
        if (assignedTo) {
          const user = allUsers.find(u => u.id === assignedTo);
          assignedToName = user ? (user.displayName || user.email) : '';
        }
        
        steps[index] = {
          ...steps[index],
          assignedTo: assignedTo,
          assignedToName: assignedToName,
          dueDate: dueDate ? dateToTimestamp(dueDate) : null,
          comments: comments,
          updatedAt: new Date(),
          updatedBy: currentUser.uid
        };
        
        await db.collection('cases').doc(currentCaseId).update({
          steps: steps,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showAlert('ステップを更新しました');
        hideModal('editStepModal');
        loadCase();
      } catch (error) {
        console.error('ステップ更新エラー:', error);
        alert('ステップの更新に失敗しました');
      }
    });

    async function toggleCaseStatus() {
      const newStatus = currentCaseData.status === 'inProgress' ? 'completed' : 'inProgress';
      const message = newStatus === 'completed' ? 
        '案件を完了にしますか?' : '案件を進行中に戻しますか?';
      
      if (!confirm(message)) return;
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          status: newStatus,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showAlert(newStatus === 'completed' ? '案件を完了にしました' : '案件を進行中に戻しました');
        loadCase();
      } catch (error) {
        console.error('ステータス更新エラー:', error);
        alert('ステータスの更新に失敗しました');
      }
    }

    function updateStatusButton() {
      const btn = document.getElementById('statusToggleBtn');
      
      btn.style.display = 'block';
      if (currentCaseData.status === 'completed') {
        btn.textContent = '案件を進行中に戻す';
        btn.className = 'btn btn-primary';
      } else {
        btn.textContent = '案件を完了にする';
        btn.className = 'btn btn-success';
      }
    }

    // ========================================
    // 案件情報編集
    // ========================================
    function showEditCaseInfoModal() {
      document.getElementById('editDescription').value = currentCaseData.description || '';
      document.getElementById('editEstimatedCause').value = currentCaseData.estimatedCause || '';
      document.getElementById('editTemporaryMeasures').value = currentCaseData.temporaryMeasures || '';
      showModal('editCaseInfoModal');
    }

    document.getElementById('editCaseInfoForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const description = document.getElementById('editDescription').value;
      const estimatedCause = document.getElementById('editEstimatedCause').value;
      const temporaryMeasures = document.getElementById('editTemporaryMeasures').value;
      
      try {
        const steps = [...currentCaseData.steps];
        const userName = currentUserData.displayName || currentUserData.email;
        const now = new Date();
        
        // 推定原因の調査ステップを更新
        const causeStepIndex = steps.findIndex(s => 
          s.stepName && (s.stepName.includes('原因') || s.stepName.includes('調査') || s.stepName === '推定原因の調査')
        );
        
        if (causeStepIndex !== -1 && estimatedCause) {
          steps[causeStepIndex] = {
            ...steps[causeStepIndex],
            comments: estimatedCause,
            state: 'completed',
            assignedTo: currentUser.uid,
            assignedToName: userName,
            updatedAt: now,
            updatedBy: currentUser.uid,
            updatedByName: userName,
            stateChangedAt: now,
            stateChangedBy: userName
          };
        }
        
        // 暫定対策検討ステップを更新
        const measuresStepIndex = steps.findIndex(s => 
          s.stepName && (s.stepName.includes('対策') || s.stepName.includes('暫定') || s.stepName === '暫定対策検討')
        );
        
        if (measuresStepIndex !== -1 && temporaryMeasures) {
          steps[measuresStepIndex] = {
            ...steps[measuresStepIndex],
            comments: temporaryMeasures,
            state: 'completed',
            assignedTo: currentUser.uid,
            assignedToName: userName,
            updatedAt: now,
            updatedBy: currentUser.uid,
            updatedByName: userName,
            stateChangedAt: now,
            stateChangedBy: userName
          };
        }
        
        await db.collection('cases').doc(currentCaseId).update({
          description: description,
          estimatedCause: estimatedCause,
          temporaryMeasures: temporaryMeasures,
          steps: steps,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showAlert('案件情報を更新しました');
        hideModal('editCaseInfoModal');
        loadCase();
      } catch (error) {
        console.error('案件情報更新エラー:', error);
        alert('案件情報の更新に失敗しました');
      }
    });

    // ========================================
    // まとめてCSV出力
    // ========================================
    function exportCaseSummaryCSV() {
      if (!currentCaseData) {
        alert('案件データが読み込まれていません');
        return;
      }

      try {
        let csvContent = '\uFEFF'; // BOM for Excel UTF-8
        
        // タイトル
        csvContent += '客先不具合対応報告書\n\n';
        
        // 基本情報
        csvContent += '【基本情報】\n';
        csvContent += `案件名,${escapeCsvValue(currentCaseData.caseName)}\n`;
        csvContent += `発生客先,${escapeCsvValue(currentCaseData.customerName)}\n`;
        csvContent += `不具合発生日,${formatDate(currentCaseData.occurredDate)}\n`;
        csvContent += `登録日,${formatDate(currentCaseData.createdAt)}\n`;
        csvContent += '\n';
        
        // 不具合内容
        csvContent += '【不具合内容】\n';
        csvContent += `${escapeCsvValue(currentCaseData.description || 'なし')}\n`;
        csvContent += '\n';
        
        // 推定原因の調査
        csvContent += '【推定原因の調査】\n';
        csvContent += `${escapeCsvValue(currentCaseData.estimatedCause || 'なし')}\n`;
        csvContent += '\n';
        
        // 暫定対策検討
        csvContent += '【暫定対策検討】\n';
        csvContent += `${escapeCsvValue(currentCaseData.temporaryMeasures || 'なし')}\n`;
        csvContent += '\n\n';
        
        // 選別実績
        const locations = currentCaseData.inventoryLocations || [];
        
        if (locations.length > 0) {
          csvContent += '【選別実績】\n\n';
          
          let grandTotalCount = 0;
          let grandTotalNgCount = 0;
          
          locations.forEach((location, locationIndex) => {
            const results = location.inspectionResults || [];
            
            if (results.length === 0) return;
            
            let locationTotalCount = 0;
            let locationTotalNgCount = 0;
            
            results.forEach(result => {
              locationTotalCount += result.count || 0;
              locationTotalNgCount += result.ngCount || 0;
            });
            
            grandTotalCount += locationTotalCount;
            grandTotalNgCount += locationTotalNgCount;
            
            const locationNgRate = locationTotalCount > 0 ? 
              ((locationTotalNgCount / locationTotalCount) * 100).toFixed(2) : '0.00';
            
            csvContent += `在庫場所 ${locationIndex + 1},${escapeCsvValue(location.location)}\n`;
            if (location.customerContact) {
              csvContent += `得意先担当者,${escapeCsvValue(location.customerContact)}\n`;
            }
            if (location.kanban) {
              csvContent += `かんばん情報,${escapeCsvValue(location.kanban)}\n`;
            }
            if (location.instructions) {
              csvContent += `その他指示,${escapeCsvValue(location.instructions)}\n`;
            }
            csvContent += `合計,選別数: ${locationTotalCount} / NG数: ${locationTotalNgCount} / NG率: ${locationNgRate}%\n`;
            csvContent += '\n';
            
            csvContent += 'No,開始時刻,完了時刻,所要時間,便,選別数,NG数,NG率,責任者,備考\n';
            
            results.forEach((result, resultIndex) => {
              const ngRate = result.count > 0 ? 
                ((result.ngCount / result.count) * 100).toFixed(2) : '0.00';
              const duration = calculateDuration(result.startTime, result.endTime);
              
              csvContent += [
                resultIndex + 1,
                escapeCsvValue(formatDateTime(result.startTime)),
                escapeCsvValue(formatDateTime(result.endTime)),
                escapeCsvValue(duration),
                escapeCsvValue(result.shift),
                result.count,
                result.ngCount,
                `${ngRate}%`,
                escapeCsvValue(result.supervisor),
                escapeCsvValue(result.remarks || '')
              ].join(',') + '\n';
            });
            
            csvContent += '\n';
          });
          
          const grandTotalNgRate = grandTotalCount > 0 ? 
            ((grandTotalNgCount / grandTotalCount) * 100).toFixed(2) : '0.00';
          
          csvContent += '【選別実績合計】\n';
          csvContent += `総選別数,${grandTotalCount}\n`;
          csvContent += `総NG数,${grandTotalNgCount}\n`;
          csvContent += `総合NG率,${grandTotalNgRate}%\n`;
          csvContent += `在庫場所数,${locations.length}\n`;
        } else {
          csvContent += '【選別実績】\nなし\n';
        }
        
        // CSVダウンロード
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        const fileName = `不具合対応報告書_${currentCaseData.caseName}_${formatDate(new Date()).replace(/\//g, '')}.csv`;
        
        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAlert('CSVを出力しました');
      } catch (error) {
        console.error('CSV出力エラー:', error);
        alert('CSVの出力に失敗しました: ' + error.message);
      }
    }

    // ========================================
    // 過去履歴管理
    // ========================================
    async function loadHistory() {
      if (!currentUser) return;
      
      document.getElementById('historyList').innerHTML = '<div class="loading">読み込み中...</div>';
      
      try {
        const searchCustomer = document.getElementById('historySearchCustomer').value.toLowerCase();
        
        const snapshot = await db.collection('cases')
          .where('status', '==', 'completed')
          .orderBy('updatedAt', 'desc')
          .get();
        
        const historyCases = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          if (!searchCustomer || data.customerName.toLowerCase().includes(searchCustomer)) {
            historyCases.push({
              id: doc.id,
              ...data
            });
          }
        });
        
        displayHistory(historyCases);
      } catch (error) {
        console.error('過去履歴読み込みエラー:', error);
        document.getElementById('historyList').innerHTML = '<div class="alert alert-error">過去履歴の読み込みに失敗しました</div>';
      }
    }

    function displayHistory(cases) {
      const historyList = document.getElementById('historyList');
      
      if (cases.length === 0) {
        historyList.innerHTML = '<div class="card text-center">完了した案件がありません</div>';
        return;
      }
      
      let html = '<ul class="case-list">';
      
      cases.forEach(caseData => {
        const progress = calculateProgress(caseData.steps || []);
        const completedSteps = (caseData.steps || []).filter(s => s.state === 'completed').length;
        const totalSteps = (caseData.steps || []).length;
        
        html += `
          <li class="case-item" style="cursor: default; opacity: 0.9;">
            <div class="case-header">
              <div class="case-name" onclick="goToCaseDetail('${caseData.id}')" style="cursor: pointer;">${caseData.caseName}</div>
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <span class="status-badge status-completed">完了</span>
                <button onclick="deleteCase('${caseData.id}', '${caseData.caseName}')" class="btn btn-danger btn-small">削除</button>
              </div>
            </div>
            
            <div class="case-info" onclick="goToCaseDetail('${caseData.id}')" style="cursor: pointer;">
              <span>客先: ${caseData.customerName}</span>
              <span>発生日: ${formatDate(caseData.occurredDate)}</span>
              <span>完了日: ${formatDate(caseData.updatedAt)}</span>
              <span>進捗: ${completedSteps}/${totalSteps} 完了</span>
            </div>
            
            <div onclick="goToCaseDetail('${caseData.id}')" style="cursor: pointer;">
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${progress}%; background-color: #27ae60;">
                  ${progress}%
                </div>
              </div>
              
              ${caseData.description ? `<div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">${caseData.description}</div>` : ''}
            </div>
          </li>
        `;
      });
      
      html += '</ul>';
      historyList.innerHTML = html;
    }

    // ========================================
    // 在庫場所と選別実績管理
    // ========================================
    function displayInventoryLocations() {
      const locations = currentCaseData.inventoryLocations || [];
      const locationsList = document.getElementById('inventoryLocationsList');
      
      if (locations.length === 0) {
        locationsList.innerHTML = '<div class="card text-center">在庫場所が登録されていません</div>';
        return;
      }
      
      let html = '';
      let grandTotalCount = 0;
      let grandTotalNgCount = 0;
      
      locations.forEach((location, locationIndex) => {
        const results = location.inspectionResults || [];
        let locationTotalCount = 0;
        let locationTotalNgCount = 0;
        
        results.forEach(result => {
          locationTotalCount += result.count || 0;
          locationTotalNgCount += result.ngCount || 0;
        });
        
        grandTotalCount += locationTotalCount;
        grandTotalNgCount += locationTotalNgCount;
        
        const locationNgRate = locationTotalCount > 0 ? 
          ((locationTotalNgCount / locationTotalCount) * 100).toFixed(2) : '0.00';
        
        html += `
          <div class="card" style="margin-bottom: 1.5rem; ${results.length > 0 ? 'border-left: 4px solid #27ae60;' : ''}">
            <div class="flex-between" style="margin-bottom: 1rem;">
              <div>
                <div style="font-weight: 600; font-size: 1.1rem; margin-bottom: 0.5rem;">${location.location}</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; font-size: 0.85rem; color: #666;">
                  ${location.customerContact ? `<div><strong>得意先担当:</strong> ${location.customerContact}</div>` : ''}
                  ${location.kanban ? `<div><strong>かんばん:</strong> ${location.kanban}</div>` : ''}
                  <div><strong>実績:</strong> ${results.length}件</div>
                </div>
                ${location.instructions ? `
                  <div style="margin-top: 0.5rem; padding: 0.5rem; background: #fff3cd; border-radius: 4px; font-size: 0.85rem;">
                    <strong>指示:</strong> ${location.instructions}
                  </div>
                ` : ''}
              </div>
              <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                <button onclick="openAddInspectionModal(${locationIndex})" class="btn btn-primary btn-small">+ 実績追加</button>
                <button onclick="editLocation(${locationIndex})" class="btn btn-secondary btn-small">編集</button>
                <button onclick="deleteLocation(${locationIndex})" class="btn btn-danger btn-small">削除</button>
              </div>
            </div>
            
            ${results.length > 0 ? `
              <div style="padding: 1rem; background: #f8f9fa; border-radius: 6px; margin-bottom: 1rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                  <div>
                    <div style="font-size: 0.85rem; color: #666;">合計選別数</div>
                    <div style="font-weight: 600; font-size: 1.2rem;">${locationTotalCount.toLocaleString()}</div>
                  </div>
                  <div>
                    <div style="font-size: 0.85rem; color: #666;">合計NG数</div>
                    <div style="font-weight: 600; font-size: 1.2rem; color: #e74c3c;">${locationTotalNgCount.toLocaleString()}</div>
                  </div>
                  <div>
                    <div style="font-size: 0.85rem; color: #666;">NG率</div>
                    <div style="font-weight: 600; font-size: 1.2rem; color: ${parseFloat(locationNgRate) > 1 ? '#e74c3c' : '#27ae60'};">${locationNgRate}%</div>
                  </div>
                </div>
              </div>
            ` : ''}
            
            ${results.length > 0 ? `
              <div style="margin-top: 1rem;">
                <div style="font-weight: 600; margin-bottom: 0.5rem;">選別実績詳細</div>
                ${results.map((result, resultIndex) => {
                  const ngRate = result.count > 0 ? 
                    ((result.ngCount / result.count) * 100).toFixed(2) : '0.00';
                  const duration = calculateDuration(result.startTime, result.endTime);
                  
                  return `
                    <div style="background: white; padding: 1rem; border-radius: 4px; margin-bottom: 0.5rem; border: 1px solid #dee2e6;">
                      <div class="flex-between" style="margin-bottom: 0.5rem;">
                        <div style="font-weight: 600;">実績 #${resultIndex + 1}</div>
                        <div style="display: flex; gap: 0.5rem;">
                          <button onclick="editInspectionResult(${locationIndex}, ${resultIndex})" class="btn btn-secondary btn-small">編集</button>
                          <button onclick="deleteInspectionResult(${locationIndex}, ${resultIndex})" class="btn btn-danger btn-small">削除</button>
                        </div>
                      </div>
                      
                      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; font-size: 0.85rem;">
                        <div><span style="color: #666;">開始:</span> ${formatDateTime(result.startTime)}</div>
                        <div><span style="color: #666;">完了:</span> ${formatDateTime(result.endTime)}</div>
                        <div><span style="color: #666;">所要:</span> ${duration}</div>
                        <div><span style="color: #666;">便:</span> ${result.shift}</div>
                        <div><span style="color: #666;">選別数:</span> <strong>${result.count.toLocaleString()}</strong></div>
                        <div><span style="color: #666;">NG数:</span> <strong style="color: #e74c3c;">${result.ngCount.toLocaleString()}</strong></div>
                        <div><span style="color: #666;">NG率:</span> <strong style="color: ${parseFloat(ngRate) > 1 ? '#e74c3c' : '#27ae60'};">${ngRate}%</strong></div>
                        <div><span style="color: #666;">責任者:</span> ${result.supervisor}</div>
                      </div>
                      
                      ${result.remarks ? `
                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; font-size: 0.85rem;">
                          ${result.remarks}
                        </div>
                      ` : ''}
                      
                      ${result.photos && result.photos.length > 0 ? `
                        <div style="margin-top: 0.5rem;">
                          <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.3rem;">添付写真:</div>
                          <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${result.photos.map(photo => `
                              <a href="${photo.url}" target="_blank">
                                <img src="${photo.url}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 2px solid #ddd; cursor: pointer;">
                              </a>
                            `).join('')}
                          </div>
                        </div>
                      ` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            ` : '<div style="text-align: center; color: #999; padding: 1rem;">選別実績なし</div>'}
          </div>
        `;
      });
      
      // 全体サマリー
      const grandTotalNgRate = grandTotalCount > 0 ? 
        ((grandTotalNgCount / grandTotalCount) * 100).toFixed(2) : '0.00';
      
      html = `
        <div class="card" style="background: #e3f2fd; margin-bottom: 1.5rem;">
          <div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 1.1rem;">全体サマリー</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
            <div>
              <div style="font-size: 0.85rem; color: #666;">総選別数</div>
              <div style="font-weight: 600; font-size: 1.4rem;">${grandTotalCount.toLocaleString()}</div>
            </div>
            <div>
              <div style="font-size: 0.85rem; color: #666;">総NG数</div>
              <div style="font-weight: 600; font-size: 1.4rem; color: #e74c3c;">${grandTotalNgCount.toLocaleString()}</div>
            </div>
            <div>
              <div style="font-size: 0.85rem; color: #666;">総合NG率</div>
              <div style="font-weight: 600; font-size: 1.4rem; color: ${parseFloat(grandTotalNgRate) > 1 ? '#e74c3c' : '#27ae60'};">${grandTotalNgRate}%</div>
            </div>
            <div>
              <div style="font-size: 0.85rem; color: #666;">在庫場所数</div>
              <div style="font-weight: 600; font-size: 1.4rem;">${locations.length} 箇所</div>
            </div>
          </div>
        </div>
      ` + html;
      
      locationsList.innerHTML = html;
    }

    function calculateDuration(startTime, endTime) {
      if (!startTime || !endTime) return '-';
      
      const start = startTime.toDate ? startTime.toDate() : new Date(startTime);
      const end = endTime.toDate ? endTime.toDate() : new Date(endTime);
      
      const diffMs = end - start;
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
      
      return `${diffHours}時間${diffMinutes}分`;
    }

    // 在庫場所追加
    document.getElementById('addLocationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const locationName = document.getElementById('newLocationName').value;
      const customerContact = document.getElementById('newLocationCustomerContact').value;
      const kanban = document.getElementById('newLocationKanban').value;
      const instructions = document.getElementById('newLocationInstructions').value;
      
      try {
        const locations = currentCaseData.inventoryLocations || [];
        locations.push({
          id: `loc_${Date.now()}`,
          location: locationName,
          customerContact: customerContact,
          kanban: kanban,
          instructions: instructions,
          inspectionResults: []
        });
        
        await db.collection('cases').doc(currentCaseId).update({
          inventoryLocations: locations,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showAlert('在庫場所を追加しました');
        hideModal('addLocationModal');
        document.getElementById('addLocationForm').reset();
        loadCase();
      } catch (error) {
        console.error('在庫場所追加エラー:', error);
        alert('在庫場所の追加に失敗しました');
      }
    });

    // 在庫場所編集
    async function editLocation(index) {
      const location = currentCaseData.inventoryLocations[index];
      
      document.getElementById('editLocationIndex').value = index;
      document.getElementById('editLocationName').value = location.location;
      document.getElementById('editLocationCustomerContact').value = location.customerContact || '';
      document.getElementById('editLocationKanban').value = location.kanban || '';
      document.getElementById('editLocationInstructions').value = location.instructions || '';
      
      showModal('editLocationModal');
    }

    document.getElementById('editLocationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const index = parseInt(document.getElementById('editLocationIndex').value);
      const locationName = document.getElementById('editLocationName').value;
      const customerContact = document.getElementById('editLocationCustomerContact').value;
      const kanban = document.getElementById('editLocationKanban').value;
      const instructions = document.getElementById('editLocationInstructions').value;
      
      try {
        const locations = [...currentCaseData.inventoryLocations];
        locations[index] = {
          ...locations[index],
          location: locationName,
          customerContact: customerContact,
          kanban: kanban,
          instructions: instructions
        };
        
        await db.collection('cases').doc(currentCaseId).update({
          inventoryLocations: locations,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showAlert('在庫場所を更新しました');
        hideModal('editLocationModal');
        loadCase();
      } catch (error) {
        console.error('在庫場所更新エラー:', error);
        alert('在庫場所の更新に失敗しました');
      }
    });

    // 在庫場所削除
    async function deleteLocation(index) {
      const location = currentCaseData.inventoryLocations[index];
      const resultsCount = location.inspectionResults ? location.inspectionResults.length : 0;
      
      let confirmMessage = `在庫場所「${location.location}」を削除しますか?`;
      if (resultsCount > 0) {
        confirmMessage += `\n\n※ ${resultsCount}件の選別実績も削除されます`;
      }
      
      if (!confirm(confirmMessage)) {
        return;
      }
      
      try {
        const locations = [...currentCaseData.inventoryLocations];
        locations.splice(index, 1);
        
        await db.collection('cases').doc(currentCaseId).update({
          inventoryLocations: locations,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showAlert('在庫場所を削除しました');
        loadCase();
      } catch (error) {
        console.error('在庫場所削除エラー:', error);
        alert('在庫場所の削除に失敗しました');
      }
    }

    // 選別実績追加モーダルを開く
    function openAddInspectionModal(locationIndex) {
      const location = currentCaseData.inventoryLocations[locationIndex];
      
      document.getElementById('inspectionLocationIndex').value = locationIndex;
      document.getElementById('addInspectionModalTitle').textContent = '選別実績追加';
      document.getElementById('inspectionLocationName').textContent = location.location;
      
      showModal('addInspectionModal');
    }

    // 選別実績追加
    document.getElementById('addInspectionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const locationIndex = parseInt(document.getElementById('inspectionLocationIndex').value);
      const startTime = document.getElementById('inspectionStartTime').value;
      const endTime = document.getElementById('inspectionEndTime').value;
      const shift = document.getElementById('inspectionShift').value;
      const count = parseInt(document.getElementById('inspectionCount').value);
      const ngCount = parseInt(document.getElementById('inspectionNgCount').value);
      const supervisor = document.getElementById('inspectionSupervisor').value;
      const remarks = document.getElementById('inspectionRemarks').value;
      
      try {
        // 写真をアップロード
        const photoFiles = document.getElementById('inspectionPhotos').files;
        let photoUrls = [];
        
        if (photoFiles.length > 0) {
          showAlert('写真をアップロード中...');
          photoUrls = await uploadPhotos(Array.from(photoFiles), `inspections/${currentCaseId}/${Date.now()}`);
        }
        
        const locations = [...currentCaseData.inventoryLocations];
        locations[locationIndex].inspectionResults.push({
          startTime: dateToTimestamp(startTime),
          endTime: dateToTimestamp(endTime),
          shift: shift,
          count: count,
          ngCount: ngCount,
          supervisor: supervisor,
          remarks: remarks,
          photos: photoUrls,
          createdBy: currentUser.uid,
          createdByName: currentUserData.displayName || currentUserData.email,
          createdAt: new Date()
        });
        
        await db.collection('cases').doc(currentCaseId).update({
          inventoryLocations: locations,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showAlert('選別実績を追加しました');
        hideModal('addInspectionModal');
        document.getElementById('addInspectionForm').reset();
        document.getElementById('inspectionPhotoPreview').innerHTML = '';
        loadCase();
      } catch (error) {
        console.error('選別実績追加エラー:', error);
        alert('選別実績の追加に失敗しました');
      }
    });

    // 選別実績編集
    function editInspectionResult(locationIndex, resultIndex) {
      const location = currentCaseData.inventoryLocations[locationIndex];
      const result = location.inspectionResults[resultIndex];
      
      document.getElementById('editInspectionLocationIndex').value = locationIndex;
      document.getElementById('editInspectionIndex').value = resultIndex;
      document.getElementById('editInspectionLocationName').textContent = location.location;
      document.getElementById('editInspectionStartTime').value = formatDateTimeForInput(result.startTime);
      document.getElementById('editInspectionEndTime').value = formatDateTimeForInput(result.endTime);
      document.getElementById('editInspectionShift').value = result.shift;
      document.getElementById('editInspectionCount').value = result.count;
      document.getElementById('editInspectionNgCount').value = result.ngCount;
      document.getElementById('editInspectionSupervisor').value = result.supervisor;
      document.getElementById('editInspectionRemarks').value = result.remarks || '';
      
      showModal('editInspectionModal');
    }

    document.getElementById('editInspectionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const locationIndex = parseInt(document.getElementById('editInspectionLocationIndex').value);
      const resultIndex = parseInt(document.getElementById('editInspectionIndex').value);
      const startTime = document.getElementById('editInspectionStartTime').value;
      const endTime = document.getElementById('editInspectionEndTime').value;
      const shift = document.getElementById('editInspectionShift').value;
      const count = parseInt(document.getElementById('editInspectionCount').value);
      const ngCount = parseInt(document.getElementById('editInspectionNgCount').value);
      const supervisor = document.getElementById('editInspectionSupervisor').value;
      const remarks = document.getElementById('editInspectionRemarks').value;
      
      try {
        const locations = [...currentCaseData.inventoryLocations];
        locations[locationIndex].inspectionResults[resultIndex] = {
          ...locations[locationIndex].inspectionResults[resultIndex],
          startTime: dateToTimestamp(startTime),
          endTime: dateToTimestamp(endTime),
          shift: shift,
          count: count,
          ngCount: ngCount,
          supervisor: supervisor,
          remarks: remarks,
          updatedBy: currentUser.uid,
          updatedByName: currentUserData.displayName || currentUserData.email,
          updatedAt: new Date()
        };
        
        await db.collection('cases').doc(currentCaseId).update({
          inventoryLocations: locations,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showAlert('選別実績を更新しました');
        hideModal('editInspectionModal');
        loadCase();
      } catch (error) {
        console.error('選別実績更新エラー:', error);
        alert('選別実績の更新に失敗しました');
      }
    });

    // 選別実績削除
    async function deleteInspectionResult(locationIndex, resultIndex) {
      if (!confirm('この選別実績を削除しますか?')) {
        return;
      }
      
      try {
        const locations = [...currentCaseData.inventoryLocations];
        locations[locationIndex].inspectionResults.splice(resultIndex, 1);
        
        await db.collection('cases').doc(currentCaseId).update({
          inventoryLocations: locations,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showAlert('選別実績を削除しました');
        loadCase();
      } catch (error) {
        console.error('選別実績削除エラー:', error);
        alert('選別実績の削除に失敗しました');
      }
    }

    function formatDateTimeForInput(timestamp) {
      if (!timestamp) return '';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // ========================================
    // CSV出力機能
    // ========================================
    function exportInspectionsCSV() {
      if (!currentCaseData) {
        alert('案件データが読み込まれていません');
        return;
      }

      const locations = currentCaseData.inventoryLocations || [];
      
      if (locations.length === 0) {
        alert('選別実績がありません');
        return;
      }

      try {
        // CSVデータを作成
        let csvContent = '\uFEFF'; // BOM for Excel UTF-8
        
        // ヘッダー情報
        csvContent += '選別実績報告書\n';
        csvContent += `案件名,${escapeCsvValue(currentCaseData.caseName)}\n`;
        csvContent += `客先名,${escapeCsvValue(currentCaseData.customerName)}\n`;
        csvContent += `発生日,${formatDate(currentCaseData.occurredDate)}\n`;
        csvContent += `出力日,${formatDate(new Date())}\n`;
        csvContent += '\n';

        // 全体サマリー
        let grandTotalCount = 0;
        let grandTotalNgCount = 0;
        
        locations.forEach(location => {
          const results = location.inspectionResults || [];
          results.forEach(result => {
            grandTotalCount += result.count || 0;
            grandTotalNgCount += result.ngCount || 0;
          });
        });

        const grandTotalNgRate = grandTotalCount > 0 ? 
          ((grandTotalNgCount / grandTotalCount) * 100).toFixed(2) : '0.00';

        csvContent += '【全体サマリー】\n';
        csvContent += `総選別数,${grandTotalCount}\n`;
        csvContent += `総NG数,${grandTotalNgCount}\n`;
        csvContent += `総合NG率,${grandTotalNgRate}%\n`;
        csvContent += `在庫場所数,${locations.length}\n`;
        csvContent += '\n\n';

        // 各在庫場所の選別実績
        locations.forEach((location, locationIndex) => {
          const results = location.inspectionResults || [];
          
          if (results.length === 0) return; // 実績がない場所はスキップ

          // 場所ごとの合計
          let locationTotalCount = 0;
          let locationTotalNgCount = 0;
          
          results.forEach(result => {
            locationTotalCount += result.count || 0;
            locationTotalNgCount += result.ngCount || 0;
          });

          const locationNgRate = locationTotalCount > 0 ? 
            ((locationTotalNgCount / locationTotalCount) * 100).toFixed(2) : '0.00';

          // 在庫場所情報
          csvContent += `【在庫場所 ${locationIndex + 1}】,${escapeCsvValue(location.location)}\n`;
          if (location.customerContact) {
            csvContent += `得意先担当者,${escapeCsvValue(location.customerContact)}\n`;
          }
          if (location.kanban) {
            csvContent += `かんばん情報,${escapeCsvValue(location.kanban)}\n`;
          }
          if (location.instructions) {
            csvContent += `その他指示,${escapeCsvValue(location.instructions)}\n`;
          }
          csvContent += `合計選別数,${locationTotalCount}\n`;
          csvContent += `合計NG数,${locationTotalNgCount}\n`;
          csvContent += `NG率,${locationNgRate}%\n`;
          csvContent += '\n';

          // 選別実績テーブルヘッダー
          csvContent += 'No,開始時刻,完了時刻,所要時間,便,選別数,NG数,NG率,責任者,備考\n';

          // 選別実績データ
          results.forEach((result, resultIndex) => {
            const ngRate = result.count > 0 ? 
              ((result.ngCount / result.count) * 100).toFixed(2) : '0.00';
            const duration = calculateDuration(result.startTime, result.endTime);

            csvContent += [
              resultIndex + 1,
              escapeCsvValue(formatDateTime(result.startTime)),
              escapeCsvValue(formatDateTime(result.endTime)),
              escapeCsvValue(duration),
              escapeCsvValue(result.shift),
              result.count,
              result.ngCount,
              `${ngRate}%`,
              escapeCsvValue(result.supervisor),
              escapeCsvValue(result.remarks || '')
            ].join(',') + '\n';
          });

          csvContent += '\n';
        });

        // CSVファイルとしてダウンロード
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        const fileName = `選別実績_${currentCaseData.caseName}_${formatDate(new Date()).replace(/\//g, '')}.csv`;
        
        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAlert('CSVを出力しました');
      } catch (error) {
        console.error('CSV出力エラー:', error);
        alert('CSVの出力に失敗しました: ' + error.message);
      }
    }

    // CSV用のエスケープ処理
    function escapeCsvValue(value) {
      if (value === null || value === undefined) return '';
      
      const stringValue = String(value);
      
      // ダブルクォート、カンマ、改行が含まれる場合はダブルクォートで囲む
      if (stringValue.includes('"') || stringValue.includes(',') || stringValue.includes('\n')) {
        return '"' + stringValue.replace(/"/g, '""') + '"';
      }
      
      return stringValue;
    }

    // ========================================
    // 管理画面
    // ========================================
    async function loadStandardSteps() {
      document.getElementById('standardStepsList').innerHTML = '<div class="loading">読み込み中...</div>';
      
      try {
        const snapshot = await db.collection('standardSteps')
          .orderBy('order')
          .get();
        
        standardSteps = [];
        snapshot.forEach(doc => {
          standardSteps.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        displayStandardSteps();
      } catch (error) {
        console.error('標準ステップ読み込みエラー:', error);
        document.getElementById('standardStepsList').innerHTML = '<div class="alert alert-error">標準ステップの読み込みに失敗しました</div>';
      }
    }

    function displayStandardSteps() {
      const stepsList = document.getElementById('standardStepsList');
      
      if (standardSteps.length === 0) {
        stepsList.innerHTML = '<div class="card text-center">標準ステップがありません。まずはステップを追加してください。</div>';
        return;
      }
      
      let html = '';
      
      standardSteps.forEach((step, index) => {
        html += `
          <div class="step-item-admin">
            <div class="step-order">${index + 1}</div>
            <div class="step-content">
              <div style="font-weight: 600; margin-bottom: 0.3rem;">${step.stepName}</div>
              ${step.description ? `<div style="font-size: 0.85rem; color: #666;">${step.description}</div>` : ''}
            </div>
            <div class="step-actions">
              ${index > 0 ? `<button onclick="moveStep(${index}, -1)" class="btn btn-secondary btn-small">↑</button>` : ''}
              ${index < standardSteps.length - 1 ? `<button onclick="moveStep(${index}, 1)" class="btn btn-secondary btn-small">↓</button>` : ''}
              <button onclick="editStandardStep('${step.id}')" class="btn btn-primary btn-small">編集</button>
              <button onclick="deleteStep('${step.id}', '${step.stepName}')" class="btn btn-danger btn-small">削除</button>
            </div>
          </div>
        `;
      });
      
      stepsList.innerHTML = html;
    }

    document.getElementById('newStepForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const stepName = document.getElementById('stepName').value;
      const stepDescription = document.getElementById('stepDescription').value;
      
      try {
        const maxOrder = standardSteps.length > 0 ? 
          Math.max(...standardSteps.map(s => s.order || 0)) : 0;
        
        await db.collection('standardSteps').add({
          stepName: stepName,
          description: stepDescription,
          order: maxOrder + 1,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showAlert('ステップを追加しました');
        hideModal('newStepModal');
        document.getElementById('newStepForm').reset();
        loadStandardSteps();
      } catch (error) {
        console.error('ステップ追加エラー:', error);
        alert('ステップの追加に失敗しました');
      }
    });

    function editStandardStep(stepId) {
      const step = standardSteps.find(s => s.id === stepId);
      if (!step) return;
      
      document.getElementById('editStandardStepId').value = stepId;
      document.getElementById('editStandardStepName').value = step.stepName;
      document.getElementById('editStandardStepDescription').value = step.description || '';
      
      showModal('editStandardStepModal');
    }

    document.getElementById('editStandardStepForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const stepId = document.getElementById('editStandardStepId').value;
      const stepName = document.getElementById('editStandardStepName').value;
      const stepDescription = document.getElementById('editStandardStepDescription').value;
      
      try {
        await db.collection('standardSteps').doc(stepId).update({
          stepName: stepName,
          description: stepDescription,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showAlert('ステップを更新しました');
        hideModal('editStandardStepModal');
        loadStandardSteps();
      } catch (error) {
        console.error('ステップ更新エラー:', error);
        alert('ステップの更新に失敗しました');
      }
    });

    async function deleteStep(stepId, stepName) {
      if (!confirm(`「${stepName}」を削除しますか?\n\n※既存の案件には影響しません`)) {
        return;
      }
      
      try {
        await db.collection('standardSteps').doc(stepId).delete();
        showAlert('ステップを削除しました');
        loadStandardSteps();
      } catch (error) {
        console.error('ステップ削除エラー:', error);
        alert('ステップの削除に失敗しました');
      }
    }

    async function moveStep(index, direction) {
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= standardSteps.length) return;
      
      try {
        const batch = db.batch();
        
        const step1 = standardSteps[index];
        const step2 = standardSteps[newIndex];
        
        batch.update(db.collection('standardSteps').doc(step1.id), {
          order: step2.order
        });
        
        batch.update(db.collection('standardSteps').doc(step2.id), {
          order: step1.order
        });
        
        await batch.commit();
        loadStandardSteps();
      } catch (error) {
        console.error('順序変更エラー:', error);
        alert('順序の変更に失敗しました');
      }
    }

    async function loadUsersForAdmin() {
      try {
        const users = await getAllUsers();
        displayUsersForAdmin(users);
      } catch (error) {
        console.error('ユーザー読み込みエラー:', error);
        document.getElementById('usersList').innerHTML = '<div class="alert alert-error">ユーザーの読み込みに失敗しました</div>';
      }
    }

    function displayUsersForAdmin(users) {
      const usersList = document.getElementById('usersList');
      
      if (users.length === 0) {
        usersList.innerHTML = '<div class="card text-center">ユーザーがいません</div>';
        return;
      }
      
      let html = '<div class="card">';
      html += '<table style="width: 100%; border-collapse: collapse;">';
      html += '<thead><tr style="border-bottom: 2px solid #dee2e6;">';
      html += '<th style="padding: 0.5rem; text-align: left;">表示名</th>';
      html += '<th style="padding: 0.5rem; text-align: left;">メールアドレス</th>';
      html += '<th style="padding: 0.5rem; text-align: left;">権限</th>';
      html += '<th style="padding: 0.5rem; text-align: left;">操作</th>';
      html += '</tr></thead>';
      html += '<tbody>';
      
      users.forEach(user => {
        html += `<tr style="border-bottom: 1px solid #dee2e6;">`;
        html += `<td style="padding: 0.5rem;">${user.displayName || '-'}</td>`;
        html += `<td style="padding: 0.5rem;">${user.email}</td>`;
        html += `<td style="padding: 0.5rem;">${user.role === 'admin' ? '管理者' : '一般'}</td>`;
        html += `<td style="padding: 0.5rem;">`;
        
        if (user.id !== currentUser.uid) {
          if (user.role === 'admin') {
            html += `<button onclick="changeUserRole('${user.id}', 'user')" class="btn btn-secondary btn-small">一般に変更</button>`;
          } else {
            html += `<button onclick="changeUserRole('${user.id}', 'admin')" class="btn btn-primary btn-small">管理者に変更</button>`;
          }
        } else {
          html += '<span style="color: #666; font-size: 0.85rem;">自分自身</span>';
        }
        
        html += `</td>`;
        html += `</tr>`;
      });
      
      html += '</tbody></table>';
      html += '</div>';
      
      usersList.innerHTML = html;
    }

    async function changeUserRole(userId, newRole) {
      const roleText = newRole === 'admin' ? '管理者' : '一般ユーザー';
      
      if (!confirm(`このユーザーを${roleText}に変更しますか?`)) {
        return;
      }
      
      try {
        await db.collection('users').doc(userId).update({
          role: newRole,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showAlert(`${roleText}に変更しました`);
        loadUsersForAdmin();
      } catch (error) {
        console.error('権限変更エラー:', error);
        alert('権限の変更に失敗しました');
      }
    }
  </script>
</body>
</html>
