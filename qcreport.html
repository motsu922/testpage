<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®¢å…ˆä¸å…·åˆç®¡ç†</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.5;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    header {
      background: #2c3e50;
      color: white;
      padding: 0.75rem 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 1.2rem;
      font-weight: 600;
    }

    nav {
      display: flex;
      gap: 0.5rem;
    }

    nav button {
      background: none;
      border: none;
      color: white;
      padding: 0.4rem 0.8rem;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.85rem;
      transition: background 0.2s;
    }

    nav button:hover {
      background: rgba(255,255,255,0.1);
    }

    nav button.active {
      background: rgba(255,255,255,0.2);
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem;
    }

    /* ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ */
    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    /* ã‚«ãƒ¼ãƒ‰ */
    .card {
      background: white;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* ãƒœã‚¿ãƒ³ */
    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
    }

    .btn-secondary {
      background: #95a5a6;
      color: white;
    }

    .btn-secondary:hover {
      background: #7f8c8d;
    }

    .btn-small {
      padding: 0.3rem 0.6rem;
      font-size: 0.8rem;
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    /* ã‚°ãƒªãƒƒãƒ‰ */
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ  */
    input, textarea, select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
      font-family: inherit;
    }

    label {
      display: block;
      margin-bottom: 0.3rem;
      font-size: 0.85rem;
      font-weight: 600;
      color: #555;
    }

    .form-group {
      margin-bottom: 0.75rem;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      margin: 2rem;
    }

    .modal-header {
      padding: 1rem;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-body {
      padding: 1rem;
    }

    .modal-footer {
      padding: 1rem;
      border-top: 1px solid #eee;
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th, td {
      padding: 0.5rem;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #555;
    }

    tr:hover {
      background: #f8f9fa;
    }

    /* ã‚¿ãƒ– */
    .tabs {
      display: flex;
      gap: 0.5rem;
      border-bottom: 2px solid #eee;
      margin-bottom: 1rem;
    }

    .tab {
      padding: 0.5rem 1rem;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 0.9rem;
      color: #666;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .tab:hover {
      color: #3498db;
    }

    .tab.active {
      color: #3498db;
      border-bottom-color: #3498db;
      font-weight: 600;
    }

    /* ãƒãƒƒã‚¸ */
    .badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 3px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-success {
      background: #d4edda;
      color: #155724;
    }

    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }

    /* ã‚¢ãƒ©ãƒ¼ãƒˆ */
    .alert {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: 0.75rem 1rem;
      background: #2c3e50;
      color: white;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 2000;
      animation: slideIn 0.3s;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
      }
      to {
        transform: translateX(0);
      }
    }

    /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .text-right {
      text-align: right;
    }

    .text-center {
      text-align: center;
    }

    .mb-1 {
      margin-bottom: 1rem;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 768px) {
      .grid-2, .grid-3 {
        grid-template-columns: 1fr;
      }
      
      .modal-content {
        width: 95%;
        margin: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
  <div id="loginPage" class="page active">
    <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
      <div class="card" style="max-width: 400px; width: 90%; padding: 2rem;">
        <h2 style="text-align: center; margin-bottom: 1.5rem;">å®¢å…ˆä¸å…·åˆç®¡ç†</h2>
        <form id="loginForm">
          <div class="form-group">
            <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input type="email" id="loginEmail" required>
          </div>
          <div class="form-group">
            <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" id="loginPassword" required>
          </div>
          <button type="submit" class="btn btn-primary" style="width: 100%;">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </form>
      </div>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª -->
  <div id="mainApp" class="page">
    <header>
      <div class="header-content">
        <h1>å®¢å…ˆä¸å…·åˆç®¡ç†</h1>
        <nav>
          <button onclick="showPage('dashboardPage')" class="active">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
          <button onclick="showPage('casesPage')">éå»ã®æ¡ˆä»¶</button>
          <button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </nav>
      </div>
    </header>

    <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ -->
    <div id="dashboardPage" class="page active">
      <div class="container">
        <div class="flex-between mb-1">
          <h2 style="font-size: 1.3rem;">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
          <div style="display: flex; gap: 0.5rem;">
            <button onclick="showModal('newCaseModal')" class="btn btn-primary">+ æ–°è¦æ¡ˆä»¶</button>
            <button onclick="showModal('stepTemplateModal')" class="btn btn-secondary btn-small">ã‚¹ãƒ†ãƒƒãƒ—ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†</button>
            <button onclick="exportSummaryReport()" class="btn btn-secondary btn-small">ğŸ“Š é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›</button>
          </div>
        </div>
        
        <!-- æœªå®Œäº†é …ç›®ãƒªã‚¹ãƒˆ -->
        <div class="grid-2 mb-1" style="align-items: start;">
          <!-- æœªå®Œäº†ã‚¹ãƒ†ãƒƒãƒ— -->
          <div class="card">
            <h3 style="font-size: 1.1rem; margin-bottom: 0.75rem; color: #e74c3c;">âš ï¸ æœªå®Œäº†ã‚¹ãƒ†ãƒƒãƒ—</h3>
            <div id="incompleteSteps"></div>
          </div>

          <!-- æœªå®Œäº†é¸åˆ¥ -->
          <div class="card">
            <h3 style="font-size: 1.1rem; margin-bottom: 0.75rem; color: #f39c12;">ğŸ“‹ é¸åˆ¥æœªå®Œäº†</h3>
            <div id="incompleteInspections"></div>
          </div>
        </div>

        <!-- æ¡ˆä»¶ä¸€è¦§ -->
        <div class="card">
          <h3 style="margin-bottom: 0.75rem; font-size: 1.1rem;">å¯¾å¿œä¸­ã®æ¡ˆä»¶</h3>
          <div id="dashCasesList"></div>
        </div>
      </div>
    </div>

    <!-- æ¡ˆä»¶ä¸€è¦§ãƒšãƒ¼ã‚¸ï¼ˆéå»ã®æ¡ˆä»¶ï¼‰ -->
    <div id="casesPage" class="page">
      <div class="container">
        <div class="flex-between mb-1">
          <h2 style="font-size: 1.3rem;">éå»ã®æ¡ˆä»¶</h2>
          <div style="display: flex; gap: 0.5rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
              <input type="checkbox" id="showCompletedCases" onchange="loadCases()" style="width: auto;">
              å®Œäº†æ¡ˆä»¶ã‚‚è¡¨ç¤º
            </label>
          </div>
        </div>
        <div id="casesList"></div>
      </div>
    </div>

    <!-- æ¡ˆä»¶è©³ç´°ãƒšãƒ¼ã‚¸ -->
    <div id="caseDetailPage" class="page">
      <div class="container">
        <button onclick="showPage('dashboardPage')" class="btn btn-secondary btn-small mb-1">â† æˆ»ã‚‹</button>
        
        <!-- 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
        <div class="grid-2" style="align-items: start;">
          <!-- å·¦: æ¡ˆä»¶æƒ…å ± + é€£çµ¡äº‹é … -->
          <div>
            <!-- æ¡ˆä»¶æƒ…å ± -->
            <div class="card mb-1">
              <div class="flex-between mb-1">
                <h3 style="font-size: 1.1rem;">æ¡ˆä»¶æƒ…å ±</h3>
                <div style="display: flex; gap: 0.5rem;">
                  <button onclick="toggleCaseStatus()" id="caseStatusBtn" class="btn btn-small">å®Œäº†ã«ã™ã‚‹</button>
                  <button onclick="showModal('editCaseModal')" class="btn btn-secondary btn-small">ç·¨é›†</button>
                </div>
              </div>
              <div id="caseInfo"></div>
            </div>

            <!-- é€£çµ¡äº‹é …ï¼ˆæ—§ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒ¼ãƒ‰ï¼‰ -->
            <div class="card">
              <div class="flex-between mb-1">
                <h3 style="font-size: 1.1rem;">ğŸ“¢ é€£çµ¡äº‹é …</h3>
                <button onclick="saveWhiteboard()" class="btn btn-primary btn-small">ä¿å­˜</button>
              </div>
              
              <textarea id="whiteboardText" 
                        style="width: 100%; min-height: 200px; padding: 0.75rem; border: 2px solid #ddd; border-radius: 6px; font-family: inherit; font-size: 0.9rem; margin-bottom: 0.75rem;"
                        placeholder="é€£çµ¡äº‹é …ã‚„é‡è¦ãªãƒ¡ãƒ¢ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„...

ä¾‹:
- å¯¾ç­–ä¼šè­°ã®æ±ºå®šäº‹é …
- é¡§å®¢ã‹ã‚‰ã®è¦æœ›ãƒ»æŒ‡æ‘˜
- æ¬¡å›ç¢ºèªäº‹é …
- æ³¨æ„ç‚¹ãƒ»ç”³ã—é€ã‚Šäº‹é …"></textarea>
              
              <div style="margin-bottom: 0.75rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 600;">ğŸ“ æ·»ä»˜å†™çœŸãƒ»è³‡æ–™</label>
                <input type="file" id="whiteboardPhotos" accept="image/*" multiple style="margin-bottom: 0.5rem; font-size: 0.85rem;">
                <button onclick="uploadWhiteboardPhotos()" class="btn btn-secondary btn-small">å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
              </div>
              
              <div id="whiteboardPhotosList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.75rem;"></div>
            </div>
          </div>

          <!-- å³: ã‚¹ãƒ†ãƒƒãƒ—é€²æ— -->
          <div class="card">
            <h3 style="font-size: 1.1rem; margin-bottom: 0.75rem;">å¯¾å¿œçŠ¶æ³</h3>
            <div id="stepsProgress"></div>
          </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–ã‚¨ãƒªã‚¢ -->
        <div class="card">
          <div class="tabs" style="border-bottom: 2px solid #eee;">
            <button class="tab active" onclick="switchMainTab('inspection')">é¸åˆ¥å®Ÿç¸¾</button>
            <button class="tab" onclick="switchMainTab('steps')">ã‚¹ãƒ†ãƒƒãƒ—ç®¡ç†</button>
          </div>

          <!-- é¸åˆ¥å®Ÿç¸¾ã‚¿ãƒ– -->
          <div id="inspectionTab" class="tab-content" style="display: block;">
            <div class="flex-between mb-1" style="margin-top: 1rem;">
              <h3 style="font-size: 1.1rem;">é¸åˆ¥å®Ÿç¸¾</h3>
              <button onclick="showModal('addLocationModal')" class="btn btn-primary btn-small">+ åœ¨åº«å ´æ‰€è¿½åŠ </button>
            </div>
            
            <div class="tabs" id="locationTabs"></div>
            <div id="locationContent"></div>
          </div>

          <!-- ã‚¹ãƒ†ãƒƒãƒ—ç®¡ç†ã‚¿ãƒ– -->
          <div id="stepsTab" class="tab-content" style="display: none; margin-top: 1rem;">
            <div class="flex-between mb-1">
              <h3 style="font-size: 1.1rem;">å¯¾å¿œã‚¹ãƒ†ãƒƒãƒ—</h3>
              <button onclick="addStep()" class="btn btn-primary btn-small">+ ã‚¹ãƒ†ãƒƒãƒ—è¿½åŠ </button>
            </div>
            <div id="stepsList"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ–°è¦æ¡ˆä»¶ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="newCaseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>æ–°è¦æ¡ˆä»¶ç™»éŒ²</h3>
        <button onclick="hideModal('newCaseModal')" class="btn btn-secondary btn-small">âœ•</button>
      </div>
      <form id="newCaseForm">
        <div class="modal-body">
          <div class="form-group">
            <label>æ¡ˆä»¶å *</label>
            <input type="text" id="caseName" required>
          </div>
          <div class="form-group">
            <label>å¾—æ„å…ˆå *</label>
            <input type="text" id="customerName" required>
          </div>
          <div class="form-group">
            <label>ç™ºç”Ÿæ—¥ *</label>
            <input type="date" id="occurredDate" required>
          </div>
          <div class="form-group">
            <label>ä¸å…·åˆå†…å®¹</label>
            <textarea id="description" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label>å¯¾è±¡æ•´ç†Noï¼ˆè¤‡æ•°å¯ã€Enterã§è¿½åŠ ï¼‰</label>
            <input type="text" id="serialNumberInput" placeholder="ä¾‹: A-001">
            <div id="serialNumbersList" style="display: flex; flex-wrap: wrap; gap: 0.3rem; margin-top: 0.5rem;"></div>
          </div>
          <div class="form-group">
            <label>å†™çœŸï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
            <input type="file" id="casePhotos" accept="image/*" multiple>
            <div id="casePhotoPreview" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;"></div>
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="useStepTemplate" style="width: auto; margin-right: 0.5rem;">
              åŸºæœ¬ã‚¹ãƒ†ãƒƒãƒ—ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" onclick="hideModal('newCaseModal')" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ã‚¹ãƒ†ãƒƒãƒ—ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="stepTemplateModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ã‚¹ãƒ†ãƒƒãƒ—ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†</h3>
        <button onclick="hideModal('stepTemplateModal')" class="btn btn-secondary btn-small">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="mb-1">
          <h4 style="font-size: 1rem; margin-bottom: 0.5rem;">åŸºæœ¬ã‚¹ãƒ†ãƒƒãƒ—</h4>
          <div id="stepTemplateList"></div>
        </div>
        <div style="border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1rem;">
          <h4 style="font-size: 1rem; margin-bottom: 0.5rem;">æ–°ã—ã„ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ </h4>
          <div class="form-group">
            <label>ã‚¹ãƒ†ãƒƒãƒ—å</label>
            <input type="text" id="newStepTitle" placeholder="ä¾‹: åŸå› èª¿æŸ»">
          </div>
          <div class="form-group">
            <label>èª¬æ˜ï¼ˆä»»æ„ï¼‰</label>
            <input type="text" id="newStepDescription" placeholder="ä¾‹: ä¸å…·åˆã®åŸå› ã‚’ç‰¹å®šã™ã‚‹">
          </div>
          <button onclick="addStepToTemplate()" class="btn btn-primary btn-small">è¿½åŠ </button>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="hideModal('stepTemplateModal')" class="btn btn-secondary">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- åœ¨åº«å ´æ‰€è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="addLocationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>åœ¨åº«å ´æ‰€è¿½åŠ </h3>
        <button onclick="hideModal('addLocationModal')" class="btn btn-secondary btn-small">âœ•</button>
      </div>
      <form id="addLocationForm">
        <div class="modal-body">
          <div class="form-group">
            <label>åœ¨åº«å ´æ‰€ *</label>
            <input type="text" id="locationName" required placeholder="ä¾‹: å€‰åº«A">
          </div>
          <div class="form-group">
            <label>ã‹ã‚“ã°ã‚“</label>
            <input type="text" id="locationKanban" placeholder="ä¾‹: K-12345">
          </div>
          <div class="form-group">
            <label>æ‹…å½“è€…</label>
            <input type="text" id="locationContact">
          </div>
          <div class="form-group">
            <label>ãƒ¡ãƒ¢</label>
            <textarea id="locationMemo" rows="3" placeholder="ä¾‹: å·¥ç¨‹æƒ…å ±ã€æ³¨æ„äº‹é …ãªã©"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" onclick="hideModal('addLocationModal')" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="submit" class="btn btn-primary">è¿½åŠ </button>
        </div>
      </form>
    </div>
  </div>

  <!-- åœ¨åº«å ´æ‰€ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="editLocationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>åœ¨åº«å ´æ‰€ç·¨é›†</h3>
        <button onclick="hideModal('editLocationModal')" class="btn btn-secondary btn-small">âœ•</button>
      </div>
      <form id="editLocationForm">
        <div class="modal-body">
          <input type="hidden" id="editLocationIndex">
          <div class="form-group">
            <label>åœ¨åº«å ´æ‰€ *</label>
            <input type="text" id="editLocationName" required placeholder="ä¾‹: å€‰åº«A">
          </div>
          <div class="form-group">
            <label>ã‹ã‚“ã°ã‚“</label>
            <input type="text" id="editLocationKanban" placeholder="ä¾‹: K-12345">
          </div>
          <div class="form-group">
            <label>æ‹…å½“è€…</label>
            <input type="text" id="editLocationContact">
          </div>
          <div class="form-group">
            <label>ãƒ¡ãƒ¢</label>
            <textarea id="editLocationMemo" rows="3" placeholder="ä¾‹: å·¥ç¨‹æƒ…å ±ã€æ³¨æ„äº‹é …ãªã©"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" onclick="hideModal('editLocationModal')" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <!-- é¸åˆ¥å®Ÿç¸¾è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="addInspectionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>é¸åˆ¥å®Ÿç¸¾è¿½åŠ </h3>
        <button onclick="hideModal('addInspectionModal')" class="btn btn-secondary btn-small">âœ•</button>
      </div>
      <form id="addInspectionForm">
        <div class="modal-body">
          <input type="hidden" id="inspectionLocationIndex">
          
          <div class="grid-2">
            <div class="form-group">
              <label>é–‹å§‹æ™‚åˆ»</label>
              <input type="datetime-local" id="inspectionStartTime">
            </div>
            <div class="form-group">
              <label>å®Œäº†æ™‚åˆ»</label>
              <input type="datetime-local" id="inspectionEndTime">
            </div>
          </div>

          <div class="form-group">
            <label>ã‹ã‚“ã°ã‚“ï¼ˆä¾¿ï¼‰</label>
            <input type="text" id="inspectionKanban">
          </div>

          <div class="form-group">
            <label>é¸åˆ¥ã—ãŸæ•´ç†Noï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
            <div id="inspectionSerialNumbers" style="max-height: 120px; overflow-y: auto; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;"></div>
          </div>

          <div class="grid-2">
            <div class="form-group">
              <label>é¸åˆ¥æ•° *</label>
              <input type="number" id="inspectionCount" required min="0">
            </div>
            <div class="form-group">
              <label>NGæ•° *</label>
              <input type="number" id="inspectionNgCount" required min="0">
            </div>
          </div>

          <div class="form-group">
            <label>è²¬ä»»è€…</label>
            <input type="text" id="inspectionSupervisor">
          </div>

          <div class="form-group">
            <label>å†™çœŸï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
            <input type="file" id="inspectionPhotos" accept="image/*" multiple>
            <div id="inspectionPhotoPreview" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" onclick="hideModal('addInspectionModal')" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="submit" class="btn btn-primary">è¿½åŠ </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <script>
    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCr2A0kYdlJsCKnJhGXwEDViu2Ae08yKJc",
      authDomain: "qckyouyu.firebaseapp.com",
      projectId: "qckyouyu",
      storageBucket: "qckyouyu.firebasestorage.app",
      messagingSenderId: "884065987840",
      appId: "1:884065987840:web:2b12cc1204e484b999d7e5"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    let currentUser = null;
    let currentCaseId = null;
    let currentCaseData = null;
    let allCases = [];
    let serialNumbers = [];
    let selectedLocationIndex = 0;
    let stepTemplate = [];

    // å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    document.addEventListener('DOMContentLoaded', () => {
      // é¸åˆ¥å®Ÿç¸¾å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      const photoInput = document.getElementById('inspectionPhotos');
      if (photoInput) {
        photoInput.addEventListener('change', (e) => {
          const preview = document.getElementById('inspectionPhotoPreview');
          preview.innerHTML = '';
          
          Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
              const img = document.createElement('img');
              img.src = e.target.result;
              img.style.width = '80px';
              img.style.height = '80px';
              img.style.objectFit = 'cover';
              img.style.borderRadius = '4px';
              img.style.border = '2px solid #ddd';
              preview.appendChild(img);
            };
            reader.readAsDataURL(file);
          });
        });
      }

      // æ¡ˆä»¶å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      const casePhotoInput = document.getElementById('casePhotos');
      if (casePhotoInput) {
        casePhotoInput.addEventListener('change', (e) => {
          const preview = document.getElementById('casePhotoPreview');
          preview.innerHTML = '';
          
          Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
              const img = document.createElement('img');
              img.src = e.target.result;
              img.style.width = '80px';
              img.style.height = '80px';
              img.style.objectFit = 'cover';
              img.style.borderRadius = '4px';
              img.style.border = '2px solid #ddd';
              preview.appendChild(img);
            };
            reader.readAsDataURL(file);
          });
        });
      }

      // ã‚¹ãƒ†ãƒƒãƒ—ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
      loadStepTemplate();
    });

    // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢æ•°
    async function uploadPhotos(files, path) {
      const urls = [];
      
      for (const file of files) {
        const storageRef = storage.ref(`${path}/${Date.now()}_${file.name}`);
        await storageRef.put(file);
        const url = await storageRef.getDownloadURL();
        urls.push({ url, name: file.name, uploadedAt: new Date() });
      }
      
      return urls;
    }

    // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        document.getElementById('loginPage').classList.remove('active');
        document.getElementById('mainApp').classList.add('active');
        loadDashboard(); // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æœ€åˆã«èª­ã¿è¾¼ã¿
      } else {
        currentUser = null;
        document.getElementById('loginPage').classList.add('active');
        document.getElementById('mainApp').classList.remove('active');
      }
    });

    // ãƒ­ã‚°ã‚¤ãƒ³
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (error) {
        alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    });

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    function logout() {
      auth.signOut();
    }

    // ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchMainTab(tabName) {
      // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹
      document.querySelectorAll('#caseDetailPage .tabs .tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
      document.getElementById('inspectionTab').style.display = tabName === 'inspection' ? 'block' : 'none';
      document.getElementById('stepsTab').style.display = tabName === 'steps' ? 'block' : 'none';
      
      // ã‚¹ãƒ†ãƒƒãƒ—ã‚¿ãƒ–ã‚’é–‹ã„ãŸã¨ãã«ã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒ­ãƒ¼ãƒ‰
      if (tabName === 'steps') {
        loadSteps();
      }
    }

    // ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
    function showPage(pageId) {
      document.querySelectorAll('#mainApp .page').forEach(p => p.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
      
      // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
      if (pageId === 'casesPage' || pageId === 'dashboardPage') {
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        const buttons = document.querySelectorAll('nav button');
        if (pageId === 'dashboardPage' && buttons[0]) buttons[0].classList.add('active');
        if (pageId === 'casesPage' && buttons[1]) buttons[1].classList.add('active');
      }
      
      if (pageId === 'casesPage') loadCases();
      if (pageId === 'dashboardPage') loadDashboard();
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º/éè¡¨ç¤º
    function showModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function hideModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
    function showAlert(message) {
      const alert = document.createElement('div');
      alert.className = 'alert';
      alert.textContent = message;
      document.body.appendChild(alert);
      setTimeout(() => alert.remove(), 3000);
    }

    // æ•´ç†Noç®¡ç†
    document.getElementById('serialNumberInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addSerialNumber();
      }
    });

    function addSerialNumber() {
      const input = document.getElementById('serialNumberInput');
      const value = input.value.trim();
      
      if (value && !serialNumbers.includes(value)) {
        serialNumbers.push(value);
        input.value = '';
        displaySerialNumbers();
      }
    }

    function displaySerialNumbers() {
      const list = document.getElementById('serialNumbersList');
      list.innerHTML = serialNumbers.map(sn => `
        <span class="badge badge-success" style="cursor: pointer;" onclick="removeSerialNumber('${sn}')">
          ${sn} âœ•
        </span>
      `).join('');
    }

    function removeSerialNumber(sn) {
      serialNumbers = serialNumbers.filter(s => s !== sn);
      displaySerialNumbers();
    }

    // æ–°è¦æ¡ˆä»¶ç™»éŒ²
    document.getElementById('newCaseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      try {
        // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        const photoFiles = document.getElementById('casePhotos').files;
        let photoUrls = [];
        
        if (photoFiles.length > 0) {
          showAlert('å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');
          photoUrls = await uploadPhotos(Array.from(photoFiles), `cases/${Date.now()}`);
        }

        // ã‚¹ãƒ†ãƒƒãƒ—ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé©ç”¨
        let steps = [];
        if (document.getElementById('useStepTemplate').checked) {
          steps = stepTemplate.map(step => ({
            ...step,
            completed: false,
            createdAt: new Date()
          }));
        }
        
        await db.collection('cases').add({
          caseName: document.getElementById('caseName').value,
          customerName: document.getElementById('customerName').value,
          occurredDate: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('occurredDate').value)),
          description: document.getElementById('description').value,
          targetSerialNumbers: serialNumbers,
          photos: photoUrls,
          steps: steps,
          status: 'inProgress',
          inventoryLocations: [],
          createdBy: currentUser.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showAlert('æ¡ˆä»¶ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
        hideModal('newCaseModal');
        document.getElementById('newCaseForm').reset();
        document.getElementById('casePhotoPreview').innerHTML = '';
        serialNumbers = [];
        displaySerialNumbers();
        loadCases();
      } catch (error) {
        alert('ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    });

    // æ¡ˆä»¶ä¸€è¦§èª­ã¿è¾¼ã¿ï¼ˆéå»ã®æ¡ˆä»¶ï¼‰
    async function loadCases() {
      try {
        const showCompleted = document.getElementById('showCompletedCases').checked;
        
        let query = db.collection('cases').orderBy('updatedAt', 'desc');
        
        if (!showCompleted) {
          query = query.where('status', '==', 'inProgress');
        }
        
        const snapshot = await query.get();
        
        allCases = [];
        snapshot.forEach(doc => {
          allCases.push({ id: doc.id, ...doc.data() });
        });
        
        displayCases();
      } catch (error) {
        console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // æ¡ˆä»¶ä¸€è¦§è¡¨ç¤º
    function displayCases() {
      const list = document.getElementById('casesList');
      
      if (allCases.length === 0) {
        list.innerHTML = '<div class="card text-center" style="color: #999;">æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      list.innerHTML = allCases.map(c => {
        let totalCount = 0;
        let totalNG = 0;
        
        (c.inventoryLocations || []).forEach(loc => {
          (loc.inspectionResults || []).forEach(r => {
            totalCount += r.count || 0;
            totalNG += r.ngCount || 0;
          });
        });
        
        const ngRate = totalCount > 0 ? ((totalNG / totalCount) * 100).toFixed(2) : '0.00';
        const statusBadge = c.status === 'completed' 
          ? '<span class="badge badge-success">å®Œäº†</span>' 
          : '<span class="badge badge-warning">å¯¾å¿œä¸­</span>';
        
        return `
          <div class="card" style="cursor: pointer; ${c.status === 'completed' ? 'opacity: 0.7;' : ''}" onclick="openCase('${c.id}')">
            <div class="flex-between">
              <div>
                <h3 style="font-size: 1rem; margin-bottom: 0.3rem;">${c.caseName} ${statusBadge}</h3>
                <div style="font-size: 0.8rem; color: #666;">
                  ${c.customerName} | 
                  ${c.occurredDate ? new Date(c.occurredDate.seconds * 1000).toLocaleDateString('ja-JP') : ''}
                </div>
              </div>
              <div class="text-right">
                <div style="font-size: 0.8rem; color: #666;">é¸åˆ¥æ•°: <strong>${totalCount.toLocaleString()}</strong></div>
                <div style="font-size: 0.8rem; color: #666;">NGç‡: <strong style="color: ${parseFloat(ngRate) > 1 ? '#e74c3c' : '#27ae60'};">${ngRate}%</strong></div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // æ¡ˆä»¶è©³ç´°ã‚’é–‹ã
    async function openCase(caseId) {
      currentCaseId = caseId;
      
      try {
        const doc = await db.collection('cases').doc(caseId).get();
        currentCaseData = { id: doc.id, ...doc.data() };
        
        displayCaseDetail();
        showPage('caseDetailPage');
      } catch (error) {
        alert('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }

    // æ¡ˆä»¶è©³ç´°è¡¨ç¤º
    function displayCaseDetail() {
      // å®Œäº†ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
      const statusBtn = document.getElementById('caseStatusBtn');
      if (statusBtn) {
        if (currentCaseData.status === 'completed') {
          statusBtn.textContent = 'æœªå®Œäº†ã«æˆ»ã™';
          statusBtn.className = 'btn btn-secondary btn-small';
        } else {
          statusBtn.textContent = 'å®Œäº†ã«ã™ã‚‹';
          statusBtn.className = 'btn btn-primary btn-small';
        }
      }

      // æ¡ˆä»¶æƒ…å ±
      const statusBadge = currentCaseData.status === 'completed' 
        ? '<span class="badge badge-success" style="font-size: 0.9rem;">âœ“ å®Œäº†</span>' 
        : '<span class="badge badge-warning" style="font-size: 0.9rem;">å¯¾å¿œä¸­</span>';
      
      const info = `
        <div style="display: grid; gap: 0.5rem; font-size: 0.85rem;">
          <div><strong>æ¡ˆä»¶å:</strong> ${currentCaseData.caseName} ${statusBadge}</div>
          <div><strong>å¾—æ„å…ˆ:</strong> ${currentCaseData.customerName}</div>
          <div><strong>ç™ºç”Ÿæ—¥:</strong> ${currentCaseData.occurredDate ? new Date(currentCaseData.occurredDate.seconds * 1000).toLocaleDateString('ja-JP') : ''}</div>
          ${currentCaseData.description ? `<div style="margin-top: 0.5rem; padding: 0.5rem; background: #fff3cd; border-radius: 4px;"><strong>å†…å®¹:</strong> ${currentCaseData.description}</div>` : ''}
          ${currentCaseData.targetSerialNumbers && currentCaseData.targetSerialNumbers.length > 0 ? `
            <div style="margin-top: 0.5rem;">
              <strong>æ•´ç†No:</strong>
              ${currentCaseData.targetSerialNumbers.map(sn => `<span class="badge badge-success">${sn}</span>`).join(' ')}
            </div>
          ` : ''}
        </div>
      `;
      document.getElementById('caseInfo').innerHTML = info;
      
      // é€²æ—çŠ¶æ³ï¼ˆç°¡æ˜“ç‰ˆï¼‰
      const locations = currentCaseData.inventoryLocations || [];
      let totalCount = 0;
      let totalNG = 0;
      
      locations.forEach(loc => {
        (loc.inspectionResults || []).forEach(r => {
          totalCount += r.count || 0;
          totalNG += r.ngCount || 0;
        });
      });
      
      const ngRate = totalCount > 0 ? ((totalNG / totalCount) * 100).toFixed(2) : '0.00';
      
      const progress = `
        <div style="display: grid; gap: 0.5rem;">
          <div class="card" style="background: #e8f5e9; padding: 0.5rem;">
            <div style="font-size: 0.75rem; color: #666;">é¸åˆ¥æ•°</div>
            <div style="font-size: 1.3rem; font-weight: bold; color: #2e7d32;">${totalCount.toLocaleString()}</div>
          </div>
          <div class="card" style="background: #ffebee; padding: 0.5rem;">
            <div style="font-size: 0.75rem; color: #666;">NGæ•°</div>
            <div style="font-size: 1.3rem; font-weight: bold; color: #c62828;">${totalNG.toLocaleString()}</div>
          </div>
          <div class="card" style="background: #e3f2fd; padding: 0.5rem;">
            <div style="font-size: 0.75rem; color: #666;">NGç‡</div>
            <div style="font-size: 1.3rem; font-weight: bold; color: #1565c0;">${ngRate}%</div>
          </div>
        </div>
      `;
      document.getElementById('stepsProgress').innerHTML = progress;
      
      // åœ¨åº«å ´æ‰€ã‚¿ãƒ–
      displayLocationTabs();
      
      // é€£çµ¡äº‹é …ï¼ˆæ—§ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒ¼ãƒ‰ï¼‰ã‚’ãƒ­ãƒ¼ãƒ‰ - å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ãŸã‚æœ€åˆã«èª­ã¿è¾¼ã‚€
      loadWhiteboard();
      
      // ã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒ­ãƒ¼ãƒ‰
      loadSteps();
    }

    // åœ¨åº«å ´æ‰€ã‚¿ãƒ–è¡¨ç¤º
    function displayLocationTabs() {
      const locations = currentCaseData.inventoryLocations || [];
      const tabs = document.getElementById('locationTabs');
      
      if (locations.length === 0) {
        tabs.innerHTML = '';
        document.getElementById('locationContent').innerHTML = '<div class="text-center" style="color: #999; padding: 2rem;">åœ¨åº«å ´æ‰€ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
        return;
      }
      
      tabs.innerHTML = locations.map((loc, i) => `
        <button class="tab ${i === selectedLocationIndex ? 'active' : ''}" onclick="selectLocation(${i})">
          ${loc.location}
        </button>
      `).join('');
      
      displayLocationContent();
    }

    // åœ¨åº«å ´æ‰€é¸æŠ
    function selectLocation(index) {
      selectedLocationIndex = index;
      displayLocationTabs();
    }

    // åœ¨åº«å ´æ‰€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤º
    function displayLocationContent() {
      const location = currentCaseData.inventoryLocations[selectedLocationIndex];
      const results = location.inspectionResults || [];
      const isCompleted = location.completed || false;
      
      let html = `
        <div style="margin-bottom: 0.75rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: ${isCompleted ? '#e8f5e9' : '#f8f9fa'}; border-radius: 4px;">
            <div style="font-size: 0.85rem;">
              ${location.kanban ? `ã‹ã‚“ã°ã‚“: <strong>${location.kanban}</strong> | ` : ''}
              ${location.customerContact ? `æ‹…å½“: <strong>${location.customerContact}</strong> | ` : ''}
              å®Ÿç¸¾: <strong>${results.length}ä»¶</strong>
              ${isCompleted ? ' | <span style="color: #2e7d32; font-weight: bold;">âœ“ å®Œäº†</span>' : ''}
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button onclick="toggleLocationStatus()" class="btn ${isCompleted ? 'btn-secondary' : 'btn-primary'} btn-small">
                ${isCompleted ? 'æœªå®Œäº†ã«æˆ»ã™' : 'å®Œäº†ã«ã™ã‚‹'}
              </button>
              <button onclick="openEditLocation()" class="btn btn-secondary btn-small">ç·¨é›†</button>
              <button onclick="openAddInspection()" class="btn btn-primary btn-small">+ å®Ÿç¸¾è¿½åŠ </button>
            </div>
          </div>
          ${location.memo ? `
            <div style="margin-top: 0.5rem; padding: 0.5rem; background: #fffbf0; border-left: 3px solid #ffc107; border-radius: 4px; font-size: 0.85rem;">
              <strong>ğŸ“ ãƒ¡ãƒ¢:</strong> ${location.memo}
            </div>
          ` : ''}
        </div>
      `;
      
      if (results.length > 0) {
        html += `
          <table>
            <thead>
              <tr>
                <th>No</th>
                <th>æ•´ç†No</th>
                <th>æ™‚åˆ»</th>
                <th>ã‹ã‚“ã°ã‚“</th>
                <th class="text-right">é¸åˆ¥æ•°</th>
                <th class="text-right">NGæ•°</th>
                <th class="text-right">NGç‡</th>
                <th>è²¬ä»»è€…</th>
                <th>å†™çœŸ</th>
                <th class="text-center">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${results.map((r, i) => {
                const ngRate = r.count > 0 ? ((r.ngCount / r.count) * 100).toFixed(2) : '0.00';
                const time = r.startTime && r.endTime ? 
                  `${formatTime(r.startTime)}-${formatTime(r.endTime)}` :
                  r.startTime ? formatTime(r.startTime) : '-';
                
                return `
                  <tr>
                    <td>#${i + 1}</td>
                    <td>${(r.serialNumbers || []).map(sn => `<span class="badge badge-success">${sn}</span>`).join(' ') || '-'}</td>
                    <td>${time}</td>
                    <td>${r.kanban || '-'}</td>
                    <td class="text-right"><strong>${r.count.toLocaleString()}</strong></td>
                    <td class="text-right"><strong style="color: #e74c3c;">${r.ngCount.toLocaleString()}</strong></td>
                    <td class="text-right"><strong style="color: ${parseFloat(ngRate) > 1 ? '#e74c3c' : '#27ae60'};">${ngRate}%</strong></td>
                    <td>${r.supervisor || '-'}</td>
                    <td>
                      ${r.photos && r.photos.length > 0 ? `
                        <button onclick="showPhotos(${selectedLocationIndex}, ${i})" class="btn btn-secondary btn-small">ğŸ“· ${r.photos.length}</button>
                      ` : '-'}
                    </td>
                    <td class="text-center">
                      <button onclick="deleteInspection(${i})" class="btn btn-danger btn-small">å‰Šé™¤</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
      } else {
        html += '<div class="text-center" style="color: #999; padding: 2rem;">å®Ÿç¸¾ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      }
      
      document.getElementById('locationContent').innerHTML = html;
    }

    // åœ¨åº«å ´æ‰€è¿½åŠ 
    document.getElementById('addLocationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const newLocation = {
        location: document.getElementById('locationName').value,
        kanban: document.getElementById('locationKanban').value || '',
        customerContact: document.getElementById('locationContact').value || '',
        memo: document.getElementById('locationMemo').value || '',
        inspectionResults: []
      };
      
      const locations = [...(currentCaseData.inventoryLocations || [])];
      locations.push(newLocation);
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          inventoryLocations: locations,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.inventoryLocations = locations;
        selectedLocationIndex = locations.length - 1;
        
        showAlert('åœ¨åº«å ´æ‰€ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        hideModal('addLocationModal');
        document.getElementById('addLocationForm').reset();
        displayLocationTabs();
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    });

    // å®Ÿç¸¾è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openAddInspection() {
      document.getElementById('inspectionLocationIndex').value = selectedLocationIndex;
      
      // æ•´ç†Noãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
      const serialNos = currentCaseData.targetSerialNumbers || [];
      const container = document.getElementById('inspectionSerialNumbers');
      
      if (serialNos.length === 0) {
        container.innerHTML = '<div style="color: #999; font-size: 0.85rem;">æ•´ç†NoãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
      } else {
        container.innerHTML = serialNos.map(sn => `
          <label style="display: block; padding: 0.3rem; cursor: pointer;">
            <input type="checkbox" name="inspectionSerialNo" value="${sn}" style="width: auto; margin-right: 0.5rem;">
            ${sn}
          </label>
        `).join('');
      }
      
      // ã‹ã‚“ã°ã‚“æƒ…å ±ã‚’ãƒ—ãƒªãƒ•ã‚£ãƒ«
      const location = currentCaseData.inventoryLocations[selectedLocationIndex];
      if (location.kanban) {
        document.getElementById('inspectionKanban').value = location.kanban;
      }
      
      showModal('addInspectionModal');
    }

    // å®Ÿç¸¾è¿½åŠ 
    document.getElementById('addInspectionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const locationIndex = parseInt(document.getElementById('inspectionLocationIndex').value);
      const selectedSerialNos = Array.from(document.querySelectorAll('input[name="inspectionSerialNo"]:checked'))
        .map(cb => cb.value);
      
      try {
        // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        const photoFiles = document.getElementById('inspectionPhotos').files;
        let photoUrls = [];
        
        if (photoFiles.length > 0) {
          showAlert('å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');
          photoUrls = await uploadPhotos(Array.from(photoFiles), `inspections/${currentCaseId}/${Date.now()}`);
        }
        
        const newResult = {
          startTime: document.getElementById('inspectionStartTime').value ? 
            firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('inspectionStartTime').value)) : null,
          endTime: document.getElementById('inspectionEndTime').value ?
            firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('inspectionEndTime').value)) : null,
          kanban: document.getElementById('inspectionKanban').value || '',
          serialNumbers: selectedSerialNos,
          count: parseInt(document.getElementById('inspectionCount').value),
          ngCount: parseInt(document.getElementById('inspectionNgCount').value),
          supervisor: document.getElementById('inspectionSupervisor').value || '',
          photos: photoUrls,
          createdBy: currentUser.uid,
          createdAt: firebase.firestore.Timestamp.now()
        };
        
        const locations = [...currentCaseData.inventoryLocations];
        locations[locationIndex].inspectionResults.push(newResult);
        
        await db.collection('cases').doc(currentCaseId).update({
          inventoryLocations: locations,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.inventoryLocations = locations;
        
        showAlert('å®Ÿç¸¾ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        hideModal('addInspectionModal');
        document.getElementById('addInspectionForm').reset();
        document.getElementById('inspectionPhotoPreview').innerHTML = '';
        displayLocationContent();
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    });

    // å®Ÿç¸¾å‰Šé™¤
    async function deleteInspection(index) {
      if (!confirm('ã“ã®å®Ÿç¸¾ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) return;
      
      const locations = [...currentCaseData.inventoryLocations];
      locations[selectedLocationIndex].inspectionResults.splice(index, 1);
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          inventoryLocations: locations,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.inventoryLocations = locations;
        
        showAlert('å®Ÿç¸¾ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        displayLocationContent();
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }

    // æ¡ˆä»¶ã®å®Œäº†/æœªå®Œäº†åˆ‡ã‚Šæ›¿ãˆ
    async function toggleCaseStatus() {
      const newStatus = currentCaseData.status === 'completed' ? 'inProgress' : 'completed';
      const message = newStatus === 'completed' ? 'ã“ã®æ¡ˆä»¶ã‚’å®Œäº†ã«ã—ã¾ã™ã‹?' : 'ã“ã®æ¡ˆä»¶ã‚’æœªå®Œäº†ã«æˆ»ã—ã¾ã™ã‹?';
      
      if (!confirm(message)) return;
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          status: newStatus,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.status = newStatus;
        showAlert(newStatus === 'completed' ? 'æ¡ˆä»¶ã‚’å®Œäº†ã«ã—ã¾ã—ãŸ' : 'æ¡ˆä»¶ã‚’æœªå®Œäº†ã«æˆ»ã—ã¾ã—ãŸ');
        displayCaseDetail();
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }

    // åœ¨åº«å ´æ‰€ã®å®Œäº†/æœªå®Œäº†åˆ‡ã‚Šæ›¿ãˆ
    async function toggleLocationStatus() {
      const locations = [...currentCaseData.inventoryLocations];
      const currentStatus = locations[selectedLocationIndex].completed || false;
      const newStatus = !currentStatus;
      
      const message = newStatus ? 'ã“ã®åœ¨åº«å ´æ‰€ã®é¸åˆ¥ã‚’å®Œäº†ã«ã—ã¾ã™ã‹?' : 'ã“ã®åœ¨åº«å ´æ‰€ã®é¸åˆ¥ã‚’æœªå®Œäº†ã«æˆ»ã—ã¾ã™ã‹?';
      
      if (!confirm(message)) return;
      
      locations[selectedLocationIndex].completed = newStatus;
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          inventoryLocations: locations,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.inventoryLocations = locations;
        showAlert(newStatus ? 'é¸åˆ¥ã‚’å®Œäº†ã«ã—ã¾ã—ãŸ' : 'é¸åˆ¥ã‚’æœªå®Œäº†ã«æˆ»ã—ã¾ã—ãŸ');
        displayLocationContent();
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }

    // åœ¨åº«å ´æ‰€ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openEditLocation() {
      const location = currentCaseData.inventoryLocations[selectedLocationIndex];
      
      document.getElementById('editLocationIndex').value = selectedLocationIndex;
      document.getElementById('editLocationName').value = location.location || '';
      document.getElementById('editLocationKanban').value = location.kanban || '';
      document.getElementById('editLocationContact').value = location.customerContact || '';
      document.getElementById('editLocationMemo').value = location.memo || '';
      
      showModal('editLocationModal');
    }

    // åœ¨åº«å ´æ‰€ç·¨é›†
    document.getElementById('editLocationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const locationIndex = parseInt(document.getElementById('editLocationIndex').value);
      const locations = [...currentCaseData.inventoryLocations];
      
      locations[locationIndex].location = document.getElementById('editLocationName').value;
      locations[locationIndex].kanban = document.getElementById('editLocationKanban').value || '';
      locations[locationIndex].customerContact = document.getElementById('editLocationContact').value || '';
      locations[locationIndex].memo = document.getElementById('editLocationMemo').value || '';
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          inventoryLocations: locations,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.inventoryLocations = locations;
        
        showAlert('åœ¨åº«å ´æ‰€ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        hideModal('editLocationModal');
        displayLocationTabs();
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    });

    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
    async function loadDashboard() {
      try {
        const snapshot = await db.collection('cases')
          .where('status', '==', 'inProgress')
          .get();
        
        const incompleteStepsList = [];
        const incompleteInspectionsList = [];
        const cases = [];
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const caseId = doc.id;
          const caseName = data.caseName || '';
          
          // æœªå®Œäº†ã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒã‚§ãƒƒã‚¯
          const steps = data.steps || [];
          const incompleteSteps = steps.filter(step => !step.completed);
          if (incompleteSteps.length > 0) {
            incompleteStepsList.push({
              caseId: caseId,
              caseName: caseName,
              steps: incompleteSteps
            });
          }
          
          // æœªå®Œäº†é¸åˆ¥ã‚’ãƒã‚§ãƒƒã‚¯
          const locations = data.inventoryLocations || [];
          locations.forEach(location => {
            if (!location.completed) {
              incompleteInspectionsList.push({
                caseId: caseId,
                caseName: caseName,
                location: location.location,
                contact: location.customerContact || ''
              });
            }
          });
          
          // æ¡ˆä»¶æƒ…å ±ã‚’åé›†
          let caseCount = 0;
          let caseNG = 0;
          
          locations.forEach(loc => {
            (loc.inspectionResults || []).forEach(r => {
              caseCount += r.count || 0;
              caseNG += r.ngCount || 0;
            });
          });
          
          cases.push({
            id: caseId,
            ...data,
            totalCount: caseCount,
            totalNG: caseNG
          });
        });
        
        // æœªå®Œäº†ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤º
        const stepsContainer = document.getElementById('incompleteSteps');
        if (incompleteStepsList.length === 0) {
          stepsContainer.innerHTML = '<div style="color: #27ae60; font-size: 0.9rem; padding: 1rem; text-align: center;">âœ“ ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå®Œäº†ã—ã¦ã„ã¾ã™</div>';
        } else {
          stepsContainer.innerHTML = incompleteStepsList.map(item => `
            <div style="padding: 0.75rem; border-left: 3px solid #e74c3c; background: #fff5f5; margin-bottom: 0.5rem; border-radius: 4px; cursor: pointer;" onclick="openCase('${item.caseId}')">
              <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.3rem;">${item.caseName}</div>
              <div style="font-size: 0.85rem; color: #666;">
                æœªå®Œäº†: ${item.steps.map(s => s.title).join(', ')}
              </div>
            </div>
          `).join('');
        }
        
        // æœªå®Œäº†é¸åˆ¥è¡¨ç¤º
        const inspectionsContainer = document.getElementById('incompleteInspections');
        if (incompleteInspectionsList.length === 0) {
          inspectionsContainer.innerHTML = '<div style="color: #27ae60; font-size: 0.9rem; padding: 1rem; text-align: center;">âœ“ ã™ã¹ã¦ã®é¸åˆ¥ãŒå®Œäº†ã—ã¦ã„ã¾ã™</div>';
        } else {
          inspectionsContainer.innerHTML = incompleteInspectionsList.map(item => `
            <div style="padding: 0.75rem; border-left: 3px solid #f39c12; background: #fffaf0; margin-bottom: 0.5rem; border-radius: 4px; cursor: pointer;" onclick="openCase('${item.caseId}')">
              <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.3rem;">æ¡ˆä»¶: ${item.caseName}</div>
              <div style="font-size: 0.85rem; color: #666;">
                å ´æ‰€: ${item.location}${item.contact ? ` (æ‹…å½“è€…: ${item.contact})` : ''}
              </div>
            </div>
          `).join('');
        }
        
        // æ¡ˆä»¶ä¸€è¦§
        const list = document.getElementById('dashCasesList');
        if (cases.length === 0) {
          list.innerHTML = '<div style="color: #999; font-size: 0.9rem; padding: 1rem; text-align: center;">å¯¾å¿œä¸­ã®æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        } else {
          list.innerHTML = cases.map(c => {
            const ngRate = c.totalCount > 0 ? ((c.totalNG / c.totalCount) * 100).toFixed(2) : '0.00';
            return `
              <div style="padding: 0.5rem; border-bottom: 1px solid #eee; cursor: pointer;" onclick="openCase('${c.id}')">
                <div class="flex-between">
                  <strong style="font-size: 0.9rem;">${c.caseName}</strong>
                  <span style="font-size: 0.85rem;">
                    é¸åˆ¥: ${c.totalCount.toLocaleString()} | 
                    NG: ${c.totalNG.toLocaleString()} | 
                    ç‡: <strong style="color: ${parseFloat(ngRate) > 1 ? '#e74c3c' : '#27ae60'};">${ngRate}%</strong>
                  </span>
                </div>
              </div>
            `;
          }).join('');
        }
      } catch (error) {
        console.error('ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    function formatTime(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp.seconds * 1000);
      return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
    }

    // ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒ¼ãƒ‰æ©Ÿèƒ½ï¼ˆé€£çµ¡äº‹é …ï¼‰
    function loadWhiteboard() {
      const whiteboard = currentCaseData.whiteboard || '';
      const photos = currentCaseData.whiteboardPhotos || [];
      
      document.getElementById('whiteboardText').value = whiteboard;
      
      // å†™çœŸä¸€è¦§è¡¨ç¤º
      const photosList = document.getElementById('whiteboardPhotosList');
      photosList.innerHTML = photos.map((photo, i) => `
        <div style="position: relative;">
          <a href="${photo.url}" target="_blank">
            <img src="${photo.url}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 4px; border: 2px solid #ddd;">
          </a>
          <button onclick="deleteWhiteboardPhoto(${i})" 
                  style="position: absolute; top: 5px; right: 5px; background: #e74c3c; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; justify-content: center;">âœ•</button>
        </div>
      `).join('');
    }

    async function uploadWhiteboardPhotos() {
      const files = document.getElementById('whiteboardPhotos').files;
      if (files.length === 0) {
        alert('å†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      try {
        showAlert('å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');
        const newPhotos = await uploadPhotos(Array.from(files), `whiteboard/${currentCaseId}/${Date.now()}`);
        
        const photos = [...(currentCaseData.whiteboardPhotos || []), ...newPhotos];
        
        await db.collection('cases').doc(currentCaseId).update({
          whiteboardPhotos: photos,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.whiteboardPhotos = photos;
        document.getElementById('whiteboardPhotos').value = '';
        
        showAlert('å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
        loadWhiteboard();
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }

    async function deleteWhiteboardPhoto(index) {
      if (!confirm('ã“ã®å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) return;
      
      const photos = [...currentCaseData.whiteboardPhotos];
      photos.splice(index, 1);
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          whiteboardPhotos: photos,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.whiteboardPhotos = photos;
        showAlert('å†™çœŸã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        loadWhiteboard();
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }

    async function saveWhiteboard() {
      const text = document.getElementById('whiteboardText').value;
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          whiteboard: text,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.whiteboard = text;
        showAlert('ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒ¼ãƒ‰ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }

    // ã‚¹ãƒ†ãƒƒãƒ—ç®¡ç†æ©Ÿèƒ½
    function loadSteps() {
      const steps = currentCaseData.steps || [];
      const list = document.getElementById('stepsList');
      
      if (steps.length === 0) {
        list.innerHTML = '<div class="text-center" style="color: #999; padding: 2rem;">ã‚¹ãƒ†ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      list.innerHTML = steps.map((step, i) => `
        <div class="card" style="padding: 0.75rem; margin-bottom: 0.5rem; ${step.completed ? 'background: #e8f5e9;' : ''}">
          <div class="flex-between">
            <div style="flex: 1;">
              <input type="checkbox" ${step.completed ? 'checked' : ''} 
                     onchange="toggleStep(${i})" 
                     style="width: auto; margin-right: 0.5rem;">
              <span style="${step.completed ? 'text-decoration: line-through; color: #999;' : ''}">${step.title}</span>
            </div>
            <button onclick="deleteStep(${i})" class="btn btn-danger btn-small">å‰Šé™¤</button>
          </div>
          ${step.description ? `<div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666; margin-left: 1.5rem;">${step.description}</div>` : ''}
        </div>
      `).join('');
    }

    async function addStep() {
      const title = prompt('ã‚¹ãƒ†ãƒƒãƒ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (!title) return;
      
      const description = prompt('èª¬æ˜ï¼ˆä»»æ„ï¼‰:');
      
      const steps = [...(currentCaseData.steps || [])];
      steps.push({
        title: title,
        description: description || '',
        completed: false,
        createdAt: new Date()
      });
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          steps: steps,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.steps = steps;
        loadSteps();
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }

    async function toggleStep(index) {
      const steps = [...currentCaseData.steps];
      steps[index].completed = !steps[index].completed;
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          steps: steps,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.steps = steps;
        loadSteps();
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }

    async function deleteStep(index) {
      if (!confirm('ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) return;
      
      const steps = [...currentCaseData.steps];
      steps.splice(index, 1);
      
      try {
        await db.collection('cases').doc(currentCaseId).update({
          steps: steps,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentCaseData.steps = steps;
        loadSteps();
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }

    // ã‚¹ãƒ†ãƒƒãƒ—ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†
    async function loadStepTemplate() {
      try {
        // ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
        const localTemplate = localStorage.getItem('stepTemplate');
        if (localTemplate) {
          stepTemplate = JSON.parse(localTemplate);
          displayStepTemplate();
          return;
        }

        // Firestoreã‹ã‚‰èª­ã¿è¾¼ã¿ã‚’è©¦ã¿ã‚‹
        try {
          const doc = await db.collection('settings').doc('stepTemplate').get();
          if (doc.exists) {
            stepTemplate = doc.data().steps || [];
            localStorage.setItem('stepTemplate', JSON.stringify(stepTemplate));
          } else {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
            stepTemplate = [
              { title: 'ä¸å…·åˆå†…å®¹ã®ç¢ºèª', description: 'ç™ºç”ŸçŠ¶æ³ã¨å½±éŸ¿ç¯„å›²ã‚’ç¢ºèª' },
              { title: 'åŸå› èª¿æŸ»', description: 'ä¸å…·åˆã®åŸå› ã‚’ç‰¹å®š' },
              { title: 'æš«å®šå¯¾ç­–ã®å®Ÿæ–½', description: 'ä¸€æ™‚çš„ãªå¯¾å¿œã‚’å®Ÿæ–½' },
              { title: 'æœ¬å¯¾ç­–ã®æ¤œè¨', description: 'æ’ä¹…çš„ãªå¯¾ç­–ã‚’æ¤œè¨' },
              { title: 'å¯¾ç­–ã®å®Ÿæ–½ãƒ»ç¢ºèª', description: 'å¯¾ç­–ã‚’å®Ÿæ–½ã—åŠ¹æœã‚’ç¢ºèª' },
              { title: 'å®Œäº†å ±å‘Š', description: 'é¡§å®¢ã¸å ±å‘Šã—æ‰¿èªã‚’å¾—ã‚‹' }
            ];
            localStorage.setItem('stepTemplate', JSON.stringify(stepTemplate));
          }
        } catch (firestoreError) {
          // Firestoreã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨
          console.log('Firestoreãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ¨©é™ä¸è¶³ï¼‰ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨');
          stepTemplate = [
            { title: 'ä¸å…·åˆå†…å®¹ã®ç¢ºèª', description: 'ç™ºç”ŸçŠ¶æ³ã¨å½±éŸ¿ç¯„å›²ã‚’ç¢ºèª' },
            { title: 'åŸå› èª¿æŸ»', description: 'ä¸å…·åˆã®åŸå› ã‚’ç‰¹å®š' },
            { title: 'æš«å®šå¯¾ç­–ã®å®Ÿæ–½', description: 'ä¸€æ™‚çš„ãªå¯¾å¿œã‚’å®Ÿæ–½' },
            { title: 'æœ¬å¯¾ç­–ã®æ¤œè¨', description: 'æ’ä¹…çš„ãªå¯¾ç­–ã‚’æ¤œè¨' },
            { title: 'å¯¾ç­–ã®å®Ÿæ–½ãƒ»ç¢ºèª', description: 'å¯¾ç­–ã‚’å®Ÿæ–½ã—åŠ¹æœã‚’ç¢ºèª' },
            { title: 'å®Œäº†å ±å‘Š', description: 'é¡§å®¢ã¸å ±å‘Šã—æ‰¿èªã‚’å¾—ã‚‹' }
          ];
          localStorage.setItem('stepTemplate', JSON.stringify(stepTemplate));
        }
        
        displayStepTemplate();
      } catch (error) {
        console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ç¶šè¡Œ
        stepTemplate = [
          { title: 'ä¸å…·åˆå†…å®¹ã®ç¢ºèª', description: 'ç™ºç”ŸçŠ¶æ³ã¨å½±éŸ¿ç¯„å›²ã‚’ç¢ºèª' },
          { title: 'åŸå› èª¿æŸ»', description: 'ä¸å…·åˆã®åŸå› ã‚’ç‰¹å®š' },
          { title: 'æš«å®šå¯¾ç­–ã®å®Ÿæ–½', description: 'ä¸€æ™‚çš„ãªå¯¾å¿œã‚’å®Ÿæ–½' },
          { title: 'æœ¬å¯¾ç­–ã®æ¤œè¨', description: 'æ’ä¹…çš„ãªå¯¾ç­–ã‚’æ¤œè¨' },
          { title: 'å¯¾ç­–ã®å®Ÿæ–½ãƒ»ç¢ºèª', description: 'å¯¾ç­–ã‚’å®Ÿæ–½ã—åŠ¹æœã‚’ç¢ºèª' },
          { title: 'å®Œäº†å ±å‘Š', description: 'é¡§å®¢ã¸å ±å‘Šã—æ‰¿èªã‚’å¾—ã‚‹' }
        ];
        displayStepTemplate();
      }
    }

    function displayStepTemplate() {
      const list = document.getElementById('stepTemplateList');
      if (!list) return;
      
      list.innerHTML = stepTemplate.map((step, i) => `
        <div class="card" style="padding: 0.75rem; margin-bottom: 0.5rem;">
          <div class="flex-between">
            <div>
              <div style="font-weight: 600;">${step.title}</div>
              ${step.description ? `<div style="font-size: 0.85rem; color: #666; margin-top: 0.3rem;">${step.description}</div>` : ''}
            </div>
            <button onclick="deleteStepFromTemplate(${i})" class="btn btn-danger btn-small">å‰Šé™¤</button>
          </div>
        </div>
      `).join('');
    }

    async function addStepToTemplate() {
      const title = document.getElementById('newStepTitle').value.trim();
      if (!title) {
        alert('ã‚¹ãƒ†ãƒƒãƒ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      const description = document.getElementById('newStepDescription').value.trim();
      
      stepTemplate.push({ title, description });
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
      localStorage.setItem('stepTemplate', JSON.stringify(stepTemplate));
      
      // Firestoreã¸ã®ä¿å­˜ã‚’è©¦ã¿ã‚‹ï¼ˆå¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œï¼‰
      try {
        await db.collection('settings').doc('stepTemplate').set({
          steps: stepTemplate,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (error) {
        console.log('Firestoreä¿å­˜ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜æ¸ˆã¿ï¼‰');
      }
      
      document.getElementById('newStepTitle').value = '';
      document.getElementById('newStepDescription').value = '';
      
      showAlert('ã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ');
      displayStepTemplate();
    }

    async function deleteStepFromTemplate(index) {
      if (!confirm('ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹?')) return;
      
      stepTemplate.splice(index, 1);
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
      localStorage.setItem('stepTemplate', JSON.stringify(stepTemplate));
      
      // Firestoreã¸ã®ä¿å­˜ã‚’è©¦ã¿ã‚‹ï¼ˆå¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œï¼‰
      try {
        await db.collection('settings').doc('stepTemplate').set({
          steps: stepTemplate,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (error) {
        console.log('Firestoreä¿å­˜ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜æ¸ˆã¿ï¼‰');
      }
      
      showAlert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ');
      displayStepTemplate();
    }

    // å†™çœŸè¡¨ç¤º
    function showPhotos(locationIndex, resultIndex) {
      const result = currentCaseData.inventoryLocations[locationIndex].inspectionResults[resultIndex];
      const photos = result.photos || [];
      
      if (photos.length === 0) return;
      
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3>å†™çœŸ (${photos.length}æš)</h3>
            <button onclick="this.closest('.modal').remove()" class="btn btn-secondary btn-small">âœ•</button>
          </div>
          <div class="modal-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
              ${photos.map(photo => `
                <a href="${photo.url}" target="_blank">
                  <img src="${photo.url}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 4px; border: 2px solid #ddd;">
                </a>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }

    // é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
    async function exportSummaryReport() {
      try {
        showAlert('ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...');
        
        const snapshot = await db.collection('cases')
          .where('status', '==', 'inProgress')
          .get();
        
        let csvContent = '\uFEFF'; // UTF-8 BOM
        csvContent += 'æ¡ˆä»¶å,å¾—æ„å…ˆ,ç™ºç”Ÿæ—¥,åœ¨åº«å ´æ‰€,æ•´ç†No,é¸åˆ¥æ•°,NGæ•°,NGç‡(%),å®Ÿç¸¾ä»¶æ•°\n';
        
        snapshot.forEach(doc => {
          const caseData = doc.data();
          const caseName = caseData.caseName || '';
          const customerName = caseData.customerName || '';
          const occurredDate = caseData.occurredDate ? 
            new Date(caseData.occurredDate.seconds * 1000).toLocaleDateString('ja-JP') : '';
          
          const locations = caseData.inventoryLocations || [];
          
          if (locations.length === 0) {
            csvContent += `"${caseName}","${customerName}","${occurredDate}","ãªã—","",0,0,0.00,0\n`;
          } else {
            locations.forEach(location => {
              const results = location.inspectionResults || [];
              let totalCount = 0;
              let totalNG = 0;
              
              // æ•´ç†Noã‚’é›†è¨ˆ
              const serialNumbersSet = new Set();
              results.forEach(r => {
                totalCount += r.count || 0;
                totalNG += r.ngCount || 0;
                (r.serialNumbers || []).forEach(sn => serialNumbersSet.add(sn));
              });
              
              const ngRate = totalCount > 0 ? ((totalNG / totalCount) * 100).toFixed(2) : '0.00';
              const serialNumbers = Array.from(serialNumbersSet).join(' ');
              
              csvContent += `"${caseName}","${customerName}","${occurredDate}","${location.location}","${serialNumbers}",${totalCount},${totalNG},${ngRate},${results.length}\n`;
            });
          }
        });
        
        // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        const date = new Date().toISOString().split('T')[0];
        link.download = `é¸åˆ¥å®Ÿç¸¾é›†è¨ˆ_${date}.csv`;
        link.click();
        
        showAlert('ãƒ¬ãƒãƒ¼ãƒˆã‚’å‡ºåŠ›ã—ã¾ã—ãŸ');
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }
  </script>
</body>
</html>
