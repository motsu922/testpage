<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¨­å‚™ç•°å¸¸å±¥æ­´ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<style>
/* ãƒ†ãƒ¼ãƒå¤‰æ•° */
:root {
  --bg-primary: #fff;
  --bg-secondary: #f8f9fb;
  --bg-tertiary: #f8fafc;
  --border-color: #e5e7eb;
  --text-primary: #0f172a;
  --text-secondary: #334155;
  --text-tertiary: #64748b;
  --card-bg: #fff;
  --grid-line: #e5e7eb;
  --shadow: rgba(0,0,0,.05);
  --shadow-lg: rgba(0,0,0,.25);
}

[data-theme="dark"] {
  --bg-primary: #1e293b;
  --bg-secondary: #0f172a;
  --bg-tertiary: #334155;
  --border-color: #334155;
  --text-primary: #f1f5f9;
  --text-secondary: #cbd5e1;
  --text-tertiary: #94a3b8;
  --card-bg: #1e293b;
  --grid-line: #334155;
  --shadow: rgba(0,0,0,.3);
  --shadow-lg: rgba(0,0,0,.5);
}

.legend { gap: 8px; }
.legend-item {
  max-width: 100%;
}
.legend-item span {
  display: inline-block;
  max-width: 420px;
  white-space: normal;
  word-break: break-word;
  line-height: 1.25;
}
  *{margin:0;padding:0;box-sizing:border-box}
  body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Hiragino Sans',Meiryo,sans-serif;
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    min-height:100vh;padding:20px;
    transition: background 0.3s ease;
  }
  .container{
    max-width:1480px;margin:0 auto;background:var(--bg-primary);border-radius:20px;
    box-shadow:0 20px 60px var(--shadow-lg);overflow:hidden;
    transition: background 0.3s ease;
  }
  .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:18px 24px;}
  .header-row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .header h1{font-size:22px}
  .header .sub{opacity:.9;font-size:13px;margin-top:4px}
  .controls{padding:16px 20px 8px;border-bottom:1px solid var(--border-color);background:var(--bg-secondary);transition: all 0.3s ease;}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .file-input-wrapper{position:relative;overflow:hidden;display:inline-block}
  .btn{
    padding:10px 16px;border:none;border-radius:10px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px;
    background:#e2e8f0;color:#0f172a;
    transition: all 0.2s ease;
  }
  .btn.primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
  .btn.ghost{background:transparent;color:#4f46e5;border:1px solid var(--border-color);}
  .btn:hover{opacity:.92;transform: translateY(-1px);}
  .btn-theme{
    background:var(--bg-tertiary);
    color:var(--text-primary);
    border:1px solid var(--border-color);
  }
  input[type=file]{position:absolute;left:-9999px}
  select,input[type=number],input[type=text]{
    padding:9px 12px;border:2px solid var(--border-color);border-radius:10px;background:var(--bg-primary);
    color:var(--text-primary);
    transition: all 0.3s ease;
  }
  .content{padding:18px 20px 24px}
  .grid{display:grid;gap:14px}
  .grid-2{grid-template-columns:2fr 1fr}
  .panel{
    background:var(--card-bg);border:1px solid var(--border-color);border-radius:16px;padding:16px 16px 12px;
    box-shadow:0 1px 4px var(--shadow);
    transition: all 0.3s ease;
  }
  .panel h3{font-size:14px;color:var(--text-secondary);margin-bottom:10px;display:flex;align-items:center;justify-content:space-between}
  .hint{font-size:12px;color:var(--text-tertiary);}
  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:6px}
  .kpi{border:1px solid var(--border-color);border-radius:14px;padding:12px;background:var(--bg-tertiary);transition: all 0.3s ease;}
  .kpi .t{font-size:12px;color:var(--text-tertiary);}
  .kpi .v{font-size:26px;font-weight:800;color:var(--text-primary);margin-top:4px}
  .svg{width:100%;height:440px;overflow:visible}
  .svg-s{width:100%;height:150px;overflow:visible}
  .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px}
  .card{
    border:1px solid var(--border-color);border-radius:14px;padding:12px;background:var(--card-bg);cursor:pointer;transition:.15s;
  }
  .card:hover{box-shadow:0 2px 10px var(--shadow);transform:translateY(-1px)}
  
  /* ãƒˆãƒ¬ãƒ³ãƒ‰ã‚«ãƒ¼ãƒ‰ï¼šãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
  .card.trend-up{
    background:var(--card-bg);
    border:2px solid #fb7185;
  }
  [data-theme="dark"] .card.trend-up{
    background:#2d1a1f;
    border-color:#fb7185;
  }
  .card.trend-down{
    background:var(--card-bg);
    border:2px solid #4ade80;
  }
  [data-theme="dark"] .card.trend-down{
    background:#1a2d1f;
    border-color:#4ade80;
  }
  
  .tag{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--border-color);color:var(--text-secondary);background:var(--bg-tertiary);}
  .trend-up{color:#b91c1c;font-weight:700}
  .trend-down{color:#065f46;font-weight:700}
  .section-title{font-size:15px;color:var(--text-primary);margin:4px 2px 8px;font-weight:800}
  .marked-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px}
  .legend{display:flex;flex-wrap:wrap;gap:8px;margin:8px 2px 0}
  .legend-item{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-secondary);background:var(--bg-tertiary);border:1px solid var(--border-color);padding:4px 8px;border-radius:999px}
  .dot{width:10px;height:10px;border-radius:50%}
  /* modal */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center;padding:20px}
  .modal.active{display:flex}
  .modal-content{background:var(--bg-primary);border-radius:20px;max-width:1000px;width:100%;max-height:90vh;overflow:auto;position:relative;padding:20px;transition: all 0.3s ease;}
  .modal-close{position:absolute;right:16px;top:16px;border:none;background:#e5e7eb;width:38px;height:38px;border-radius:50%;font-size:22px;cursor:pointer}
  .modal-close:hover{background:#ef4444;color:#fff}
  #modalTitle{
    word-break:break-word;
    overflow-wrap:break-word;
    line-height:1.4;
    max-width:calc(100% - 60px);
    color:var(--text-primary);
  }
  /* settings */
  .settings{display:none;border-top:1px dashed var(--border-color);margin-top:10px;padding-top:12px}
  .settings.active{display:block}
  .search{padding:8px 10px;border:1px solid var(--border-color);border-radius:10px;width:260px;background:var(--bg-primary);color:var(--text-primary);}
  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;max-height:180px;overflow:auto}
  .chip{border:1px solid var(--border-color);padding:6px 10px;border-radius:999px;cursor:pointer;background:var(--card-bg);color:var(--text-primary);transition: all 0.2s ease;}
  .chip.active{background:#eef2ff;border-color:#c7d2fe;color:#3730a3}
  .loading{display:none;text-align:center;padding:40px}
  .loading.active{display:block}
  .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:48px;height:48px;animation:spin 1s linear infinite;margin:0 auto}
  @keyframes spin{to{transform:rotate(360deg)}}
  
  /* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠè¡¨ç¤º */
  .file-info{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 12px;
    background:var(--bg-tertiary);
    border:1px solid var(--border-color);
    border-radius:999px;
    font-size:12px;
    color:var(--text-secondary);
  }
  /* ==== ğŸ”¥ ãƒˆãƒ”ãƒƒã‚¯ã‚¹ï¼ˆæ€¥å¢—ãƒ»é€£ç¶šå¢—åŠ ï¼‰å°‚ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ==== */
#panelTopics {
  border: 2px solid #fb7185;                 /* ãƒ‘ãƒãƒ«æ ã‚’å¼·èª¿ */
  background: rgba(248, 250, 252, 0.95);
}

[data-theme="dark"] #panelTopics {
  background: #020617;
}

#panelTopics h3 {
  font-size: 15px;
  font-weight: 800;
  display: flex;
  align-items: center;
  gap: 8px;
}

#panelTopics h3::before {
  content: "ğŸ”¥";
  font-size: 18px;
}

/* ã‚«ãƒ¼ãƒ‰ã‚’ä¸­å¤®å¯„ã›ï¼†å¤§ãã‚è¡¨ç¤º */
#panelTopics .cards {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  justify-content: center;   /* 1ä»¶ã§ã‚‚çœŸã‚“ä¸­ã« */
  align-items: stretch;
}

#panelTopics .section-title {
  flex-basis: 100%;
  margin: 4px 4px 0;
}

/* ãƒˆãƒ”ãƒƒã‚¯ã‚«ãƒ¼ãƒ‰è‡ªä½“ã‚’å°‘ã—å¤§ããï¼†ç›®ç«‹ãŸã›ã‚‹ */
#panelTopics .card {
  max-width: 620px;
  width: 100%;
  border-width: 2px;
  box-shadow: 0 8px 18px var(--shadow);
  transform: translateY(0);
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

#panelTopics .card:hover {
  transform: translateY(-3px) scale(1.01);
  box-shadow: 0 12px 24px var(--shadow-lg);
}
/* æ€¥å¢—ãƒˆãƒ”ãƒƒã‚¯ï¼ˆtrend-upï¼‰ã®èƒŒæ™¯è‰²ã‚’ãƒ”ãƒ³ã‚¯ã« */
#panelTopics .card.trend-up {
  background: #ffe4ea;               /* å„ªã—ã„ãƒ”ãƒ³ã‚¯ */
  border-color: #f472b6 !important;  /* æ¿ƒã„ãƒ”ãƒ³ã‚¯ã®æ  */
}

/* ãƒ›ãƒãƒ¼æ™‚ã«å°‘ã—æ¿ƒã„ãƒ”ãƒ³ã‚¯ã«ã—ã¦å¼·èª¿ */
#panelTopics .card.trend-up:hover {
  background: #ffdae4;
  border-color: #ec4899 !important;
}

</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="header-row">
      <div>
        <h1>è¨­å‚™ç•°å¸¸å±¥æ­´ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <div class="sub">ç›´è¿‘48æ™‚é–“ã®çŠ¶æ³ã‚’å¼·èª¿ï¼‹ãƒˆãƒ¬ãƒ³ãƒ‰ã§å¯¾ç­–åŠ¹æœã‚’å¯è¦–åŒ–</div>
      </div>
      <div class="row">
        <div class="file-input-wrapper">
          <button class="btn primary" id="btnPick">ğŸ“ CSVã‚’é¸æŠ</button>
          <input type="file" id="fileInput" accept=".csv,.txt">
        </div>
        <select id="granularity">
          <option value="day">æ—¥</option>
          <option value="week">é€±</option>
          <option value="month" selected>æœˆ</option>
        </select>
        <button class="btn" id="btnSettings">âš™ï¸ è¨­å®š</button>
        <button class="btn btn-theme" id="btnTheme" title="ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ">ğŸŒ“</button>
      </div>
    </div>
  </div>

  <div class="controls">
    <div class="row" style="gap:12px;align-items:end">
      <div>
        <div class="hint" style="margin-bottom:6px">ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«</div>
        <div class="file-info" id="currentFile">æœªé¸æŠ</div>
      </div>
      <div class="hint">å¿…é ˆåˆ—ï¼š<b>DATE</b>, <b>MESSAGE</b>ï¼ˆä»»æ„ï¼š<b>TIME</b>ï¼‰</div>
    </div>
<!-- æ–‡å­—ã‚µã‚¤ã‚º -->
<div class="row" style="gap:6px;margin-top:6px">
  <span class="hint">æ–‡å­—ã‚µã‚¤ã‚º</span>
  <input type="range" id="fontScale" min="80" max="160" step="5" value="100">
  <span class="hint" id="fontScaleVal">100%</span>
</div>

<!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ä¸­ï¼ˆURLè¨­å®šã®ç›´å¾Œãªã©ï¼‰ã«ç½®ã -->
<div id="settings" class="settings">
  <div style="display:grid;gap:14px;grid-template-columns:1fr 1fr">
    <div>
      <div class="section-title">ğŸ¯ ãƒãƒ¼ã‚¯ã™ã‚‹ç•°å¸¸ï¼ˆMESSAGEï¼‰</div>
      <input class="search" id="searchMsg" placeholder="MESSAGEã‚’æ¤œç´¢">
      <div class="chips" id="chipsMark"></div>
    </div>
    <div>
      <div class="section-title">ğŸ™ˆ ç„¡è¦–ã™ã‚‹ç•°å¸¸ï¼ˆMESSAGEï¼‰</div>
      <input class="search" id="searchIgnore" placeholder="MESSAGEã‚’æ¤œç´¢">
      <div class="chips" id="chipsIgnore"></div>
    </div>
  </div>
  
  <!-- FirebaseåŒæœŸè¨­å®š -->
  <div style="margin-top:14px;padding-top:14px;border-top:1px dashed var(--border-color);">
    <div class="section-title">â˜ï¸ Firebaseè¨­å®šå…±æœ‰</div>
    <div class="row" style="gap:8px;margin-bottom:8px;">
      <span class="hint" id="firebaseStatus">æœªæ¥ç¶š</span>
      <button class="btn" id="btnFirebaseSync" disabled>ğŸ”„ Firebaseã‹ã‚‰èª­è¾¼</button>
      <button class="btn" id="btnFirebaseSave" disabled>â˜ï¸ Firebaseã«ä¿å­˜</button>
    </div>
    <div class="hint" style="font-size:11px;">â€» è¨­å®šã¯ãƒ•ã‚¡ã‚¤ãƒ«åã”ã¨ã«ä¿å­˜ã•ã‚Œã€ãƒãƒ¼ãƒ å…¨ä½“ã§å…±æœ‰ã•ã‚Œã¾ã™</div>
  </div>
  
  <div class="row" style="margin-top:8px;gap:8px">
    <button class="btn primary" id="saveSettings">âœ… ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜</button>
    <button class="btn ghost" id="clearSettings">ğŸ§¹ ã™ã¹ã¦è§£é™¤</button>
    <span class="hint" id="marksHint">ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ã‚‚å³ä¿å­˜ï¼†åæ˜ ã—ã¾ã™ï¼‰</span>
  </div>
</div>
<!-- ãƒˆãƒ”ãƒƒã‚¯ã‚¹æ¤œå‡ºã®é–¾å€¤ -->
<div style="margin-top:14px;padding-top:14px;border-top:1px dashed var(--border-color);">
  <div class="section-title">ğŸ”¥ ãƒˆãƒ”ãƒƒã‚¯ã‚¹æ¤œå‡ºã®é–¾å€¤</div>
  <div class="row" style="gap:8px;flex-wrap:wrap">
    <label class="hint">åŸºæº–æ—¥æ•°</label>
    <input type="number" id="topicBaselineDays" value="7" min="3" max="30" style="width:84px">
    <label class="hint">æ€¥å¢—å€ç‡ â‰¥</label>
    <input type="number" id="topicLiftMin" value="1.5" step="0.1" style="width:84px">
    <label class="hint">æ€¥å¢—çµ¶å¯¾å€¤ â‰¥</label>
    <input type="number" id="topicAbsMin" value="8" step="1" style="width:84px">
    <label class="hint">é€£ç¶šå¢—åŠ æ—¥æ•°</label>
    <input type="number" id="topicConsecDays" value="3" min="3" max="7" style="width:84px">
    <label class="hint">æœ€å°æ—¥ä»¶æ•°</label>
    <input type="number" id="topicMinDaily" value="2" step="1" style="width:84px">
    <label class="hint">æœ€å¤§è¡¨ç¤ºä»¶æ•°</label>
    <input type="number" id="topicMaxCards" value="5" min="1" max="12" style="width:84px">
    <button class="btn" id="btnTopicsApply">ğŸ” å†åˆ¤å®š</button>
  </div>
</div>


  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div class="hint" style="margin-top:10px">ãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...</div>
  </div>

  <div class="content" id="content" style="display:none">
    <!-- ğŸ”¥ ãƒˆãƒ”ãƒƒã‚¯ã‚¹ï¼ˆæ€¥å¢—ãƒ»é€£ç¶šå¢—åŠ ï¼‰ -->
<div class="panel" id="panelTopics" style="margin-bottom:12px;display:none">
  <h3>ğŸ”¥ ãƒˆãƒ”ãƒƒã‚¯ã‚¹ï¼ˆæ€¥å¢—ãƒ»é€£ç¶šå¢—åŠ ï¼‰
    <span class="hint" id="topicsHint" style="margin-left:6px"></span>
  </h3>
  <div class="cards" id="topicsCards"></div>
</div>

<!-- TOP: ç›´è¿‘48hï¼ˆãã®ã¾ã¾ï¼‰ -->
<div class="grid grid-2">
  <div class="panel">
    <h3>â± ç›´è¿‘48æ™‚é–“ã®ç•°å¸¸ä»¶æ•°ï¼ˆ1æ™‚é–“ã”ã¨ï¼‰ <span class="hint" id="h48Range">-</span></h3>
    <svg class="svg" id="svg48h"></svg>
    <div class="legend" id="legendTop5"></div>
  </div>
  <div class="panel">
    <h3>åŸå› TOP5ï¼ˆç›´è¿‘24æ™‚é–“ï¼‰</h3>
    <div class="kpis">
      <div class="kpi"><div class="t">ç›´è¿‘48h åˆè¨ˆ</div><div class="v" id="vTotal48">-</div></div>
      <div class="kpi"><div class="t">ãƒ”ãƒ¼ã‚¯æ™‚åˆ»ï¼ˆä»¶æ•°ï¼‰</div><div class="v" id="vPeak">-</div></div>
    </div>
    <svg class="svg" id="svgTopCauses24"></svg>
  </div>
</div>

<!-- ğŸ¯ ãƒãƒ¼ã‚¯ç•°å¸¸ï¼ˆç›´è¿‘48hï¼‰ â† ãƒˆãƒ¬ãƒ³ãƒ‰ã‚ˆã‚Šä¸Šã«ç§»å‹• -->
<div class="section-title" style="margin-top:14px">ğŸ¯ ãƒãƒ¼ã‚¯ã—ãŸç•°å¸¸ã®ãƒ¢ãƒ‹ã‚¿ï¼ˆç›´è¿‘48hï¼‰</div>
<div class="marked-grid" id="markedGrid"></div>

<!-- ğŸ“ˆ ç²’åº¦åˆ¥ãƒˆãƒ¬ãƒ³ãƒ‰TOP3 -->
<div class="section-title" style="margin-top:14px">ğŸ“ˆ ç²’åº¦åˆ¥ãƒˆãƒ¬ãƒ³ãƒ‰è§£æ TOP3ï¼ˆä¸Šæ˜‡/æ”¹å–„ï¼‰</div>
<div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(360px,1fr))">
  <div class="panel" id="panelDay">
    <h3>æ—¥ãƒˆãƒ¬ãƒ³ãƒ‰ TOP3</h3>
    <div class="cards" id="cardsDay"></div>
  </div>
  <div class="panel" id="panelWeek">
    <h3>é€±ãƒˆãƒ¬ãƒ³ãƒ‰ TOP3</h3>
    <div class="cards" id="cardsWeek"></div>
  </div>
  <div class="panel" id="panelMonth">
    <h3>æœˆãƒˆãƒ¬ãƒ³ãƒ‰ TOP3</h3>
    <div class="cards" id="cardsMonth"></div>
  </div>
</div>


<!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="detailModal" aria-hidden="true">
  <div class="modal-content">
    <button class="modal-close" id="modalClose" aria-label="é–‰ã˜ã‚‹">Ã—</button>
    <h2 id="modalTitle" style="margin-bottom:10px"></h2>
  <!-- ğŸ”½ è¿½åŠ ï¼šç²’åº¦åˆ‡æ›¿ -->
  <div style="margin-bottom:8px;">
    <label for="modalGran" style="font-size:13px;color:#334155;">ç²’åº¦ï¼š</label>
    <select id="modalGran" style="padding:4px 8px;border-radius:6px;border:1px solid #e5e7eb;">
      <option value="day">æ—¥</option>
      <option value="week">é€±</option>
      <option value="month">æœˆ</option>
    </select>
  </div>

<!-- ç²’åº¦åˆ‡æ›¿ã®ç›´å¾Œã«è¿½åŠ  -->
<div id="detailControls" style="display:flex;gap:8px;align-items:center;margin:8px 0 6px;">
  <button class="btn" id="btnZoomOut"  title="ç¸®å°">ï¼</button>
  <button class="btn" id="btnZoomIn"   title="æ‹¡å¤§">ï¼‹</button>
  <button class="btn ghost" id="btnZoomReset" title="å…¨ä½“è¡¨ç¤º">âŸ³ ãƒªã‚»ãƒƒãƒˆ</button>
  <div class="hint">è¡¨ç¤ºå¹…</div>
  <input id="rangeWindow" type="range" min="3" max="60" step="1" value="12" style="width:140px">
  <span class="hint" id="lblWindow">12</span>
  <div class="hint">ä½ç½®</div>
  <input id="rangeOffset" type="range" min="0" max="0" step="1" value="0" style="flex:1;min-width:200px">
</div>
    <div class="kpis">
      <div class="kpi"><div class="t">æœŸé–“åˆè¨ˆ</div><div class="v" id="mTotal">-</div></div>
      <div class="kpi"><div class="t">å¹³å‡/æœŸé–“</div><div class="v" id="mAvg">-</div></div>
      <div class="kpi"><div class="t">å‚¾ãï¼ˆå›å¸°ï¼‰</div><div class="v" id="mSlope">-</div></div>
      <div class="kpi"><div class="t">RÂ²</div><div class="v" id="mR2">-</div></div>
    </div>
    <div class="panel" style="margin-top:10px">
      <!-- ğŸ“ å¯¾å¿œãƒ¡ãƒ¢ -->
<div class="panel" id="memoPanel" style="margin-top:12px">
  <h3>ğŸ“ å¯¾å¿œãƒ¡ãƒ¢ï¼ˆã“ã®é …ç›®ã«ç´ã¥ããƒ¡ãƒ¢ï¼‰</h3>
  <div class="row" style="gap:8px;align-items:flex-start;margin:8px 0 6px;flex-wrap:wrap">
    <textarea id="memoText" rows="3" placeholder="å¯¾å¿œå†…å®¹ã‚’å…¥åŠ›" 
      style="flex:1;min-width:320px;padding:10px;border:1px solid var(--border-color);border-radius:10px;background:var(--bg-primary);color:var(--text-primary)"></textarea>
    <div style="display:flex;flex-direction:column;gap:6px">
      <input type="datetime-local" id="memoAt" 
        style="padding:8px 10px;border:1px solid var(--border-color);border-radius:10px;background:var(--bg-primary);color:var(--text-primary)">
      <button class="btn primary" id="btnMemoSave">ğŸ’¾ ä¿å­˜</button>
    </div>
  </div>
  <div class="hint" style="margin-bottom:6px">â€» ãƒ¡ãƒ¢ã¯ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ã«ä¿å­˜ï¼å…±æœ‰ã•ã‚Œã¾ã™</div>
  <div id="memoList" style="display:grid;gap:8px"></div>
</div>

      <h3>æ¨ç§»ï¼ˆé¸æŠç²’åº¦ï¼‰</h3>
      <svg class="svg" id="svgDetail"></svg>
    </div>
  </div>
</div>

<script>

// ===== Firebaseè¨­å®š =====
const firebaseConfig = {
  apiKey: "AIzaSyCep92sxUf_X_1OLXUa3C73UdOwk00n7Pw",
  authDomain: "chokotei-ef572.firebaseapp.com",
  projectId: "chokotei-ef572",
  storageBucket: "chokotei-ef572.firebasestorage.app",
  messagingSenderId: "520522241295",
  appId: "1:520522241295:web:a7e9b338ace97307ef5a7a"
};

// FirebaseåˆæœŸåŒ–
let db = null;
let firebaseInitialized = false;

async function initFirebase() {
  try {
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    // åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³ï¼ˆå¿…è¦ã«å¿œã˜ã¦ãƒ«ãƒ¼ãƒ«ã¯ anon write ã‚’è¨±å¯ï¼‰
    await firebase.auth().signInAnonymously();

    db = firebase.firestore();
    firebaseInitialized = true;
    updateFirebaseStatus('æ¥ç¶šæ¸ˆã¿ âœ“ï¼ˆåŒ¿åï¼‰');
    enableFirebaseButtons();
    console.log('FirebaseåˆæœŸåŒ–æˆåŠŸï¼ˆåŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³å®Œäº†ï¼‰');
  } catch (error) {
    console.error('FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
    updateFirebaseStatus('æ¥ç¶šã‚¨ãƒ©ãƒ¼ âœ—');
    firebaseInitialized = false;
  }
}

// ===== Firestore: refs =====
function fileDocRef() {
  if (!firebaseInitialized || !currentFileName) return null;
  return db.collection('anomaly-configs').doc(getFileKey(currentFileName));
}
function memoColRef() {
  const fd = fileDocRef();
  return fd ? fd.collection('memos') : null;
}
  async function addMemoToFirebase(msg, note, atISO) {
  const col = memoColRef();
  if (!col) throw new Error('Firebaseæœªæ¥ç¶šã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠã§ã™');
  const now = firebase.firestore.FieldValue.serverTimestamp();
  const docRef = await col.add({
    msg, note, atISO,
    createdAt: now,
    updatedAt: now,
    updatedBy: 'user-' + Date.now().toString(36)
  });
  return docRef.id;
}

async function deleteMemoFromFirebase(memoId) {
  const col = memoColRef();
  if (!col) throw new Error('Firebaseæœªæ¥ç¶šã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠã§ã™');
  await col.doc(memoId).delete();
}

async function fetchMemosFromFirebase(msg) {
  const col = memoColRef();
  if (!col) return [];
  const snap = await col.where('msg', '==', msg).get(); // orderByå¤–ã™
  const arr = snap.docs.map(d => ({ id: d.id, ...(d.data()||{}) }));
  // atISO é™é †
  return arr.sort((a,b)=> (b.atISO||'').localeCompare(a.atISO||''));
}
function updateFirebaseStatus(text) {
  const status = document.getElementById('firebaseStatus');
  if (status) status.textContent = text;
}

function enableFirebaseButtons() {
  const syncBtn = document.getElementById('btnFirebaseSync');
  const saveBtn = document.getElementById('btnFirebaseSave');
  if (syncBtn) syncBtn.disabled = false;
  if (saveBtn) saveBtn.disabled = false;
}

// ===== Firestoreæ“ä½œ =====
async function saveToFirebase() {
  if (!firebaseInitialized || !currentFileName) {
    alert('FirebaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
    return;
  }

  try {
    updateFirebaseStatus('ä¿å­˜ä¸­...');
    const fileKey = getFileKey(currentFileName);
    const configData = {
      fileName: currentFileName,
      marked: [...marked],
      ignored: [...ignored],
      memos, 
      lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: 'user-' + Date.now().toString(36) // ç°¡æ˜“çš„ãªãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥å­
    };

    await db.collection('anomaly-configs').doc(fileKey).set(configData);
    
    updateFirebaseStatus('ä¿å­˜å®Œäº† âœ“');
    alert(`âœ… ${currentFileName} ã®è¨­å®šã‚’Firebaseã«ä¿å­˜ã—ã¾ã—ãŸ`);
    console.log('Firebaseä¿å­˜æˆåŠŸ:', fileKey);
  } catch (error) {
    console.error('Firebaseä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
    updateFirebaseStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼ âœ—');
    alert('Firebaseã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

async function loadFromFirebase() {
  if (!firebaseInitialized || !currentFileName) {
    alert('FirebaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
    return;
  }

  try {
    updateFirebaseStatus('èª­è¾¼ä¸­...');
    const fileKey = getFileKey(currentFileName);
    const doc = await db.collection('anomaly-configs').doc(fileKey).get();

    if (!doc.exists) {
      updateFirebaseStatus('ãƒ‡ãƒ¼ã‚¿ãªã—');
      alert(`â„¹ï¸ ${currentFileName} ã®è¨­å®šãŒFirebaseã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
      return;
    }

    const data = doc.data();
    marked = new Set(data.marked || []);
    ignored = new Set(data.ignored || []);
    memos  = (data.memos && typeof data.memos === 'object') ? data.memos : {};
    // UIæ›´æ–°
    renderChipSets(allMessages);
    renderAll();
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚ä¿å­˜
    saveFileConfig(currentFileName);
    
    updateFirebaseStatus('èª­è¾¼å®Œäº† âœ“');
    
    const updatedDate = data.lastUpdated?.toDate?.();
    const dateStr = updatedDate ? updatedDate.toLocaleString('ja-JP') : 'ä¸æ˜';
    alert(`âœ… ${currentFileName} ã®è¨­å®šã‚’Firebaseã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸ\næœ€çµ‚æ›´æ–°: ${dateStr}`);
    console.log('Firebaseèª­è¾¼æˆåŠŸ:', fileKey, data);
  } catch (error) {
    console.error('Firebaseèª­è¾¼ã‚¨ãƒ©ãƒ¼:', error);
    updateFirebaseStatus('èª­è¾¼ã‚¨ãƒ©ãƒ¼ âœ—');
    alert('Firebaseã‹ã‚‰ã®èª­è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

// ãƒ•ã‚©ãƒ³ãƒˆæ‹¡å¤§ç‡ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰
const LS_FONT = 'fontScale.v1';
let FONT_SCALE = parseFloat(localStorage.getItem(LS_FONT) || '1');
const fs = (px) => Math.max(8, Math.round(px * FONT_SCALE));

/* ====== å®šæ•°/ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
const LS_MARKS = 'markedMessages.v1';
const LS_IGNORES = 'ignoredMessages.v1';
const LS_THEME = 'theme.v1';
const LS_FILE_CONFIGS = 'fileConfigs.v1';  // ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥è¨­å®š
const DEFAULT_LOOKBACK = { day: 10, week: 4, month: 3 };
const COLORS = ['#ef4444','#22c55e','#3b82f6','#f59e0b','#a855f7','#06b6d4','#eab308'];

const $ = (id)=>document.getElementById(id);
const fmt = (n)=>n.toLocaleString();
const debounce = (fn,ms=150)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
const DEFAULT_TOPICS = {
  baselineDays: 7,
  liftMin:      1.5,
  absMin:       8,
  consecDays:   3,
  minDaily:     2,
  maxCards:     5,
  minTotal:     20,   // å¯¾è±¡æœŸé–“ã®åˆè¨ˆä»¶æ•°ãŒã“ã‚Œæœªæº€ãªã‚‰é™¤å¤–
  liftCap:      3.0,  // å€ç‡ã®ä¸Šé™ï¼ˆæ¥µç«¯ãªã‚¹ãƒ‘ã‚¤ã‚¯ã‚’æŠ‘åˆ¶ï¼‰
  weight48:     0.5,  // 48h ä»¶æ•°ã®ã‚¹ã‚³ã‚¢å¯„ä¸
  bonusConsec:  10    // é€£ç¶šå¢—åŠ ãƒœãƒ¼ãƒŠã‚¹
};

let topicsConfig = { ...DEFAULT_TOPICS };

/* ====== ãƒ†ãƒ¼ãƒç®¡ç† ====== */
function initTheme() {
  const saved = localStorage.getItem(LS_THEME) || 'light';
  document.documentElement.setAttribute('data-theme', saved);
  updateThemeButton(saved);
}

function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme') || 'light';
  const next = current === 'light' ? 'dark' : 'light';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem(LS_THEME, next);
  updateThemeButton(next);
  // SVGå†æç”»ï¼ˆè‰²ãŒå¤‰ã‚ã‚‹ãŸã‚ï¼‰
  if (rawRows.length > 0) renderAll();
}
function toLocalDatetimeValue(date = new Date()){
  // YYYY-MM-DDTHH:mmï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰ã‚’ç”Ÿæˆ
  const pad = n => String(n).padStart(2,'0');
  const y = date.getFullYear();
  const m = pad(date.getMonth()+1);
  const d = pad(date.getDate());
  const hh= pad(date.getHours());
  const mm= pad(date.getMinutes());
  return `${y}-${m}-${d}T${hh}:${mm}`;
}

function renderMemoList(msg){
  const list = $('memoList');
  if (!list) return;
  list.innerHTML = '';

  const arr = (memos[msg] || []).slice().sort((a,b)=> (b.atISO||'').localeCompare(a.atISO||''));
  if (!arr.length){
    list.innerHTML = '<div class="hint">ãƒ¡ãƒ¢ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }

  arr.forEach((it, idx) => {
    const wrap = document.createElement('div');
    wrap.className = 'card';
    wrap.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <div style="font-size:${fs(12)}px;color:var(--text-secondary)">å¯¾å¿œæ—¥æ™‚ï¼š${(it.atISO||'').replace('T',' ')}</div>
        <button class="btn ghost" data-idx="${idx}" data-id="${it.id || ''}" data-at="${it.atISO || ''}">ğŸ—‘ å‰Šé™¤</button>
      </div>
      <div style="margin-top:6px;font-size:${fs(14)}px;color:var(--text-primary);white-space:pre-wrap;line-height:1.4">${it.note || ''}</div>
    `;
const btn = wrap.querySelector('button');
  btn?.addEventListener('click', async () => {
    try {
      btn.disabled = true;
      const id = btn.dataset.id || null;
      const targetAt = btn.dataset.at || it.atISO || '';

      // 1) Firebase ã‚’å‰Šé™¤ï¼ˆid ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
      if (id && firebaseInitialized && currentFileName) {
        await deleteMemoFromFirebase(id);
      }
      // 2) ãƒ­ãƒ¼ã‚«ãƒ«ã‚‚å‰Šé™¤ï¼ˆid å„ªå…ˆã€ãªã‘ã‚Œã° atISO ã§å¾Œæ–¹äº’æ›ï¼‰
      memos[msg] = (memos[msg] || []).filter(x => {
        if (id) return x.id !== id;
        return x.atISO !== targetAt;
      });
      if (currentFileName) saveFileConfig(currentFileName);

      // 3) å†æç”»ï¼ˆä¸€è¦§/ã‚«ãƒ¼ãƒ‰/KPIï¼‰
      renderMemoList(msg);
      renderTrends();
      renderMarked();
    } catch (e) {
      alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e?.message || e));
    } finally {
      btn.disabled = false;
    }
  });
    list.appendChild(wrap);
  });
}

function updateThemeButton(theme) {
  const btn = $('btnTheme');
  if (btn) {
    btn.textContent = theme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
    btn.title = theme === 'light' ? 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ' : 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ';
  }
}

/* ====== ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥è¨­å®šç®¡ç† ====== */
let currentFileName = '';  // ç¾åœ¨èª­ã¿è¾¼ã‚“ã§ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«å

function getFileKey(filename) {
  // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ‹¡å¼µå­ã‚’é™¤ã„ãŸéƒ¨åˆ†ã‚’ã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨
  return filename.replace(/\.[^/.]+$/, '').toLowerCase();
}

function loadFileConfig(filename) {
  const key = getFileKey(filename);
  try {
    const configs = JSON.parse(localStorage.getItem(LS_FILE_CONFIGS) || '{}');
    const config = configs[key] || { marked: [], ignored: [], memos: {} };
    marked = new Set((config.marked || []).filter(x => typeof x === 'string'));
    ignored = new Set((config.ignored || []).filter(x => typeof x === 'string'));
    memos  = (config.memos && typeof config.memos === 'object') ? config.memos : {};
    console.log(`è¨­å®šèª­ã¿è¾¼ã¿: ${filename} => ãƒãƒ¼ã‚¯:${marked.size}, ç„¡è¦–:${ignored.size}, ãƒ¡ãƒ¢é …ç›®æ•°:${Object.keys(memos).length}`);
  } catch {
    marked = new Set(); ignored = new Set(); memos = {};
  }
}

function loadFileConfig(filename) {
  const key = getFileKey(filename);
  try {
    const configs = JSON.parse(localStorage.getItem(LS_FILE_CONFIGS) || '{}');
    const config = configs[key] || { marked: [], ignored: [], memos: {} };
    marked = new Set((config.marked || []).filter(x => typeof x === 'string'));
    ignored = new Set((config.ignored || []).filter(x => typeof x === 'string'));
    memos  = (config.memos && typeof config.memos === 'object') ? config.memos : {};
   topicsConfig = { ...DEFAULT_TOPICS, ...(config.topicsConfig || {}) };
    console.log(`è¨­å®šèª­ã¿è¾¼ã¿: ${filename} => ãƒãƒ¼ã‚¯:${marked.size}, ç„¡è¦–:${ignored.size}, ãƒ¡ãƒ¢é …ç›®æ•°:${Object.keys(memos).length}`);
  } catch {
    marked = new Set(); ignored = new Set(); memos = {};
   topicsConfig = { ...DEFAULT_TOPICS };
  }
}

function saveFileConfig(filename) {
  const key = getFileKey(filename);
  try {
    const configs = JSON.parse(localStorage.getItem(LS_FILE_CONFIGS) || '{}');
    configs[key] = {
      marked: [...marked],
      ignored: [...ignored],
      memos,
     topicsConfig,
      lastUpdated: new Date().toISOString()
    };
    localStorage.setItem(LS_FILE_CONFIGS, JSON.stringify(configs));
    console.log(`è¨­å®šä¿å­˜: ${filename} => ãƒãƒ¼ã‚¯:${marked.size}, ç„¡è¦–:${ignored.size}, ãƒ¡ãƒ¢é …ç›®æ•°:${Object.keys(memos).length}`);
  } catch (e) {
    console.error('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
  }
}


function updateCurrentFileName(filename) {
  currentFileName = filename;
  const display = $('currentFile');
  if (display) {
    display.innerHTML = `ğŸ“„ ${filename}`;
  }
}

function parseDateValue(dv){
  if (dv instanceof Date) return dv;
  if (typeof dv === 'number'){ return new Date((dv - 25569) * 86400 * 1000); }
  const t = new Date(dv);
  return isNaN(+t) ? null : t;
}
function parseTimeValue(tv){
  if (tv == null || tv === '') return {h:0,m:0};
  if (typeof tv === 'number'){
    const totalMin = Math.round(tv * 24 * 60);
    const h = Math.floor(totalMin/60), m = totalMin % 60;
    return {h,m};
  }
  const m = String(tv).match(/^(\d{1,2}):(\d{2})/);
  if (m){ return {h:parseInt(m[1]), m:parseInt(m[2])}; }
  return {h:0,m:0};
}
function toYMD(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
function getWeekKey(d){
  const du = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = du.getUTCDay() || 7;
  du.setUTCDate(du.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(du.getUTCFullYear(),0,1));
  const week = Math.ceil((((du - yearStart)/86400000)+1)/7);
  const weekStart = new Date(du);
  const wsDay = weekStart.getUTCDay()||7;
  weekStart.setUTCDate(weekStart.getUTCDate() - (wsDay-1));
  const ws = new Date(Date.UTC(weekStart.getUTCFullYear(), weekStart.getUTCMonth(), weekStart.getUTCDate()));
  return { key:`${du.getUTCFullYear()}-W${String(week).padStart(2,'0')}`, startLabel:`${ws.getUTCMonth()+1}/${String(ws.getUTCDate()).padStart(2,'0')}` };
}
function getMonthKey(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'); return `${y}-${m}`; }
function computeTrend(y){
  const n=y.length; if(!n) return {slope:0,intercept:0,r2:0};
  const xs=Array.from({length:n},(_,i)=>i);
  const sumX=xs.reduce((a,b)=>a+b,0);
  const sumY=y.reduce((a,b)=>a+b,0);
  const sumXX=xs.reduce((a,b)=>a+b*b,0);
  const sumXY=xs.reduce((a,xi,i)=>a+xi*y[i],0);
  const denom = n*sumXX - sumX*sumX || 1;
  const slope=(n*sumXY - sumX*sumY)/denom;
  const intercept=(sumY - slope*sumX)/n;
  const avg=sumY/n;
  const ssTot=y.reduce((a,yi)=>a+(yi-avg)**2,0) || 1e-9;
  const ssRes=y.reduce((a,yi,i)=>a+(yi-(slope*xs[i]+intercept))**2,0);
  const r2=Math.max(0, Math.min(1, 1-ssRes/ssTot));
  return {slope,intercept,r2};
}

/* ====== çŠ¶æ…‹ ====== */
let rawRows=[];            // æ­£è¦åŒ–æ¸ˆã¿
let rowsWithDT=[];         // {ts:Date, message:string}
let marked = new Set();    // ãƒãƒ¼ã‚¯å¯¾è±¡
let ignored = new Set();   // ç„¡è¦–å¯¾è±¡
let allMessages=[];
  let memos = {};
async function syncMemosFromFirebase(msg){
  if (!firebaseInitialized || !currentFileName) return;
  const list = await fetchMemosFromFirebase(msg);
  memos[msg] = list.map(x => ({ id: x.id, note: x.note || '', atISO: x.atISO || '' }));
  // ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥è¨­å®šã«ã‚‚åæ˜ ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³é–²è¦§ã®ãŸã‚ï¼‰
  if (currentFileName) saveFileConfig(currentFileName);
}

/* ====== CSV I/Oï¼ˆæ‰‹å‹•ã®ã¿ï¼‰ ====== */
$('btnPick').addEventListener('click', ()=> $('fileInput').click());
$('fileInput').addEventListener('change', handlePickedFile);

// ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
$('btnTheme')?.addEventListener('click', toggleTheme);


async function handlePickedFile(e){
  const f=e.target.files?.[0]; if(!f) return;
  updateCurrentFileName(f.name);
  loadFileConfig(f.name);
  $('loading').classList.add('active'); $('content').style.display='none';
  const buf = await f.arrayBuffer();
  let text = new TextDecoder('utf-8',{fatal:false}).decode(buf);
  if ((text.match(/\uFFFD/g)||[]).length>0){
    text = new TextDecoder('shift_jis',{fatal:false}).decode(buf);
  }
  await parseAndRender(text);
  $('loading').classList.remove('active'); $('content').style.display='block';
}

// èµ·å‹•æ™‚ã®åˆæœŸåŒ–
window.addEventListener('DOMContentLoaded', async () => {
  // ãƒ†ãƒ¼ãƒåˆæœŸåŒ–
  initTheme();
  
  // FirebaseåˆæœŸåŒ–
  initFirebase();
  
  // Firebaseãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  const syncBtn = document.getElementById('btnFirebaseSync');
  const saveBtn = document.getElementById('btnFirebaseSave');
  if (syncBtn) syncBtn.addEventListener('click', loadFromFirebase);
  if (saveBtn) saveBtn.addEventListener('click', saveToFirebase);
  
  // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼åˆæœŸåŒ–
  const fsInput = document.getElementById('fontScale');
  const fsVal   = document.getElementById('fontScaleVal');
  if (fsInput && fsVal) {
    fsInput.value = String(Math.round(FONT_SCALE * 100));
    fsVal.textContent = `${Math.round(FONT_SCALE * 100)}%`;
    fsInput.addEventListener('input', (e) => {
      FONT_SCALE = Math.max(0.6, Math.min(2, (Number(e.target.value)||100)/100));
      localStorage.setItem(LS_FONT, String(FONT_SCALE));
      fsVal.textContent = `${Math.round(FONT_SCALE * 100)}%`;
      renderAll();
    });
  }
});
// ãƒˆãƒ”ãƒƒã‚¯ã‚¹é–¾å€¤UI åˆæœŸåŒ–ï¼†ãƒã‚¤ãƒ³ãƒ‰
const ids = ['topicBaselineDays','topicLiftMin','topicAbsMin','topicConsecDays','topicMinDaily','topicMaxCards'];
const applyTopicsForm = () => {
  const num = id => Number(document.getElementById(id)?.value ?? topicsConfig[id] ?? 0);

  topicsConfig = {
    baselineDays: num('topicBaselineDays'),
    liftMin:      num('topicLiftMin'),
    absMin:       num('topicAbsMin'),
    consecDays:   num('topicConsecDays'),
    minDaily:     num('topicMinDaily'),
    maxCards:     num('topicMaxCards'),
  };
  if (currentFileName) saveFileConfig(currentFileName);
  renderTopics();
};
ids.forEach(id=>{
  const el = document.getElementById(id);
  if (el) {
    // ä¿å­˜æ¸ˆã¿å€¤ã‚’åæ˜ 
    const map = {
      topicBaselineDays: topicsConfig.baselineDays,
      topicLiftMin:      topicsConfig.liftMin,
      topicAbsMin:       topicsConfig.absMin,
      topicConsecDays:   topicsConfig.consecDays,
      topicMinDaily:     topicsConfig.minDaily,
      topicMaxCards:     topicsConfig.maxCards,
    };
    el.value = map[id];
    el.addEventListener('change', applyTopicsForm);
    el.addEventListener('input',  debounce(applyTopicsForm, 200));
  }
});
document.getElementById('btnTopicsApply')?.addEventListener('click', applyTopicsForm);

/* ====== è§£æï¼†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ====== */
async function parseAndRender(text){
  const rows = parseCSV(text);
  rawRows = normalizeHeaders(rows);
  const okDATE = rawRows.some(r=>'DATE' in r), okMSG = rawRows.some(r=>'MESSAGE' in r);
  if(!okDATE || !okMSG){ alert('ãƒ˜ãƒƒãƒ€ã«ã€ŒDATEã€ã€ŒMESSAGEã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'); return; }

  rowsWithDT = rawRows.map(r=>{
    const d = parseDateValue(r.DATE);
    if(!d) return null;
    const t = 'TIME' in r ? parseTimeValue(r.TIME) : {h:0,m:0};
    const dt = new Date(d.getFullYear(), d.getMonth(), d.getDate(), t.h, t.m, 0, 0);
    const msg = String(r.MESSAGE||'').trim();
    return {ts:dt, message:msg};
  }).filter(Boolean).sort((a,b)=>a.ts-b.ts);

  allMessages = [...new Set(rowsWithDT.map(r=>r.message))].sort();
  renderChipSets(allMessages);
  loadSettings();
  renderAll();
}

/* CSV utils */
function parseCSV(text){
  const lines = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l=>l.length);
  if(!lines.length) return [];
  const headers = splitCsvLine(lines[0]).map(h=>h.replace(/^\uFEFF/,''));
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const cols = splitCsvLine(lines[i]);
    const row={}; headers.forEach((h,idx)=>row[h]= (cols[idx]??'').trim());
    rows.push(row);
  }
  return rows;
  function splitCsvLine(line){
    const out=[]; let cur=''; let inQ=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(inQ){
        if(c==='"'){ if(line[i+1]==='"'){cur+='"'; i++;} else {inQ=false;} }
        else cur+=c;
      }else{
        if(c===','){ out.push(cur); cur=''; }
        else if(c==='"'){ inQ=true; }
        else cur+=c;
      }
    }
    out.push(cur); return out;
  }
}
function normalizeHeaders(rows){
  if(!rows.length) return rows;
  const map = k=>k.replace(/^\uFEFF/,'').trim().toUpperCase();
  const hmap = Object.fromEntries(Object.keys(rows[0]).map(k=>[k,map(k)]));
  return rows.map(r=>{
    const o={}; for(const k in r){ o[hmap[k]]=r[k]; } return o;
  });
}
function computeTopics() {
  const rows = filteredRows();
  if (!rows.length) return { items: [], lastKey: null, lastLabel: null };

  // â˜… 48h ã® MESSAGE åˆ¥ä»¶æ•°ã‚’ã“ã“ã§ä¸€æ‹¬è¨ˆç®—
  const latest = rows[rows.length - 1].ts;
  const start48 = new Date(latest.getTime() - 48 * 3600 * 1000);
  const count48 = {};
  rows.forEach(r => {
    if (r.ts < start48 || r.ts > latest) return;
    const m = r.message;
    count48[m] = (count48[m] || 0) + 1;
  });

  const { periods, byMsg } = groupByPeriod('day');
  if (!periods.length) return { items: [], lastKey: null, lastLabel: null };

  const keys   = periods.map(p => p.key);
  const labels = periods.map(p => p.label);
  const lastIdx = keys.length - 1;
  if (lastIdx < 0) return { items: [], lastKey: null, lastLabel: null };

  const baselineDays = Math.max(1, topicsConfig.baselineDays | 0);
  const consecNeed   = Math.max(3, topicsConfig.consecDays   | 0);
  const minDaily     = Math.max(0, topicsConfig.minDaily     | 0);
  const maxCards     = Math.max(1, topicsConfig.maxCards     | 0);
  const minTotal     = Math.max(0, topicsConfig.minTotal     | 0);   // åˆè¨ˆä»¶æ•°ã—ãã„å€¤

  const items = [];

  for (const [msg, obj] of byMsg.entries()) {
    const yAll = keys.map(k => obj[k] || 0);
    if (yAll.length < Math.max(baselineDays + 1, consecNeed)) continue;

    const total = yAll.reduce((a, b) => a + b, 0);
    if (total < minTotal) continue;  // â˜… åˆè¨ˆä»¶æ•°ãŒå°‘ãªã™ãã‚‹é …ç›®ã¯é™¤å¤–

    const last = yAll[lastIdx];
    const recent48 = count48[msg] || 0;

    // â˜… æ˜¨æ—¥ã‚‚48hã‚‚ã€Œæœ€å°æ—¥ä»¶æ•°ã€æœªæº€ãªã‚‰ãƒˆãƒ”ãƒƒã‚¯ã‹ã‚‰é™¤å¤–
    if (last < minDaily && recent48 < minDaily) continue;

    const baseStart = Math.max(0, lastIdx - baselineDays);
    const baseSlice = yAll.slice(baseStart, lastIdx);
    const baseMean  = baseSlice.length
      ? baseSlice.reduce((a, b) => a + b, 0) / baseSlice.length
      : 0;

    const liftRaw = baseMean > 0 ? last / baseMean : 0;
    const liftCap = topicsConfig.liftCap ?? 0;        // 0 ãªã‚‰ç„¡åˆ¶é™
    const lift = liftCap > 0 ? Math.min(liftRaw, liftCap) : liftRaw;

    // æ€¥å¢—ï¼ˆå€ç‡ or çµ¶å¯¾å€¤ï¼‰
    const surgeByLift = baseMean > 0 &&
      last >= minDaily &&
      liftRaw >= topicsConfig.liftMin;

    const surgeByAbs  = last >= topicsConfig.absMin;
    const isSurge     = surgeByLift || surgeByAbs;

    // é€£ç¶šå¢—åŠ 
    let isConsec = false;
    if (yAll.length >= consecNeed) {
      const tail = yAll.slice(-consecNeed);
      isConsec = tail.every((v, i) => (i === 0 || v > tail[i - 1])) &&
                 tail.every(v => v >= minDaily);
    }

    if (!(isSurge || isConsec)) continue;

    // ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆ48hï¼‹é€£ç¶šå¢—åŠ ãƒœãƒ¼ãƒŠã‚¹ï¼‰
    const w48    = topicsConfig.weight48    ?? 0.5;
    const bonusC = topicsConfig.bonusConsec ?? 10;

    let score = 0;
    if (isSurge)  score += last * lift;
    if (isConsec) score += bonusC;
    score += w48 * recent48;

    const labelsView = labels.slice(-14);
    const yView      = yAll.slice(-14);

    items.push({
      msg,
      yAll, labelsAll: labels,
      y: yView, labels: labelsView,
      last, baseMean, lift,
      surgeByLift, surgeByAbs, isConsec,
      recent48, total,
      score
    });
  }

  items.sort((a, b) => b.score - a.score);
  return {
    items: items.slice(0, maxCards),
    lastKey: keys[lastIdx],
    lastLabel: labels[lastIdx]
  };
}


function renderTopics() {
  const panel = document.getElementById('panelTopics');
  const cards = document.getElementById('topicsCards');
  const hint  = document.getElementById('topicsHint');
  if (!panel || !cards) return;

  const { items, lastLabel } = computeTopics();
  cards.innerHTML = '';

  if (!items.length) {
    panel.style.display = 'none';
    return;
  }
  panel.style.display = 'block';
  hint.textContent = lastLabel ? `å¯¾è±¡æ—¥ï¼š${lastLabel}` : '';

  // â˜… ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘
  const both      = items.filter(it => (it.surgeByLift || it.surgeByAbs) && it.isConsec);
  const surgeOnly = items.filter(it => (it.surgeByLift || it.surgeByAbs) && !it.isConsec);
  const consecOnly= items.filter(it => it.isConsec && !(it.surgeByLift || it.surgeByAbs));

  const makeCard = (it) => {
    const badges = [];
    if (it.surgeByLift) badges.push(`ğŸ“ˆ æ€¥å¢—Ã—å€ç‡(${it.lift.toFixed(2)}x)`);
    if (it.surgeByAbs)  badges.push(`ğŸ”¢ æ€¥å¢—Ã—çµ¶å¯¾(${it.last})`);
    if (it.isConsec)    badges.push(`â¤´ï¸ ${topicsConfig.consecDays}æ—¥é€£ç¶šå¢—åŠ `);

    const card = document.createElement('div');
    card.className = 'card trend-up';
    card.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
        <div style="font-size:${fs(14)}px;color:var(--text-primary)">${it.msg}</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          ${badges.map(b=>`<span class="tag">${b}</span>`).join('')}
        </div>
      </div>
      <div class="hint" style="margin-top:4px">
        æ˜¨æ—¥: ${it.last}ä»¶ ï¼ ãƒ™ãƒ¼ã‚¹å¹³å‡(${topicsConfig.baselineDays}æ—¥): ${it.baseMean.toFixed(2)}ä»¶
        ï¼ 48h: ${it.recent48}ä»¶ ï¼ åˆè¨ˆ: ${it.total}ä»¶
      </div>
      <svg class="svg-s"></svg>
    `;
    card.addEventListener('click', () => openDetail(it.msg, 'day'));
    const svg = card.querySelector('svg');
    drawMiniLineWithAxes(svg, it.labels, it.y, { showValues:true });
    return card;
  };

  const renderGroup = (title, arr) => {
    if (!arr.length) return;
    const h = document.createElement('div');
    h.className = 'section-title';
    h.style.margin = '6px 2px 4px';
    h.textContent = title;
    cards.appendChild(h);
    arr.forEach(it => cards.appendChild(makeCard(it)));
  };

  // â˜… è¡¨ç¤ºé †ï¼šä¸¡æ–¹æº€ãŸã™ â†’ æ€¥å¢— â†’ é€£ç¶šå¢—åŠ 
  renderGroup('ğŸ“Š æ€¥å¢—ï¼‹é€£ç¶šå¢—åŠ ', both);
  renderGroup('ğŸ“ˆ æ€¥å¢—ãƒˆãƒ”ãƒƒã‚¯', surgeOnly);
  renderGroup('â¤´ï¸ é€£ç¶šå¢—åŠ ãƒˆãƒ”ãƒƒã‚¯', consecOnly);
}

/* ====== è¨­å®šï¼ˆãƒãƒ¼ã‚¯ï¼ç„¡è¦–ï¼‰ ====== */
function loadSettings(){
  // ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥è¨­å®šã¯æ—¢ã«loadFileConfigã§èª­ã¿è¾¼ã¿æ¸ˆã¿
  // UIåæ˜ ã®ã¿è¡Œã†
  document.querySelectorAll('#chipsMark .chip').forEach(ch=> ch.classList.toggle('active', marked.has(ch.dataset.v)));
  document.querySelectorAll('#chipsIgnore .chip').forEach(ch=> ch.classList.toggle('active', ignored.has(ch.dataset.v)));
}
function saveSettings(){
  // ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥è¨­å®šã¨ã—ã¦ä¿å­˜
  if (currentFileName) {
    saveFileConfig(currentFileName);
    $('marksHint').textContent=`${currentFileName} ã®è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ`;
  } else {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š
    localStorage.setItem(LS_MARKS, JSON.stringify([...marked]));
    localStorage.setItem(LS_IGNORES, JSON.stringify([...ignored]));
    $('marksHint').textContent='ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ï¼‰';
  }
  setTimeout(()=>$('marksHint').textContent='ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ã‚‚å³ä¿å­˜ï¼†åæ˜ ã—ã¾ã™ï¼‰',2000);
}
function instantApply(){
  saveSettings();
  renderAll();
}

// é–‹é–‰çŠ¶æ…‹ã‚’ä¿å­˜ã™ã‚‹ã‚­ãƒ¼
const LS_SETTINGS_OPEN = 'settingsOpen.v1';

// è¨­å®šãƒ‘ãƒãƒ«ã®é–‹é–‰
function toggleSettings(open) {
  const btn = document.getElementById('btnSettings');
  const panel = document.getElementById('settings');
  if (!panel || !btn) return;

  const willOpen = (typeof open === 'boolean') ? open : !panel.classList.contains('active');
  panel.classList.toggle('active', willOpen);
  btn.setAttribute('aria-expanded', String(willOpen));
  localStorage.setItem(LS_SETTINGS_OPEN, JSON.stringify(willOpen));

  if (willOpen) {
    // ãƒãƒƒãƒ—ã‚’æœ€æ–°ã®å…¨MESSAGEã§å†æç”»ï¼ˆæ¤œç´¢èªã‚’åæ˜ ï¼‰
    renderChipSets(allMessages);
    // ç”»é¢å†…ã«åã‚ã‚‹
    panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

// ãƒœã‚¿ãƒ³ã«ãƒˆã‚°ãƒ«ã‚’å‰²ã‚Šå½“ã¦
document.getElementById('btnSettings')?.addEventListener('click', (e)=>{
  e.preventDefault();
  toggleSettings();
});

// èµ·å‹•æ™‚ã«å‰å›ã®é–‹é–‰çŠ¶æ…‹ã‚’å¾©å…ƒ
document.addEventListener('DOMContentLoaded', ()=>{
  const saved = localStorage.getItem(LS_SETTINGS_OPEN);
  const open = saved ? JSON.parse(saved) : false;
  toggleSettings(open);
});





function renderChipSets(list){
  const kw = $('searchMsg').value?.toLowerCase()||'';
  const kw2= $('searchIgnore').value?.toLowerCase()||'';
  const wrapM = $('chipsMark'); const wrapI = $('chipsIgnore');
  wrapM.innerHTML=''; wrapI.innerHTML='';
  list.filter(m=>m.toLowerCase().includes(kw)).forEach(m=>{
    const div = document.createElement('div'); div.className='chip'; div.dataset.v=m;
    if(marked.has(m)) div.classList.add('active');
    div.textContent = m;
    div.addEventListener('click',()=>{
      div.classList.toggle('active');
      if(div.classList.contains('active')) marked.add(m); else marked.delete(m);
      instantApply();        // â† ã‚¯ãƒªãƒƒã‚¯å³ä¿å­˜ï¼†å³åæ˜ 
    });
    wrapM.appendChild(div);
  });
  list.filter(m=>m.toLowerCase().includes(kw2)).forEach(m=>{
    const div = document.createElement('div'); div.className='chip'; div.dataset.v=m;
    if(ignored.has(m)) div.classList.add('active');
    div.textContent = m;
    div.addEventListener('click',()=>{
      div.classList.toggle('active');
      if(div.classList.contains('active')) ignored.add(m); else ignored.delete(m);
      instantApply();        // â† ã‚¯ãƒªãƒƒã‚¯å³ä¿å­˜ï¼†å³åæ˜ 
    });
    wrapI.appendChild(div);
  });
}

/* ====== ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ ====== */
function filteredRows(){
  if(ignored.size===0) return rowsWithDT;
  return rowsWithDT.filter(r=>!ignored.has(r.message));
}

/* ====== 48h å¯è¦–åŒ– ====== */
function render48h(){
  const rows = filteredRows();
  const svg = $('svg48h'); svg.innerHTML='';
  const legend = $('legendTop5'); legend.innerHTML='';
  const svgCause = $('svgTopCauses24'); svgCause.innerHTML='';
  if(!rows.length){ $('h48Range').textContent='-'; $('vTotal48').textContent='-'; $('vPeak').textContent='-'; return; }

  const latest = rows[rows.length-1].ts;
  const end = new Date(latest);
  const start48 = new Date(latest.getTime() - 48*3600*1000);
  const start24 = new Date(latest.getTime() - 24*3600*1000);
  $('h48Range').textContent = `${start48.toLocaleString()} ï½ ${end.toLocaleString()}`;

  // 48h ãƒ“ãƒ³ä½œæˆ
  const bins48=[], labels48=[], labelsFull=[];
  for(let i=0;i<48;i++){
    const from = new Date(start48.getTime()+i*3600*1000);
    const to   = new Date(from.getTime()+3600*1000);
    bins48.push({from,to,count:0});
    labels48.push(from.getHours().toString().padStart(2,'0')+':00');
    labelsFull.push(`${from.getMonth()+1}/${String(from.getDate()).padStart(2,'0')} ${String(from.getHours()).padStart(2,'0')}:00`);
  }

  rows.forEach(r=>{
    if(r.ts<start48 || r.ts>end) return;
    const idx = Math.floor((r.ts - start48)/3600000);
    if(idx>=0 && idx<48) bins48[idx].count++;
  });
  const counts48 = bins48.map(b=>b.count);
  const total48 = counts48.reduce((a,b)=>a+b,0);
  const peakIdx = counts48.indexOf(Math.max(...counts48));
  $('vTotal48').textContent = fmt(total48);
  $('vPeak').textContent = peakIdx>=0 ? `${labelsFull[peakIdx]}ï¼ˆ${fmt(counts48[peakIdx])}ï¼‰` : '-';

  // 24h åŸå› TOP5
  const cause24 = new Map();
  rows.forEach(r=>{
    if(r.ts<start24 || r.ts>end) return;
    cause24.set(r.message, (cause24.get(r.message)||0)+1);
  });
  const top5 = [...cause24.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5);
  top5.forEach((pair,i)=>{
    const li = document.createElement('div'); li.className='legend-item';
    const c = document.createElement('div'); c.className='dot'; c.style.background=COLORS[i%COLORS.length];
    const t = document.createElement('span'); t.textContent = `${pair[0]}ï¼ˆ${pair[1]}ï¼‰`;
    li.appendChild(c); li.appendChild(t); legend.appendChild(li);
  });

  // å„MESSAGEã®48hç³»åˆ—ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰
  const series48 = top5.map((pair,i)=>{
    const name = pair[0];
    const arr = new Array(48).fill(0);
    rows.forEach(r=>{
      if(r.ts<start48 || r.ts>end) return;
      if(r.message!==name) return;
      const idx = Math.floor((r.ts - start48)/3600000);
      if(idx>=0 && idx<48) arr[idx]++;
    });
    return {name, y:arr, color:COLORS[i%COLORS.length]};
  });

  drawBarWithOverlays(svg, labelsFull, counts48, series48, {height:440, bottom:140, top:40, showDaySplit:true});
  drawHBar(svgCause, top5, {height:440});
}

/* ====== ç²’åº¦åˆ¥ãƒˆãƒ¬ãƒ³ãƒ‰ TOP3 ====== */
function groupByPeriod(gran){
  const map = new Map(); // key: period|message -> count
  const periodsSet = new Set();
  for(const r of filteredRows()){
    let keyPeriod, xLabel;
    if(gran==='day'){ keyPeriod = toYMD(r.ts); xLabel = keyPeriod.replace(/^\d{4}-/,''); }
    else if(gran==='week'){ const wk = getWeekKey(r.ts); keyPeriod = wk.key; xLabel = wk.startLabel; }
    else { keyPeriod = getMonthKey(r.ts); xLabel = keyPeriod.replace(/^(\d{4})-(\d{2})$/,'$1/$2'); }
    periodsSet.add(JSON.stringify({key:keyPeriod, label:xLabel}));
    const key = keyPeriod+'|'+r.message;
    map.set(key, (map.get(key)||0)+1);
  }
  const periods = [...periodsSet].map(s=>JSON.parse(s)).sort((a,b)=>a.key.localeCompare(b.key));
  const byMsg = new Map(); // message -> {period->count}
  for(const [k,v] of map.entries()){
    const [p,msg] = k.split('|');
    if(!byMsg.has(msg)) byMsg.set(msg,{});
    byMsg.get(msg)[p]=v;
  }
  return {periods, byMsg};
}

function renderTrends(){
  const cfg = {
    day:   {panel:'cardsDay',   look:DEFAULT_LOOKBACK.day,   title:'æ—¥'},
    week:  {panel:'cardsWeek',  look:DEFAULT_LOOKBACK.week,  title:'é€±'},
    month: {panel:'cardsMonth', look:DEFAULT_LOOKBACK.month, title:'æœˆ'},
  };

  // 48hä»¶æ•°ï¼ˆå…¨MESSAGEï¼‰ã‚’ä¸€åº¦ã ã‘ä½œã‚‹
  const rowsAll = filteredRows();
  const count48All = {};
  if (rowsAll.length) {
    const latest = rowsAll[rowsAll.length - 1].ts;
    const start48 = new Date(latest.getTime() - 48 * 3600 * 1000);
    rowsAll.forEach(r => {
      if (r.ts >= start48 && r.ts <= latest) {
        count48All[r.message] = (count48All[r.message] || 0) + 1;
      }
    });
  }

  for (const gran of ['day','week','month']) {
    const { periods, byMsg } = groupByPeriod(gran);
    const container = $(cfg[gran].panel);
    container.innerHTML = '';
    if (periods.length === 0) {
      container.innerHTML = '<div class="hint">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
      continue;
    }

    const look = Math.min(cfg[gran].look, periods.length);
    const usePeriods = periods.slice(-look);

    // ===== recs ã‚’ã“ã“ã§ä½œã‚‹ï¼ˆå¿…ãšå®šç¾©ï¼‰=====
    const recs = [];
    const r2Min = 0.20;
    const sumMin = 10;
    const recentMin = 5;
    const baseMin = 5;

    for (const [msg, obj] of byMsg.entries()) {
      const y = usePeriods.map(p => obj[p.key] || 0);
      const n = y.length;
      const sum = y.reduce((a,b)=>a+b, 0);
      if (sum < sumMin) continue;
      if (y.every(v => v === y[0])) continue; // å®Œå…¨ãƒ•ãƒ©ãƒƒãƒˆé™¤å¤–

      // å¾ŒåŠé‡ã¿ä»˜ãå›å¸°
      const xs = [...y.keys()];
      const w  = xs.map(i => 0.6 + 0.4 * (i / Math.max(1, n-1)));
      const W  = w.reduce((a,b)=>a+b,0);
      const xw = xs.reduce((a,i)=>a + w[i]*i, 0) / W;
      const yw = y.reduce((a,yi,i)=>a + w[i]*yi, 0) / W;

      let num=0, den=0, sst=0, ssr=0;
      for (let i=0;i<n;i++){
        num += w[i]*(i - xw)*(y[i] - yw);
        den += w[i]*(i - xw)*(i - xw);
      }
      const slope = den ? (num/den) : 0;
      const intercept = yw - slope*xw;

      for (let i=0;i<n;i++){
        const yhat = slope*i + intercept;
        sst += w[i]*(y[i] - yw)*(y[i] - yw);
        ssr += w[i]*(y[i] - yhat)*(y[i] - yhat);
      }
      const r2 = sst ? Math.max(0, 1 - ssr/sst) : 0;
      if (r2 < r2Min) continue;

      const mean = sum / n || 0;
      const slopePct = slope / Math.max(1, mean);

      // ===== ã“ã“ã‹ã‚‰ã€Œéå»ï¼æœ€è¿‘ã€ã®æ¯”ç‡ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ—¥7:3 / é€±3:1 / æœˆ2:1ï¼‰ =====
      let base = [];
      let recent = [];

      if (gran === 'day') {
        // ç›´è¿‘10æ—¥ â†’ éå»7æ—¥ / æœ€è¿‘3æ—¥
        const total = Math.min(10, n);          // å®Ÿãƒ‡ãƒ¼ã‚¿ãŒ10æ—¥æœªæº€ã®æ™‚ã‚‚ã‚±ã‚¢
        const start = n - total;                // ç›´è¿‘ total æ—¥ã®å…ˆé ­
        const baseEnd = start + Math.min(7, total - 1); // æœ€ä½1æ—¥ã¯æœ€è¿‘å´ã«æ®‹ã™
        base   = y.slice(start, baseEnd);
        recent = y.slice(baseEnd, start + total);
      } else if (gran === 'week') {
        // ç›´è¿‘4é€± â†’ éå»3é€± / æœ€è¿‘1é€±
        const total = Math.min(4, n);
        const start = n - total;
        const baseEnd = start + Math.min(3, total - 1);
        base   = y.slice(start, baseEnd);
        recent = y.slice(baseEnd, start + total);
      } else {
        // monthï¼šç›´è¿‘3ãƒ¶æœˆ â†’ éå»2ãƒ¶æœˆ / æœ€è¿‘1ãƒ¶æœˆ
        const total = Math.min(3, n);
        const start = n - total;
        const baseEnd = start + Math.min(2, total - 1);
        base   = y.slice(start, baseEnd);
        recent = y.slice(baseEnd, start + total);
      }

      // ãƒ‡ãƒ¼ã‚¿ãŒè¶³ã‚Šãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
      if (!base.length || !recent.length) continue;

      const baseMean = base.reduce((a,b)=>a+b,0) / base.length;
      const recentMean = recent.reduce((a,b)=>a+b,0) / recent.length;
      const recentSum = recent.reduce((a,b)=>a+b,0);

      const lift = recentMean / Math.max(1, baseMean);
      const liftDown = baseMean / Math.max(1, recentMean);
      const stability = Math.min(1, sum / 30);

      let scoreUp = 0, scoreDn = 0;
      if (slopePct > 0 && recentSum >= recentMin) {
        scoreUp = slopePct * r2 * lift * stability;
        if (lift < 1.2) scoreUp *= 0.5;
      }
      if (slopePct < 0 && baseMean >= baseMin) {
        scoreDn = (-slopePct) * r2 * liftDown * stability;
        if (liftDown < 1.2) scoreDn *= 0.5;
      }
      if (scoreUp  < 0.01) scoreUp  = 0;
      if (scoreDn  < 0.01) scoreDn  = 0;

      recs.push({
        msg, y,
        labels: usePeriods.map(p=>p.label),
        slope, r2, sum, mean, scoreUp, scoreDn,
        baseMean, recentMean, lift, liftDown
      });
    }
    // ===== ã“ã“ã¾ã§ recs =====

    const up = recs.filter(r => r.scoreUp > 0).sort((a,b) => b.scoreUp - a.scoreUp).slice(0,3);
    const dn = recs.filter(r => r.scoreDn > 0).sort((a,b) => b.scoreDn - a.scoreDn).slice(0,3);

    const makeCard = (r, dir) => {
      const msg = r.msg; // â† ã“ã“ã§å¿…ãšãƒ­ãƒ¼ã‚«ãƒ«åŒ–
      const card = document.createElement('div');
      card.className = dir === 'up' ? 'card trend-up' : 'card trend-down';

      const lastMemoAt = (memos[msg] && memos[msg].length)
        ? memos[msg].map(x=>x.atISO).sort().slice(-1)[0].replace('T',' ')
        : null;

      card.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div style="font-size:${fs(14)}px;color:var(--text-primary)">${msg}</div>
          <div style="display:flex;gap:6px;align-items:center">
            <span class="tag">48h: ${fmt(count48All[msg] || 0)}</span>
            ${ lastMemoAt ? `<span class="tag" title="æœ€å¾Œã®å¯¾å¿œæ—¥æ™‚">ğŸ•’ ${lastMemoAt}</span>` : '' }
          </div>
        </div>
        <svg class="svg-s"></svg>
      `;
      card.addEventListener('click', () => openDetail(msg, $('granularity').value));
      drawMiniLineWithAxes(card.querySelector('svg'), r.labels, r.y, { showValues:true });
      return card;
    };

    up.forEach(r => container.appendChild(makeCard(r, 'up')));
    dn.forEach(r => container.appendChild(makeCard(r, 'down')));
  }
}




/* ====== ãƒãƒ¼ã‚¯ç•°å¸¸ã®å€‹åˆ¥ãƒ¢ãƒ‹ã‚¿ ====== */
/* ====== ãƒãƒ¼ã‚¯ç•°å¸¸ã®å€‹åˆ¥ãƒ¢ãƒ‹ã‚¿ ====== */
function renderMarked() {
  const rows = filteredRows();
  const wrap = $('markedGrid');
  wrap.innerHTML = '';

  if (marked.size === 0) {
    wrap.innerHTML = '<div class="hint">ï¼ˆè¨­å®šã§MESSAGEã‚’ãƒãƒ¼ã‚¯ã™ã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</div>';
    return;
  }
  if (!rows.length) return;

  // ç›´è¿‘48hç¯„å›²
  const latest = rows[rows.length - 1].ts;
  const start48 = new Date(latest.getTime() - 48 * 3600 * 1000);

  // 48hã®ä»¶æ•°
  const count48 = {};
  rows.forEach(r => {
    if (r.ts < start48 || r.ts > latest) return;
    if (!marked.has(r.message)) return;
    count48[r.message] = (count48[r.message] || 0) + 1;
  });

  // ç›´è¿‘14æ—¥ï¼ˆæ—¥ç²’åº¦ï¼‰ã‚¹ãƒ‘ãƒ¼ã‚¯
  const dayMap = new Map();
  const periodsSet = new Set();
  for (const r of rows) {
    const p = toYMD(r.ts);
    periodsSet.add(p);
    if (marked.has(r.message)) {
      const k = p + '|' + r.message;
      dayMap.set(k, (dayMap.get(k) || 0) + 1);
    }
  }

  const days   = [...periodsSet].sort();
  const useDays = days.slice(-14);
  const labels = useDays.map(d => d.replace(/^\d{4}-/, ''));

  // ãƒãƒ¼ã‚¯æ¸ˆã¿MESSAGEã”ã¨ã«ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
  marked.forEach(msg => {
    const y = useDays.map(p => dayMap.get(p + '|' + msg) || 0);

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="font-size:${fs(14)}px;color:var(--text-primary)">${msg}</div>
        <span class="tag">48h: ${fmt(count48[msg] || 0)}</span>
      </div>
      <svg class="svg-s"></svg>
    `;

    card.addEventListener('click', () => openDetail(msg, $('granularity').value));

    const svg = card.querySelector('svg');
    drawMiniLineWithAxes(svg, labels, y, { showValues: true });

    wrap.appendChild(card);
  });
}


// ===== ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºç¯„å›²ã®çŠ¶æ…‹ =====
const modalView = {
  msg: '', gran: 'day',
  y: [], labels: [],
  window: 12,   // è¡¨ç¤ºå¹…ï¼ˆæœŸé–“æ•°ï¼‰
  offset: 0     // å·¦ç«¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
};

// ç¯„å›²ã«å¿œã˜ã¦ã‚µãƒ–ã‚»ãƒƒãƒˆã‚’ä½œã£ã¦æç”»
function renderDetailChart() {
  const n = modalView.y.length;
  if (!n) { $('svgDetail').innerHTML = '<text x="10" y="24">ãƒ‡ãƒ¼ã‚¿ãªã—</text>'; return; }

  // ã‚¬ãƒ¼ãƒ‰ï¼†ã‚¯ãƒ©ãƒ³ãƒ—
  modalView.window = Math.max(3, Math.min(n, modalView.window));
  modalView.offset = Math.max(0, Math.min(n - modalView.window, modalView.offset));

  const i0 = modalView.offset;
  const i1 = i0 + modalView.window;
  const ySub = modalView.y.slice(i0, i1);
  const lSub = modalView.labels.slice(i0, i1);

  // KPIï¼ˆåˆè¨ˆãƒ»å¹³å‡ãƒ»å‚¾ããƒ»R2ï¼‰ã‚‚ã‚µãƒ–ã‚»ãƒƒãƒˆã«åˆã‚ã›ã¦æ›´æ–°ã™ã‚‹ãªã‚‰ã“ã“ã§è¨ˆç®—
  const sum = ySub.reduce((a,b)=>a+b,0);
  const avg = ySub.length ? sum / ySub.length : 0;
  const { slope, r2 } = computeTrend(ySub);
  $('mTotal').textContent = fmt(sum);
  $('mAvg').textContent   = avg.toFixed(2);
  $('mSlope').textContent = slope.toFixed(2);
  $('mR2').textContent    = r2.toFixed(2);

  // æç”»
  drawMiniLineWithAxes($('svgDetail'), lSub, ySub, { large:true, showValues:true, xTitle:'æœŸé–“', yTitle:'ä»¶æ•°' });

  // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¡¨ç¤ºå€¤ã®åŒæœŸ
  const rW = $('rangeWindow'), rO = $('rangeOffset');
  const lblW = $('lblWindow');
  if (rW && rO && lblW) {
    rW.max = String(n);         // ä¸Šé™ï¼å…¨æœŸé–“
    rW.value = String(modalView.window);
    lblW.textContent = String(modalView.window);

    rO.max = String(Math.max(0, n - modalView.window));
    rO.value = String(modalView.offset);
  }
}

/* ====== è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« ====== */
async function openDetail(msg, gran) {
  // ãƒ‡ãƒ¼ã‚¿çµ„ã¿ç«‹ã¦ï¼ˆå…¨æœŸé–“ï¼‰
  const { periods, byMsg } = groupByPeriod(gran);
  const series = (byMsg.get(msg) || {});
  const y = periods.map(p => series[p.key] || 0);
  const labels = periods.map(p => p.label);

  modalView.msg = msg;
  modalView.gran = gran;
  modalView.y = y;
  modalView.labels = labels;

  // åˆå›ã¯ã€Œæœ€è¿‘12æœŸé–“ã€ã‚’è¡¨ç¤ºï¼ˆè¶³ã‚Šãªã‘ã‚Œã°å…¨ä½“ï¼‰
  const n = y.length;
  modalView.window = Math.min(12, n || 12);
  modalView.offset = Math.max(0, n - modalView.window);

  // ã‚¿ã‚¤ãƒˆãƒ«ï¼†ç²’åº¦ã‚»ãƒ¬ã‚¯ãƒˆ
  $('modalTitle').textContent = `${msg}ï¼ˆ${gran.toUpperCase()}ï¼‰`;
  const sel = $('modalGran');
  if (sel) {
    sel.value = gran;
    sel.onchange = () => openDetail(msg, sel.value); // ç²’åº¦å¤‰æ›´â†’å†æ§‹ç¯‰
  }
$('memoText') && ($('memoText').value = '');
$('memoAt')   && ($('memoAt').value   = toLocalDatetimeValue(new Date()));
  await syncMemosFromFirebase(msg);   // â† ã“ã‚Œã‚’è¿½åŠ 

renderMemoList(msg); // â† Firebaseã‹ã‚‰è¡¨ç¤º

const btnSave = $('btnMemoSave');
if (btnSave) {
  btnSave.onclick = async () => {
    const note = ($('memoText')?.value || '').trim();
    const at   = $('memoAt')?.value || '';
    if (!note) { alert('å¯¾å¿œå†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    if (!at)   { alert('å¯¾å¿œæ—¥æ™‚ã‚’æŒ‡å®šã—ã¦ãã ã•ã„'); return; }

    // UIãƒ­ãƒƒã‚¯
    btnSave.disabled = true;
    const orig = btnSave.textContent;
    btnSave.textContent = 'ä¿å­˜ä¸­...';

    try{
      // â–¼ å¿…ãš Firebase ã«ä¿å­˜
      const newId = await addMemoToFirebase(msg, note, at);

      // ãƒ­ãƒ¼ã‚«ãƒ«ã¯åŒæœŸã—ãŸã„å ´åˆã®ã¿åæ˜ ï¼ˆä»»æ„ï¼‰
      if (!memos[msg]) memos[msg] = [];
      memos[msg].push({ id: newId, note, atISO: at });

      // å…¥åŠ›ã‚¯ãƒªã‚¢ï¼†å†èª­è¾¼
    // å…¥åŠ›ã‚¯ãƒªã‚¢
$('memoText').value = '';
$('memoAt').value   = toLocalDatetimeValue(new Date());

// Firebase â†’ ãƒ­ãƒ¼ã‚«ãƒ«å†åŒæœŸã—ã¦ã‹ã‚‰æç”»
await syncMemosFromFirebase(msg);
renderMemoList(msg);
renderTrends();
renderMarked();

    }catch(err){
      alert('Firebaseã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
    }finally{
      btnSave.disabled = false;
      btnSave.textContent = orig;
    }
  };
}
  // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
  const rW = $('rangeWindow'), rO = $('rangeOffset');
  if (rW) {
    rW.oninput = () => { modalView.window = Number(rW.value) || modalView.window; renderDetailChart(); };
  }
  if (rO) {
    rO.oninput = () => { modalView.offset = Number(rO.value) || modalView.offset; renderDetailChart(); };
  }

  // ã‚ºãƒ¼ãƒ ãƒœã‚¿ãƒ³
  $('btnZoomIn')?.addEventListener('click', () => {
    // 1æ®µéšæ‹¡å¤§ï¼ˆè¡¨ç¤ºå¹…ã‚’ç¸®ã‚ã‚‹ï¼‰
    modalView.window = Math.max(3, modalView.window - Math.ceil(modalView.window * 0.2) || 1);
    renderDetailChart();
  });
  $('btnZoomOut')?.addEventListener('click', () => {
    // 1æ®µéšç¸®å°ï¼ˆè¡¨ç¤ºå¹…ã‚’åºƒã’ã‚‹ï¼‰
    modalView.window = Math.min(modalView.y.length, modalView.window + Math.ceil(modalView.window * 0.2) || 1);
    renderDetailChart();
  });
  $('btnZoomReset')?.addEventListener('click', () => {
    modalView.window = modalView.y.length;
    modalView.offset = 0;
    renderDetailChart();
    
  });

  // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ ã€ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆä»»æ„ï¼‰
  const svg = $('svgDetail');
  if (svg) {
    // wheel ã‚ºãƒ¼ãƒ ï¼ˆã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’ä¸­å¿ƒã£ã½ãèª¿æ•´ï¼‰
    svg.onwheel = (ev) => {
      ev.preventDefault();
      const dir = Math.sign(ev.deltaY);
      const n = modalView.y.length;
      const delta = Math.max(1, Math.round(modalView.window * 0.1));
      if (dir > 0) modalView.window = Math.min(n, modalView.window + delta);
      else         modalView.window = Math.max(3, modalView.window - delta);

      // ã‚ªãƒ•ã‚»ãƒƒãƒˆèª¿æ•´ï¼ˆå·¦å³ã«å¯„ã‚Šã™ããªã„ã‚ˆã†è»½ãè£œæ­£ï¼‰
      modalView.offset = Math.max(0, Math.min(n - modalView.window, modalView.offset));
      renderDetailChart();


      
    };

    // ãƒ‰ãƒ©ãƒƒã‚°ãƒ»ãƒ‘ãƒ³
    let dragging = false, startX = 0, startOffset = 0;
    svg.onmousedown = (e) => { dragging = true; startX = e.clientX; startOffset = modalView.offset; };
    window.onmouseup = () => { dragging = false; };
    window.onmousemove = (e) => {
      if (!dragging) return;
      const n = modalView.y.length;
      // ã–ã£ãã‚Š 20px ã§ 1ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å‹•ãæ„Ÿã˜ã®ç°¡æ˜“ãƒ‘ãƒ³
      const dx = e.clientX - startX;
      const step = Math.round(-dx / 20);
      modalView.offset = Math.max(0, Math.min(n - modalView.window, startOffset + step));
      renderDetailChart();
    };
  }

  // è¡¨ç¤ºï¼†åˆå›æç”»
  const md = $('detailModal');
  md.classList.add('active');
  md.style.display = 'flex';
  md.setAttribute('aria-hidden', 'false');

  renderDetailChart();
}


function closeModal(){
  const md=$('detailModal');
  md.classList.remove('active'); md.style.display='none'; md.setAttribute('aria-hidden','true');
}
$('modalClose').addEventListener('click', closeModal);
$('detailModal').addEventListener('click',(e)=>{ if(!e.target.closest('.modal-content')) closeModal(); });
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && $('detailModal').classList.contains('active')) closeModal(); });

/* ====== æç”»é–¢æ•° ====== */
// ãƒ†ãƒ¼ãƒã«å¿œã˜ãŸè‰²ã‚’å–å¾—
function getThemeColor(lightColor, darkColor) {
  const theme = document.documentElement.getAttribute('data-theme') || 'light';
  return theme === 'dark' ? darkColor : lightColor;
}

function drawBarWithOverlays(svgEl, labelsFull, data, overlays, opts={}){
  const width = svgEl.clientWidth || 900;
  const height = opts.height || 440;
  const pad = {t:opts.top??40,r:40,b:opts.bottom??140,l:54};
  svgEl.setAttribute('viewBox',`0 0 ${width} ${height}`);
  svgEl.innerHTML='';
  const maxV = Math.max(...data, ...overlays.flatMap(o=>o.y), 1);
  const n = data.length || 1;
  const chartW = width - pad.l - pad.r;
  const chartH = height - pad.t - pad.b;
  const space = chartW / n;
  const bw = Math.max(2, space*0.7);

  // èƒŒæ™¯
  svgEl.appendChild(rect(0,0,width,height,getThemeColor('#fff','#1e293b')));

  // Yã‚°ãƒªãƒƒãƒ‰ï¼†ãƒ©ãƒ™ãƒ«
  for(let i=0;i<=4;i++){
    const y = pad.t + chartH*i/4;
    svgEl.appendChild(line(pad.l,y,width-pad.r,y,getThemeColor('#e5e7eb','#334155'),1));
    const val = Math.round(maxV*(1 - i/4));
    svgEl.appendChild(text(pad.l-8, y+4, String(val), fs(10), getThemeColor('#475569','#94a3b8'), 'end'));
  }

  // Xè»¸
  svgEl.appendChild(line(pad.l, height-pad.b, width-pad.r, height-pad.b, getThemeColor('#cbd5e1','#475569'), 1.5));

  // 0æ™‚ã®ç¸¦åˆ†å‰²ç·šï¼†ä¸Šéƒ¨æ—¥ä»˜ãƒ©ãƒ™ãƒ«
  if(opts.showDaySplit){
    for(let i=0;i<n;i++){
      const lbl = labelsFull[i]; // "MM/DD HH:00"
      const isZero = /\s00:00$/.test(lbl);
      if(isZero){
        const x = pad.l + i*space + space/2;
        svgEl.appendChild(line(x, pad.t, x, height-pad.b, getThemeColor('#e2e8f0','#334155'), 1));
        const d = lbl.split(' ')[0]; // "MM/DD"
        svgEl.appendChild(text(x, pad.t-8, d, 11, getThemeColor('#334155','#cbd5e1'), 'middle'));
      }
    }
  }

  // æ£’
  const step = Math.max(1, Math.ceil(n / Math.max(12, Math.min(24, Math.floor(chartW/48)))));
  for(let i=0;i<n;i++){
    const v = data[i];
    const cx = pad.l + i*space + space/2;
    const barH = (v/maxV)*chartH;
    const x = cx - bw/2;
    const y = height - pad.b - barH;
    const r = rect(x,y,bw,Math.max(0,barH),'#667eea'); r.setAttribute('rx','3');
    svgEl.appendChild(r);

    if (i%step===0 || i===n-1 || i===0){
      const ty1 = height - pad.b, ty2 = ty1 + 6;
      svgEl.appendChild(line(cx,ty1,cx,ty2,getThemeColor('#94a3b8','#64748b'),1));
     const baseY = ty2 + 18;
      // æ™‚åˆ»ã®ã¿ï¼ˆHH:00ï¼‰ã‚’è¡¨ç¤ºã€‚é‡ãªã‚Šè»½æ¸›ã®ãŸã‚çŸ­ãã™ã‚‹
      const lab = (labelsFull[i].split(' ')[1] || labelsFull[i]); // "HH:00"
      const t = text(cx, baseY, lab, fs(10), getThemeColor('#334155','#cbd5e1'), 'start');
      t.setAttribute('transform',`rotate(-60 ${cx} ${baseY})`);
      svgEl.appendChild(t);
    }
  }

  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æŠ˜ã‚Œç·š
  overlays.forEach((s)=>{
    const path = [];
    for(let i=0;i<n;i++){
      const x = pad.l + i*space + space/2;
      const y = height - pad.b - (s.y[i]/maxV)*chartH;
      path.push(i===0?`M${x} ${y}`:`L${x} ${y}`);
      svgEl.appendChild(circle(x,y,2.5,s.color));
    }
    const p = document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d', path.join(' '));
    p.setAttribute('fill','none');
    p.setAttribute('stroke', s.color);
    p.setAttribute('stroke-width','2');
    svgEl.appendChild(p);
  });

  function line(x1,y1,x2,y2,stroke,w){
    const el=document.createElementNS('http://www.w3.org/2000/svg','line');
    el.setAttribute('x1',x1); el.setAttribute('y1',y1); el.setAttribute('x2',x2); el.setAttribute('y2',y2);
    el.setAttribute('stroke',stroke); el.setAttribute('stroke-width',w); return el;
  }
  function text(x,y,str,fs,fill,anchor='start'){
    const el=document.createElementNS('http://www.w3.org/2000/svg','text');
    el.setAttribute('x',x); el.setAttribute('y',y); el.setAttribute('font-size',fs);
    el.setAttribute('fill',fill); el.setAttribute('text-anchor',anchor);
    el.textContent=str; return el;
  }
  function rect(x,y,w,h,fill){ const el=document.createElementNS('http://www.w3.org/2000/svg','rect');
    el.setAttribute('x',x);el.setAttribute('y',y);el.setAttribute('width',w);el.setAttribute('height',h);
    el.setAttribute('fill',fill); return el;
  }
  function circle(cx,cy,r,fill){ const el=document.createElementNS('http://www.w3.org/2000/svg','circle');
    el.setAttribute('cx',cx); el.setAttribute('cy',cy); el.setAttribute('r',r); el.setAttribute('fill',fill); return el;
  }
}

// --- ç½®æ›ï¼šåŸå› TOP5ï¼ˆæ¨ªæ£’ï¼‰ ---
function drawHBar(svgEl, pairs, opts = {}) {
  const width = svgEl.clientWidth || 640;
  const height = opts.height || 440;
  const pad = { t: 18, r: 24, b: 16, l: 320 };
  svgEl.setAttribute("viewBox", `0 0 ${width} ${height}`);
  svgEl.innerHTML = "";

  if (!pairs.length) {
    svgEl.innerHTML =
      '<text x="20" y="30" fill="' + getThemeColor('#64748b','#94a3b8') + '" font-size="' +
      fs(12) +
      '">ãƒ‡ãƒ¼ã‚¿ãªã—</text>';
    return;
  }

  // --- æŠ˜ã‚Šè¿”ã—ãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
  function wrapSvgText(svg, x, y, text, maxWidth, lineHeight, fontSize, fill, anchor = "end") {
    const breakers = /([ ã€€ã€ã€‚ãƒ»ï¼\/\-ï¼ˆï¼‰\(\)ï¼¿_])/;
    const tokens = text.split(breakers).filter((s) => s !== "");

    const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
    txt.setAttribute("x", x);
    txt.setAttribute("y", y);
    txt.setAttribute("text-anchor", anchor);
    txt.setAttribute("font-size", fontSize);
    txt.setAttribute("fill", fill);
    svg.appendChild(txt);

    let line = "";
    let tspan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
    tspan.setAttribute("x", x);
    tspan.setAttribute("dy", 0);
    txt.appendChild(tspan);

    const testLen = () => tspan.getComputedTextLength();

    tokens.forEach((tok) => {
      const probe = line + tok;
      tspan.textContent = probe;
      if (line === "") {
        line = tok;
        return;
      }
      if (testLen() <= maxWidth) {
        line = probe;
      } else {
        tspan.textContent = line;
        line = tok;
        tspan = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
        tspan.setAttribute("x", x);
        tspan.setAttribute("dy", lineHeight);
        txt.appendChild(tspan);
        tspan.textContent = line;
      }
    });
    tspan.textContent = line;
    return txt;
  }

  const maxV = Math.max(...pairs.map((p) => p[1]), 1);
  const n = pairs.length;
  const rowH = Math.max(18, (height - pad.t - pad.b) / n - 8);

  pairs.forEach((p, idx) => {
    const label = p[0],
      v = p[1];
    const y = pad.t + idx * (rowH + 8);
    const x = pad.l;
    const w = (width - pad.l - pad.r) * (v / maxV);

    const r = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    r.setAttribute("x", x);
    r.setAttribute("y", y);
    r.setAttribute("width", w);
    r.setAttribute("height", rowH);
    r.setAttribute("fill", "#764ba2");
    r.setAttribute("rx", "4");
    svgEl.appendChild(r);

    const fontSize = fs(13);
    const lineHeight = Math.max(14, Math.round(fontSize * 1.2));
    const maxLabelWidth = pad.l - 40;

    wrapSvgText(
      svgEl,
      x - 10,
      y + rowH / 2,
      label,
      maxLabelWidth,
      lineHeight,
      fontSize,
      getThemeColor("#0f172a","#f1f5f9"),
      "end"
    ).addEventListener('click', () => openDetail(label, $('granularity').value));

    const t2 = document.createElementNS("http://www.w3.org/2000/svg", "text");
    t2.setAttribute("x", x + w + 8);
    t2.setAttribute("y", y + rowH / 2 + 4);
    t2.setAttribute("font-size", fs(12));
    t2.setAttribute("fill", getThemeColor("#334155","#cbd5e1"));
    t2.textContent = String(v);
    svgEl.appendChild(t2);
  });
}


function drawMiniLineWithAxes(svgEl, labels, y, opts={}){
  const w = svgEl.clientWidth || (opts.large?900:360), h = opts.large?300:150;
  const pad = opts.large 
    ? {l:54,r:48,t:20,b:88}
    : {l:44,r:36,t:16,b:52};
  
  svgEl.setAttribute('viewBox',`0 0 ${w} ${h}`); 
  svgEl.innerHTML='';
  
  if(!y.length){ 
    svgEl.innerHTML='<text x="10" y="24" fill="' + getThemeColor('#64748b','#94a3b8') + '" font-size="12">ãƒ‡ãƒ¼ã‚¿ãªã—</text>'; 
    return; 
  }
  
  const maxV = Math.max(...y,1);
  const n=y.length;
  const cw = w-pad.l-pad.r, ch = h-pad.t-pad.b;
  const sx = cw/(Math.max(1,n-1));

  // Yè»¸ã‚°ãƒªãƒƒãƒ‰
  for(let i=0;i<=4;i++){
    const yy = pad.t + ch*i/4;
    const val = Math.round(maxV*(1 - i/4));
    svgEl.appendChild(line(pad.l,yy,w-pad.r,yy,getThemeColor('#e5e7eb','#334155'),1));
    const t = text(pad.l-8, yy+4, String(val), 10, getThemeColor('#475569','#94a3b8'), 'end'); 
    svgEl.appendChild(t);
  }
  
  // Xè»¸
  svgEl.appendChild(line(pad.l, h-pad.b, w-pad.r, h-pad.b, getThemeColor('#cbd5e1','#475569'), 1.5));

  // Xè»¸ãƒ©ãƒ™ãƒ«
  const step = opts.large 
    ? Math.max(1, Math.ceil(n / 14))
    : Math.max(1, Math.ceil(n / 8));
  
  labels.forEach((lb,i)=>{
    if(i%step!==0 && i!==n-1 && i!==0) return;
    
    let tx = pad.l + i*sx;
    const ty1 = h-pad.b, ty2 = ty1 + 6;
    svgEl.appendChild(line(tx,ty1,tx,ty2,getThemeColor('#94a3b8','#64748b'),1));
    
    const baseY = ty2 + (opts.large ? 20 : 18);
    const isLast = (i===n-1);
    if(isLast) tx -= 6;
    
    const t = text(tx, baseY, lb, fs(10), getThemeColor('#334155','#cbd5e1'), isLast?'end':'start');
    t.setAttribute('transform',`rotate(-45 ${tx} ${baseY})`);
    svgEl.appendChild(t);
  });

  // æŠ˜ã‚Œç·šãƒ‘ã‚¹
  const path=[]; 
  let xPrev=pad.l;
  for(let i=0;i<n;i++){
    const x = pad.l + i*sx;
    const yv = h-pad.b - (y[i]/maxV)*ch;
    path.push(i===0?`M${x} ${yv}`:`L${x} ${yv}`); 
    xPrev=x;
  }
  
  // å¡—ã‚Šã¤ã¶ã—ã‚¨ãƒªã‚¢
  const area = document.createElementNS('http://www.w3.org/2000/svg','path');
  area.setAttribute('d', path.join(' ') + `L ${xPrev} ${h-pad.b} L ${pad.l} ${h-pad.b} Z`);
  area.setAttribute('fill','rgba(59,130,246,.12)'); 
  svgEl.appendChild(area);
  
  // æŠ˜ã‚Œç·š
  const p = document.createElementNS('http://www.w3.org/2000/svg','path');
  p.setAttribute('d', path.join(' ')); 
  p.setAttribute('fill','none'); 
  p.setAttribute('stroke','#3b82f6'); 
  p.setAttribute('stroke-width','2');
  svgEl.appendChild(p);

  // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆï¼†å€¤ãƒ©ãƒ™ãƒ«
  if(opts.showValues){
    for(let i=0;i<n;i++){
      let x = pad.l + i*sx;
      const yy = h-pad.b - (y[i]/maxV)*ch;
      svgEl.appendChild(circle(x,yy,2.8,getThemeColor('#1f2937','#f1f5f9')));
      
      const isLast = (i===n-1);
      if(isLast) x -= 6;
      
      const t = text(x, yy - 6, String(y[i]), 10, getThemeColor('#0f172a','#f1f5f9'), isLast?'end':'middle');
      
      if(!opts.large && n>18 && i%2===1) t.textContent='';
      
      svgEl.appendChild(t);
    }
  }

  // è»¸ã‚¿ã‚¤ãƒˆãƒ«
  if(opts.xTitle){ 
    svgEl.appendChild(text(w/2, h-6, opts.xTitle, 11, getThemeColor('#475569','#94a3b8'), 'middle')); 
  }
  if(opts.yTitle){
    const yt=text(12, h/2, opts.yTitle, 11, getThemeColor('#475569','#94a3b8'), 'middle');
    yt.setAttribute('transform', `rotate(-90 12 ${h/2})`); 
    svgEl.appendChild(yt);
  }

  function line(x1,y1,x2,y2,stroke,w){ 
    const el=document.createElementNS('http://www.w3.org/2000/svg','line'); 
    el.setAttribute('x1',x1); el.setAttribute('y1',y1); 
    el.setAttribute('x2',x2); el.setAttribute('y2',y2); 
    el.setAttribute('stroke',stroke); el.setAttribute('stroke-width',w); 
    return el; 
  }
  function text(x,y,str,fs,fill,anchor='start'){ 
    const el=document.createElementNS('http://www.w3.org/2000/svg','text'); 
    el.setAttribute('x',x); el.setAttribute('y',y); 
    el.setAttribute('font-size',fs); 
    el.setAttribute('fill',fill); 
    el.setAttribute('text-anchor',anchor); 
    el.textContent=str; 
    return el; 
  }
  function circle(cx,cy,r,fill){ 
    const el=document.createElementNS('http://www.w3.org/2000/svg','circle'); 
    el.setAttribute('cx',cx); el.setAttribute('cy',cy); 
    el.setAttribute('r',r); el.setAttribute('fill',fill); 
    return el; 
  }
}

/* ====== å…¨ãƒ¬ãƒ³ãƒ€ãƒ¼/ã‚¤ãƒ™ãƒ³ãƒˆ ====== */
function renderAll(){ renderTopics(); render48h(); renderTrends(); renderMarked(); }
$('granularity').addEventListener('change', ()=> renderTrends());

/* åˆæœŸï¼ˆè¨­å®šUIã ã‘ç”¨æ„ï¼‰ */
renderChipSets(allMessages);

/* ====== ãƒ¢ãƒ¼ãƒ€ãƒ« ====== */
function line(){} // (ç©ºå®šç¾©ã®æ··å…¥é˜²æ­¢å¯¾ç­–ã§ã¯ãªãã€ä¸Šã®é–¢æ•°ã§å®šç¾©æ¸ˆãªã®ã§ä¸è¦ã§ã™)
</script>
</body>
</html>
