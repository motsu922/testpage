<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>QR照合（整理No→画像マスタ）</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="format-detection" content="telephone=no" />
<style>
  :root{
    --ok:#1a7f37; --ng:#d1242f; --fg:#222; --muted:#666;
    --border:#e5e7eb; --primary:#0b3b75; --bg:#f7f7f8;
    --card:#fff;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }

  /* ===== 全体背景：ステータス別（ほんのり） ===== */
  body{
    margin:0; color:var(--fg);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    -webkit-touch-callout:none; -webkit-user-select:none; user-select:none;
    transition: background-color .35s ease;
    background:var(--bg);
  }
  body.bg-NOT_STARTED{ background:#f7f7f8; }
  body.bg-RUNNING{ background:#f0fdf4; }          /* 薄い緑 */
  body.bg-TRY{ background:#eff6ff; }              /* 薄い青 */
  body.bg-ABNORMAL_STOP{ background:#fef2f2; }    /* 薄い赤 */
  body.bg-PLAN_STOP{ background:#fff7ed; }        /* 薄いオレンジ */
  body.bg-MATERIAL_CHANGE{ background:#faf5ff; }  /* 薄い紫 */
  body.bg-SETUP_CHANGE{ background:#fefce8; }     /* 薄い黄 */

  header{
    background:#fff; border-bottom:1px solid var(--border);
    padding:12px 16px; position:sticky; top:0; z-index:20;
    display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    -webkit-tap-highlight-color: transparent;
  }
  h1{ margin:0; font-size:18px; }
  .sub{ color:var(--muted); font-size:12px; }

  /* Tabs */
  .tabs{
    display:flex; gap:8px; align-items:center;
    padding:6px; border:1px solid var(--border); border-radius:12px; background:#fff;
  }
  .tab{
    border:1px solid var(--border); background:#fff; color:#111;
    border-radius:10px; padding:8px 12px; cursor:pointer; font-size:13px;
  }
  .tab.active{
    background:var(--primary); color:#fff; border-color:var(--primary);
    font-weight:700;
  }

  .rightTools{ margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .badge{ font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid #d1d5db; }
  .small{ font-size:12px; color:#6b7280; }

  .lineWrap,.bushoWrap{
    display:flex; gap:8px; align-items:center;
    border:1px solid var(--border); border-radius:10px; padding:6px 8px; background:#fff;
  }
  select{ border:none; outline:none; font-size:14px; background:#fff; }
  .pill{
    font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid #cbd5e1;
  }
  #lineBadge{ background:#eff6ff; color:#0b3b75; }
  #bushoBadge{ background:#fff7ed; color:#92400e; }

  main{ max-width:1100px; margin:16px auto; padding:0 16px 40px; }
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:14px;
    padding:16px; margin-bottom:16px;
  }
  .bigLabel{ font-size:18px; font-weight:800; margin-bottom:10px; }

  /* Views */
  .view{ display:none; }
  .view.active{ display:block; }

  /* ===== 目立つステータスバー ===== */
  .statusBar{
    display:flex; align-items:center; justify-content:center; gap:16px;
    padding:16px 14px;
    border-radius:18px;
    border:3px solid #e5e7eb;
    background:#fff;
    margin: 6px 0 14px;
    transition: background .35s ease, border-color .35s ease;
  }
  .statusBig{
    font-size:32px;
    font-weight:1000;
    letter-spacing:.08em;
    line-height:1.1;
  }
  .statusSub{
    font-size:13px;
    font-weight:800;
    padding:6px 12px;
    border-radius:999px;
    background:#fff;
    border:1px solid #d1d5db;
    color:#334155;
  }
  .status--RUNNING{ background:linear-gradient(90deg,#bbf7d0,#f0fdf4); border-color:#4ade80; }
  .status--TRY{ background:linear-gradient(90deg,#bfdbfe,#eff6ff); border-color:#60a5fa; }
  .status--ABNORMAL_STOP{ background:linear-gradient(90deg,#fecaca,#fef2f2); border-color:#f87171; }
  .status--PLAN_STOP{ background:linear-gradient(90deg,#fed7aa,#fff7ed); border-color:#fb923c; }
  .status--MATERIAL_CHANGE{ background:linear-gradient(90deg,#e9d5ff,#faf5ff); border-color:#c084fc; }
  .status--SETUP_CHANGE{ background:linear-gradient(90deg,#fde68a,#fefce8); border-color:#facc15; }
  .status--NOT_STARTED{ background:#f1f5f9; border-color:#cbd5e1; }

  /* Scan view layout */
  .baseWrap{ display:grid; grid-template-columns: 1.2fr .8fr; gap:16px; align-items:stretch; }
  @media (max-width:900px){ .baseWrap{ grid-template-columns:1fr; } }
  .baseBox{
    border:2px dashed #cbd5e1; border-radius:16px; background:#fbfdff;
    padding:16px; text-align:center; display:flex; flex-direction:column; justify-content:center;
  }
  .baseHeading{ display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap; }
  .statusChip{
    display:inline-block; padding:4px 10px; border-radius:999px; font-size:13px;
    border:1px solid #cbd5e1; background:#f1f5f9;
  }
  .baseValue{
    font-weight:900; font-size: clamp(70px, 10vw, 140px);
    color:var(--primary); word-break:break-all;
  }
  .placeholder{ color:#94a3b8; }

  .imgBox{
    border:2px dashed #e5e7eb; border-radius:16px; background:#fff;
    padding:10px; display:flex; align-items:center; justify-content:center; min-height:220px;
  }
  #productImage{ max-width:100%; max-height:320px; object-fit:contain; display:none; }
  .imgHint{ color:#9ca3af; font-size:13px; text-align:center; line-height:1.6; }

  .resultArea{ text-align:center; padding: 12px 10px 0; }
  .resultMark{ font-size:300px; line-height:1; display:none; }
  .ok{ color:var(--ok); } .ng{ color:var(--ng); }
  .lock{ display:none; margin-top:10px; color:var(--ng); font-weight:800; }
  .status{ font-size:15px; color:var(--muted); margin-top:12px; }

  .btn{
    padding:10px 14px; border-radius:12px; border:1px solid #d1d5db;
    background:#fff; cursor:pointer; font-size:14px;
    -webkit-tap-highlight-color: transparent;
  }
  .btn.warn{ background:#fef3f2; color:#b42318; border-color:#fecdcf; }
  .btn.big{ font-size:18px; padding:16px 22px; border-width:2px; }
  .btn.big.primary{ background:#0b3b75; color:#fff; border-color:#0b3b75; }
  .btn:disabled{ opacity:.5; cursor:not-allowed; }

  /* 状態切替ボタン */
  .stateBar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
  .stateBtn{
    padding:10px 12px; border-radius:12px; border:1px solid #d1d5db;
    background:#fff; cursor:pointer; font-size:14px;
  }
  .stateBtn.active{
    border-color:#0b3b75;
    box-shadow:0 0 0 3px rgba(11,59,117,.12);
    font-weight:900;
  }

  /* Timeline */
  .tlHead{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .tlHead .title{ font-size:16px; font-weight:900; }
  .tlHint{ color:#64748b; font-size:12px; }
  .tlTable{ width:100%; border-collapse:separate; border-spacing:0; margin-top:10px; }
  .tlTable th,.tlTable td{
    border-bottom:1px solid #e5e7eb;
    padding:8px 10px;
    font-size:13px;
    vertical-align:top;
  }
  .tlTable th{ text-align:left; color:#475569; font-weight:900; background:#f8fafc; position:sticky; top:0; }
  .tlWrap{ max-height:320px; overflow:auto; border:1px solid #e5e7eb; border-radius:12px; }
  .tlBadge{
    display:inline-block; padding:2px 8px; border-radius:999px;
    border:1px solid #d1d5db; font-size:12px; font-weight:800; background:#fff;
  }
  .tlDim{ color:#64748b; }

  /* Master view */
  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  @media (max-width:900px){ .grid2{ grid-template-columns:1fr; } }
  .field{ display:flex; flex-direction:column; gap:6px; }
  .field label{ font-size:12px; color:#475569; }
  .field input[type="text"]{
    padding:10px 12px; border-radius:10px; border:1px solid #d1d5db;
    font-size:16px; outline:none;
  }
  .field input[type="text"]:focus{
    border-color:#93c5fd; box-shadow:0 0 0 3px rgba(59,130,246,.15);
  }
  input[type="file"]{ display:none; }
  .toolBtn{
    padding:6px 10px; border-radius:10px; border:1px solid #d1d5db;
    background:#fff; cursor:pointer; font-size:13px; -webkit-tap-highlight-color: transparent;
  }
  .note{ font-size:12px; color:#6b7280; line-height:1.6; }
  .kpi{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .danger{ color:#b42318; font-weight:700; }

  footer{ text-align:center; color:#9ca3af; font-size:12px; padding:16px 0; }
</style>
</head>

<body class="bg-NOT_STARTED">
<header>
  <div>
    <h1>QR照合システム（整理No→画像マスタ）</h1>
    <div class="sub">基準QRの切り出し値＝整理No → Firestoreマスタ → Storage画像表示</div>
  </div>

  <div class="tabs" role="tablist" aria-label="mode tabs">
    <button id="tabScan" class="tab active" role="tab" aria-selected="true">照合モード</button>
    <button id="tabMaster" class="tab" role="tab" aria-selected="false">画像マスタ登録</button>
  </div>

  <div class="rightTools">
    <div class="bushoWrap">
      <span class="small">部署</span>
      <select id="bushoSelect">
        <option value="">未設定</option>
        <option>1G</option><option>3G</option><option>4G</option><option>5G</option><option>6G</option><option>品質</option>
      </select>
      <span id="bushoBadge" class="pill" title="現在の部署">未設定</span>
    </div>

    <div class="lineWrap">
      <span class="small">ライン</span>
      <select id="lineSelect">
        <option value="">未設定</option>
        <option>53-300</option><option>57-200</option><option>65-300</option><option>71-300</option><option>72-160</option>
        <option>83-500</option><option>89-400</option><option>90-600</option><option>94-300</option><option>RL5</option>
        <option>TPS03-3.5</option><option>あきひと</option><option>キャップ６号機</option><option>キャップ７号機</option>
        <option>30-060</option><option>41-200</option><option>42-250</option><option>49-060</option><option>51-110</option>
        <option>54-160</option><option>70-080</option><option>76-060</option><option>78-060</option><option>82-045</option>
        <option>87-400</option><option>88-400</option><option>91-200</option><option>RL1</option><option>RL3</option><option>RL4</option>
        <option>RMI-1(インサート成型機）</option><option>TPS01-2.7</option><option>TPS02-0.75</option>
        <option>キャップ10号機</option><option>キャップ８号機</option><option>キャップ9号機</option>
      </select>
      <span id="lineBadge" class="pill" title="現在のライン">未設定</span>
    </div>

    <span id="firebaseStatus" class="badge" style="color:#9ca3af;">Firebase: 未接続</span>
    <span id="storageStatus" class="badge" style="color:#9ca3af;">Storage: 未準備</span>
  </div>
</header>

<input id="scanInput" type="text" readonly inputmode="none"
  autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" aria-hidden="true"
  style="position:absolute; left:-9999px; top:-9999px; width:1px; height:1px; opacity:0; pointer-events:none;" />

<main>
  <!-- ===================== 照合モード ===================== -->
  <section id="viewScan" class="view active">
    <div class="card">
      <div class="bigLabel">生産（基準＝整理No）</div>

      <!-- ★ 目立つステータスバー -->
      <div id="statusBar" class="statusBar status--NOT_STARTED">
        <div id="prodStateBig" class="statusBig">未開始</div>
        <div id="statusHint" class="statusSub">基準未設定</div>
      </div>

      <div class="baseWrap">
        <div class="baseBox">
          <div class="baseHeading">
            <span id="masterHit" class="statusChip" style="display:none;">画像マスタ：ヒット</span>
            <span id="masterMiss" class="statusChip" style="display:none;">画像マスタ：未登録</span>
          </div>
          <div id="baseDisplay" class="baseValue placeholder">未設定</div>
        </div>

        <div class="imgBox">
          <img id="productImage" alt="基準(整理No)の画像" />
          <div id="imgHint" class="imgHint">
            基準QRを読み込むと、切り出し値（整理No）で画像マスタを検索して表示します。<br>
            画像が出ない場合は「画像マスタ登録」タブで登録してください。
          </div>
        </div>
      </div>

      <!-- 状態切替 -->
      <div class="stateBar">
        <button id="btnBackRunning" class="stateBtn" type="button">生産中に戻す</button>
        <button id="btnTry" class="stateBtn" type="button">トライ中</button>
        <button id="btnAbnormalStop" class="stateBtn" type="button">異常停止中</button>
        <button id="btnPlanStop" class="stateBtn" type="button">計画停止中</button>
        <button id="btnMaterialChange" class="stateBtn" type="button">材料替え中</button>
      </div>

      <div class="resultArea">
        <div id="ok" class="resultMark ok">○</div>
        <div id="ng" class="resultMark ng">×</div>
        <div id="lockMsg" class="lock">NG！ 管理者QRを読み込むまでロック中</div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="resetBtn" class="btn big primary" tabindex="-1">製品切替え</button>
        <button id="saveBtn" class="btn" tabindex="-1">ログ保存（CSV）</button>
        <button id="exitBtn" class="btn warn" tabindex="-1">システム終了（自動保存）</button>
      </div>

      <div id="mode" class="status">基準QRを読み込んでください</div>
      <div class="small">切り出し固定：開始=3、長さ=5（空白除去）</div>
    </div>

    <!-- ★ ④ 今日のステータス遷移タイムライン -->
    <div class="card">
      <div class="tlHead">
        <div class="title">今日のステータス遷移</div>
        <span class="tlHint">最新50件（本日0:00〜）</span>
        <span id="tlCount" class="badge" style="margin-left:auto; color:#64748b;">0件</span>
      </div>
      <div class="tlWrap">
        <table class="tlTable">
          <thead>
            <tr>
              <th style="width:120px;">時刻</th>
              <th>遷移</th>
              <th style="width:160px;">理由</th>
              <th style="width:120px;">基準</th>
              <th style="width:140px;">ライン/部署</th>
            </tr>
          </thead>
          <tbody id="timelineBody">
            <tr><td colspan="5" class="tlDim" style="padding:14px;">Firestore接続後に表示します。</td></tr>
          </tbody>
        </table>
      </div>
      <div class="tlHint" style="margin-top:10px;">
        ※集計用に <span class="tlBadge">tsMs</span>（端末時刻）で当日範囲検索しています。端末時刻がズレていると範囲外になります。
      </div>
    </div>
  </section>

  <!-- ===================== 画像マスタ登録 ===================== -->
  <section id="viewMaster" class="view">
    <div class="card">
      <div class="bigLabel">画像マスタ登録（整理No → 画像）</div>

      <div class="grid2">
        <div class="field">
          <label>整理No（切り出し値）</label>
          <input id="masterSeiriNo" type="text" placeholder="例：ABCDE" inputmode="latin" autocomplete="off" />
          <div class="note">※この整理Noで <b>imageMasters/{整理No}</b> に保存します。</div>
        </div>

        <div class="field">
          <label>画像ファイル</label>
          <div class="kpi">
            <label class="toolBtn" for="masterImageFile">画像を選択</label>
            <input id="masterImageFile" type="file" accept="image/*" />
            <span id="masterFileName" class="pill">未選択</span>
            <span id="masterUploadState" class="pill">未登録</span>
          </div>
          <div class="note">※Storage は <b>productImages/{整理No}.{拡張子}</b> に保存（同じ整理Noは上書き更新）。</div>
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button id="masterUploadBtn" class="btn">登録（アップロード）</button>
        <button id="masterFetchBtn" class="btn">この整理Noを検索（プレビュー）</button>
        <button id="masterClearBtn" class="btn warn">入力クリア</button>
      </div>

      <div class="note" style="margin-top:10px;">
        <span class="danger">運用注意：</span>
        同じ整理Noで拡張子が変わると Storage に古い拡張子の画像が残る場合があります（必要なら削除ロジック追加できます）。
      </div>

      <div class="card" style="margin-top:14px;">
        <div class="bigLabel" style="font-size:16px;">プレビュー</div>
        <div class="imgBox">
          <img id="masterPreviewImage" alt="マスタ画像プレビュー" style="max-width:100%; max-height:320px; object-fit:contain; display:none;" />
          <div id="masterPreviewHint" class="imgHint">ここに検索結果（画像）が表示されます。</div>
        </div>
      </div>
    </div>
  </section>
</main>

<footer>© QR Verify</footer>

<script>
/* ================== 設定 ================== */
const CUT_START = 3;
const CUT_LENGTH = 5;
const ADMIN_QR = "ADMIN123";
const LINE_KEY = "qr_line_name";
const BUSHO_KEY = "qr_busho_name";

const STORAGE_DIR = "productImages";       // Storage: productImages/...
const MASTER_COLLECTION = "imageMasters";  // Firestore: imageMasters/{seiriNo}

/* ★ Firestore: 生産ステータス遷移ログ */
const STATUS_LOG_COLLECTION = "prodStatusLogs";

/* ================== 状態 ================== */
let baseQR = null; // 基準（整理No）
let isLocked = false;
let logData = [["時刻","読み込んだQR","切り出し後値","判定","ロック状態","画像情報","ライン","部署","生産ステータス"]];

let lineName = localStorage.getItem(LINE_KEY) || "";
let bushoName = localStorage.getItem(BUSHO_KEY) || "";

/* 生産ステータス */
const PROD_STATUS = {
  NOT_STARTED: "未開始",
  RUNNING: "生産中",
  TRY: "トライ中",
  ABNORMAL_STOP: "異常停止中",
  PLAN_STOP: "計画停止中",
  MATERIAL_CHANGE: "材料替え中",
  SETUP_CHANGE: "段替え中"
};
let prodStatus = PROD_STATUS.NOT_STARTED;

/* module側から注入される関数 */
let __getMasterBySeiriNo = null; // async(seiriNo)=>{imagePath,downloadUrl,...}|null
let __saveMaster = null;         // async(seiriNo,file)=>{imagePath,downloadUrl}

/* Firestore書込み（module側が準備できたら注入） */
let __firestoreLogRow = null;    // qrLogs
let __firestoreStatusLog = null; // prodStatusLogs

/* ================== DOM ================== */
const $tabScan = document.getElementById("tabScan");
const $tabMaster = document.getElementById("tabMaster");
const $viewScan = document.getElementById("viewScan");
const $viewMaster = document.getElementById("viewMaster");

const $mode = document.getElementById("mode");
const $ok = document.getElementById("ok");
const $ng = document.getElementById("ng");
const $lockMsg = document.getElementById("lockMsg");
const $baseDisplay = document.getElementById("baseDisplay");
const $productImage = document.getElementById("productImage");
const $imgHint = document.getElementById("imgHint");
const $resetBtn = document.getElementById("resetBtn");
const $masterHit = document.getElementById("masterHit");
const $masterMiss = document.getElementById("masterMiss");

const $lineSelect = document.getElementById("lineSelect");
const $lineBadge = document.getElementById("lineBadge");
const $bushoSelect = document.getElementById("bushoSelect");
const $bushoBadge = document.getElementById("bushoBadge");

/* ステータスバー */
const $statusBar = document.getElementById("statusBar");
const $prodStateBig = document.getElementById("prodStateBig");
const $statusHint = document.getElementById("statusHint");

/* 状態ボタン */
const $btnBackRunning = document.getElementById("btnBackRunning");
const $btnTry = document.getElementById("btnTry");
const $btnAbnormalStop = document.getElementById("btnAbnormalStop");
const $btnPlanStop = document.getElementById("btnPlanStop");
const $btnMaterialChange = document.getElementById("btnMaterialChange");

/* Timeline */
const $timelineBody = document.getElementById("timelineBody");
const $tlCount = document.getElementById("tlCount");

/* Master UI */
const $masterSeiriNo = document.getElementById("masterSeiriNo");
const $masterImageFile = document.getElementById("masterImageFile");
const $masterFileName = document.getElementById("masterFileName");
const $masterUploadState = document.getElementById("masterUploadState");
const $masterUploadBtn = document.getElementById("masterUploadBtn");
const $masterFetchBtn = document.getElementById("masterFetchBtn");
const $masterClearBtn = document.getElementById("masterClearBtn");
const $masterPreviewImage = document.getElementById("masterPreviewImage");
const $masterPreviewHint = document.getElementById("masterPreviewHint");

/* ================== タブ切替 ================== */
function setActiveTab(mode){
  const isScan = (mode === "scan");
  $tabScan.classList.toggle("active", isScan);
  $tabMaster.classList.toggle("active", !isScan);
  $tabScan.setAttribute("aria-selected", isScan ? "true" : "false");
  $tabMaster.setAttribute("aria-selected", !isScan ? "true" : "false");
  $viewScan.classList.toggle("active", isScan);
  $viewMaster.classList.toggle("active", !isScan);
}
$tabScan.addEventListener("click", ()=>setActiveTab("scan"));
$tabMaster.addEventListener("click", ()=>setActiveTab("master"));

/* ================== 初期：ライン/部署 ================== */
window.addEventListener("load", ()=>{
  if (lineName) Array.from($lineSelect.options).forEach(o=>{ if(o.value===lineName) o.selected=true; });
  if (bushoName) Array.from($bushoSelect.options).forEach(o=>{ if(o.value===bushoName) o.selected=true; });
  $lineBadge.textContent = lineName || "未設定";
  $bushoBadge.textContent = bushoName || "未設定";
  renderProdStatus();
});
$lineSelect.addEventListener("change", ()=>{
  lineName = $lineSelect.value;
  localStorage.setItem(LINE_KEY, lineName);
  $lineBadge.textContent = lineName || "未設定";
});
$bushoSelect.addEventListener("change", ()=>{
  bushoName = $bushoSelect.value;
  localStorage.setItem(BUSHO_KEY, bushoName);
  $bushoBadge.textContent = bushoName || "未設定";
});

/* ================== Utils ================== */
function nowString(){
  const d=new Date(); const pad=n=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function normalizeSeiriNo(s){ return String(s||"").trim().replace(/\s+/g,""); }
function cutQR(qr){ return normalizeSeiriNo(String(qr||"").substr(CUT_START, CUT_LENGTH)); }

function showOK(){ $ok.style.display="block"; $ng.style.display="none"; setTimeout(()=>{$ok.style.display="none";},1500); }
function showNGPersistent(){ $ok.style.display="none"; $ng.style.display="block"; }
function clearMarks(){ $ok.style.display="none"; $ng.style.display="none"; }

function setLock(state){
  isLocked = state;
  $lockMsg.style.display = state ? "block" : "none";
  $resetBtn.disabled = state;
  if(!state) clearMarks();
}
function updateBaseDisplay(val){
  if(val){ $baseDisplay.classList.remove("placeholder"); $baseDisplay.textContent=val; }
  else { $baseDisplay.classList.add("placeholder"); $baseDisplay.textContent="未設定"; }
}
function setMasterBadge(hit){
  $masterHit.style.display = hit ? "inline-block" : "none";
  $masterMiss.style.display = hit ? "none" : "inline-block";
}
function showImage(url){
  if(url){
    $productImage.src=url; $productImage.style.display="block"; $imgHint.style.display="none";
  }
}
function showNoImage(html){
  $productImage.style.display="none"; $imgHint.style.display="block"; $imgHint.innerHTML = html || "";
}

/* CSV */
function csvEscape(field){ const s=String(field??""); return /[\",\n]/.test(s)?`"${s.replace(/\"/g,'\"\"')}"`:s; }
function buildCSV(rows){ return rows.map(r=>r.map(csvEscape).join(",")).join("\n"); }
function downloadCSV(rows, baseName="qr_log"){
  const ts=new Date(); const pad=n=>String(n).padStart(2,"0");
  const name=`${baseName}_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}${pad(ts.getSeconds())}.csv`;
  const blob=new Blob([buildCSV(rows)],{type:"text/csv"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=name; a.click();
}

/* Firestoreログ保存（CSV + Firestore(qrLogs)） */
function logRow(row){
  logData.push(row);
  if(typeof __firestoreLogRow === "function"){
    __firestoreLogRow(row).catch(()=>{});
  }
}

/* ================== 生産ステータス：キー化 ================== */
function statusKeyFromText(text){
  if(text === PROD_STATUS.RUNNING) return "RUNNING";
  if(text === PROD_STATUS.TRY) return "TRY";
  if(text === PROD_STATUS.ABNORMAL_STOP) return "ABNORMAL_STOP";
  if(text === PROD_STATUS.PLAN_STOP) return "PLAN_STOP";
  if(text === PROD_STATUS.MATERIAL_CHANGE) return "MATERIAL_CHANGE";
  if(text === PROD_STATUS.SETUP_CHANGE) return "SETUP_CHANGE";
  return "NOT_STARTED";
}

/* ================== 生産ステータス：表示（バー＋背景＋ボタン） ================== */
function renderProdStatus(){
  const key = statusKeyFromText(prodStatus);

  // 文字
  $prodStateBig.textContent = prodStatus;
  $statusHint.textContent = baseQR ? `基準：${baseQR}` : "基準未設定";

  // ステータスバー色
  $statusBar.className = `statusBar status--${key}`;

  // 画面全体背景
  document.body.classList.remove(
    "bg-NOT_STARTED","bg-RUNNING","bg-TRY","bg-ABNORMAL_STOP","bg-PLAN_STOP","bg-MATERIAL_CHANGE","bg-SETUP_CHANGE"
  );
  document.body.classList.add(`bg-${key}`);

  // ボタンactive
  const setActive = (btn, on)=>btn.classList.toggle("active", !!on);
  setActive($btnBackRunning, prodStatus === PROD_STATUS.RUNNING);
  setActive($btnTry, prodStatus === PROD_STATUS.TRY);
  setActive($btnAbnormalStop, prodStatus === PROD_STATUS.ABNORMAL_STOP);
  setActive($btnPlanStop, prodStatus === PROD_STATUS.PLAN_STOP);
  setActive($btnMaterialChange, prodStatus === PROD_STATUS.MATERIAL_CHANGE);
}

/**
 * ★ステータス変更（ここで “時系列ログ” をFirestoreへ保存）
 * reason: どの操作で変えたか（ボタン/基準QRセット等）
 */
function setProdStatus(next, reason="MANUAL"){
  if(!next || next === prodStatus) return;

  const prev = prodStatus;
  prodStatus = next;
  renderProdStatus();

  // CSV/qrLogs にも残す（あなたの運用で追えるように）
  logRow([nowString(), "-", "-", `STATUS:${reason}`, isLocked?"LOCKED":"UNLOCK", `${prev}→${next}`, lineName, bushoName, prodStatus]);

  // ★ Firestore 時系列保存（prodStatusLogs）
  if(typeof __firestoreStatusLog === "function"){
    const tsMs = Date.now(); // ← タイムライン表示の当日範囲検索に使う
    __firestoreStatusLog({
      tsText: nowString(),
      tsMs,
      prevStatus: prev,
      nextStatus: next,
      reason,
      line: lineName || null,
      busho: bushoName || null,
      baseQR: baseQR || null,
      lockState: isLocked ? "LOCKED" : "UNLOCK",
      pageUrl: location.href,
      userAgent: navigator.userAgent
    }).catch(()=>{});
  }
}

/* ================== 状態ボタンイベント ================== */
$btnBackRunning.addEventListener("click", ()=>{
  setProdStatus(PROD_STATUS.RUNNING, "BACK_TO_RUNNING_BTN");
  clearMarks(); // ★ ×表示（＋○）を消す
});
$btnTry.addEventListener("click", ()=>setProdStatus(PROD_STATUS.TRY, "TRY_BTN"));
$btnAbnormalStop.addEventListener("click", ()=>setProdStatus(PROD_STATUS.ABNORMAL_STOP, "ABNORMAL_STOP_BTN"));
$btnPlanStop.addEventListener("click", ()=>setProdStatus(PROD_STATUS.PLAN_STOP, "PLAN_STOP_BTN"));
$btnMaterialChange.addEventListener("click", ()=>setProdStatus(PROD_STATUS.MATERIAL_CHANGE, "MATERIAL_CHANGE_BTN"));

/* ================== Timeline描画（moduleから呼ばれる） ================== */
function esc(s){ return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function fmtTimeFromMs(ms){
  try{
    const d=new Date(ms);
    const pad=n=>String(n).padStart(2,"0");
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }catch(e){ return "-"; }
}
window.__updateStatusTimeline = function(list){
  const rows = Array.isArray(list) ? list : [];
  $tlCount.textContent = `${rows.length}件`;

  if(rows.length===0){
    $timelineBody.innerHTML = `<tr><td colspan="5" class="tlDim" style="padding:14px;">本日の遷移ログはまだありません。</td></tr>`;
    return;
  }

  $timelineBody.innerHTML = rows.map(r=>{
    const time = r.tsMs ? fmtTimeFromMs(r.tsMs) : (r.tsText ? esc(r.tsText.split(" ")[1]||"-") : "-");
    const trans = `${esc(r.prevStatus||"-")} → ${esc(r.nextStatus||"-")}`;
    const reason = esc(r.reason||"-");
    const base = esc(r.baseQR||"-");
    const lb = `${esc(r.line||"-")} / ${esc(r.busho||"-")}`;
    return `
      <tr>
        <td><span class="tlBadge">${time}</span></td>
        <td><b>${trans}</b></td>
        <td>${reason}</td>
        <td>${base}</td>
        <td>${lb}</td>
      </tr>`;
  }).join("");
};

/* ================== マスタ登録イベント ================== */
function showMasterPreview(url){
  if(url){
    $masterPreviewImage.src=url;
    $masterPreviewImage.style.display="block";
    $masterPreviewHint.style.display="none";
  }
}
function showMasterPreviewHint(text){
  $masterPreviewImage.style.display="none";
  $masterPreviewHint.style.display="block";
  $masterPreviewHint.innerHTML = text || "";
}
function setMasterUIBusy(busy){
  $masterUploadBtn.disabled = busy;
  $masterFetchBtn.disabled = busy;
  $masterClearBtn.disabled = busy;
}
$masterImageFile.addEventListener("change", ()=>{
  const f = $masterImageFile.files && $masterImageFile.files[0];
  $masterFileName.textContent = f ? f.name : "未選択";
  $masterUploadState.textContent = "未登録";
});
$masterClearBtn.addEventListener("click", ()=>{
  $masterSeiriNo.value="";
  $masterImageFile.value="";
  $masterFileName.textContent="未選択";
  $masterUploadState.textContent="未登録";
  showMasterPreviewHint("ここに検索結果（画像）が表示されます。");
});
$masterUploadBtn.addEventListener("click", async ()=>{
  const seiriNo = normalizeSeiriNo($masterSeiriNo.value);
  const file = $masterImageFile.files && $masterImageFile.files[0];
  if(!seiriNo){ alert("整理Noを入力してください。"); return; }
  if(!file){ alert("画像を選択してください。"); return; }
  if(!__saveMaster){ alert("Firebase未接続の可能性があります。"); return; }

  setMasterUIBusy(true);
  $masterUploadState.textContent="登録中...";
  try{
    const res = await __saveMaster(seiriNo, file);
    $masterUploadState.textContent="登録完了";
    showMasterPreview(res.downloadUrl);
  }catch(e){
    console.warn(e);
    $masterUploadState.textContent="登録失敗";
    alert("登録に失敗しました（コンソール確認）");
  }finally{
    setMasterUIBusy(false);
  }
});
$masterFetchBtn.addEventListener("click", async ()=>{
  const seiriNo = normalizeSeiriNo($masterSeiriNo.value);
  if(!seiriNo){ alert("整理Noを入力してください。"); return; }
  if(!__getMasterBySeiriNo){ alert("Firebase未接続の可能性があります。"); return; }

  setMasterUIBusy(true);
  $masterUploadState.textContent="検索中...";
  try{
    const master = await __getMasterBySeiriNo(seiriNo);
    if(master && master.downloadUrl){
      $masterUploadState.textContent="ヒット";
      showMasterPreview(master.downloadUrl);
    }else{
      $masterUploadState.textContent="未登録";
      showMasterPreviewHint(`画像マスタ未登録：<b>${esc(seiriNo)}</b><br>「登録（アップロード）」で登録してください。`);
    }
  }finally{
    setMasterUIBusy(false);
  }
});

/* ================== スキャナ入力（documentで受ける） ================== */
let buffer = "";
let idleTimer = null;
const IDLE_MS = 120;

function flushBuffer(){
  if(!buffer) return;
  const qr = buffer.replace(/\r/g,"").split("\n").map(s=>s.trim()).filter(Boolean).slice(-1)[0] || "";
  buffer = "";
  if(qr) processQR(qr);
}
document.addEventListener("keydown", (e)=>{
  e.preventDefault();
  const k = e.key;
  if(k==="Enter" || k==="Tab"){ flushBuffer(); return; }
  if(k.length===1){
    buffer += k;
    if(idleTimer) clearTimeout(idleTimer);
    idleTimer = setTimeout(()=>flushBuffer(), IDLE_MS);
  }else if(k==="Backspace"){
    buffer = buffer.slice(0,-1);
  }
},{ passive:false });

/* ================== 照合フロー ================== */
async function processQR(qrRaw){
  const now = nowString();
  const sliced = cutQR(qrRaw);

  // 1) 基準セット（切り出し値＝整理No）
  if(!baseQR){
    baseQR = sliced;
    updateBaseDisplay(baseQR);

    // ★ 基準QR読込後 → 生産中
    setProdStatus(PROD_STATUS.RUNNING, "BASE_QR_SET");

    $mode.textContent = `照合モード（基準/整理No: ${baseQR}）`;

    // 整理No→マスタ検索→Storage画像表示
    let imageInfo = "";
    try{
      if(__getMasterBySeiriNo){
        const master = await __getMasterBySeiriNo(baseQR);
        if(master && master.downloadUrl){
          showImage(master.downloadUrl);
          setMasterBadge(true);
          imageInfo = `storage:${master.imagePath}`;
        }else{
          setMasterBadge(false);
          showNoImage(`画像マスタ未登録：<b>${esc(baseQR)}</b><br>「画像マスタ登録」タブで登録してください。`);
        }
      }else{
        setMasterBadge(false);
        showNoImage("Firebase未接続のため画像マスタ検索ができません。");
      }
    }catch(e){
      console.warn(e);
      setMasterBadge(false);
      showNoImage("画像マスタ検索エラー（コンソール確認）");
    }

    logRow([now, qrRaw, sliced, "SET_BASE", isLocked?"LOCKED":"UNLOCK", imageInfo, lineName, bushoName, prodStatus]);
    return;
  }

  // 2) ロック中
  if(isLocked){
    if(qrRaw===ADMIN_QR){
      setLock(false); showOK();
      $mode.textContent="解除されました。照合を再開します。";
      logRow([now, qrRaw, sliced, "UNLOCK_BY_ADMIN", "UNLOCK", "", lineName, bushoName, prodStatus]);
    }else{
      showNGPersistent();
      logRow([now, qrRaw, sliced, "LOCK_REJECT", "LOCKED", "", lineName, bushoName, prodStatus]);
    }
    return;
  }

  // 3) 判定
  const judgedOK = (sliced===baseQR);
  if(judgedOK){
    showOK();
    logRow([now, qrRaw, sliced, "OK", "UNLOCK", "", lineName, bushoName, prodStatus]);
  }else{
    showNGPersistent();
    setLock(true);
    $mode.textContent="NG！管理者QRを読み込んでください";
    logRow([now, qrRaw, sliced, "NG", "LOCKED", "", lineName, bushoName, prodStatus]);
  }
}

/* ================== ボタン ================== */
document.getElementById("resetBtn").addEventListener("click", ()=>{
  if(isLocked){
    $mode.textContent="NGロック中は切替できません。管理者QRで解除してください。";
    logRow([nowString(), "-", "-", "RESET_DENIED_WHEN_LOCKED", "LOCKED", "", lineName, bushoName, prodStatus]);
    return;
  }

  // ★ 製品切り替え → 段替え中
  setProdStatus(PROD_STATUS.SETUP_CHANGE, "RESET_BTN");

  baseQR=null;
  setLock(false);
  clearMarks();
  updateBaseDisplay(null);
  setMasterBadge(false);
  $productImage.style.display="none";
  $imgHint.style.display="block";
  $imgHint.textContent="基準QRを読み込むと、整理Noで画像マスタを検索して表示します。";
  $mode.textContent="基準QRを読み込んでください";
  logRow([nowString(), "-", "-", "RESET", "UNLOCK", "", lineName, bushoName, prodStatus]);
});
document.getElementById("saveBtn").addEventListener("click", ()=>downloadCSV(logData));
document.getElementById("exitBtn").addEventListener("click", ()=>{ downloadCSV(logData,"qr_log"); window.close(); });
</script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, collection, addDoc, serverTimestamp,
    query, where, orderBy, limit, onSnapshot
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAOMRoojKv9Hnh3OjVGwYV_k1LBTGOKepY",
    authDomain: "miyamaunitec-fb87a.firebaseapp.com",
    databaseURL: "https://miyamaunitec-fb87a-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "miyamaunitec-fb87a",
    storageBucket: "miyamaunitec-fb87a.firebasestorage.app",
    messagingSenderId: "495316649507",
    appId: "1:495316649507:web:1f98ee3dd851474fa39396",
    measurementId: "G-1NXD8ZPGNR"
  };

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch(e){}

  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const statusEl = document.getElementById("firebaseStatus");
  const storageEl = document.getElementById("storageStatus");
  const setStatus = (t,c)=>{ statusEl.textContent=`Firebase: ${t}`; statusEl.style.color=c; };
  const setStorage = (t,c)=>{ storageEl.textContent=`Storage: ${t}`; storageEl.style.color=c; };

  try{
    await signInAnonymously(auth);
    setStatus("接続済み","#16a34a");
    setStorage("準備OK","#16a34a");
  }catch(e){
    console.warn("匿名認証失敗:", e);
    setStatus("未接続（認証エラー）","#dc2626");
    setStorage("未準備（認証エラー）","#dc2626");
  }

  // 画像マスタ取得：imageMasters/{seiriNo}
  window.__getMasterBySeiriNo = async (seiriNo) => {
    const key = String(seiriNo||"").trim();
    if(!key) return null;

    const snap = await getDoc(doc(db, MASTER_COLLECTION, key));
    if(!snap.exists()) return null;

    const data = snap.data() || {};
    if(!data.imagePath) return null;

    try{
      const downloadUrl = await getDownloadURL(ref(storage, data.imagePath));
      return { ...data, downloadUrl };
    }catch(e){
      console.warn("getDownloadURL failed:", e);
      return { ...data, downloadUrl: null };
    }
  };

  // 画像マスタ保存：Storageへアップロード→imageMasters/{seiriNo} 上書き
  window.__saveMaster = async (seiriNo, file) => {
    const key = String(seiriNo||"").trim();
    if(!key) throw new Error("seiriNo required");
    if(!file) throw new Error("file required");

    const origName = String(file.name || "image");
    const extMatch = origName.toLowerCase().match(/\.([a-z0-9]+)$/);
    const ext = extMatch ? extMatch[1] : "jpg";

    const imagePath = `${STORAGE_DIR}/${key}.${ext}`;
    const storageRef = ref(storage, imagePath);

    await uploadBytes(storageRef, file, { contentType: file.type || "application/octet-stream" });
    const downloadUrl = await getDownloadURL(storageRef);

    const payload = {
      seiriNo: key,
      imagePath,
      originalFileName: origName,
      contentType: file.type || null,
      updatedAt: serverTimestamp(),
      updatedByUid: (auth.currentUser && auth.currentUser.uid) || null
    };
    await setDoc(doc(db, MASTER_COLLECTION, key), payload, { merge:true });

    return { imagePath, downloadUrl };
  };

  // 非module側へ反映
  // eslint-disable-next-line no-undef
  __getMasterBySeiriNo = window.__getMasterBySeiriNo;
  // eslint-disable-next-line no-undef
  __saveMaster = window.__saveMaster;

  // qrLogs 保存
  // eslint-disable-next-line no-undef
  __firestoreLogRow = async function(row){
    try{
      const [ts, raw, sliced, judge, lockState, imageInfo, line, busho, prodStatus] = row;

      await addDoc(collection(db, "qrLogs"), {
        ts, raw, sliced, judge, lockState,
        imageInfo: imageInfo || null,
        line, busho,
        prodStatus: prodStatus || null,
        readAt: serverTimestamp(),
        uid: (auth.currentUser && auth.currentUser.uid) || null,
        pageUrl: location.href,
        userAgent: navigator.userAgent,
        // 互換
        qrData: raw,
        readAtText: ts,
        result: judge
      });
    }catch(e){
      console.warn("Firestore write fail(qrLogs):", e);
      setStatus("エラー（保存失敗）","#dc2626");
    }
  };

  // ★ prodStatusLogs（時系列）
  // eslint-disable-next-line no-undef
  __firestoreStatusLog = async function(payload){
    try{
      await addDoc(collection(db, STATUS_LOG_COLLECTION), {
        ...payload,
        createdAt: serverTimestamp(),
        uid: (auth.currentUser && auth.currentUser.uid) || null
      });
    }catch(e){
      console.warn("Firestore write fail(prodStatusLogs):", e);
      setStatus("エラー（ステータス履歴保存失敗）","#dc2626");
    }
  };

  // ★ ④ 今日のステータス遷移：リアルタイム表示（最新50件）
  function startTodayTimeline(){
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0);
    const end = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 0,0,0,0);

    const q = query(
      collection(db, STATUS_LOG_COLLECTION),
      where("tsMs", ">=", start.getTime()),
      where("tsMs", "<", end.getTime()),
      orderBy("tsMs", "desc"),
      limit(50)
    );

    return onSnapshot(q, (snap)=>{
      const list = [];
      snap.forEach(d=>{
        const data = d.data() || {};
        list.push(data);
      });
      // eslint-disable-next-line no-undef
      if(typeof window.__updateStatusTimeline === "function"){
        window.__updateStatusTimeline(list);
      }
    }, (err)=>{
      console.warn("timeline snapshot error:", err);
      setStatus("エラー（タイムライン）","#dc2626");
    });
  }

  try{
    window.__timelineUnsub && window.__timelineUnsub();
    window.__timelineUnsub = startTodayTimeline();
  }catch(e){
    console.warn(e);
  }
</script>
</body>
</html>
