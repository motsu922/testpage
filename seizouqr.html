<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>QRç…§åˆï¼ˆæ•´ç†Noâ†’ç”»åƒãƒã‚¹ã‚¿ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="format-detection" content="telephone=no" />
<style>
  :root{
    --ok:#1a7f37; --ng:#d1242f; --fg:#222; --muted:#666;
    --border:#e5e7eb; --primary:#0b3b75; --bg:#f7f7f8;
    --card:#fff;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }

  body{
    margin:0; color:var(--fg);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    -webkit-touch-callout:none; -webkit-user-select:none; user-select:none;
    transition: background-color .35s ease;
    background:var(--bg);
  }

  header{
    background:#fff; border-bottom:1px solid var(--border);
    padding:12px 16px; position:sticky; top:0; z-index:20;
    display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    -webkit-tap-highlight-color: transparent;
  }
  h1{ margin:0; font-size:18px; }
  .sub{ color:var(--muted); font-size:12px; }

  /* Tabs */
  .tabs{
    display:flex; gap:8px; align-items:center;
    padding:6px; border:1px solid var(--border); border-radius:12px; background:#fff;
  }
  .tab{
    border:1px solid var(--border); background:#fff; color:#111;
    border-radius:10px; padding:8px 12px; cursor:pointer; font-size:13px;
  }
  .tab.active{
    background:var(--primary); color:#fff; border-color:var(--primary);
    font-weight:700;
  }

  .rightTools{ margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .badge{ font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid #d1d5db; }
  .small{ font-size:12px; color:#6b7280; }

  .lineWrap,.bushoWrap{
    display:flex; gap:8px; align-items:center;
    border:1px solid var(--border); border-radius:10px; padding:6px 8px; background:#fff;
  }
  select{ border:none; outline:none; font-size:14px; background:#fff; }
  .pill{
    font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid #cbd5e1;
  }
  #lineBadge{ background:#eff6ff; color:#0b3b75; }
  #bushoBadge{ background:#fff7ed; color:#92400e; }

  main{ max-width:1100px; margin:16px auto; padding:0 16px 40px; }
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:14px;
    padding:16px; margin-bottom:16px;
  }
  .bigLabel{ font-size:18px; font-weight:800; margin-bottom:10px; }

  /* Views */
  .view{ display:none; }
  .view.active{ display:block; }

  /* ===== ç›®ç«‹ã¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ ===== */
  .statusBar{
    display:flex; align-items:center; justify-content:space-between; gap:14px;
    padding:16px 14px;
    border-radius:18px;
    border:3px solid #e5e7eb;
    background:#fff;
    margin: 6px 0 14px;
    transition: background .35s ease, border-color .35s ease;
  }
  .statusBig{
    font-size:32px;
    font-weight:1000;
    letter-spacing:.08em;
    line-height:1.1;
  }
  .statusSub{
    font-size:13px;
    font-weight:800;
    padding:6px 12px;
    border-radius:999px;
    background:#fff;
    border:1px solid #d1d5db;
    color:#334155;
  }

  .statusLeft{
    display:flex; align-items:baseline; gap:14px; flex-wrap:wrap;
  }
  .statusRight{
    margin-left:auto;
    display:flex; align-items:baseline; gap:10px;
    padding:8px 12px;
    border-radius:14px;
    background:rgba(255,255,255,.72);
    border:1px solid rgba(148,163,184,.55);
    backdrop-filter: blur(6px);
  }
  .statusRight .counterLabel{
    font-size:12px; font-weight:900; color:#334155; letter-spacing:.08em;
  }
  #goodCounter{
    font-size:38px;
    font-weight:1000;
    line-height:1;
    letter-spacing:.06em;
    color:var(--primary);
    font-variant-numeric: tabular-nums;
    text-shadow: 0 1px 0 rgba(255,255,255,.35);
    min-width: 72px;
    text-align:right;
  }
  .statusRight .counterUnit{
    font-size:12px; font-weight:800; color:#64748b;
  }
  @media (max-width:520px){
    #goodCounter{ font-size:32px; min-width: 64px; }
  }
  .status--RUNNING{ background:linear-gradient(90deg,#bbf7d0,#f0fdf4); border-color:#4ade80; }
  .status--TRY{ background:linear-gradient(90deg,#bfdbfe,#eff6ff); border-color:#60a5fa; }
  .status--ABNORMAL_STOP{ background:linear-gradient(90deg,#fecaca,#fef2f2); border-color:#f87171; }
  .status--PLAN_STOP{ background:linear-gradient(90deg,#fed7aa,#fff7ed); border-color:#fb923c; }
  .status--MATERIAL_CHANGE{ background:linear-gradient(90deg,#e9d5ff,#faf5ff); border-color:#c084fc; }
  .status--SETUP_CHANGE{ background:linear-gradient(90deg,#fde68a,#fefce8); border-color:#facc15; }
  .status--NOT_STARTED{ background:#f1f5f9; border-color:#cbd5e1; }

  /* Scan view layout */
  .baseWrap{ display:grid; grid-template-columns: 1.2fr .8fr; gap:16px; align-items:stretch; }
  @media (max-width:900px){ .baseWrap{ grid-template-columns:1fr; } }
  .baseBox{
    border:2px dashed #cbd5e1; border-radius:16px; background:#fbfdff;
    padding:16px; text-align:center; display:flex; flex-direction:column; justify-content:center;
  }
  .baseHeading{ display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap; }
  .statusChip{
    display:inline-block; padding:4px 10px; border-radius:999px; font-size:13px;
    border:1px solid #cbd5e1; background:#f1f5f9;
  }
  .baseValue{
    font-weight:900; font-size: clamp(70px, 10vw, 140px);
    color:var(--primary); word-break:break-all;
  }
  .placeholder{ color:#94a3b8; }

  .imgBox{
    border:2px dashed #e5e7eb; border-radius:16px; background:#fff;
    padding:10px; display:flex; align-items:center; justify-content:center; min-height:220px;
  }
  #productImage{ max-width:100%; max-height:320px; object-fit:contain; display:none; }
  .imgHint{ color:#9ca3af; font-size:13px; text-align:center; line-height:1.6; }

  /* â˜… ç…§åˆçµæœã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º */
  .resultArea{
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.95);
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(8px);
  }
  .resultArea.show { display: flex; }
  .resultMark{
    font-size: 280px; line-height: 1; display: none;
    font-weight: 900;
    animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    text-shadow: 0 8px 16px rgba(0,0,0,0.2);
  }
  @keyframes popIn {
    0% { transform: scale(0.3); opacity: 0; }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); opacity: 1; }
  }
  .ok{ color:var(--ok); }
  .ng{ color:var(--ng); }
  .lock{
    display:none;
    font-size: 28px;
    color:#fff;
    background: var(--ng);
    font-weight:900;
    padding: 24px 40px;
    border-radius: 16px;
    line-height: 1.4;
    box-shadow: 0 12px 24px rgba(0,0,0,0.3);
  }
  .status{ font-size:15px; color:var(--muted); margin-top:12px; }

  @media (max-width: 768px) {
    .resultMark { font-size: 200px; }
    .lock { font-size: 22px; padding: 20px 30px; }
  }

  .btn{
    padding:10px 14px; border-radius:12px; border:1px solid #d1d5db;
    background:#fff; cursor:pointer; font-size:14px;
    -webkit-tap-highlight-color: transparent;
  }
  .btn.warn{ background:#fef3f2; color:#b42318; border-color:#fecdcf; }
  .btn.big{ font-size:18px; padding:16px 22px; border-width:2px; }
  .btn.big.primary{ background:#0b3b75; color:#fff; border-color:#0b3b75; }
  .btn:disabled{ opacity:.5; cursor:not-allowed; }

  /* çŠ¶æ…‹åˆ‡æ›¿ãƒœã‚¿ãƒ³ */
  .stateBar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
  .stateBtn{
    padding:10px 12px; border-radius:12px; border:1px solid #d1d5db;
    background:#fff; cursor:pointer; font-size:14px;
  }
  .stateBtn.active{
    border-color:#0b3b75;
    box-shadow:0 0 0 3px rgba(11,59,117,.12);
    font-weight:900;
  }

  /* Timeline */
  .tlHead{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .tlHead .title{ font-size:16px; font-weight:900; }
  .tlHint{ color:#64748b; font-size:12px; }
  .tlTable{ width:100%; border-collapse:separate; border-spacing:0; margin-top:10px; }
  .tlTable th,.tlTable td{
    border-bottom:1px solid #e5e7eb;
    padding:8px 10px;
    font-size:13px;
    vertical-align:top;
  }
  .tlTable th{ text-align:left; color:#475569; font-weight:900; background:#f8fafc; position:sticky; top:0; }
  .tlWrap{ max-height:320px; overflow:auto; border:1px solid #e5e7eb; border-radius:12px; }
  .tlBadge{
    display:inline-block; padding:2px 8px; border-radius:999px;
    border:1px solid #d1d5db; font-size:12px; font-weight:800; background:#fff;
  }
  .tlDim{ color:#64748b; }

  /* Master view */
  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  @media (max-width:900px){ .grid2{ grid-template-columns:1fr; } }
  .field{ display:flex; flex-direction:column; gap:6px; }
  .field label{ font-size:12px; color:#475569; }
  .field input[type="text"]{
    padding:10px 12px; border-radius:10px; border:1px solid #d1d5db;
    font-size:16px; outline:none;
  }
  .field input[type="text"]:focus{
    border-color:#93c5fd; box-shadow:0 0 0 3px rgba(59,130,246,.15);
  }
  input[type="file"]{ display:none; }
  .toolBtn{
    padding:6px 10px; border-radius:10px; border:1px solid #d1d5db;
    background:#fff; cursor:pointer; font-size:13px; -webkit-tap-highlight-color: transparent;
  }
  .note{ font-size:12px; color:#6b7280; line-height:1.6; }
  .kpi{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .danger{ color:#b42318; font-weight:700; }

  footer{ text-align:center; color:#9ca3af; font-size:12px; padding:16px 0; }

  /* ===== å…¨ä½“èƒŒæ™¯ï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ï¼ˆãã£ãã‚Šï¼‰ ===== */
  body.bg-NOT_STARTED{ background:#e5e7eb; }        /* ã‚°ãƒ¬ãƒ¼ */
  body.bg-RUNNING{ background:#86efac; }            /* ç·‘ */
  body.bg-TRY{ background:#93c5fd; }                /* é’ */
  body.bg-ABNORMAL_STOP{ background:#fca5a5; }      /* èµ¤ */
  body.bg-PLAN_STOP{ background:#fdba74; }          /* ã‚ªãƒ¬ãƒ³ã‚¸ */
  body.bg-MATERIAL_CHANGE{ background:#d8b4fe; }    /* ç´« */
  body.bg-SETUP_CHANGE{ background:#fde047; }       /* é»„ */

  /* Counters */
  .kpiRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px; }
  .kpiPill{ font-size:13px; padding:6px 10px; border-radius:999px; border:1px solid #cbd5e1; background:#fff; font-weight:800; }
  .kpiPill b{ font-size:16px; margin-left:6px; }
  .kpiPill.muted{ color:#475569; background:#f8fafc; }
/* ===== ãƒ‡ã‚¸ã‚¿ãƒ«å‡ºæ¥é«˜ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ ===== */
.statusRight{
  background: #000;                /* é»’èƒŒæ™¯ */
  border: 2px solid #222;
  box-shadow:
    inset 0 0 12px rgba(0,0,0,.8),
    0 4px 12px rgba(0,0,0,.25);
}

.statusRight .counterLabel{
  color: #9ca3af;                  /* è–„ã„ã‚°ãƒ¬ãƒ¼ */
  letter-spacing: .2em;
}

#goodCounter{
  font-family: "DS-Digital","Digital-7","Orbitron",
               ui-monospace, monospace;
  font-size: 44px;
  font-weight: 700;
  color: #00ff66;                  /* ãƒ‡ã‚¸ã‚¿ãƒ«ç·‘ */
  background: #000;
  padding: 6px 10px;
  border-radius: 6px;
  min-width: 120px;
  text-align: right;
  letter-spacing: .12em;
  font-variant-numeric: tabular-nums;

  /* ç™ºå…‰è¡¨ç¾ */
  text-shadow:
    0 0 4px rgba(0,255,102,.9),
    0 0 12px rgba(0,255,102,.6),
    0 0 24px rgba(0,255,102,.35);
}

.statusRight .counterUnit{
  color: #9ca3af;
  margin-left: 4px;
}

/* ãƒ¢ãƒã‚¤ãƒ« */
@media (max-width:520px){
  #goodCounter{
    font-size: 34px;
    min-width: 96px;
  }
}
#miniHourlyChart{
  display:block;
  width: 160px;
  height: 46px;
  margin-left: 10px;
  margin-top: 6px;
  opacity: .95;
}
@media (max-width:520px){
  #miniHourlyChart{ width: 140px; }
}

</style>
</head>

<body class="bg-NOT_STARTED">
<header>
  <div>
    <h1>QRç…§åˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ•´ç†Noâ†’ç”»åƒãƒã‚¹ã‚¿ï¼‰</h1>
  </div>

  <div class="tabs" role="tablist" aria-label="mode tabs">
    <button id="tabScan" class="tab active" role="tab" aria-selected="true">ç…§åˆãƒ¢ãƒ¼ãƒ‰</button>
    <button id="tabMaster" class="tab" role="tab" aria-selected="false">ç”»åƒãƒã‚¹ã‚¿ç™»éŒ²</button>
    <button id="tabQtyMaster" class="tab" role="tab" aria-selected="false">å€‹æ•°ãƒã‚¹ã‚¿è¨­å®š</button>
  </div>

  <div class="rightTools">
    <div class="bushoWrap">
      <span class="small">éƒ¨ç½²</span>
      <select id="bushoSelect">
        <option value="">æœªè¨­å®š</option>
        <option>1G</option><option>3G</option><option>4G</option><option>5G</option><option>6G</option><option>å“è³ª</option>
      </select>
      <span id="bushoBadge" class="pill" title="ç¾åœ¨ã®éƒ¨ç½²">æœªè¨­å®š</span>
    </div>

    <div class="lineWrap">
      <span class="small">ãƒ©ã‚¤ãƒ³</span>
      <select id="lineSelect">
        <option value="">æœªè¨­å®š</option>
        <option>53-300</option><option>57-200</option><option>65-300</option><option>71-300</option><option>72-160</option>
        <option>83-500</option><option>89-400</option><option>90-600</option><option>94-300</option><option>RL5</option>
        <option>TPS03-3.5</option><option>ã‚ãã²ã¨</option><option>ã‚­ãƒ£ãƒƒãƒ—ï¼–å·æ©Ÿ</option><option>ã‚­ãƒ£ãƒƒãƒ—ï¼—å·æ©Ÿ</option>
        <option>30-060</option><option>41-200</option><option>42-250</option><option>49-060</option><option>51-110</option>
        <option>54-160</option><option>70-080</option><option>76-060</option><option>78-060</op11:51 2026/01/20tion><option>82-045</option>
        <option>87-400</option><option>88-400</option><option>91-200</option><option>RL1</option><option>RL3</option><option>RL4</option>
        <option>RMI-1(ã‚¤ãƒ³ã‚µãƒ¼ãƒˆæˆå‹æ©Ÿï¼‰</option><option>TPS01-2.7</option><option>TPS02-0.75</option>
        <option>ã‚­ãƒ£ãƒƒãƒ—10å·æ©Ÿ</option><option>ã‚­ãƒ£ãƒƒãƒ—ï¼˜å·æ©Ÿ</option><option>ã‚­ãƒ£ãƒƒãƒ—9å·æ©Ÿ</option>
      </select>
      <span id="lineBadge" class="pill" title="ç¾åœ¨ã®ãƒ©ã‚¤ãƒ³">æœªè¨­å®š</span>
    </div>

    <span id="firebaseStatus" class="badge" style="color:#9ca3af;">Firebase: æœªæ¥ç¶š</span>
    <span id="storageStatus" class="badge" style="color:#9ca3af;">Storage: æœªæº–å‚™</span>
  </div>
</header>

<input id="scanInput" type="text" readonly inputmode="none"
  autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" aria-hidden="true"
  style="position:absolute; left:-9999px; top:-9999px; width:1px; height:1px; opacity:0; pointer-events:none;" />

<main>
  <!-- ===================== ç…§åˆãƒ¢ãƒ¼ãƒ‰ ===================== -->
  <section id="viewScan" class="view active">
    <div class="card">

      <!-- â˜… ç›®ç«‹ã¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
      <div id="statusBar" class="statusBar status--NOT_STARTED">
        <div class="statusLeft">
          <div id="prodStateBig" class="statusBig">æœªé–‹å§‹</div>
          <div id="statusHint" class="statusSub">åŸºæº–æœªè¨­å®š</div>
        </div>
        <div class="statusRight" aria-label="å‡ºæ¥é«˜ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼">
          <div class="counterLabel">å‡ºæ¥é«˜</div>
          <div id="goodCounter">0</div>
          <div class="counterUnit">pcs</div>
            <canvas id="miniHourlyChart" width="160" height="46" aria-label="æ™‚é–“åˆ¥å‡ºæ¥é«˜ãƒŸãƒ‹ã‚°ãƒ©ãƒ•"></canvas>
        </div>
      </div>

      <div class="baseWrap">
        <div class="baseBox">
          <div class="baseHeading">
            <span id="masterHit" class="statusChip" style="display:none;">ç”»åƒãƒã‚¹ã‚¿ï¼šãƒ’ãƒƒãƒˆ</span>
            <span id="masterMiss" class="statusChip" style="display:none;">ç”»åƒãƒã‚¹ã‚¿ï¼šæœªç™»éŒ²</span>
          </div>
          <div id="baseDisplay" class="baseValue placeholder">æœªè¨­å®š</div>
        </div>

        <div class="imgBox">
          <img id="productImage" alt="åŸºæº–(æ•´ç†No)ã®ç”»åƒ" />
          <div id="imgHint" class="imgHint">
            åŸºæº–QRã‚’èª­ã¿è¾¼ã‚€ã¨ã€åˆ‡ã‚Šå‡ºã—å€¤ï¼ˆæ•´ç†Noï¼‰ã§ç”»åƒãƒã‚¹ã‚¿ã‚’æ¤œç´¢ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚<br>
            ç”»åƒãŒå‡ºãªã„å ´åˆã¯ã€Œç”»åƒãƒã‚¹ã‚¿ç™»éŒ²ã€ã‚¿ãƒ–ã§ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
          </div>
        </div>
      </div>

      <!-- â˜… ç…§åˆçµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
      <div class="resultArea">
        <div id="ok" class="resultMark ok">â—‹</div>
        <div id="ng" class="resultMark ng">Ã—</div>
        <div id="lockMsg" class="lock">NGï¼ ç®¡ç†è€…QRã‚’èª­ã¿è¾¼ã‚€ã¾ã§ãƒ­ãƒƒã‚¯ä¸­</div>
      </div>

      <!-- çŠ¶æ…‹åˆ‡æ›¿ -->
      <div class="stateBar">
        <button id="btnBackRunning" class="stateBtn" type="button">ç”Ÿç”£ä¸­ã«æˆ»ã™</button>
        <button id="btnTry" class="stateBtn" type="button">ãƒˆãƒ©ã‚¤ä¸­</button>
        <button id="btnAbnormalStop" class="stateBtn" type="button">ç•°å¸¸åœæ­¢ä¸­</button>
        <button id="btnPlanStop" class="stateBtn" type="button">è¨ˆç”»åœæ­¢ä¸­</button>
        <button id="btnMaterialChange" class="stateBtn" type="button">ææ–™æ›¿ãˆä¸­</button>
      </div>
      <div>ã€€</div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="resetBtn" class="btn big primary" tabindex="-1">è£½å“åˆ‡æ›¿ãˆ</button>
        <button id="deleteLastBtn" class="btn warn" tabindex="-1">ç›´å‰ãƒ­ã‚°å‰Šé™¤</button>
        <button id="saveBtn" class="btn" tabindex="-1">ãƒ­ã‚°ä¿å­˜ï¼ˆCSVï¼‰</button>
        <button id="exitBtn" class="btn warn" tabindex="-1">ã‚·ã‚¹ãƒ†ãƒ çµ‚äº†ï¼ˆè‡ªå‹•ä¿å­˜ï¼‰</button>
      </div>

      <div id="mode" class="status">åŸºæº–QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
 
    </div>

    <!-- ä»Šæ—¥ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§» -->
    <div class="card">
      <div class="tlHead">
        <div class="title">ä»Šæ—¥ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»</div>
        <span class="tlHint">æœ€æ–°50ä»¶ï¼ˆæœ¬æ—¥0:00ã€œï¼‰</span>
        <span id="tlCount" class="badge" style="margin-left:auto; color:#64748b;">0ä»¶</span>
      </div>
      <div class="tlWrap">
        <table class="tlTable">
          <thead>
            <tr>
              <th style="width:120px;">æ™‚åˆ»</th>
              <th>é·ç§»</th>
              <th style="width:160px;">ç†ç”±</th>
              <th style="width:120px;">åŸºæº–</th>
              <th style="width:140px;">ãƒ©ã‚¤ãƒ³/éƒ¨ç½²</th>
            </tr>
          </thead>
          <tbody id="timelineBody">
            <tr><td colspan="5" class="tlDim" style="padding:14px;">Firestoreæ¥ç¶šå¾Œã«è¡¨ç¤ºã—ã¾ã™ã€‚</td></tr>
          </tbody>
        </table>
      </div>
      <div class="tlHint" style="margin-top:10px;">
        â€»é›†è¨ˆç”¨ã« <span class="tlBadge">tsMs</span>ï¼ˆç«¯æœ«æ™‚åˆ»ï¼‰ã§å½“æ—¥ç¯„å›²æ¤œç´¢ã—ã¦ã„ã¾ã™ã€‚ç«¯æœ«æ™‚åˆ»ãŒã‚ºãƒ¬ã¦ã„ã‚‹ã¨ç¯„å›²å¤–ã«ãªã‚Šã¾ã™ã€‚
      </div>
    </div>
  </section>

  <!-- ===================== ç”»åƒãƒã‚¹ã‚¿ç™»éŒ² ===================== -->
  <section id="viewMaster" class="view">
    <div class="card">
      <div class="bigLabel">ç”»åƒãƒã‚¹ã‚¿ç™»éŒ²ï¼ˆæ•´ç†No â†’ ç”»åƒï¼‰</div>

      <div class="grid2">
        <div class="field">
          <label>æ•´ç†Noï¼ˆåˆ‡ã‚Šå‡ºã—å€¤ï¼‰</label>
          <input id="masterSeiriNo" type="text" placeholder="ä¾‹ï¼šABCDE" inputmode="latin" autocomplete="off" />
          <div class="note">â€»ã“ã®æ•´ç†Noã§ <b>imageMasters/{æ•´ç†No}</b> ã«ä¿å­˜ã—ã¾ã™ã€‚</div>
        </div>

        <div class="field">
          <label>ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«</label>
          <div class="kpi">
            <label class="toolBtn" for="masterImageFile">ç”»åƒã‚’é¸æŠ</label>
            <input id="masterImageFile" type="file" accept="image/*" />
            <span id="masterFileName" class="pill">æœªé¸æŠ</span>
            <span id="masterUploadState" class="pill">æœªç™»éŒ²</span>
          </div>
          <div class="note">â€»Storage ã¯ <b>productImages/{æ•´ç†No}.{æ‹¡å¼µå­}</b> ã«ä¿å­˜ï¼ˆåŒã˜æ•´ç†Noã¯ä¸Šæ›¸ãæ›´æ–°ï¼‰ã€‚</div>
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button id="masterUploadBtn" class="btn">ç™»éŒ²ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰</button>
        <button id="masterFetchBtn" class="btn">ã“ã®æ•´ç†Noã‚’æ¤œç´¢ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</button>
        <button id="masterClearBtn" class="btn warn">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
      </div>

      <div class="note" style="margin-top:10px;">
        <span class="danger">é‹ç”¨æ³¨æ„ï¼š</span>
        åŒã˜æ•´ç†Noã§æ‹¡å¼µå­ãŒå¤‰ã‚ã‚‹ã¨ Storage ã«å¤ã„æ‹¡å¼µå­ã®ç”»åƒãŒæ®‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼ˆå¿…è¦ãªã‚‰å‰Šé™¤ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ ã§ãã¾ã™ï¼‰ã€‚
      </div>

      <div class="card" style="margin-top:14px;">
        <div class="bigLabel" style="font-size:16px;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
        <div class="imgBox">
          <img id="masterPreviewImage" alt="ãƒã‚¹ã‚¿ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" style="max-width:100%; max-height:320px; object-fit:contain; display:none;" />
          <div id="masterPreviewHint" class="imgHint">ã“ã“ã«æ¤œç´¢çµæœï¼ˆç”»åƒï¼‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
        </div>
      </div>

      <!-- ç™»éŒ²æ¸ˆã¿ç”»åƒãƒã‚¹ã‚¿ä¸€è¦§ -->
      <div class="card" style="margin-top:14px;">
        <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
          <div class="bigLabel" style="font-size:16px; margin:0;">ç™»éŒ²æ¸ˆã¿ç”»åƒãƒã‚¹ã‚¿</div>
          <button id="masterRefreshBtn" class="btn" style="padding:6px 12px; font-size:13px;">ğŸ”„ æ›´æ–°</button>
        </div>
        <div id="masterListHint" class="imgHint" style="margin:10px 0;">èª­ã¿è¾¼ã¿ä¸­...</div>
        <div id="masterListGrid" style="display:none; margin-top:10px;">
          <div id="masterListContainer" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:12px; max-height:600px; overflow-y:auto; padding:4px;"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===================== å€‹æ•°ãƒã‚¹ã‚¿è¨­å®š ===================== -->
  <section id="viewQtyMaster" class="view">
    <div class="card">
      <div class="bigLabel">å€‹æ•°ãƒã‚¹ã‚¿è¨­å®šï¼ˆå“ç•ªåˆ¥QR1å›ã‚ãŸã‚Šå€‹æ•°ï¼‰</div>
      
      <div class="grid2">
        <div class="field">
          <label>æ•´ç†Noï¼ˆå“ç•ªï¼‰</label>
          <input id="qtyMasterSeiriNo" type="text" placeholder="ä¾‹ï¼šABCDE" inputmode="latin" autocomplete="off" />
          <div class="note">â€»QRã‚³ãƒ¼ãƒ‰ã‹ã‚‰åˆ‡ã‚Šå‡ºã•ã‚Œã‚‹æ•´ç†Noï¼ˆå“ç•ªï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
        </div>

        <div class="field">
          <label>QR1å›ã‚ãŸã‚Šã®å€‹æ•°</label>
          <input id="qtyMasterQuantity" type="number" min="1" step="1" value="1" placeholder="1" />
          <div class="note">â€»QRã‚’1å›ã‚¹ã‚­ãƒ£ãƒ³ã—ãŸæ™‚ã«ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹å€‹æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼š1å€‹ï¼‰</div>
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button id="qtyMasterSaveBtn" class="btn">ç™»éŒ²</button>
        <button id="qtyMasterFetchBtn" class="btn">ã“ã®å“ç•ªã‚’æ¤œç´¢</button>
        <button id="qtyMasterDeleteBtn" class="btn warn">å‰Šé™¤</button>
        <button id="qtyMasterClearBtn" class="btn">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
      </div>

      <div class="note" style="margin-top:10px;">
        <b>ç™»éŒ²å…ˆï¼š</b> Firestore <code>qrMaster/{æ•´ç†No}</code> ã« quantity ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br>
        <b>å‹•ä½œï¼š</b> ç™»éŒ²ã•ã‚Œã¦ã„ãªã„å“ç•ªã¯è‡ªå‹•çš„ã«ã€Œ1å€‹ã€ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã¾ã™ã€‚
      </div>

      <!-- ç™»éŒ²æ¸ˆã¿ä¸€è¦§ -->
      <div class="card" style="margin-top:14px;">
        <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
          <div class="bigLabel" style="font-size:16px; margin:0;">ç™»éŒ²æ¸ˆã¿å€‹æ•°ãƒã‚¹ã‚¿</div>
          <button id="qtyMasterRefreshBtn" class="btn" style="padding:6px 12px; font-size:13px;">ğŸ”„ æ›´æ–°</button>
        </div>
        <div id="qtyMasterListHint" class="imgHint" style="margin:10px 0;">èª­ã¿è¾¼ã¿ä¸­...</div>
        <div id="qtyMasterListTable" style="display:none; margin-top:10px; max-height:400px; overflow-y:auto;">
          <table style="width:100%; border-collapse:collapse;">
            <thead style="position:sticky; top:0; background:#f8fafc; border-bottom:2px solid #cbd5e1;">
              <tr>
                <th style="padding:8px; text-align:left; font-size:13px; font-weight:900;">æ•´ç†Noï¼ˆå“ç•ªï¼‰</th>
                <th style="padding:8px; text-align:center; font-size:13px; font-weight:900;">å€‹æ•°</th>
                <th style="padding:8px; text-align:center; font-size:13px; font-weight:900;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="qtyMasterListBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
</main>

<footer>Â© QR Verify</footer>

<script>
/* ================== è¨­å®š ================== */
const CUT_START = 2;
const CUT_LENGTH = 5;
const ADMIN_QR = "ADMIN123";
const LINE_KEY = "qr_line_name";
const BUSHO_KEY = "qr_busho_name";

const STORAGE_DIR = "productImages";       // Storage: productImages/...
const MASTER_COLLECTION = "imageMasters";  // Firestore: imageMasters/{seiriNo}

/* â˜… Firestore: ç”Ÿç”£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»ãƒ­ã‚° */
const STATUS_LOG_COLLECTION = "prodStatusLogs";

/* ================== çŠ¶æ…‹ ================== */
let baseQR = null; // åŸºæº–ï¼ˆæ•´ç†Noï¼‰
let isLocked = false;
let logData = [["æ™‚åˆ»","èª­ã¿è¾¼ã‚“ã QR","åˆ‡ã‚Šå‡ºã—å¾Œå€¤","åˆ¤å®š","ãƒ­ãƒƒã‚¯çŠ¶æ…‹","ç”»åƒæƒ…å ±","ãƒ©ã‚¤ãƒ³","éƒ¨ç½²","ç”Ÿç”£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"]];

// ===== Counters =====
let goodCount = 0;          // å‡ºæ¥é«˜ï¼ˆæ•°é‡ã®åˆè¨ˆï¼‰
let qtyPerKanban = null;    // qrMaster.quantityï¼ˆ1æšã‚ãŸã‚Šå€‹æ•°ï¼‰

// Firestore(qrLogs) ã® docId ã‚’ logData è¡Œç•ªå·ã¨å¯¾å¿œã¥ã‘ã¦ä¿æŒï¼ˆç›´å‰ãƒ­ã‚°å‰Šé™¤ç”¨ï¼‰
const qrLogDocIds = [];

// â˜… å„ãƒ­ã‚°è¡ŒãŒã‚«ã‚¦ãƒ³ã‚¿ã«ä¸ãˆãŸå½±éŸ¿ï¼ˆç›´å‰ãƒ­ã‚°å‰Šé™¤ã§å·»ãæˆ»ã™ç”¨ï¼‰
//   logData ã¨åŒã˜è¡Œæ•°ã‚’ç¶­æŒï¼ˆãƒ˜ãƒƒãƒ€è¡Œã‚‚å«ã‚ã¦ç®¡ç†ï¼‰
const counterDeltas = [{ good:0 }];


let lineName = localStorage.getItem(LINE_KEY) || "";
let bushoName = localStorage.getItem(BUSHO_KEY) || "";

/* ç”Ÿç”£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
const PROD_STATUS = {
  NOT_STARTED: "æœªé–‹å§‹",
  RUNNING: "ç”Ÿç”£ä¸­",
  TRY: "ãƒˆãƒ©ã‚¤ä¸­",
  ABNORMAL_STOP: "ç•°å¸¸åœæ­¢ä¸­",
  PLAN_STOP: "è¨ˆç”»åœæ­¢ä¸­",
  MATERIAL_CHANGE: "ææ–™æ›¿ãˆä¸­",
  SETUP_CHANGE: "æ®µæ›¿ãˆä¸­"
};
let prodStatus = PROD_STATUS.NOT_STARTED;

/* moduleå´ã‹ã‚‰æ³¨å…¥ã•ã‚Œã‚‹é–¢æ•° */
let __getMasterBySeiriNo = null; // async(seiriNo)=>{imagePath,downloadUrl,...}|null
let __saveMaster = null;         // async(seiriNo,file)=>{imagePath,downloadUrl}
let __loadLineStatus = null;     // async(line)=>{...}|null  â˜…è¿½åŠ ï¼ˆèµ·å‹•æ™‚å¾©å…ƒç”¨ï¼‰
let __getQtyBySeiriNo = null;   // async(seiriNo)=>number|null  â˜…è¿½åŠ ï¼ˆ1æšã‚ãŸã‚Šå€‹æ•°ï¼‰

/* Firestoreæ›¸è¾¼ã¿ï¼ˆmoduleå´ãŒæº–å‚™ã§ããŸã‚‰æ³¨å…¥ï¼‰ */
let __firestoreLogRow = null;    // qrLogs
let __firestoreStatusLog = null; // prodStatusLogs

/* ================== DOM ================== */
const $tabScan = document.getElementById("tabScan");
const $tabMaster = document.getElementById("tabMaster");
const $tabQtyMaster = document.getElementById("tabQtyMaster");
const $viewScan = document.getElementById("viewScan");
const $viewMaster = document.getElementById("viewMaster");
const $viewQtyMaster = document.getElementById("viewQtyMaster");

const $mode = document.getElementById("mode");
const $ok = document.getElementById("ok");
const $ng = document.getElementById("ng");
const $lockMsg = document.getElementById("lockMsg");
const $baseDisplay = document.getElementById("baseDisplay");
const $productImage = document.getElementById("productImage");
const $imgHint = document.getElementById("imgHint");
const $resetBtn = document.getElementById("resetBtn");
const $deleteLastBtn = document.getElementById("deleteLastBtn");

// Counters UI

const $masterHit = document.getElementById("masterHit");
const $masterMiss = document.getElementById("masterMiss");

const $lineSelect = document.getElementById("lineSelect");
const $lineBadge = document.getElementById("lineBadge");
const $bushoSelect = document.getElementById("bushoSelect");
const $bushoBadge = document.getElementById("bushoBadge");

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
const $statusBar = document.getElementById("statusBar");
const $prodStateBig = document.getElementById("prodStateBig");
const $statusHint = document.getElementById("statusHint");

/* çŠ¶æ…‹ãƒœã‚¿ãƒ³ */
const $btnBackRunning = document.getElementById("btnBackRunning");
const $btnTry = document.getElementById("btnTry");
const $btnAbnormalStop = document.getElementById("btnAbnormalStop");
const $btnPlanStop = document.getElementById("btnPlanStop");
const $btnMaterialChange = document.getElementById("btnMaterialChange");

/* Timeline */
const $timelineBody = document.getElementById("timelineBody");
const $tlCount = document.getElementById("tlCount");

/* Master UI */
const $masterSeiriNo = document.getElementById("masterSeiriNo");
const $masterImageFile = document.getElementById("masterImageFile");
const $masterFileName = document.getElementById("masterFileName");
const $masterUploadState = document.getElementById("masterUploadState");
const $masterUploadBtn = document.getElementById("masterUploadBtn");
const $masterFetchBtn = document.getElementById("masterFetchBtn");
const $masterClearBtn = document.getElementById("masterClearBtn");
const $masterPreviewImage = document.getElementById("masterPreviewImage");
const $masterPreviewHint = document.getElementById("masterPreviewHint");
const $masterRefreshBtn = document.getElementById("masterRefreshBtn");
const $masterListHint = document.getElementById("masterListHint");
const $masterListGrid = document.getElementById("masterListGrid");
const $masterListContainer = document.getElementById("masterListContainer");

/* Qty Master UI */
const $qtyMasterSeiriNo = document.getElementById("qtyMasterSeiriNo");
const $qtyMasterQuantity = document.getElementById("qtyMasterQuantity");
const $qtyMasterSaveBtn = document.getElementById("qtyMasterSaveBtn");
const $qtyMasterFetchBtn = document.getElementById("qtyMasterFetchBtn");
const $qtyMasterDeleteBtn = document.getElementById("qtyMasterDeleteBtn");
const $qtyMasterClearBtn = document.getElementById("qtyMasterClearBtn");
const $qtyMasterRefreshBtn = document.getElementById("qtyMasterRefreshBtn");
const $qtyMasterListHint = document.getElementById("qtyMasterListHint");
const $qtyMasterListTable = document.getElementById("qtyMasterListTable");
const $qtyMasterListBody = document.getElementById("qtyMasterListBody");

/* ================== ã‚¿ãƒ–åˆ‡æ›¿ ================== */
function setActiveTab(mode){
  const isScan = (mode === "scan");
  const isMaster = (mode === "master");
  const isQtyMaster = (mode === "qtyMaster");
  
  $tabScan.classList.toggle("active", isScan);
  $tabMaster.classList.toggle("active", isMaster);
  $tabQtyMaster.classList.toggle("active", isQtyMaster);
  
  $tabScan.setAttribute("aria-selected", isScan ? "true" : "false");
  $tabMaster.setAttribute("aria-selected", isMaster ? "true" : "false");
  $tabQtyMaster.setAttribute("aria-selected", isQtyMaster ? "true" : "false");
  
  $viewScan.classList.toggle("active", isScan);
  $viewMaster.classList.toggle("active", isMaster);
  $viewQtyMaster.classList.toggle("active", isQtyMaster);
}
$tabScan.addEventListener("click", ()=>setActiveTab("scan"));
$tabMaster.addEventListener("click", ()=>{
  setActiveTab("master");
  loadImageMasterList();
});
$tabQtyMaster.addEventListener("click", ()=>{
  setActiveTab("qtyMaster");
  loadQtyMasterList();
});

/* ================== Utils ================== */
function nowString(){
  const d=new Date(); const pad=n=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function normalizeSeiriNo(s){ return String(s||"").trim().replace(/\s+/g,""); }
function cutQR(qr){ return normalizeSeiriNo(String(qr||"").substr(CUT_START, CUT_LENGTH)); }

function showOK(){
  const resultArea = document.querySelector('.resultArea');
  resultArea.classList.add('show');
  $ok.style.display="block";
  $ng.style.display="none";
  setTimeout(()=>{
    $ok.style.display="none";
    resultArea.classList.remove('show');
  }, 1500);
}
function showNGPersistent(){
  const resultArea = document.querySelector('.resultArea');
  resultArea.classList.add('show');
  $ok.style.display="none";
  $ng.style.display="block";
}
function clearMarks(){
  const resultArea = document.querySelector('.resultArea');
  resultArea.classList.remove('show');
  $ok.style.display="none";
  $ng.style.display="none";
}

function setLock(state){
  isLocked = state;
  const resultArea = document.querySelector('.resultArea');
  if (state) {
    resultArea.classList.add('show');
    $lockMsg.style.display = "block";
  } else {
    resultArea.classList.remove('show');
    $lockMsg.style.display = "none";
  }
  $resetBtn.disabled = state;
  if(!state) clearMarks();
}
function updateBaseDisplay(val){
  if(val){ $baseDisplay.classList.remove("placeholder"); $baseDisplay.textContent=val; }
  else { $baseDisplay.classList.add("placeholder"); $baseDisplay.textContent="æœªè¨­å®š"; }
}
function setMasterBadge(hit){
  $masterHit.style.display = hit ? "inline-block" : "none";
  $masterMiss.style.display = hit ? "none" : "inline-block";
}
function showImage(url){
  if(url){
    $productImage.src=url; $productImage.style.display="block"; $imgHint.style.display="none";
  }
}

function updateCountersUI(){
  const el = document.getElementById("goodCounter");
  if(el) el.textContent = String(goodCount||0);
}
/* ================== ãƒŸãƒ‹ï¼šæ™‚é–“åˆ¥å‡ºæ¥é«˜ ================== */
const HOURLY_BINS = new Array(24).fill(0); // 0ã€œ23æ™‚
function addHourly(tsMs, qty){
  try{
    const d = new Date(tsMs);
    const h = d.getHours();
    HOURLY_BINS[h] = (HOURLY_BINS[h] || 0) + (qty || 0);
  }catch(e){}
}

function setHourlyBins(bins){
  // Firebaseå´ã®é›†è¨ˆçµæœã‚’åæ˜ ï¼ˆbinsã¯é•·ã•24æƒ³å®šï¼‰
  if(Array.isArray(bins) && bins.length === 24){
    for(let i=0;i<24;i++) HOURLY_BINS[i] = Number(bins[i]||0);
    renderMiniHourlyChart();
  }
}
window.__setHourlyBins = setHourlyBins;

function renderMiniHourlyChart(){
  const c = document.getElementById("miniHourlyChart");
  if(!c) return;
  const ctx = c.getContext("2d");
  const W = c.width, H = c.height;

  // ===== è¡¨ç¤ºæ¡ä»¶ =====
  const span = 12;          // ç›´è¿‘12æ™‚é–“
  const now = new Date();
  const endH = now.getHours();

  // è¡¨ç¤ºå¯¾è±¡ã®æ™‚é–“é…åˆ—
  const hours = [];
  for(let i=span-1;i>=0;i--){
    let h = endH - i;
    if(h < 0) h += 24;
    hours.push(h);
  }

  const vals = hours.map(h => Number(HOURLY_BINS[h] || 0));
  const maxV = Math.max(1, ...vals);

  // ===== ã‚¯ãƒªã‚¢ =====
  ctx.clearRect(0,0,W,H);

  // ===== ãƒãƒ¼æç”» =====
  const padX = 4;
  const padTop = 10;
  const padBottom = 14;   // â† æ™‚åˆ»ãƒ©ãƒ™ãƒ«ç”¨
  const barAreaH = H - padTop - padBottom;

  const barW = Math.floor((W - padX*2) / span);
  const gap = 2;

  ctx.fillStyle = "#00ff66";

  for(let i=0;i<span;i++){
    const v = vals[i];
    const bh = Math.round(barAreaH * (v / maxV));
    const x = padX + i*barW + Math.floor(gap/2);
    const y = padTop + (barAreaH - bh);
    const w = Math.max(2, barW - gap);

    // è–„ã„ä¸‹åœ°
    ctx.globalAlpha = 0.25;
    ctx.fillRect(x, padTop, w, barAreaH);

    // å®Ÿãƒãƒ¼
    ctx.globalAlpha = 0.95;
    ctx.fillRect(x, y, w, bh);

    // ç¾åœ¨æ™‚åˆ»ã‚’å¼·èª¿
    if(hours[i] === endH){
      ctx.globalAlpha = 1.0;
      ctx.fillRect(x, y, w, bh);
    }
  }

  ctx.globalAlpha = 1.0;

  // ===== æ¨ªè»¸ãƒ©ãƒ™ãƒ«ï¼ˆ2æ™‚é–“ãŠãï¼‰ =====
  ctx.fillStyle = "#9ca3af";
  ctx.font = "10px system-ui, sans-serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "top";

  for(let i=0;i<span;i++){
    if(i % 2 !== 0) continue; // 2æ™‚é–“ãŠã
    const h = hours[i];
    const label = String(h).padStart(2,"0");
    const x = padX + i*barW + barW/2;
    ctx.fillText(label, x, H - 11);
  }

  // ===== ç¸¦è»¸ãƒ©ãƒ™ãƒ«ï¼ˆæœ€å¤§å€¤ï¼‰ =====
  ctx.fillStyle = "#9ca3af";
  ctx.font = "10px system-ui, sans-serif";
  ctx.textAlign = "left";
  ctx.textBaseline = "top";
  ctx.fillText(`max ${maxV}`, 2, 0);
}

// lineStatus ã«ã‚«ã‚¦ãƒ³ã‚¿ã‚‚ä¸€ç·’ã«ä¿å­˜ï¼ˆå¾©å…ƒã§å¼•ãç¶™ãï¼‰
async function persistLineStatus(reason){
  if(!lineName || typeof window.__writeLineStatus !== "function") return;
  try{
    await window.__writeLineStatus(lineName, {
      state: statusKeyFromText(prodStatus),
      stateText: prodStatus,
      reason: reason || "COUNTER_UPDATE",
      product: baseQR || null,
      updatedAt: new Date().toISOString(),
      busho: bushoName || null,
      lockState: isLocked ? "LOCKED" : "UNLOCK",
      goodCount: goodCount || 0,
      qtyPerKanban: (qtyPerKanban==null? null : qtyPerKanban)
    });
  }catch(e){
    console.warn("persistLineStatus error:", e);
  }
}

function showNoImage(html){
  $productImage.style.display="none"; $imgHint.style.display="block"; $imgHint.innerHTML = html || "";
}

/* CSV */
function csvEscape(field){ const s=String(field??""); return /[\",\n]/.test(s)?`"${s.replace(/\"/g,'\"\"')}"`:s; }
function buildCSV(rows){ return rows.map(r=>r.map(csvEscape).join(",")).join("\n"); }
function downloadCSV(rows, baseName="qr_log"){
  const ts=new Date(); const pad=n=>String(n).padStart(2,"0");
  const name=`${baseName}_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}${pad(ts.getSeconds())}.csv`;
  const blob=new Blob([buildCSV(rows)],{type:"text/csv"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=name; a.click();
}

/* Firestoreãƒ­ã‚°ä¿å­˜ï¼ˆCSV + Firestore(qrLogs)ï¼‰ */
function logRow(row, delta={good:0}){
  logData.push(row);
  counterDeltas.push({
    good:   (delta && typeof delta.good   === 'number' && isFinite(delta.good))   ? delta.good   : 0
  });

  const idx = logData.length - 1;
  if(typeof __firestoreLogRow === "function"){
    Promise.resolve(__firestoreLogRow(row))
      .then((docId)=>{ if(docId) qrLogDocIds[idx] = docId; })
      .catch(()=>{});
  }
}

/* ================== ç”Ÿç”£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼šã‚­ãƒ¼åŒ– ================== */
function statusKeyFromText(text){
  if(text === PROD_STATUS.RUNNING) return "RUNNING";
  if(text === PROD_STATUS.TRY) return "TRY";
  if(text === PROD_STATUS.ABNORMAL_STOP) return "ABNORMAL_STOP";
  if(text === PROD_STATUS.PLAN_STOP) return "PLAN_STOP";
  if(text === PROD_STATUS.MATERIAL_CHANGE) return "MATERIAL_CHANGE";
  if(text === PROD_STATUS.SETUP_CHANGE) return "SETUP_CHANGE";
  return "NOT_STARTED";
}

/* ================== ç”Ÿç”£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼šè¡¨ç¤ºï¼ˆãƒãƒ¼ï¼‹èƒŒæ™¯ï¼‹ãƒœã‚¿ãƒ³ï¼‰ ================== */
function renderProdStatus(){
  const key = statusKeyFromText(prodStatus);

  $prodStateBig.textContent = prodStatus;
  $statusHint.textContent = baseQR ? `åŸºæº–ï¼š${baseQR}` : "åŸºæº–æœªè¨­å®š";

  $statusBar.className = `statusBar status--${key}`;

  document.body.classList.remove(
    "bg-NOT_STARTED","bg-RUNNING","bg-TRY","bg-ABNORMAL_STOP","bg-PLAN_STOP","bg-MATERIAL_CHANGE","bg-SETUP_CHANGE"
  );
  document.body.classList.add(`bg-${key}`);

  const setActive = (btn, on)=>btn.classList.toggle("active", !!on);
  setActive($btnBackRunning, prodStatus === PROD_STATUS.RUNNING);
  setActive($btnTry, prodStatus === PROD_STATUS.TRY);
  setActive($btnAbnormalStop, prodStatus === PROD_STATUS.ABNORMAL_STOP);
  setActive($btnPlanStop, prodStatus === PROD_STATUS.PLAN_STOP);
  setActive($btnMaterialChange, prodStatus === PROD_STATUS.MATERIAL_CHANGE);
}

/**
 * â˜…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ï¼ˆæ™‚ç³»åˆ—ãƒ­ã‚° + lineStatusæ›´æ–°ï¼‰
 */
function setProdStatus(next, reason="MANUAL"){
  if(!next || next === prodStatus) return;

  const prev = prodStatus;
  prodStatus = next;
  renderProdStatus();

  logRow([nowString(), "-", "-", `STATUS:${reason}`, isLocked?"LOCKED":"UNLOCK", `${prev}â†’${next}`, lineName, bushoName, prodStatus]);

  if(typeof __firestoreStatusLog === "function"){
    const tsMs = Date.now();
    __firestoreStatusLog({
      tsText: nowString(),
      tsMs,
      prevStatus: prev,
      nextStatus: next,
      reason,
      line: lineName || null,
      busho: bushoName || null,
      baseQR: baseQR || null,
      lockState: isLocked ? "LOCKED" : "UNLOCK",
      pageUrl: location.href,
      userAgent: navigator.userAgent
    }).catch(()=>{});
  }

  if(lineName && typeof window.__writeLineStatus === "function"){
    window.__writeLineStatus(lineName, {
      state: statusKeyFromText(next),
      stateText: next,
      reason: reason,
      product: baseQR || null,
      updatedAt: new Date().toISOString(),
      busho: bushoName || null,
      lockState: isLocked ? "LOCKED" : "UNLOCK"
    }).catch(err => console.warn("ãƒ©ã‚¤ãƒ³çŠ¶æ…‹æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err));
  }
}

/* ================== çŠ¶æ…‹ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ ================== */
$btnBackRunning.addEventListener("click", ()=>{
  setProdStatus(PROD_STATUS.RUNNING, "BACK_TO_RUNNING_BTN");
  clearMarks();
});
$btnTry.addEventListener("click", ()=>setProdStatus(PROD_STATUS.TRY, "TRY_BTN"));
$btnAbnormalStop.addEventListener("click", ()=>setProdStatus(PROD_STATUS.ABNORMAL_STOP, "ABNORMAL_STOP_BTN"));
$btnPlanStop.addEventListener("click", ()=>setProdStatus(PROD_STATUS.PLAN_STOP, "PLAN_STOP_BTN"));
$btnMaterialChange.addEventListener("click", ()=>setProdStatus(PROD_STATUS.MATERIAL_CHANGE, "MATERIAL_CHANGE_BTN"));

/* ================== Timelineæç”» ================== */
function esc(s){ return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function fmtTimeFromMs(ms){
  try{
    const d=new Date(ms);
    const pad=n=>String(n).padStart(2,"0");
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }catch(e){ return "-"; }
}
window.__updateStatusTimeline = function(list){
  const rows = Array.isArray(list) ? list : [];
  $tlCount.textContent = `${rows.length}ä»¶`;

  if(rows.length===0){
    $timelineBody.innerHTML = `<tr><td colspan="5" class="tlDim" style="padding:14px;">æœ¬æ—¥ã®é·ç§»ãƒ­ã‚°ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>`;
    return;
  }

  $timelineBody.innerHTML = rows.map(r=>{
    const time = r.tsMs ? fmtTimeFromMs(r.tsMs) : (r.tsText ? esc(r.tsText.split(" ")[1]||"-") : "-");
    const trans = `${esc(r.prevStatus||"-")} â†’ ${esc(r.nextStatus||"-")}`;
    const reason = esc(r.reason||"-");
    const base = esc(r.baseQR||"-");
    const lb = `${esc(r.line||"-")} / ${esc(r.busho||"-")}`;
    return `
      <tr>
        <td><span class="tlBadge">${time}</span></td>
        <td><b>${trans}</b></td>
        <td>${reason}</td>
        <td>${base}</td>
        <td>${lb}</td>
      </tr>`;
  }).join("");
};

/* ================== ãƒã‚¹ã‚¿ç™»éŒ²ã‚¤ãƒ™ãƒ³ãƒˆ ================== */
function showMasterPreview(url){
  if(url){
    $masterPreviewImage.src=url;
    $masterPreviewImage.style.display="block";
    $masterPreviewHint.style.display="none";
  }
}
function showMasterPreviewHint(text){
  $masterPreviewImage.style.display="none";
  $masterPreviewHint.style.display="block";
  $masterPreviewHint.innerHTML = text || "";
}
function setMasterUIBusy(busy){
  $masterUploadBtn.disabled = busy;
  $masterFetchBtn.disabled = busy;
  $masterClearBtn.disabled = busy;
}
$masterImageFile.addEventListener("change", ()=>{
  const f = $masterImageFile.files && $masterImageFile.files[0];
  $masterFileName.textContent = f ? f.name : "æœªé¸æŠ";
  $masterUploadState.textContent = "æœªç™»éŒ²";
});
$masterClearBtn.addEventListener("click", ()=>{
  $masterSeiriNo.value="";
  $masterImageFile.value="";
  $masterFileName.textContent="æœªé¸æŠ";
  $masterUploadState.textContent="æœªç™»éŒ²";
  showMasterPreviewHint("ã“ã“ã«æ¤œç´¢çµæœï¼ˆç”»åƒï¼‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚");
});
$masterUploadBtn.addEventListener("click", async ()=>{
  const seiriNo = normalizeSeiriNo($masterSeiriNo.value);
  const file = $masterImageFile.files && $masterImageFile.files[0];
  if(!seiriNo){ alert("æ•´ç†Noã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
  if(!file){ alert("ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
  if(!__saveMaster){ alert("Firebaseæœªæ¥ç¶šã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"); return; }

  setMasterUIBusy(true);
  $masterUploadState.textContent="ç™»éŒ²ä¸­...";
  try{
    const res = await __saveMaster(seiriNo, file);
    $masterUploadState.textContent="ç™»éŒ²å®Œäº†";
    showMasterPreview(res.downloadUrl);
  }catch(e){
    console.warn(e);
    $masterUploadState.textContent="ç™»éŒ²å¤±æ•—";
    alert("ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç¢ºèªï¼‰");
  }finally{
    setMasterUIBusy(false);
  }
});
$masterFetchBtn.addEventListener("click", async ()=>{
  const seiriNo = normalizeSeiriNo($masterSeiriNo.value);
  if(!seiriNo){ alert("æ•´ç†Noã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
  if(!__getMasterBySeiriNo){ alert("Firebaseæœªæ¥ç¶šã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"); return; }

  setMasterUIBusy(true);
  $masterUploadState.textContent="æ¤œç´¢ä¸­...";
  try{
    const master = await __getMasterBySeiriNo(seiriNo);
    if(master && master.downloadUrl){
      $masterUploadState.textContent="ãƒ’ãƒƒãƒˆ";
      showMasterPreview(master.downloadUrl);
    }else{
      $masterUploadState.textContent="æœªç™»éŒ²";
      showMasterPreviewHint(`ç”»åƒãƒã‚¹ã‚¿æœªç™»éŒ²ï¼š<b>${esc(seiriNo)}</b><br>ã€Œç™»éŒ²ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰ã€ã§ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚`);
    }
  }finally{
    setMasterUIBusy(false);
  }
});

/* ================== èµ·å‹•æ™‚å¾©å…ƒï¼ˆFirebaseâ†’ç”»é¢çŠ¶æ…‹ã¸åæ˜ ï¼‰ ================== */
let __restoring = false;

async function applyRestoredState(state){
  // state: lineStatus/{line}
  // ä¾‹) { state:"RUNNING", stateText:"ç”Ÿç”£ä¸­", product:"ABCDE", lockState:"LOCKED", busho:"1G", ... }
  const restoredProdText = state && state.stateText ? String(state.stateText) : null;
  const restoredBase = state && state.product ? String(state.product) : null;
  const restoredLock = state && state.lockState ? String(state.lockState) : "UNLOCK";

  // 0) counters (å¾©å…ƒ)
  goodCount = (state && typeof state.goodCount === "number") ? state.goodCount : 0;
  qtyPerKanban = (state && (typeof state.qtyPerKanban === "number")) ? state.qtyPerKanban : null;
  updateCountersUI();

  // 1) baseQR
  baseQR = restoredBase || null;
  updateBaseDisplay(baseQR);

  // 2) prodStatusï¼ˆãƒ­ã‚°ã¯æ®‹ã•ãšé™ã‹ã«åæ˜ ï¼‰
  if(restoredProdText && Object.values(PROD_STATUS).includes(restoredProdText)){
    prodStatus = restoredProdText;
  }else{
    // base ãŒã‚ã‚‹ã®ã« stateText ãŒç„¡ã„å ´åˆã¯ã€Œç”Ÿç”£ä¸­ã€ã«å¯„ã›ã‚‹ï¼ˆç¾å ´é‹ç”¨çš„ã«è‡ªç„¶ï¼‰
    prodStatus = baseQR ? PROD_STATUS.RUNNING : PROD_STATUS.NOT_STARTED;
  }
  renderProdStatus();

  // 3) ãƒ­ãƒƒã‚¯çŠ¶æ…‹
  setLock(restoredLock === "LOCKED");

  // 4) modeè¡¨ç¤º
  if(baseQR){
    if(isLocked){
      $mode.textContent = "NGï¼ç®¡ç†è€…QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„";
      showNGPersistent();
    }else{
      $mode.textContent = `ç…§åˆãƒ¢ãƒ¼ãƒ‰ï¼ˆåŸºæº–/æ•´ç†No: ${baseQR}ï¼‰`;
      clearMarks();
    }
  }else{
    $mode.textContent = "åŸºæº–QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„";
    clearMarks();
  }

  // 5) ç”»åƒè¡¨ç¤ºï¼ˆbaseQRãŒã‚ã‚‹ã¨ãã ã‘ï¼‰
  if(baseQR){
    try{
      if(__getMasterBySeiriNo){
        const master = await __getMasterBySeiriNo(baseQR);
        if(master && master.downloadUrl){
          showImage(master.downloadUrl);
          setMasterBadge(true);
        }else{
          setMasterBadge(false);
          showNoImage(`ç”»åƒãƒã‚¹ã‚¿æœªç™»éŒ²ï¼š<b>${esc(baseQR)}</b><br>ã€Œç”»åƒãƒã‚¹ã‚¿ç™»éŒ²ã€ã‚¿ãƒ–ã§ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚`);
        }
      }else{
        setMasterBadge(false);
        showNoImage("Firebaseæœªæ¥ç¶šã®ãŸã‚ç”»åƒãƒã‚¹ã‚¿æ¤œç´¢ãŒã§ãã¾ã›ã‚“ã€‚");
      }
    }catch(e){
      console.warn(e);
      setMasterBadge(false);
      showNoImage("ç”»åƒãƒã‚¹ã‚¿æ¤œç´¢ã‚¨ãƒ©ãƒ¼ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç¢ºèªï¼‰");
    }
  }else{
    setMasterBadge(false);
    $productImage.style.display="none";
    $imgHint.style.display="block";
    $imgHint.textContent="åŸºæº–QRã‚’èª­ã¿è¾¼ã‚€ã¨ã€æ•´ç†Noã§ç”»åƒãƒã‚¹ã‚¿ã‚’æ¤œç´¢ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚";
  }
}

async function restoreFromFirebase(){
  if(__restoring) return;
  if(!lineName) return;                 // ãƒ©ã‚¤ãƒ³æœªè¨­å®šãªã‚‰å¾…ã¤
  if(typeof __loadLineStatus !== "function") return; // Firebaseæœªæº–å‚™ãªã‚‰å¾…ã¤

  __restoring = true;
  try{
    const st = await __loadLineStatus(lineName);
    if(st){
      await applyRestoredState(st);
    }else{
      // ã¾ã ä½•ã‚‚ç„¡ã‘ã‚Œã°åˆæœŸè¡¨ç¤ºã®ã¾ã¾
      prodStatus = PROD_STATUS.NOT_STARTED;
      baseQR = null;
      goodCount = 0;
      qtyPerKanban = null;
      updateCountersUI();
      setLock(false);
      renderProdStatus();
      updateBaseDisplay(null);
      $mode.textContent = "åŸºæº–QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„";
      clearMarks();
    }
  }catch(e){
    console.warn("restoreFromFirebase failed:", e);
  }finally{
    __restoring = false;
  }
}
// moduleå´ã‹ã‚‰å‘¼ã¹ã‚‹ã‚ˆã†ã«å…¬é–‹
window.__restoreFromFirebase = restoreFromFirebase;

/* ================== åˆæœŸï¼šãƒ©ã‚¤ãƒ³/éƒ¨ç½² ================== */
window.addEventListener("load", ()=>{
  if (lineName) Array.from($lineSelect.options).forEach(o=>{ if(o.value===lineName) o.selected=true; });
  if (bushoName) Array.from($bushoSelect.options).forEach(o=>{ if(o.value===bushoName) o.selected=true; });
  $lineBadge.textContent = lineName || "æœªè¨­å®š";
  $bushoBadge.textContent = bushoName || "æœªè¨­å®š";
  renderProdStatus();
  // â€» Firebaseæº–å‚™å¾Œã« module å´ã‹ã‚‰ __restoreFromFirebase() ã‚’å‘¼ã¶
});
$lineSelect.addEventListener("change", ()=>{
  lineName = $lineSelect.value;
  localStorage.setItem(LINE_KEY, lineName);
  $lineBadge.textContent = lineName || "æœªè¨­å®š";
  // â˜… ãƒ©ã‚¤ãƒ³ã‚’é¸ã‚“ã ç¬é–“ã«å¾©å…ƒ
  restoreFromFirebase();
});
$bushoSelect.addEventListener("change", ()=>{
  bushoName = $bushoSelect.value;
  localStorage.setItem(BUSHO_KEY, bushoName);
  $bushoBadge.textContent = bushoName || "æœªè¨­å®š";
});

/* ================== ã‚¹ã‚­ãƒ£ãƒŠå…¥åŠ›ï¼ˆdocumentã§å—ã‘ã‚‹ï¼‰ ================== */
let buffer = "";
let idleTimer = null;
const IDLE_MS = 120;

function flushBuffer(){
  if(!buffer) return;
  const qr = buffer.replace(/\r/g,"").split("\n").map(s=>s.trim()).filter(Boolean).slice(-1)[0] || "";
  buffer = "";
  if(qr) processQR(qr);
}
document.addEventListener("keydown", (e)=>{
  e.preventDefault();
  const k = e.key;
  if(k==="Enter" || k==="Tab"){ flushBuffer(); return; }
  if(k.length===1){
    buffer += k;
    if(idleTimer) clearTimeout(idleTimer);
    idleTimer = setTimeout(()=>flushBuffer(), IDLE_MS);
  }else if(k==="Backspace"){
    buffer = buffer.slice(0,-1);
  }
},{ passive:false });

/* ================== ç…§åˆãƒ•ãƒ­ãƒ¼ ================== */
async function processQR(qrRaw){
  const now = nowString();
  const sliced = cutQR(qrRaw);
  // â˜… QRãŒèª­ã¾ã‚ŒãŸã‚‰ã€Œç”Ÿç”£ä¸­ã€ã¸æˆ»ã™ï¼ˆãŸã ã—NGãƒ­ãƒƒã‚¯ä¸­ã¯æˆ»ã•ãªã„ï¼‰
  if (baseQR && !isLocked && prodStatus !== PROD_STATUS.RUNNING) {
    setProdStatus(PROD_STATUS.RUNNING, "FORCE_RUNNING_BY_SCAN");
  }

  // 1) åŸºæº–ã‚»ãƒƒãƒˆï¼ˆåˆ‡ã‚Šå‡ºã—å€¤ï¼æ•´ç†Noï¼‰
  if(!baseQR){
    baseQR = sliced;
    updateBaseDisplay(baseQR);


    // â˜… 1æšã‚ãŸã‚Šå€‹æ•°ï¼ˆqrMaster.quantityï¼‰ã‚’å–å¾— â†’ å‡ºæ¥é«˜ã‚«ã‚¦ãƒ³ã‚¿ã«ä½¿ç”¨
    try{
      if(__getQtyBySeiriNo){
        const q = await __getQtyBySeiriNo(baseQR);
        qtyPerKanban = (typeof q === 'number' && isFinite(q) && q > 0) ? q : null;
      }else{
        qtyPerKanban = null;
      }
    }catch(e){
      console.warn('LOAD_QTY failed:', e);
      qtyPerKanban = null;
    }
    updateCountersUI();
    persistLineStatus('BASE_QR_SET');

    // â˜… åŸºæº–QRèª­è¾¼å¾Œ â†’ ç”Ÿç”£ä¸­
    setProdStatus(PROD_STATUS.RUNNING, "BASE_QR_SET");

    $mode.textContent = `ç…§åˆãƒ¢ãƒ¼ãƒ‰ï¼ˆåŸºæº–/æ•´ç†No: ${baseQR}ï¼‰`;

    // æ•´ç†Noâ†’ãƒã‚¹ã‚¿æ¤œç´¢â†’Storageç”»åƒè¡¨ç¤º
    let imageInfo = "";
    try{
      if(__getMasterBySeiriNo){
        const master = await __getMasterBySeiriNo(baseQR);
        if(master && master.downloadUrl){
          showImage(master.downloadUrl);
          setMasterBadge(true);
          imageInfo = `storage:${master.imagePath}`;
        }else{
          setMasterBadge(false);
          showNoImage(`ç”»åƒãƒã‚¹ã‚¿æœªç™»éŒ²ï¼š<b>${esc(baseQR)}</b><br>ã€Œç”»åƒãƒã‚¹ã‚¿ç™»éŒ²ã€ã‚¿ãƒ–ã§ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚`);
        }
      }else{
        setMasterBadge(false);
        showNoImage("Firebaseæœªæ¥ç¶šã®ãŸã‚ç”»åƒãƒã‚¹ã‚¿æ¤œç´¢ãŒã§ãã¾ã›ã‚“ã€‚");
      }
    }catch(e){
      console.warn(e);
      setMasterBadge(false);
      showNoImage("ç”»åƒãƒã‚¹ã‚¿æ¤œç´¢ã‚¨ãƒ©ãƒ¼ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç¢ºèªï¼‰");
    }

    logRow([now, qrRaw, sliced, "SET_BASE", isLocked?"LOCKED":"UNLOCK", imageInfo, lineName, bushoName, prodStatus], {good:0});
    return;
  }

  // 2) ãƒ­ãƒƒã‚¯ä¸­
  if(isLocked){
    if(qrRaw===ADMIN_QR){
      setLock(false); showOK();
      $mode.textContent="è§£é™¤ã•ã‚Œã¾ã—ãŸã€‚ç…§åˆã‚’å†é–‹ã—ã¾ã™ã€‚";
      logRow([now, qrRaw, sliced, "UNLOCK_BY_ADMIN", "UNLOCK", "", lineName, bushoName, prodStatus], {good:0});

      // â˜… ãƒ­ãƒƒã‚¯è§£é™¤ã‚’ lineStatus ã«åæ˜ ï¼ˆåŒã˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ã‚‚ lockState ã¯æ›´æ–°ã•ã‚Œã‚‹ï¼‰
      if(lineName && typeof window.__writeLineStatus === "function"){
        window.__writeLineStatus(lineName, {
          state: statusKeyFromText(prodStatus),
          stateText: prodStatus,
          reason: "UNLOCK_BY_ADMIN",
          product: baseQR || null,
          updatedAt: new Date().toISOString(),
          busho: bushoName || null,
          lockState: "UNLOCK"
        }).catch(()=>{});
      }
    }else{
      showNGPersistent();
      logRow([now, qrRaw, sliced, "LOCK_REJECT", "LOCKED", "", lineName, bushoName, prodStatus], {good:0});
    }
    return;
  }
  // 3) åˆ¤å®š
  const judgedOK = (sliced===baseQR);
  let deltaGood = 0;
  if(judgedOK){
    showOK();
    // â˜… å‡ºæ¥é«˜ï¼ˆå€‹æ•°ï¼‰ã‚«ã‚¦ãƒ³ãƒˆï¼šqrMaster.quantity ã‚’åŠ ç®—
    const q = (qtyPerKanban==null? 0 : qtyPerKanban);
    deltaGood = (typeof q === "number" && isFinite(q) && q > 0) ? q : 0;
    goodCount += deltaGood;
    
    updateCountersUI();
    persistLineStatus("SCAN_OK");
    addHourly(Date.now(), deltaGood);
renderMiniHourlyChart();
    logRow([now, qrRaw, sliced, "OK", "UNLOCK", "", lineName, bushoName, prodStatus], {good:deltaGood});
  }else{
    showNGPersistent();
    setLock(true);
    $mode.textContent="NGï¼ç®¡ç†è€…QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„";
    updateCountersUI();
    persistLineStatus("SCAN_NG");
    logRow([now, qrRaw, sliced, "NG", "LOCKED", "", lineName, bushoName, prodStatus], {good:0});

    // â˜… NGãƒ­ãƒƒã‚¯ã‚’ lineStatus ã«åæ˜ ï¼ˆåŒã˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ã‚‚ lockState ã¯æ›´æ–°ã•ã‚Œã‚‹ï¼‰
    if(lineName && typeof window.__writeLineStatus === "function"){
      window.__writeLineStatus(lineName, {
        state: statusKeyFromText(prodStatus),
        stateText: prodStatus,
        reason: "NG_LOCK",
        product: baseQR || null,
        updatedAt: new Date().toISOString(),
        busho: bushoName || null,
        lockState: "LOCKED"
      }).catch(()=>{});
    }
  }
}

/* ================== ãƒœã‚¿ãƒ³ ================== */
document.getElementById("resetBtn").addEventListener("click", ()=>{
  if(isLocked){
    $mode.textContent="NGãƒ­ãƒƒã‚¯ä¸­ã¯åˆ‡æ›¿ã§ãã¾ã›ã‚“ã€‚ç®¡ç†è€…QRã§è§£é™¤ã—ã¦ãã ã•ã„ã€‚";
    logRow([nowString(), "-", "-", "RESET_DENIED_WHEN_LOCKED", "LOCKED", "", lineName, bushoName, prodStatus]);
    return;
  }

  // â˜… è£½å“åˆ‡ã‚Šæ›¿ãˆ â†’ æ®µæ›¿ãˆä¸­
  setProdStatus(PROD_STATUS.SETUP_CHANGE, "RESET_BTN");

  baseQR=null;
  // â˜… ã‚«ã‚¦ãƒ³ã‚¿ã‚‚ãƒªã‚»ãƒƒãƒˆï¼ˆè£½å“åˆ‡æ›¿ãˆï¼‰
  goodCount = 0;
  qtyPerKanban = null;
  updateCountersUI();
  persistLineStatus("RESET");
  setLock(false);
  clearMarks();
  updateBaseDisplay(null);
  setMasterBadge(false);
  $productImage.style.display="none";
  $imgHint.style.display="block";
  $imgHint.textContent="åŸºæº–QRã‚’èª­ã¿è¾¼ã‚€ã¨ã€æ•´ç†Noã§ç”»åƒãƒã‚¹ã‚¿ã‚’æ¤œç´¢ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚";
  $mode.textContent="åŸºæº–QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„";
  logRow([nowString(), "-", "-", "RESET", "UNLOCK", "", lineName, bushoName, prodStatus]);
});

// ===== ç›´å‰ãƒ­ã‚°å‰Šé™¤ï¼ˆèª­ã¿ãƒŸã‚¹ä¿®æ­£ï¼‰ =====
$deleteLastBtn && $deleteLastBtn.addEventListener("click", async ()=>{
  if(logData.length <= 1){ alert("å‰Šé™¤ã§ãã‚‹ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }
  const last = logData[logData.length-1];
  const judge = last && last[3] ? String(last[3]) : "";
  const ok = confirm(`ç›´å‰ã®ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ

${last.join(' / ')}`);
  if(!ok) return;

  const idx = logData.length - 1;
  const docId = qrLogDocIds[idx];
  const delta = counterDeltas[idx] || {good:0};

  // ç”»é¢å´ï¼ˆCSVç”¨ï¼‰ã‹ã‚‰å‰Šé™¤
  logData.pop();
  qrLogDocIds.pop();
  counterDeltas.pop();

  // Firestore(qrLogs) å´ã‚‚å‰Šé™¤ï¼ˆdocIdãŒå–ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
  if(docId && typeof window.__deleteQrLogDoc === "function"){
    try{ await window.__deleteQrLogDoc(docId); }
    catch(e){ console.warn("delete qrLogs failed:", e); }
  }

  // â˜… ã‚«ã‚¦ãƒ³ã‚¿å·»ãæˆ»ã—ï¼ˆèª¤èª­ä¿®æ­£ï¼‰
  goodCount   = Math.max(0, (goodCount||0)   - (delta.good||0));
  updateCountersUI();
  persistLineStatus("DELETE_LAST");

  alert("ç›´å‰ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆã‚«ã‚¦ãƒ³ã‚¿ã‚‚å·»ãæˆ»ã—ã¾ã—ãŸï¼‰ã€‚\nFirestoreå´ã¯ docId å–å¾—ã§ããŸå ´åˆã®ã¿å‰Šé™¤ã—ã¾ã™ã€‚");
});

document.getElementById("saveBtn").addEventListener("click", ()=>downloadCSV(logData));
document.getElementById("exitBtn").addEventListener("click", ()=>{ downloadCSV(logData,"qr_log"); window.close(); });

/* ================== ç”»åƒãƒã‚¹ã‚¿ä¸€è¦§æ©Ÿèƒ½ ================== */
// æ›´æ–°ãƒœã‚¿ãƒ³
$masterRefreshBtn.addEventListener("click", ()=>loadImageMasterList());

// ç”»åƒãƒã‚¹ã‚¿ä¸€è¦§èª­ã¿è¾¼ã¿
async function loadImageMasterList(){
  $masterListHint.style.display = "block";
  $masterListHint.textContent = "èª­ã¿è¾¼ã¿ä¸­...";
  $masterListGrid.style.display = "none";
  
  try{
    const list = await window.__listImageMaster();
    
    if(!list || list.length === 0){
      $masterListHint.textContent = "ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ç”»åƒãƒã‚¹ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
      return;
    }
    
    $masterListHint.style.display = "none";
    $masterListGrid.style.display = "block";
    
    $masterListContainer.innerHTML = "";
    
    list.forEach(item=>{
      const card = document.createElement("div");
      card.style.cssText = "border:1px solid #e5e7eb; border-radius:10px; padding:10px; background:#fff; cursor:pointer; transition:all 0.2s;";
      card.addEventListener("mouseenter", ()=>{ card.style.boxShadow = "0 4px 12px rgba(0,0,0,0.1)"; card.style.borderColor = "#0b3b75"; });
      card.addEventListener("mouseleave", ()=>{ card.style.boxShadow = "none"; card.style.borderColor = "#e5e7eb"; });
      
      // ç”»åƒéƒ¨åˆ†
      const imgContainer = document.createElement("div");
      imgContainer.style.cssText = "width:100%; height:150px; background:#f8fafc; border-radius:8px; overflow:hidden; display:flex; align-items:center; justify-content:center; margin-bottom:8px;";
      
      if(item.downloadUrl){
        const img = document.createElement("img");
        img.src = item.downloadUrl;
        img.alt = item.seiriNo;
        img.style.cssText = "max-width:100%; max-height:100%; object-fit:contain;";
        imgContainer.appendChild(img);
      }else{
        const placeholder = document.createElement("div");
        placeholder.textContent = "ç”»åƒãªã—";
        placeholder.style.cssText = "color:#9ca3af; font-size:13px;";
        imgContainer.appendChild(placeholder);
      }
      
      // æ•´ç†No
      const seiriNoLabel = document.createElement("div");
      seiriNoLabel.textContent = item.seiriNo;
      seiriNoLabel.style.cssText = "font-size:14px; font-weight:900; text-align:center; margin-bottom:4px; word-break:break-all;";
      
      // ãƒ•ã‚¡ã‚¤ãƒ«å
      const fileNameLabel = document.createElement("div");
      fileNameLabel.textContent = item.originalFileName || "ãƒ•ã‚¡ã‚¤ãƒ«åä¸æ˜";
      fileNameLabel.style.cssText = "font-size:11px; color:#64748b; text-align:center; word-break:break-all;";
      
      // ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†
      card.addEventListener("click", ()=>{
        $masterSeiriNo.value = item.seiriNo;
        if(item.downloadUrl){
          $masterPreviewImage.src = item.downloadUrl;
          $masterPreviewImage.style.display = "block";
          $masterPreviewHint.style.display = "none";
        }
        window.scrollTo({top:0, behavior:"smooth"});
      });
      
      card.appendChild(imgContainer);
      card.appendChild(seiriNoLabel);
      card.appendChild(fileNameLabel);
      $masterListContainer.appendChild(card);
    });
  }catch(e){
    console.error(e);
    $masterListHint.textContent = `ã‚¨ãƒ©ãƒ¼: ${e.message}`;
  }
}

/* ================== å€‹æ•°ãƒã‚¹ã‚¿æ©Ÿèƒ½ ================== */
// å€‹æ•°ãƒã‚¹ã‚¿ä¿å­˜
$qtyMasterSaveBtn.addEventListener("click", async ()=>{
  const seiriNo = $qtyMasterSeiriNo.value.trim();
  const quantity = parseInt($qtyMasterQuantity.value, 10);
  
  if(!seiriNo){ alert("æ•´ç†Noï¼ˆå“ç•ªï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
  if(!quantity || quantity < 1){ alert("å€‹æ•°ã¯1ä»¥ä¸Šã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
  
  if(!confirm(`å“ç•ªã€Œ${seiriNo}ã€ã«QR1å›ã‚ãŸã‚Šã€Œ${quantity}å€‹ã€ã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  
  try{
    await window.__saveQtyMaster(seiriNo, quantity);
    alert(`ç™»éŒ²å®Œäº†ï¼š${seiriNo} â†’ ${quantity}å€‹`);
    loadQtyMasterList();
  }catch(e){
    console.error(e);
    alert(`ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ${e.message}`);
  }
});

// å€‹æ•°ãƒã‚¹ã‚¿æ¤œç´¢
$qtyMasterFetchBtn.addEventListener("click", async ()=>{
  const seiriNo = $qtyMasterSeiriNo.value.trim();
  if(!seiriNo){ alert("æ•´ç†Noï¼ˆå“ç•ªï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
  
  try{
    const qty = await window.__getQtyBySeiriNo(seiriNo);
    if(qty !== null){
      $qtyMasterQuantity.value = qty;
      alert(`å“ç•ªã€Œ${seiriNo}ã€ã¯ ${qty}å€‹/QR ã§ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚`);
    }else{
      $qtyMasterQuantity.value = 1;
      alert(`å“ç•ªã€Œ${seiriNo}ã€ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1å€‹/QRï¼‰`);
    }
  }catch(e){
    console.error(e);
    alert(`æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ${e.message}`);
  }
});

// å€‹æ•°ãƒã‚¹ã‚¿å‰Šé™¤
$qtyMasterDeleteBtn.addEventListener("click", async ()=>{
  const seiriNo = $qtyMasterSeiriNo.value.trim();
  if(!seiriNo){ alert("æ•´ç†Noï¼ˆå“ç•ªï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
  
  if(!confirm(`å“ç•ªã€Œ${seiriNo}ã€ã®å€‹æ•°è¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå‰Šé™¤å¾Œã¯è‡ªå‹•çš„ã«1å€‹/QRã«ãªã‚Šã¾ã™ï¼‰`)) return;
  
  try{
    await window.__deleteQtyMaster(seiriNo);
    alert(`å‰Šé™¤å®Œäº†ï¼š${seiriNo}`);
    $qtyMasterSeiriNo.value = "";
    $qtyMasterQuantity.value = 1;
    loadQtyMasterList();
  }catch(e){
    console.error(e);
    alert(`å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${e.message}`);
  }
});

// å…¥åŠ›ã‚¯ãƒªã‚¢
$qtyMasterClearBtn.addEventListener("click", ()=>{
  $qtyMasterSeiriNo.value = "";
  $qtyMasterQuantity.value = 1;
});

// ä¸€è¦§æ›´æ–°
$qtyMasterRefreshBtn.addEventListener("click", ()=>loadQtyMasterList());

// å€‹æ•°ãƒã‚¹ã‚¿ä¸€è¦§èª­ã¿è¾¼ã¿
async function loadQtyMasterList(){
  $qtyMasterListHint.style.display = "block";
  $qtyMasterListHint.textContent = "èª­ã¿è¾¼ã¿ä¸­...";
  $qtyMasterListTable.style.display = "none";
  
  try{
    const list = await window.__listQtyMaster();
    
    if(!list || list.length === 0){
      $qtyMasterListHint.textContent = "ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å€‹æ•°ãƒã‚¹ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
      return;
    }
    
    $qtyMasterListHint.style.display = "none";
    $qtyMasterListTable.style.display = "block";
    
    $qtyMasterListBody.innerHTML = "";
    list.forEach(item=>{
      const tr = document.createElement("tr");
      tr.style.borderBottom = "1px solid #e5e7eb";
      
      const tdSeiriNo = document.createElement("td");
      tdSeiriNo.style.padding = "8px";
      tdSeiriNo.style.fontSize = "14px";
      tdSeiriNo.textContent = item.seiriNo;
      
      const tdQty = document.createElement("td");
      tdQty.style.padding = "8px";
      tdQty.style.textAlign = "center";
      tdQty.style.fontSize = "16px";
      tdQty.style.fontWeight = "900";
      tdQty.textContent = item.quantity;
      
      const tdAction = document.createElement("td");
      tdAction.style.padding = "8px";
      tdAction.style.textAlign = "center";
      
      const editBtn = document.createElement("button");
      editBtn.textContent = "ç·¨é›†";
      editBtn.className = "btn";
      editBtn.style.padding = "4px 10px";
      editBtn.style.fontSize = "12px";
      editBtn.addEventListener("click", ()=>{
        $qtyMasterSeiriNo.value = item.seiriNo;
        $qtyMasterQuantity.value = item.quantity;
        window.scrollTo({top:0, behavior:"smooth"});
      });
      
      tdAction.appendChild(editBtn);
      
      tr.appendChild(tdSeiriNo);
      tr.appendChild(tdQty);
      tr.appendChild(tdAction);
      $qtyMasterListBody.appendChild(tr);
    });
  }catch(e){
    console.error(e);
    $qtyMasterListHint.textContent = `ã‚¨ãƒ©ãƒ¼: ${e.message}`;
  }
}

</script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, getDocs, setDoc, collection, addDoc, serverTimestamp, deleteDoc,
    query, where, orderBy, limit, onSnapshot
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAOMRoojKv9Hnh3OjVGwYV_k1LBTGOKepY",
    authDomain: "miyamaunitec-fb87a.firebaseapp.com",
    databaseURL: "https://miyamaunitec-fb87a-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "miyamaunitec-fb87a",
    storageBucket: "miyamaunitec-fb87a.firebasestorage.app",
    messagingSenderId: "495316649507",
    appId: "1:495316649507:web:1f98ee3dd851474fa39396",
    measurementId: "G-1NXD8ZPGNR"
  };

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch(e){}

  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const QR_MASTER_COLLECTION = "qrMaster"; // {seiriNo}.quantity ã‚’å‚ç…§

  const statusEl = document.getElementById("firebaseStatus");
  const storageEl = document.getElementById("storageStatus");
  const setStatus = (t,c)=>{ statusEl.textContent=`Firebase: ${t}`; statusEl.style.color=c; };
  const setStorage = (t,c)=>{ storageEl.textContent=`Storage: ${t}`; storageEl.style.color=c; };

  try{
    await signInAnonymously(auth);
    setStatus("æ¥ç¶šæ¸ˆã¿","#16a34a");
    setStorage("æº–å‚™OK","#16a34a");
  }catch(e){
    console.warn("åŒ¿åèªè¨¼å¤±æ•—:", e);
    setStatus("æœªæ¥ç¶šï¼ˆèªè¨¼ã‚¨ãƒ©ãƒ¼ï¼‰","#dc2626");
    setStorage("æœªæº–å‚™ï¼ˆèªè¨¼ã‚¨ãƒ©ãƒ¼ï¼‰","#dc2626");
  }

  // â˜… 1å›ã‚ãŸã‚Šå€‹æ•°ï¼ˆqrMaster/{seiriNo}.quantityï¼‰ã‚’å–å¾—
  //    quantityç™»éŒ²ã‚¢ãƒ—ãƒªï¼ˆdashboard_integratedï¼‰ã«åˆã‚ã›ã¦ã€docId=åˆ‡ã‚Šå‡ºã—å€¤ã€field=quantity ã‚’å‚ç…§ã™ã‚‹
  window.__getQtyBySeiriNo = async (seiriNo) => {
    const key = String(seiriNo||"").trim();
    if(!key) return null;
    try{
      const snap = await getDoc(doc(db, QR_MASTER_COLLECTION, key));
      if(!snap.exists()) return null;
      const data = snap.data() || {};
      const q = Number(data.quantity);
      return (isFinite(q) && q > 0) ? q : 1;
    }catch(e){
      console.warn("getQty error:", e);
      return null;
    }
  };

  // â˜… qrLogs ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‰Šé™¤ï¼ˆç›´å‰ãƒ­ã‚°å‰Šé™¤ç”¨ï¼‰
  window.__deleteQrLogDoc = async (docId) => {
    const id = String(docId||"").trim();
    if(!id) return;
    await deleteDoc(doc(db, "qrLogs", id));
  };

  // â˜… å€‹æ•°ãƒã‚¹ã‚¿ä¿å­˜ï¼šqrMaster/{seiriNo} ã« quantity ã‚’ä¿å­˜
  window.__saveQtyMaster = async (seiriNo, quantity) => {
    const key = String(seiriNo||"").trim();
    if(!key) throw new Error("seiriNo required");
    const qty = parseInt(quantity, 10);
    if(!qty || qty < 1) throw new Error("quantity must be >= 1");
    
    await setDoc(doc(db, QR_MASTER_COLLECTION, key), {
      seiriNo: key,
      quantity: qty,
      updatedAt: serverTimestamp(),
      updatedByUid: (auth.currentUser && auth.currentUser.uid) || null
    }, { merge: true });
  };

  // â˜… å€‹æ•°ãƒã‚¹ã‚¿å‰Šé™¤ï¼šqrMaster/{seiriNo} ã‚’å‰Šé™¤
  window.__deleteQtyMaster = async (seiriNo) => {
    const key = String(seiriNo||"").trim();
    if(!key) throw new Error("seiriNo required");
    await deleteDoc(doc(db, QR_MASTER_COLLECTION, key));
  };

  // â˜… å€‹æ•°ãƒã‚¹ã‚¿ä¸€è¦§å–å¾—ï¼šqrMaster ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å…¨ä»¶å–å¾—
  window.__listQtyMaster = async () => {
    try{
      const colRef = collection(db, QR_MASTER_COLLECTION);
      const querySnap = await getDocs(colRef);
      
      const list = [];
      querySnap.forEach(docSnap=>{
        const data = docSnap.data() || {};
        if(data.quantity){
          list.push({
            seiriNo: docSnap.id,
            quantity: data.quantity
          });
        }
      });
      
      // æ•´ç†Noé †ã«ã‚½ãƒ¼ãƒˆ
      list.sort((a,b)=>a.seiriNo.localeCompare(b.seiriNo));
      return list;
    }catch(e){
      console.warn("listQtyMaster error:", e);
      return [];
    }
  };

  // ç”»åƒãƒã‚¹ã‚¿å–å¾—ï¼šimageMasters/{seiriNo}
  window.__getMasterBySeiriNo = async (seiriNo) => {
    const key = String(seiriNo||"").trim();
    if(!key) return null;

    const snap = await getDoc(doc(db, MASTER_COLLECTION, key));
    if(!snap.exists()) return null;

    const data = snap.data() || {};
    if(!data.imagePath) return null;

    try{
      const downloadUrl = await getDownloadURL(ref(storage, data.imagePath));
      return { ...data, downloadUrl };
    }catch(e){
      console.warn("getDownloadURL failed:", e);
      return { ...data, downloadUrl: null };
    }
  };

  // ç”»åƒãƒã‚¹ã‚¿ä¿å­˜ï¼šStorageã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰â†’imageMasters/{seiriNo} ä¸Šæ›¸ã
  window.__saveMaster = async (seiriNo, file) => {
    const key = String(seiriNo||"").trim();
    if(!key) throw new Error("seiriNo required");
    if(!file) throw new Error("file required");

    const origName = String(file.name || "image");
    const extMatch = origName.toLowerCase().match(/\.([a-z0-9]+)$/);
    const ext = extMatch ? extMatch[1] : "jpg";

    const imagePath = `${STORAGE_DIR}/${key}.${ext}`;
    const storageRef = ref(storage, imagePath);

    await uploadBytes(storageRef, file, { contentType: file.type || "application/octet-stream" });
    const downloadUrl = await getDownloadURL(storageRef);

    const payload = {
      seiriNo: key,
      imagePath,
      originalFileName: origName,
      contentType: file.type || null,
      updatedAt: serverTimestamp(),
      updatedByUid: (auth.currentUser && auth.currentUser.uid) || null
    };
    await setDoc(doc(db, MASTER_COLLECTION, key), payload, { merge:true });

    return { imagePath, downloadUrl };
  };

  // â˜… ç”»åƒãƒã‚¹ã‚¿ä¸€è¦§å–å¾—ï¼šimageMasters ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å…¨ä»¶å–å¾—
  window.__listImageMaster = async () => {
    try{
      const colRef = collection(db, MASTER_COLLECTION);
      const querySnap = await getDocs(colRef);
      
      const list = [];
      for(const docSnap of querySnap.docs){
        const data = docSnap.data() || {};
        let downloadUrl = null;
        
        // ç”»åƒURLã‚’å–å¾—
        if(data.imagePath){
          try{
            downloadUrl = await getDownloadURL(ref(storage, data.imagePath));
          }catch(e){
            console.warn(`getDownloadURL failed for ${docSnap.id}:`, e);
          }
        }
        
        list.push({
          seiriNo: docSnap.id,
          imagePath: data.imagePath || null,
          originalFileName: data.originalFileName || null,
          downloadUrl: downloadUrl
        });
      }
      
      // æ•´ç†Noé †ã«ã‚½ãƒ¼ãƒˆ
      list.sort((a,b)=>a.seiriNo.localeCompare(b.seiriNo));
      return list;
    }catch(e){
      console.warn("listImageMaster error:", e);
      return [];
    }
  };

  // â˜… èµ·å‹•æ™‚å¾©å…ƒç”¨ï¼šlineStatus/{line} ã‚’èª­ã‚€
  window.__loadLineStatus = async (line) => {
    const key = String(line||"").trim();
    if(!key) return null;
    const snap = await getDoc(doc(db, "lineStatus", key));
    return snap.exists() ? (snap.data() || null) : null;
  };

  // émoduleå´ã¸åæ˜ 
  // eslint-disable-next-line no-undef
  __getMasterBySeiriNo = window.__getMasterBySeiriNo;
  // eslint-disable-next-line no-undef
  __saveMaster = window.__saveMaster;
  // eslint-disable-next-line no-undef
  __loadLineStatus = window.__loadLineStatus;
  // eslint-disable-next-line no-undef
  __getQtyBySeiriNo = window.__getQtyBySeiriNo;

  // qrLogs ä¿å­˜
  // eslint-disable-next-line no-undef
  __firestoreLogRow = async function(row){
    try{
      const [ts, raw, sliced, judge, lockState, imageInfo, line, busho, prodStatus] = row;

      const docRef = await addDoc(collection(db, "qrLogs"), {
        ts, raw, sliced, judge, lockState,
        imageInfo: imageInfo || null,
        line, busho,
        prodStatus: prodStatus || null,
         tsMs: Date.now(), 
        readAt: serverTimestamp(),
        uid: (auth.currentUser && auth.currentUser.uid) || null,
        pageUrl: location.href,
        userAgent: navigator.userAgent,
        // äº’æ›
        qrData: raw,
        readAtText: ts,
        result: judge
      });

      return docRef.id;
    }catch(e){
      console.warn("Firestore write fail(qrLogs):", e);
      setStatus("ã‚¨ãƒ©ãƒ¼ï¼ˆä¿å­˜å¤±æ•—ï¼‰","#dc2626");
      return null;
    }
  };

  // prodStatusLogsï¼ˆæ™‚ç³»åˆ—ï¼‰
  // eslint-disable-next-line no-undef
  __firestoreStatusLog = async function(payload){
    try{
      await addDoc(collection(db, STATUS_LOG_COLLECTION), {
        ...payload,
        createdAt: serverTimestamp(),
        uid: (auth.currentUser && auth.currentUser.uid) || null
      });
    }catch(e){
      console.warn("Firestore write fail(prodStatusLogs):", e);
      setStatus("ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å±¥æ­´ä¿å­˜å¤±æ•—ï¼‰","#dc2626");
    }
  };

  // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰é€£æºï¼šãƒ©ã‚¤ãƒ³åˆ¥ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›¸ãè¾¼ã‚€
  window.__writeLineStatus = async function(line, statusData){
    try{
      const docRef = doc(db, "lineStatus", line);
      await setDoc(docRef, {
        line: line,
        ...statusData,
        timestamp: serverTimestamp()
      }, { merge: true });
    }catch(e){
      console.warn("Firestore write fail(lineStatus):", e);
    }
  };

  // ä»Šæ—¥ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»ï¼šãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºï¼ˆæœ€æ–°50ä»¶ï¼‰
  function startTodayTimeline(){
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0);
    const end = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 0,0,0,0);

    const q = query(
      collection(db, STATUS_LOG_COLLECTION),
      where("tsMs", ">=", start.getTime()),
      where("tsMs", "<", end.getTime()),
      orderBy("tsMs", "desc"),
      limit(50)
    );

    return onSnapshot(q, (snap)=>{
      const list = [];
      snap.forEach(d=>{
        const data = d.data() || {};
        list.push(data);
      });
      // eslint-disable-next-line no-undef
      if(typeof window.__updateStatusTimeline === "function"){
        window.__updateStatusTimeline(list);
      }
    }, (err)=>{
      console.warn("timeline snapshot error:", err);
      setStatus("ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼‰","#dc2626");
    });
  }

  try{
    window.__timelineUnsub && window.__timelineUnsub();
    window.__timelineUnsub = startTodayTimeline();
  }catch(e){
    console.warn(e);
  }

  // â˜…â˜…â˜…â˜…â˜… èµ·å‹•æ™‚ï¼šFirebaseæº–å‚™å®Œäº† â†’ å¾©å…ƒå®Ÿè¡Œ â˜…â˜…â˜…â˜…â˜…
  try{
    if(typeof window.__restoreFromFirebase === "function"){
      window.__restoreFromFirebase();
    }
  }catch(e){
    console.warn("auto restore error:", e);
  }
  function startTodayHourlyMini(){
  // lineæœªè¨­å®šãªã‚‰ä½•ã‚‚ã—ãªã„
  if(!lineName) return null;

  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0);
  const end   = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 0,0,0,0);

  const qy = query(
    collection(db, "qrLogs"),
    where("line", "==", lineName),
    where("judge", "==", "OK"),
    where("tsMs", ">=", start.getTime()),
    where("tsMs", "<", end.getTime()),
    orderBy("tsMs", "asc")
  );

  return onSnapshot(qy, (snap)=>{
    const bins = new Array(24).fill(0);
    snap.forEach(d=>{
      const data = d.data() || {};
      const tsMs = Number(data.tsMs || 0);
      const qty  = Number(data.quantity || 0); // ç„¡ã‘ã‚Œã°0
      // ã‚ãªãŸã®ä»•æ§˜ï¼šOKã®å‡ºæ¥é«˜ã¯ quantity åŠ ç®—ãªã®ã§ã€ç„¡ã„å ´åˆã¯ã€Œ1ã€ã§ã¯ãªãã€Œdeltaã€ã‚’ä½¿ã„ãŸã„
      // ã“ã“ã§ã¯ qrLogs ã« quantity ãŒç„¡ã„ã®ã§ã€OKãƒ­ã‚°ã¯ "1æš=qtyPerKanban" ã‚’å¾Œã§æ”¹å–„ã§ãã‚‹
      // ã¾ãšã¯ã€ŒOKä»¶æ•°ã€ã§è‰¯ã‘ã‚Œã° qty=1 ã«ã™ã‚‹
      const add = qty > 0 ? qty : 1;

      if(tsMs){
        const h = new Date(tsMs).getHours();
        bins[h] += add;
      }
    });

    if(typeof window.__setHourlyBins === "function"){
      window.__setHourlyBins(bins);
    }
  }, (err)=>{
    console.warn("mini hourly snapshot error:", err);
  });
}

</script>
</body>
</html>
