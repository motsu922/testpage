<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>QRç…§åˆã‚·ã‚¹ãƒ†ãƒ </title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a !important;
      min-height: 100vh;
      color: #e0e0e0;
    }
    html { background: #0a0a0a !important; }

    /* ã‚¿ãƒ–ãƒŠãƒ“ */
    .tab-nav {
      display: flex;
      background: #1a1a1a;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid #333;
    }
    .tab-btn {
      flex: 1;
      padding: 16px;
      background: transparent;
      border: none;
      color: rgba(255,255,255,0.5);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border-bottom: 3px solid transparent;
    }
    .tab-btn.active {
      color: #4fc3f7;
      background: rgba(79,195,247,0.1);
      border-bottom-color: #4fc3f7;
    }
    .tab-content { display: none; background: #0a0a0a; }
    .tab-content.active { display: block; background: #0a0a0a; }

    .container { padding: 16px; max-width: 520px; margin: 0 auto; background: #0a0a0a; }

    /* FirebaseçŠ¶æ…‹ */
    .firebase-status { padding: 8px 16px; font-size: 12px; text-align: center; }
    .firebase-status.connected { background: #1b3d1b; color: #4caf50; }
    .firebase-status.disconnected { background: #3d2e1b; color: #ff9800; }
    .firebase-status.error { background: #3d1b1b; color: #f44336; }

    /* ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰ */
    .scan-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: calc(100vh - 100px);
      padding: 20px;
      background: #0a0a0a;
    }
    .scan-box {
      width: 100%;
      max-width: 420px;
      background: #1a1a1a;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      text-align: center;
      border: 1px solid #333;
    }
    .scan-step { font-size: 16px; color: #888; margin-bottom: 8px; }
    .scan-message { font-size: 26px; font-weight: 700; color: #4fc3f7; margin-bottom: 24px; }
    .scan-message.step2 { color: #ffb74d; }
    .scan-input-area { position: relative; margin-bottom: 20px; }
    .scan-input {
      width: 100%;
      padding: 20px;
      font-size: 22px;
      text-align: center;
      border: 3px solid #4fc3f7;
      border-radius: 12px;
      outline: none;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      background: #0a0a0a;
      color: #fff;
    }
    .scan-input:focus { border-color: #00c853; box-shadow: 0 0 0 4px rgba(0,200,83,0.3); }
    .scan-input.step2 { border-color: #ffb74d; }
    .scan-input.step2:focus { border-color: #ffb74d; box-shadow: 0 0 0 4px rgba(255,183,77,0.3); }
    .input-hint { font-size: 14px; color: #666; margin-top: 10px; }
    .scanner-icon { font-size: 64px; margin-bottom: 20px; }

    .stop-btn {
      margin-top: 20px;
      padding: 14px 40px;
      background: #d32f2f;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
    }

    /* ãƒ­ã‚° */
    .log-card {
      width: 100%;
      max-width: 420px;
      background: #1a1a1a;
      border-radius: 12px;
      padding: 16px;
      margin-top: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      border: 1px solid #333;
    }
    .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .log-title { font-size: 14px; font-weight: 600; color: #e0e0e0; }
    .log-count { font-size: 11px; color: #888; background: #2a2a2a; padding: 3px 8px; border-radius: 8px; }
    .log-list { max-height: 220px; overflow-y: auto; }
    .log-item { padding: 8px 10px; border-radius: 6px; margin-bottom: 4px; font-size: 11px; }
    .log-item.ok { background: #1b3d1b; border-left: 3px solid #4caf50; }
    .log-item.ng { background: #3d1b1b; border-left: 3px solid #f44336; }
    .log-time { color: #888; font-size: 10px; }
    .log-result { font-weight: 600; margin: 2px 0; }
    .log-item.ok .log-result { color: #4caf50; }
    .log-item.ng .log-result { color: #f44336; }
    .log-values { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; font-size: 10px; color: #aaa; }
    .no-log { text-align: center; color: #666; padding: 16px; font-size: 12px; }
    .log-actions { display: flex; gap: 8px; margin-top: 10px; }
    .log-btn {
      flex: 1;
      padding: 8px;
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 6px;
      font-size: 12px;
      color: #aaa;
      cursor: pointer;
    }
    .log-btn:hover { background: #333; }

    /* è¨­å®šï¼ˆçœç•¥ãªã—ï¼šå‰å›ã®ã¾ã¾ï¼‰ */
    .settings-locked { text-align: center; padding: 40px 20px; }
    .lock-icon { font-size: 64px; margin-bottom: 16px; }
    .lock-text { font-size: 16px; color: #888; margin-bottom: 20px; }
    .password-input-group { display: flex; gap: 8px; max-width: 300px; margin: 0 auto; }
    .password-input-group input {
      flex: 1;
      padding: 12px;
      border: 2px solid #444;
      border-radius: 8px;
      font-size: 16px;
      background: #1a1a1a;
      color: #fff;
    }
    .password-input-group button {
      padding: 12px 20px;
      background: #4fc3f7;
      color: #000;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .settings-unlocked { display: none; }
    .settings-card {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      border: 1px solid #333;
    }
    .settings-card-title {
      font-size: 15px;
      font-weight: 700;
      color: #4fc3f7;
      margin-bottom: 14px;
      padding-bottom: 10px;
      border-bottom: 2px solid #333;
    }
    .range-group {
      margin-bottom: 14px;
      padding: 12px;
      background: #0a0a0a;
      border-radius: 8px;
      border: 1px solid #333;
    }
    .range-group-title { font-size: 14px; font-weight: 600; color: #ffb74d; margin-bottom: 10px; }
    .range-inputs { display: flex; gap: 10px; flex-wrap: wrap; }
    .range-input-item { flex: 1; min-width: 120px; }
    .range-input-item label { display: block; font-size: 12px; color: #888; margin-bottom: 4px; }
    .range-input-item input {
      width: 100%;
      padding: 10px;
      border: 2px solid #444;
      border-radius: 6px;
      font-size: 14px;
      text-align: center;
      background: #1a1a1a;
      color: #fff;
    }
    .range-input-item input:focus { outline: none; border-color: #4fc3f7; }

    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #333;
    }
    .setting-row:last-child { border-bottom: none; }
    .setting-label { font-size: 14px; color: #e0e0e0; }
    .setting-input {
      width: 100%;
      padding: 8px;
      border: 2px solid #444;
      border-radius: 6px;
      font-size: 14px;
      margin-top: 8px;
      background: #0a0a0a;
      color: #fff;
    }
    .setting-input-wide {
      width: 100%;
      padding: 10px;
      border: 2px solid #444;
      border-radius: 6px;
      font-size: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      margin-top: 8px;
      background: #0a0a0a;
      color: #fff;
    }
    .toggle-switch {
      width: 50px;
      height: 28px;
      background: #444;
      border-radius: 14px;
      position: relative;
      cursor: pointer;
      transition: background 0.3s;
    }
    .toggle-switch.on { background: #00c853; }
    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: left 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .toggle-switch.on::after { left: 24px; }

    .save-btn {
      width: 100%;
      padding: 16px;
      background: #00c853;
      color: #000;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 8px;
    }
    .lock-settings-btn {
      width: 100%;
      padding: 12px;
      background: #2a2a2a;
      color: #888;
      border: 2px solid #444;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 12px;
    }
    .danger-btn {
      width: 100%;
      padding: 12px;
      background: #3d1b1b;
      color: #ff8080;
      border: 1px solid #6b2b2b;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: 700;
    }

    /* çµæœ */
    .result-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .result-overlay.show { display: flex; animation: fadeIn 0.15s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .result-overlay.ok { background: rgba(0,100,0,0.97); }
    .result-overlay.ng { background: rgba(139,0,0,0.97); }
    .result-symbol {
      font-size: min(50vw, 50vh);
      font-weight: 900;
      color: white;
      text-shadow: 0 4px 20px rgba(0,0,0,0.5);
      line-height: 1;
    }
    .result-text { font-size: 32px; color: white; margin-top: 10px; font-weight: 700; }
    .result-detail {
      margin-top: 20px;
      padding: 16px 24px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      text-align: center;
      max-width: 92vw;
    }
    .result-detail p { color: white; font-size: 14px; margin: 4px 0; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; word-break: break-all; }
    .result-detail .label { font-size: 11px; opacity: 0.8; font-family: inherit; }

    .ng-locked .result-symbol { animation: shake 0.4s ease infinite; }
    @keyframes shake { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }

    .admin-area {
      margin-top: 20px;
      padding: 16px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      text-align: center;
      max-width: 92vw;
    }
    .admin-area p { color: white; font-size: 13px; margin-bottom: 10px; }
    .admin-input-group { display: flex; gap: 8px; justify-content: center; }
    .admin-input {
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      width: min(320px, 86vw);
      text-align: center;
      background: rgba(255,255,255,0.9);
      color: #000;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #1a1a1a; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
  </style>
</head>
<body>

  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('scan')">ğŸ“· ç…§åˆ</button>
    <button class="tab-btn" onclick="switchTab('settings')">âš™ï¸ è¨­å®š</button>
  </div>

  <div class="firebase-status disconnected" id="firebaseStatus">ğŸ”Œ Firebaseæœªæ¥ç¶š</div>

  <!-- ç…§åˆï¼ˆå¸¸æ™‚å¾…æ©Ÿï¼‰ -->
  <div class="tab-content active" id="tab-scan">
    <div class="scan-screen" id="scanScreen">
      <div class="scan-box">
        <div class="scanner-icon">ğŸ“Ÿ</div>
        <div class="scan-step" id="scanStep">STEP 1 / 2</div>
        <div class="scan-message" id="scanMessage">1å›ç›®ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„</div>

        <div class="scan-input-area">
          <input type="text" class="scan-input" id="scanInput"
                 placeholder="QRãƒªãƒ¼ãƒ€ãƒ¼ã§èª­ã¿å–ã‚Š"
                 autocomplete="off"
                 inputmode="latin">
          <div class="input-hint">QRãƒªãƒ¼ãƒ€ãƒ¼ã§ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„</div>
        </div>
      </div>

      <button class="stop-btn" onclick="stopAndReset()">â¹ï¸ åœæ­¢</button>

      <div class="log-card">
        <div class="log-header">
          <div class="log-title">ğŸ“ ç…§åˆå±¥æ­´</div>
          <div class="log-count" id="logCount">0ä»¶</div>
        </div>
        <div class="log-list" id="logList">
          <div class="no-log">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>
        </div>
        <div class="log-actions">
          <button class="log-btn" onclick="clearLog()">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
          <button class="log-btn" onclick="exportLog()">ğŸ“¥ å‡ºåŠ›</button>
        </div>
      </div>
    </div>
  </div>

  <!-- è¨­å®š -->
  <div class="tab-content" id="tab-settings">
    <div class="container">

      <div class="settings-locked" id="settingsLocked">
        <div class="lock-icon">ğŸ”’</div>
        <div class="lock-text">è¨­å®šã‚’å¤‰æ›´ã™ã‚‹ã«ã¯<br>ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
        <div class="password-input-group">
          <input type="password" id="unlockPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
          <button onclick="unlockSettings()">è§£é™¤</button>
        </div>
      </div>

      <div class="settings-unlocked" id="settingsUnlocked">

        <div class="settings-card">
          <div class="settings-card-title">ğŸ”¥ Firebaseè¨­å®š</div>

          <div class="setting-row" style="flex-direction: column; align-items: flex-start;">
            <span class="setting-label">API Key</span>
            <input type="text" class="setting-input-wide" id="fbApiKey" placeholder="AIza...">
          </div>
          <div class="setting-row" style="flex-direction: column; align-items: flex-start;">
            <span class="setting-label">Auth Domain</span>
            <input type="text" class="setting-input-wide" id="fbAuthDomain" placeholder="your-app.firebaseapp.com">
          </div>
          <div class="setting-row" style="flex-direction: column; align-items: flex-start;">
            <span class="setting-label">Database URL</span>
            <input type="text" class="setting-input-wide" id="fbDatabaseURL" placeholder="https://your-app-default-rtdb.firebaseio.com">
          </div>
          <div class="setting-row" style="flex-direction: column; align-items: flex-start;">
            <span class="setting-label">Project ID</span>
            <input type="text" class="setting-input-wide" id="fbProjectId" placeholder="your-project-id">
          </div>

          <button class="log-btn" style="width:100%; margin-top:12px;" onclick="testFirebaseConnection()">ğŸ”Œ æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
        </div>

        <div class="settings-card">
          <div class="settings-card-title">ğŸ“ å“ç•ªæŠ½å‡ºãƒ«ãƒ¼ãƒ«ï¼ˆãƒ¬ãƒ³ã‚¸ + prefixå¯¾å¿œï¼‰</div>
          <p style="font-size:12px; color:#666; margin-bottom:12px; line-height:1.5;">
            2å›ç›®QRï¼ˆæ­£è¦åŒ–å¾Œï¼‰ã®æ–‡å­—æ•°ãƒ¬ãƒ³ã‚¸(minã€œmax)ã§ãƒ«ãƒ¼ãƒ«ã‚’é¸ã³ã€é–‹å§‹ä½ç½®(startPos)ã‹ã‚‰charCountæ–‡å­—ã‚’å“ç•ªã¨ã—ã¦æŠ½å‡ºã—ã¾ã™ã€‚<br>
            prefixï¼ˆé–‹å§‹æ–‡å­—åˆ—ï¼‰ã‚’æŒ‡å®šã™ã‚‹ã¨ã€<b>æ–‡å­—æ•°ãƒ¬ãƒ³ã‚¸AND prefix</b> ã®ä¸¡æ–¹ãŒä¸€è‡´ã—ãŸãƒ«ãƒ¼ãƒ«ãŒå„ªå…ˆã•ã‚Œã¾ã™ã€‚<br>
            1å›ç›®QRï¼ˆæ­£è¦åŒ–å¾Œï¼‰ã«ã“ã®å“ç•ªãŒå«ã¾ã‚Œã¦ã„ã‚Œã°ä¸€è‡´(â—‹)ã§ã™ã€‚
          </p>

          <div id="extractRulesContainer"></div>

          <button class="log-btn" style="width:100%; margin-top:12px;" onclick="addExtractRule()">â• ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ </button>
        </div>

        <div class="settings-card">
          <div class="settings-card-title">ğŸ” ç®¡ç†è€…è¨­å®š</div>
          <div class="setting-row" style="flex-direction: column; align-items: flex-start;">
            <span class="setting-label">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</span>
            <input type="password" class="setting-input" id="adminPassword" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width:100%;">
          </div>
          <div class="setting-row" style="flex-direction: column; align-items: flex-start;">
            <span class="setting-label">ç®¡ç†è€…QRï¼ˆã‚¨ãƒ©ãƒ¼è§£é™¤ç”¨ï¼‰</span>
            <input type="text" class="setting-input" id="adminQR" placeholder="QRã®å€¤" style="width:100%;">
          </div>
        </div>

        <div class="settings-card">
          <div class="settings-card-title">ğŸ”Š ãã®ä»–</div>
          <div class="setting-row">
            <span class="setting-label">ç…§åˆéŸ³ã‚’é³´ã‚‰ã™</span>
            <div class="toggle-switch on" id="soundToggle" onclick="toggleSound()"></div>
          </div>
          <div class="setting-row">
            <span class="setting-label">ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</span>
            <div class="toggle-switch on" id="vibrationToggle" onclick="toggleVibration()"></div>
          </div>
        </div>

        <button class="save-btn" onclick="saveAllSettings()">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
        <button class="lock-settings-btn" onclick="lockSettings()">ğŸ”’ è¨­å®šã‚’ãƒ­ãƒƒã‚¯</button>

        <button class="danger-btn" onclick="resetAppSettings()">âš ï¸ è¨­å®šã‚’åˆæœŸåŒ–ï¼ˆVB24å•é¡Œã®ç·Šæ€¥å¾©æ—§ï¼‰</button>
      </div>
    </div>
  </div>

  <!-- çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆOKã¯è‡ªå‹•ã§é–‰ã˜ã‚‹ã®ã§ãƒœã‚¿ãƒ³ç„¡ã—ï¼‰ -->
  <div class="result-overlay" id="resultOverlay">
    <div class="result-symbol" id="resultSymbol">â—‹</div>
    <div class="result-text" id="resultText">ä¸€è‡´</div>
    <div class="result-detail" id="resultDetail"></div>

    <!-- äº’æ›ã®ãŸã‚æ®‹ã™ãŒå¸¸ã«éè¡¨ç¤ºï¼ˆæŠ¼ã•ãšã«è‡ªå‹•é·ç§»ï¼‰ -->
    <button style="display:none;" id="okBtn" onclick="closeAndContinue()">æ¬¡ã®ç…§åˆã¸</button>

    <div class="admin-area" id="adminArea" style="display:none;">
      <p>âš ï¸ ç®¡ç†è€…QRã§è§£é™¤ã—ã¦ãã ã•ã„</p>
      <div class="admin-input-group">
        <input type="text" class="admin-input" id="adminInput"
               placeholder="ç®¡ç†è€…QRã‚’èª­ã¿å–ã‚Š"
               inputmode="latin">
      </div>
    </div>
  </div>

<script>
  // ========= çŠ¶æ…‹ =========
  let currentStep = 0;
  let value1 = '';
  let value2 = '';
  let isNGLocked = false;
  let scanLog = [];
  let audioCtx = null;

  // ã‚¿ãƒ–çŠ¶æ…‹ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç¶­æŒç”¨ï¼‰
  let currentTab = 'scan';

  // OKè‡ªå‹•é·ç§»ã‚¿ã‚¤ãƒãƒ¼ï¼ˆé€£æ‰“å¯¾ç­–ï¼‰
  let okAutoTimer = null;

  // Firebase
  let firebaseApp = null;
  let database = null;
  let logsRef = null;

  // ========= è¨­å®š =========
  let settings = {
    adminPassword: 'admin',
    adminQR: 'ADMIN123',
    soundEnabled: true,
    vibrationEnabled: true,
    firebase: {
      apiKey: "AIzaSyAOMRoojKv9Hnh3OjVGwYV_k1LBTGOKepY",
      authDomain: "miyamaunitec-fb87a.firebaseapp.com",
      databaseURL: "https://miyamaunitec-fb87a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "miyamaunitec-fb87a"
    },
    extractRules: [
      { minLen: 1, maxLen: 99, startPos: 9, charCount: 8, prefix: '' }
    ]
  };

  // ========= åˆæœŸåŒ– =========
  document.addEventListener('DOMContentLoaded', () => {
    loadSettings();
    loadLog();
    setupInputListeners();
    initFirebase();

    // èµ·å‹•ç›´å¾Œã‹ã‚‰å³ã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿï¼ˆSTEP1ï¼‰
    startScanning(true);

    // å¸¸æ™‚ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç¶­æŒï¼ˆç…§åˆã‚¿ãƒ–ã®æ™‚ã ã‘ï¼‰
    setupFocusKeeper();
  });

  // ========= å¸¸æ™‚ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç¶­æŒ =========
  function setupFocusKeeper(){
    document.addEventListener('pointerdown', () => {
      if (currentTab !== 'scan') return;
      if (document.getElementById('resultOverlay').classList.contains('show')) return;
      focusScanInputSoon();
    }, { passive: true });

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        if (currentTab === 'scan' && !document.getElementById('resultOverlay').classList.contains('show')) {
          focusScanInputSoon();
        }
      }
    });

    setInterval(() => {
      if (currentTab !== 'scan') return;
      if (document.getElementById('resultOverlay').classList.contains('show')) return;

      const scanInput = document.getElementById('scanInput');
      if (!scanInput) return;

      if (document.activeElement === scanInput || document.activeElement === document.getElementById('adminInput')) return;

      focusScanInputSoon();
    }, 700);
  }

  function focusScanInputSoon(){
    setTimeout(() => {
      const scanInput = document.getElementById('scanInput');
      if (!scanInput) return;
      if (document.getElementById('resultOverlay').classList.contains('show')) return;
      if (currentTab !== 'scan') return;
      scanInput.focus({ preventScroll: true });
    }, 30);
  }

  // ========= æ–‡å­—åˆ—æ­£è¦åŒ– =========
  function normalizeQR(str){
    return String(str ?? '')
      .normalize('NFKC')
      .replace(/\u00A0/g, ' ')
      .replace(/[\r\n]+/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();
  }

  // ========= Firebase =========
  function initFirebase() {
    if (!settings.firebase.apiKey || !settings.firebase.databaseURL) {
      updateFirebaseStatus('disconnected', 'ğŸ”Œ Firebaseæœªè¨­å®š');
      return;
    }
    try {
      const firebaseConfig = {
        apiKey: settings.firebase.apiKey,
        authDomain: settings.firebase.authDomain,
        databaseURL: settings.firebase.databaseURL,
        projectId: settings.firebase.projectId
      };

      try { if (firebaseApp) firebaseApp.delete(); } catch(e){}

      firebaseApp = firebase.initializeApp(firebaseConfig);
      database = firebase.database();
      logsRef = database.ref('qr_match_logs');

      database.ref('.info/connected').on('value', (snapshot) => {
        if (snapshot.val() === true) {
          updateFirebaseStatus('connected', 'ğŸŸ¢ Firebaseæ¥ç¶šä¸­');
          setupRealtimeSync();
        } else {
          updateFirebaseStatus('disconnected', 'ğŸ”Œ Firebaseæœªæ¥ç¶š');
        }
      });
    } catch (error) {
      console.error('FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      updateFirebaseStatus('error', 'âŒ Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼');
    }
  }

  function setupRealtimeSync() {
    if (!logsRef) return;
    logsRef.orderByChild('timestamp').limitToLast(100).on('value', (snapshot) => {
      const data = snapshot.val();
      if (data) {
        scanLog = Object.entries(data)
          .map(([key, val]) => ({ ...val, firebaseKey: key }))
          .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        renderLog();
      }
    });
  }

  function updateFirebaseStatus(status, message) {
    const el = document.getElementById('firebaseStatus');
    el.className = 'firebase-status ' + status;
    el.textContent = message;
  }

  function testFirebaseConnection() {
    settings.firebase.apiKey = document.getElementById('fbApiKey').value.trim();
    settings.firebase.authDomain = document.getElementById('fbAuthDomain').value.trim();
    settings.firebase.databaseURL = document.getElementById('fbDatabaseURL').value.trim();
    settings.firebase.projectId = document.getElementById('fbProjectId').value.trim();
    initFirebase();
    alert('æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚ä¸Šéƒ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
  }

  function saveLogToFirebase(logEntry) {
    if (!logsRef) return;
    logsRef.push(logEntry).catch(err => console.error('Firebaseä¿å­˜ã‚¨ãƒ©ãƒ¼:', err));
  }

  function clearFirebaseLogs() {
    if (!logsRef) return;
    logsRef.remove().catch(err => console.error('Firebaseã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', err));
  }

  // ========= å…¥åŠ›ãƒªã‚¹ãƒŠãƒ¼ =========
  function setupInputListeners() {
    const scanInput = document.getElementById('scanInput');
    const adminInput = document.getElementById('adminInput');

    scanInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const raw = scanInput.value;
        const value = normalizeQR(raw);
        if (value) {
          handleScan(value);
          scanInput.value = '';
        }
      }
    });

    adminInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const raw = adminInput.value;
        const value = normalizeQR(raw);
        if (value) {
          handleAdminScan(value);
          adminInput.value = '';
        }
      }
    });

    scanInput.addEventListener('blur', () => {
      if (currentTab !== 'scan') return;
      if (document.getElementById('resultOverlay').classList.contains('show')) return;
      focusScanInputSoon();
    });
  }

  // ========= ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç† =========
  function handleScan(decoded) {
    // OKè¡¨ç¤ºä¸­ã«è¿½åŠ å…¥åŠ›ãŒæ¥ãŸã‚‰ç„¡è¦–ï¼ˆèª¤çˆ†é˜²æ­¢ï¼‰
    if (document.getElementById('resultOverlay').classList.contains('show')) return;

    if (currentStep === 1) {
      value1 = decoded;
      playSound('beep');
      currentStep = 2;
      updateScanUI();
      focusScanInputSoon();
    } else if (currentStep === 2) {
      value2 = decoded;
      playSound('beep');
      doMatch();
    }
  }

  function handleAdminScan(value) {
    if (value === settings.adminQR) {
      isNGLocked = false;
      playSound('ok');
      document.getElementById('resultOverlay').classList.remove('show');
      startScanning(true);
      alert('âœ… ã‚¨ãƒ©ãƒ¼è§£é™¤ã—ã¾ã—ãŸ');
    } else {
      playSound('ng');
      alert('âŒ ç®¡ç†è€…QRãŒä¸€è‡´ã—ã¾ã›ã‚“');
      document.getElementById('adminInput').focus();
    }
  }

  // ========= è¨­å®šãƒ­ãƒ¼ãƒ‰ =========
  function loadSettings() {
    const KEY = 'qrMatchSettings_v7';
    const saved = localStorage.getItem(KEY);

    if (saved) {
      try {
        settings = deepMerge(settings, JSON.parse(saved));
      } catch (e) {
        console.warn('settings parse error', e);
      }
    }

    settings.extractRules = (settings.extractRules || []).map(r => sanitizeRule(r));
    if (!settings.extractRules.length) {
      settings.extractRules = [{ minLen: 1, maxLen: 99, startPos: 9, charCount: 8, prefix: '' }];
    }

    settings.firebase = settings.firebase || {};
    settings.firebase.apiKey = settings.firebase.apiKey || "AIzaSyAOMRoojKv9Hnh3OjVGwYV_k1LBTGOKepY";
    settings.firebase.authDomain = settings.firebase.authDomain || "miyamaunitec-fb87a.firebaseapp.com";
    settings.firebase.databaseURL = settings.firebase.databaseURL || "https://miyamaunitec-fb87a-default-rtdb.asia-southeast1.firebasedatabase.app";
    settings.firebase.projectId = settings.firebase.projectId || "miyamaunitec-fb87a";

    applySettingsToForm();
  }

  function deepMerge(base, extra) {
    const out = Array.isArray(base) ? [...base] : { ...base };
    for (const k in extra) {
      const v = extra[k];
      if (v && typeof v === 'object' && !Array.isArray(v)) {
        out[k] = deepMerge(base[k] || {}, v);
      } else {
        out[k] = v;
      }
    }
    return out;
  }

  function sanitizeRule(r) {
    r = r || {};
    const minLen = Math.max(1, parseInt(r.minLen ?? 1) || 1);
    const maxLen = Math.max(minLen, parseInt(r.maxLen ?? minLen) || minLen);
    const startPos = Math.max(1, parseInt(r.startPos ?? 1) || 1);
    const charCount = Math.max(1, parseInt(r.charCount ?? 8) || 8);
    const prefix = normalizeQR(r.prefix || '');
    return { minLen, maxLen, startPos, charCount, prefix };
  }

  function applySettingsToForm() {
    document.getElementById('adminQR').value = settings.adminQR;
    document.getElementById('soundToggle').className = settings.soundEnabled ? 'toggle-switch on' : 'toggle-switch';
    document.getElementById('vibrationToggle').className = settings.vibrationEnabled ? 'toggle-switch on' : 'toggle-switch';

    document.getElementById('fbApiKey').value = settings.firebase.apiKey || '';
    document.getElementById('fbAuthDomain').value = settings.firebase.authDomain || '';
    document.getElementById('fbDatabaseURL').value = settings.firebase.databaseURL || '';
    document.getElementById('fbProjectId').value = settings.firebase.projectId || '';

    renderExtractRules();
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function renderExtractRules() {
    const container = document.getElementById('extractRulesContainer');
    container.innerHTML = (settings.extractRules || []).map((rule, index) => `
      <div class="range-group" style="position: relative;">
        <button onclick="removeExtractRule(${index})"
          style="position:absolute; top:8px; right:8px; background:#f44336; color:white; border:none; border-radius:4px; padding:4px 8px; font-size:11px; cursor:pointer;">
          å‰Šé™¤
        </button>

        <div class="range-group-title">ãƒ«ãƒ¼ãƒ« ${index + 1}</div>

        <div class="range-inputs" style="margin-bottom: 8px;">
          <div class="range-input-item">
            <label>minLen</label>
            <input type="number" class="rule-minLen" data-index="${index}" value="${rule.minLen}" min="1">
          </div>
          <div class="range-input-item">
            <label>maxLen</label>
            <input type="number" class="rule-maxLen" data-index="${index}" value="${rule.maxLen}" min="1">
          </div>
          <div class="range-input-item">
            <label>é–‹å§‹ä½ç½®(startPos)</label>
            <input type="number" class="rule-startPos" data-index="${index}" value="${rule.startPos}" min="1">
          </div>
          <div class="range-input-item">
            <label>æ–‡å­—æ•°(charCount)</label>
            <input type="number" class="rule-charCount" data-index="${index}" value="${rule.charCount}" min="1">
          </div>
          <div class="range-input-item" style="min-width: 180px;">
            <label>prefix(é–‹å§‹æ–‡å­—åˆ—)</label>
            <input type="text" class="rule-prefix" data-index="${index}" value="${escapeHtml(rule.prefix || '')}" placeholder="ä¾‹: :G / VB / ãªã—">
          </div>
        </div>

        <div style="font-size: 11px; color: #666; line-height:1.4;">
          ä¾‹ï¼š${rule.minLen}ã€œ${rule.maxLen}æ–‡å­— ${rule.prefix ? `ã‹ã¤ prefix="${escapeHtml(rule.prefix)}"` : ''} ã®å ´åˆ â†’
          ${rule.startPos}æ–‡å­—ç›®ã‹ã‚‰${rule.charCount}æ–‡å­—ã‚’å“ç•ªã¨ã—ã¦æŠ½å‡º
        </div>
      </div>
    `).join('');
  }

  function addExtractRule() {
    settings.extractRules.push({ minLen: 1, maxLen: 99, startPos: 9, charCount: 8, prefix: '' });
    renderExtractRules();
  }

  function removeExtractRule(index) {
    if (settings.extractRules.length <= 1) {
      alert('æœ€ä½1ã¤ã®ãƒ«ãƒ¼ãƒ«ãŒå¿…è¦ã§ã™');
      return;
    }
    settings.extractRules.splice(index, 1);
    renderExtractRules();
  }

  function collectExtractRules() {
    const minEls = [...document.querySelectorAll('.rule-minLen')];
    const maxEls = [...document.querySelectorAll('.rule-maxLen')];
    const startEls = [...document.querySelectorAll('.rule-startPos')];
    const countEls = [...document.querySelectorAll('.rule-charCount')];
    const prefixEls = [...document.querySelectorAll('.rule-prefix')];

    const rules = minEls.map((_, i) => sanitizeRule({
      minLen: parseInt(minEls[i].value) || 1,
      maxLen: parseInt(maxEls[i].value) || (parseInt(minEls[i].value) || 1),
      startPos: parseInt(startEls[i].value) || 1,
      charCount: parseInt(countEls[i].value) || 8,
      prefix: normalizeQR(prefixEls[i].value || '')
    }));

    return rules;
  }

  function saveAllSettings() {
    const newPassword = document.getElementById('adminPassword').value.trim();
    if (newPassword) settings.adminPassword = newPassword;

    settings.adminQR = normalizeQR(document.getElementById('adminQR').value) || 'ADMIN123';

    settings.firebase.apiKey = document.getElementById('fbApiKey').value.trim();
    settings.firebase.authDomain = document.getElementById('fbAuthDomain').value.trim();
    settings.firebase.databaseURL = document.getElementById('fbDatabaseURL').value.trim();
    settings.firebase.projectId = document.getElementById('fbProjectId').value.trim();

    settings.extractRules = collectExtractRules();

    localStorage.setItem('qrMatchSettings_v7', JSON.stringify(settings));

    initFirebase();
    alert('âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    document.getElementById('adminPassword').value = '';
  }

  function toggleSound() {
    settings.soundEnabled = !settings.soundEnabled;
    document.getElementById('soundToggle').className = settings.soundEnabled ? 'toggle-switch on' : 'toggle-switch';
  }

  function toggleVibration() {
    settings.vibrationEnabled = !settings.vibrationEnabled;
    document.getElementById('vibrationToggle').className = settings.vibrationEnabled ? 'toggle-switch on' : 'toggle-switch';
  }

  function resetAppSettings() {
    if (!confirm('è¨­å®šã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚\nï¼ˆVB24å•é¡Œãªã©ã®ç·Šæ€¥å¾©æ—§ç”¨ï¼‰\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    localStorage.removeItem('qrMatchSettings_v7');
    localStorage.removeItem('qrMatchSettings_v6');
    localStorage.removeItem('qrMatchSettings_v5');
    alert('âœ… è¨­å®šã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚');
    location.reload();
  }

  // ========= è¨­å®šãƒ­ãƒƒã‚¯ =========
  function unlockSettings() {
    const input = document.getElementById('unlockPassword').value;
    if (input === settings.adminPassword) {
      document.getElementById('settingsLocked').style.display = 'none';
      document.getElementById('settingsUnlocked').style.display = 'block';
      document.getElementById('unlockPassword').value = '';
    } else {
      alert('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
    }
  }

  function lockSettings() {
    document.getElementById('settingsLocked').style.display = 'block';
    document.getElementById('settingsUnlocked').style.display = 'none';
  }

  // ========= ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ =========
  function switchTab(tab) {
    currentTab = tab;

    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

    if (tab === 'scan') {
      document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
      document.getElementById('tab-scan').classList.add('active');
      focusScanInputSoon();
    } else {
      document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
      document.getElementById('tab-settings').classList.add('active');
    }
  }

  // ========= ãƒ­ã‚° =========
  function loadLog() {
    const saved = localStorage.getItem('qrMatchLog_v7');
    const legacy6 = localStorage.getItem('qrMatchLog_v6');
    const legacy5 = localStorage.getItem('qrMatchLog_v5');

    if (saved) {
      try { scanLog = JSON.parse(saved) || []; } catch(e) { scanLog = []; }
    } else if (legacy6) {
      try { scanLog = JSON.parse(legacy6) || []; } catch(e) { scanLog = []; }
      localStorage.setItem('qrMatchLog_v7', JSON.stringify(scanLog));
    } else if (legacy5) {
      try { scanLog = JSON.parse(legacy5) || []; } catch(e) { scanLog = []; }
      localStorage.setItem('qrMatchLog_v7', JSON.stringify(scanLog));
    } else {
      scanLog = [];
    }
    renderLog();
  }

  function saveLog() {
    localStorage.setItem('qrMatchLog_v7', JSON.stringify(scanLog));
  }

  // ========= éŸ³ãƒ»ãƒã‚¤ãƒ– =========
  function initAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }

  function playSound(type) {
    if (!settings.soundEnabled) return;
    initAudio();
    if (audioCtx.state === 'suspended') audioCtx.resume();

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);

    if (type === 'beep') {
      osc.frequency.value = 1400; osc.type = 'sine'; gain.gain.value = 0.5;
      osc.start(); setTimeout(() => osc.stop(), 240);
      vibrate([120]);
    } else if (type === 'ok') {
      osc.frequency.value = 1200; osc.type = 'sine'; gain.gain.value = 0.5;
      osc.start();
      setTimeout(() => osc.frequency.value = 1500, 120);
      setTimeout(() => osc.stop(), 240);
      vibrate([90, 40, 90]);
    } else if (type === 'ng') {
      osc.frequency.value = 280; osc.type = 'square'; gain.gain.value = 0.4;
      osc.start(); setTimeout(() => osc.stop(), 460);
      vibrate([500]);
    }
  }

  function vibrate(pattern) {
    if (!settings.vibrationEnabled) return;
    if (navigator.vibrate) navigator.vibrate(pattern);
  }

  // ========= æŠ½å‡ºãƒ«ãƒ¼ãƒ«ï¼ˆãƒ¬ãƒ³ã‚¸ + prefixå„ªå…ˆï¼‰ =========
  function pickRule(qr2Norm) {
    const totalLen = qr2Norm.length;

    const withPrefix = (settings.extractRules || [])
      .filter(r => r.prefix && qr2Norm.startsWith(r.prefix))
      .find(r => totalLen >= r.minLen && totalLen <= r.maxLen);

    if (withPrefix) return withPrefix;

    return (settings.extractRules || []).find(r => totalLen >= r.minLen && totalLen <= r.maxLen) || null;
  }

  function extractPartNumberWithMeta(qr2Raw) {
    const qr2 = normalizeQR(qr2Raw);
    const totalLen = qr2.length;

    const rule = pickRule(qr2);

    if (!rule) {
      return { part: qr2, rule: null, totalLen, start0: 0, note: 'no_rule_full' };
    }

    const start0 = rule.startPos - 1;

    if (start0 < 0 || start0 >= qr2.length) {
      return { part: qr2, rule, totalLen, start0, note: 'bad_start_full' };
    }

    const part = qr2.substring(start0, start0 + rule.charCount);

    let note = '';
    if (part.length < rule.charCount) note = 'short_extract';

    return { part, rule, totalLen, start0, note };
  }

  // ========= ç…§åˆ =========
  function doMatch() {
    const v1 = normalizeQR(value1);
    const v2 = normalizeQR(value2);

    const ex = extractPartNumberWithMeta(v2);
    const partNumber = ex.part;

    const isOK = v1.includes(partNumber);

    const logEntry = {
      timestamp: new Date().toISOString(),
      qr1_raw: value1,
      qr2_raw: value2,
      qr1: v1,
      qr2: v2,
      partNumber: partNumber,
      qr2Length: v2.length,
      matchedRule: ex.rule ? {
        minLen: ex.rule.minLen,
        maxLen: ex.rule.maxLen,
        startPos: ex.rule.startPos,
        charCount: ex.rule.charCount,
        prefix: ex.rule.prefix || ''
      } : null,
      extractStart0: ex.start0,
      extractNote: ex.note || '',
      result: isOK ? 'OK' : 'NG'
    };

    scanLog.unshift(logEntry);
    if (scanLog.length > 120) scanLog.pop();
    saveLog();
    renderLog();

    saveLogToFirebase(logEntry);

    showResult(isOK, partNumber, logEntry);
  }

  // ========= çµæœè¡¨ç¤º =========
  function showResult(isOK, partNumber, logEntry) {
    const overlay = document.getElementById('resultOverlay');
    const symbol = document.getElementById('resultSymbol');
    const text = document.getElementById('resultText');
    const detail = document.getElementById('resultDetail');
    const adminArea = document.getElementById('adminArea');

    overlay.classList.add('show');

    const ruleText = logEntry.matchedRule
      ? `rule: [${logEntry.matchedRule.minLen}-${logEntry.matchedRule.maxLen}] start=${logEntry.matchedRule.startPos} count=${logEntry.matchedRule.charCount} prefix="${logEntry.matchedRule.prefix}"`
      : 'rule: (none)';

    // ã‚‚ã—å‰ã®OKã‚¿ã‚¤ãƒãƒ¼ãŒæ®‹ã£ã¦ãŸã‚‰æ¶ˆã™
    if (okAutoTimer) { clearTimeout(okAutoTimer); okAutoTimer = null; }

    if (isOK) {
      overlay.className = 'result-overlay show ok';
      symbol.textContent = 'â—‹';
      text.textContent = 'ä¸€è‡´';
      detail.innerHTML = `
        <p class="label">æŠ½å‡ºå“ç•ª</p><p>${escapeHtml(partNumber)}</p>
        <p class="label" style="margin-top:10px;">${escapeHtml(ruleText)}</p>
        ${logEntry.extractNote ? `<p class="label" style="margin-top:10px;">note: ${escapeHtml(logEntry.extractNote)}</p>` : ''}
      `;
      adminArea.style.display = 'none';
      playSound('ok');

      // â˜…ã“ã“ãŒå¤‰æ›´ç‚¹ï¼š0.4ç§’ã§è‡ªå‹•çš„ã«æ¬¡ã¸
      okAutoTimer = setTimeout(() => {
        overlay.classList.remove('show');
        startScanning(true);
        okAutoTimer = null;
      }, 400);

    } else {
      overlay.className = 'result-overlay show ng ng-locked';
      symbol.textContent = 'Ã—';
      text.textContent = 'ä¸ä¸€è‡´';
      detail.innerHTML = `
        <p class="label">æŠ½å‡ºã—ãŸå“ç•ª</p><p>${escapeHtml(partNumber)}</p>
        <p class="label" style="margin-top:10px;">${escapeHtml(ruleText)}</p>
        ${logEntry.extractNote ? `<p class="label" style="margin-top:10px;">note: ${escapeHtml(logEntry.extractNote)}</p>` : ''}
        <p class="label" style="margin-top:12px;">1å›ç›®QRã«å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“</p>
      `;
      adminArea.style.display = 'block';
      isNGLocked = true;
      playSound('ng');
      setTimeout(() => document.getElementById('adminInput').focus(), 100);
    }
  }

  // ========= é–‹å§‹ãƒ»åœæ­¢ =========
  function startScanning(boot=false) {
    if (isNGLocked) {
      showNGOverlay();
      return;
    }
    value1 = '';
    value2 = '';
    currentStep = 1;
    updateScanUI();
    if (!boot) playSound('beep');
    focusScanInputSoon();
  }

  function stopAndReset() {
    currentStep = 0;
    value1 = '';
    value2 = '';
    startScanning(true);
  }

  function showNGOverlay() {
    const overlay = document.getElementById('resultOverlay');
    overlay.className = 'result-overlay show ng ng-locked';
    document.getElementById('resultSymbol').textContent = 'Ã—';
    document.getElementById('resultText').textContent = 'ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹';
    document.getElementById('resultDetail').innerHTML = '<p>ç®¡ç†è€…QRã§è§£é™¤ãŒå¿…è¦</p>';
    document.getElementById('adminArea').style.display = 'block';
    setTimeout(() => document.getElementById('adminInput').focus(), 100);
  }

  function updateScanUI() {
    const step = document.getElementById('scanStep');
    const message = document.getElementById('scanMessage');
    const input = document.getElementById('scanInput');

    if (currentStep === 1) {
      step.textContent = 'STEP 1 / 2';
      message.textContent = '1å›ç›®ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„';
      message.className = 'scan-message';
      input.className = 'scan-input';
      input.placeholder = 'QRãƒªãƒ¼ãƒ€ãƒ¼ã§èª­ã¿å–ã‚Š';
    } else if (currentStep === 2) {
      step.textContent = 'STEP 2 / 2';
      message.textContent = '2å›ç›®ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„';
      message.className = 'scan-message step2';
      input.className = 'scan-input step2';
      input.placeholder = 'QRãƒªãƒ¼ãƒ€ãƒ¼ã§èª­ã¿å–ã‚Š';
    }
  }

  // ========= ãƒ­ã‚°è¡¨ç¤º =========
  function renderLog() {
    const container = document.getElementById('logList');
    document.getElementById('logCount').textContent = scanLog.length + 'ä»¶';

    if (scanLog.length === 0) {
      container.innerHTML = '<div class="no-log">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    container.innerHTML = scanLog.slice(0, 60).map(l => {
      const t = new Date(l.timestamp).toLocaleString('ja-JP');
      const rule = l.matchedRule
        ? `[${l.matchedRule.minLen}-${l.matchedRule.maxLen}] s${l.matchedRule.startPos} c${l.matchedRule.charCount}${l.matchedRule.prefix ? ` p:${l.matchedRule.prefix}` : ''}`
        : '(none)';
      const note = l.extractNote ? ` / note:${l.extractNote}` : '';
      return `
        <div class="log-item ${String(l.result).toLowerCase()}">
          <div class="log-time">${t}</div>
          <div class="log-result">${l.result === 'OK' ? 'âœ… OK' : 'âŒ NG'}</div>
          <div class="log-values">å“ç•ª: ${escapeHtml(l.partNumber)} / len:${l.qr2Length} / ${escapeHtml(rule)}${escapeHtml(note)}</div>
        </div>
      `;
    }).join('');
  }

  function clearLog() {
    if (confirm('å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆFirebaseã®ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰')) {
      scanLog = [];
      saveLog();
      renderLog();
      clearFirebaseLogs();
      localStorage.removeItem('qrMatchLog_v7');
      localStorage.removeItem('qrMatchLog_v6');
      localStorage.removeItem('qrMatchLog_v5');
    }
  }

  function exportLog() {
    if (scanLog.length === 0) return alert('å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“');
    const headers = [
      'æ—¥æ™‚','çµæœ','1å›ç›®QR(raw)','2å›ç›®QR(raw)',
      '1å›ç›®QR(norm)','2å›ç›®QR(norm)',
      'æŠ½å‡ºå“ç•ª','2å›ç›®æ–‡å­—æ•°','ãƒ«ãƒ¼ãƒ«','note'
    ];
    const rows = scanLog.map(l => [
      new Date(l.timestamp).toLocaleString('ja-JP'),
      l.result,
      l.qr1_raw ?? '',
      l.qr2_raw ?? '',
      l.qr1 ?? '',
      l.qr2 ?? '',
      l.partNumber ?? '',
      l.qr2Length ?? '',
      l.matchedRule ? JSON.stringify(l.matchedRule) : '',
      l.extractNote ?? ''
    ]);
    const csv = [headers, ...rows]
      .map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(','))
      .join('\n');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob(['\uFEFF' + csv], { type: 'text/csv' }));
    a.download = `QRç…§åˆå±¥æ­´_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
  }
</script>
</body>
</html>
