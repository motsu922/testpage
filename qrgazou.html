<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ç”»åƒãƒã‚¹ã‚¿ç™»éŒ²ï¼ˆæ•´ç†No â†’ ç”»åƒï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="format-detection" content="telephone=no" />
<style>
  :root{
    --fg:#111827; --muted:#6b7280;
    --border:#e5e7eb; --bg:#f7f7f8; --card:#fff;
    --primary:#0b3b75; --danger:#b42318; --ok:#16a34a;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
  }
  header{
    position:sticky; top:0; z-index:10;
    background:#fff; border-bottom:1px solid var(--border);
    padding:12px 16px;
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  }
  h1{ margin:0; font-size:16px; }
  .badge{
    font-size:12px; padding:4px 10px; border-radius:999px;
    border:1px solid #d1d5db; color:var(--muted); background:#fff;
  }
  main{ max-width:1100px; margin:16px auto; padding:0 16px 36px; }
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:14px;
    padding:16px;
    margin-bottom:16px;
  }
  .title{ font-size:18px; font-weight:900; margin:0 0 10px; }
  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  @media (max-width:900px){ .grid2{ grid-template-columns:1fr; } }
  .field{ display:flex; flex-direction:column; gap:6px; }
  label{ font-size:12px; color:#475569; font-weight:800; }
  input[type="text"]{
    padding:12px 12px; border-radius:10px; border:1px solid #d1d5db;
    font-size:16px; outline:none; background:#fff;
  }
  input[type="text"]:focus{
    border-color:#93c5fd; box-shadow:0 0 0 3px rgba(59,130,246,.15);
  }
  input[type="file"]{ display:none; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .btn{
    padding:10px 14px; border-radius:12px; border:1px solid #d1d5db;
    background:#fff; cursor:pointer; font-size:14px;
    -webkit-tap-highlight-color: transparent;
  }
  .btn.primary{ background:var(--primary); border-color:var(--primary); color:#fff; font-weight:900; }
  .btn.warn{ background:#fef3f2; border-color:#fecdcf; color:var(--danger); font-weight:900; }
  .btn:disabled{ opacity:.5; cursor:not-allowed; }
  .pill{
    font-size:12px; padding:4px 10px; border-radius:999px;
    border:1px solid #cbd5e1; background:#fff; color:#334155;
  }
  .note{ font-size:12px; color:var(--muted); line-height:1.6; }
  .danger{ color:var(--danger); font-weight:900; }
  .ok{ color:var(--ok); font-weight:900; }
  .imgBox{
    border:2px dashed #e5e7eb; border-radius:16px; background:#fff;
    padding:10px; display:flex; align-items:center; justify-content:center; min-height:220px;
  }
  .imgBox img{ max-width:100%; max-height:340px; object-fit:contain; display:none; }
  .imgHint{ color:#9ca3af; font-size:13px; text-align:center; line-height:1.6; }
  .listHeader{
    display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
  }
  .listGrid{
    display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));
    gap:12px; max-height:620px; overflow:auto; padding:4px;
  }
  .item{
    border:1px solid #e5e7eb; border-radius:12px; padding:10px; background:#fff;
    cursor:pointer; transition:.15s ease;
  }
  .item:hover{ border-color: var(--primary); box-shadow:0 6px 14px rgba(0,0,0,.08); }
  .thumb{
    width:100%; height:150px; background:#f8fafc; border-radius:10px; overflow:hidden;
    display:flex; align-items:center; justify-content:center; margin-bottom:8px;
  }
  .thumb img{ max-width:100%; max-height:100%; object-fit:contain; }
  .seiri{ font-size:14px; font-weight:1000; text-align:center; word-break:break-all; }
  .fname{ font-size:11px; color:#64748b; text-align:center; word-break:break-all; margin-top:4px; }
  footer{ text-align:center; color:#9ca3af; font-size:12px; padding:16px 0; }
</style>
</head>

<body>
<header>
  <h1>ç”»åƒãƒã‚¹ã‚¿ç™»éŒ²ï¼ˆæ•´ç†No â†’ ç”»åƒï¼‰</h1>
  <span id="firebaseStatus" class="badge">Firebase: æœªæ¥ç¶š</span>
  <span id="storageStatus" class="badge">Storage: æœªæº–å‚™</span>
</header>

<main>
  <section class="card">
    <h2 class="title">ç™»éŒ² / æ›´æ–°</h2>

    <div class="grid2">
      <div class="field">
        <label>æ•´ç†Noï¼ˆåˆ‡ã‚Šå‡ºã—å€¤ï¼‰</label>
        <input id="seiriNo" type="text" placeholder="ä¾‹ï¼šABCDE" inputmode="latin" autocomplete="off" />
        <div class="note">ä¿å­˜å…ˆï¼šFirestore <b>imageMasters/{æ•´ç†No}</b></div>
      </div>

      <div class="field">
        <label>ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«</label>
        <div class="row">
          <label class="btn" for="imageFile">ç”»åƒã‚’é¸æŠ</label>
          <input id="imageFile" type="file" accept="image/*" />
          <span id="fileName" class="pill">æœªé¸æŠ</span>
          <span id="opState" class="pill">å¾…æ©Ÿ</span>
        </div>
        <div class="note">ä¿å­˜å…ˆï¼šStorage <b>productImages/{æ•´ç†No}.{æ‹¡å¼µå­}</b>ï¼ˆåŒã˜æ•´ç†Noã¯ä¸Šæ›¸ãï¼‰</div>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <button id="btnUpload" class="btn primary">ç™»éŒ²ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰</button>
      <button id="btnFetch" class="btn">ã“ã®æ•´ç†Noã‚’æ¤œç´¢ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</button>
      <button id="btnDelete" class="btn warn">å‰Šé™¤ï¼ˆFirestore + Storageï¼‰</button>
      <button id="btnClear" class="btn">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
    </div>

    <div class="note" style="margin-top:10px;">
      <span class="danger">é‹ç”¨æ³¨æ„ï¼š</span>
      ç”»åƒæ›´æ–°ã§æ‹¡å¼µå­ãŒå¤‰ã‚ã£ã¦ã‚‚ã€æ—§ç”»åƒãŒæ®‹ã‚‰ãªã„ã‚ˆã†ã« <b>è‡ªå‹•ã§å¤ã„Storageãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤</b>ã—ã¾ã™ï¼ˆæ—¢å­˜imagePathã‚’å‚ç…§ï¼‰ã€‚
    </div>
  </section>

  <section class="card">
    <h2 class="title" style="font-size:16px;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
    <div class="imgBox">
      <img id="previewImg" alt="ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" />
      <div id="previewHint" class="imgHint">ã“ã“ã«æ¤œç´¢çµæœï¼ˆç”»åƒï¼‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
    </div>
    <div id="previewMeta" class="note" style="margin-top:10px;"></div>
  </section>

  <section class="card">
    <div class="listHeader">
      <h2 class="title" style="font-size:16px; margin:0;">ç™»éŒ²æ¸ˆã¿ç”»åƒãƒã‚¹ã‚¿ä¸€è¦§</h2>
      <div class="row">
        <button id="btnRefresh" class="btn">ğŸ”„ æ›´æ–°</button>
        <span id="listCount" class="badge">0ä»¶</span>
      </div>
    </div>

    <div id="listHint" class="imgHint" style="margin:12px 0;">èª­ã¿è¾¼ã¿ä¸­...</div>
    <div id="listWrap" style="display:none;">
      <div id="listGrid" class="listGrid"></div>
    </div>
  </section>
</main>

<footer>Â© Image Master</footer>

<script>
/* ===== è¨­å®šï¼ˆã‚ãªãŸã®å…ƒã‚³ãƒ¼ãƒ‰ã«åˆã‚ã›ã‚‹ï¼‰ ===== */
const STORAGE_DIR = "productImages";       // Storage: productImages/...
const MASTER_COLLECTION = "imageMasters";  // Firestore: imageMasters/{seiriNo}

/* ===== DOM ===== */
const $firebaseStatus = document.getElementById("firebaseStatus");
const $storageStatus  = document.getElementById("storageStatus");

const $seiriNo = document.getElementById("seiriNo");
const $imageFile = document.getElementById("imageFile");
const $fileName = document.getElementById("fileName");
const $opState = document.getElementById("opState");

const $btnUpload = document.getElementById("btnUpload");
const $btnFetch  = document.getElementById("btnFetch");
const $btnDelete = document.getElementById("btnDelete");
const $btnClear  = document.getElementById("btnClear");

const $previewImg  = document.getElementById("previewImg");
const $previewHint = document.getElementById("previewHint");
const $previewMeta = document.getElementById("previewMeta");

const $btnRefresh = document.getElementById("btnRefresh");
const $listHint   = document.getElementById("listHint");
const $listWrap   = document.getElementById("listWrap");
const $listGrid   = document.getElementById("listGrid");
const $listCount  = document.getElementById("listCount");

/* ===== Utils ===== */
function normalizeSeiriNo(s){ return String(s||"").trim().replace(/\s+/g,""); }
function esc(s){ return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function setStatus(ok){
  if(ok){
    $firebaseStatus.textContent="Firebase: æ¥ç¶šæ¸ˆã¿";
    $firebaseStatus.style.color="#16a34a";
    $storageStatus.textContent="Storage: æº–å‚™OK";
    $storageStatus.style.color="#16a34a";
  }else{
    $firebaseStatus.textContent="Firebase: æœªæ¥ç¶š";
    $firebaseStatus.style.color="#9ca3af";
    $storageStatus.textContent="Storage: æœªæº–å‚™";
    $storageStatus.style.color="#9ca3af";
  }
}
function setBusy(b){
  $btnUpload.disabled = b;
  $btnFetch.disabled  = b;
  $btnDelete.disabled = b;
  $btnClear.disabled  = b;
  $btnRefresh.disabled= b;
  $imageFile.disabled = b;
  $seiriNo.disabled   = b;
}
function showPreview(url, metaHtml=""){
  if(url){
    $previewImg.src = url;
    $previewImg.style.display="block";
    $previewHint.style.display="none";
  }else{
    $previewImg.style.display="none";
    $previewHint.style.display="block";
  }
  $previewMeta.innerHTML = metaHtml || "";
}
function setOpState(text, tone="muted"){
  $opState.textContent = text;
  $opState.style.color = (tone==="ok") ? "#16a34a" : (tone==="ng") ? "#b42318" : "#334155";
  $opState.style.borderColor = (tone==="ok") ? "#86efac" : (tone==="ng") ? "#fecdcf" : "#cbd5e1";
  $opState.style.background = (tone==="ok") ? "#f0fdf4" : (tone==="ng") ? "#fef3f2" : "#fff";
}

/* ===== ã‚¤ãƒ™ãƒ³ãƒˆ ===== */
$imageFile.addEventListener("change", ()=>{
  const f = $imageFile.files && $imageFile.files[0];
  $fileName.textContent = f ? f.name : "æœªé¸æŠ";
  setOpState("å¾…æ©Ÿ");
});

$btnClear.addEventListener("click", ()=>{
  $seiriNo.value="";
  $imageFile.value="";
  $fileName.textContent="æœªé¸æŠ";
  setOpState("å¾…æ©Ÿ");
  showPreview(null, "");
});

$btnUpload.addEventListener("click", async ()=>{
  const seiri = normalizeSeiriNo($seiriNo.value);
  const file  = $imageFile.files && $imageFile.files[0];
  if(!seiri){ alert("æ•´ç†Noã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
  if(!file){ alert("ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
  if(typeof window.__saveMaster !== "function"){ alert("Firebaseæœªæ¥ç¶šã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"); return; }

  setBusy(true);
  setOpState("ç™»éŒ²ä¸­...");
  try{
    const res = await window.__saveMaster(seiri, file);
    setOpState("ç™»éŒ²å®Œäº†", "ok");
    showPreview(res.downloadUrl, `ä¿å­˜å…ˆï¼š<b>${esc(res.imagePath)}</b> / <span class="ok">OK</span>`);
    await loadList();
    alert("ç™»éŒ²ã—ã¾ã—ãŸã€‚");
  }catch(e){
    console.error(e);
    setOpState("ç™»éŒ²å¤±æ•—", "ng");
    alert("ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç¢ºèªï¼‰");
  }finally{
    setBusy(false);
  }
});

$btnFetch.addEventListener("click", async ()=>{
  const seiri = normalizeSeiriNo($seiriNo.value);
  if(!seiri){ alert("æ•´ç†Noã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
  if(typeof window.__getMasterBySeiriNo !== "function"){ alert("Firebaseæœªæ¥ç¶šã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"); return; }

  setBusy(true);
  setOpState("æ¤œç´¢ä¸­...");
  try{
    const m = await window.__getMasterBySeiriNo(seiri);
    if(m && m.downloadUrl){
      setOpState("ãƒ’ãƒƒãƒˆ", "ok");
      showPreview(m.downloadUrl, `ä¿å­˜å…ˆï¼š<b>${esc(m.imagePath||"-")}</b> / å…ƒãƒ•ã‚¡ã‚¤ãƒ«ï¼š<b>${esc(m.originalFileName||"-")}</b>`);
    }else{
      setOpState("æœªç™»éŒ²", "ng");
      showPreview(null, `ç”»åƒãƒã‚¹ã‚¿æœªç™»éŒ²ï¼š<b>${esc(seiri)}</b>`);
    }
  }catch(e){
    console.error(e);
    setOpState("æ¤œç´¢å¤±æ•—", "ng");
    showPreview(null, `ã‚¨ãƒ©ãƒ¼ï¼š<b>${esc(e.message||String(e))}</b>`);
  }finally{
    setBusy(false);
  }
});

$btnDelete.addEventListener("click", async ()=>{
  const seiri = normalizeSeiriNo($seiriNo.value);
  if(!seiri){ alert("æ•´ç†Noã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
  if(typeof window.__deleteMaster !== "function"){ alert("Firebaseæœªæ¥ç¶šã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"); return; }

  const ok = confirm(`æ•´ç†Noã€Œ${seiri}ã€ã®ç”»åƒãƒã‚¹ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\nï¼ˆFirestore + Storageï¼‰\næœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`);
  if(!ok) return;

  setBusy(true);
  setOpState("å‰Šé™¤ä¸­...");
  try{
    await window.__deleteMaster(seiri);
    setOpState("å‰Šé™¤å®Œäº†", "ok");
    showPreview(null, "");
    await loadList();
    alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
  }catch(e){
    console.error(e);
    setOpState("å‰Šé™¤å¤±æ•—", "ng");
    alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç¢ºèªï¼‰");
  }finally{
    setBusy(false);
  }
});

$btnRefresh.addEventListener("click", ()=>loadList());

/* ===== ä¸€è¦§è¡¨ç¤º ===== */
async function loadList(){
  $listHint.style.display="block";
  $listHint.textContent="èª­ã¿è¾¼ã¿ä¸­...";
  $listWrap.style.display="none";
  $listGrid.innerHTML="";
  $listCount.textContent="0ä»¶";

  if(typeof window.__listImageMaster !== "function"){
    $listHint.textContent="Firebaseæœªæ¥ç¶šã®ãŸã‚ä¸€è¦§ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚";
    return;
  }

  try{
    const list = await window.__listImageMaster();
    const n = (list && list.length) ? list.length : 0;
    $listCount.textContent = `${n}ä»¶`;

    if(!n){
      $listHint.textContent="ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ç”»åƒãƒã‚¹ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
      return;
    }

    $listHint.style.display="none";
    $listWrap.style.display="block";

    for(const item of list){
      const card = document.createElement("div");
      card.className="item";

      const thumb = document.createElement("div");
      thumb.className="thumb";

      if(item.downloadUrl){
        const img = document.createElement("img");
        img.src = item.downloadUrl;
        img.alt = item.seiriNo;
        thumb.appendChild(img);
      }else{
        const ph = document.createElement("div");
        ph.textContent="ç”»åƒãªã—";
        ph.style.cssText="color:#9ca3af; font-size:13px;";
        thumb.appendChild(ph);
      }

      const seiri = document.createElement("div");
      seiri.className="seiri";
      seiri.textContent = item.seiriNo;

      const fn = document.createElement("div");
      fn.className="fname";
      fn.textContent = item.originalFileName || "ãƒ•ã‚¡ã‚¤ãƒ«åä¸æ˜";

      card.addEventListener("click", async ()=>{
        $seiriNo.value = item.seiriNo;
        setOpState("å¾…æ©Ÿ");
        if(item.downloadUrl){
          showPreview(item.downloadUrl, `ä¿å­˜å…ˆï¼š<b>${esc(item.imagePath||"-")}</b> / å…ƒãƒ•ã‚¡ã‚¤ãƒ«ï¼š<b>${esc(item.originalFileName||"-")}</b>`);
        }else{
          showPreview(null, `ä¿å­˜å…ˆï¼š<b>${esc(item.imagePath||"-")}</b>`);
        }
        window.scrollTo({top:0, behavior:"smooth"});
      });

      card.appendChild(thumb);
      card.appendChild(seiri);
      card.appendChild(fn);
      $listGrid.appendChild(card);
    }
  }catch(e){
    console.error(e);
    $listHint.textContent = `ã‚¨ãƒ©ãƒ¼: ${e.message}`;
  }
}

/* èµ·å‹•æ™‚ */
window.addEventListener("load", ()=>{
  setStatus(false);
  loadList();
});
</script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, getDocs, setDoc, deleteDoc, collection, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import {
    getStorage, ref, uploadBytes, getDownloadURL, deleteObject
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAOMRoojKv9Hnh3OjVGwYV_k1LBTGOKepY",
    authDomain: "miyamaunitec-fb87a.firebaseapp.com",
    databaseURL: "https://miyamaunitec-fb87a-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "miyamaunitec-fb87a",
    storageBucket: "miyamaunitec-fb87a.firebasestorage.app",
    messagingSenderId: "495316649507",
    appId: "1:495316649507:web:1f98ee3dd851474fa39396",
    measurementId: "G-1NXD8ZPGNR"
  };

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch(e){}

  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const statusEl = document.getElementById("firebaseStatus");
  const storageEl = document.getElementById("storageStatus");
  const setStatus = (t,c)=>{ statusEl.textContent=`Firebase: ${t}`; statusEl.style.color=c; };
  const setStorage = (t,c)=>{ storageEl.textContent=`Storage: ${t}`; storageEl.style.color=c; };

  try{
    await signInAnonymously(auth);
    setStatus("æ¥ç¶šæ¸ˆã¿","#16a34a");
    setStorage("æº–å‚™OK","#16a34a");
  }catch(e){
    console.warn("åŒ¿åèªè¨¼å¤±æ•—:", e);
    setStatus("æœªæ¥ç¶šï¼ˆèªè¨¼ã‚¨ãƒ©ãƒ¼ï¼‰","#dc2626");
    setStorage("æœªæº–å‚™ï¼ˆèªè¨¼ã‚¨ãƒ©ãƒ¼ï¼‰","#dc2626");
  }

  // ===== ç”»åƒãƒã‚¹ã‚¿å–å¾—ï¼šimageMasters/{seiriNo} =====
  window.__getMasterBySeiriNo = async (seiriNo) => {
    const key = String(seiriNo||"").trim();
    if(!key) return null;

    const snap = await getDoc(doc(db, MASTER_COLLECTION, key));
    if(!snap.exists()) return null;

    const data = snap.data() || {};
    if(!data.imagePath) return { ...data, downloadUrl: null };

    try{
      const downloadUrl = await getDownloadURL(ref(storage, data.imagePath));
      return { ...data, downloadUrl };
    }catch(e){
      console.warn("getDownloadURL failed:", e);
      return { ...data, downloadUrl: null };
    }
  };

  // ===== ç”»åƒãƒã‚¹ã‚¿ä¿å­˜ï¼šStorageã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ imageMasters/{seiriNo} ä¸Šæ›¸ã =====
  // æ—§æ‹¡å¼µå­æ®‹ã‚Šå¯¾ç­–ï¼šæ—¢å­˜imagePathã‚’å–å¾—ã—ã€ãƒ‘ã‚¹ãŒå¤‰ã‚ã‚‹ãªã‚‰å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
  window.__saveMaster = async (seiriNo, file) => {
    const key = String(seiriNo||"").trim();
    if(!key) throw new Error("seiriNo required");
    if(!file) throw new Error("file required");

    const origName = String(file.name || "image");
    const extMatch = origName.toLowerCase().match(/\.([a-z0-9]+)$/);
    const ext = extMatch ? extMatch[1] : "jpg";

    const newPath = `${STORAGE_DIR}/${key}.${ext}`;

    // æ—¢å­˜ã‚’ç¢ºèªï¼ˆæ—§ãƒ‘ã‚¹ãŒã‚ã‚Œã°å‰Šé™¤å€™è£œï¼‰
    let oldPath = null;
    try{
      const oldSnap = await getDoc(doc(db, MASTER_COLLECTION, key));
      if(oldSnap.exists()){
        const old = oldSnap.data() || {};
        if(old.imagePath) oldPath = String(old.imagePath);
      }
    }catch(e){
      // å–å¾—å¤±æ•—ã—ã¦ã‚‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯ç¶šè¡Œ
      console.warn("read old master failed:", e);
    }

    // æ–°è¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    const storageRef = ref(storage, newPath);
    await uploadBytes(storageRef, file, { contentType: file.type || "application/octet-stream" });
    const downloadUrl = await getDownloadURL(storageRef);

    // Firestoreæ›´æ–°
    const payload = {
      seiriNo: key,
      imagePath: newPath,
      originalFileName: origName,
      contentType: file.type || null,
      updatedAt: serverTimestamp(),
      updatedByUid: (auth.currentUser && auth.currentUser.uid) || null
    };
    await setDoc(doc(db, MASTER_COLLECTION, key), payload, { merge:true });

    // æ—§ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ï¼ˆãƒ‘ã‚¹ãŒé•ã†å ´åˆã®ã¿ï¼‰
    if(oldPath && oldPath !== newPath){
      try{
        await deleteObject(ref(storage, oldPath));
      }catch(e){
        console.warn("delete old storage file failed:", e);
      }
    }

    return { imagePath: newPath, downloadUrl };
  };

  // ===== ç”»åƒãƒã‚¹ã‚¿å‰Šé™¤ï¼šFirestore + Storage =====
  window.__deleteMaster = async (seiriNo) => {
    const key = String(seiriNo||"").trim();
    if(!key) throw new Error("seiriNo required");

    // Firestoreã‹ã‚‰imagePathå–å¾—
    let path = null;
    const snap = await getDoc(doc(db, MASTER_COLLECTION, key));
    if(snap.exists()){
      const data = snap.data() || {};
      if(data.imagePath) path = String(data.imagePath);
    }

    // Storageå‰Šé™¤ï¼ˆå­˜åœ¨ã—ãªãã¦ã‚‚OKæ‰±ã„ï¼‰
    if(path){
      try{ await deleteObject(ref(storage, path)); }
      catch(e){ console.warn("delete storage failed:", e); }
    }

    // Firestoreå‰Šé™¤
    await deleteDoc(doc(db, MASTER_COLLECTION, key));
  };

  // ===== ç”»åƒãƒã‚¹ã‚¿ä¸€è¦§å–å¾—ï¼šimageMasters å…¨ä»¶ =====
  window.__listImageMaster = async () => {
    try{
      const colRef = collection(db, MASTER_COLLECTION);
      const snap = await getDocs(colRef);

      const list = [];
      for(const d of snap.docs){
        const data = d.data() || {};
        let downloadUrl = null;

        if(data.imagePath){
          try{ downloadUrl = await getDownloadURL(ref(storage, data.imagePath)); }
          catch(e){ console.warn(`getDownloadURL failed for ${d.id}:`, e); }
        }

        list.push({
          seiriNo: d.id,
          imagePath: data.imagePath || null,
          originalFileName: data.originalFileName || null,
          downloadUrl
        });
      }

      list.sort((a,b)=>a.seiriNo.localeCompare(b.seiriNo));
      return list;
    }catch(e){
      console.warn("listImageMaster error:", e);
      return [];
    }
  };

  // èµ·å‹•ç›´å¾Œï¼šä¸€è¦§æ›´æ–°ï¼ˆémoduleå´ã®loadListã‚’å©ãï¼‰
  try{
    const fn = window.loadList || null;
    // loadListã¯ã‚¹ã‚³ãƒ¼ãƒ—å¤–ãªã®ã§ã€ãƒœã‚¿ãƒ³ã‚’æ“¬ä¼¼ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ›´æ–°
    document.getElementById("btnRefresh").click();
  }catch(e){
    console.warn(e);
  }
</script>
</body>
</html>
