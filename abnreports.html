<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>出荷作業 異常履歴管理（RTDB版）</title>
<style>
  body{margin:0;font-family:Arial, sans-serif;background:#f5f7fb;}
  .hidden{display:none!important}
  .container{max-width:1200px;margin:20px auto;padding:10px}
  .card{background:#fff;border-radius:10px;padding:16px;margin-bottom:16px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  button{padding:8px 12px;border-radius:6px;border:1px solid #aaa;cursor:pointer;}
  button.brand{background:#6366f1;color:#fff;border:none}
  input,select,textarea{width:100%;padding:8px;margin:4px 0 10px;border-radius:6px;border:1px solid #ddd;}
  img.thumb{width:100px;height:100px;object-fit:cover;border-radius:6px;margin-right:6px;margin-bottom:6px;}
</style>
</head>
<body>

<!-- ✅ サインインモーダル -->
<div id="authModal" style="position:fixed; inset:0; background:rgba(0,0,0,.4); display:flex; align-items:center; justify-content:center;">
  <div style="background:#fff;padding:20px;border-radius:10px; width:90%;max-width:380px;">
    <h2>サインイン</h2>
    <input id="email" type="email" placeholder="メール"/>
    <input id="password" type="password" placeholder="パスワード"/>
    <button id="btnSignIn" class="brand">サインイン</button>
    <button id="btnRegister">新規登録</button>
    <div id="authMsg" style="margin-top:8px;color:#e11;"></div>
  </div>
</div>

<!-- ✅ アプリ本体 -->
<div id="app" class="container hidden">

  <div class="card">
    <h2>出荷作業 異常履歴管理（RTDB版）</h2>
    <div id="loginInfo"></div>
    <button id="btnSignOut">サインアウト</button>
  </div>

  <!-- 製造入力 -->
  <div class="card">
    <h3>製造入力</h3>
    <label>部署</label><input id="mfgDepartment">
    <label>ライン</label><input id="mfgLine">
    <label>発生日</label><input id="occurAt" type="datetime-local">
    <label>作業者</label><input id="mfgOperator">
    <label>分類</label>
    <select id="mfgCategory">
      <option>品違い</option><option>数量違い</option>
      <option>ラベル不備</option><option>作業ミス</option><option>その他</option>
    </select>
    <label>現象</label><textarea id="mfgDetail"></textarea>
    <label>一次処置</label><textarea id="mfgAction"></textarea>
    <label>写真</label><input id="mfgPhotos" type="file" accept="image/*" multiple>
    <button id="btnMfgSubmit" class="brand">登録</button>
    <div id="mfgMsg"></div>
  </div>

  <!-- 履歴 -->
  <div class="card">
    <h3>履歴（最新50件）</h3>
    <div id="history"></div>
  </div>
</div>

<script type="module">
  /* ✅ Firebase SDK */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getDatabase, ref, set, push, update, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
  import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

  /* ✅ あなたの実プロジェクト設定（確定版） */
  const firebaseConfig = {
    apiKey: "AIzaSyA0YUIpIDh4WB4p1ewiNB0XfwHve0ByljU",
    authDomain: "abnreport-fd733.firebaseapp.com",
    databaseURL: "https://abnreport-fd733-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "abnreport-fd733",
    storageBucket: "abnreport-fd733.appspot.com"
  };

  /* ✅ Init */
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const storage = getStorage(app);

  /* ✅ DOM */
  const $ = id => document.getElementById(id);
  const el = {
    authModal:$("authModal"), app:$("app"),
    email:$("email"), password:$("password"), btnSignIn:$("btnSignIn"), btnRegister:$("btnRegister"), btnSignOut:$("btnSignOut"), authMsg:$("authMsg"), loginInfo:$("loginInfo"),
    mfgDepartment:$("mfgDepartment"), mfgLine:$("mfgLine"), occurAt:$("occurAt"), mfgOperator:$("mfgOperator"), mfgCategory:$("mfgCategory"), mfgDetail:$("mfgDetail"), mfgAction:$("mfgAction"), mfgPhotos:$("mfgPhotos"), btnMfgSubmit:$("btnMfgSubmit"), mfgMsg:$("mfgMsg"),
    history:$("history")
  };

  /* ✅ 認証 */
  el.btnSignIn.onclick = async ()=>{
    el.authMsg.textContent="送信中…";
    try{
      await signInWithEmailAndPassword(auth, el.email.value, el.password.value);
    }catch(e){
      el.authMsg.textContent = "失敗:" + e.code;
    }
  };
  el.btnRegister.onclick = async ()=>{
    try{
      await createUserWithEmailAndPassword(auth, el.email.value, el.password.value);
    }catch(e){ el.authMsg.textContent="登録失敗:"+e.code; }
  };
  el.btnSignOut.onclick = ()=>{ signOut(auth); };

  onAuthStateChanged(auth, user=>{
    console.log("auth:", !!user);
    if(user){
      el.authModal.classList.add("hidden");
      el.app.classList.remove("hidden");
      el.loginInfo.textContent = user.email;
      subscribeAnomalies();
    }else{
      el.app.classList.add("hidden");
      el.authModal.classList.remove("hidden");
    }
  });

  /* ✅ 異常履歴 監視表示 */
  function subscribeAnomalies(){
    onValue(ref(db,"anomalies"), snap=>{
      const obj = snap.val()||{};
      const arr = Object.entries(obj).map(([id,v])=>({_id:id,...v}));
      arr.sort((a,b)=> (b.occurrenceDate||"").localeCompare(a.occurrenceDate||""));
      el.history.innerHTML = arr.slice(0,50).map(x=>renderItem(x)).join("");
    });
  }

  function renderItem(x){
    const imgs = [...(x.mfgPhotoUrls||[])].map(u=>`<img class="thumb" src="${u}">`).join("");
    return `<div style="border-bottom:1px solid #ddd; margin-bottom:10px">
      <strong>${x.category||""}</strong> ${x.department||""}/${x.line||""}
      <div>${x.detail||""}</div>
      <div>${imgs}</div>
    </div>`;
  }

  /* ✅ 画像アップロード付き登録 */
  el.btnMfgSubmit.onclick = async ()=>{
    el.mfgMsg.textContent="登録中…";
    try{
      const base = {
        department:el.mfgDepartment.value,
        line:el.mfgLine.value,
        operator:el.mfgOperator.value,
        category:el.mfgCategory.value,
        detail:el.mfgDetail.value,
        action:el.mfgAction.value,
        occurrenceDate:el.occurAt.value,
        createdAt:serverTimestamp(),
        createdBy:auth.currentUser.uid
      };

      const newRef = push(ref(db,"anomalies"));
      const id = newRef.key;
      await set(newRef, base);

      const files = Array.from(el.mfgPhotos.files||[]);
      if(files.length){
        const urls = await uploadPhotos(id,"mfg",files);
        await update(sRef(db,"anomalies/"+id),{}); // dummy
        await update(ref(db,"anomalies/"+id),{mfgPhotoUrls:urls});
      }

      el.mfgMsg.textContent="OK";
      el.mfgDetail.value=""; el.mfgAction.value=""; el.mfgPhotos.value="";
    }catch(e){
      console.error(e);
      el.mfgMsg.textContent="ERROR:"+e.message;
    }
  };

  async function uploadPhotos(id,folder,files){
    const urls=[];
    for(const f of files){
      const key = Date.now()+"_"+(f.name||"img").replace(/[^\w\-.]+/g,"_");
      const r = sRef(storage,`anomalies/${id}/${folder}/${key}`);
      console.log("[UPLOAD try]",id,folder,key);

      await new Promise((res,rej)=>{
        const task = uploadBytesResumable(r,f);
        task.on('state_changed',()=>{},rej,async()=>{
          const url = await getDownloadURL(task.snapshot.ref);
          urls.push(url);
          res();
        });
      });
    }
    return urls;
  }

  /* 初期値 */
  el.occurAt.value = new Date().toISOString().slice(0,16);
</script>

</body>
</html>
