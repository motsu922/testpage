<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•°å¸¸å±¥æ­´å…¥åŠ›ãƒ„ãƒ¼ãƒ«ï¼ˆFirebaseé€£æºç‰ˆï¼‰</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Hiragino Sans',sans-serif;background:#f5f5f5}
  .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  .header h1{font-size:1.5rem;margin-bottom:5px}
  .container{max-width:900px;margin:0 auto;padding:10px}
  .tabs{display:flex;background:#fff;margin:15px 0 0;border-radius:8px 8px 0 0;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,.1)}
  .tab{flex:1;padding:15px;text-align:center;cursor:pointer;background:#f8f9fa;border:none;font-size:1rem;font-weight:bold;transition:.3s;color:#666}
  .tab.active{background:#fff;color:#667eea;border-bottom:3px solid #667eea}
  .tab-content{display:none;background:#fff;padding:20px;border-radius:0 0 8px 8px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  .tab-content.active{display:block}
  .form-group{margin-bottom:20px}
  .form-group label{display:block;margin-bottom:8px;font-weight:bold;color:#333;font-size:.95rem}
  .form-group input,.form-group textarea,.form-group select{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:6px;font-size:1rem;transition:border-color .3s}
  .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:#667eea}
  .form-group textarea{min-height:100px;resize:vertical}
  .time-group{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .photo-upload{border:2px dashed #e0e0e0;border-radius:6px;padding:20px;text-align:center;cursor:pointer;transition:.3s}
  .photo-upload:hover{border-color:#667eea;background:#f8f9ff}
  .photo-upload input[type=file]{display:none}
  .photo-preview{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-top:15px}
  .photo-item{position:relative;aspect-ratio:1;border-radius:6px;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,.1)}
  .photo-item img{width:100%;height:100%;object-fit:cover}
  .photo-item .remove-btn{position:absolute;top:5px;right:5px;background:rgba(255,59,48,.9);color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:14px;line-height:1}
  .btn{width:100%;padding:15px;border:none;border-radius:6px;font-size:1rem;font-weight:bold;cursor:pointer;transition:.3s;margin-top:10px}
  .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
  .btn-secondary{background:#6c757d;color:#fff}
  .btn-export{background:#28a745;color:#fff}
  .history-controls{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
  .view-toggle{display:flex;gap:5px}
  .view-toggle button{padding:8px 15px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:6px;cursor:pointer;font-weight:bold}
  .view-toggle button.active{background:#667eea;color:#fff}
  .card-view{display:grid;gap:15px}
  .anomaly-card{background:#fff;border-radius:8px;padding:15px;box-shadow:0 2px 8px rgba(0,0,0,.1);border-left:4px solid #667eea}
  .anomaly-card.complete{border-left-color:#28a745}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #e0e0e0}
  .card-id{font-size:1.2rem;font-weight:bold;color:#667eea}
  .card-status{padding:4px 12px;border-radius:12px;font-size:.85rem;font-weight:bold}
  .status-pending{background:#fff3cd;color:#856404}
  .status-complete{background:#d4edda;color:#155724}
  .card-body{display:grid;gap:8px}
  .card-field{display:grid;grid-template-columns:120px 1fr;gap:10px}
  .field-label{font-weight:bold;color:#666}
  .field-value{color:#333}
  .table-view{overflow-x:auto;display:none}
  .table-view.active{display:block}
  table{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.1)}
  th,td{padding:12px;text-align:left;border-bottom:1px solid #e0e0e0}
  th{background:#667eea;color:#fff;font-weight:bold;position:sticky;top:0}
  tr:hover{background:#f8f9ff}
  .action-btns{display:flex;gap:6px;flex-wrap:wrap}
  .btn-small{padding:6px 10px;border:none;border-radius:4px;cursor:pointer;font-size:.85rem}
  .btn-edit{background:#ffc107;color:#000}
  .btn-delete{background:#dc3545;color:#fff}
  .empty-state{text-align:center;padding:40px 20px;color:#999}
  .empty-state-icon{font-size:3rem;margin-bottom:15px}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
  .modal.active{display:flex}
  .modal-content{background:#fff;padding:20px;border-radius:8px;max-width:680px;width:95%;max-height:90vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .modal-title{font-size:1.1rem;font-weight:bold;margin-bottom:10px;color:#333}
  .edit-tabs{display:flex;gap:8px;margin:8px 0 16px}
  .edit-tab{flex:1;padding:10px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:6px;cursor:pointer;font-weight:bold}
  .edit-tab.active{background:#667eea;color:#fff}
  .modal-actions{display:flex;gap:10px;margin-top:10px}
  .btn-cancel{background:#9e9e9e;color:#fff}
  @media (max-width:600px){
    .card-field{grid-template-columns:1fr;gap:5px}
    .time-group{grid-template-columns:1fr}
    table{font-size:.85rem}
    th,td{padding:8px}
  }
  #authGate{position:fixed;inset:0;background:#f5f5f5;display:flex;align-items:center;justify-content:center;z-index:2000}
  #authCard{background:#fff;max-width:380px;width:92%;padding:24px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
  #signOutBtn{position:fixed;right:12px;top:12px;background:#ef5350;color:#fff;border:none;border-radius:6px;padding:8px 12px;cursor:pointer;z-index:1500}
  
  /* ãƒ¯ãƒ¼ãƒ‰å€™è£œã‚¹ã‚¿ã‚¤ãƒ« */
  .word-suggestions{position:relative;}
  .word-suggestion-box{position:absolute;z-index:100;background:#fff;border:2px solid #667eea;border-radius:8px;padding:10px;max-height:300px;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,.15);display:none;width:100%;margin-top:5px;}
  .word-suggestion-box.active{display:block;}
  .word-suggestion-header{font-size:.85rem;color:#667eea;font-weight:bold;margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid #e0e0e0;}
  .word-tag{display:inline-block;background:#f0f7ff;color:#667eea;padding:6px 12px;margin:3px;border-radius:16px;cursor:pointer;font-size:.85rem;transition:.2s;border:1px solid #e3f2fd;}
  .word-tag:hover{background:#667eea;color:#fff;transform:translateY(-2px);box-shadow:0 2px 8px rgba(102,126,234,.3);}
  
  /* é¡ä¼¼æ¡ˆä»¶è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */
  .similar-cases-box{background:#fff4e6;border:2px solid #f57c00;border-radius:8px;padding:15px;margin-bottom:20px;display:none;}
  .similar-cases-box.active{display:block;}
  .similar-cases-header{color:#f57c00;font-weight:bold;margin-bottom:15px;font-size:1rem;display:flex;align-items:center;gap:8px;}
  .similar-case-item{background:#fff;border-left:3px solid #f57c00;border-radius:6px;padding:12px;margin-bottom:10px;}
  .similar-case-item:last-child{margin-bottom:0;}
  .similar-case-date{font-weight:bold;color:#f57c00;margin-bottom:8px;font-size:.95rem;}
  .similar-case-content{font-size:.9rem;color:#333;line-height:1.5;margin-bottom:8px;}
  .similar-case-tech{margin-top:8px;padding-top:8px;border-top:1px solid #ffe0b2;font-size:.9rem;color:#666;}
  .similar-case-tech strong{color:#f57c00;}
  .show-more-btn{width:100%;padding:10px;background:#fff;color:#f57c00;border:2px solid #f57c00;border-radius:6px;font-weight:bold;cursor:pointer;transition:.2s;margin-top:10px;}
  .show-more-btn:hover{background:#f57c00;color:#fff;}
  
  /* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
  .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;border-radius:8px;text-align:center;}
  .stat-card h4{font-size:.9rem;margin-bottom:10px;opacity:.9;}
  .stat-value{font-size:2.5rem;font-weight:bold;margin-bottom:5px;}
  .stat-label{font-size:.85rem;opacity:.8;}
  .chart-bar{background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);height:30px;display:flex;align-items:center;padding:0 10px;color:#fff;font-weight:bold;border-radius:4px;transition:.3s;}
  .analysis-insight{border-left:4px solid #2196f3;padding:15px;border-radius:6px;background:#e3f2fd;line-height:1.6;}
  .trend-badge{display:inline-block;padding:3px 12px;border-radius:12px;font-weight:bold;margin:0 5px;}
  .trend-increase{background:#ffebee;color:#c62828;}
  .trend-decrease{background:#e8f5e9;color:#2e7d32;}
  .trend-stable{background:#fff3e0;color:#ef6c00;}
</style>
</head>
<body>
  <button id="signOutBtn" style="display:none;">ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ</button>
  <div id="authGate">
    <div id="authCard">
      <h2 style="margin-bottom:10px;color:#667eea;">ğŸ” ã‚µã‚¤ãƒ³ã‚¤ãƒ³</h2>
      <p style="color:#666;margin-bottom:15px;">ç¤¾å†…ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
      <div class="form-group">
        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="email" id="authEmail" placeholder="user@miyama-unitec.co.jp">
      </div>
      <div class="form-group">
        <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="authPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <button class="btn btn-primary" id="authLoginBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <p id="authMsg" style="color:#c62828;margin-top:10px;"></p>
    </div>
  </div>

  <div class="header">
    <h1>ğŸ“‹ ç•°å¸¸å±¥æ­´å…¥åŠ›ãƒ„ãƒ¼ãƒ«</h1>
    <p>Firebaseé€£æºç‰ˆï¼ˆAuth / Firestore / Storageï¼‰</p>
  </div>

  <div class="container" style="display:none" id="appRoot">
    <div class="tabs">
      <button class="tab active" data-tab="manufacturing">è£½é€ å…¥åŠ›</button>
      <button class="tab" data-tab="technical">æŠ€è¡“å…¥åŠ›</button>
      <button class="tab" data-tab="history">å±¥æ­´</button>
      <button class="tab" data-tab="analysis">ğŸ“Š åˆ†æ</button>
      <button class="tab" data-tab="master">âš™ï¸ ç®¡ç†</button>
    </div>

    <!-- è£½é€ å…¥åŠ› -->
    <div id="manufacturing" class="tab-content active">
      <h2 style="margin-bottom:20px;color:#667eea;">è£½é€ éƒ¨é–€ - ç•°å¸¸å ±å‘Š</h2>
      <form id="manufacturingForm">
        <div style="background:#f0f7ff;padding:15px;border-radius:6px;margin-bottom:20px;">
          <h3 style="color:#667eea;margin-bottom:15px;font-size:1.1rem;">ğŸ“… ã„ã¤</h3>
          <div class="form-group">
            <label>ç™ºç”Ÿæ—¥ *</label>
            <div style="display:flex;gap:10px;">
              <input type="date" id="occurrenceDate" required style="flex:1;">
              <button type="button" class="btn btn-secondary" style="width:auto;padding:12px 20px;margin:0;background:#17a2b8;" id="btnNowDate">ğŸ“… NOW</button>
            </div>
          </div>
          <div class="form-group">
            <label>æ™‚åˆ»</label>
            <div class="time-group">
              <div>
                <label style="font-weight:normal;font-size:.9rem;">ç™ºç”Ÿæ™‚åˆ»</label>
                <div style="display:flex;gap:5px;">
                  <input type="time" id="occurrenceTime" style="flex:1;">
                  <button type="button" class="btn btn-secondary" style="width:auto;padding:8px 12px;margin:0;font-size:.85rem;background:#17a2b8;" data-now="occurrenceTime">NOW</button>
                </div>
              </div>
              <div>
                <label style="font-weight:normal;font-size:.9rem;">å†é–‹æ™‚åˆ»</label>
                <div style="display:flex;gap:5px;">
                  <input type="time" id="restartTime" style="flex:1;">
                  <button type="button" class="btn btn-secondary" style="width:auto;padding:8px 12px;margin:0;font-size:.85rem;background:#17a2b8;" data-now="restartTime">NOW</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="background:#fff4e6;padding:15px;border-radius:6px;margin-bottom:20px;">
          <h3 style="color:#f57c00;margin-bottom:15px;font-size:1.1rem;">ğŸ“ ã©ã“ã§</h3>
          <div class="form-group"><label>éƒ¨ç½² *</label><select id="department" required></select></div>
          <div class="form-group"><label>ãƒ©ã‚¤ãƒ³å *</label><select id="lineName" required><option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option></select></div>
          <div class="form-group"><label>å‡¦ç½®è€… *</label><select id="handler" required><option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option></select></div>
        </div>

        <div style="background:#f3e5f5;padding:15px;border-radius:6px;margin-bottom:20px;">
          <h3 style="color:#8e24aa;margin-bottom:15px;font-size:1.1rem;">ğŸ”¢ æ•´ç†No</h3>
          <div class="form-group"><label>æ•´ç†No *</label><input type="text" id="serialNo" required placeholder="ä¾‹: 2024-001"></div>
        </div>

        <div style="background:#e8f5e9;padding:15px;border-radius:6px;margin-bottom:20px;">
          <h3 style="color:#2e7d32;margin-bottom:15px;font-size:1.1rem;">ğŸ“ ä½•ãŒã‚ã£ãŸ</h3>
          
          <div class="form-group word-suggestions">
            <label>ç•°å¸¸å†…å®¹ *</label>
            <textarea id="anomalyContent" required></textarea>
            <!-- ãƒ¯ãƒ¼ãƒ‰å€™è£œ -->
            <div id="anomalyWordSuggestions" class="word-suggestion-box">
              <div class="word-suggestion-header">ğŸ’¡ ã‚ˆãä½¿ã‚ã‚Œã‚‹è¡¨ç¾ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ï¼‰</div>
              <div id="anomalyWords"></div>
            </div>
          </div>
          
          <div class="form-group word-suggestions">
            <label>è£½é€ å‡¦ç½®å†…å®¹ *</label>
            <textarea id="actionTaken" required></textarea>
            <!-- ãƒ¯ãƒ¼ãƒ‰å€™è£œ -->
            <div id="actionWordSuggestions" class="word-suggestion-box">
              <div class="word-suggestion-header">ğŸ’¡ ã‚ˆãä½¿ã‚ã‚Œã‚‹è¡¨ç¾ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ï¼‰</div>
              <div id="actionWords"></div>
            </div>
          </div>
          <div class="form-group"><label>é¡ã‚Š *</label>
            <select id="traceback" required><option value="">é¸æŠ</option><option value="æœ‰">æœ‰</option><option value="ç„¡">ç„¡</option></select>
          </div>
          <div class="form-group"><label>æŠ€è¡“è¦è«‹ *</label>
            <select id="techRequest" required>
              <option value="">é¸æŠ</option><option value="è¦è«‹">æŠ€è¡“è¦è«‹ã‚ã‚Š</option><option value="å®Œçµ">è£½é€ ã§å®Œçµ</option>
            </select>
          </div>
          <div class="form-group">
            <label>å†™çœŸ</label>
            <div class="photo-upload" onclick="document.getElementById('mfgPhotos').click()">
              <div style="font-size:2rem;">ğŸ“¸</div><p>å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</p>
              <input type="file" id="mfgPhotos" accept="image/*" multiple>
            </div>
            <div id="mfgPhotoPreview" class="photo-preview"></div>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
      </form>
    </div>

    <!-- æŠ€è¡“å…¥åŠ› -->
    <div id="technical" class="tab-content">
      <h2 style="margin-bottom:20px;color:#667eea;">æŠ€è¡“éƒ¨é–€ - è¿½åŠ å…¥åŠ›</h2>
      
      <div class="form-group">
        <label>å¯¾è±¡ã®æ¡ˆä»¶é¸æŠ *</label>
        <select id="selectSerialNo"><option value="">æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„</option></select>
      </div>
      
      <!-- é¡ä¼¼æ¡ˆä»¶è‡ªå‹•è¡¨ç¤º -->
      <div id="similarCasesBox" class="similar-cases-box">
        <div class="similar-cases-header">ğŸ” åŒã˜æ•´ç†Noã®éå»å¯¾å¿œäº‹ä¾‹</div>
        <div id="similarCasesContent"></div>
        <button type="button" id="showMoreCases" class="show-more-btn" style="display:none;">ä»–ã®é¡ä¼¼æ¡ˆä»¶ã‚’è¡¨ç¤º</button>
      </div>
      
      <div id="selectedDataDisplay" style="background:#f8f9ff;padding:15px;border-radius:6px;margin-bottom:20px;display:none;">
        <h3 style="color:#667eea;margin-bottom:10px;">è£½é€ éƒ¨é–€å…¥åŠ›å†…å®¹</h3>
        <div id="displayContent"></div>
      </div>
      
      <form id="technicalForm">
        <div class="form-group"><label>æŠ€è¡“å‡¦ç½®è€… *</label><input type="text" id="techHandler"></div>
        <div class="form-group"><label>å‘½æ•°æœ‰ç„¡ *</label><select id="lifespan"><option value="">é¸æŠ</option><option value="æœ‰">æœ‰</option><option value="ç„¡">ç„¡</option></select></div>
        <div class="form-group"><label>ä¿å…¨å˜ä½</label><input type="text" id="maintenanceUnit"></div>
        <div class="form-group"><label>ä½•ãŒæ‚ªãã©ã†ã—ãŸ</label><textarea id="rootCauseAction"></textarea></div>
        <div class="form-group"><label>å†ç™ºã‹æ–°è¦ã‹ *</label><select id="recurrenceType"><option value="">é¸æŠ</option><option value="å†ç™º">å†ç™º</option><option value="æ–°è¦">æ–°è¦</option></select></div>
        <div class="form-group">
          <label>å†™çœŸ</label>
          <div class="photo-upload" onclick="document.getElementById('techPhotos').click()">
            <div style="font-size:2rem;">ğŸ“¸</div><p>å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</p>
            <input type="file" id="techPhotos" accept="image/*" multiple>
          </div>
          <div id="techPhotoPreview" class="photo-preview"></div>
        </div>
        <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
      </form>
    </div>

    <!-- å±¥æ­´ -->
    <div id="history" class="tab-content">
      <h2 style="margin-bottom:20px;color:#667eea;">ç•°å¸¸å±¥æ­´</h2>
      <div class="history-controls">
        <div class="view-toggle"><button class="active" data-view="card">ã‚«ãƒ¼ãƒ‰</button><button data-view="table">ãƒ†ãƒ¼ãƒ–ãƒ«</button></div>
        <button class="btn btn-export" style="flex:1;" id="btnExport">ğŸ“¥ CSVå‡ºåŠ›</button>
      </div>
      <div id="cardView" class="card-view"></div>
      <div id="tableView" class="table-view"></div>
    </div>

    <!-- åˆ†æ -->
    <div id="analysis" class="tab-content">
      <h2 style="margin-bottom:20px;color:#ff9800;">ğŸ“Š ç•°å¸¸ãƒ‡ãƒ¼ã‚¿åˆ†æ</h2>
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#ff9800;margin-bottom:15px;">ğŸ“ˆ çµ±è¨ˆæƒ…å ±</h3>
        <div id="statisticsDisplay" style="display:grid;gap:15px;"></div>
      </div>
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#ff9800;margin-bottom:15px;">ğŸ“Š æœˆåˆ¥å‚¾å‘åˆ†æ</h3>
        <div id="trendChart" style="min-height:300px;"></div>
        <div id="trendAnalysis" style="margin-top:15px;"></div>
      </div>
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#ff9800;margin-bottom:15px;">ğŸ¢ éƒ¨ç½²ãƒ»ãƒ©ã‚¤ãƒ³åˆ¥åˆ†æ</h3>
        <div id="departmentAnalysis" style="display:grid;gap:15px;"></div>
      </div>
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);">
        <h3 style="color:#ff9800;margin-bottom:15px;">ğŸ”„ å†ç™ºãƒ»æ–°è¦åˆ†æ</h3>
        <div id="recurrenceAnalysis"></div>
      </div>
    </div>

    <!-- ç®¡ç† -->
    <div id="master" class="tab-content">
      <h2 style="margin-bottom:20px;color:#667eea;">âš™ï¸ ãƒã‚¹ã‚¿ç®¡ç†</h2>
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#667eea;margin-bottom:15px;">éƒ¨ç½²ç®¡ç†</h3>
        <div style="display:flex;gap:10px;margin-bottom:15px;">
          <input type="text" id="newDepartment" placeholder="æ–°ã—ã„éƒ¨ç½²å" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button class="btn btn-primary" style="width:auto;padding:10px 20px;margin:0;" id="btnAddDept">è¿½åŠ </button>
        </div>
        <div id="departmentList" style="display:grid;gap:10px;"></div>
      </div>

      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#f57c00;margin-bottom:15px;">ãƒ©ã‚¤ãƒ³åç®¡ç†</h3>
        <div class="form-group"><label>å¯¾è±¡éƒ¨ç½²</label><select id="lineManageDept"><option value="">éƒ¨ç½²ã‚’é¸æŠ</option></select></div>
        <div style="display:flex;gap:10px;margin-bottom:15px;">
          <input type="text" id="newLine" placeholder="æ–°ã—ã„ãƒ©ã‚¤ãƒ³å" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button class="btn btn-primary" style="width:auto;padding:10px 20px;margin:0;background:#f57c00;" id="btnAddLine">è¿½åŠ </button>
        </div>
        <div id="lineList" style="display:grid;gap:10px;"></div>
      </div>

      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);">
        <h3 style="color:#2e7d32;margin-bottom:15px;">å‡¦ç½®è€…ç®¡ç†</h3>
        <div class="form-group"><label>å¯¾è±¡éƒ¨ç½²</label><select id="handlerManageDept"><option value="">éƒ¨ç½²ã‚’é¸æŠ</option></select></div>
        <div style="display:flex;gap:10px;margin-bottom:15px;">
          <input type="text" id="newHandler" placeholder="æ–°ã—ã„å‡¦ç½®è€…å" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button class="btn btn-primary" style="width:auto;padding:10px 20px;margin:0;background:#2e7d32;" id="btnAddHandler">è¿½åŠ </button>
        </div>
        <div id="handlerList" style="display:grid;gap:10px;"></div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
  import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy, updateDoc, doc, deleteDoc, serverTimestamp, where, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
  import { getStorage, ref, uploadBytes, getDownloadURL, listAll, deleteObject } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js';

  const firebaseConfig = {
    apiKey: "AIzaSyA0YUIpIDh4WB4p1ewiNB0XfwHve0ByljU",
    authDomain: "abnreport-fd733.firebaseapp.com",
    projectId: "abnreport-fd733",
    storageBucket: "abnreport-fd733.firebasestorage.app",
    messagingSenderId: "349748947315",
    appId: "1:349748947315:web:010cb671d2a95bcf1f7d06"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);
  enableIndexedDbPersistence(db).catch(()=>{});

  const gate = document.getElementById('authGate');
  const appRoot = document.getElementById('appRoot');
  const signOutBtn = document.getElementById('signOutBtn');
  
  document.getElementById('authLoginBtn').addEventListener('click', async ()=>{
    const email = (document.getElementById('authEmail').value||'').trim();
    const pw = document.getElementById('authPassword').value;
    try{
      await setPersistence(auth, browserLocalPersistence);
      await signInWithEmailAndPassword(auth, email, pw);
    }catch(e){
      document.getElementById('authMsg').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ' + (e.code||e.message);
    }
  });
  signOutBtn.addEventListener('click', ()=> signOut(auth));

  onAuthStateChanged(auth, (user)=>{
    if (user){
      gate.style.display='none';
      appRoot.style.display='block';
      signOutBtn.style.display='inline-block';
      bootAfterLogin();
    }else{
      appRoot.style.display='none';
      gate.style.display='flex';
      signOutBtn.style.display='none';
    }
  });

  let anomalyCache = [];
  let mfgPhotos = [];
  let techPhotos = [];
  let currentView='card';
  let mastersCache = null;

  async function fetchMasters(){
    const depSnap = await getDocs(collection(db,'masters','department','items'));
    const lineSnap= await getDocs(collection(db,'masters','line','items'));
    const hSnap   = await getDocs(collection(db,'masters','handler','items'));
    const departments = depSnap.docs.map(d=>d.data().name).sort();
    const lines = {};
    lineSnap.forEach(d=>{
      const {department,name} = d.data();
      if (!lines[department]) lines[department]=[];
      lines[department].push(name);
    });
    Object.keys(lines).forEach(k=> lines[k].sort());
    const handlers = {};
    hSnap.forEach(d=>{
      const {department,name} = d.data();
      if (!handlers[department]) handlers[department]=[];
      handlers[department].push(name);
    });
    Object.keys(handlers).forEach(k=> handlers[k].sort());
    return {departments, lines, handlers};
  }

  // ===== ãƒ¯ãƒ¼ãƒ‰å€™è£œæ©Ÿèƒ½ï¼ˆè£½é€ å…¥åŠ›ï¼‰=====
  function extractCommonWords(field){
    const words = {};
    anomalyCache.forEach(item => {
      const text = item[field] || '';
      // 2æ–‡å­—ä»¥ä¸Šã®å˜èªã‚’æŠ½å‡ºï¼ˆå¥èª­ç‚¹ã§åˆ†å‰²ï¼‰
      const segments = text.split(/[ã€‚ã€\n]/).filter(s => s.trim().length >= 2);
      segments.forEach(seg => {
        const trimmed = seg.trim();
        if (trimmed.length >= 2 && trimmed.length <= 50) {
          words[trimmed] = (words[trimmed] || 0) + 1;
        }
      });
    });
    
    // å‡ºç¾é »åº¦é †ã«ã‚½ãƒ¼ãƒˆã—ã¦ä¸Šä½20ä»¶ã‚’è¿”ã™
    return Object.entries(words)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 20)
      .map(([word]) => word);
  }
  
  function showWordSuggestions(targetId, suggestionsBoxId, wordsContainerId, field){
    const words = extractCommonWords(field);
    const box = document.getElementById(suggestionsBoxId);
    const container = document.getElementById(wordsContainerId);
    
    if (words.length === 0) {
      box.classList.remove('active');
      return;
    }
    
    container.innerHTML = words.map(word => 
      `<span class="word-tag" data-word="${word}">${word}</span>`
    ).join('');
    
    box.classList.add('active');
    
    // ã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ 
    container.querySelectorAll('.word-tag').forEach(tag => {
      tag.addEventListener('click', () => {
        const textarea = document.getElementById(targetId);
        const word = tag.getAttribute('data-word');
        const currentValue = textarea.value;
        
        // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«æŒ¿å…¥
        const cursorPos = textarea.selectionStart;
        const before = currentValue.substring(0, cursorPos);
        const after = currentValue.substring(cursorPos);
        
        // å‰ã®æ–‡å­—ãŒç©ºç™½ã§ãªã„å ´åˆã¯ç©ºç™½ã‚’è¿½åŠ 
        const needsSpace = before.length > 0 && !before.match(/[\sã€ã€‚\n]$/);
        const insertion = (needsSpace ? ' ' : '') + word;
        
        textarea.value = before + insertion + after;
        textarea.focus();
        textarea.selectionStart = textarea.selectionEnd = cursorPos + insertion.length;
      });
    });
  }
  
  // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«ãƒ¯ãƒ¼ãƒ‰å€™è£œã‚’è¡¨ç¤º
  document.getElementById('anomalyContent').addEventListener('focus', () => {
    showWordSuggestions('anomalyContent', 'anomalyWordSuggestions', 'anomalyWords', 'anomalyContent');
  });
  
  document.getElementById('actionTaken').addEventListener('focus', () => {
    showWordSuggestions('actionTaken', 'actionWordSuggestions', 'actionWords', 'actionTaken');
  });
  
  // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¢ã‚¦ãƒˆæ™‚ã«å€™è£œã‚’éè¡¨ç¤ºï¼ˆé…å»¶ã—ã¦ã€ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å„ªå…ˆï¼‰
  document.getElementById('anomalyContent').addEventListener('blur', () => {
    setTimeout(() => document.getElementById('anomalyWordSuggestions').classList.remove('active'), 200);
  });
  
  document.getElementById('actionTaken').addEventListener('blur', () => {
    setTimeout(() => document.getElementById('actionWordSuggestions').classList.remove('active'), 200);
  });

  // ===== é¡ä¼¼æ¡ˆä»¶è¡¨ç¤ºæ©Ÿèƒ½ï¼ˆæŠ€è¡“å…¥åŠ›ï¼‰=====
  let allSimilarCases = [];
  let showingAllCases = false;
  
  function showSimilarCases(selectedId){
    const selected = anomalyCache.find(x => x._id === selectedId);
    if (!selected || !selected.serialNo) {
      document.getElementById('similarCasesBox').classList.remove('active');
      return;
    }
    
    // åŒã˜æ•´ç†Noã§æŠ€è¡“å¯¾å¿œæ¸ˆã¿ã®ã‚‚ã®ï¼ˆé¸æŠä¸­ã®ã‚‚ã®ã‚’é™¤ãï¼‰
    allSimilarCases = anomalyCache
      .filter(x => 
        x._id !== selectedId && 
        x.serialNo === selected.serialNo && 
        x.status === 'complete' &&
        x.techRequest === 'è¦è«‹'
      )
      .sort((a,b) => (b.occurrenceDate||'').localeCompare(a.occurrenceDate||''));
    
    const box = document.getElementById('similarCasesBox');
    const content = document.getElementById('similarCasesContent');
    const showMoreBtn = document.getElementById('showMoreCases');
    
    if (allSimilarCases.length === 0) {
      box.classList.remove('active');
      return;
    }
    
    // æœ€åˆã¯ç›´è¿‘1ä»¶ã®ã¿è¡¨ç¤º
    const casesToShow = showingAllCases ? allSimilarCases : allSimilarCases.slice(0, 1);
    
    content.innerHTML = casesToShow.map(item => `
      <div class="similar-case-item">
        <div class="similar-case-date">ğŸ“… ${item.occurrenceDate || ''} ã®å¯¾å¿œäº‹ä¾‹</div>
        <div class="similar-case-content">
          <strong>ç•°å¸¸å†…å®¹:</strong> ${item.anomalyContent || '-'}<br>
          <strong>è£½é€ å‡¦ç½®:</strong> ${item.actionTaken || '-'}
        </div>
        <div class="similar-case-tech">
          <strong>ğŸ”§ æŠ€è¡“å¯¾å¿œå†…å®¹:</strong><br>
          ${item.rootCauseAction ? `åŸå› ãƒ»å¯¾ç­–: ${item.rootCauseAction}<br>` : ''}
          ${item.maintenanceUnit ? `ä¿å…¨å˜ä½: ${item.maintenanceUnit}<br>` : ''}
          ${item.recurrenceType ? `åˆ†é¡: ${item.recurrenceType}` : ''}
        </div>
      </div>
    `).join('');
    
    // ã€Œä»–ã®æ¡ˆä»¶ã‚’è¡¨ç¤ºã€ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
    if (allSimilarCases.length > 1 && !showingAllCases) {
      showMoreBtn.style.display = 'block';
      showMoreBtn.textContent = `ä»–ã®é¡ä¼¼æ¡ˆä»¶ã‚’è¡¨ç¤ºï¼ˆã‚ã¨${allSimilarCases.length - 1}ä»¶ï¼‰`;
    } else {
      showMoreBtn.style.display = 'none';
    }
    
    box.classList.add('active');
  }
  
  document.getElementById('showMoreCases').addEventListener('click', () => {
    showingAllCases = true;
    const selectedId = document.getElementById('selectSerialNo').value;
    if (selectedId) {
      showSimilarCases(selectedId);
    }
  });

  function setNowDateTo(id){
    const now = new Date(); const hour=now.getHours();
    if (hour>=0 && hour<6) now.setDate(now.getDate()-1);
    const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0');
    document.getElementById(id).value = `${y}-${m}-${d}`;
  }
  function setNowTimeTo(id){
    const now=new Date(); const hh=String(now.getHours()).padStart(2,'0'), mm=String(now.getMinutes()).padStart(2,'0');
    document.getElementById(id).value = `${hh}:${mm}`;
  }
  document.getElementById('btnNowDate').addEventListener('click', ()=>setNowDateTo('occurrenceDate'));
  document.querySelectorAll('button[data-now]').forEach(b=> b.addEventListener('click', ()=> setNowTimeTo(b.getAttribute('data-now')) ));

  function displayPhotos(previewId, arr){
    const wrap = document.getElementById(previewId); wrap.innerHTML='';
    arr.forEach((src,idx)=>{
      const div=document.createElement('div'); div.className='photo-item';
      div.innerHTML = `<img src="${src}"><button class="remove-btn" data-photo="${previewId}" data-index="${idx}">Ã—</button>`;
      wrap.appendChild(div);
    });
  }
  function handlePhotoUpload(inputId, previewId, arrRef){
    const input = document.getElementById(inputId);
    input.addEventListener('change',(e)=>{
      (Array.from(e.target.files||[])).forEach(file=>{
        const r=new FileReader();
        r.onload = ev=>{ arrRef.push({name:file.name, file, preview:ev.target.result}); displayPhotos(previewId, arrRef.map(x=>x.preview)); };
        r.readAsDataURL(file);
      });
      input.value='';
    });
  }
  handlePhotoUpload('mfgPhotos','mfgPhotoPreview', mfgPhotos);
  handlePhotoUpload('techPhotos','techPhotoPreview', techPhotos);
  document.addEventListener('click',(e)=>{
    const rm=e.target.closest('.remove-btn[data-photo]'); if(!rm) return;
    const id=rm.getAttribute('data-photo'); const idx=Number(rm.getAttribute('data-index'));
    if (id==='mfgPhotoPreview'){ mfgPhotos.splice(idx,1); displayPhotos(id, mfgPhotos.map(x=>x.preview)); }
    if (id==='techPhotoPreview'){ techPhotos.splice(idx,1); displayPhotos(id, techPhotos.map(x=>x.preview)); }
  });

  function updateDepartmentSelect(selectId, departments){
    const sel=document.getElementById(selectId); if(!sel) return;
    const keep=sel.value;
    sel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    departments.forEach(d=>{ const o=document.createElement('option'); o.value=o.textContent=d; sel.appendChild(o); });
    if (departments.includes(keep)) sel.value=keep;
  }
  function refreshLineAndHandler(deptSelId, lineSelId, handlerSelId, lines, handlers){
    const dept=document.getElementById(deptSelId).value;
    const lineSel=document.getElementById(lineSelId), handlerSel=document.getElementById(handlerSelId);
    lineSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    handlerSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    (lines[dept]||[]).forEach(l=>{ const o=document.createElement('option'); o.value=o.textContent=l; lineSel.appendChild(o); });
    (handlers[dept]||[]).forEach(h=>{ const o=document.createElement('option'); o.value=o.textContent=h; handlerSel.appendChild(o); });
  }

  function anomaliesRef(){ return collection(db,'anomalies'); }

  async function uploadPhotos(docId, kind, items){
    const urls=[];
    for (const it of items){
      const path=`anomalies/${docId}/${kind}/${Date.now()}_${it.name}`;
      const storageRef=ref(storage, path);
      await uploadBytes(storageRef, it.file);
      const url = await getDownloadURL(storageRef);
      urls.push(url);
    }
    return urls;
  }

  function renderHistory(){
    const items=[...anomalyCache].sort((a,b)=> (b.occurrenceDate||'').localeCompare(a.occurrenceDate||''));
    const cardWrap=document.getElementById('cardView');
    if (!items.length){
      cardWrap.innerHTML=`<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;
    }else{
      cardWrap.innerHTML = items.map((item)=>{
        const status = item.status==='pending' ? {text:'æŠ€è¡“å…¥åŠ›å¾…ã¡',cls:'status-pending'} :
                      (item.techRequest==='å®Œçµ' ? {text:'å®Œäº†ï¼ˆè£½é€ å®Œçµï¼‰',cls:'status-complete'} : {text:'å®Œäº†',cls:'status-complete'});
        return `
          <div class="anomaly-card ${item.status==='complete'?'complete':''}">
            <div class="card-header">
              <div class="card-id">${item.serialNo || '(No ID)'}</div>
              <div class="card-status ${status.cls}">${status.text}</div>
            </div>
            <div class="card-body">
              ${item.department?`<div class="card-field"><div class="field-label">éƒ¨ç½²</div><div class="field-value">${item.department}</div></div>`:''}
              ${item.lineName?`<div class="card-field"><div class="field-label">ãƒ©ã‚¤ãƒ³å</div><div class="field-value">${item.lineName}</div></div>`:''}
              ${item.techRequest?`<div class="card-field"><div class="field-label">æŠ€è¡“è¦è«‹</div><div class="field-value">${item.techRequest==='è¦è«‹'?'æŠ€è¡“è¦è«‹ã‚ã‚Š':'è£½é€ ã§å®Œçµ'}</div></div>`:''}
              <div class="card-field"><div class="field-label">ç•°å¸¸å†…å®¹</div><div class="field-value">${item.anomalyContent||''}</div></div>
              <div class="card-field"><div class="field-label">è£½é€ å‡¦ç½®</div><div class="field-value">${item.actionTaken||''}</div></div>
              <div class="card-field"><div class="field-label">ç™ºç”Ÿæ—¥æ™‚</div><div class="field-value">${item.occurrenceDate||''} ${item.occurrenceTime||''}</div></div>
              <div class="card-field"><div class="field-label">å‡¦ç½®è€…</div><div class="field-value">${item.handler||''}</div></div>
              ${item.status==='complete' && item.techRequest==='è¦è«‹' ? `
                <div class="card-field"><div class="field-label">æŠ€è¡“å‡¦ç½®è€…</div><div class="field-value">${item.techHandler||'-'}</div></div>
                <div class="card-field"><div class="field-label">ä¿å…¨å˜ä½</div><div class="field-value">${item.maintenanceUnit||'-'}</div></div>
                <div class="card-field"><div class="field-label">åŸå› ãƒ»å¯¾ç­–</div><div class="field-value">${item.rootCauseAction||'-'}</div></div>
                <div class="card-field"><div class="field-label">å†ç™º/æ–°è¦</div><div class="field-value">${item.recurrenceType||'-'}</div></div>
              `:''}
              <div class="action-btns" style="margin-top:10px;">
                <button class="btn-small btn-edit" data-edit="${item._id}">ç·¨é›†</button>
                <button class="btn-small btn-delete" data-del="${item._id}">å‰Šé™¤</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    const tableWrap=document.getElementById('tableView');
    if (!items.length){
      tableWrap.innerHTML=`<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;
    }else{
      tableWrap.innerHTML = `
        <table>
          <thead><tr>
            <th>æ•´ç†No</th><th>éƒ¨ç½²</th><th>ãƒ©ã‚¤ãƒ³</th><th>ç•°å¸¸å†…å®¹</th>
            <th>ç™ºç”Ÿæ—¥</th><th>å‡¦ç½®è€…</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th>
          </tr></thead>
          <tbody>
            ${items.map(it=>{
              const st = it.status==='complete'?'å®Œäº†':'å¾…ã¡';
              const cls = it.status==='complete'?'status-complete':'status-pending';
              return `
                <tr>
                  <td>${it.serialNo||''}</td>
                  <td>${it.department||'-'}</td>
                  <td>${it.lineName||'-'}</td>
                  <td>${(it.anomalyContent||'').slice(0,30)}...</td>
                  <td>${it.occurrenceDate||''}</td>
                  <td>${it.handler||'-'}</td>
                  <td><span class="card-status ${cls}">${st}</span></td>
                  <td class="action-btns">
                    <button class="btn-small btn-edit" data-edit="${it._id}">ç·¨é›†</button>
                    <button class="btn-small btn-delete" data-del="${it._id}">å‰Šé™¤</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }
  }

  function renderTechTargetSelect(){
    const sel = document.getElementById('selectSerialNo');
    sel.innerHTML = '<option value="">æ•´ç†Noã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    anomalyCache
      .filter(x=>x.status==='pending' && x.techRequest==='è¦è«‹')
      .sort((a,b)=> (b.occurrenceDate||'').localeCompare(a.occurrenceDate||''))
      .forEach(x=>{
        const o=document.createElement('option');
        o.value = x._id;
        o.textContent = `[${x.serialNo}] ${x.occurrenceDate} - ${x.anomalyContent?.slice(0,30)||''}...`;
        sel.appendChild(o);
      });
  }

  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      const targetId = tab.getAttribute('data-tab');
      document.getElementById(targetId).classList.add('active');
    });
  });

  async function bootAfterLogin(){
    mastersCache = await fetchMasters();
    
    updateDepartmentSelect('department', mastersCache.departments);
    updateDepartmentSelect('lineManageDept', mastersCache.departments);
    updateDepartmentSelect('handlerManageDept', mastersCache.departments);

    document.getElementById('department').addEventListener('change', ()=> {
      refreshLineAndHandler('department','lineName','handler', mastersCache.lines, mastersCache.handlers);
    });
    
    document.getElementById('lineManageDept').addEventListener('change', async ()=> {
      await updateLineManageList();
    });
    
    document.getElementById('handlerManageDept').addEventListener('change', async ()=> {
      await updateHandlerManageList();
    });

    const q = query(anomaliesRef(), orderBy('createdAt','desc'));
    onSnapshot(q, (snap)=>{
      anomalyCache = snap.docs.map(d=> ({_id:d.id, ...d.data()}));
      renderHistory();
      renderTechTargetSelect();
      updateAnalysis();
    });

    await updateDepartmentList();
    setNowDateTo('occurrenceDate');
  }

  document.getElementById('manufacturingForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const techReq = document.getElementById('techRequest').value;
    const base = {
      department: document.getElementById('department').value,
      lineName:   document.getElementById('lineName').value,
      serialNo:   document.getElementById('serialNo').value,
      occurrenceDate: document.getElementById('occurrenceDate').value,
      occurrenceTime: document.getElementById('occurrenceTime').value || '',
      restartTime:    document.getElementById('restartTime').value || '',
      anomalyContent: document.getElementById('anomalyContent').value,
      actionTaken:    document.getElementById('actionTaken').value,
      traceback:      document.getElementById('traceback').value,
      handler:        document.getElementById('handler').value,
      techRequest:    techReq,
      status:         techReq==='å®Œçµ' ? 'complete':'pending',
      createdAt:      serverTimestamp(),
      techHandler:'', lifespan:'', maintenanceUnit:'', rootCauseAction:'', recurrenceType:'',
      mfgPhotoUrls:[], techPhotoUrls:[]
    };
    const created = await addDoc(anomaliesRef(), base);
    let urls=[];
    if (mfgPhotos.length){
      urls = await uploadPhotos(created.id, 'mfg', mfgPhotos);
      await updateDoc(doc(db,'anomalies',created.id), { mfgPhotoUrls: urls });
    }

    e.target.reset(); mfgPhotos=[]; document.getElementById('mfgPhotoPreview').innerHTML='';
    document.getElementById('lineName').innerHTML='<option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>';
    document.getElementById('handler').innerHTML='<option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>';
    alert('ç™»éŒ²ã—ã¾ã—ãŸã€‚');
  });

  document.getElementById('selectSerialNo').addEventListener('change', ()=>{
    const id = document.getElementById('selectSerialNo').value;
    const d = anomalyCache.find(it=> it._id===id);
    const box=document.getElementById('selectedDataDisplay'), wrap=document.getElementById('displayContent');
    
    // é¡ä¼¼æ¡ˆä»¶è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
    showingAllCases = false;
    
    if (!d){ 
      box.style.display='none'; 
      wrap.innerHTML=''; 
      document.getElementById('similarCasesBox').classList.remove('active');
      return; 
    }
    
    wrap.innerHTML = `
      <div style="display:grid;gap:8px;">
        <div><strong>æ•´ç†No:</strong> ${d.serialNo}</div>
        ${d.department?`<div><strong>éƒ¨ç½²:</strong> ${d.department}</div>`:''}
        ${d.lineName?`<div><strong>ãƒ©ã‚¤ãƒ³å:</strong> ${d.lineName}</div>`:''}
        <div><strong>ç•°å¸¸å†…å®¹:</strong> ${d.anomalyContent||''}</div>
        <div><strong>è£½é€ å‡¦ç½®:</strong> ${d.actionTaken||''}</div>
        <div><strong>ç™ºç”Ÿæ—¥:</strong> ${d.occurrenceDate||''}</div>
        <div><strong>å‡¦ç½®è€…:</strong> ${d.handler||''}</div>
      </div>
    `;
    box.style.display='block';
    
    // é¡ä¼¼æ¡ˆä»¶ã‚’è‡ªå‹•è¡¨ç¤º
    showSimilarCases(id);
  });

  document.getElementById('technicalForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const id = document.getElementById('selectSerialNo').value;
    const updates = {
      techHandler: document.getElementById('techHandler').value,
      lifespan: document.getElementById('lifespan').value,
      maintenanceUnit: document.getElementById('maintenanceUnit').value,
      rootCauseAction: document.getElementById('rootCauseAction').value,
      recurrenceType: document.getElementById('recurrenceType').value,
      status: 'complete',
      completedAt: serverTimestamp()
    };
    if (techPhotos.length){
      const urls = await uploadPhotos(id,'tech', techPhotos);
      updates.techPhotoUrls = (anomalyCache.find(x=>x._id===id)?.techPhotoUrls||[]).concat(urls);
    }
    await updateDoc(doc(db,'anomalies',id), updates);
    e.target.reset(); techPhotos=[]; document.getElementById('techPhotoPreview').innerHTML='';
    document.getElementById('selectedDataDisplay').style.display='none';
    document.getElementById('similarCasesBox').classList.remove('active');
    showingAllCases = false;
    alert('æŠ€è¡“å…¥åŠ›ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚');
  });

  document.querySelectorAll('.view-toggle button').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.view-toggle button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active'); currentView=b.dataset.view;
      document.getElementById('cardView').style.display = currentView==='card'?'grid':'none';
      document.getElementById('tableView').style.display = currentView==='table'?'block':'none';
      renderHistory();
    });
  });

  const editModalHtml = `
    <div class="modal-content">
      <div class="modal-title">âœï¸ å±¥æ­´ãƒ¬ã‚³ãƒ¼ãƒ‰ç·¨é›†</div>
      <div class="edit-tabs">
        <button class="edit-tab active" data-edit-tab="mfg">è£½é€ </button>
        <button class="edit-tab" data-edit-tab="tech">æŠ€è¡“</button>
      </div>
      <div id="editMfg" class="edit-pane">
        <div class="form-group"><label>ç™ºç”Ÿæ—¥ *</label><input type="date" id="edit_occurrenceDate"></div>
        <div class="form-group"><label>ç™ºç”Ÿæ™‚åˆ» / å†é–‹æ™‚åˆ»</label><div class="time-group"><input type="time" id="edit_occurrenceTime"><input type="time" id="edit_restartTime"></div></div>
        <div class="form-group"><label>éƒ¨ç½² *</label><select id="edit_department"></select></div>
        <div class="form-group"><label>ãƒ©ã‚¤ãƒ³å *</label><select id="edit_lineName"></select></div>
        <div class="form-group"><label>å‡¦ç½®è€… *</label><select id="edit_handler"></select></div>
        <div class="form-group"><label>æ•´ç†No *</label><input type="text" id="edit_serialNo"></div>
        <div class="form-group"><label>ç•°å¸¸å†…å®¹ *</label><textarea id="edit_anomalyContent"></textarea></div>
        <div class="form-group"><label>è£½é€ å‡¦ç½®å†…å®¹ *</label><textarea id="edit_actionTaken"></textarea></div>
        <div class="form-group"><label>é¡ã‚Š *</label><select id="edit_traceback"><option value="">é¸æŠ</option><option value="æœ‰">æœ‰</option><option value="ç„¡">ç„¡</option></select></div>
        <div class="form-group"><label>æŠ€è¡“è¦è«‹ *</label><select id="edit_techRequest"><option value="">é¸æŠ</option><option value="è¦è«‹">æŠ€è¡“è¦è«‹ã‚ã‚Š</option><option value="å®Œçµ">è£½é€ ã§å®Œçµ</option></select></div>
      </div>
      <div id="editTech" class="edit-pane" style="display:none;">
        <div class="form-group"><label>æŠ€è¡“å‡¦ç½®è€…</label><input type="text" id="edit_techHandler"></div>
        <div class="form-group"><label>å‘½æ•°æœ‰ç„¡</label><select id="edit_lifespan"><option value="">é¸æŠ</option><option value="æœ‰">æœ‰</option><option value="ç„¡">ç„¡</option></select></div>
        <div class="form-group"><label>ä¿å…¨å˜ä½</label><input type="text" id="edit_maintenanceUnit"></div>
        <div class="form-group"><label>ä½•ãŒæ‚ªãã©ã†ã—ãŸ</label><textarea id="edit_rootCauseAction"></textarea></div>
        <div class="form-group"><label>å†ç™ºã‹æ–°è¦ã‹</label><select id="edit_recurrenceType"><option value="">é¸æŠ</option><option value="å†ç™º">å†ç™º</option><option value="æ–°è¦">æ–°è¦</option></select></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-cancel" id="btnEditCancel" style="flex:1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" id="btnEditSave" style="flex:1;">ä¿å­˜</button>
      </div>
    </div>`;
  const modal = document.createElement('div'); modal.className='modal'; modal.id='editModal'; modal.innerHTML=editModalHtml; document.body.appendChild(modal);

  let editCurrentId=null, editMastersCache=null;
  function openEdit(id){
    const rec = anomalyCache.find(x=>x._id===id); if(!rec){ alert('å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
    editCurrentId=id;
    (async ()=>{
      editMastersCache = mastersCache || await fetchMasters();
      const depSel = document.getElementById('edit_department'); depSel.innerHTML='';
      editMastersCache.departments.forEach(d=>{ const o=document.createElement('option'); o.value=o.textContent=d; depSel.appendChild(o); });
      depSel.value = rec.department||'';
      const lineSel=document.getElementById('edit_lineName'), hSel=document.getElementById('edit_handler');
      lineSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      (editMastersCache.lines[depSel.value]||[]).forEach(l=>{ const o=document.createElement('option'); o.value=o.textContent=l; lineSel.appendChild(o); });
      hSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      (editMastersCache.handlers[depSel.value]||[]).forEach(h=>{ const o=document.createElement('option'); o.value=o.textContent=h; hSel.appendChild(o); });

      lineSel.value = rec.lineName||'';
      hSel.value = rec.handler||'';

      document.getElementById('edit_occurrenceDate').value = rec.occurrenceDate||'';
      document.getElementById('edit_occurrenceTime').value = rec.occurrenceTime||'';
      document.getElementById('edit_restartTime').value   = rec.restartTime||'';
      document.getElementById('edit_serialNo').value      = rec.serialNo||'';
      document.getElementById('edit_anomalyContent').value= rec.anomalyContent||'';
      document.getElementById('edit_actionTaken').value   = rec.actionTaken||'';
      document.getElementById('edit_traceback').value     = rec.traceback||'';
      document.getElementById('edit_techRequest').value   = rec.techRequest||'';
      document.getElementById('edit_techHandler').value   = rec.techHandler||'';
      document.getElementById('edit_lifespan').value      = rec.lifespan||'';
      document.getElementById('edit_maintenanceUnit').value= rec.maintenanceUnit||'';
      document.getElementById('edit_rootCauseAction').value= rec.rootCauseAction||'';
      document.getElementById('edit_recurrenceType').value = rec.recurrenceType||'';
      modal.classList.add('active'); modal.setAttribute('aria-hidden','false');
    })();
  }
  document.addEventListener('change', (e)=>{
    if (e.target.id==='edit_department' && editMastersCache){
      const dep=e.target.value;
      const lineSel=document.getElementById('edit_lineName'), hSel=document.getElementById('edit_handler');
      lineSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      (editMastersCache.lines[dep]||[]).forEach(l=>{ const o=document.createElement('option'); o.value=o.textContent=l; lineSel.appendChild(o); });
      hSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      (editMastersCache.handlers[dep]||[]).forEach(h=>{ const o=document.createElement('option'); o.value=o.textContent=h; hSel.appendChild(o); });
    }
  });
  document.addEventListener('click', (e)=>{
    const t=e.target;
    if (t.matches('.edit-tab')){
      document.querySelectorAll('.edit-tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      document.getElementById('editMfg').style.display = t.dataset.editTab==='mfg'?'block':'none';
      document.getElementById('editTech').style.display= t.dataset.editTab==='tech'?'block':'none';
    }
    const ed = t.closest('button.btn-edit[data-edit]'); if (ed){ openEdit(ed.getAttribute('data-edit')); }
    const del= t.closest('button.btn-delete[data-del]'); if (del){ deleteRecord(del.getAttribute('data-del')); }
  });
  document.getElementById('btnEditCancel').addEventListener('click', ()=>{
    modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); editCurrentId=null;
  });
  document.getElementById('btnEditSave').addEventListener('click', async ()=>{
    if (!editCurrentId) return;
    const updates = {
      occurrenceDate:  document.getElementById('edit_occurrenceDate').value||'',
      occurrenceTime:  document.getElementById('edit_occurrenceTime').value||'',
      restartTime:     document.getElementById('edit_restartTime').value||'',
      department:      document.getElementById('edit_department').value||'',
      lineName:        document.getElementById('edit_lineName').value||'',
      handler:         document.getElementById('edit_handler').value||'',
      serialNo:        document.getElementById('edit_serialNo').value||'',
      anomalyContent:  document.getElementById('edit_anomalyContent').value||'',
      actionTaken:     document.getElementById('edit_actionTaken').value||'',
      traceback:       document.getElementById('edit_traceback').value||'',
      techRequest:     document.getElementById('edit_techRequest').value||'',
      techHandler:     document.getElementById('edit_techHandler').value||'',
      lifespan:        document.getElementById('edit_lifespan').value||'',
      maintenanceUnit: document.getElementById('edit_maintenanceUnit').value||'',
      rootCauseAction: document.getElementById('edit_rootCauseAction').value||'',
      recurrenceType:  document.getElementById('edit_recurrenceType').value||'',
    };
    if (updates.techRequest==='å®Œçµ'){
      updates.status='complete';
    }else{
      const hasTech = (updates.techHandler||updates.lifespan||updates.maintenanceUnit||updates.rootCauseAction||updates.recurrenceType);
      updates.status = hasTech ? 'complete' : 'pending';
    }
    await updateDoc(doc(db,'anomalies',editCurrentId), updates);
    modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); editCurrentId=null;
    alert('æ›´æ–°ã—ã¾ã—ãŸã€‚');
  });

  async function deleteRecord(id){
    if (!confirm('ã“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆç”»åƒã‚‚å‰Šé™¤ï¼‰')) return;
    const baseRef = ref(storage, `anomalies/${id}`);
    try{
      const all = await listAll(baseRef);
      for (const f of all.items){ await deleteObject(f); }
      for (const p of all.prefixes){
        const all2 = await listAll(p);
        for (const f2 of all2.items){ await deleteObject(f2); }
      }
    }catch(err){}
    await deleteDoc(doc(db,'anomalies',id));
  }

  document.getElementById('btnExport').addEventListener('click', ()=>{
    if (!anomalyCache.length){ alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const headers = ['æ•´ç†No','éƒ¨ç½²','ãƒ©ã‚¤ãƒ³å','ç™ºç”Ÿæ—¥','ç™ºç”Ÿæ™‚åˆ»','å†é–‹æ™‚åˆ»','ç•°å¸¸å†…å®¹','è£½é€ å‡¦ç½®å†…å®¹','é¡ã‚Š','å‡¦ç½®è€…','æŠ€è¡“è¦è«‹','æŠ€è¡“å‡¦ç½®è€…','å‘½æ•°æœ‰ç„¡','ä¿å…¨å˜ä½','åŸå› å¯¾ç­–','å†ç™ºæ–°è¦','çŠ¶æ…‹','_id'];
    const rows = anomalyCache.map(item=>[
      item.serialNo||'',item.department||'',item.lineName||'',item.occurrenceDate||'',item.occurrenceTime||'',item.restartTime||'',
      item.anomalyContent||'',item.actionTaken||'',item.traceback||'',item.handler||'',
      item.techRequest==='è¦è«‹'?'æŠ€è¡“è¦è«‹ã‚ã‚Š':item.techRequest==='å®Œçµ'?'è£½é€ ã§å®Œçµ':'',
      item.techHandler||'',item.lifespan||'',item.maintenanceUnit||'',item.rootCauseAction||'',item.recurrenceType||'',
      item.status==='complete'?'å®Œäº†':'æŠ€è¡“å…¥åŠ›å¾…ã¡', item._id
    ]);
    let csv = '\uFEFF' + headers.join(',') + '\n';
    rows.forEach(r=>{ csv += r.map(c=>`"${(c??'').toString().replace(/"/g,'""')}"`).join(',')+'\n'; });
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download=`ç•°å¸¸å±¥æ­´_${new Date().toISOString().split('T')[0]}.csv`; a.click();
  });

  async function updateDepartmentList(){
    const list=document.getElementById('departmentList'); list.innerHTML='';
    const snap=await getDocs(collection(db,'masters','department','items'));
    const arr = snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=> a.name.localeCompare(b.name));
    if (!arr.length){ list.innerHTML='<p style="color:#999;text-align:center;">éƒ¨ç½²ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; return; }
    arr.forEach(row=>{
      const div=document.createElement('div');
      div.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:12px 15px;background:#f8f9fa;border-radius:6px;border-left:3px solid #667eea;';
      div.innerHTML = `<span style="font-weight:500;color:#333">${row.name}</span>
        <button class="btn-small btn-delete" data-del-dept="${row.id}">å‰Šé™¤</button>`;
      list.appendChild(div);
    });
    mastersCache = await fetchMasters();
    updateDepartmentSelect('department', mastersCache.departments);
    updateDepartmentSelect('lineManageDept', mastersCache.departments);
    updateDepartmentSelect('handlerManageDept', mastersCache.departments);
  }
  document.getElementById('btnAddDept').addEventListener('click', async ()=>{
    const name=(document.getElementById('newDepartment').value||'').trim();
    if (!name){ alert('éƒ¨ç½²åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    await addDoc(collection(db,'masters','department','items'), {name});
    document.getElementById('newDepartment').value='';
    updateDepartmentList();
  });
  document.addEventListener('click', async (e)=>{
    const del=e.target.closest('button[data-del-dept]'); if (!del) return;
    await deleteDoc(doc(db,'masters','department','items', del.getAttribute('data-del-dept')));
    updateDepartmentList();
  });

  async function updateLineManageList(){
    const dept=document.getElementById('lineManageDept').value;
    const list=document.getElementById('lineList'); 
    list.innerHTML='';
    
    if (!dept){ 
      list.innerHTML='<p style="color:#999;text-align:center;">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</p>'; 
      return; 
    }
    
    const snap=await getDocs(query(collection(db,'masters','line','items'), where('department','==',dept)));
    const arr=snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=> a.name.localeCompare(b.name));
    
    if (!arr.length){ 
      list.innerHTML='<p style="color:#999;text-align:center;">ãƒ©ã‚¤ãƒ³åãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; 
      return; 
    }
    
    arr.forEach(row=>{
      const div=document.createElement('div');
      div.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:12px 15px;background:#f8f9fa;border-radius:6px;border-left:3px solid #f57c00;';
      div.innerHTML = `<span style="font-weight:500;color:#333">${row.name}</span>
        <button class="btn-small btn-delete" data-del-line="${row.id}">å‰Šé™¤</button>`;
      list.appendChild(div);
    });
  }
  
  document.getElementById('btnAddLine').addEventListener('click', async ()=>{
    const dept=document.getElementById('lineManageDept').value;
    const name=(document.getElementById('newLine').value||'').trim();
    if (!dept){ alert('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    if (!name){ alert('ãƒ©ã‚¤ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    
    await addDoc(collection(db,'masters','line','items'), {department:dept, name});
    document.getElementById('newLine').value='';
    
    mastersCache = await fetchMasters();
    await updateLineManageList();
  });
  
  document.addEventListener('click', async (e)=>{
    const del=e.target.closest('button[data-del-line]'); if (!del) return;
    await deleteDoc(doc(db,'masters','line','items', del.getAttribute('data-del-line')));
    mastersCache = await fetchMasters();
    await updateLineManageList();
  });

  async function updateHandlerManageList(){
    const dept=document.getElementById('handlerManageDept').value;
    const list=document.getElementById('handlerList'); 
    list.innerHTML='';
    
    if (!dept){ 
      list.innerHTML='<p style="color:#999;text-align:center;">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</p>'; 
      return; 
    }
    
    const snap=await getDocs(query(collection(db,'masters','handler','items'), where('department','==',dept)));
    const arr=snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=> a.name.localeCompare(b.name));
    
    if (!arr.length){ 
      list.innerHTML='<p style="color:#999;text-align:center;">å‡¦ç½®è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; 
      return; 
    }
    
    arr.forEach(row=>{
      const div=document.createElement('div');
      div.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:12px 15px;background:#f8f9fa;border-radius:6px;border-left:3px solid #2e7d32;';
      div.innerHTML = `<span style="font-weight:500;color:#333">${row.name}</span>
        <button class="btn-small btn-delete" data-del-handler="${row.id}">å‰Šé™¤</button>`;
      list.appendChild(div);
    });
  }
  
  document.getElementById('btnAddHandler').addEventListener('click', async ()=>{
    const dept=document.getElementById('handlerManageDept').value;
    const name=(document.getElementById('newHandler').value||'').trim();
    if (!dept){ alert('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    if (!name){ alert('å‡¦ç½®è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    
    await addDoc(collection(db,'masters','handler','items'), {department:dept, name});
    document.getElementById('newHandler').value='';
    
    mastersCache = await fetchMasters();
    await updateHandlerManageList();
  });
  
  document.addEventListener('click', async (e)=>{
    const del=e.target.closest('button[data-del-handler]'); if (!del) return;
    await deleteDoc(doc(db,'masters','handler','items', del.getAttribute('data-del-handler')));
    mastersCache = await fetchMasters();
    await updateHandlerManageList();
  });

  function updateAnalysis(){ updateStatistics(); updateTrendAnalysis(); updateDepartmentAnalysis(); updateRecurrenceAnalysis(); }
  
  function updateStatistics(){
    const total=anomalyCache.length;
    const completed=anomalyCache.filter(x=>x.status==='complete').length;
    const pending=total-completed;
    const now=new Date();
    const thisMonth=anomalyCache.filter(x=>{
      const d=new Date(x.occurrenceDate); return d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear();
    }).length;
    let avg=0,cnt=0;
    anomalyCache.forEach(x=>{
      if (x.occurrenceTime && x.restartTime){
        const [oh,om]=(x.occurrenceTime||'0:0').split(':').map(Number);
        const [rh,rm]=(x.restartTime||'0:0').split(':').map(Number);
        let m=(rh*60+rm)-(oh*60+om); if (m<0) m+=1440; avg+=m; cnt++;
      }
    });
    avg = cnt?Math.round(avg/cnt):0;
    const stats=document.getElementById('statisticsDisplay');
    stats.innerHTML = `
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
        <div class="stat-card">
          <h4>ç·ç•°å¸¸ä»¶æ•°</h4><div class="stat-value">${total}</div><div class="stat-label">ä»¶</div>
        </div>
        <div class="stat-card" style="background:linear-gradient(135deg,#2e7d32 0%,#66bb6a 100%);">
          <h4>å¯¾å¿œå®Œäº†</h4><div class="stat-value">${completed}</div><div class="stat-label">ä»¶ (${total?Math.round(completed/total*100):0}%)</div>
        </div>
        <div class="stat-card" style="background:linear-gradient(135deg,#f57c00 0%,#ffb74d 100%);">
          <h4>å¯¾å¿œå¾…ã¡</h4><div class="stat-value">${pending}</div><div class="stat-label">ä»¶</div>
        </div>
        <div class="stat-card" style="background:linear-gradient(135deg,#c62828 0%,#ef5350 100%);">
          <h4>ä»Šæœˆã®ç•°å¸¸</h4><div class="stat-value">${thisMonth}</div><div class="stat-label">ä»¶</div>
        </div>
        <div class="stat-card" style="background:linear-gradient(135deg,#1976d2 0%,#42a5f5 100%);">
          <h4>å¹³å‡å¯¾å¿œæ™‚é–“</h4><div class="stat-value">${avg}</div><div class="stat-label">åˆ†</div>
        </div>
      </div>`;
  }
  
  function updateTrendAnalysis(){
    const monthly={}; 
    anomalyCache.forEach(x=>{
      if (!x.occurrenceDate) return;
      const d=new Date(x.occurrenceDate); 
      const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      monthly[k]=(monthly[k]||0)+1;
    });
    const months=Object.keys(monthly).sort();
    const max=Math.max(...Object.values(monthly),1);
    const chart=document.getElementById('trendChart');
    chart.innerHTML = months.map(m=>{
      const c=monthly[m]; const pct=(c/max)*100;
      return `<div style="margin-bottom:15px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
          <span style="font-weight:bold;">${m}</span><span style="color:#666;">${c}ä»¶</span>
        </div>
        <div style="background:#e0e0e0;height:30px;border-radius:4px;overflow:hidden;">
          <div class="chart-bar" style="width:${pct}%;">${c}ä»¶</div>
        </div>
      </div>`;
    }).join('');
    
    const ana=document.getElementById('trendAnalysis');
    if (months.length>=3){
      const r3=months.slice(-3).map(m=>monthly[m]);
      const avgR=r3.reduce((a,b)=>a+b,0)/3;
      const prev=months.slice(-6,-3).map(m=>monthly[m]);
      const avgP=prev.length?prev.reduce((a,b)=>a+b,0)/prev.length:avgR;
      let trend='æ¨ªã°ã„', cls='trend-stable';
      if (avgR>avgP*1.2){ trend='å¢—åŠ å‚¾å‘'; cls='trend-increase'; }
      else if (avgR<avgP*0.8){ trend='æ¸›å°‘å‚¾å‘'; cls='trend-decrease'; }
      ana.innerHTML = `<div class="analysis-insight">
        <strong>ğŸ“Š å‚¾å‘åˆ†æ:</strong> ç›´è¿‘3ãƒ¶æœˆã®å¹³å‡ã¯<strong>${avgR.toFixed(1)}ä»¶/æœˆ</strong>ã§ã€
        <span class="trend-badge ${cls}">${trend}</span>ã§ã™ã€‚
        ${trend==='å¢—åŠ å‚¾å‘'?'âš ï¸ ç•°å¸¸ç™ºç”ŸãŒå¢—ãˆã¦ã„ã¾ã™ã€‚åŸå› ã‚’ç‰¹å®šã—ã€å¯¾ç­–ãŒå¿…è¦ã§ã™ã€‚':''}
        ${trend==='æ¸›å°‘å‚¾å‘'?'âœ… æ”¹å–„ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚ç¾åœ¨ã®å–ã‚Šçµ„ã¿ã‚’ç¶™ç¶šã—ã¾ã—ã‚‡ã†ã€‚':''}
      </div>`;
    }else{
      ana.innerHTML='<p style="color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã‚‹ãŸã‚ã€å‚¾å‘åˆ†æã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“</p>';
    }
  }
  
  function updateDepartmentAnalysis(){
    const dept={}, line={};
    anomalyCache.forEach(x=>{
      if (x.department) dept[x.department]=(dept[x.department]||0)+1;
      if (x.lineName) line[x.lineName]=(line[x.lineName]||0)+1;
    });
    const maxD=Math.max(...Object.values(dept),1), maxL=Math.max(...Object.values(line),1);
    const div=document.getElementById('departmentAnalysis'); 
    let html='<h4 style="color:#666;margin-bottom:10px;">éƒ¨ç½²åˆ¥ç•°å¸¸ä»¶æ•°</h4>';
    Object.entries(dept).sort((a,b)=>b[1]-a[1]).forEach(([k,c])=>{
      const pct=(c/maxD)*100; 
      html += `<div style="margin-bottom:10px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
          <span>${k}</span><span style="color:#666;">${c}ä»¶</span>
        </div>
        <div style="background:#e0e0e0;height:25px;border-radius:4px;overflow:hidden;">
          <div class="chart-bar" style="width:${pct}%;height:25px;font-size:.85rem;">${c}ä»¶</div>
        </div>
      </div>`;
    });
    html+='<h4 style="color:#666;margin:20px 0 10px;">ãƒ©ã‚¤ãƒ³åˆ¥ç•°å¸¸ä»¶æ•°</h4>';
    Object.entries(line).sort((a,b)=>b[1]-a[1]).forEach(([k,c])=>{
      const pct=(c/maxL)*100; 
      html += `<div style="margin-bottom:10px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
          <span>${k}</span><span style="color:#666;">${c}ä»¶</span>
        </div>
        <div style="background:#e0e0e0;height:25px;border-radius:4px;overflow:hidden;">
          <div class="chart-bar" style="width:${pct}%;height:25px;font-size:.85rem;background:linear-gradient(90deg,#f57c00 0%,#ffb74d 100%);">${c}ä»¶</div>
        </div>
      </div>`;
    });
    div.innerHTML = html || '<p style="color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
  }
  
  function updateRecurrenceAnalysis(){
    const recCnt = anomalyCache.filter(x=>x.recurrenceType==='å†ç™º').length;
    const newCnt = anomalyCache.filter(x=>x.recurrenceType==='æ–°è¦').length;
    const total=recCnt+newCnt; 
    const div=document.getElementById('recurrenceAnalysis');
    if (!total){ 
      div.innerHTML='<p style="color:#999;">æŠ€è¡“å¯¾å¿œæ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>'; 
      return; 
    }
    const rate=(recCnt/total*100).toFixed(1);
    div.innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
        <div style="text-align:center;padding:20px;background:#ffebee;border-radius:8px;">
          <div style="font-size:3rem;font-weight:bold;color:#c62828;">${recCnt}</div>
          <div style="color:#666;margin-top:5px;">å†ç™ºä»¶æ•°</div>
        </div>
        <div style="text-align:center;padding:20px;background:#e8f5e9;border-radius:8px;">
          <div style="font-size:3rem;font-weight:bold;color:#2e7d32;">${newCnt}</div>
          <div style="color:#666;margin-top:5px;">æ–°è¦ä»¶æ•°</div>
        </div>
      </div>
      <div class="analysis-insight">
        <strong>ğŸ”„ å†ç™ºç‡:</strong> ${rate}% (${recCnt}/${total}ä»¶)
        ${rate>30?'<br>âš ï¸ å†ç™ºç‡ãŒé«˜ã‚ã§ã™ã€‚æ ¹æœ¬åŸå› ã®è¿½æ±‚ã¨æ’ä¹…å¯¾ç­–ãŒå¿…è¦ã§ã™ã€‚':''}
        ${rate<20?'<br>âœ… å†ç™ºç‡ã¯è‰¯å¥½ã§ã™ã€‚ç¾åœ¨ã®å¯¾ç­–ã‚’ç¶™ç¶šã—ã¾ã—ã‚‡ã†ã€‚':''}
      </div>`;
  }
</script>
</body>
</html>
