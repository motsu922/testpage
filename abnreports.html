<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•°å¸¸å±¥æ­´å…¥åŠ›ãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
        background: #f5f5f5;
        padding: 0;
        margin: 0;
    }

    .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 10px;
    }

    .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header h1 {
        font-size: 1.5rem;
        margin-bottom: 5px;
    }

    .tabs {
        display: flex;
        background: white;
        margin: 15px 0 0 0;
        border-radius: 8px 8px 0 0;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .tab {
        flex: 1;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        background: #f8f9fa;
        border: none;
        font-size: 1rem;
        font-weight: bold;
        transition: all 0.3s;
        color: #666;
    }

    .tab.active {
        background: white;
        color: #667eea;
        border-bottom: 3px solid #667eea;
    }

    .tab-content {
        display: none;
        background: white;
        padding: 20px;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .tab-content.active {
        display: block;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #333;
        font-size: 0.95rem;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
        outline: none;
        border-color: #667eea;
    }

    .form-group textarea {
        min-height: 100px;
        resize: vertical;
    }

    .time-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    .photo-upload {
        border: 2px dashed #e0e0e0;
        border-radius: 6px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }

    .photo-upload:hover {
        border-color: #667eea;
        background: #f8f9ff;
    }

    .photo-upload input[type="file"] {
        display: none;
    }

    .photo-preview {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        margin-top: 15px;
    }

    .photo-item {
        position: relative;
        aspect-ratio: 1;
        border-radius: 6px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .photo-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .photo-item .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(255, 59, 48, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
    }

    .btn {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 10px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-export {
        background: #28a745;
        color: white;
    }

    .btn-import {
        background: #17a2b8;
        color: white;
    }

    .history-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }

    .view-toggle {
        display: flex;
        gap: 5px;
    }

    .view-toggle button {
        padding: 8px 15px;
        border: 2px solid #667eea;
        background: white;
        color: #667eea;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
    }

    .view-toggle button.active {
        background: #667eea;
        color: white;
    }

    .card-view {
        display: grid;
        gap: 15px;
    }

    .anomaly-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
    }

    .anomaly-card.complete {
        border-left-color: #28a745;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e0e0e0;
    }

    .card-id {
        font-size: 1.2rem;
        font-weight: bold;
        color: #667eea;
    }

    .card-status {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: bold;
    }

    .status-pending {
        background: #fff3cd;
        color: #856404;
    }

    .status-complete {
        background: #d4edda;
        color: #155724;
    }

    .card-body {
        display: grid;
        gap: 8px;
    }

    .card-field {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 10px;
    }

    .field-label {
        font-weight: bold;
        color: #666;
    }

    .field-value {
        color: #333;
    }

    .table-view {
        overflow-x: auto;
        display: none;
    }

    .table-view.active {
        display: block;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    th, td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }

    th {
        background: #667eea;
        color: white;
        font-weight: bold;
        position: sticky;
        top: 0;
    }

    tr:hover {
        background: #f8f9ff;
    }

    .action-btns {
        display: flex;
        gap: 5px;
    }

    .btn-small {
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
    }

    .btn-edit {
        background: #ffc107;
        color: #000;
    }

    .btn-delete {
        background: #dc3545;
        color: white;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 8px;
        max-width: 400px;
        width: 90%;
        text-align: center;
    }

    .modal-icon {
        font-size: 3rem;
        margin-bottom: 15px;
    }

    .modal-content h3 {
        margin-bottom: 20px;
        color: #333;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 15px;
    }

    .checkbox-group input[type="checkbox"] {
        width: auto;
        height: 20px;
        cursor: pointer;
    }

    @media (max-width: 600px) {
        .card-field {
            grid-template-columns: 1fr;
            gap: 5px;
        }

        .time-group {
            grid-template-columns: 1fr;
        }

        table {
            font-size: 0.85rem;
        }

        th, td {
            padding: 8px;
        }
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 15px;
    }

    .master-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 3px solid #667eea;
    }

    .master-item-name {
        font-weight: 500;
        color: #333;
    }

    .master-item .btn-delete {
        padding: 5px 12px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
    }

    .master-item .btn-delete:hover {
        background: #c82333;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
    }

    .stat-card h4 {
        font-size: 0.9rem;
        margin-bottom: 10px;
        opacity: 0.9;
    }

    .stat-card .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stat-card .stat-label {
        font-size: 0.85rem;
        opacity: 0.8;
    }

    .similar-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 10px;
        border-left: 4px solid #ff9800;
    }

    .similar-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e0e0e0;
    }

    .similar-score {
        background: #ff9800;
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: bold;
    }

    .chart-bar {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        height: 30px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        padding: 0 10px;
        color: white;
        font-weight: bold;
        margin-bottom: 10px;
        transition: all 0.3s;
    }

    .chart-bar:hover {
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .trend-badge {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.9rem;
        margin: 5px;
    }

    .trend-increase {
        background: #ffebee;
        color: #c62828;
    }

    .trend-decrease {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .trend-stable {
        background: #fff3e0;
        color: #ef6c00;
    }

    .analysis-insight {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 15px;
        border-radius: 6px;
        margin-top: 15px;
    }

    .analysis-insight strong {
        color: #1976d2;
    }

    .suggestion-btn {
        display: inline-block;
        padding: 8px 15px;
        margin: 5px;
        background: linear-gradient(135deg, #8e24aa 0%, #6a1b9a 100%);
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s;
        box-shadow: 0 2px 5px rgba(142, 36, 170, 0.3);
    }

    .suggestion-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(142, 36, 170, 0.4);
    }

    .suggestion-btn:active {
        transform: translateY(0);
    }

    .suggestion-category {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e0e0e0;
    }

    .suggestion-category:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .suggestion-category-title {
        font-weight: bold;
        color: #8e24aa;
        margin-bottom: 8px;
        font-size: 0.9rem;
    }

    .past-history-item {
        background: white;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
        border-left: 4px solid #ff9800;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .past-history-item:last-child {
        margin-bottom: 0;
    }

    .past-history-date {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 8px;
    }

    .past-history-field {
        margin-bottom: 10px;
        padding: 8px;
        background: #f5f5f5;
        border-radius: 4px;
    }

    .past-history-field strong {
        color: #ff9800;
        display: block;
        margin-bottom: 5px;
    }

    .copy-btn {
        display: inline-block;
        padding: 5px 12px;
        margin-left: 10px;
        background: #ff9800;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.3s;
    }

    .copy-btn:hover {
        background: #f57c00;
        transform: translateY(-1px);
    }
</style>
```

</head>
<body>
    <div class="header">
        <h1>ğŸ“‹ ç•°å¸¸å±¥æ­´å…¥åŠ›ãƒ„ãƒ¼ãƒ«</h1>
        <p>è£½é€ ãƒ»æŠ€è¡“éƒ¨é–€é€£æºã‚·ã‚¹ãƒ†ãƒ </p>
    </div>

```
<div class="container">
    <div class="tabs">
        <button class="tab active" onclick="switchTab('manufacturing')">è£½é€ å…¥åŠ›</button>
        <button class="tab" onclick="switchTab('technical')">æŠ€è¡“å…¥åŠ›</button>
        <button class="tab" onclick="switchTab('history')">å±¥æ­´</button>
        <button class="tab" onclick="switchTab('analysis')">ğŸ“Š åˆ†æ</button>
        <button class="tab" onclick="switchTab('master')">âš™ï¸ ç®¡ç†</button>
    </div>

    <!-- è£½é€ å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div id="manufacturing" class="tab-content active">
        <h2 style="margin-bottom: 20px; color: #667eea;">è£½é€ éƒ¨é–€ - ç•°å¸¸å ±å‘Š</h2>
        <p style="margin-bottom: 20px; color: #666;">ã„ã¤ãƒ»ã©ã“ã§ãƒ»ã©ã®æ•´ç†Noã§ãƒ»ä½•ãŒã‚ã£ãŸ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <form id="manufacturingForm">
            <!-- ã„ã¤ -->
            <div style="background: #f0f7ff; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                <h3 style="color: #667eea; margin-bottom: 15px; font-size: 1.1rem;">ğŸ“… ã„ã¤</h3>
                
                <div class="form-group">
                    <label>ç™ºç”Ÿæ—¥ *</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="date" id="occurrenceDate" required style="flex: 1;">
                        <button type="button" onclick="setNowDate()" class="btn btn-secondary" style="width: auto; padding: 12px 20px; margin: 0; background: #17a2b8;">ğŸ“… NOW</button>
                    </div>
                    <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">â€»å‹¤å‹™æ™‚é–“: 8:00ã€œç¿Œ6:00 (0:00ã€œ6:00ã®ç•°å¸¸ã¯å‰æ—¥æ‰±ã„)</p>
                </div>

                <div class="form-group">
                    <label>æ™‚åˆ»</label>
                    <div class="time-group">
                        <div>
                            <label style="font-weight: normal; font-size: 0.9rem;">ç™ºç”Ÿæ™‚åˆ»</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="time" id="occurrenceTime" style="flex: 1;">
                                <button type="button" onclick="setNowTime('occurrenceTime')" class="btn btn-secondary" style="width: auto; padding: 8px 12px; margin: 0; font-size: 0.85rem; background: #17a2b8;">NOW</button>
                            </div>
                        </div>
                        <div>
                            <label style="font-weight: normal; font-size: 0.9rem;">å†é–‹æ™‚åˆ»</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="time" id="restartTime" style="flex: 1;">
                                <button type="button" onclick="setNowTime('restartTime')" class="btn btn-secondary" style="width: auto; padding: 8px 12px; margin: 0; font-size: 0.85rem; background: #17a2b8;">NOW</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ã©ã“ã§ -->
            <div style="background: #fff4e6; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                <h3 style="color: #f57c00; margin-bottom: 15px; font-size: 1.1rem;">ğŸ“ ã©ã“ã§</h3>
                
                <div class="form-group">
                    <label>éƒ¨ç½² *</label>
                    <select id="department" required onchange="updateLineOptions()">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ãƒ©ã‚¤ãƒ³å *</label>
                    <select id="lineName" required>
                        <option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>å‡¦ç½®è€… *</label>
                    <select id="handler" required>
                        <option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>
            </div>

            <!-- ã©ã®æ•´ç†Noã§ -->
            <div style="background: #f3e5f5; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                <h3 style="color: #8e24aa; margin-bottom: 15px; font-size: 1.1rem;">ğŸ”¢ ã©ã®æ•´ç†Noã§</h3>
                
                <div class="form-group">
                    <label>æ•´ç†No *</label>
                    <input type="text" id="serialNo" required placeholder="ä¾‹: 2024-001" onblur="searchSimilarSerialNo()">
                    <p style="margin-top: 5px; font-size: 0.85rem; color: #666;">â€»æ•´ç†Noã‚’å…¥åŠ›ã™ã‚‹ã¨éå»ã®é¡ä¼¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å€™è£œãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                </div>

                <!-- å€™è£œãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="suggestionArea" style="display: none; margin-top: 15px; padding: 15px; background: white; border-radius: 6px; border: 2px solid #8e24aa;">
                    <h4 style="color: #8e24aa; margin-bottom: 10px; font-size: 0.95rem;">ğŸ’¡ éå»ã®é¡ä¼¼æ•´ç†Noã‹ã‚‰å€™è£œã‚’è¡¨ç¤º</h4>
                    <div id="suggestionButtons"></div>
                </div>
            </div>

            <!-- ä½•ãŒã‚ã£ãŸ -->
            <div style="background: #e8f5e9; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                <h3 style="color: #2e7d32; margin-bottom: 15px; font-size: 1.1rem;">ğŸ“ ä½•ãŒã‚ã£ãŸ</h3>
                
                <div class="form-group">
                    <label>ç•°å¸¸å†…å®¹ *</label>
                    <textarea id="anomalyContent" required placeholder="ç™ºç”Ÿã—ãŸç•°å¸¸ã®è©³ç´°ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„"></textarea>
                </div>

                <div class="form-group">
                    <label>è£½é€ å‡¦ç½®å†…å®¹ *</label>
                    <textarea id="actionTaken" required placeholder="å®Ÿæ–½ã—ãŸå‡¦ç½®å†…å®¹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„"></textarea>
                </div>

                <div class="form-group">
                    <label>é¡ã‚Š *</label>
                    <select id="traceback" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="æœ‰">æœ‰</option>
                        <option value="ç„¡">ç„¡</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>æŠ€è¡“è¦è«‹ *</label>
                    <select id="techRequest" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="è¦è«‹">æŠ€è¡“è¦è«‹ã‚ã‚Šï¼ˆæŠ€è¡“éƒ¨é–€ã®å…¥åŠ›ãŒå¿…è¦ï¼‰</option>
                        <option value="å®Œçµ">è£½é€ ã§å®Œçµï¼ˆæŠ€è¡“å…¥åŠ›ä¸è¦ï¼‰</option>
                    </select>
                    <p style="margin-top: 5px; font-size: 0.85rem; color: #666;">â€»è£½é€ ã§å®Œçµã™ã‚‹å ´åˆã¯ã€Œè£½é€ ã§å®Œçµã€ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                </div>

                <div class="form-group">
                    <label>å†™çœŸ</label>
                    <div class="photo-upload" onclick="document.getElementById('mfgPhotos').click()">
                        <div style="font-size: 2rem;">ğŸ“¸</div>
                        <p>å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</p>
                        <input type="file" id="mfgPhotos" accept="image/*" multiple>
                    </div>
                    <div id="mfgPhotoPreview" class="photo-preview"></div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">ç™»éŒ²ã—ã¦LINEè»¢é€ç¢ºèª</button>
        </form>
    </div>

    <!-- æŠ€è¡“å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div id="technical" class="tab-content">
        <h2 style="margin-bottom: 20px; color: #667eea;">æŠ€è¡“éƒ¨é–€ - è¿½åŠ å…¥åŠ›</h2>
        
        <div class="form-group">
            <label>å¯¾è±¡ã®æ¡ˆä»¶é¸æŠ *</label>
            <select id="selectSerialNo" onchange="loadManufacturingData()">
                <option value="">æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
            <p style="margin-top: 5px; font-size: 0.85rem; color: #666;">â€»[å“ç•ª] æ—¥ä»˜ - ç•°å¸¸å†…å®¹ ã®å½¢å¼ã§è¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>

        <div id="selectedDataDisplay" style="background: #f8f9ff; padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none;">
            <h3 style="color: #667eea; margin-bottom: 10px;">è£½é€ éƒ¨é–€å…¥åŠ›å†…å®¹</h3>
            <div id="displayContent"></div>
        </div>

        <!-- éå»ã®å¯¾å¿œå±¥æ­´è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="pastHistoryArea" style="display: none; margin-bottom: 20px; padding: 15px; background: #fff3e0; border-radius: 6px; border: 2px solid #ff9800;">
            <h3 style="color: #ff9800; margin-bottom: 10px; font-size: 1.1rem;">ğŸ“š éå»ã®åŒä¸€æ•´ç†Noã®å¯¾å¿œå±¥æ­´</h3>
            <div id="pastHistoryContent"></div>
        </div>

        <!-- æŠ€è¡“å…¥åŠ›ç”¨å€™è£œãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="techSuggestionArea" style="display: none; margin-bottom: 20px; padding: 15px; background: white; border-radius: 6px; border: 2px solid #667eea;">
            <h4 style="color: #667eea; margin-bottom: 10px; font-size: 0.95rem;">ğŸ’¡ éå»ã®é¡ä¼¼æ•´ç†Noã‹ã‚‰å€™è£œã‚’è¡¨ç¤º</h4>
            <div id="techSuggestionButtons"></div>
        </div>

        <form id="technicalForm">
            <div class="form-group">
                <label>æŠ€è¡“å‡¦ç½®è€… *</label>
                <input type="text" id="techHandler" required placeholder="æŠ€è¡“å‡¦ç½®è€…åã‚’å…¥åŠ›">
            </div>

            <div class="form-group">
                <label>å‘½æ•°æœ‰ç„¡ *</label>
                <select id="lifespan" required>
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    <option value="æœ‰">æœ‰</option>
                    <option value="ç„¡">ç„¡</option>
                </select>
            </div>

            <div class="form-group">
                <label>ä¿å…¨å˜ä½ *</label>
                <input type="text" id="maintenanceUnit" required placeholder="ä¾‹: ãƒ¢ãƒ¼ã‚¿ãƒ¼ã€ãƒ™ã‚¢ãƒªãƒ³ã‚°">
            </div>

            <div class="form-group">
                <label>ä½•ãŒæ‚ªãã©ã†ã—ãŸ *</label>
                <textarea id="rootCauseAction" required placeholder="åŸå› ã¨å¯¾ç­–ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„"></textarea>
            </div>

            <div class="form-group">
                <label>å†ç™ºã‹æ–°è¦ã‹ *</label>
                <select id="recurrenceType" required>
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    <option value="å†ç™º">å†ç™º</option>
                    <option value="æ–°è¦">æ–°è¦</option>
                </select>
            </div>

            <div class="form-group">
                <label>å†™çœŸ</label>
                <div class="photo-upload" onclick="document.getElementById('techPhotos').click()">
                    <div style="font-size: 2rem;">ğŸ“¸</div>
                    <p>å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</p>
                    <input type="file" id="techPhotos" accept="image/*" multiple>
                </div>
                <div id="techPhotoPreview" class="photo-preview"></div>
            </div>

            <button type="submit" class="btn btn-primary">ç™»éŒ²ã—ã¦LINEè»¢é€ç¢ºèª</button>
        </form>
    </div>

    <!-- å±¥æ­´è¡¨ç¤º -->
    <div id="history" class="tab-content">
        <h2 style="margin-bottom: 20px; color: #667eea;">ç•°å¸¸å±¥æ­´</h2>
        
        <div class="history-controls">
            <div class="view-toggle">
                <button class="active" onclick="toggleView('card')">ã‚«ãƒ¼ãƒ‰</button>
                <button onclick="toggleView('table')">ãƒ†ãƒ¼ãƒ–ãƒ«</button>
            </div>
            <button class="btn" onclick="switchTab('analysis')" style="flex: 1; background: #ff9800; color: white;">ğŸ“Š åˆ†æ</button>
            <button class="btn btn-export" onclick="exportCSV()" style="flex: 1;">ğŸ“¥ CSVå‡ºåŠ›</button>
            <button class="btn btn-import" onclick="document.getElementById('csvImport').click()" style="flex: 1;">ğŸ“¤ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            <input type="file" id="csvImport" accept=".csv" style="display: none;" onchange="importCSV(event)">
        </div>

        <div id="cardView" class="card-view"></div>
        <div id="tableView" class="table-view"></div>
    </div>

    <!-- åˆ†æãƒšãƒ¼ã‚¸ -->
    <div id="analysis" class="tab-content">
        <h2 style="margin-bottom: 20px; color: #ff9800;">ğŸ“Š ç•°å¸¸ãƒ‡ãƒ¼ã‚¿åˆ†æ</h2>

        <!-- æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <h3 style="color: #ff9800; margin-bottom: 15px;">ğŸ” é¡ä¼¼ç•°å¸¸æ¤œç´¢</h3>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                <h4 style="font-size: 1rem; margin-bottom: 10px; color: #666;">çµã‚Šè¾¼ã¿æ¡ä»¶</h4>
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>éƒ¨ç½²</label>
                    <select id="searchDepartment" onchange="updateSearchLineOptions()">
                        <option value="">ã™ã¹ã¦</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>ãƒ©ã‚¤ãƒ³å</label>
                    <select id="searchLine">
                        <option value="">ã™ã¹ã¦</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <label>æ•´ç†No</label>
                    <input type="text" id="searchSerialNo" placeholder="æ•´ç†Noã§çµã‚Šè¾¼ã¿ï¼ˆä¾‹: 2024-001ï¼‰">
                </div>
            </div>

            <div class="form-group">
                <label>æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="text" id="searchKeyword" placeholder="ç•°å¸¸å†…å®¹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆä¾‹: ãƒ¢ãƒ¼ã‚¿ãƒ¼ã€åœæ­¢ã€ç•°éŸ³ï¼‰">
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="searchSimilarAnomalies()" class="btn btn-primary" style="background: #ff9800; flex: 1;">æ¤œç´¢</button>
                <button onclick="clearSearchFilters()" class="btn btn-secondary" style="flex: 1;">ã‚¯ãƒªã‚¢</button>
            </div>
            
            <div id="similarResults" style="margin-top: 20px;"></div>
        </div>

        <!-- çµ±è¨ˆæƒ…å ± -->
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <h3 style="color: #ff9800; margin-bottom: 15px;">ğŸ“ˆ çµ±è¨ˆæƒ…å ±</h3>
            <div id="statisticsDisplay" style="display: grid; gap: 15px;"></div>
        </div>

        <!-- å‚¾å‘åˆ†æ -->
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <h3 style="color: #ff9800; margin-bottom: 15px;">ğŸ“Š æœˆåˆ¥å‚¾å‘åˆ†æ</h3>
            <div id="trendChart" style="min-height: 300px;"></div>
            <div id="trendAnalysis" style="margin-top: 15px;"></div>
        </div>

        <!-- éƒ¨ç½²åˆ¥ãƒ»ãƒ©ã‚¤ãƒ³åˆ¥åˆ†æ -->
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <h3 style="color: #ff9800; margin-bottom: 15px;">ğŸ¢ éƒ¨ç½²ãƒ»ãƒ©ã‚¤ãƒ³åˆ¥åˆ†æ</h3>
            <div id="departmentAnalysis" style="display: grid; gap: 15px;"></div>
        </div>

        <!-- å†ç™ºåˆ†æ -->
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h3 style="color: #ff9800; margin-bottom: 15px;">ğŸ”„ å†ç™ºãƒ»æ–°è¦åˆ†æ</h3>
            <div id="recurrenceAnalysis"></div>
        </div>
    </div>

    <!-- ç®¡ç†ç”»é¢ -->
    <div id="master" class="tab-content">
        <h2 style="margin-bottom: 20px; color: #667eea;">âš™ï¸ ãƒã‚¹ã‚¿ç®¡ç†</h2>
        
        <!-- éƒ¨ç½²ç®¡ç† -->
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 15px;">éƒ¨ç½²ç®¡ç†</h3>
            
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="newDepartment" placeholder="æ–°ã—ã„éƒ¨ç½²åã‚’å…¥åŠ›" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
                <button onclick="addDepartment()" class="btn btn-primary" style="width: auto; padding: 10px 20px; margin: 0;">è¿½åŠ </button>
            </div>

            <div id="departmentList" style="display: grid; gap: 10px;"></div>
        </div>

        <!-- ãƒ©ã‚¤ãƒ³åç®¡ç† -->
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <h3 style="color: #f57c00; margin-bottom: 15px;">ãƒ©ã‚¤ãƒ³åç®¡ç†</h3>
            
            <div class="form-group">
                <label>å¯¾è±¡éƒ¨ç½²</label>
                <select id="lineManageDept" onchange="updateLineManageList()">
                    <option value="">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="newLine" placeholder="æ–°ã—ã„ãƒ©ã‚¤ãƒ³åã‚’å…¥åŠ›" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
                <button onclick="addLine()" class="btn btn-primary" style="width: auto; padding: 10px 20px; margin: 0; background: #f57c00;">è¿½åŠ </button>
            </div>

            <div id="lineList" style="display: grid; gap: 10px;"></div>
        </div>

        <!-- å‡¦ç½®è€…ç®¡ç† -->
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h3 style="color: #2e7d32; margin-bottom: 15px;">å‡¦ç½®è€…ç®¡ç†</h3>
            
            <div class="form-group">
                <label>å¯¾è±¡éƒ¨ç½²</label>
                <select id="handlerManageDept" onchange="updateHandlerManageList()">
                    <option value="">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="newHandler" placeholder="æ–°ã—ã„å‡¦ç½®è€…åã‚’å…¥åŠ›" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
                <button onclick="addHandler()" class="btn btn-primary" style="width: auto; padding: 10px 20px; margin: 0; background: #2e7d32;">è¿½åŠ </button>
            </div>

            <div id="handlerList" style="display: grid; gap: 10px;"></div>
        </div>
    </div>
</div>

<!-- LINEè»¢é€ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="lineModal" class="modal">
    <div class="modal-content">
        <div class="modal-icon">âœ…</div>
        <h3>ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ</h3>
        <p style="margin-bottom: 20px;">LINEé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ</p>
        <div class="checkbox-group">
            <input type="checkbox" id="lineConfirm">
            <label for="lineConfirm">LINEã§é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹</label>
        </div>
        <button class="btn btn-primary" onclick="confirmLineTransfer()">ç¢ºèª</button>
    </div>
</div>

<script>
    let anomalyData = [];
    let mfgPhotos = [];
    let techPhotos = [];
    let currentView = 'card';
    
    // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿
    let masterData = {
        departments: [],
        lines: {}, // { departmentName: [line1, line2, ...] }
        handlers: {} // { departmentName: [handler1, handler2, ...] }
    };

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadData() {
        const saved = localStorage.getItem('anomalyData');
        if (saved) {
            anomalyData = JSON.parse(saved);
        }
        
        const savedMaster = localStorage.getItem('masterData');
        if (savedMaster) {
            masterData = JSON.parse(savedMaster);
        } else {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿
            masterData = {
                departments: ['è£½é€ 1èª²', 'è£½é€ 2èª²', 'çµ„ç«‹èª²'],
                lines: {
                    'è£½é€ 1èª²': ['ãƒ©ã‚¤ãƒ³1', 'ãƒ©ã‚¤ãƒ³2'],
                    'è£½é€ 2èª²': ['ãƒ©ã‚¤ãƒ³A', 'ãƒ©ã‚¤ãƒ³B'],
                    'çµ„ç«‹èª²': ['çµ„ç«‹1', 'çµ„ç«‹2']
                },
                handlers: {
                    'è£½é€ 1èª²': ['å±±ç”°å¤ªéƒ', 'ä½è—¤èŠ±å­'],
                    'è£½é€ 2èª²': ['éˆ´æœ¨ä¸€éƒ', 'ç”°ä¸­ç¾å’²'],
                    'çµ„ç«‹èª²': ['é«˜æ©‹å¥å¤ª', 'ä¼Šè—¤æ„›']
                }
            };
            saveMasterData();
        }
        
        updateHistory();
        updateSerialNoSelect();
        updateAllDepartmentSelects();
    }

    // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
    function saveData() {
        localStorage.setItem('anomalyData', JSON.stringify(anomalyData));
    }
    
    function saveMasterData() {
        localStorage.setItem('masterData', JSON.stringify(masterData));
    }

    // éƒ¨ç½²é¸æŠè‚¢ã‚’å…¨ã¦æ›´æ–°
    function updateAllDepartmentSelects() {
        updateDepartmentSelect('department');
        updateDepartmentSelect('lineManageDept');
        updateDepartmentSelect('handlerManageDept');
        updateDepartmentList();
    }

    function updateDepartmentSelect(selectId) {
        const select = document.getElementById(selectId);
        const currentValue = select.value;
        select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        
        masterData.departments.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept;
            option.textContent = dept;
            select.appendChild(option);
        });
        
        if (currentValue && masterData.departments.includes(currentValue)) {
            select.value = currentValue;
        }
    }

    // ãƒ©ã‚¤ãƒ³åé¸æŠè‚¢ã‚’æ›´æ–°
    function updateLineOptions() {
        const dept = document.getElementById('department').value;
        const lineSelect = document.getElementById('lineName');
        const handlerSelect = document.getElementById('handler');
        
        lineSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        handlerSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        
        if (dept && masterData.lines[dept]) {
            masterData.lines[dept].forEach(line => {
                const option = document.createElement('option');
                option.value = line;
                option.textContent = line;
                lineSelect.appendChild(option);
            });
        }
        
        if (dept && masterData.handlers[dept]) {
            masterData.handlers[dept].forEach(handler => {
                const option = document.createElement('option');
                option.value = handler;
                option.textContent = handler;
                handlerSelect.appendChild(option);
            });
        }
    }

    // éƒ¨ç½²ç®¡ç†
    function addDepartment() {
        const input = document.getElementById('newDepartment');
        const deptName = input.value.trim();
        
        if (!deptName) {
            alert('éƒ¨ç½²åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        
        if (masterData.departments.includes(deptName)) {
            alert('ã“ã®éƒ¨ç½²ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
            return;
        }
        
        masterData.departments.push(deptName);
        masterData.lines[deptName] = [];
        masterData.handlers[deptName] = [];
        saveMasterData();
        updateAllDepartmentSelects();
        input.value = '';
    }

    function deleteDepartment(deptName) {
        if (!confirm(`ã€Œ${deptName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\né–¢é€£ã™ã‚‹ãƒ©ã‚¤ãƒ³åã¨å‡¦ç½®è€…ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) {
            return;
        }
        
        masterData.departments = masterData.departments.filter(d => d !== deptName);
        delete masterData.lines[deptName];
        delete masterData.handlers[deptName];
        saveMasterData();
        updateAllDepartmentSelects();
    }

    function updateDepartmentList() {
        const list = document.getElementById('departmentList');
        list.innerHTML = '';
        
        if (masterData.departments.length === 0) {
            list.innerHTML = '<p style="color: #999; text-align: center;">éƒ¨ç½²ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
            return;
        }
        
        masterData.departments.forEach(dept => {
            const div = document.createElement('div');
            div.className = 'master-item';
            div.innerHTML = `
                <span class="master-item-name">${dept}</span>
                <button class="btn-delete" onclick="deleteDepartment('${dept}')">å‰Šé™¤</button>
            `;
            list.appendChild(div);
        });
    }

    // ãƒ©ã‚¤ãƒ³åç®¡ç†
    function addLine() {
        const dept = document.getElementById('lineManageDept').value;
        const input = document.getElementById('newLine');
        const lineName = input.value.trim();
        
        if (!dept) {
            alert('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }
        
        if (!lineName) {
            alert('ãƒ©ã‚¤ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        
        if (!masterData.lines[dept]) {
            masterData.lines[dept] = [];
        }
        
        if (masterData.lines[dept].includes(lineName)) {
            alert('ã“ã®ãƒ©ã‚¤ãƒ³åã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
            return;
        }
        
        masterData.lines[dept].push(lineName);
        saveMasterData();
        updateLineManageList();
        input.value = '';
    }

    function deleteLine(dept, lineName) {
        if (!confirm(`ã€Œ${lineName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
            return;
        }
        
        masterData.lines[dept] = masterData.lines[dept].filter(l => l !== lineName);
        saveMasterData();
        updateLineManageList();
    }

    function updateLineManageList() {
        const dept = document.getElementById('lineManageDept').value;
        const list = document.getElementById('lineList');
        list.innerHTML = '';
        
        if (!dept) {
            list.innerHTML = '<p style="color: #999; text-align: center;">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</p>';
            return;
        }
        
        if (!masterData.lines[dept] || masterData.lines[dept].length === 0) {
            list.innerHTML = '<p style="color: #999; text-align: center;">ãƒ©ã‚¤ãƒ³åãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
            return;
        }
        
        masterData.lines[dept].forEach(line => {
            const div = document.createElement('div');
            div.className = 'master-item';
            div.innerHTML = `
                <span class="master-item-name">${line}</span>
                <button class="btn-delete" onclick="deleteLine('${dept}', '${line}')">å‰Šé™¤</button>
            `;
            list.appendChild(div);
        });
    }

    // å‡¦ç½®è€…ç®¡ç†
    function addHandler() {
        const dept = document.getElementById('handlerManageDept').value;
        const input = document.getElementById('newHandler');
        const handlerName = input.value.trim();
        
        if (!dept) {
            alert('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }
        
        if (!handlerName) {
            alert('å‡¦ç½®è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        
        if (!masterData.handlers[dept]) {
            masterData.handlers[dept] = [];
        }
        
        if (masterData.handlers[dept].includes(handlerName)) {
            alert('ã“ã®å‡¦ç½®è€…ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
            return;
        }
        
        masterData.handlers[dept].push(handlerName);
        saveMasterData();
        updateHandlerManageList();
        input.value = '';
    }

    function deleteHandler(dept, handlerName) {
        if (!confirm(`ã€Œ${handlerName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
            return;
        }
        
        masterData.handlers[dept] = masterData.handlers[dept].filter(h => h !== handlerName);
        saveMasterData();
        updateHandlerManageList();
    }

    function updateHandlerManageList() {
        const dept = document.getElementById('handlerManageDept').value;
        const list = document.getElementById('handlerList');
        list.innerHTML = '';
        
        if (!dept) {
            list.innerHTML = '<p style="color: #999; text-align: center;">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</p>';
            return;
        }
        
        if (!masterData.handlers[dept] || masterData.handlers[dept].length === 0) {
            list.innerHTML = '<p style="color: #999; text-align: center;">å‡¦ç½®è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
            return;
        }
        
        masterData.handlers[dept].forEach(handler => {
            const div = document.createElement('div');
            div.className = 'master-item';
            div.innerHTML = `
                <span class="master-item-name">${handler}</span>
                <button class="btn-delete" onclick="deleteHandler('${dept}', '${handler}')">å‰Šé™¤</button>
            `;
            list.appendChild(div);
        });
    }

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById(tabName).classList.add('active');

        if (tabName === 'history') {
            updateHistory();
        } else if (tabName === 'technical') {
            updateSerialNoSelect();
        } else if (tabName === 'analysis') {
            updateAnalysis();
        }
    }

    // NOWæ©Ÿèƒ½: å‹¤å‹™æ™‚é–“è€ƒæ…®ã—ãŸæ—¥ä»˜è¨­å®š (8:00ã€œç¿Œ6:00ã€0:00ã€œ6:00ã¯å‰æ—¥æ‰±ã„)
    function setNowDate() {
        const now = new Date();
        const hour = now.getHours();
        
        // 0æ™‚ã€œ6æ™‚ã¯å‰æ—¥æ‰±ã„
        if (hour >= 0 && hour < 6) {
            now.setDate(now.getDate() - 1);
        }
        
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        
        document.getElementById('occurrenceDate').value = `${year}-${month}-${day}`;
    }

    // NOWæ©Ÿèƒ½: ç¾åœ¨æ™‚åˆ»è¨­å®š
    function setNowTime(fieldId) {
        const now = new Date();
        const hour = String(now.getHours()).padStart(2, '0');
        const minute = String(now.getMinutes()).padStart(2, '0');
        
        document.getElementById(fieldId).value = `${hour}:${minute}`;
    }

    // é¡ä¼¼æ•´ç†Noæ¤œç´¢ã¨å€™è£œãƒ¯ãƒ¼ãƒ‰è¡¨ç¤º
    function searchSimilarSerialNo() {
        const inputSerialNo = document.getElementById('serialNo').value.trim();
        const suggestionArea = document.getElementById('suggestionArea');
        const suggestionButtons = document.getElementById('suggestionButtons');
        
        if (!inputSerialNo) {
            suggestionArea.style.display = 'none';
            return;
        }

        // æ•´ç†Noï¼ˆå“ç•ªï¼‰ãŒå®Œå…¨ä¸€è‡´ã™ã‚‹éå»ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
        const similarData = anomalyData.filter(item => {
            return item.serialNo === inputSerialNo; // å®Œå…¨ä¸€è‡´
        }).slice(0, 10); // æœ€å¤§10ä»¶

        if (similarData.length === 0) {
            suggestionArea.style.display = 'none';
            return;
        }

        // å„ã‚«ãƒ†ã‚´ãƒªã®å€™è£œã‚’æŠ½å‡ºï¼ˆæœ€å¤§4å€‹ãšã¤ï¼‰
        const anomalyContents = extractTopCandidates(similarData, 'anomalyContent', 4);
        const actionTakens = extractTopCandidates(similarData, 'actionTaken', 4);

        let html = '';

        // ç•°å¸¸å†…å®¹ã®å€™è£œ
        if (anomalyContents.length > 0) {
            html += `
                <div class="suggestion-category">
                    <div class="suggestion-category-title">ğŸ“ ç•°å¸¸å†…å®¹ã®å€™è£œï¼ˆå“ç•ª: ${inputSerialNo}ï¼‰</div>
                    <div>
                        ${anomalyContents.map(text => 
                            `<button type="button" class="suggestion-btn" onclick="applySuggestion('anomalyContent', '${escapeHtml(text)}')">${truncateText(text, 30)}</button>`
                        ).join('')}
                    </div>
                </div>
            `;
        }

        // è£½é€ å‡¦ç½®å†…å®¹ã®å€™è£œ
        if (actionTakens.length > 0) {
            html += `
                <div class="suggestion-category">
                    <div class="suggestion-category-title">ğŸ”§ è£½é€ å‡¦ç½®å†…å®¹ã®å€™è£œï¼ˆå“ç•ª: ${inputSerialNo}ï¼‰</div>
                    <div>
                        ${actionTakens.map(text => 
                            `<button type="button" class="suggestion-btn" onclick="applySuggestion('actionTaken', '${escapeHtml(text)}')">${truncateText(text, 30)}</button>`
                        ).join('')}
                    </div>
                </div>
            `;
        }

        if (html) {
            suggestionButtons.innerHTML = html;
            suggestionArea.style.display = 'block';
        } else {
            suggestionArea.style.display = 'none';
        }
    }

    // å€™è£œãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºï¼ˆé‡è¤‡é™¤å»ã€å‡ºç¾é »åº¦é †ï¼‰
    function extractTopCandidates(dataArray, field, maxCount) {
        const frequencyMap = {};
        
        dataArray.forEach(item => {
            const text = item[field];
            if (text && text.trim()) {
                frequencyMap[text] = (frequencyMap[text] || 0) + 1;
            }
        });

        // å‡ºç¾é »åº¦é †ã«ã‚½ãƒ¼ãƒˆ
        return Object.entries(frequencyMap)
            .sort((a, b) => b[1] - a[1])
            .slice(0, maxCount)
            .map(entry => entry[0]);
    }

    // å€™è£œã‚’å…¥åŠ›æ¬„ã«é©ç”¨
    function applySuggestion(fieldId, text) {
        const field = document.getElementById(fieldId);
        if (field) {
            field.value = text;
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å ´åˆã¯è‡ªå‹•ãƒªã‚µã‚¤ã‚º
            if (field.tagName === 'TEXTAREA') {
                field.style.height = 'auto';
                field.style.height = field.scrollHeight + 'px';
            }
            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆå°‘ã—å…‰ã‚‰ã›ã‚‹ï¼‰
            field.style.background = '#e1bee7';
            setTimeout(() => {
                field.style.background = '';
            }, 500);
        }
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
        return text.replace(/'/g, '\\\'').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    // ãƒ†ã‚­ã‚¹ãƒˆåˆ‡ã‚Šè©°ã‚
    function truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }

    // å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‡¦ç†
    function handlePhotoUpload(inputId, previewId, photoArray) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        
        input.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoArray.push(e.target.result);
                    displayPhotos(previewId, photoArray);
                };
                reader.readAsDataURL(file);
            });
        });
    }

    function displayPhotos(previewId, photoArray) {
        const preview = document.getElementById(previewId);
        preview.innerHTML = '';
        
        photoArray.forEach((photo, index) => {
            const div = document.createElement('div');
            div.className = 'photo-item';
            div.innerHTML = `
                <img src="${photo}" alt="Photo ${index + 1}">
                <button class="remove-btn" onclick="removePhoto('${previewId}', ${index}, '${previewId === 'mfgPhotoPreview' ? 'mfg' : 'tech'}')">Ã—</button>
            `;
            preview.appendChild(div);
        });
    }

    function removePhoto(previewId, index, type) {
        if (type === 'mfg') {
            mfgPhotos.splice(index, 1);
            displayPhotos(previewId, mfgPhotos);
        } else {
            techPhotos.splice(index, 1);
            displayPhotos(previewId, techPhotos);
        }
    }

    // è£½é€ ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    document.getElementById('manufacturingForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const techRequest = document.getElementById('techRequest').value;
        
        const data = {
            id: Date.now() + Math.random(), // ä¸€æ„ã®IDã‚’ç”Ÿæˆï¼ˆé‡è¤‡å›é¿ï¼‰
            department: document.getElementById('department').value,
            lineName: document.getElementById('lineName').value,
            serialNo: document.getElementById('serialNo').value,
            occurrenceDate: document.getElementById('occurrenceDate').value,
            occurrenceTime: document.getElementById('occurrenceTime').value,
            restartTime: document.getElementById('restartTime').value,
            anomalyContent: document.getElementById('anomalyContent').value,
            actionTaken: document.getElementById('actionTaken').value,
            traceback: document.getElementById('traceback').value,
            handler: document.getElementById('handler').value,
            techRequest: techRequest,
            mfgPhotos: [...mfgPhotos],
            // æŠ€è¡“è¦è«‹ãªã—ã®å ´åˆã¯å®Œäº†æ‰±ã„ã€ã‚ã‚Šã®å ´åˆã¯æŠ€è¡“å…¥åŠ›å¾…ã¡
            status: techRequest === 'å®Œçµ' ? 'complete' : 'pending',
            createdAt: new Date().toISOString()
        };

        anomalyData.push(data);
        saveData();
        
        document.getElementById('lineModal').classList.add('active');
        
        this.reset();
        mfgPhotos = [];
        document.getElementById('mfgPhotoPreview').innerHTML = '';
        
        // ãƒªã‚»ãƒƒãƒˆå¾Œã«éƒ¨ç½²ä¾å­˜ã®é¸æŠè‚¢ã‚‚ã‚¯ãƒªã‚¢
        document.getElementById('lineName').innerHTML = '<option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>';
        document.getElementById('handler').innerHTML = '<option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>';
    });

    // æŠ€è¡“ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    document.getElementById('technicalForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const recordId = document.getElementById('selectSerialNo').value;
        const index = anomalyData.findIndex(item => item.id == recordId); // IDã§æ¤œç´¢
        
        if (index !== -1) {
            anomalyData[index].techHandler = document.getElementById('techHandler').value;
            anomalyData[index].lifespan = document.getElementById('lifespan').value;
            anomalyData[index].maintenanceUnit = document.getElementById('maintenanceUnit').value;
            anomalyData[index].rootCauseAction = document.getElementById('rootCauseAction').value;
            anomalyData[index].recurrenceType = document.getElementById('recurrenceType').value;
            anomalyData[index].techPhotos = [...techPhotos];
            anomalyData[index].status = 'complete';
            anomalyData[index].completedAt = new Date().toISOString();
            
            saveData();
            
            document.getElementById('lineModal').classList.add('active');
            
            this.reset();
            techPhotos = [];
            document.getElementById('techPhotoPreview').innerHTML = '';
            document.getElementById('selectedDataDisplay').style.display = 'none';
            document.getElementById('pastHistoryArea').style.display = 'none';
            document.getElementById('techSuggestionArea').style.display = 'none';
            updateSerialNoSelect();
        }
    });

    // LINEè»¢é€ç¢ºèª
    function confirmLineTransfer() {
        const checkbox = document.getElementById('lineConfirm');
        if (checkbox.checked) {
            alert('LINEé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ âœ“');
        }
        document.getElementById('lineModal').classList.remove('active');
        checkbox.checked = false;
    }

    // æ•´ç†Noé¸æŠè‚¢æ›´æ–°
    function updateSerialNoSelect() {
        const select = document.getElementById('selectSerialNo');
        select.innerHTML = '<option value="">æ•´ç†Noã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
        
        anomalyData
            .filter(item => item.status === 'pending' && item.techRequest === 'è¦è«‹')
            .sort((a, b) => new Date(b.occurrenceDate) - new Date(a.occurrenceDate)) // æ–°ã—ã„é †
            .forEach(item => {
                const option = document.createElement('option');
                option.value = item.id; // IDã§è­˜åˆ¥ï¼ˆæ•´ç†Noã§ã¯ãªãï¼‰
                // è¡¨ç¤º: æ•´ç†No + æ—¥ä»˜ + ç•°å¸¸å†…å®¹
                option.textContent = `[${item.serialNo}] ${item.occurrenceDate} - ${item.anomalyContent.substring(0, 30)}...`;
                select.appendChild(option);
            });
    }

    // è£½é€ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadManufacturingData() {
        const recordId = document.getElementById('selectSerialNo').value;
        const display = document.getElementById('displayContent');
        const selectedDataDisplay = document.getElementById('selectedDataDisplay');
        
        // ãƒ¬ã‚³ãƒ¼ãƒ‰IDãŒæœªé¸æŠã®å ´åˆã¯éè¡¨ç¤º
        if (!recordId) {
            selectedDataDisplay.style.display = 'none';
            document.getElementById('techSuggestionArea').style.display = 'none';
            document.getElementById('pastHistoryArea').style.display = 'none';
            display.innerHTML = '';
            return;
        }
        
        // IDã§æ¤œç´¢ï¼ˆæ•´ç†Noã§ã¯ãªãï¼‰
        const data = anomalyData.find(item => item.id == recordId);
        
        if (data) {
            // å¿…ãšå†…å®¹ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰æ–°ã—ã„å†…å®¹ã‚’è¨­å®š
            display.innerHTML = '';
            
            // æ–°ã—ã„å†…å®¹ã‚’è¨­å®š
            const htmlContent = `
                <div style="display: grid; gap: 10px;">
                    <div><strong>æ•´ç†Noï¼ˆå“ç•ªï¼‰:</strong> ${data.serialNo}</div>
                    ${data.department ? `<div><strong>éƒ¨ç½²:</strong> ${data.department}</div>` : ''}
                    ${data.lineName ? `<div><strong>ãƒ©ã‚¤ãƒ³å:</strong> ${data.lineName}</div>` : ''}
                    <div><strong>ç•°å¸¸å†…å®¹:</strong> ${data.anomalyContent}</div>
                    <div><strong>è£½é€ å‡¦ç½®:</strong> ${data.actionTaken}</div>
                    <div><strong>ç™ºç”Ÿæ—¥:</strong> ${data.occurrenceDate}</div>
                    <div><strong>å‡¦ç½®è€…:</strong> ${data.handler}</div>
                </div>
            `;
            
            display.innerHTML = htmlContent;
            selectedDataDisplay.style.display = 'block';
            
            // éå»ã®åŒä¸€æ•´ç†Noï¼ˆå“ç•ªï¼‰ã®å¯¾å¿œå±¥æ­´ã‚’è¡¨ç¤º
            showPastHistory(data.serialNo, data.id);
            
            // æŠ€è¡“å…¥åŠ›ç”¨ã®å€™è£œãƒ¯ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            showTechSuggestions(data.serialNo);
        } else {
            // ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
            display.innerHTML = '<p style="color: #999;">ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
            selectedDataDisplay.style.display = 'block';
            document.getElementById('techSuggestionArea').style.display = 'none';
            document.getElementById('pastHistoryArea').style.display = 'none';
        }
    }

    // éå»ã®åŒä¸€æ•´ç†Noï¼ˆå“ç•ªï¼‰ã®å¯¾å¿œå±¥æ­´ã‚’è¡¨ç¤º
    function showPastHistory(serialNo, currentRecordId) {
        const pastHistoryArea = document.getElementById('pastHistoryArea');
        const pastHistoryContent = document.getElementById('pastHistoryContent');
        
        // ç¾åœ¨ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ç•°å¸¸å†…å®¹ã‚’å–å¾—
        const currentData = anomalyData.find(item => item.id == currentRecordId);
        if (!currentData || !currentData.anomalyContent) {
            pastHistoryArea.style.display = 'none';
            return;
        }
        
        const currentAnomalyContent = currentData.anomalyContent.toLowerCase();
        
        // ç•°å¸¸å†…å®¹ã‚’ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«åˆ†è§£ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã‚„å¥èª­ç‚¹ã§åŒºåˆ‡ã‚Šã€2æ–‡å­—ä»¥ä¸Šã®ã‚‚ã®ã‚’æŠ½å‡ºï¼‰
        const keywords = currentAnomalyContent
            .replace(/[ã€ã€‚ï¼Œï¼,.\s]+/g, ' ')
            .split(' ')
            .filter(word => word.length >= 2);
        
        // åŒã˜æ•´ç†Noï¼ˆå“ç•ªï¼‰ã§æŠ€è¡“å…¥åŠ›ãŒå®Œäº†ã—ã¦ã„ã‚‹éå»ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
        const pastData = anomalyData.filter(item => {
            if (item.serialNo !== serialNo || 
                item.id == currentRecordId || 
                item.status !== 'complete' ||
                item.techRequest !== 'è¦è«‹' ||
                !item.rootCauseAction ||
                !item.anomalyContent) {
                return false;
            }
            
            // ç•°å¸¸å†…å®¹ã®éƒ¨åˆ†ä¸€è‡´ãƒã‚§ãƒƒã‚¯
            const pastAnomalyContent = item.anomalyContent.toLowerCase();
            
            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã„ãšã‚Œã‹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            return keywords.some(keyword => pastAnomalyContent.includes(keyword));
        }).sort((a, b) => {
            // ä¸€è‡´åº¦ã‚’è¨ˆç®—ï¼ˆä¸€è‡´ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ•°ï¼‰
            const scoreA = keywords.filter(kw => a.anomalyContent.toLowerCase().includes(kw)).length;
            const scoreB = keywords.filter(kw => b.anomalyContent.toLowerCase().includes(kw)).length;
            
            // ä¸€è‡´åº¦ãŒé«˜ã„é †ã€åŒã˜ãªã‚‰æ—¥ä»˜ãŒæ–°ã—ã„é †
            if (scoreB !== scoreA) {
                return scoreB - scoreA;
            }
            return new Date(b.occurrenceDate) - new Date(a.occurrenceDate);
        });

        if (pastData.length === 0) {
            pastHistoryArea.style.display = 'none';
            return;
        }

        let html = `
            <div style="margin-bottom: 10px; padding: 10px; background: #fff; border-radius: 4px; border-left: 3px solid #4caf50;">
                <strong style="color: #2e7d32;">âœ… ã“ã®å“ç•ªï¼ˆ${serialNo}ï¼‰ã§é¡ä¼¼ã®ç•°å¸¸ãŒéå»ã«${pastData.length}ä»¶ã‚ã‚Šã¾ã™</strong>
                <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                    ç¾åœ¨ã®ç•°å¸¸: ${currentData.anomalyContent}
                </div>
            </div>
        `;

        pastData.forEach((item, index) => {
            // ä¸€è‡´åº¦ã‚’è¨ˆç®—
            const matchCount = keywords.filter(kw => item.anomalyContent.toLowerCase().includes(kw)).length;
            const matchRate = Math.round((matchCount / keywords.length) * 100);
            
            html += `
                <div class="past-history-item">
                    <div class="past-history-date">
                        ğŸ“… ${item.occurrenceDate} ${item.occurrenceTime ? `(${item.occurrenceTime})` : ''}
                        ${index === 0 ? '<span style="background: #4caf50; color: white; padding: 2px 8px; border-radius: 10px; margin-left: 10px; font-size: 0.8rem;">æœ€ã‚‚é¡ä¼¼</span>' : ''}
                        <span style="background: #2196f3; color: white; padding: 2px 8px; border-radius: 10px; margin-left: 5px; font-size: 0.8rem;">ä¸€è‡´åº¦ ${matchRate}%</span>
                    </div>
                    
                    <div class="past-history-field">
                        <strong>ğŸ“ ç•°å¸¸å†…å®¹</strong>
                        <div>${item.anomalyContent}</div>
                    </div>
                    
                    <div class="past-history-field">
                        <strong>ğŸ”§ è£½é€ å‡¦ç½®å†…å®¹</strong>
                        <div>${item.actionTaken}</div>
                    </div>
                    
                    <div class="past-history-field">
                        <strong>ğŸ’¡ æŠ€è¡“å‡¦ç½®å†…å®¹ï¼ˆä½•ãŒæ‚ªãã©ã†ã—ãŸï¼‰</strong>
                        <div>${item.rootCauseAction}</div>
                        <button type="button" class="copy-btn" onclick="applySuggestion('rootCauseAction', '${escapeHtml(item.rootCauseAction)}')">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                    </div>
                    
                    ${item.maintenanceUnit ? `
                    <div class="past-history-field">
                        <strong>ğŸ”© ä¿å…¨å˜ä½</strong>
                        <div>${item.maintenanceUnit}</div>
                        <button type="button" class="copy-btn" onclick="applySuggestion('maintenanceUnit', '${escapeHtml(item.maintenanceUnit)}')">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                    </div>
                    ` : ''}
                    
                    <div style="margin-top: 10px; font-size: 0.85rem; color: #666;">
                        ${item.techHandler ? `æŠ€è¡“å‡¦ç½®è€…: ${item.techHandler} | ` : ''}
                        ${item.recurrenceType ? `åŒºåˆ†: ${item.recurrenceType} | ` : ''}
                        ${item.department ? `éƒ¨ç½²: ${item.department}` : ''}
                    </div>
                </div>
            `;
        });

        pastHistoryContent.innerHTML = html;
        pastHistoryArea.style.display = 'block';
    }

    // æŠ€è¡“å…¥åŠ›ç”¨ã®å€™è£œãƒ¯ãƒ¼ãƒ‰è¡¨ç¤º
    function showTechSuggestions(serialNo) {
        const techSuggestionArea = document.getElementById('techSuggestionArea');
        const techSuggestionButtons = document.getElementById('techSuggestionButtons');
        
        if (!serialNo) {
            techSuggestionArea.style.display = 'none';
            return;
        }

        // æ•´ç†Noï¼ˆå“ç•ªï¼‰ãŒå®Œå…¨ä¸€è‡´ã§æŠ€è¡“å…¥åŠ›ãŒå®Œäº†ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
        const similarData = anomalyData.filter(item => {
            return item.serialNo === serialNo && // å®Œå…¨ä¸€è‡´
                   item.status === 'complete' &&
                   item.techRequest === 'è¦è«‹';
        }).slice(0, 10);

        if (similarData.length === 0) {
            techSuggestionArea.style.display = 'none';
            return;
        }

        // æŠ€è¡“å‡¦ç½®å†…å®¹ã®å€™è£œã‚’æŠ½å‡º
        const rootCauseActions = extractTopCandidates(similarData.filter(d => d.rootCauseAction), 'rootCauseAction', 4);
        const maintenanceUnits = extractTopCandidates(similarData.filter(d => d.maintenanceUnit), 'maintenanceUnit', 4);

        let html = '';

        // æŠ€è¡“å‡¦ç½®å†…å®¹ã®å€™è£œ
        if (rootCauseActions.length > 0) {
            html += `
                <div class="suggestion-category">
                    <div class="suggestion-category-title">ğŸ’¡ æŠ€è¡“å‡¦ç½®å†…å®¹ã®å€™è£œï¼ˆå“ç•ª: ${serialNo}ï¼‰</div>
                    <div>
                        ${rootCauseActions.map(text => 
                            `<button type="button" class="suggestion-btn" onclick="applySuggestion('rootCauseAction', '${escapeHtml(text)}')">${truncateText(text, 30)}</button>`
                        ).join('')}
                    </div>
                </div>
            `;
        }

        // ä¿å…¨å˜ä½ã®å€™è£œ
        if (maintenanceUnits.length > 0) {
            html += `
                <div class="suggestion-category">
                    <div class="suggestion-category-title">ğŸ”© ä¿å…¨å˜ä½ã®å€™è£œï¼ˆå“ç•ª: ${serialNo}ï¼‰</div>
                    <div>
                        ${maintenanceUnits.map(text => 
                            `<button type="button" class="suggestion-btn" onclick="applySuggestion('maintenanceUnit', '${escapeHtml(text)}')">${truncateText(text, 20)}</button>`
                        ).join('')}
                    </div>
                </div>
            `;
        }

        if (html) {
            techSuggestionButtons.innerHTML = html;
            techSuggestionArea.style.display = 'block';
        } else {
            techSuggestionArea.style.display = 'none';
        }
    }

    // å±¥æ­´è¡¨ç¤ºæ›´æ–°
    function updateHistory() {
        if (currentView === 'card') {
            updateCardView();
        } else {
            updateTableView();
        }
    }

    function updateCardView() {
        const cardView = document.getElementById('cardView');
        
        if (anomalyData.length === 0) {
            cardView.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“­</div>
                    <p>ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            `;
            return;
        }
        
        cardView.innerHTML = anomalyData.map(item => {
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®ãƒ­ã‚¸ãƒƒã‚¯
            let statusText = 'å®Œäº†';
            let statusClass = 'status-complete';
            
            if (item.status === 'pending') {
                statusText = 'æŠ€è¡“å…¥åŠ›å¾…ã¡';
                statusClass = 'status-pending';
            } else if (item.status === 'complete' && item.techRequest === 'å®Œçµ') {
                statusText = 'å®Œäº†ï¼ˆè£½é€ å®Œçµï¼‰';
                statusClass = 'status-complete';
            } else if (item.status === 'complete' && item.techRequest === 'è¦è«‹') {
                statusText = 'å®Œäº†';
                statusClass = 'status-complete';
            }
            
            return `
            <div class="anomaly-card ${item.status === 'complete' ? 'complete' : ''}">
                <div class="card-header">
                    <div class="card-id">${item.serialNo}</div>
                    <div class="card-status ${statusClass}">
                        ${statusText}
                    </div>
                </div>
                <div class="card-body">
                    ${item.department ? `
                    <div class="card-field">
                        <div class="field-label">éƒ¨ç½²</div>
                        <div class="field-value">${item.department}</div>
                    </div>
                    ` : ''}
                    ${item.lineName ? `
                    <div class="card-field">
                        <div class="field-label">ãƒ©ã‚¤ãƒ³å</div>
                        <div class="field-value">${item.lineName}</div>
                    </div>
                    ` : ''}
                    ${item.techRequest ? `
                    <div class="card-field">
                        <div class="field-label">æŠ€è¡“è¦è«‹</div>
                        <div class="field-value">${item.techRequest === 'è¦è«‹' ? 'æŠ€è¡“è¦è«‹ã‚ã‚Š' : 'è£½é€ ã§å®Œçµ'}</div>
                    </div>
                    ` : ''}
                    <div class="card-field">
                        <div class="field-label">ç•°å¸¸å†…å®¹</div>
                        <div class="field-value">${item.anomalyContent}</div>
                    </div>
                    <div class="card-field">
                        <div class="field-label">è£½é€ å‡¦ç½®</div>
                        <div class="field-value">${item.actionTaken}</div>
                    </div>
                    <div class="card-field">
                        <div class="field-label">ç™ºç”Ÿæ—¥æ™‚</div>
                        <div class="field-value">${item.occurrenceDate} ${item.occurrenceTime || ''}</div>
                    </div>
                    <div class="card-field">
                        <div class="field-label">å‡¦ç½®è€…</div>
                        <div class="field-value">${item.handler}</div>
                    </div>
                    ${item.status === 'complete' && item.techRequest === 'è¦è«‹' ? `
                    <div class="card-field">
                        <div class="field-label">æŠ€è¡“å‡¦ç½®è€…</div>
                        <div class="field-value">${item.techHandler || '-'}</div>
                    </div>
                    <div class="card-field">
                        <div class="field-label">ä¿å…¨å˜ä½</div>
                        <div class="field-value">${item.maintenanceUnit || '-'}</div>
                    </div>
                    <div class="card-field">
                        <div class="field-label">åŸå› ãƒ»å¯¾ç­–</div>
                        <div class="field-value">${item.rootCauseAction || '-'}</div>
                    </div>
                    <div class="card-field">
                        <div class="field-label">å†ç™º/æ–°è¦</div>
                        <div class="field-value">${item.recurrenceType || '-'}</div>
                    </div>
                    ` : ''}
                    <div class="action-btns" style="margin-top: 10px;">
                        <button class="btn-small btn-delete" onclick="deleteRecord(${item.id})">å‰Šé™¤</button>
                    </div>
                </div>
            </div>
        `;
        }).join('');
    }

    function updateTableView() {
        const tableView = document.getElementById('tableView');
        
        if (anomalyData.length === 0) {
            tableView.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“­</div>
                    <p>ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            `;
            return;
        }
        
        tableView.innerHTML = `
            <table>
                <thead>
                    <tr>
                        <th>æ•´ç†No</th>
                        <th>éƒ¨ç½²</th>
                        <th>ãƒ©ã‚¤ãƒ³</th>
                        <th>ç•°å¸¸å†…å®¹</th>
                        <th>ç™ºç”Ÿæ—¥</th>
                        <th>å‡¦ç½®è€…</th>
                        <th>çŠ¶æ…‹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    ${anomalyData.map(item => `
                        <tr>
                            <td>${item.serialNo}</td>
                            <td>${item.department || '-'}</td>
                            <td>${item.lineName || '-'}</td>
                            <td>${item.anomalyContent.substring(0, 30)}...</td>
                            <td>${item.occurrenceDate}</td>
                            <td>${item.handler}</td>
                            <td><span class="card-status ${item.status === 'complete' ? 'status-complete' : 'status-pending'}">
                                ${item.status === 'complete' ? 'å®Œäº†' : 'å¾…ã¡'}
                            </span></td>
                            <td>
                                <button class="btn-small btn-delete" onclick="deleteRecord(${item.id})">å‰Šé™¤</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    function toggleView(view) {
        currentView = view;
        document.querySelectorAll('.view-toggle button').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        if (view === 'card') {
            document.getElementById('cardView').style.display = 'grid';
            document.getElementById('tableView').style.display = 'none';
        } else {
            document.getElementById('cardView').style.display = 'none';
            document.getElementById('tableView').style.display = 'block';
        }
        
        updateHistory();
    }

    function deleteRecord(id) {
        if (confirm('ã“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
            anomalyData = anomalyData.filter(item => item.id !== id);
            saveData();
            updateHistory();
            updateSerialNoSelect();
        }
    }

    // CSVå‡ºåŠ›
    function exportCSV() {
        if (anomalyData.length === 0) {
            alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }

        const headers = ['æ•´ç†No', 'éƒ¨ç½²', 'ãƒ©ã‚¤ãƒ³å', 'ç™ºç”Ÿæ—¥', 'ç™ºç”Ÿæ™‚åˆ»', 'å†é–‹æ™‚åˆ»', 'ç•°å¸¸å†…å®¹', 'è£½é€ å‡¦ç½®å†…å®¹', 'é¡ã‚Š', 'å‡¦ç½®è€…', 'æŠ€è¡“è¦è«‹', 'æŠ€è¡“å‡¦ç½®è€…', 'å‘½æ•°æœ‰ç„¡', 'ä¿å…¨å˜ä½', 'åŸå› å¯¾ç­–', 'å†ç™ºæ–°è¦', 'çŠ¶æ…‹'];
        const rows = anomalyData.map(item => [
            item.serialNo,
            item.department || '',
            item.lineName || '',
            item.occurrenceDate,
            item.occurrenceTime || '',
            item.restartTime || '',
            item.anomalyContent,
            item.actionTaken,
            item.traceback,
            item.handler,
            item.techRequest === 'è¦è«‹' ? 'æŠ€è¡“è¦è«‹ã‚ã‚Š' : item.techRequest === 'å®Œçµ' ? 'è£½é€ ã§å®Œçµ' : '',
            item.techHandler || '',
            item.lifespan || '',
            item.maintenanceUnit || '',
            item.rootCauseAction || '',
            item.recurrenceType || '',
            item.status === 'complete' ? 'å®Œäº†' : 'æŠ€è¡“å…¥åŠ›å¾…ã¡'
        ]);

        let csv = '\uFEFF' + headers.join(',') + '\n';
        rows.forEach(row => {
            csv += row.map(cell => `"${cell}"`).join(',') + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `ç•°å¸¸å±¥æ­´_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
    }

    // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    function importCSV(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™');
                    return;
                }

                const dataLines = lines.slice(1);
                let importCount = 0;

                dataLines.forEach(line => {
                    const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g).map(v => v.replace(/^"|"$/g, ''));
                    
                    if (values.length >= 10) {
                        // æŠ€è¡“è¦è«‹ã®å€¤ã‚’å¤‰æ›
                        let techRequest = '';
                        if (values[10] === 'æŠ€è¡“è¦è«‹ã‚ã‚Š') {
                            techRequest = 'è¦è«‹';
                        } else if (values[10] === 'è£½é€ ã§å®Œçµ') {
                            techRequest = 'å®Œçµ';
                        }
                        
                        const data = {
                            id: Date.now() + importCount,
                            serialNo: values[0],
                            department: values[1] || '',
                            lineName: values[2] || '',
                            occurrenceDate: values[3],
                            occurrenceTime: values[4] || '',
                            restartTime: values[5] || '',
                            anomalyContent: values[6],
                            actionTaken: values[7],
                            traceback: values[8],
                            handler: values[9],
                            techRequest: techRequest,
                            techHandler: values[11] || '',
                            lifespan: values[12] || '',
                            maintenanceUnit: values[13] || '',
                            rootCauseAction: values[14] || '',
                            recurrenceType: values[15] || '',
                            status: values[16] === 'å®Œäº†' ? 'complete' : 'pending',
                            mfgPhotos: [],
                            techPhotos: [],
                            createdAt: new Date().toISOString()
                        };
                        
                        anomalyData.push(data);
                        importCount++;
                    }
                });

                saveData();
                updateHistory();
                updateSerialNoSelect();
                alert(`${importCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
            } catch (error) {
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                console.error(error);
            }
        };
        reader.readAsText(file, 'UTF-8');
        event.target.value = '';
    }

    // åˆæœŸåŒ–
    handlePhotoUpload('mfgPhotos', 'mfgPhotoPreview', mfgPhotos);
    handlePhotoUpload('techPhotos', 'techPhotoPreview', techPhotos);
    loadData();

    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®šï¼ˆå‹¤å‹™ã‚·ãƒ•ãƒˆè€ƒæ…®ï¼‰
    setNowDate();

    // === åˆ†ææ©Ÿèƒ½ ===

    // åˆ†æãƒšãƒ¼ã‚¸æ›´æ–°
    function updateAnalysis() {
        updateStatistics();
        updateTrendAnalysis();
        updateDepartmentAnalysis();
        updateRecurrenceAnalysis();
        updateSearchDepartmentSelect();
    }

    // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ã®éƒ¨ç½²é¸æŠè‚¢ã‚’æ›´æ–°
    function updateSearchDepartmentSelect() {
        const select = document.getElementById('searchDepartment');
        const currentValue = select.value;
        select.innerHTML = '<option value="">ã™ã¹ã¦</option>';
        
        masterData.departments.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept;
            option.textContent = dept;
            select.appendChild(option);
        });
        
        if (currentValue && masterData.departments.includes(currentValue)) {
            select.value = currentValue;
            updateSearchLineOptions();
        }
    }

    // é¡ä¼¼ç•°å¸¸æ¤œç´¢
    function searchSimilarAnomalies() {
        const keyword = document.getElementById('searchKeyword').value.trim().toLowerCase();
        const department = document.getElementById('searchDepartment').value;
        const line = document.getElementById('searchLine').value;
        const serialNo = document.getElementById('searchSerialNo').value.trim();
        const resultsDiv = document.getElementById('similarResults');
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        let results = anomalyData.filter(item => {
            // éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿
            if (department && item.department !== department) return false;
            
            // ãƒ©ã‚¤ãƒ³åãƒ•ã‚£ãƒ«ã‚¿
            if (line && item.lineName !== line) return false;
            
            // æ•´ç†Noãƒ•ã‚£ãƒ«ã‚¿
            if (serialNo && !item.serialNo.toLowerCase().includes(serialNo.toLowerCase())) return false;
            
            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰
            if (keyword) {
                const content = (item.anomalyContent + ' ' + item.actionTaken + ' ' + (item.rootCauseAction || '')).toLowerCase();
                return content.includes(keyword);
            }
            
            return true;
        });

        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
        if (keyword) {
            results = results.map(item => {
                const content = (item.anomalyContent + ' ' + item.actionTaken + ' ' + (item.rootCauseAction || '')).toLowerCase();
                const score = (content.match(new RegExp(keyword, 'g')) || []).length;
                return { ...item, score };
            }).sort((a, b) => b.score - a.score);
        } else {
            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãªã—ã®å ´åˆã¯æ—¥ä»˜é †ï¼ˆæ–°ã—ã„é †ï¼‰
            results.sort((a, b) => new Date(b.occurrenceDate) - new Date(a.occurrenceDate));
        }

        if (results.length === 0) {
            resultsDiv.innerHTML = '<p style="color: #999;">è©²å½“ã™ã‚‹ç•°å¸¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
            return;
        }

        const filterInfo = [];
        if (department) filterInfo.push(`éƒ¨ç½²: ${department}`);
        if (line) filterInfo.push(`ãƒ©ã‚¤ãƒ³: ${line}`);
        if (serialNo) filterInfo.push(`æ•´ç†No: ${serialNo}`);
        if (keyword) filterInfo.push(`ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${keyword}`);

        resultsDiv.innerHTML = `
            <div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 6px;">
                <strong>æ¤œç´¢æ¡ä»¶:</strong> ${filterInfo.length > 0 ? filterInfo.join(' / ') : 'ã™ã¹ã¦'}
            </div>
            <p style="margin-bottom: 15px; font-weight: bold; color: #333;">è©²å½“ä»¶æ•°: ${results.length}ä»¶</p>
            ${results.map(item => `
                <div class="similar-item">
                    <div class="similar-item-header">
                        <div>
                            <strong style="color: #ff9800;">${item.serialNo}</strong>
                            <span style="color: #666; margin-left: 10px;">${item.occurrenceDate}</span>
                        </div>
                        ${keyword && item.score ? `<span class="similar-score">ä¸€è‡´åº¦: ${item.score}</span>` : ''}
                    </div>
                    ${item.department || item.lineName ? `
                    <div style="margin-bottom: 8px;">
                        ${item.department ? `<span style="background: #e3f2fd; padding: 3px 10px; border-radius: 12px; font-size: 0.85rem; margin-right: 5px;">${item.department}</span>` : ''}
                        ${item.lineName ? `<span style="background: #fff3e0; padding: 3px 10px; border-radius: 12px; font-size: 0.85rem;">${item.lineName}</span>` : ''}
                    </div>
                    ` : ''}
                    <div style="margin-bottom: 8px;">
                        <strong>ç•°å¸¸å†…å®¹:</strong> ${item.anomalyContent}
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>è£½é€ å‡¦ç½®:</strong> ${item.actionTaken}
                    </div>
                    ${item.rootCauseAction ? `
                    <div style="margin-bottom: 8px; background: #f1f8e9; padding: 10px; border-radius: 4px; border-left: 3px solid #8bc34a;">
                        <strong style="color: #558b2f;">ğŸ’¡ æŠ€è¡“å¯¾ç­–:</strong> ${item.rootCauseAction}
                    </div>
                    ` : ''}
                    <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                        ${item.handler ? `å‡¦ç½®è€…: ${item.handler}` : ''}
                        ${item.handler && item.techHandler ? ' / ' : ''}
                        ${item.techHandler ? `æŠ€è¡“å‡¦ç½®è€…: ${item.techHandler}` : ''}
                    </div>
                </div>
            `).join('')}
        `;
    }

    // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ã®ãƒ©ã‚¤ãƒ³åé¸æŠè‚¢ã‚’æ›´æ–°
    function updateSearchLineOptions() {
        const dept = document.getElementById('searchDepartment').value;
        const lineSelect = document.getElementById('searchLine');
        
        lineSelect.innerHTML = '<option value="">ã™ã¹ã¦</option>';
        
        if (dept && masterData.lines[dept]) {
            masterData.lines[dept].forEach(line => {
                const option = document.createElement('option');
                option.value = line;
                option.textContent = line;
                lineSelect.appendChild(option);
            });
        }
    }

    // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‚¯ãƒªã‚¢
    function clearSearchFilters() {
        document.getElementById('searchDepartment').value = '';
        document.getElementById('searchLine').value = '';
        document.getElementById('searchLine').innerHTML = '<option value="">ã™ã¹ã¦</option>';
        document.getElementById('searchSerialNo').value = '';
        document.getElementById('searchKeyword').value = '';
        document.getElementById('similarResults').innerHTML = '';
    }

    // çµ±è¨ˆæƒ…å ±æ›´æ–°
    function updateStatistics() {
        const total = anomalyData.length;
        const completed = anomalyData.filter(item => item.status === 'complete').length;
        const pending = total - completed;
        
        // ä»Šæœˆã®ç•°å¸¸ä»¶æ•°
        const now = new Date();
        const thisMonth = anomalyData.filter(item => {
            const itemDate = new Date(item.occurrenceDate);
            return itemDate.getMonth() === now.getMonth() && itemDate.getFullYear() === now.getFullYear();
        }).length;

        // å¹³å‡å¯¾å¿œæ™‚é–“ï¼ˆç™ºç”Ÿã€œå†é–‹ï¼‰
        let avgTime = 0;
        let timeCount = 0;
        anomalyData.forEach(item => {
            if (item.occurrenceTime && item.restartTime) {
                const [oh, om] = item.occurrenceTime.split(':').map(Number);
                const [rh, rm] = item.restartTime.split(':').map(Number);
                let minutes = (rh * 60 + rm) - (oh * 60 + om);
                if (minutes < 0) minutes += 24 * 60; // æ—¥è·¨ãå¯¾å¿œ
                avgTime += minutes;
                timeCount++;
            }
        });
        avgTime = timeCount > 0 ? Math.round(avgTime / timeCount) : 0;

        const statsDiv = document.getElementById('statisticsDisplay');
        statsDiv.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div class="stat-card">
                    <h4>ç·ç•°å¸¸ä»¶æ•°</h4>
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">ä»¶</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #2e7d32 0%, #66bb6a 100%);">
                    <h4>å¯¾å¿œå®Œäº†</h4>
                    <div class="stat-value">${completed}</div>
                    <div class="stat-label">ä»¶ (${total > 0 ? Math.round(completed / total * 100) : 0}%)</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f57c00 0%, #ffb74d 100%);">
                    <h4>å¯¾å¿œå¾…ã¡</h4>
                    <div class="stat-value">${pending}</div>
                    <div class="stat-label">ä»¶</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #c62828 0%, #ef5350 100%);">
                    <h4>ä»Šæœˆã®ç•°å¸¸</h4>
                    <div class="stat-value">${thisMonth}</div>
                    <div class="stat-label">ä»¶</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%);">
                    <h4>å¹³å‡å¯¾å¿œæ™‚é–“</h4>
                    <div class="stat-value">${avgTime}</div>
                    <div class="stat-label">åˆ†</div>
                </div>
            </div>
        `;
    }

    // æœˆåˆ¥å‚¾å‘åˆ†æ
    function updateTrendAnalysis() {
        const monthlyData = {};
        
        anomalyData.forEach(item => {
            const date = new Date(item.occurrenceDate);
            const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            monthlyData[key] = (monthlyData[key] || 0) + 1;
        });

        const sortedMonths = Object.keys(monthlyData).sort();
        const maxCount = Math.max(...Object.values(monthlyData));

        const chartDiv = document.getElementById('trendChart');
        chartDiv.innerHTML = sortedMonths.map(month => {
            const count = monthlyData[month];
            const percentage = (count / maxCount) * 100;
            return `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: bold;">${month}</span>
                        <span style="color: #666;">${count}ä»¶</span>
                    </div>
                    <div style="background: #e0e0e0; height: 30px; border-radius: 4px; overflow: hidden;">
                        <div class="chart-bar" style="width: ${percentage}%;">${count}ä»¶</div>
                    </div>
                </div>
            `;
        }).join('');

        // å‚¾å‘åˆ†æ
        const analysisDiv = document.getElementById('trendAnalysis');
        if (sortedMonths.length >= 3) {
            const recent3 = sortedMonths.slice(-3).map(m => monthlyData[m]);
            const avgRecent = recent3.reduce((a, b) => a + b, 0) / 3;
            const previous = sortedMonths.slice(-6, -3).map(m => monthlyData[m]);
            const avgPrevious = previous.length > 0 ? previous.reduce((a, b) => a + b, 0) / previous.length : avgRecent;

            let trend = '';
            let trendClass = '';
            if (avgRecent > avgPrevious * 1.2) {
                trend = 'å¢—åŠ å‚¾å‘';
                trendClass = 'trend-increase';
            } else if (avgRecent < avgPrevious * 0.8) {
                trend = 'æ¸›å°‘å‚¾å‘';
                trendClass = 'trend-decrease';
            } else {
                trend = 'æ¨ªã°ã„';
                trendClass = 'trend-stable';
            }

            analysisDiv.innerHTML = `
                <div class="analysis-insight">
                    <strong>ğŸ“Š å‚¾å‘åˆ†æ:</strong> 
                    ç›´è¿‘3ãƒ¶æœˆã®å¹³å‡ã¯<strong>${avgRecent.toFixed(1)}ä»¶/æœˆ</strong>ã§ã€
                    <span class="trend-badge ${trendClass}">${trend}</span>ã§ã™ã€‚
                    ${trend === 'å¢—åŠ å‚¾å‘' ? 'âš ï¸ ç•°å¸¸ç™ºç”ŸãŒå¢—ãˆã¦ã„ã¾ã™ã€‚åŸå› ã‚’ç‰¹å®šã—ã€å¯¾ç­–ãŒå¿…è¦ã§ã™ã€‚' : ''}
                    ${trend === 'æ¸›å°‘å‚¾å‘' ? 'âœ… æ”¹å–„ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚ç¾åœ¨ã®å–ã‚Šçµ„ã¿ã‚’ç¶™ç¶šã—ã¾ã—ã‚‡ã†ã€‚' : ''}
                </div>
            `;
        } else {
            analysisDiv.innerHTML = '<p style="color: #999;">ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã‚‹ãŸã‚ã€å‚¾å‘åˆ†æã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“</p>';
        }
    }

    // éƒ¨ç½²ãƒ»ãƒ©ã‚¤ãƒ³åˆ¥åˆ†æ
    function updateDepartmentAnalysis() {
        const deptData = {};
        const lineData = {};

        anomalyData.forEach(item => {
            if (item.department) {
                deptData[item.department] = (deptData[item.department] || 0) + 1;
            }
            if (item.lineName) {
                lineData[item.lineName] = (lineData[item.lineName] || 0) + 1;
            }
        });

        const maxDept = Math.max(...Object.values(deptData), 1);
        const maxLine = Math.max(...Object.values(lineData), 1);

        const analysisDiv = document.getElementById('departmentAnalysis');
        
        let html = '<h4 style="color: #666; margin-bottom: 10px;">éƒ¨ç½²åˆ¥ç•°å¸¸ä»¶æ•°</h4>';
        for (const [dept, count] of Object.entries(deptData).sort((a, b) => b[1] - a[1])) {
            const percentage = (count / maxDept) * 100;
            html += `
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>${dept}</span>
                        <span style="color: #666;">${count}ä»¶</span>
                    </div>
                    <div style="background: #e0e0e0; height: 25px; border-radius: 4px; overflow: hidden;">
                        <div class="chart-bar" style="width: ${percentage}%; height: 25px; font-size: 0.85rem;">${count}ä»¶</div>
                    </div>
                </div>
            `;
        }

        html += '<h4 style="color: #666; margin: 20px 0 10px;">ãƒ©ã‚¤ãƒ³åˆ¥ç•°å¸¸ä»¶æ•°</h4>';
        for (const [line, count] of Object.entries(lineData).sort((a, b) => b[1] - a[1])) {
            const percentage = (count / maxLine) * 100;
            html += `
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>${line}</span>
                        <span style="color: #666;">${count}ä»¶</span>
                    </div>
                    <div style="background: #e0e0e0; height: 25px; border-radius: 4px; overflow: hidden;">
                        <div class="chart-bar" style="width: ${percentage}%; height: 25px; font-size: 0.85rem; background: linear-gradient(90deg, #f57c00 0%, #ffb74d 100%);">${count}ä»¶</div>
                    </div>
                </div>
            `;
        }

        analysisDiv.innerHTML = html || '<p style="color: #999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
    }

    // å†ç™ºãƒ»æ–°è¦åˆ†æ
    function updateRecurrenceAnalysis() {
        const recurrence = anomalyData.filter(item => item.recurrenceType === 'å†ç™º').length;
        const newCases = anomalyData.filter(item => item.recurrenceType === 'æ–°è¦').length;
        const total = recurrence + newCases;

        const analysisDiv = document.getElementById('recurrenceAnalysis');
        
        if (total === 0) {
            analysisDiv.innerHTML = '<p style="color: #999;">æŠ€è¡“å¯¾å¿œæ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            return;
        }

        const recurrenceRate = (recurrence / total * 100).toFixed(1);

        analysisDiv.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div style="text-align: center; padding: 20px; background: #ffebee; border-radius: 8px;">
                    <div style="font-size: 3rem; font-weight: bold; color: #c62828;">${recurrence}</div>
                    <div style="color: #666; margin-top: 5px;">å†ç™ºä»¶æ•°</div>
                </div>
                <div style="text-align: center; padding: 20px; background: #e8f5e9; border-radius: 8px;">
                    <div style="font-size: 3rem; font-weight: bold; color: #2e7d32;">${newCases}</div>
                    <div style="color: #666; margin-top: 5px;">æ–°è¦ä»¶æ•°</div>
                </div>
            </div>
            <div class="analysis-insight">
                <strong>ğŸ”„ å†ç™ºç‡:</strong> ${recurrenceRate}% (${recurrence}/${total}ä»¶)
                ${recurrenceRate > 30 ? '<br>âš ï¸ å†ç™ºç‡ãŒé«˜ã‚ã§ã™ã€‚æ ¹æœ¬åŸå› ã®è¿½æ±‚ã¨æ’ä¹…å¯¾ç­–ãŒå¿…è¦ã§ã™ã€‚' : ''}
                ${recurrenceRate < 20 ? '<br>âœ… å†ç™ºç‡ã¯è‰¯å¥½ã§ã™ã€‚ç¾åœ¨ã®å¯¾ç­–ã‚’ç¶™ç¶šã—ã¾ã—ã‚‡ã†ã€‚' : ''}
            </div>
        `;
    }
</script>
```

</body>
</html>