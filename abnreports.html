<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•°å¸¸å±¥æ­´å…¥åŠ›ãƒ„ãƒ¼ãƒ«ï¼ˆFirebaseé€£æºç‰ˆï¼‰</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Hiragino Sans',sans-serif;background:#f5f5f5}
  .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  .header h1{font-size:1.5rem;margin-bottom:5px}
  .container{max-width:900px;margin:0 auto;padding:10px}
  .tabs{display:flex;background:#fff;margin:15px 0 0;border-radius:8px 8px 0 0;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,.1)}
  .tab{flex:1;padding:15px;text-align:center;cursor:pointer;background:#f8f9fa;border:none;font-size:1rem;font-weight:bold;transition:.3s;color:#666}
  .tab.active{background:#fff;color:#667eea;border-bottom:3px solid #667eea}
  .tab-content{display:none;background:#fff;padding:20px;border-radius:0 0 8px 8px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  .tab-content.active{display:block}
  .form-group{margin-bottom:16px}
  .form-group label{display:block;margin-bottom:8px;font-weight:bold;color:#333;font-size:.95rem}
  .form-group input,.form-group textarea,.form-group select{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:6px;font-size:1rem;transition:border-color .3s}
  .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:#667eea}
  .form-group textarea{min-height:100px;resize:vertical}
  .time-group{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .photo-upload{border:2px dashed #e0e0e0;border-radius:6px;padding:20px;text-align:center;cursor:pointer;transition:.3s}
  .photo-upload:hover{border-color:#667eea;background:#f8f9ff}
  .photo-upload input[type=file]{display:none}
  .photo-preview{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-top:15px}
  .photo-item{position:relative;aspect-ratio:1;border-radius:6px;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,.1)}
  .photo-item img{width:100%;height:100%;object-fit:cover}
  .photo-item .remove-btn{position:absolute;top:5px;right:5px;background:rgba(255,59,48,.9);color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:14px;line-height:1}
  .btn{width:100%;padding:14px;border:none;border-radius:6px;font-size:1rem;font-weight:bold;cursor:pointer;transition:.3s;margin-top:10px}
  .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
  .btn-secondary{background:#6c757d;color:#fff}
  .btn-export{background:#28a745;color:#fff}
  .history-controls{display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap}
  .view-toggle{display:flex;gap:5px}
  .view-toggle button{padding:8px 12px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:6px;cursor:pointer;font-weight:bold}
  .view-toggle button.active{background:#667eea;color:#fff}
  .card-view{display:grid;gap:12px}
  .anomaly-card{position:relative;background:#fff;border-radius:8px;padding:12px 12px;box-shadow:0 1px 5px rgba(0,0,0,.08);border-left:4px solid #667eea}
  .anomaly-card.complete{border-left-color:#28a745}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid #eee}
  .card-id{font-size:1.05rem;font-weight:700;color:#667eea}
  .card-status{padding:3px 10px;border-radius:12px;font-size:.83rem;font-weight:700}
  .status-pending{background:#fff3cd;color:#856404}
  .status-complete{background:#d4edda;color:#155724}
  .card-body{display:grid;gap:6px}
  .card-field{display:grid;grid-template-columns:110px 1fr;gap:8px}
  .field-label{font-weight:bold;color:#666}
  .field-value{color:#333}
  .table-view{overflow-x:auto;display:none}
  .table-view.active{display:block}
  table{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 1px 6px rgba(0,0,0,.08)}
  th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #eaeaea}
  th{background:#667eea;color:#fff;font-weight:bold;position:sticky;top:0}
  tr:hover{background:#f8f9ff}
  .action-btns{display:flex;gap:6px;flex-wrap:wrap}
  .btn-small{padding:6px 10px;border:none;border-radius:4px;cursor:pointer;font-size:.85rem}
  .btn-edit{background:#ffc107;color:#000}
  .btn-delete{background:#dc3545;color:#fff}
  .empty-state{text-align:center;padding:36px 20px;color:#999}
  .empty-state-icon{font-size:2.5rem;margin-bottom:10px}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
  .modal.active{display:flex}
  .modal-content{background:#fff;padding:20px;border-radius:8px;max-width:680px;width:95%;max-height:90vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .modal-title{font-size:1.1rem;font-weight:bold;margin-bottom:10px;color:#333}
  .edit-tabs{display:flex;gap:8px;margin:8px 0 16px}
  .edit-tab{flex:1;padding:10px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:6px;cursor:pointer;font-weight:bold}
  .edit-tab.active{background:#667eea;color:#fff}
  .modal-actions{display:flex;gap:10px;margin-top:10px}
  .btn-cancel{background:#9e9e9e;color:#fff}
  @media (max-width:600px){
    .card-field{grid-template-columns:1fr;gap:5px}
    .time-group{grid-template-columns:1fr}
    table{font-size:.85rem}
    th,td{padding:8px}
  }
  #authGate{position:fixed;inset:0;background:#f5f5f5;display:flex;align-items:center;justify-content:center;z-index:2000}
  #authCard{background:#fff;max-width:380px;width:92%;padding:24px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
  #signOutBtn{position:fixed;right:12px;top:12px;background:#ef5350;color:#fff;border:none;border-radius:6px;padding:8px 12px;cursor:pointer;z-index:1500}
  /* ãƒ¯ãƒ¼ãƒ‰å€™è£œ */
  .word-suggestions{position:relative;}
  .word-suggestion-box{position:absolute;z-index:100;background:#fff;border:2px solid #667eea;border-radius:8px;padding:10px;max-height:300px;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,.15);display:none;width:100%;margin-top:5px;}
  .word-suggestion-box.active{display:block;}
  .word-suggestion-header{font-size:.85rem;color:#667eea;font-weight:bold;margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid #e0e0e0;}
  .word-tag{display:inline-block;background:#f0f7ff;color:#667eea;padding:6px 12px;margin:3px;border-radius:16px;cursor:pointer;font-size:.85rem;transition:.2s;border:1px solid #e3f2fd;}
  .word-tag:hover{background:#667eea;color:#fff;transform:translateY(-2px);box-shadow:0 2px 8px rgba(102,126,234,.3);}
  /* é¡ä¼¼æ¡ˆä»¶ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ï¼ˆãã®ã¾ã¾ï¼‰ */
  .similar-cases-box{background:#fff4e6;border:2px solid #f57c00;border-radius:8px;padding:15px;margin-bottom:20px;display:none;}
  .similar-cases-box.active{display:block;}
  .similar-cases-header{color:#f57c00;font-weight:bold;margin-bottom:15px;font-size:1rem;display:flex;align-items:center;gap:8px;}
  .similar-case-item{background:#fff;border-left:3px solid #f57c00;border-radius:6px;padding:12px;margin-bottom:10px;}
  .similar-case-item:last-child{margin-bottom:0;}
  .similar-case-date{font-weight:bold;color:#f57c00;margin-bottom:8px;font-size:.95rem;}
  .similar-case-content{font-size:.9rem;color:#333;line-height:1.5;margin-bottom:8px;}
  .similar-case-tech{margin-top:8px;padding-top:8px;border-top:1px solid #ffe0b2;font-size:.9rem;color:#666;}
  .similar-case-tech strong{color:#f57c00;}
  .show-more-btn{width:100%;padding:10px;background:#fff;color:#f57c00;border:2px solid #f57c00;border-radius:6px;font-weight:bold;cursor:pointer;transition:.2s;margin-top:10px;}
  .show-more-btn:hover{background:#f57c00;color:#fff;}
  .similar-photos{margin-top:8px;display:grid;grid-template-columns:repeat(4,1fr);gap:6px;}
  .similar-photos .thumb{aspect-ratio:1;overflow:hidden;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,.1);cursor:pointer;}
  .similar-photos .thumb img{ width:100%; height:100%; object-fit:cover; }
  /* å±¥æ­´ã‚«ãƒ¼ãƒ‰ï¼šå†™çœŸã‚µã‚¤ãƒ‰ */
  .card-body.with-photos{display:grid;grid-template-columns: 1fr 200px;gap:10px;align-items:start;}
  .card-body.with-photos .card-text{display:grid;gap:6px;}
  .card-photos{display:grid;gap:8px;}
  .card-photos .thumbs{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;}
  .card-photos .thumb{position:relative;aspect-ratio:1;border-radius:6px;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,.1);cursor:pointer;}
  .card-photos .thumb img{width:100%; height:100%; object-fit:cover;}
  .card-photos .more{font-size:.85rem; color:#666; text-align:center;}
  @media (max-width:600px){ .card-body.with-photos{ grid-template-columns:1fr; } }
  /* åœæ­¢æ™‚é–“ãƒãƒƒã‚¸ */
  .stop-badge{position:absolute; right:12px; top:10px; padding:6px 10px; border-radius:14px; font-weight:700; font-size:.9rem; color:#fff; background:#1976d2; box-shadow:0 2px 6px rgba(0,0,0,.15);}
  .stop-badge.warn{ background:#f57c00; }
  .stop-badge.danger{ background:#d32f2f; }
</style>
</head>
<body>
  <button id="signOutBtn" style="display:none;">ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ</button>

  <div id="authGate">
    <div id="authCard">
      <h2 style="margin-bottom:10px;color:#667eea;">ğŸ” ã‚µã‚¤ãƒ³ã‚¤ãƒ³</h2>
      <p style="color:#666;margin-bottom:15px;">ç¤¾å†…ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
      <div class="form-group">
        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="email" id="authEmail" placeholder="user@miyama-unitec.co.jp">
      </div>
      <div class="form-group">
        <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="authPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <button class="btn btn-primary" id="authLoginBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <p id="authMsg" style="color:#c62828;margin-top:10px;"></p>
    </div>
  </div>

  <div class="header">
    <h1>ğŸ“‹ ç•°å¸¸å±¥æ­´å…¥åŠ›ãƒ„ãƒ¼ãƒ«</h1>
    <p>Firebaseé€£æºç‰ˆï¼ˆAuth / Firestore / Storageï¼‰</p>
  </div>

  <div class="container" style="display:none" id="appRoot">
    <div class="tabs">
      <button class="tab active" data-tab="manufacturing">è£½é€ å…¥åŠ›</button>
      <button class="tab" data-tab="technical">æŠ€è¡“å…¥åŠ›</button>
      <button class="tab" data-tab="history">å±¥æ­´</button>
      <button class="tab" data-tab="master">âš™ï¸ ç®¡ç†</button>
    </div>

    <!-- è£½é€ å…¥åŠ› -->
    <div id="manufacturing" class="tab-content active">
      <h2 style="margin-bottom:16px;color:#667eea;">è£½é€ éƒ¨é–€ - ç•°å¸¸å ±å‘Š</h2>
      <form id="manufacturingForm">
        <div style="background:#f0f7ff;padding:15px;border-radius:6px;margin-bottom:14px;">
          <h3 style="color:#667eea;margin-bottom:12px;font-size:1.05rem;">ğŸ“… ã„ã¤</h3>
          <div class="form-group">
            <label>ç™ºç”Ÿæ—¥ *</label>
            <div style="display:flex;gap:10px;">
              <input type="date" id="occurrenceDate" required style="flex:1;">
              <button type="button" class="btn btn-secondary" style="width:auto;padding:10px 16px;margin:0;background:#17a2b8;" id="btnNowDate">ğŸ“… NOW</button>
            </div>
          </div>
          <div class="form-group">
            <label>æ™‚åˆ»</label>
            <div class="time-group">
              <div>
                <label style="font-weight:normal;font-size:.9rem;">ç™ºç”Ÿæ™‚åˆ»</label>
                <div style="display:flex;gap:5px;">
                  <input type="time" id="occurrenceTime" style="flex:1;">
                  <button type="button" class="btn btn-secondary" style="width:auto;padding:6px 10px;margin:0;font-size:.85rem;background:#17a2b8;" data-now="occurrenceTime">NOW</button>
                </div>
              </div>
              <div>
                <label style="font-weight:normal;font-size:.9rem;">å†é–‹æ™‚åˆ»</label>
                <div style="display:flex;gap:5px;">
                  <input type="time" id="restartTime" style="flex:1;">
                  <button type="button" class="btn btn-secondary" style="width:auto;padding:6px 10px;margin:0;font-size:.85rem;background:#17a2b8;" data-now="restartTime">NOW</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="background:#fff4e6;padding:15px;border-radius:6px;margin-bottom:14px;">
          <h3 style="color:#f57c00;margin-bottom:12px;font-size:1.05rem;">ğŸ“ ã©ã“ã§</h3>
          <div class="form-group"><label>éƒ¨ç½² *</label><select id="department" required></select></div>
          <div class="form-group"><label>ãƒ©ã‚¤ãƒ³å *</label><select id="lineName" required><option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option></select></div>
          <div class="form-group"><label>å‡¦ç½®è€… *</label><select id="handler" required><option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option></select></div>
        </div>

        <div style="background:#f3e5f5;padding:15px;border-radius:6px;margin-bottom:14px;">
          <h3 style="color:#8e24aa;margin-bottom:12px;font-size:1.05rem;">ğŸ”¢ æ•´ç†No</h3>
          <div class="form-group word-suggestions">
            <label>æ•´ç†No *</label>
            <input type="text" id="serialNo" required placeholder="ä¾‹: 2024-001" list="serialNoList">
            <datalist id="serialNoList"></datalist>
            <div id="serialNoInfo" style="margin-top:8px;padding:8px;background:#f3e5f5;border-radius:4px;font-size:.85rem;color:#8e24aa;display:none;">
              <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ:</strong> ã“ã®æ•´ç†Noã®éå»ãƒ‡ãƒ¼ã‚¿: <span id="serialNoCount">0</span>ä»¶
            </div>
          </div>
        </div>

        <div style="background:#e8f5e9;padding:15px;border-radius:6px;margin-bottom:14px;">
          <h3 style="color:#2e7d32;margin-bottom:12px;font-size:1.05rem;">ğŸ“ ä½•ãŒã‚ã£ãŸ</h3>
          <div class="form-group word-suggestions">
            <label>ç•°å¸¸å†…å®¹ *</label>
            <textarea id="anomalyContent" required></textarea>
            <div id="anomalyWordSuggestions" class="word-suggestion-box">
              <div class="word-suggestion-header">ğŸ’¡ ã‚ˆãä½¿ã‚ã‚Œã‚‹è¡¨ç¾ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ï¼‰</div>
              <div id="anomalyWords"></div>
            </div>
          </div>
          <div class="form-group word-suggestions">
            <label>è£½é€ å‡¦ç½®å†…å®¹ *</label>
            <textarea id="actionTaken" required></textarea>
            <div id="actionWordSuggestions" class="word-suggestion-box">
              <div class="word-suggestion-header">ğŸ’¡ ã‚ˆãä½¿ã‚ã‚Œã‚‹è¡¨ç¾ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ï¼‰</div>
              <div id="actionWords"></div>
            </div>
          </div>
          <div class="form-group"><label>é¡ã‚Š *</label>
            <select id="traceback" required><option value="">é¸æŠ</option><option value="æœ‰">æœ‰</option><option value="ç„¡">ç„¡</option></select>
          </div>
          <div class="form-group"><label>æŠ€è¡“è¦è«‹ *</label>
            <select id="techRequest" required>
              <option value="">é¸æŠ</option><option value="è¦è«‹">æŠ€è¡“è¦è«‹ã‚ã‚Š</option><option value="å®Œçµ">è£½é€ ã§å®Œçµ</option>
            </select>
          </div>

          <!-- è£½é€ å´ã§ã‚‚ã€Œéå»ã®ç•°å¸¸å±¥æ­´ã€ã‚’å‚ç…§ã—ãŸã„æ™‚ã®ãƒœã‚¿ãƒ³ -->
          <button type="button" id="btnShowPastOnMfg" class="btn btn-secondary" style="background:#1976d2;">éå»ã®ç•°å¸¸å±¥æ­´</button>

          <div class="form-group">
            <label>å†™çœŸ</label>
            <div class="photo-upload" onclick="document.getElementById('mfgPhotos').click()">
              <div style="font-size:2rem;">ğŸ“¸</div><p>å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</p>
              <input type="file" id="mfgPhotos" accept="image/*" multiple>
            </div>
            <div id="mfgPhotoPreview" class="photo-preview"></div>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
      </form>

      <!-- è£½é€ å´ï¼šéå»ã®ç•°å¸¸å±¥æ­´ï¼ˆæ‰‹å‹•è¡¨ç¤ºï¼‰ -->
      <div id="mfgSimilarBox" class="similar-cases-box" style="margin-top:14px;">
        <div class="similar-cases-header">ğŸ” éå»ã®ç•°å¸¸å±¥æ­´</div>
        <div id="mfgSimilarContent"></div>
        <button type="button" id="mfgShowMore" class="show-more-btn" style="display:none;">ã‚‚ã£ã¨è¡¨ç¤º</button>
      </div>
    </div>

    <!-- æŠ€è¡“å…¥åŠ› -->
    <div id="technical" class="tab-content">
      <h2 style="margin-bottom:16px;color:#667eea;">æŠ€è¡“éƒ¨é–€ - è¿½åŠ å…¥åŠ›</h2>
      <div class="form-group">
        <label>å¯¾è±¡ã®æ¡ˆä»¶é¸æŠ *</label>
        <select id="selectSerialNo"><option value="">æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„</option></select>
      </div>

      <!-- æŠ€è¡“å´ï¼šãƒœã‚¿ãƒ³ã§é¡ä¼¼æ¡ˆä»¶ï¼ˆå…ƒä»•æ§˜ï¼šé¸æŠæ™‚ã«å‡ºã™ + ãƒœã‚¿ãƒ³ã§ã‚‚å‡ºã›ã‚‹ï¼‰ -->
      <button type="button" id="btnShowPastOnTech" class="btn btn-secondary" style="background:#1976d2;margin-bottom:10px;">éå»ã®ç•°å¸¸å±¥æ­´</button>

      <div id="similarCasesBox" class="similar-cases-box">
        <div class="similar-cases-header">ğŸ” åŒã˜æ•´ç†Noã®éå»å¯¾å¿œäº‹ä¾‹</div>
        <div id="similarCasesContent"></div>
        <button type="button" id="showMoreCases" class="show-more-btn" style="display:none;">ä»–ã®é¡ä¼¼æ¡ˆä»¶ã‚’è¡¨ç¤º</button>
      </div>

      <div id="selectedDataDisplay" style="background:#f8f9ff;padding:15px;border-radius:6px;margin-bottom:14px;display:none;">
        <h3 style="color:#667eea;margin-bottom:8px;">è£½é€ éƒ¨é–€å…¥åŠ›å†…å®¹</h3>
        <div id="displayContent"></div>
      </div>

      <form id="technicalForm">
        <div class="form-group"><label>æŠ€è¡“å‡¦ç½®è€… *</label><input type="text" id="techHandler"></div>
        <div class="form-group">
          <label>ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚° *</label>
          <select id="discoveryTiming" required>
            <option value="">é¸æŠ</option>
            <option value="é‹è»¢ä¸­">é‹è»¢ä¸­</option>
            <option value="é ­å‡ºã—">é ­å‡ºã—</option>
            <option value="åˆç‰©">åˆç‰©</option>
            <option value="çµ‚ç‰©">çµ‚ç‰©</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>
        <div class="form-group" id="previousCheckGroup" style="display:none;">
          <label>å‰å›çµ‚ç‰©ç¢ºèªï¼ˆç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒåˆç‰©ã®å ´åˆï¼‰</label>
          <select id="previousCheck">
            <option value="">é¸æŠ</option>
            <option value="ä¸è¦">ä¸è¦</option>
            <option value="æœª">æœª</option>
            <option value="ç¢ºèªæ¸ˆ">ç¢ºèªæ¸ˆ</option>
          </select>
        </div>
        <div class="form-group"><label>å‘½æ•°æœ‰ç„¡ *</label><select id="lifespan"><option value="">é¸æŠ</option><option value="æœ‰">æœ‰</option><option value="ç„¡">ç„¡</option></select></div>
        <div class="form-group">
          <label>å‘½æ•°åˆ°é” *</label>
          <select id="lifespanReached" required>
            <option value="">é¸æŠ</option>
            <option value="è‡³">è‡³</option>
            <option value="ä¸é”">ä¸é”</option>
          </select>
        </div>
        <div class="form-group"><label>ä¿å…¨å˜ä½</label><input type="text" id="maintenanceUnit"></div>
        <div class="form-group"><label>ä½•ãŒæ‚ªãã©ã†ã—ãŸ</label><textarea id="rootCauseAction"></textarea></div>
        <div class="form-group"><label>å†ç™ºã‹æ–°è¦ã‹ *</label><select id="recurrenceType"><option value="">é¸æŠ</option><option value="å†ç™º">å†ç™º</option><option value="æ–°è¦">æ–°è¦</option></select></div>
        <div class="form-group">
          <label>è‚¯å®š *</label>
          <select id="affirmation" required>
            <option value="">é¸æŠ</option>
            <option value="æœ‰">æœ‰</option>
            <option value="ç„¡">ç„¡</option>
          </select>
        </div>
        <div class="form-group">
          <label>å†™çœŸ</label>
          <div class="photo-upload" onclick="document.getElementById('techPhotos').click()">
            <div style="font-size:2rem;">ğŸ“¸</div><p>å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</p>
            <input type="file" id="techPhotos" accept="image/*" multiple>
          </div>
          <div id="techPhotoPreview" class="photo-preview"></div>
        </div>
        <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
      </form>
    </div>

    <!-- å±¥æ­´ -->
    <div id="history" class="tab-content">
      <h2 style="margin-bottom:16px;color:#667eea;">ç•°å¸¸å±¥æ­´</h2>
      <div class="history-controls">
        <div class="view-toggle"><button class="active" data-view="card">ã‚«ãƒ¼ãƒ‰</button><button data-view="table">ãƒ†ãƒ¼ãƒ–ãƒ«</button></div>
        <button class="btn btn-export" style="flex:1;" id="btnExport">ğŸ“¥ CSVå‡ºåŠ›</button>
      </div>
      <div id="cardView" class="card-view"></div>
      <div id="tableView" class="table-view"></div>
    </div>

    <!-- ç®¡ç† -->
    <div id="master" class="tab-content">
      <h2 style="margin-bottom:16px;color:#667eea;">âš™ï¸ ãƒã‚¹ã‚¿ç®¡ç†</h2>
      <div style="background:#fff;padding:18px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:16px;">
        <h3 style="color:#667eea;margin-bottom:10px;">éƒ¨ç½²ç®¡ç†</h3>
        <div style="display:flex;gap:10px;margin-bottom:12px;">
          <input type="text" id="newDepartment" placeholder="æ–°ã—ã„éƒ¨ç½²å" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button class="btn btn-primary" style="width:auto;padding:10px 20px;margin:0;" id="btnAddDept">è¿½åŠ </button>
        </div>
        <div id="departmentList" style="display:grid;gap:8px;"></div>
      </div>

      <div style="background:#fff;padding:18px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:16px;">
        <h3 style="color:#f57c00;margin-bottom:10px;">ãƒ©ã‚¤ãƒ³åç®¡ç†</h3>
        <div class="form-group"><label>å¯¾è±¡éƒ¨ç½²</label><select id="lineManageDept"><option value="">éƒ¨ç½²ã‚’é¸æŠ</option></select></div>
        <div style="display:flex;gap:10px;margin-bottom:12px;">
          <input type="text" id="newLine" placeholder="æ–°ã—ã„ãƒ©ã‚¤ãƒ³å" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button class="btn btn-primary" style="width:auto;padding:10px 20px;margin:0;background:#f57c00;" id="btnAddLine">è¿½åŠ </button>
        </div>
        <div id="lineList" style="display:grid;gap:8px;"></div>
      </div>

      <div style="background:#fff;padding:18px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);">
        <h3 style="color:#2e7d32;margin-bottom:10px;">å‡¦ç½®è€…ç®¡ç†</h3>
        <div class="form-group"><label>å¯¾è±¡éƒ¨ç½²</label><select id="handlerManageDept"><option value="">éƒ¨ç½²ã‚’é¸æŠ</option></select></div>
        <div style="display:flex;gap:10px;margin-bottom:12px;">
          <input type="text" id="newHandler" placeholder="æ–°ã—ã„å‡¦ç½®è€…å" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button class="btn btn-primary" style="width:auto;padding:10px 20px;margin:0;background:#2e7d32;" id="btnAddHandler">è¿½åŠ </button>
        </div>
        <div id="handlerList" style="display:grid;gap:8px;"></div>
      </div>
    </div>
  </div>

  <!-- å†™çœŸãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="photoModal" class="modal" aria-hidden="true">
    <div class="modal-content" style="max-width:800px;">
      <h3 class="modal-title">ğŸ“· å†™çœŸä¸€è¦§</h3>
      <div id="photoModalContent" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0;"></div>
      <button class="btn btn-cancel" id="btnPhotoClose">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- é¡ä¼¼æ¡ˆä»¶è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="similarCaseDetailModal" class="modal" aria-hidden="true">
    <div class="modal-content" style="max-width:900px;">
      <h3 class="modal-title">ğŸ“‹ é¡ä¼¼æ¡ˆä»¶ã®è©³ç´°</h3>
      <div id="similarCaseDetailContent" style="margin:20px 0;"></div>
      <button class="btn btn-cancel" id="btnSimilarCaseDetailClose">é–‰ã˜ã‚‹</button>
    </div>
  </div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
  import {
    initializeFirestore, persistentLocalCache, getFirestore,
    collection, addDoc, getDocs, onSnapshot, query, orderBy, updateDoc,
    doc, deleteDoc, serverTimestamp, where, limit
  } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
  import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js';

  // ==== Firestoreç„¡æ–™æ å¯¾ç­–ï¼šå±¥æ­´è³¼èª­ã®ä¸Šé™ ====
  const HISTORY_LIMIT = 200; // å¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼ˆå°ã•ãã™ã‚‹ã¨èª­ã¿å–ã‚Šå‰Šæ¸›ï¼‰

  const firebaseConfig = {
    apiKey: "AIzaSyA0YUIpIDh4WB4p1ewiNB0XfwHve0ByljU",
    authDomain: "abnreport-fd733.firebaseapp.com",
    projectId: "abnreport-fd733",
    storageBucket: "abnreport-fd733.appspot.com",
    messagingSenderId: "349748947315",
    appId: "1:349748947315:web:010cb671d2a95bcf1f7d06"
  };

  const app = initializeApp(firebaseConfig);
  // v10æ¨å¥¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥API
  initializeFirestore(app, { localCache: persistentLocalCache() });
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  const gate = document.getElementById('authGate');
  const appRoot = document.getElementById('appRoot');
  const signOutBtn = document.getElementById('signOutBtn');

  document.getElementById('authLoginBtn').addEventListener('click', async ()=>{
    const email = (document.getElementById('authEmail').value||'').trim();
    const pw = document.getElementById('authPassword').value;
    try{
      await setPersistence(auth, browserLocalPersistence);
      await signInWithEmailAndPassword(auth, email, pw);
    }catch(e){
      document.getElementById('authMsg').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ' + (e.code||e.message);
    }
  });
  signOutBtn.addEventListener('click', ()=> signOut(auth));

  onAuthStateChanged(auth, (user)=>{
    if (user){
      gate.style.display='none';
      appRoot.style.display='block';
      signOutBtn.style.display='inline-block';
      bootAfterLogin();
    }else{
      appRoot.style.display='none';
      gate.style.display='flex';
      signOutBtn.style.display='none';
    }
  });

  let anomalyCache = [];
  let mfgPhotos = [];
  let techPhotos = [];
  let currentView='card';
  let mastersCache = null;

  async function fetchMasters(){
    const depSnap = await getDocs(collection(db,'masters','department','items'));
    const lineSnap= await getDocs(collection(db,'masters','line','items'));
    const hSnap   = await getDocs(collection(db,'masters','handler','items'));
    const departments = depSnap.docs.map(d=>d.data().name).sort();
    const lines = {};
    lineSnap.forEach(d=>{
      const {department,name} = d.data();
      if (!lines[department]) lines[department]=[];
      lines[department].push(name);
    });
    Object.keys(lines).forEach(k=> lines[k].sort());
    const handlers = {};
    hSnap.forEach(d=>{
      const {department,name} = d.data();
      if (!handlers[department]) handlers[department]=[];
      handlers[department].push(name);
    });
    Object.keys(handlers).forEach(k=> handlers[k].sort());
    return {departments, lines, handlers};
  }

  /* ===== ãƒ¯ãƒ¼ãƒ‰å€™è£œ ===== */
  function extractCommonWords(field, filterSerialNo = null){
    const words = {};
    let targetData = anomalyCache;
    if (filterSerialNo && filterSerialNo.trim() !== '') {
      targetData = anomalyCache.filter(item => item.serialNo === filterSerialNo.trim());
      if (targetData.length < 3) targetData = anomalyCache;
    }
    targetData.forEach(item => {
      const text = item[field] || '';
      const segments = text.split(/[ã€‚ã€\n]/).filter(s => s.trim().length >= 2);
      segments.forEach(seg => {
        const trimmed = seg.trim();
        if (trimmed.length >= 2 && trimmed.length <= 50) {
          words[trimmed] = (words[trimmed] || 0) + 1;
        }
      });
    });
    return Object.entries(words)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 20)
      .map(([word]) => word);
  }
  function updateSerialNoList(){
    const serialNoCounts = {};
    anomalyCache.forEach(item => {
      if (item.serialNo && item.serialNo.trim() !== '') {
        const no = item.serialNo.trim();
        serialNoCounts[no] = (serialNoCounts[no] || 0) + 1;
      }
    });
    const sortedSerialNos = Object.entries(serialNoCounts)
      .sort((a, b) => b[1] - a[1])
      .map(([no, count]) => ({no, count}));
    const datalist = document.getElementById('serialNoList');
    datalist.innerHTML = sortedSerialNos.map(({no, count}) => 
      `<option value="${no}">${no} (${count}ä»¶)</option>`
    ).join('');
  }
  function showWordSuggestions(targetId, suggestionsBoxId, wordsContainerId, field){
    const serialNo = document.getElementById('serialNo').value.trim();
    const words = extractCommonWords(field, serialNo);
    const box = document.getElementById(suggestionsBoxId);
    const container = document.getElementById(wordsContainerId);
    if (words.length === 0) { box.classList.remove('active'); return; }
    let headerText = 'ğŸ’¡ ã‚ˆãä½¿ã‚ã‚Œã‚‹è¡¨ç¾ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ï¼‰';
    if (serialNo !== '') {
      const filteredCount = anomalyCache.filter(item => item.serialNo === serialNo).length;
      if (filteredCount >= 3) headerText = `ğŸ’¡ æ•´ç†Noã€Œ${serialNo}ã€ã®éå»ã®è¡¨ç¾ï¼ˆ${filteredCount}ä»¶ï¼‰`;
      else if (filteredCount > 0) headerText = `ğŸ’¡ ã‚ˆãä½¿ã‚ã‚Œã‚‹è¡¨ç¾ï¼ˆæ•´ç†Noã€Œ${serialNo}ã€ã¯${filteredCount}ä»¶ã®ã¿ï¼‰`;
    }
    const header = box.querySelector('.word-suggestion-header');
    if (header) header.textContent = headerText;
    container.innerHTML = words.map(word => `<span class="word-tag" data-word="${word}">${word}</span>`).join('');
    box.classList.add('active');
    container.querySelectorAll('.word-tag').forEach(tag => {
      tag.addEventListener('click', () => {
        const textarea = document.getElementById(targetId);
        const word = tag.getAttribute('data-word');
        const currentValue = textarea.value;
        const cursorPos = textarea.selectionStart;
        const before = currentValue.substring(0, cursorPos);
        const after = currentValue.substring(cursorPos);
        const needsSpace = before.length > 0 && !before.match(/[\sã€ã€‚\n]$/);
        const insertion = (needsSpace ? ' ' : '') + word;
        textarea.value = before + insertion + after;
        textarea.focus();
        textarea.selectionStart = textarea.selectionEnd = cursorPos + insertion.length;
      });
    });
  }
  document.getElementById('anomalyContent').addEventListener('focus', () => {
    showWordSuggestions('anomalyContent', 'anomalyWordSuggestions', 'anomalyWords', 'anomalyContent');
  });
  document.getElementById('actionTaken').addEventListener('focus', () => {
    showWordSuggestions('actionTaken', 'actionWordSuggestions', 'actionWords', 'actionTaken');
  });
  document.getElementById('serialNo').addEventListener('input', () => {
    const serialNo = document.getElementById('serialNo').value.trim();
    const infoBox = document.getElementById('serialNoInfo');
    const countSpan = document.getElementById('serialNoCount');
    if (serialNo !== '') {
      const count = anomalyCache.filter(item => item.serialNo === serialNo).length;
      countSpan.textContent = count;
      infoBox.style.display = count > 0 ? 'block' : 'none';
    } else {
      infoBox.style.display = 'none';
    }
    const activeElement = document.activeElement;
    if (activeElement.id === 'anomalyContent') {
      showWordSuggestions('anomalyContent', 'anomalyWordSuggestions', 'anomalyWords', 'anomalyContent');
    } else if (activeElement.id === 'actionTaken') {
      showWordSuggestions('actionTaken', 'actionWordSuggestions', 'actionWords', 'actionTaken');
    }
  });
  document.getElementById('serialNo').addEventListener('change', () => {
    const anomalyBox = document.getElementById('anomalyWordSuggestions');
    const actionBox = document.getElementById('actionWordSuggestions');
    if (anomalyBox.classList.contains('active')) {
      showWordSuggestions('anomalyContent', 'anomalyWordSuggestions', 'anomalyWords', 'anomalyContent');
    }
    if (actionBox.classList.contains('active')) {
      showWordSuggestions('actionTaken', 'actionWordSuggestions', 'actionWords', 'actionTaken');
    }
  });
  document.getElementById('anomalyContent').addEventListener('blur', () => {
    setTimeout(() => document.getElementById('anomalyWordSuggestions').classList.remove('active'), 200);
  });
  document.getElementById('actionTaken').addEventListener('blur', () => {
    setTimeout(() => document.getElementById('actionWordSuggestions').classList.remove('active'), 200);
  });

  /* ===== é¡ä¼¼æ¡ˆä»¶ ===== */
  let showingAllCases = false;
  let allSimilarCases = [];
  function calculateSimilarity(text1, text2) {
    if (!text1 || !text2) return 0;
    const normalize = (text) => text.toLowerCase().replace(/[\s\u3000]/g, '').replace(/[ã€ã€‚ï¼Œï¼]/g, '');
    const t1 = normalize(text1); const t2 = normalize(text2);
    if (t1 === t2) return 100;
    if (t1.length === 0 || t2.length === 0) return 0;
    let matches = 0;
    const minLen = Math.min(t1.length, t2.length);
    const maxLen = Math.max(t1.length, t2.length);
    for (let len = minLen; len >= 2; len--) {
      for (let i = 0; i <= t1.length - len; i++) {
        const substr = t1.substring(i, i + len);
        if (t2.includes(substr)) { matches += len; break; }
      }
      if (matches > 0) break;
    }
    return Math.round((matches / maxLen) * 100);
  }
  function buildThumbs(urls, max=4){
    if(!urls || !urls.length) return '';
    const shown = urls.slice(0, max);
    const more  = urls.length > max ? `<div class="more">+${urls.length - max} æš</div>` : '';
    return `
      <div class="thumbs">
        ${shown.map(u=>`
          <div class="thumb" onclick="window.open('${u}','_blank')">
            <img src="${u}" alt="">
          </div>
        `).join('')}
      </div>
      ${more}
    `;
  }
  // è£½é€ ãƒ»æŠ€è¡“å…±é€šï¼šç›´è¿‘å®Œæˆãƒ‡ãƒ¼ã‚¿ã®ã†ã¡æ•´ç†Noä¸€è‡´ã‚’å„ªå…ˆã—ã€ãªã‘ã‚Œã°å…¨ä½“ã‹ã‚‰æŠ½å‡ºï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§é™é †ã‚½ãƒ¼ãƒˆï¼‰
  function findSimilarCandidates(base, limitN=10){
    if (!base) return [];
    let candidates = anomalyCache
      .filter(x => x._id !== base._id && x.status==='complete');
    if (base.serialNo) {
      const same = candidates.filter(x => x.serialNo === base.serialNo);
      if (same.length >= 1) candidates = same; // åŒã˜æ•´ç†Noã‚’å„ªå…ˆ
    }
    // æ–‡ç« é¡ä¼¼ã§ã‚¹ã‚³ã‚¢ä»˜ã‘
    const withScore = candidates.map(it => ({
      ...it,
      similarity: calculateSimilarity(base.anomalyContent||'', it.anomalyContent||'')
    }));
    return withScore
      .filter(x => x.similarity >= 30)
      .sort((a,b) => (b.similarity!==a.similarity) ? (b.similarity-a.similarity) : (b.occurrenceDate||'').localeCompare(a.occurrenceDate||''))
      .slice(0, limitN);
  }
  function renderSimilarList(items){
    return items.map((item) => {
      const allPhotos = [ ...(item.mfgPhotoUrls || []), ...(item.techPhotoUrls || []) ];
      const photosHtml = allPhotos.length ? `
        <div class="similar-photos">
          ${allPhotos.slice(0,8).map(u=>`
            <div class="thumb" onclick="window.open('${u}','_blank')">
              <img src="${u}" alt="">
            </div>
          `).join('')}
        </div>
      ` : '';
      return `
        <div class="similar-case-item">
          <div class="similar-case-date">
            ğŸ“… ${item.occurrenceDate || ''} ã®å¯¾å¿œäº‹ä¾‹
            <span style="background:#4caf50;color:#fff;padding:2px 8px;border-radius:12px;font-size:.8rem;margin-left:8px;">
              é¡ä¼¼åº¦ ${item.similarity}%
            </span>
          </div>
          <div class="similar-case-content">
            <strong>ç•°å¸¸å†…å®¹:</strong> ${item.anomalyContent || '-'}<br>
            <strong>è£½é€ å‡¦ç½®:</strong> ${item.actionTaken || '-'}
          </div>
          <div class="similar-case-tech">
            <strong>ğŸ”§ æŠ€è¡“å¯¾å¿œå†…å®¹:</strong><br>
            ${item.techHandler ? `æŠ€è¡“å‡¦ç½®è€…: ${item.techHandler}<br>` : ''}
            ${item.rootCauseAction ? `åŸå› ãƒ»å¯¾ç­–: ${item.rootCauseAction}<br>` : ''}
            ${item.maintenanceUnit ? `ä¿å…¨å˜ä½: ${item.maintenanceUnit}<br>` : ''}
            ${item.lifespan ? `å‘½æ•°æœ‰ç„¡: ${item.lifespan}<br>` : ''}
            ${item.recurrenceType ? `åˆ†é¡: ${item.recurrenceType}` : ''}
          </div>
          ${photosHtml}
          <button class="btn-small" style="background:#2196f3;color:#fff;margin-top:10px;width:100%;" onclick="showSimilarCaseDetail('${item._id}')">
            ğŸ“‹ è©³ç´°ã‚’è¦‹ã‚‹
          </button>
        </div>
      `;
    }).join('');
  }

  function setNowDateTo(id){
    const now = new Date(); const hour=now.getHours();
    if (hour>=0 && hour<6) now.setDate(now.getDate()-1);
    const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0');
    document.getElementById(id).value = `${y}-${m}-${d}`;
  }
  function setNowTimeTo(id){
    const now=new Date(); const hh=String(now.getHours()).padStart(2,'0'), mm=String(now.getMinutes()).padStart(2,'0');
    document.getElementById(id).value = `${hh}:${mm}`;
  }
  document.getElementById('btnNowDate').addEventListener('click', ()=>setNowDateTo('occurrenceDate'));
  document.querySelectorAll('button[data-now]').forEach(b=> b.addEventListener('click', ()=> setNowTimeTo(b.getAttribute('data-now')) ));

  function displayPhotos(previewId, arr){
    const wrap = document.getElementById(previewId); wrap.innerHTML='';
    arr.forEach((src,idx)=>{
      const div=document.createElement('div'); div.className='photo-item';
      div.innerHTML = `<img src="${src}"><button class="remove-btn" data-photo="${previewId}" data-index="${idx}">Ã—</button>`;
      wrap.appendChild(div);
    });
  }
  function handlePhotoUpload(inputId, previewId, arrRef){
    const input = document.getElementById(inputId);
    input.addEventListener('change',(e)=>{
      (Array.from(e.target.files||[])).forEach(file=>{
        const r=new FileReader();
        r.onload = ev=>{ arrRef.push({name:file.name, file, preview:ev.target.result}); displayPhotos(previewId, arrRef.map(x=>x.preview)); };
        r.readAsDataURL(file);
      });
      input.value='';
    });
  }
  handlePhotoUpload('mfgPhotos','mfgPhotoPreview', mfgPhotos);
  handlePhotoUpload('techPhotos','techPhotoPreview', techPhotos);
  document.addEventListener('click',(e)=>{
    const rm=e.target.closest('.remove-btn[data-photo]'); if(!rm) return;
    const id=rm.getAttribute('data-photo'); const idx=Number(rm.getAttribute('data-index'));
    if (id==='mfgPhotoPreview'){ mfgPhotos.splice(idx,1); displayPhotos(id, mfgPhotos.map(x=>x.preview)); }
    if (id==='techPhotoPreview'){ techPhotos.splice(idx,1); displayPhotos(id, techPhotos.map(x=>x.preview)); }
  });

  function updateDepartmentSelect(selectId, departments){
    const sel=document.getElementById(selectId); if(!sel) return;
    const keep=sel.value;
    sel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    departments.forEach(d=>{ const o=document.createElement('option'); o.value=o.textContent=d; sel.appendChild(o); });
    if (departments.includes(keep)) sel.value=keep;
  }
  function refreshLineAndHandler(deptSelId, lineSelId, handlerSelId, lines, handlers){
    const dept=document.getElementById(deptSelId).value;
    const lineSel=document.getElementById(lineSelId), handlerSel=document.getElementById(handlerSelId);
    lineSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    handlerSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    (lines[dept]||[]).forEach(l=>{ const o=document.createElement('option'); o.value=o.textContent=l; lineSel.appendChild(o); });
    (handlers[dept]||[]).forEach(h=>{ const o=document.createElement('option'); o.value=o.textContent=h; handlerSel.appendChild(o); });
  }

  function calcStopMinutes(item){
    const ot = item.occurrenceTime || '';
    const rt = item.restartTime || '';
    if (!ot || !rt) return null;
    const [oh,om] = ot.split(':').map(Number);
    const [rh,rm] = rt.split(':').map(Number);
    let diff = (rh*60+rm) - (oh*60+om);
    if (isNaN(diff)) return null;
    if (diff < 0) diff += 1440; // æ—¥è·¨ãè£œæ­£
    return diff;
  }
  function badgeClassByMinutes(m){
    if (m === null) return '';
    if (m >= 30) return 'danger';
    if (m >= 10) return 'warn';
    return '';
  }

  function anomaliesRef(){ return collection(db,'anomalies'); }

  async function uploadPhotos(docId, kind, items){
    const urls=[];
    for (const it of items){
      const path=`anomalies/${docId}/${kind}/${Date.now()}_${it.name}`;
      const storageRef=ref(storage, path);
      await uploadBytes(storageRef, it.file);
      const url = await getDownloadURL(storageRef);
      urls.push(url);
    }
    return urls;
  }

  /* ===== å±¥æ­´æç”» ===== */
  function renderHistory(){
    const items=[...anomalyCache].sort((a,b)=> (b.occurrenceDate||'').localeCompare(a.occurrenceDate||''));
    const cardWrap=document.getElementById('cardView');
    if (!items.length){
      cardWrap.innerHTML=`<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;
    }else{
      cardWrap.innerHTML = items.map((item)=>{
        const status = item.status==='pending'
          ? {text:'æŠ€è¡“å…¥åŠ›å¾…ã¡',cls:'status-pending'}
          : (item.techRequest==='å®Œçµ' ? {text:'å®Œäº†ï¼ˆè£½é€ å®Œçµï¼‰',cls:'status-complete'} : {text:'å®Œäº†',cls:'status-complete'});

        const allPhotos = [ ...(item.mfgPhotoUrls || []), ...(item.techPhotoUrls || []) ];
        const hasPhotos = allPhotos.length > 0;

        const stopMin = calcStopMinutes(item);
        const badgeCls = badgeClassByMinutes(stopMin);
        const stopBadge = (stopMin !== null)
          ? `<div class="stop-badge ${badgeCls}">åœæ­¢æ™‚é–“ï¼š${stopMin}åˆ†</div>`
          : '';

        const leftFields = `
          ${item.department?`<div class="card-field"><div class="field-label">éƒ¨ç½²</div><div class="field-value">${item.department}</div></div>`:''}
          ${item.lineName?`<div class="card-field"><div class="field-label">ãƒ©ã‚¤ãƒ³å</div><div class="field-value">${item.lineName}</div></div>`:''}
          ${item.techRequest?`<div class="card-field"><div class="field-label">æŠ€è¡“è¦è«‹</div><div class="field-value">${item.techRequest==='è¦è«‹'?'æŠ€è¡“è¦è«‹ã‚ã‚Š':'è£½é€ ã§å®Œçµ'}</div></div>`:''}
          <div class="card-field"><div class="field-label">ç•°å¸¸å†…å®¹</div><div class="field-value">${item.anomalyContent||''}</div></div>
          <div class="card-field"><div class="field-label">è£½é€ å‡¦ç½®</div><div class="field-value">${item.actionTaken||''}</div></div>
          <div class="card-field"><div class="field-label">ç™ºç”Ÿæ—¥æ™‚</div><div class="card-value">${item.occurrenceDate||''} ${item.occurrenceTime||''}</div></div>
          <div class="card-field"><div class="field-label">å†é–‹æ™‚åˆ»</div><div class="card-value">${item.restartTime||''}</div></div>
          <div class="card-field"><div class="field-label">å‡¦ç½®è€…</div><div class="field-value">${item.handler||''}</div></div>
          ${item.status==='complete' && item.techRequest==='è¦è«‹' ? `
            <div class="card-field"><div class="field-label">æŠ€è¡“å‡¦ç½®è€…</div><div class="field-value">${item.techHandler||'-'}</div></div>
            <div class="card-field"><div class="field-label">ä¿å…¨å˜ä½</div><div class="field-value">${item.maintenanceUnit||'-'}</div></div>
            <div class="card-field"><div class="field-label">åŸå› ãƒ»å¯¾ç­–</div><div class="field-value">${item.rootCauseAction||'-'}</div></div>
            <div class="card-field"><div class="field-label">å†ç™º/æ–°è¦</div><div class="card-value">${item.recurrenceType||'-'}</div></div>
          `:''}
          <div class="action-btns" style="margin-top:6px;">
            <button class="btn-small btn-edit" data-edit="${item._id}">ç·¨é›†</button>
            <button class="btn-small btn-delete" data-del="${item._id}">å‰Šé™¤</button>
          </div>
        `;
        const rightPhotos = hasPhotos ? `<div class="card-photos">${buildThumbs(allPhotos, 4)}</div>` : '';

        return `
          <div class="anomaly-card ${item.status==='complete'?'complete':''}">
            ${stopBadge}
            <div class="card-header">
              <div class="card-id">${item.serialNo || '(No ID)'}</div>
              <div class="card-status ${status.cls}">${status.text}</div>
            </div>
            <div class="card-body ${hasPhotos ? 'with-photos' : ''}">
              <div class="card-text">
                ${leftFields}
              </div>
              ${rightPhotos}
            </div>
          </div>
        `;
      }).join('');
    }

    const tableWrap=document.getElementById('tableView');
    if (!items.length){
      tableWrap.innerHTML=`<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;
    }else{
      tableWrap.innerHTML = `
        <div style="overflow-x:auto;">
        <table style="min-width:2200px;">
          <thead><tr>
            <th>æ•´ç†No</th><th>éƒ¨ç½²</th><th>ãƒ©ã‚¤ãƒ³</th><th>ç™ºç”Ÿæ—¥</th><th>ç™ºç”Ÿæ™‚åˆ»</th>
            <th>å†é–‹æ™‚åˆ»</th><th>åœæ­¢æ™‚é–“(åˆ†)</th><th>ç•°å¸¸å†…å®¹</th><th>å‡¦ç½®å†…å®¹</th><th>é¡ã‚Š</th>
            <th>å‡¦ç½®è€…</th><th>æŠ€è¡“è¦è«‹</th><th>æŠ€è¡“å‡¦ç½®è€…</th><th>ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°</th><th>å‰å›çµ‚ç‰©ç¢ºèª</th>
            <th>å‘½æ•°æœ‰ç„¡</th><th>å‘½æ•°åˆ°é”</th><th>ä¿å…¨å˜ä½</th><th>åŸå› å¯¾ç­–</th><th>å†ç™ºæ–°è¦</th>
            <th>è‚¯å®š</th><th>å†™çœŸ</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th>
          </tr></thead>
          <tbody>
            ${items.map(it=>{
              const st = it.status==='complete'?'å®Œäº†':'å¾…ã¡';
              const cls = it.status==='complete'?'status-complete':'status-pending';
              const photoCount = (it.mfgPhotoUrls?.length||0)+(it.techPhotoUrls?.length||0);
              const stopMin = calcStopMinutes(it);
              return `
                <tr>
                  <td>${it.serialNo||'-'}</td>
                  <td>${it.department||'-'}</td>
                  <td>${it.lineName||'-'}</td>
                  <td>${it.occurrenceDate||'-'}</td>
                  <td>${it.occurrenceTime||'-'}</td>
                  <td>${it.restartTime||'-'}</td>
                  <td>${stopMin!==null?stopMin:'-'}</td>
                  <td style="min-width:150px;">${(it.anomalyContent||'-').slice(0,50)}${(it.anomalyContent||'').length>50?'...':''}</td>
                  <td style="min-width:150px;">${(it.actionTaken||'-').slice(0,50)}${(it.actionTaken||'').length>50?'...':''}</td>
                  <td>${it.traceback||'-'}</td>
                  <td>${it.handler||'-'}</td>
                  <td>${it.techRequest==='è¦è«‹'?'æŠ€è¡“è¦è«‹':it.techRequest==='å®Œçµ'?'è£½é€ å®Œçµ':'-'}</td>
                  <td>${it.techHandler||'-'}</td>
                  <td>${it.discoveryTiming||'-'}</td>
                  <td>${it.previousCheck||'-'}</td>
                  <td>${it.lifespan||'-'}</td>
                  <td>${it.lifespanReached||'-'}</td>
                  <td>${it.maintenanceUnit||'-'}</td>
                  <td style="min-width:150px;">${(it.rootCauseAction||'-').slice(0,50)}${(it.rootCauseAction||'').length>50?'...':''}</td>
                  <td>${it.recurrenceType||'-'}</td>
                  <td>${it.affirmation||'-'}</td>
                  <td>${photoCount ? `<button class="btn-small" style="background:#2196f3;color:#fff;" data-photos="${it._id}">ğŸ“· ${photoCount}</button>` : '-'}</td>
                  <td><span class="card-status ${cls}">${st}</span></td>
                  <td class="action-btns">
                    <button class="btn-small btn-edit" data-edit="${it._id}">ç·¨é›†</button>
                    <button class="btn-small btn-delete" data-del="${it._id}">å‰Šé™¤</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
        </div>
      `;
    }
  }

  function renderTechTargetSelect(){
    const sel = document.getElementById('selectSerialNo');
    sel.innerHTML = '<option value="">æ•´ç†Noã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    anomalyCache
      .filter(x=>x.status==='pending' && x.techRequest==='è¦è«‹')
      .sort((a,b)=> (b.occurrenceDate||'').localeCompare(a.occurrenceDate||''))
      .forEach(x=>{
        const o=document.createElement('option');
        o.value = x._id;
        o.textContent = `[${x.serialNo}] ${x.occurrenceDate} - ${x.anomalyContent?.slice(0,30)||''}...`;
        sel.appendChild(o);
      });
  }

  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      const targetId = tab.getAttribute('data-tab');
      document.getElementById(targetId).classList.add('active');
    });
  });

  async function bootAfterLogin(){
    mastersCache = await fetchMasters();
    updateDepartmentSelect('department', mastersCache.departments);
    updateDepartmentSelect('lineManageDept', mastersCache.departments);
    updateDepartmentSelect('handlerManageDept', mastersCache.departments);

    document.getElementById('department').addEventListener('change', ()=> {
      refreshLineAndHandler('department','lineName','handler', mastersCache.lines, mastersCache.handlers);
    });
    document.getElementById('lineManageDept').addEventListener('change', async ()=> { await updateLineManageList(); });
    document.getElementById('handlerManageDept').addEventListener('change', async ()=> { await updateHandlerManageList(); });

    document.getElementById('discoveryTiming').addEventListener('change', ()=> {
      const timing = document.getElementById('discoveryTiming').value;
      const previousCheckGroup = document.getElementById('previousCheckGroup');
      if (timing === 'åˆç‰©') { previousCheckGroup.style.display = 'block'; }
      else { previousCheckGroup.style.display = 'none'; document.getElementById('previousCheck').value = ''; }
    });

    // ==== ç„¡æ–™æ å¯¾ç­–ï¼šå±¥æ­´ã‚’ createdAt é™é †ãƒ»ä¸Šä½ HISTORY_LIMIT ä»¶ã ã‘è³¼èª­ ====
    const q = query(anomaliesRef(), orderBy('createdAt','desc'), limit(HISTORY_LIMIT));
    onSnapshot(q, (snap)=>{
      anomalyCache = snap.docs.map(d=> ({_id:d.id, ...d.data()}));
      renderHistory();
      renderTechTargetSelect();
      updateSerialNoList();
    });

    await updateDepartmentList();
    setNowDateTo('occurrenceDate');
  }

  document.getElementById('manufacturingForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const techReq = document.getElementById('techRequest').value;
    const base = {
      department: document.getElementById('department').value,
      lineName:   document.getElementById('lineName').value,
      serialNo:   document.getElementById('serialNo').value,
      occurrenceDate: document.getElementById('occurrenceDate').value,
      occurrenceTime: document.getElementById('occurrenceTime').value || '',
      restartTime:    document.getElementById('restartTime').value || '',
      anomalyContent: document.getElementById('anomalyContent').value,
      actionTaken:    document.getElementById('actionTaken').value,
      traceback:      document.getElementById('traceback').value,
      handler:        document.getElementById('handler').value,
      techRequest:    techReq,
      status:         techReq==='å®Œçµ' ? 'complete':'pending',
      createdAt:      serverTimestamp(),
      techHandler:'', lifespan:'', maintenanceUnit:'', rootCauseAction:'', recurrenceType:'',
      discoveryTiming:'', previousCheck:'', lifespanReached:'', affirmation:'',
      mfgPhotoUrls:[], techPhotoUrls:[]
    };
    const created = await addDoc(anomaliesRef(), base);
    let urls=[];
    if (mfgPhotos.length){
      urls = await uploadPhotos(created.id, 'mfg', mfgPhotos);
      await updateDoc(doc(db,'anomalies',created.id), { mfgPhotoUrls: urls });
    }

    e.target.reset(); mfgPhotos=[]; document.getElementById('mfgPhotoPreview').innerHTML='';
    document.getElementById('lineName').innerHTML='<option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>';
    document.getElementById('handler').innerHTML='<option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>';
    alert('ç™»éŒ²ã—ã¾ã—ãŸã€‚');
  });

  document.getElementById('selectSerialNo').addEventListener('change', ()=>{
    const id = document.getElementById('selectSerialNo').value;
    const d = anomalyCache.find(it=> it._id===id);
    const box=document.getElementById('selectedDataDisplay'), wrap=document.getElementById('displayContent');
    showingAllCases = false;
    if (!d){
      box.style.display='none';
      wrap.innerHTML='';
      document.getElementById('similarCasesBox').classList.remove('active');
      return;
    }
    wrap.innerHTML = `
      <div style="display:grid;gap:8px;">
        <div><strong>æ•´ç†No:</strong> ${d.serialNo}</div>
        ${d.department?`<div><strong>éƒ¨ç½²:</strong> ${d.department}</div>`:''}
        ${d.lineName?`<div><strong>ãƒ©ã‚¤ãƒ³å:</strong> ${d.lineName}</div>`:''}
        <div><strong>ç•°å¸¸å†…å®¹:</strong> ${d.anomalyContent||''}</div>
        <div><strong>è£½é€ å‡¦ç½®:</strong> ${d.actionTaken||''}</div>
        <div><strong>ç™ºç”Ÿæ—¥:</strong> ${d.occurrenceDate||''}</div>
        <div><strong>å‡¦ç½®è€…:</strong> ${d.handler||''}</div>
      </div>
    `;
    box.style.display='block';

    // å…ƒä»•æ§˜ï¼šé¸æŠæ™‚ã«é¡ä¼¼ã‚’å‡ºã™ï¼ˆãŸã ã—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸è¦ã®ãŸã‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚½ãƒ¼ãƒˆï¼‰
    const candidates = findSimilarCandidates(d, 10);
    allSimilarCases = candidates;
    const content = document.getElementById('similarCasesContent');
    const simBox = document.getElementById('similarCasesBox');
    if (candidates.length){
      content.innerHTML = renderSimilarList(showingAllCases ? candidates : candidates.slice(0,1));
      const showMoreBtn = document.getElementById('showMoreCases');
      if (candidates.length > 1 && !showingAllCases) {
        showMoreBtn.style.display = 'block';
        showMoreBtn.textContent = `ä»–ã®é¡ä¼¼æ¡ˆä»¶ã‚’è¡¨ç¤ºï¼ˆã‚ã¨${candidates.length - 1}ä»¶ï¼‰`;
      } else {
        showMoreBtn.style.display = 'none';
      }
      simBox.classList.add('active');
    }else{
      simBox.classList.remove('active');
    }
  });

  document.getElementById('showMoreCases').addEventListener('click', () => {
    showingAllCases = true;
    const content = document.getElementById('similarCasesContent');
    content.innerHTML = renderSimilarList(allSimilarCases);
    document.getElementById('showMoreCases').style.display='none';
  });

  // æŠ€è¡“å´ï¼šæ˜ç¤ºãƒœã‚¿ãƒ³ã§å†è¡¨ç¤º
  document.getElementById('btnShowPastOnTech').addEventListener('click', ()=>{
    const id = document.getElementById('selectSerialNo').value;
    if (!id){ alert('å¯¾è±¡æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    const d = anomalyCache.find(it=> it._id===id);
    if (!d){ return; }
    showingAllCases = false;
    const candidates = findSimilarCandidates(d, 10);
    const content = document.getElementById('similarCasesContent');
    const simBox = document.getElementById('similarCasesBox');
    if (candidates.length){
      content.innerHTML = renderSimilarList(candidates.slice(0,1));
      const showMoreBtn = document.getElementById('showMoreCases');
      if (candidates.length > 1) {
        showMoreBtn.style.display = 'block';
        showMoreBtn.textContent = `ä»–ã®é¡ä¼¼æ¡ˆä»¶ã‚’è¡¨ç¤ºï¼ˆã‚ã¨${candidates.length - 1}ä»¶ï¼‰`;
      } else {
        showMoreBtn.style.display = 'none';
      }
      simBox.classList.add('active');
      simBox.scrollIntoView({behavior:'smooth', block:'start'});
    }else{
      simBox.classList.add('active');
      document.getElementById('similarCasesContent').innerHTML = '<div style="color:#666;">å€™è£œãŒã‚ã‚Šã¾ã›ã‚“</div>';
      document.getElementById('showMoreCases').style.display='none';
    }
  });

  // è£½é€ å´ï¼šã€Œéå»ã®ç•°å¸¸å±¥æ­´ã€ãƒœã‚¿ãƒ³
  document.getElementById('btnShowPastOnMfg').addEventListener('click', ()=>{
    const serialNo = (document.getElementById('serialNo').value||'').trim();
    const base = {
      _id: '(temp)',
      serialNo,
      anomalyContent: (document.getElementById('anomalyContent').value||'')
    };
    const candidates = findSimilarCandidates(base, 10);
    const box = document.getElementById('mfgSimilarBox');
    const content = document.getElementById('mfgSimilarContent');
    if (candidates.length){
      content.innerHTML = renderSimilarList(candidates.slice(0,3));
      const more = document.getElementById('mfgShowMore');
      more.style.display = candidates.length>3 ? 'block' : 'none';
      more.onclick = ()=>{
        content.innerHTML = renderSimilarList(candidates);
        more.style.display = 'none';
      };
      box.classList.add('active');
      box.scrollIntoView({behavior:'smooth', block:'start'});
    }else{
      box.classList.add('active');
      content.innerHTML = '<div style="color:#666;">å€™è£œãŒã‚ã‚Šã¾ã›ã‚“</div>';
      document.getElementById('mfgShowMore').style.display='none';
    }
  });

  document.getElementById('technicalForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const id = document.getElementById('selectSerialNo').value;
    const updates = {
      techHandler: document.getElementById('techHandler').value,
      discoveryTiming: document.getElementById('discoveryTiming').value,
      previousCheck: document.getElementById('previousCheck').value || '',
      lifespan: document.getElementById('lifespan').value,
      lifespanReached: document.getElementById('lifespanReached').value,
      maintenanceUnit: document.getElementById('maintenanceUnit').value,
      rootCauseAction: document.getElementById('rootCauseAction').value,
      recurrenceType: document.getElementById('recurrenceType').value,
      affirmation: document.getElementById('affirmation').value,
      status: 'complete',
      completedAt: serverTimestamp()
    };
    if (techPhotos.length){
      const urls = await uploadPhotos(id,'tech', techPhotos);
      updates.techPhotoUrls = (anomalyCache.find(x=>x._id===id)?.techPhotoUrls||[]).concat(urls);
    }
    await updateDoc(doc(db,'anomalies',id), updates);
    e.target.reset(); techPhotos=[]; document.getElementById('techPhotoPreview').innerHTML='';
    document.getElementById('selectedDataDisplay').style.display='none';
    document.getElementById('similarCasesBox').classList.remove('active');
    showingAllCases = false;
    document.getElementById('previousCheckGroup').style.display='none';
    alert('æŠ€è¡“å…¥åŠ›ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚');
  });

  document.querySelectorAll('.view-toggle button').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.view-toggle button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active'); currentView=b.dataset.view;
      document.getElementById('cardView').style.display = currentView==='card'?'grid':'none';
      document.getElementById('tableView').style.display = currentView==='table'?'block':'none';
      renderHistory();
    });
  });

  /* === ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« === */
  const editModalHtml = `
    <div class="modal-content">
      <div class="modal-title">âœï¸ å±¥æ­´ãƒ¬ã‚³ãƒ¼ãƒ‰ç·¨é›†</div>
      <div class="edit-tabs">
        <button class="edit-tab active" data-edit-tab="mfg">è£½é€ </button>
        <button class="edit-tab" data-edit-tab="tech">æŠ€è¡“</button>
      </div>
      <div id="editMfg" class="edit-pane">
        <div class="form-group"><label>ç™ºç”Ÿæ—¥ *</label><input type="date" id="edit_occurrenceDate"></div>
        <div class="form-group"><label>ç™ºç”Ÿæ™‚åˆ» / å†é–‹æ™‚åˆ»</label><div class="time-group"><input type="time" id="edit_occurrenceTime"><input type="time" id="edit_restartTime"></div></div>
        <div class="form-group"><label>éƒ¨ç½² *</label><select id="edit_department"></select></div>
        <div class="form-group"><label>ãƒ©ã‚¤ãƒ³å *</label><select id="edit_lineName"></select></div>
        <div class="form-group"><label>å‡¦ç½®è€… *</label><select id="edit_handler"></select></div>
        <div class="form-group"><label>æ•´ç†No *</label><input type="text" id="edit_serialNo"></div>
        <div class="form-group"><label>ç•°å¸¸å†…å®¹ *</label><textarea id="edit_anomalyContent"></textarea></div>
        <div class="form-group"><label>è£½é€ å‡¦ç½®å†…å®¹ *</label><textarea id="edit_actionTaken"></textarea></div>
        <div class="form-group"><label>é¡ã‚Š *</label><select id="edit_traceback"><option value="">é¸æŠ</option><option value="æœ‰">æœ‰</option><option value="ç„¡">ç„¡</option></select></div>
        <div class="form-group"><label>æŠ€è¡“è¦è«‹ *</label><select id="edit_techRequest"><option value="">é¸æŠ</option><option value="è¦è«‹">æŠ€è¡“è¦è«‹ã‚ã‚Š</option><option value="å®Œçµ">è£½é€ ã§å®Œçµ</option></select></div>
      </div>
      <div id="editTech" class="edit-pane" style="display:none;">
        <div class="form-group"><label>æŠ€è¡“å‡¦ç½®è€…</label><input type="text" id="edit_techHandler"></div>
        <div class="form-group"><label>ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°</label>
          <select id="edit_discoveryTiming">
            <option value="">é¸æŠ</option>
            <option value="é‹è»¢ä¸­">é‹è»¢ä¸­</option>
            <option value="é ­å‡ºã—">é ­å‡ºã—</option>
            <option value="åˆç‰©">åˆç‰©</option>
            <option value="çµ‚ç‰©">çµ‚ç‰©</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>
        <div class="form-group"><label>å‰å›çµ‚ç‰©ç¢ºèª</label>
          <select id="edit_previousCheck">
            <option value="">é¸æŠ</option>
            <option value="ä¸è¦">ä¸è¦</option>
            <option value="æœª">æœª</option>
            <option value="ç¢ºèªæ¸ˆ">ç¢ºèªæ¸ˆ</option>
          </select>
        </div>
        <div class="form-group"><label>å‘½æ•°æœ‰ç„¡</label><select id="edit_lifespan"><option value="">é¸æŠ</option><option value="æœ‰">æœ‰</option><option value="ç„¡">ç„¡</option></select></div>
        <div class="form-group"><label>å‘½æ•°åˆ°é”</label>
          <select id="edit_lifespanReached">
            <option value="">é¸æŠ</option>
            <option value="è‡³">è‡³</option>
            <option value="ä¸é”">ä¸é”</option>
          </select>
        </div>
        <div class="form-group"><label>ä¿å…¨å˜ä½</label><input type="text" id="edit_maintenanceUnit"></div>
        <div class="form-group"><label>ä½•ãŒæ‚ªãã©ã†ã—ãŸ</label><textarea id="edit_rootCauseAction"></textarea></div>
        <div class="form-group"><label>å†ç™ºã‹æ–°è¦ã‹</label><select id="edit_recurrenceType"><option value="">é¸æŠ</option><option value="å†ç™º">å†ç™º</option><option value="æ–°è¦">æ–°è¦</option></select></div>
        <div class="form-group"><label>è‚¯å®š</label>
          <select id="edit_affirmation">
            <option value="">é¸æŠ</option>
            <option value="æœ‰">æœ‰</option>
            <option value="ç„¡">ç„¡</option>
          </select>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-cancel" id="btnEditCancel" style="flex:1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" id="btnEditSave" style="flex:1;">ä¿å­˜</button>
      </div>
    </div>`;
  const modal = document.createElement('div'); modal.className='modal'; modal.id='editModal'; modal.innerHTML=editModalHtml; document.body.appendChild(modal);

  let editCurrentId=null, editMastersCache=null;
  function openEdit(id){
    const rec = anomalyCache.find(x=>x._id===id); if(!rec){ alert('å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
    editCurrentId=id;
    (async ()=>{
      editMastersCache = mastersCache || await fetchMasters();
      const depSel = document.getElementById('edit_department'); depSel.innerHTML='';
      editMastersCache.departments.forEach(d=>{ const o=document.createElement('option'); o.value=o.textContent=d; depSel.appendChild(o); });
      depSel.value = rec.department||'';
      const lineSel=document.getElementById('edit_lineName'), hSel=document.getElementById('edit_handler');
      lineSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      (editMastersCache.lines[depSel.value]||[]).forEach(l=>{ const o=document.createElement('option'); o.value=o.textContent=l; lineSel.appendChild(o); });
      hSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      (editMastersCache.handlers[depSel.value]||[]).forEach(h=>{ const o=document.createElement('option'); o.value=o.textContent=h; hSel.appendChild(o); });

      lineSel.value = rec.lineName||'';
      hSel.value = rec.handler||'';

      document.getElementById('edit_occurrenceDate').value = rec.occurrenceDate||'';
      document.getElementById('edit_occurrenceTime').value = rec.occurrenceTime||'';
      document.getElementById('edit_restartTime').value   = rec.restartTime||'';
      document.getElementById('edit_serialNo').value      = rec.serialNo||'';
      document.getElementById('edit_anomalyContent').value= rec.anomalyContent||'';
      document.getElementById('edit_actionTaken').value   = rec.actionTaken||'';
      document.getElementById('edit_traceback').value     = rec.traceback||'';
      document.getElementById('edit_techRequest').value   = rec.techRequest||'';
      document.getElementById('edit_techHandler').value   = rec.techHandler||'';
      document.getElementById('edit_discoveryTiming').value = rec.discoveryTiming||'';
      document.getElementById('edit_previousCheck').value = rec.previousCheck||'';
      document.getElementById('edit_lifespan').value      = rec.lifespan||'';
      document.getElementById('edit_lifespanReached').value = rec.lifespanReached||'';
      document.getElementById('edit_maintenanceUnit').value= rec.maintenanceUnit||'';
      document.getElementById('edit_rootCauseAction').value= rec.rootCauseAction||'';
      document.getElementById('edit_recurrenceType').value = rec.recurrenceType||'';
      document.getElementById('edit_affirmation').value   = rec.affirmation||'';
      modal.classList.add('active'); modal.setAttribute('aria-hidden','false');
    })();
  }
  document.addEventListener('change', (e)=>{
    if (e.target.id==='edit_department' && editMastersCache){
      const dep=e.target.value;
      const lineSel=document.getElementById('edit_lineName'), hSel=document.getElementById('edit_handler');
      lineSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      (editMastersCache.lines[dep]||[]).forEach(l=>{ const o=document.createElement('option'); o.value=o.textContent=l; lineSel.appendChild(o); });
      hSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      (editMastersCache.handlers[dep]||[]).forEach(h=>{ const o=document.createElement('option'); o.value=o.textContent=h; hSel.appendChild(o); });
    }
  });
  document.addEventListener('click', (e)=>{
    const t=e.target;
    if (t.matches('.edit-tab')){
      document.querySelectorAll('.edit-tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      document.getElementById('editMfg').style.display = t.dataset.editTab==='mfg'?'block':'none';
      document.getElementById('editTech').style.display= t.dataset.editTab==='tech'?'block':'none';
    }
    const ed = t.closest('button.btn-edit[data-edit]'); if (ed){ openEdit(ed.getAttribute('data-edit')); }
    const del= t.closest('button.btn-delete[data-del]'); if (del){ deleteRecord(del.getAttribute('data-del')); }
    const photos = t.closest('button[data-photos]'); if (photos){ showPhotos(photos.getAttribute('data-photos')); }
  });
  document.getElementById('btnEditCancel').addEventListener('click', ()=>{
    modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); editCurrentId=null;
  });
  document.getElementById('btnEditSave').addEventListener('click', async ()=>{
    if (!editCurrentId) return;
    const updates = {
      occurrenceDate:  document.getElementById('edit_occurrenceDate').value||'',
      occurrenceTime:  document.getElementById('edit_occurrenceTime').value||'',
      restartTime:     document.getElementById('edit_restartTime').value||'',
      department:      document.getElementById('edit_department').value||'',
      lineName:        document.getElementById('edit_lineName').value||'',
      handler:         document.getElementById('edit_handler').value||'',
      serialNo:        document.getElementById('edit_serialNo').value||'',
      anomalyContent:  document.getElementById('edit_anomalyContent').value||'',
      actionTaken:     document.getElementById('edit_actionTaken').value||'',
      traceback:       document.getElementById('edit_traceback').value||'',
      techRequest:     document.getElementById('edit_techRequest').value||'',
      techHandler:     document.getElementById('edit_techHandler').value||'',
      discoveryTiming: document.getElementById('edit_discoveryTiming').value||'',
      previousCheck:   document.getElementById('edit_previousCheck').value||'',
      lifespan:        document.getElementById('edit_lifespan').value||'',
      lifespanReached: document.getElementById('edit_lifespanReached').value||'',
      maintenanceUnit: document.getElementById('edit_maintenanceUnit').value||'',
      rootCauseAction: document.getElementById('edit_rootCauseAction').value||'',
      recurrenceType:  document.getElementById('edit_recurrenceType').value||'',
      affirmation:     document.getElementById('edit_affirmation').value||'',
    };
    if (updates.techRequest==='å®Œçµ'){
      updates.status='complete';
    }else{
      const hasTech = (updates.techHandler||updates.lifespan||updates.maintenanceUnit||updates.rootCauseAction||updates.recurrenceType);
      updates.status = hasTech ? 'complete' : 'pending';
    }
    await updateDoc(doc(db,'anomalies',editCurrentId), updates);
    modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); editCurrentId=null;
    alert('æ›´æ–°ã—ã¾ã—ãŸã€‚');
  });

  async function deleteRecord(id){
    if (!confirm('ã“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆç”»åƒã‚‚å‰Šé™¤ï¼‰')) return;
    const item = anomalyCache.find(a => a._id === id);
    try{
      if (item.mfgPhotoUrls && Array.isArray(item.mfgPhotoUrls)){
        for (const url of item.mfgPhotoUrls){
          try{
            const photoRef = ref(storage, url);
            await deleteObject(photoRef);
          }catch(e){
            console.log('Failed to delete mfg photo:', e);
          }
        }
      }
      if (item.techPhotoUrls && Array.isArray(item.techPhotoUrls)){
        for (const url of item.techPhotoUrls){
          try{
            const photoRef = ref(storage, url);
            await deleteObject(photoRef);
          }catch(e){
            console.log('Failed to delete tech photo:', e);
          }
        }
      }
    }catch(err){
      console.log('Error deleting photos:', err);
    }
    await deleteDoc(doc(db,'anomalies',id));
    alert('å‰Šé™¤ã—ã¾ã—ãŸ');
  }

  function showPhotos(id){
    const item = anomalyCache.find(a => a._id === id);
    if (!item) return;
    const modal = document.getElementById('photoModal');
    const content = document.getElementById('photoModalContent');
    let html = '';
    if (item.mfgPhotoUrls && item.mfgPhotoUrls.length > 0){
      html += '<div style="grid-column:1/-1;"><h4 style="color:#667eea;margin-bottom:10px;">è£½é€ éƒ¨é–€ã®å†™çœŸ</h4></div>';
      item.mfgPhotoUrls.forEach(url => {
        html += `<div style="position:relative;aspect-ratio:1;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.1);">
          <img src="${url}" style="width:100%;height:100%;object-fit:cover;cursor:pointer;" onclick="window.open('${url}','_blank')">
        </div>`;
      });
    }
    if (item.techPhotoUrls && item.techPhotoUrls.length > 0){
      html += '<div style="grid-column:1/-1;margin-top:20px;"><h4 style="color:#f57c00;margin-bottom:10px;">æŠ€è¡“éƒ¨é–€ã®å†™çœŸ</h4></div>';
      item.techPhotoUrls.forEach(url => {
        html += `<div style="position:relative;aspect-ratio:1;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.1);">
          <img src="${url}" style="width:100%;height:100%;object-fit:cover;cursor:pointer;" onclick="window.open('${url}','_blank')">
        </div>`;
      });
    }
    if (!html) html = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999;">å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“</div>';
    content.innerHTML = html;
    modal.classList.add('active');
    modal.setAttribute('aria-hidden', 'false');
  }

  // é¡ä¼¼æ¡ˆä»¶è©³ç´°
  window.showSimilarCaseDetail = function(caseId) {
    const item = anomalyCache.find(x => x._id === caseId);
    if (!item) return;
    const modal = document.getElementById('similarCaseDetailModal');
    const content = document.getElementById('similarCaseDetailContent');
    // ç›´å‰ã«å‚ç…§ã—ãŸãƒ™ãƒ¼ã‚¹ï¼ˆæŠ€è¡“é¸æŠ or è£½é€ å…¥åŠ›ä¸­ã®ãƒ†ã‚­ã‚¹ãƒˆï¼‰
    const techId = document.getElementById('selectSerialNo').value;
    const selected = anomalyCache.find(x => x._id === techId) || { anomalyContent: (document.getElementById('anomalyContent').value||'') };
    const similarity = calculateSimilarity(selected.anomalyContent || '', item.anomalyContent || '');
    content.innerHTML = `
      <div style="background:#f8f9ff;padding:20px;border-radius:8px;margin-bottom:20px;">
        <h4 style="color:#667eea;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center;">
          <span>ğŸ“‹ åŸºæœ¬æƒ…å ±</span>
          <span style="background:#4caf50;color:#fff;padding:4px 12px;border-radius:12px;font-size:.9rem;">é¡ä¼¼åº¦ ${similarity}%</span>
        </h4>
        <div style="display:grid;gap:12px;">
          <div><strong>æ•´ç†No:</strong> ${item.serialNo || '-'}</div>
          <div><strong>éƒ¨ç½²:</strong> ${item.department || '-'}</div>
          <div><strong>ãƒ©ã‚¤ãƒ³å:</strong> ${item.lineName || '-'}</div>
          <div><strong>ç™ºç”Ÿæ—¥:</strong> ${item.occurrenceDate || '-'} ${item.occurrenceTime || ''}</div>
          <div><strong>å†é–‹æ™‚åˆ»:</strong> ${item.restartTime || '-'}</div>
          <div><strong>å‡¦ç½®è€…:</strong> ${item.handler || '-'}</div>
        </div>
      </div>
      <div style="background:#fff4e6;padding:20px;border-radius:8px;margin-bottom:20px;">
        <h4 style="color:#f57c00;margin-bottom:15px;">ğŸ”§ è£½é€ éƒ¨é–€ã®å¯¾å¿œ</h4>
        <div style="display:grid;gap:12px;">
          <div><strong>ç•°å¸¸å†…å®¹:</strong><div style="background:#fff;padding:12px;border-radius:6px;margin-top:8px;white-space:pre-wrap;">${item.anomalyContent || '-'}</div></div>
          <div><strong>è£½é€ å‡¦ç½®å†…å®¹:</strong><div style="background:#fff;padding:12px;border-radius:6px;margin-top:8px;white-space:pre-wrap;">${item.actionTaken || '-'}</div></div>
          <div><strong>é¡ã‚Š:</strong> ${item.traceback || '-'}</div>
          <div><strong>æŠ€è¡“è¦è«‹:</strong> ${item.techRequest === 'è¦è«‹' ? 'æŠ€è¡“è¦è«‹ã‚ã‚Š' : 'è£½é€ ã§å®Œçµ'}</div>
        </div>
      </div>
      ${item.status === 'complete' && item.techRequest === 'è¦è«‹' ? `
        <div style="background:#e8f5e9;padding:20px;border-radius:8px;margin-bottom:20px;">
          <h4 style="color:#2e7d32;margin-bottom:15px;">âš™ï¸ æŠ€è¡“éƒ¨é–€ã®å¯¾å¿œ</h4>
          <div style="display:grid;gap:12px;">
            <div><strong>æŠ€è¡“å‡¦ç½®è€…:</strong> ${item.techHandler || '-'}</div>
            <div><strong>ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°:</strong> ${item.discoveryTiming || '-'}</div>
            <div><strong>å‰å›çµ‚ç‰©ç¢ºèª:</strong> ${item.previousCheck || '-'}</div>
            <div><strong>å‘½æ•°æœ‰ç„¡:</strong> ${item.lifespan || '-'}</div>
            <div><strong>å‘½æ•°åˆ°é”:</strong> ${item.lifespanReached || '-'}</div>
            <div><strong>ä¿å…¨å˜ä½:</strong> ${item.maintenanceUnit || '-'}</div>
            <div><strong>åŸå› ãƒ»å¯¾ç­–:</strong><div style="background:#fff;padding:12px;border-radius:6px;margin-top:8px;white-space:pre-wrap;">${item.rootCauseAction || '-'}</div></div>
            <div><strong>å†ç™º/æ–°è¦:</strong> ${item.recurrenceType || '-'}</div>
            <div><strong>è‚¯å®š:</strong> ${item.affirmation || '-'}</div>
          </div>
        </div>` : ''}
      ${(item.mfgPhotoUrls?.length || item.techPhotoUrls?.length) ? `
        <div style="background:#e3f2fd;padding:20px;border-radius:8px;">
          <h4 style="color:#1976d2;margin-bottom:15px;">ğŸ“· å†™çœŸ</h4>
          ${item.mfgPhotoUrls?.length ? `
            <div style="margin-bottom:8px;color:#667eea;font-weight:bold;">è£½é€ éƒ¨é–€</div>
            <div class="similar-photos">
              ${item.mfgPhotoUrls.map(u=>`<div class="thumb" onclick="window.open('${u}','_blank')"><img src="${u}" alt=""></div>`).join('')}
            </div>`:''}
          ${item.techPhotoUrls?.length ? `
            <div style="margin:14px 0 8px;color:#f57c00;font-weight:bold;">æŠ€è¡“éƒ¨é–€</div>
            <div class="similar-photos">
              ${item.techPhotoUrls.map(u=>`<div class="thumb" onclick="window.open('${u}','_blank')"><img src="${u}" alt=""></div>`).join('')}
            </div>`:''}
        </div>` : ''}
    `;
    modal.classList.add('active');
    modal.setAttribute('aria-hidden', 'false');
  };

  document.getElementById('btnPhotoClose').addEventListener('click', ()=>{
    const modal = document.getElementById('photoModal');
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden', 'true');
  });
  document.getElementById('btnSimilarCaseDetailClose').addEventListener('click', ()=>{
    const modal = document.getElementById('similarCaseDetailModal');
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden', 'true');
  });
  document.getElementById('photoModal').addEventListener('click', (e)=>{
    if (e.target.id === 'photoModal') {
      document.getElementById('photoModal').classList.remove('active');
      document.getElementById('photoModal').setAttribute('aria-hidden', 'true');
    }
  });
  document.getElementById('similarCaseDetailModal').addEventListener('click', (e)=>{
    if (e.target.id === 'similarCaseDetailModal') {
      document.getElementById('similarCaseDetailModal').classList.remove('active');
      document.getElementById('similarCaseDetailModal').setAttribute('aria-hidden', 'true');
    }
  });

  /* ==== CSVå‡ºåŠ› ==== */
  document.getElementById('btnExport').addEventListener('click', ()=>{
    if (!anomalyCache.length){ alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const headers = ['æ•´ç†No','éƒ¨ç½²','ãƒ©ã‚¤ãƒ³å','ç™ºç”Ÿæ—¥','ç™ºç”Ÿæ™‚åˆ»','å†é–‹æ™‚åˆ»','åœæ­¢æ™‚é–“(åˆ†)','ç•°å¸¸å†…å®¹','è£½é€ å‡¦ç½®å†…å®¹','é¡ã‚Š','å‡¦ç½®è€…','æŠ€è¡“è¦è«‹','æŠ€è¡“å‡¦ç½®è€…','ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°','å‰å›çµ‚ç‰©ç¢ºèª','å‘½æ•°æœ‰ç„¡','å‘½æ•°åˆ°é”','ä¿å…¨å˜ä½','åŸå› å¯¾ç­–','å†ç™ºæ–°è¦','è‚¯å®š','çŠ¶æ…‹','_id'];
    const rows = anomalyCache.map(item=>{
      const stopMin = (()=>{
        if (!item.occurrenceTime || !item.restartTime) return null;
        const [oh,om]=(item.occurrenceTime||'0:0').split(':').map(Number);
        const [rh,rm]=(item.restartTime||'0:0').split(':').map(Number);
        let m=(rh*60+rm)-(oh*60+om); if (m<0) m+=1440; return m;
      })();
      return [
        item.serialNo||'',item.department||'',item.lineName||'',item.occurrenceDate||'',item.occurrenceTime||'',item.restartTime||'',
        (stopMin!==null?stopMin:''),
        item.anomalyContent||'',item.actionTaken||'',item.traceback||'',item.handler||'',
        item.techRequest==='è¦è«‹'?'æŠ€è¡“è¦è«‹ã‚ã‚Š':item.techRequest==='å®Œçµ'?'è£½é€ ã§å®Œçµ':'',
        item.techHandler||'',item.discoveryTiming||'',item.previousCheck||'',item.lifespan||'',item.lifespanReached||'',
        item.maintenanceUnit||'',item.rootCauseAction||'',item.recurrenceType||'',item.affirmation||'',
        item.status==='complete'?'å®Œäº†':'æŠ€è¡“å…¥åŠ›å¾…ã¡', item._id
      ];
    });
    let csv = '\uFEFF' + headers.join(',') + '\n';
    rows.forEach(r=>{ csv += r.map(c=>`"${(c??'').toString().replace(/"/g,'""')}"`).join(',')+'\n'; });
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download=`ç•°å¸¸å±¥æ­´_${new Date().toISOString().split('T')[0]}.csv`; a.click();
  });

  /* ==== ãƒã‚¹ã‚¿ç®¡ç† ==== */
  async function updateDepartmentList(){
    const list=document.getElementById('departmentList'); list.innerHTML='';
    const snap=await getDocs(collection(db,'masters','department','items'));
    const arr = snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=> a.name.localeCompare(b.name));
    if (!arr.length){ list.innerHTML='<p style="color:#999;text-align:center;">éƒ¨ç½²ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; return; }
    arr.forEach(row=>{
      const div=document.createElement('div');
      div.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#f8f9fa;border-radius:6px;border-left:3px solid #667eea;';
      div.innerHTML = `<span style="font-weight:500;color:#333">${row.name}</span>
        <button class="btn-small btn-delete" data-del-dept="${row.id}">å‰Šé™¤</button>`;
      list.appendChild(div);
    });
    mastersCache = await fetchMasters();
    updateDepartmentSelect('department', mastersCache.departments);
    updateDepartmentSelect('lineManageDept', mastersCache.departments);
    updateDepartmentSelect('handlerManageDept', mastersCache.departments);
  }
  document.getElementById('btnAddDept').addEventListener('click', async ()=>{
    const name=(document.getElementById('newDepartment').value||'').trim();
    if (!name){ alert('éƒ¨ç½²åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    await addDoc(collection(db,'masters','department','items'), {name});
    document.getElementById('newDepartment').value='';
    updateDepartmentList();
  });
  document.addEventListener('click', async (e)=>{
    const del=e.target.closest('button[data-del-dept]'); if (!del) return;
    await deleteDoc(doc(db,'masters','department','items', del.getAttribute('data-del-dept')));
    updateDepartmentList();
  });

  async function updateLineManageList(){
    const dept=document.getElementById('lineManageDept').value;
    const list=document.getElementById('lineList'); 
    list.innerHTML='';
    if (!dept){ list.innerHTML='<p style="color:#999;text-align:center;">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</p>'; return; }
    const snap=await getDocs(query(collection(db,'masters','line','items'), where('department','==',dept)));
    const arr=snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=> a.name.localeCompare(b.name));
    if (!arr.length){ list.innerHTML='<p style="color:#999;text-align:center;">ãƒ©ã‚¤ãƒ³åãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; return; }
    arr.forEach(row=>{
      const div=document.createElement('div');
      div.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#f8f9fa;border-radius:6px;border-left:3px solid #f57c00;';
      div.innerHTML = `<span style="font-weight:500;color:#333">${row.name}</span>
        <button class="btn-small btn-delete" data-del-line="${row.id}">å‰Šé™¤</button>`;
      list.appendChild(div);
    });
  }
  document.getElementById('btnAddLine').addEventListener('click', async ()=>{
    const dept=document.getElementById('lineManageDept').value;
    const name=(document.getElementById('newLine').value||'').trim();
    if (!dept){ alert('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    if (!name){ alert('ãƒ©ã‚¤ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    await addDoc(collection(db,'masters','line','items'), {department:dept, name});
    document.getElementById('newLine').value='';
    mastersCache = await fetchMasters();
    await updateLineManageList();
  });
  document.addEventListener('click', async (e)=>{
    const del=e.target.closest('button[data-del-line]'); if (!del) return;
    await deleteDoc(doc(db,'masters','line','items', del.getAttribute('data-del-line')));
    mastersCache = await fetchMasters();
    await updateLineManageList();
  });

  async function updateHandlerManageList(){
    const dept=document.getElementById('handlerManageDept').value;
    const list=document.getElementById('handlerList'); 
    list.innerHTML='';
    if (!dept){ list.innerHTML='<p style="color:#999;text-align:center;">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</p>'; return; }
    const snap=await getDocs(query(collection(db,'masters','handler','items'), where('department','==',dept)));
    const arr=snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=> a.name.localeCompare(b.name));
    if (!arr.length){ list.innerHTML='<p style="color:#999;text-align:center;">å‡¦ç½®è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; return; }
    arr.forEach(row=>{
      const div=document.createElement('div');
      div.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#f8f9fa;border-radius:6px;border-left:3px solid #2e7d32;';
      div.innerHTML = `<span style="font-weight:500;color:#333">${row.name}</span>
        <button class="btn-small btn-delete" data-del-handler="${row.id}">å‰Šé™¤</button>`;
      list.appendChild(div);
    });
  }
  document.getElementById('btnAddHandler').addEventListener('click', async ()=>{
    const dept=document.getElementById('handlerManageDept').value;
    const name=(document.getElementById('newHandler').value||'').trim();
    if (!dept){ alert('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    if (!name){ alert('å‡¦ç½®è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    await addDoc(collection(db,'masters','handler','items'), {department:dept, name});
    document.getElementById('newHandler').value='';
    mastersCache = await fetchMasters();
    await updateHandlerManageList();
  });
  document.addEventListener('click', async (e)=>{
    const del=e.target.closest('button[data-del-handler]'); if (!del) return;
    await deleteDoc(doc(db,'masters','handler','items', del.getAttribute('data-del-handler')));
    mastersCache = await fetchMasters();
    await updateHandlerManageList();
  });

  // è§£æã‚¿ãƒ–ã¯å‰Šé™¤æ¸ˆã¿

</script>
</body>
</html>
