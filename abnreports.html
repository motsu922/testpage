<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•°å¸¸å±¥æ­´å…¥åŠ›ãƒ„ãƒ¼ãƒ«</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Hiragino Sans',sans-serif;
    background:#f5f5f5;
  }
  .container{max-width:800px;margin:0 auto;padding:10px}
  .header{
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    color:#fff;padding:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.1)
  }
  .header h1{font-size:1.5rem;margin-bottom:5px}

  .tabs{display:flex;background:#fff;margin:15px 0 0;border-radius:8px 8px 0 0;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,.1)}
  .tab{flex:1;padding:15px;text-align:center;cursor:pointer;background:#f8f9fa;border:none;font-size:1rem;font-weight:bold;transition:.3s;color:#666}
  .tab.active{background:#fff;color:#667eea;border-bottom:3px solid #667eea}

  .tab-content{display:none;background:#fff;padding:20px;border-radius:0 0 8px 8px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  .tab-content.active{display:block}

  .form-group{margin-bottom:20px}
  .form-group label{display:block;margin-bottom:8px;font-weight:bold;color:#333;font-size:.95rem}
  .form-group input,.form-group textarea,.form-group select{
    width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:6px;font-size:1rem;transition:border-color .3s
  }
  .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:#667eea}
  .form-group textarea{min-height:100px;resize:vertical}

  .time-group{display:grid;grid-template-columns:1fr 1fr;gap:10px}

  .photo-upload{border:2px dashed #e0e0e0;border-radius:6px;padding:20px;text-align:center;cursor:pointer;transition:.3s}
  .photo-upload:hover{border-color:#667eea;background:#f8f9ff}
  .photo-upload input[type="file"]{display:none}
  .photo-preview{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-top:15px}
  .photo-item{position:relative;aspect-ratio:1;border-radius:6px;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,.1)}
  .photo-item img{width:100%;height:100%;object-fit:cover}
  .photo-item .remove-btn{position:absolute;top:5px;right:5px;background:rgba(255,59,48,.9);color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:14px;line-height:1}

  .btn{width:100%;padding:15px;border:none;border-radius:6px;font-size:1rem;font-weight:bold;cursor:pointer;transition:.3s;margin-top:10px}
  .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
  .btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,.4)}
  .btn-secondary{background:#6c757d;color:#fff}
  .btn-export{background:#28a745;color:#fff}
  .btn-import{background:#17a2b8;color:#fff}

  .history-controls{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
  .view-toggle{display:flex;gap:5px}
  .view-toggle button{padding:8px 15px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:6px;cursor:pointer;font-weight:bold}
  .view-toggle button.active{background:#667eea;color:#fff}

  .card-view{display:grid;gap:15px}
  .anomaly-card{background:#fff;border-radius:8px;padding:15px;box-shadow:0 2px 8px rgba(0,0,0,.1);border-left:4px solid #667eea}
  .anomaly-card.complete{border-left-color:#28a745}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #e0e0e0}
  .card-id{font-size:1.2rem;font-weight:bold;color:#667eea}
  .card-status{padding:4px 12px;border-radius:12px;font-size:.85rem;font-weight:bold}
  .status-pending{background:#fff3cd;color:#856404}
  .status-complete{background:#d4edda;color:#155724}
  .card-body{display:grid;gap:8px}
  .card-field{display:grid;grid-template-columns:120px 1fr;gap:10px}
  .field-label{font-weight:bold;color:#666}
  .field-value{color:#333}
  .action-btns{display:flex;gap:5px;margin-top:10px}
  .btn-small{padding:5px 10px;border:none;border-radius:4px;cursor:pointer;font-size:.85rem}
  .btn-edit{background:#ffc107;color:#000}
  .btn-delete{background:#dc3545;color:#fff}
  .btn-line{background:#00c300;color:#fff}

  .table-view{overflow-x:auto;display:none}
  .table-view.active{display:block}
  table{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.1)}
  th,td{padding:12px;text-align:left;border-bottom:1px solid #e0e0e0}
  th{background:#667eea;color:#fff;font-weight:bold;position:sticky;top:0}
  tr:hover{background:#f8f9ff}

  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
  .modal.active{display:flex}
  .modal-content{background:#fff;padding:24px;border-radius:10px;max-width:520px;width:92%}
  .modal-content h3{margin-bottom:10px}
  .modal-row{margin:10px 0}
  .modal-row label{font-weight:600;margin-bottom:6px;display:block}
  .helper{font-size:.85rem;color:#666}

  @media (max-width:600px){
    .card-field{grid-template-columns:1fr;gap:5px}
    .time-group{grid-template-columns:1fr}
    table{font-size:.85rem}
    th,td{padding:8px}
  }

  .empty-state{text-align:center;padding:40px 20px;color:#999}
  .empty-state-icon{font-size:3rem;margin-bottom:15px}

  .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;border-radius:8px;text-align:center}
  .stat-card h4{font-size:.9rem;margin-bottom:10px;opacity:.9}
  .stat-card .stat-value{font-size:2.5rem;font-weight:bold;margin-bottom:5px}
  .stat-card .stat-label{font-size:.85rem;opacity:.8}

  .chart-bar{background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);height:30px;border-radius:4px;display:flex;align-items:center;padding:0 10px;color:#fff;font-weight:bold;margin-bottom:10px;transition:.3s}
  .chart-bar:hover{transform:translateX(5px);box-shadow:0 2px 8px rgba(102,126,234,.4)}

  .analysis-insight{background:#e3f2fd;border-left:4px solid #2196f3;padding:15px;border-radius:6px;margin-top:15px}
  .trend-badge{display:inline-block;padding:5px 15px;border-radius:20px;font-weight:bold;font-size:.9rem;margin:5px}
  .trend-increase{background:#ffebee;color:#c62828}
  .trend-decrease{background:#e8f5e9;color:#2e7d32}
  .trend-stable{background:#fff3e0;color:#ef6c00}
</style>
</head>
<body>
  <div class="header">
    <h1>ğŸ“‹ ç•°å¸¸å±¥æ­´å…¥åŠ›ãƒ„ãƒ¼ãƒ«</h1>
    <p>è£½é€ ãƒ»æŠ€è¡“éƒ¨é–€é€£æºã‚·ã‚¹ãƒ†ãƒ </p>
  </div>

  <div class="container">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('manufacturing')">è£½é€ å…¥åŠ›</button>
      <button class="tab" onclick="switchTab('technical')">æŠ€è¡“å…¥åŠ›</button>
      <button class="tab" onclick="switchTab('history')">å±¥æ­´</button>
      <button class="tab" onclick="switchTab('analysis')">ğŸ“Š åˆ†æ</button>
      <button class="tab" onclick="switchTab('master')">âš™ï¸ ç®¡ç†</button>
    </div>

    <!-- è£½é€ å…¥åŠ› -->
    <div id="manufacturing" class="tab-content active">
      <h2 style="margin-bottom:20px;color:#667eea;">è£½é€ éƒ¨é–€ - ç•°å¸¸å ±å‘Š</h2>
      <p style="margin-bottom:20px;color:#666;">ã„ã¤ãƒ»ã©ã“ã§ãƒ»ã©ã®æ•´ç†Noã§ãƒ»ä½•ãŒã‚ã£ãŸ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>

      <form id="manufacturingForm">
        <!-- ã„ã¤ -->
        <div style="background:#f0f7ff;padding:15px;border-radius:6px;margin-bottom:20px;">
          <h3 style="color:#667eea;margin-bottom:15px;font-size:1.1rem;">ğŸ“… ã„ã¤</h3>

          <div class="form-group">
            <label>ç™ºç”Ÿæ—¥ *</label>
            <div style="display:flex;gap:10px;">
              <input type="date" id="occurrenceDate" required style="flex:1;">
              <button type="button" onclick="setNowDate()" class="btn btn-secondary" style="width:auto;padding:12px 20px;margin:0;background:#17a2b8;">ğŸ“… NOW</button>
            </div>
            <p class="helper">â€»å‹¤å‹™æ™‚é–“: 8:00ã€œç¿Œ6:00 (0:00ã€œ6:00ã®ç•°å¸¸ã¯å‰æ—¥æ‰±ã„)</p>
          </div>

          <div class="form-group">
            <label>æ™‚åˆ»</label>
            <div class="time-group">
              <div>
                <label style="font-weight:normal;font-size:.9rem;">ç™ºç”Ÿæ™‚åˆ»</label>
                <div style="display:flex;gap:5px;">
                  <input type="time" id="occurrenceTime" style="flex:1;">
                  <button type="button" onclick="setNowTime('occurrenceTime')" class="btn btn-secondary" style="width:auto;padding:8px 12px;margin:0;font-size:.85rem;background:#17a2b8;">NOW</button>
                </div>
              </div>
              <div>
                <label style="font-weight:normal;font-size:.9rem;">å†é–‹æ™‚åˆ»</label>
                <div style="display:flex;gap:5px;">
                  <input type="time" id="restartTime" style="flex:1;">
                  <button type="button" onclick="setNowTime('restartTime')" class="btn btn-secondary" style="width:auto;padding:8px 12px;margin:0;font-size:.85rem;background:#17a2b8;">NOW</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ã©ã“ã§ -->
        <div style="background:#fff4e6;padding:15px;border-radius:6px;margin-bottom:20px;">
          <h3 style="color:#f57c00;margin-bottom:15px;font-size:1.1rem;">ğŸ“ ã©ã“ã§</h3>

          <div class="form-group">
            <label>éƒ¨ç½² *</label>
            <select id="department" required onchange="updateLineOptions()">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>

          <div class="form-group">
            <label>ãƒ©ã‚¤ãƒ³å *</label>
            <select id="lineName" required>
              <option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>

          <div class="form-group">
            <label>å‡¦ç½®è€… *</label>
            <select id="handler" required>
              <option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
        </div>

        <!-- ã©ã®æ•´ç†Noã§ -->
        <div style="background:#f3e5f5;padding:15px;border-radius:6px;margin-bottom:20px;">
          <h3 style="color:#8e24aa;margin-bottom:15px;font-size:1.1rem;">ğŸ”¢ ã©ã®æ•´ç†Noã§</h3>

          <div class="form-group">
            <label>æ•´ç†No *</label>
            <input type="text" id="serialNo" required placeholder="ä¾‹: 2024-001" onblur="searchSimilarSerialNo()">
            <p class="helper">â€»æ•´ç†Noã‚’å…¥åŠ›ã™ã‚‹ã¨éå»ã®é¡ä¼¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å€™è£œãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
          </div>

          <div id="suggestionArea" style="display:none;margin-top:15px;padding:15px;background:#fff;border-radius:6px;border:2px solid #8e24aa;">
            <h4 style="color:#8e24aa;margin-bottom:10px;font-size:.95rem;">ğŸ’¡ éå»ã®é¡ä¼¼æ•´ç†Noã‹ã‚‰å€™è£œã‚’è¡¨ç¤º</h4>
            <div id="suggestionButtons"></div>
          </div>
        </div>

        <!-- ä½•ãŒã‚ã£ãŸ -->
        <div style="background:#e8f5e9;padding:15px;border-radius:6px;margin-bottom:20px;">
          <h3 style="color:#2e7d32;margin-bottom:15px;font-size:1.1rem;">ğŸ“ ä½•ãŒã‚ã£ãŸ</h3>

          <div class="form-group">
            <label>ç•°å¸¸å†…å®¹ *</label>
            <textarea id="anomalyContent" required placeholder="ç™ºç”Ÿã—ãŸç•°å¸¸ã®è©³ç´°ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„"></textarea>
          </div>

          <div class="form-group">
            <label>è£½é€ å‡¦ç½®å†…å®¹ *</label>
            <textarea id="actionTaken" required placeholder="å®Ÿæ–½ã—ãŸå‡¦ç½®å†…å®¹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„"></textarea>
          </div>

          <div class="form-group">
            <label>é¡ã‚Š *</label>
            <select id="traceback" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="æœ‰">æœ‰</option>
              <option value="ç„¡">ç„¡</option>
            </select>
          </div>

          <div class="form-group">
            <label>æŠ€è¡“è¦è«‹ *</label>
            <select id="techRequest" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="è¦è«‹">æŠ€è¡“è¦è«‹ã‚ã‚Šï¼ˆæŠ€è¡“éƒ¨é–€ã®å…¥åŠ›ãŒå¿…è¦ï¼‰</option>
              <option value="å®Œçµ">è£½é€ ã§å®Œçµï¼ˆæŠ€è¡“å…¥åŠ›ä¸è¦ï¼‰</option>
            </select>
            <p class="helper">â€»è£½é€ ã§å®Œçµã™ã‚‹å ´åˆã¯ã€Œè£½é€ ã§å®Œçµã€ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
          </div>

          <div class="form-group">
            <label>å†™çœŸ</label>
            <div class="photo-upload" onclick="document.getElementById('mfgPhotos').click()">
              <div style="font-size:2rem;">ğŸ“¸</div>
              <p>å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</p>
              <input type="file" id="mfgPhotos" accept="image/*" multiple>
            </div>
            <div id="mfgPhotoPreview" class="photo-preview"></div>
          </div>
        </div>

        <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
      </form>
    </div>

    <!-- æŠ€è¡“å…¥åŠ› -->
    <div id="technical" class="tab-content">
      <h2 style="margin-bottom:20px;color:#667eea;">æŠ€è¡“éƒ¨é–€ - è¿½åŠ å…¥åŠ›</h2>

      <div class="form-group">
        <label>å¯¾è±¡ã®æ¡ˆä»¶é¸æŠ *</label>
        <select id="selectSerialNo" onchange="loadManufacturingData()">
          <option value="">æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
        <p class="helper">â€»[å“ç•ª] æ—¥ä»˜ - ç•°å¸¸å†…å®¹ ã®å½¢å¼ã§è¡¨ç¤ºã•ã‚Œã¾ã™</p>
      </div>

      <div id="selectedDataDisplay" style="background:#f8f9ff;padding:15px;border-radius:6px;margin-bottom:20px;display:none;">
        <h3 style="color:#667eea;margin-bottom:10px;">è£½é€ éƒ¨é–€å…¥åŠ›å†…å®¹</h3>
        <div id="displayContent"></div>
      </div>

      <!-- â€»ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ï¼šæŠ€è¡“ãƒšãƒ¼ã‚¸ã®ã€Œéå»ã®é¡ä¼¼æ•´ç†Noã‹ã‚‰å€™è£œã€ã¯ä¸è¦ã®ãŸã‚å‰Šé™¤æ¸ˆã¿ -->

      <form id="technicalForm">
        <div class="form-group">
          <label>æŠ€è¡“å‡¦ç½®è€… *</label>
          <input type="text" id="techHandler" required placeholder="æŠ€è¡“å‡¦ç½®è€…åã‚’å…¥åŠ›">
        </div>

        <div class="form-group">
          <label>å‘½æ•°æœ‰ç„¡ *</label>
          <select id="lifespan" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="æœ‰">æœ‰</option>
            <option value="ç„¡">ç„¡</option>
          </select>
        </div>

        <div class="form-group">
          <label>ä¿å…¨å˜ä½ *</label>
          <input type="text" id="maintenanceUnit" required placeholder="ä¾‹: ãƒ¢ãƒ¼ã‚¿ãƒ¼ã€ãƒ™ã‚¢ãƒªãƒ³ã‚°">
        </div>

        <div class="form-group">
          <label>ä½•ãŒæ‚ªãã©ã†ã—ãŸ *</label>
          <textarea id="rootCauseAction" required placeholder="åŸå› ã¨å¯¾ç­–ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„"></textarea>
        </div>

        <div class="form-group">
          <label>å†ç™ºã‹æ–°è¦ã‹ *</label>
          <select id="recurrenceType" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="å†ç™º">å†ç™º</option>
            <option value="æ–°è¦">æ–°è¦</option>
          </select>
        </div>

        <div class="form-group">
          <label>å†™çœŸ</label>
          <div class="photo-upload" onclick="document.getElementById('techPhotos').click()">
            <div style="font-size:2rem;">ğŸ“¸</div>
            <p>å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</p>
            <input type="file" id="techPhotos" accept="image/*" multiple>
          </div>
          <div id="techPhotoPreview" class="photo-preview"></div>
        </div>

        <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
      </form>
    </div>

    <!-- å±¥æ­´ -->
    <div id="history" class="tab-content">
      <h2 style="margin-bottom:20px;color:#667eea;">ç•°å¸¸å±¥æ­´</h2>

      <div class="history-controls">
        <div class="view-toggle">
          <button class="active" onclick="toggleView('card')">ã‚«ãƒ¼ãƒ‰</button>
          <button onclick="toggleView('table')">ãƒ†ãƒ¼ãƒ–ãƒ«</button>
        </div>
        <button class="btn btn-export" onclick="exportCSV()" style="flex:1;">ğŸ“¥ CSVå‡ºåŠ›</button>
        <button class="btn btn-import" onclick="document.getElementById('csvImport').click()" style="flex:1;">ğŸ“¤ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        <input type="file" id="csvImport" accept=".csv" style="display:none" onchange="importCSV(event)">
      </div>

      <div id="cardView" class="card-view"></div>
      <div id="tableView" class="table-view"></div>
    </div>

    <!-- åˆ†æ -->
    <div id="analysis" class="tab-content">
      <h2 style="margin-bottom:20px;color:#ff9800;">ğŸ“Š ç•°å¸¸ãƒ‡ãƒ¼ã‚¿åˆ†æ</h2>

      <!-- æ¤œç´¢ -->
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#ff9800;margin-bottom:15px;">ğŸ” é¡ä¼¼ç•°å¸¸æ¤œç´¢</h3>

        <div style="background:#f8f9fa;padding:15px;border-radius:6px;margin-bottom:15px;">
          <h4 style="font-size:1rem;margin-bottom:10px;color:#666;">çµã‚Šè¾¼ã¿æ¡ä»¶</h4>

          <div class="form-group" style="margin-bottom:15px;">
            <label>éƒ¨ç½²</label>
            <select id="searchDepartment" onchange="updateSearchLineOptions()">
              <option value="">ã™ã¹ã¦</option>
            </select>
          </div>

          <div class="form-group" style="margin-bottom:15px;">
            <label>ãƒ©ã‚¤ãƒ³å</label>
            <select id="searchLine">
              <option value="">ã™ã¹ã¦</option>
            </select>
          </div>

          <div class="form-group" style="margin-bottom:0;">
            <label>æ•´ç†No</label>
            <input type="text" id="searchSerialNo" placeholder="æ•´ç†Noã§çµã‚Šè¾¼ã¿ï¼ˆä¾‹: 2024-001ï¼‰">
          </div>
        </div>

        <div class="form-group">
          <label>æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="text" id="searchKeyword" placeholder="ç•°å¸¸å†…å®¹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆä¾‹: ãƒ¢ãƒ¼ã‚¿ãƒ¼ã€åœæ­¢ã€ç•°éŸ³ï¼‰">
        </div>

        <div style="display:flex;gap:10px;">
          <button onclick="searchSimilarAnomalies()" class="btn btn-primary" style="background:#ff9800;flex:1;">æ¤œç´¢</button>
          <button onclick="clearSearchFilters()" class="btn btn-secondary" style="flex:1;">ã‚¯ãƒªã‚¢</button>
        </div>

        <div id="similarResults" style="margin-top:20px;"></div>
      </div>

      <!-- çµ±è¨ˆ -->
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#ff9800;margin-bottom:15px;">ğŸ“ˆ çµ±è¨ˆæƒ…å ±</h3>
        <div id="statisticsDisplay" style="display:grid;gap:15px;"></div>
      </div>

      <!-- å‚¾å‘ -->
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#ff9800;margin-bottom:15px;">ğŸ“Š æœˆåˆ¥å‚¾å‘åˆ†æ</h3>
        <div id="trendChart" style="min-height:300px;"></div>
        <div id="trendAnalysis" style="margin-top:15px;"></div>
      </div>

      <!-- éƒ¨ç½²/ãƒ©ã‚¤ãƒ³ -->
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#ff9800;margin-bottom:15px;">ğŸ¢ éƒ¨ç½²ãƒ»ãƒ©ã‚¤ãƒ³åˆ¥åˆ†æ</h3>
        <div id="departmentAnalysis" style="display:grid;gap:15px;"></div>
      </div>

      <!-- å†ç™º -->
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);">
        <h3 style="color:#ff9800;margin-bottom:15px;">ğŸ”„ å†ç™ºãƒ»æ–°è¦åˆ†æ</h3>
        <div id="recurrenceAnalysis"></div>
      </div>
    </div>

    <!-- ç®¡ç† -->
    <div id="master" class="tab-content">
      <h2 style="margin-bottom:20px;color:#667eea;">âš™ï¸ ãƒã‚¹ã‚¿ç®¡ç†</h2>

      <!-- éƒ¨ç½²ç®¡ç† -->
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#667eea;margin-bottom:15px;">éƒ¨ç½²ç®¡ç†</h3>
        <div style="display:flex;gap:10px;margin-bottom:15px;">
          <input type="text" id="newDepartment" placeholder="æ–°ã—ã„éƒ¨ç½²åã‚’å…¥åŠ›" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button onclick="addDepartment()" class="btn btn-primary" style="width:auto;padding:10px 20px;margin:0;">è¿½åŠ </button>
        </div>
        <div id="departmentList" style="display:grid;gap:10px;"></div>
      </div>

      <!-- ãƒ©ã‚¤ãƒ³åç®¡ç† -->
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#f57c00;margin-bottom:15px;">ãƒ©ã‚¤ãƒ³åç®¡ç†</h3>
        <div class="form-group">
          <label>å¯¾è±¡éƒ¨ç½²</label>
          <select id="lineManageDept" onchange="updateLineManageList()">
            <option value="">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
        <div style="display:flex;gap:10px;margin-bottom:15px;">
          <input type="text" id="newLine" placeholder="æ–°ã—ã„ãƒ©ã‚¤ãƒ³åã‚’å…¥åŠ›" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button onclick="addLine()" class="btn btn-primary" style="width:auto;padding:10px 20px;margin:0;background:#f57c00;">è¿½åŠ </button>
        </div>
        <div id="lineList" style="display:grid;gap:10px;"></div>
      </div>

      <!-- å‡¦ç½®è€…ç®¡ç† -->
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);">
        <h3 style="color:#2e7d32;margin-bottom:15px;">å‡¦ç½®è€…ç®¡ç†</h3>
        <div class="form-group">
          <label>å¯¾è±¡éƒ¨ç½²</label>
          <select id="handlerManageDept" onchange="updateHandlerManageList()">
            <option value="">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
        <div style="display:flex;gap:10px;margin-bottom:15px;">
          <input type="text" id="newHandler" placeholder="æ–°ã—ã„å‡¦ç½®è€…åã‚’å…¥åŠ›" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button onclick="addHandler()" class="btn btn-primary" style="width:auto;padding:10px 20px;margin:0;background:#2e7d32;">è¿½åŠ </button>
        </div>
        <div id="handlerList" style="display:grid;gap:10px;"></div>
      </div>
    </div>
  </div>

  <!-- â–¼ å±¥æ­´ã‹ã‚‰ã®LINEè»¢é€ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå”¯ä¸€ã®LINEæ©Ÿèƒ½ï¼‰ -->
  <div id="lineSendModal" class="modal">
    <div class="modal-content">
      <h3>LINEè»¢é€</h3>
      <p class="helper">ä»»æ„ã®Webhook URLã«POSTã—ã¾ã™ï¼ˆJSON: <code>{ text, record }</code>ï¼‰ã€‚è»¢é€å…ˆã¯ç«¯æœ«ã«ä¿å­˜ã•ã‚Œã€æ¬¡å›ã‚‚è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ã€‚</p>

      <div class="modal-row">
        <label for="lineDestUrl">è»¢é€å…ˆ Webhook URL *</label>
        <input id="lineDestUrl" type="url" placeholder="https://example.com/webhook">
      </div>

      <div class="modal-row">
        <label for="lineMessage">é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆç·¨é›†å¯ï¼‰</label>
        <textarea id="lineMessage" style="min-height:140px;"></textarea>
      </div>

      <div class="modal-row" style="display:flex;gap:10px;">
        <button class="btn btn-line" style="flex:1" onclick="sendLine()">é€ä¿¡</button>
        <button class="btn btn-secondary" style="flex:1" onclick="closeLineSendModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>

      <p class="helper" style="margin-top:8px;">â€»ç›´æ¥LINEã«å±Šã‘ã‚‹ã«ã¯ã€URLå…ˆã§LINE Messaging API / LINE Notifyç­‰ã¸ä¸­ç¶™ã—ã¦ãã ã•ã„ã€‚</p>
    </div>
  </div>
  <!-- â–² å±¥æ­´ã‹ã‚‰ã®LINEè»¢é€ãƒ¢ãƒ¼ãƒ€ãƒ« -->

<script>
  let anomalyData = [];
  let mfgPhotos = [];
  let techPhotos = [];
  let currentView = 'card';

  // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿
  let masterData = {
    departments: [],
    lines: {}, // {dept: [line,...]}
    handlers: {} // {dept: [handler,...]}
  };

  // ===== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  function saveData(){ localStorage.setItem('anomalyData', JSON.stringify(anomalyData)); }
  function saveMasterData(){ localStorage.setItem('masterData', JSON.stringify(masterData)); }

  function loadData(){
    const saved = localStorage.getItem('anomalyData');
    if(saved){ anomalyData = JSON.parse(saved); }

    const savedMaster = localStorage.getItem('masterData');
    if(savedMaster){
      masterData = JSON.parse(savedMaster);
    }else{
      masterData = {
        departments:['è£½é€ 1èª²','è£½é€ 2èª²','çµ„ç«‹èª²'],
        lines:{
          'è£½é€ 1èª²':['ãƒ©ã‚¤ãƒ³1','ãƒ©ã‚¤ãƒ³2'],
          'è£½é€ 2èª²':['ãƒ©ã‚¤ãƒ³A','ãƒ©ã‚¤ãƒ³B'],
          'çµ„ç«‹èª²':['çµ„ç«‹1','çµ„ç«‹2']
        },
        handlers:{
          'è£½é€ 1èª²':['å±±ç”°å¤ªéƒ','ä½è—¤èŠ±å­'],
          'è£½é€ 2èª²':['éˆ´æœ¨ä¸€éƒ','ç”°ä¸­ç¾å’²'],
          'çµ„ç«‹èª²':['é«˜æ©‹å¥å¤ª','ä¼Šè—¤æ„›']
        }
      };
      saveMasterData();
    }

    updateHistory();
    updateSerialNoSelect();
    updateAllDepartmentSelects();
  }

  function updateAllDepartmentSelects(){
    updateDepartmentSelect('department');
    updateDepartmentSelect('lineManageDept');
    updateDepartmentSelect('handlerManageDept');
    updateDepartmentList();
  }

  function updateDepartmentSelect(selectId){
    const sel = document.getElementById(selectId);
    const keep = sel.value;
    sel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    masterData.departments.forEach(d=>{
      const op=document.createElement('option');
      op.value=d; op.textContent=d;
      sel.appendChild(op);
    });
    if(keep && masterData.departments.includes(keep)) sel.value=keep;
  }

  // éƒ¨ç½²â†’ãƒ©ã‚¤ãƒ³/å‡¦ç½®è€…
  function updateLineOptions(){
    const dept = document.getElementById('department').value;
    const lineSel = document.getElementById('lineName');
    const handlerSel = document.getElementById('handler');
    lineSel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    handlerSel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';

    (masterData.lines[dept]||[]).forEach(line=>{
      const op=document.createElement('option'); op.value=line; op.textContent=line; lineSel.appendChild(op);
    });
    (masterData.handlers[dept]||[]).forEach(h=>{
      const op=document.createElement('option'); op.value=h; op.textContent=h; handlerSel.appendChild(op);
    });
  }

  // éƒ¨ç½²ç®¡ç†
  function addDepartment(){
    const input = document.getElementById('newDepartment');
    const name = input.value.trim();
    if(!name) return alert('éƒ¨ç½²åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    if(masterData.departments.includes(name)) return alert('ã“ã®éƒ¨ç½²ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
    masterData.departments.push(name);
    masterData.lines[name]=[]; masterData.handlers[name]=[];
    saveMasterData(); updateAllDepartmentSelects(); input.value='';
  }
  function deleteDepartment(name){
    if(!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\né–¢é€£ã™ã‚‹ãƒ©ã‚¤ãƒ³åã¨å‡¦ç½®è€…ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) return;
    masterData.departments = masterData.departments.filter(d=>d!==name);
    delete masterData.lines[name]; delete masterData.handlers[name];
    saveMasterData(); updateAllDepartmentSelects();
  }
  function updateDepartmentList(){
    const list=document.getElementById('departmentList'); list.innerHTML='';
    if(masterData.departments.length===0){ list.innerHTML='<p style="color:#999;text-align:center;">éƒ¨ç½²ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; return; }
    masterData.departments.forEach(d=>{
      const div=document.createElement('div');
      div.className='master-item';
      div.innerHTML=`<span class="master-item-name">${d}</span><button class="btn-delete" onclick="deleteDepartment('${d}')">å‰Šé™¤</button>`;
      list.appendChild(div);
    });
  }

  // ãƒ©ã‚¤ãƒ³ç®¡ç†
  function addLine(){
    const dept = document.getElementById('lineManageDept').value;
    const input = document.getElementById('newLine');
    const name = input.value.trim();
    if(!dept) return alert('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„');
    if(!name) return alert('ãƒ©ã‚¤ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    masterData.lines[dept]=masterData.lines[dept]||[];
    if(masterData.lines[dept].includes(name)) return alert('ã“ã®ãƒ©ã‚¤ãƒ³åã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
    masterData.lines[dept].push(name);
    saveMasterData(); updateLineManageList(); input.value='';
  }
  function deleteLine(dept,line){
    if(!confirm(`ã€Œ${line}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
    masterData.lines[dept]=masterData.lines[dept].filter(l=>l!==line);
    saveMasterData(); updateLineManageList();
  }
  function updateLineManageList(){
    const dept=document.getElementById('lineManageDept').value;
    const list=document.getElementById('lineList'); list.innerHTML='';
    if(!dept){ list.innerHTML='<p style="color:#999;text-align:center;">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</p>'; return; }
    const arr=masterData.lines[dept]||[];
    if(arr.length===0){ list.innerHTML='<p style="color:#999;text-align:center;">ãƒ©ã‚¤ãƒ³åãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; return; }
    arr.forEach(line=>{
      const div=document.createElement('div');
      div.className='master-item';
      div.innerHTML=`<span class="master-item-name">${line}</span><button class="btn-delete" onclick="deleteLine('${dept}','${line}')">å‰Šé™¤</button>`;
      list.appendChild(div);
    });
  }

  // å‡¦ç½®è€…ç®¡ç†
  function addHandler(){
    const dept=document.getElementById('handlerManageDept').value;
    const input=document.getElementById('newHandler');
    const name=input.value.trim();
    if(!dept) return alert('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„');
    if(!name) return alert('å‡¦ç½®è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    masterData.handlers[dept]=masterData.handlers[dept]||[];
    if(masterData.handlers[dept].includes(name)) return alert('ã“ã®å‡¦ç½®è€…ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
    masterData.handlers[dept].push(name);
    saveMasterData(); updateHandlerManageList(); input.value='';
  }
  function deleteHandler(dept,name){
    if(!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
    masterData.handlers[dept]=masterData.handlers[dept].filter(h=>h!==name);
    saveMasterData(); updateHandlerManageList();
  }
  function updateHandlerManageList(){
    const dept=document.getElementById('handlerManageDept').value;
    const list=document.getElementById('handlerList'); list.innerHTML='';
    if(!dept){ list.innerHTML='<p style="color:#999;text-align:center;">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</p>'; return; }
    const arr=masterData.handlers[dept]||[];
    if(arr.length===0){ list.innerHTML='<p style="color:#999;text-align:center;">å‡¦ç½®è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; return; }
    arr.forEach(h=>{
      const div=document.createElement('div');
      div.className='master-item';
      div.innerHTML=`<span class="master-item-name">${h}</span><button class="btn-delete" onclick="deleteHandler('${dept}','${h}')">å‰Šé™¤</button>`;
      list.appendChild(div);
    });
  }

  // ã‚¿ãƒ–åˆ‡æ›¿
  function switchTab(tabName){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(tabName).classList.add('active');
    if(tabName==='history'){ updateHistory(); }
    else if(tabName==='technical'){ updateSerialNoSelect(); }
    else if(tabName==='analysis'){ updateAnalysis(); }
  }

  // NOWç³»
  function setNowDate(){
    const now=new Date(); const h=now.getHours();
    if(h>=0 && h<6) now.setDate(now.getDate()-1);
    const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0');
    document.getElementById('occurrenceDate').value=`${y}-${m}-${d}`;
  }
  function setNowTime(id){
    const n=new Date(); const H=String(n.getHours()).padStart(2,'0'); const M=String(n.getMinutes()).padStart(2,'0');
    document.getElementById(id).value=`${H}:${M}`;
  }

  // é¡ä¼¼æ•´ç†Noå€™è£œï¼ˆè£½é€ å´ï¼‰
  function searchSimilarSerialNo(){
    const sn=document.getElementById('serialNo').value.trim();
    const area=document.getElementById('suggestionArea');
    const box=document.getElementById('suggestionButtons');
    if(!sn){ area.style.display='none'; return; }
    const similar=anomalyData.filter(i=>i.serialNo===sn).slice(0,10);
    if(similar.length===0){ area.style.display='none'; return; }

    const anomalyContents=extractTopCandidates(similar,'anomalyContent',4);
    const actionTakens=extractTopCandidates(similar,'actionTaken',4);
    let html='';
    if(anomalyContents.length>0){
      html+=`<div class="suggestion-category">
        <div class="suggestion-category-title">ğŸ“ ç•°å¸¸å†…å®¹ã®å€™è£œï¼ˆå“ç•ª: ${sn}ï¼‰</div>
        <div>${anomalyContents.map(t=>`<button type="button" class="suggestion-btn" onclick="applySuggestion('anomalyContent','${escapeHtml(t)}')">${truncateText(t,30)}</button>`).join('')}</div>
      </div>`;
    }
    if(actionTakens.length>0){
      html+=`<div class="suggestion-category">
        <div class="suggestion-category-title">ğŸ”§ è£½é€ å‡¦ç½®å†…å®¹ã®å€™è£œï¼ˆå“ç•ª: ${sn}ï¼‰</div>
        <div>${actionTakens.map(t=>`<button type="button" class="suggestion-btn" onclick="applySuggestion('actionTaken','${escapeHtml(t)}')">${truncateText(t,30)}</button>`).join('')}</div>
      </div>`;
    }
    if(html){ box.innerHTML=html; area.style.display='block'; } else { area.style.display='none'; }
  }
  function extractTopCandidates(arr,field,maxCount){
    const freq={}; arr.forEach(it=>{ const t=it[field]; if(t&&t.trim()) freq[t]=(freq[t]||0)+1; });
    return Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,maxCount).map(e=>e[0]);
  }
  function applySuggestion(id,text){
    const el=document.getElementById(id); if(!el) return;
    el.value=text; if(el.tagName==='TEXTAREA'){ el.style.height='auto'; el.style.height=el.scrollHeight+'px'; }
    el.style.background='#e1bee7'; setTimeout(()=>{ el.style.background=''; },500);
  }
  function escapeHtml(t){ return t.replace(/'/g,"\\'").replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function truncateText(t,n){ return t.length<=n ? t : t.substring(0,n)+'...'; }

  // å†™çœŸ
  function handlePhotoUpload(inputId,previewId,arr){
    const input=document.getElementById(inputId);
    input.addEventListener('change',e=>{
      const files=Array.from(e.target.files);
      files.forEach(f=>{
        const r=new FileReader();
        r.onload=function(ev){ arr.push(ev.target.result); displayPhotos(previewId,arr); };
        r.readAsDataURL(f);
      });
    });
  }
  function displayPhotos(previewId,arr){
    const preview=document.getElementById(previewId); preview.innerHTML='';
    arr.forEach((p,idx)=>{
      const div=document.createElement('div'); div.className='photo-item';
      div.innerHTML=`<img src="${p}" alt="Photo ${idx+1}"><button class="remove-btn" onclick="removePhoto('${previewId}',${idx},'${previewId==='mfgPhotoPreview'?'mfg':'tech'}')">Ã—</button>`;
      preview.appendChild(div);
    });
  }
  function removePhoto(previewId,idx,type){
    if(type==='mfg'){ mfgPhotos.splice(idx,1); displayPhotos(previewId,mfgPhotos); }
    else{ techPhotos.splice(idx,1); displayPhotos(previewId,techPhotos); }
  }

  // è£½é€ ãƒ•ã‚©ãƒ¼ãƒ 
  document.getElementById('manufacturingForm').addEventListener('submit',function(e){
    e.preventDefault();
    const techRequest=document.getElementById('techRequest').value;
    const data={
      id: Date.now()+Math.random(),
      department: document.getElementById('department').value,
      lineName: document.getElementById('lineName').value,
      serialNo: document.getElementById('serialNo').value,
      occurrenceDate: document.getElementById('occurrenceDate').value,
      occurrenceTime: document.getElementById('occurrenceTime').value,
      restartTime: document.getElementById('restartTime').value,
      anomalyContent: document.getElementById('anomalyContent').value,
      actionTaken: document.getElementById('actionTaken').value,
      traceback: document.getElementById('traceback').value,
      handler: document.getElementById('handler').value,
      techRequest,
      mfgPhotos:[...mfgPhotos],
      status: techRequest==='å®Œçµ' ? 'complete' : 'pending',
      createdAt: new Date().toISOString()
    };
    anomalyData.push(data); saveData();
    alert('ç™»éŒ²ã—ã¾ã—ãŸ');
    this.reset(); mfgPhotos=[]; document.getElementById('mfgPhotoPreview').innerHTML='';
    document.getElementById('lineName').innerHTML='<option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>';
    document.getElementById('handler').innerHTML='<option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>';
    updateSerialNoSelect(); updateHistory();
  });

  // æŠ€è¡“ãƒ•ã‚©ãƒ¼ãƒ 
  document.getElementById('technicalForm').addEventListener('submit',function(e){
    e.preventDefault();
    const recordId=document.getElementById('selectSerialNo').value;
    const idx=anomalyData.findIndex(it=>it.id==recordId);
    if(idx!==-1){
      anomalyData[idx].techHandler=document.getElementById('techHandler').value;
      anomalyData[idx].lifespan=document.getElementById('lifespan').value;
      anomalyData[idx].maintenanceUnit=document.getElementById('maintenanceUnit').value;
      anomalyData[idx].rootCauseAction=document.getElementById('rootCauseAction').value;
      anomalyData[idx].recurrenceType=document.getElementById('recurrenceType').value;
      anomalyData[idx].techPhotos=[...techPhotos];
      anomalyData[idx].status='complete';
      anomalyData[idx].completedAt=new Date().toISOString();
      saveData();
      alert('ç™»éŒ²ã—ã¾ã—ãŸ');
      this.reset(); techPhotos=[]; document.getElementById('techPhotoPreview').innerHTML='';
      document.getElementById('selectedDataDisplay').style.display='none';
      updateSerialNoSelect(); updateHistory();
    }
  });

  // æŠ€è¡“ç”¨ï¼šå¯¾è±¡é¸æŠ
  function updateSerialNoSelect(){
    const sel=document.getElementById('selectSerialNo');
    sel.innerHTML='<option value="">æ•´ç†Noã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    anomalyData
      .filter(it=>it.status==='pending' && it.techRequest==='è¦è«‹')
      .sort((a,b)=>new Date(b.occurrenceDate)-new Date(a.occurrenceDate))
      .forEach(it=>{
        const op=document.createElement('option');
        op.value=it.id;
        op.textContent=`[${it.serialNo}] ${it.occurrenceDate} - ${it.anomalyContent.substring(0,30)}...`;
        sel.appendChild(op);
      });
  }
  function loadManufacturingData(){
    const id=document.getElementById('selectSerialNo').value;
    const box=document.getElementById('displayContent');
    const wrap=document.getElementById('selectedDataDisplay');
    if(!id){ wrap.style.display='none'; box.innerHTML=''; return; }
    const d=anomalyData.find(it=>it.id==id);
    if(!d){ wrap.style.display='none'; box.innerHTML=''; return; }
    box.innerHTML=`
      <div style="display:grid;gap:10px;">
        <div><strong>æ•´ç†Noï¼ˆå“ç•ªï¼‰:</strong> ${d.serialNo}</div>
        ${d.department?`<div><strong>éƒ¨ç½²:</strong> ${d.department}</div>`:''}
        ${d.lineName?`<div><strong>ãƒ©ã‚¤ãƒ³å:</strong> ${d.lineName}</div>`:''}
        <div><strong>ç•°å¸¸å†…å®¹:</strong> ${d.anomalyContent}</div>
        <div><strong>è£½é€ å‡¦ç½®:</strong> ${d.actionTaken}</div>
        <div><strong>ç™ºç”Ÿæ—¥:</strong> ${d.occurrenceDate}</div>
        <div><strong>å‡¦ç½®è€…:</strong> ${d.handler}</div>
      </div>`;
    wrap.style.display='block';
  }

  // å±¥æ­´
  function updateHistory(){ currentView==='card' ? updateCardView() : updateTableView(); }

  function updateCardView(){
    const card=document.getElementById('cardView');
    if(anomalyData.length===0){
      card.innerHTML=`<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;
      return;
    }
    card.innerHTML = anomalyData.map(item=>{
      let statusText='å®Œäº†', statusClass='status-complete';
      if(item.status==='pending'){ statusText='æŠ€è¡“å…¥åŠ›å¾…ã¡'; statusClass='status-pending'; }
      else if(item.status==='complete' && item.techRequest==='å®Œçµ'){ statusText='å®Œäº†ï¼ˆè£½é€ å®Œçµï¼‰'; }

      return `
      <div class="anomaly-card ${item.status==='complete'?'complete':''}">
        <div class="card-header">
          <div class="card-id">${item.serialNo}</div>
          <div class="card-status ${statusClass}">${statusText}</div>
        </div>
        <div class="card-body">
          ${item.department?`<div class="card-field"><div class="field-label">éƒ¨ç½²</div><div class="field-value">${item.department}</div></div>`:''}
          ${item.lineName?`<div class="card-field"><div class="field-label">ãƒ©ã‚¤ãƒ³å</div><div class="field-value">${item.lineName}</div></div>`:''}
          ${item.techRequest?`<div class="card-field"><div class="field-label">æŠ€è¡“è¦è«‹</div><div class="field-value">${item.techRequest==='è¦è«‹'?'æŠ€è¡“è¦è«‹ã‚ã‚Š':'è£½é€ ã§å®Œçµ'}</div></div>`:''}
          <div class="card-field"><div class="field-label">ç•°å¸¸å†…å®¹</div><div class="field-value">${item.anomalyContent}</div></div>
          <div class="card-field"><div class="field-label">è£½é€ å‡¦ç½®</div><div class="field-value">${item.actionTaken}</div></div>
          <div class="card-field"><div class="field-label">ç™ºç”Ÿæ—¥æ™‚</div><div class="field-value">${item.occurrenceDate} ${item.occurrenceTime||''}</div></div>
          <div class="card-field"><div class="field-label">å‡¦ç½®è€…</div><div class="field-value">${item.handler}</div></div>
          ${item.status==='complete' && item.techRequest==='è¦è«‹' ? `
            <div class="card-field"><div class="field-label">æŠ€è¡“å‡¦ç½®è€…</div><div class="field-value">${item.techHandler||'-'}</div></div>
            <div class="card-field"><div class="field-label">åŸå› ãƒ»å¯¾ç­–</div><div class="field-value">${item.rootCauseAction||'-'}</div></div>
            <div class="card-field"><div class="field-label">å†ç™º/æ–°è¦</div><div class="field-value">${item.recurrenceType||'-'}</div></div>
          `:''}
          <div class="action-btns">
            <button class="btn-small btn-line" onclick="openLineSendModal(${item.id})">LINEè»¢é€</button>
            <button class="btn-small btn-delete" onclick="deleteRecord(${item.id})">å‰Šé™¤</button>
          </div>
        </div>
      </div>`;
    }).join('');
  }

  function updateTableView(){
    const tableView=document.getElementById('tableView');
    if(anomalyData.length===0){
      tableView.innerHTML=`<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;
      return;
    }
    tableView.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>æ•´ç†No</th><th>éƒ¨ç½²</th><th>ãƒ©ã‚¤ãƒ³</th><th>ç•°å¸¸å†…å®¹</th><th>ç™ºç”Ÿæ—¥</th><th>å‡¦ç½®è€…</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          ${anomalyData.map(item=>`
            <tr>
              <td>${item.serialNo}</td>
              <td>${item.department||'-'}</td>
              <td>${item.lineName||'-'}</td>
              <td>${item.anomalyContent.substring(0,30)}...</td>
              <td>${item.occurrenceDate}</td>
              <td>${item.handler}</td>
              <td><span class="card-status ${item.status==='complete'?'status-complete':'status-pending'}">${item.status==='complete'?'å®Œäº†':'å¾…ã¡'}</span></td>
              <td>
                <button class="btn-small btn-line" onclick="openLineSendModal(${item.id})">LINEè»¢é€</button>
                <button class="btn-small btn-delete" onclick="deleteRecord(${item.id})">å‰Šé™¤</button>
              </td>
            </tr>`).join('')}
        </tbody>
      </table>`;
  }

  function toggleView(view){
    currentView=view;
    document.querySelectorAll('.view-toggle button').forEach(b=>b.classList.remove('active'));
    event.target.classList.add('active');
    if(view==='card'){ document.getElementById('cardView').style.display='grid'; document.getElementById('tableView').style.display='none'; }
    else{ document.getElementById('cardView').style.display='none'; document.getElementById('tableView').style.display='block'; }
    updateHistory();
  }

  function deleteRecord(id){
    if(!confirm('ã“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    anomalyData = anomalyData.filter(it=>it.id!==id); saveData();
    updateHistory(); updateSerialNoSelect();
  }

  // CSV
  function exportCSV(){
    if(anomalyData.length===0) return alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
    const headers=['æ•´ç†No','éƒ¨ç½²','ãƒ©ã‚¤ãƒ³å','ç™ºç”Ÿæ—¥','ç™ºç”Ÿæ™‚åˆ»','å†é–‹æ™‚åˆ»','ç•°å¸¸å†…å®¹','è£½é€ å‡¦ç½®å†…å®¹','é¡ã‚Š','å‡¦ç½®è€…','æŠ€è¡“è¦è«‹','æŠ€è¡“å‡¦ç½®è€…','å‘½æ•°æœ‰ç„¡','ä¿å…¨å˜ä½','åŸå› å¯¾ç­–','å†ç™ºæ–°è¦','çŠ¶æ…‹'];
    const rows=anomalyData.map(it=>[
      it.serialNo,it.department||'',it.lineName||'',it.occurrenceDate,it.occurrenceTime||'',it.restartTime||'',
      it.anomalyContent,it.actionTaken,it.traceback,it.handler,
      it.techRequest==='è¦è«‹'?'æŠ€è¡“è¦è«‹ã‚ã‚Š':it.techRequest==='å®Œçµ'?'è£½é€ ã§å®Œçµ':'',
      it.techHandler||'',it.lifespan||'',it.maintenanceUnit||'',it.rootCauseAction||'',it.recurrenceType||'',
      it.status==='complete'?'å®Œäº†':'æŠ€è¡“å…¥åŠ›å¾…ã¡'
    ]);
    let csv='\uFEFF'+headers.join(',')+'\n';
    rows.forEach(r=>{ csv+=r.map(c=>`"${c}"`).join(',')+'\n'; });
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`ç•°å¸¸å±¥æ­´_${new Date().toISOString().split('T')[0]}.csv`; a.click();
  }
  function importCSV(ev){
    const file=ev.target.files[0]; if(!file) return;
    const r=new FileReader();
    r.onload=function(e){
      try{
        const text=e.target.result; const lines=text.split('\n').filter(l=>l.trim());
        if(lines.length<2) return alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™');
        const dataLines=lines.slice(1); let cnt=0;
        dataLines.forEach(line=>{
          const vals=line.match(/(".*?"|[^",]+)(?=,|\s*$)/g)?.map(v=>v.replace(/^"|"$/g,''))||[];
          if(vals.length>=10){
            let techRequest='';
            if(vals[10]==='æŠ€è¡“è¦è«‹ã‚ã‚Š') techRequest='è¦è«‹';
            else if(vals[10]==='è£½é€ ã§å®Œçµ') techRequest='å®Œçµ';
            const d={
              id: Date.now()+cnt,
              serialNo: vals[0], department: vals[1]||'', lineName: vals[2]||'',
              occurrenceDate: vals[3], occurrenceTime: vals[4]||'', restartTime: vals[5]||'',
              anomalyContent: vals[6], actionTaken: vals[7], traceback: vals[8], handler: vals[9],
              techRequest, techHandler: vals[11]||'', lifespan: vals[12]||'',
              maintenanceUnit: vals[13]||'', rootCauseAction: vals[14]||'', recurrenceType: vals[15]||'',
              status: vals[16]==='å®Œäº†'?'complete':'pending', mfgPhotos:[], techPhotos:[], createdAt:new Date().toISOString()
            };
            anomalyData.push(d); cnt++;
          }
        });
        saveData(); updateHistory(); updateSerialNoSelect(); alert(`${cnt}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
      }catch(err){ console.error(err); alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    };
    r.readAsText(file,'UTF-8'); ev.target.value='';
  }

  // === åˆ†æ ===
  function updateAnalysis(){ updateStatistics(); updateTrendAnalysis(); updateDepartmentAnalysis(); updateRecurrenceAnalysis(); updateSearchDepartmentSelect(); }
  function updateSearchDepartmentSelect(){
    const sel=document.getElementById('searchDepartment'); const keep=sel.value;
    sel.innerHTML='<option value="">ã™ã¹ã¦</option>';
    masterData.departments.forEach(d=>{ const op=document.createElement('option'); op.value=d; op.textContent=d; sel.appendChild(op); });
    if(keep && masterData.departments.includes(keep)){ sel.value=keep; updateSearchLineOptions(); }
  }
  function searchSimilarAnomalies(){
    const keyword=document.getElementById('searchKeyword').value.trim().toLowerCase();
    const dept=document.getElementById('searchDepartment').value;
    const line=document.getElementById('searchLine').value;
    const serial=document.getElementById('searchSerialNo').value.trim();
    const out=document.getElementById('similarResults');

    let results=anomalyData.filter(it=>{
      if(dept && it.department!==dept) return false;
      if(line && it.lineName!==line) return false;
      if(serial && !it.serialNo.toLowerCase().includes(serial.toLowerCase())) return false;
      if(keyword){
        const content=(it.anomalyContent+' '+it.actionTaken+' '+(it.rootCauseAction||'')).toLowerCase();
        return content.includes(keyword);
      }
      return true;
    });

    if(keyword){
      results = results.map(it=>{
        const content=(it.anomalyContent+' '+it.actionTaken+' '+(it.rootCauseAction||'')).toLowerCase();
        const score=(content.match(new RegExp(keyword,'g'))||[]).length;
        return {...it, score};
      }).sort((a,b)=>b.score-a.score);
    }else{
      results.sort((a,b)=>new Date(b.occurrenceDate)-new Date(a.occurrenceDate));
    }

    if(results.length===0){ out.innerHTML='<p style="color:#999;">è©²å½“ã™ã‚‹ç•°å¸¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>'; return; }

    const info=[]; if(dept) info.push(`éƒ¨ç½²: ${dept}`); if(line) info.push(`ãƒ©ã‚¤ãƒ³: ${line}`); if(serial) info.push(`æ•´ç†No: ${serial}`); if(keyword) info.push(`ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${keyword}`);

    out.innerHTML=`
      <div style="margin-bottom:15px;padding:10px;background:#e3f2fd;border-radius:6px;">
        <strong>æ¤œç´¢æ¡ä»¶:</strong> ${info.length>0?info.join(' / '):'ã™ã¹ã¦'}
      </div>
      <p style="margin-bottom:15px;font-weight:bold;color:#333;">è©²å½“ä»¶æ•°: ${results.length}ä»¶</p>
      ${results.map(it=>`
        <div class="similar-item" style="background:#f8f9fa;padding:15px;border-radius:6px;margin-bottom:10px;border-left:4px solid #ff9800;">
          <div class="similar-item-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #e0e0e0;">
            <div><strong style="color:#ff9800;">${it.serialNo}</strong><span style="color:#666;margin-left:10px;">${it.occurrenceDate}</span></div>
            ${keyword && it.score ? `<span class="similar-score" style="background:#ff9800;color:#fff;padding:4px 12px;border-radius:12px;font-size:.85rem;font-weight:bold;">ä¸€è‡´åº¦: ${it.score}</span>`:''}
          </div>
          ${it.department||it.lineName ? `
            <div style="margin-bottom:8px;">
              ${it.department?`<span style="background:#e3f2fd;padding:3px 10px;border-radius:12px;font-size:.85rem;margin-right:5px;">${it.department}</span>`:''}
              ${it.lineName?`<span style="background:#fff3e0;padding:3px 10px;border-radius:12px;font-size:.85rem;">${it.lineName}</span>`:''}
            </div>`:''}
          <div style="margin-bottom:8px;"><strong>ç•°å¸¸å†…å®¹:</strong> ${it.anomalyContent}</div>
          <div style="margin-bottom:8px;"><strong>è£½é€ å‡¦ç½®:</strong> ${it.actionTaken}</div>
          ${it.rootCauseAction?`<div style="margin-bottom:8px;background:#f1f8e9;padding:10px;border-radius:4px;border-left:3px solid #8bc34a;"><strong style="color:#558b2f;">ğŸ’¡ æŠ€è¡“å¯¾ç­–:</strong> ${it.rootCauseAction}</div>`:''}
          <div style="font-size:.85rem;color:#666;margin-top:5px;">
            ${it.handler?`å‡¦ç½®è€…: ${it.handler}`:''}
            ${it.handler && it.techHandler ? ' / ' : ''}
            ${it.techHandler?`æŠ€è¡“å‡¦ç½®è€…: ${it.techHandler}`:''}
          </div>
        </div>`).join('')}
    `;
  }
  function updateSearchLineOptions(){
    const dept=document.getElementById('searchDepartment').value;
    const sel=document.getElementById('searchLine'); sel.innerHTML='<option value="">ã™ã¹ã¦</option>';
    (masterData.lines[dept]||[]).forEach(line=>{
      const op=document.createElement('option'); op.value=line; op.textContent=line; sel.appendChild(op);
    });
  }
  function clearSearchFilters(){
    document.getElementById('searchDepartment').value='';
    document.getElementById('searchLine').value='';
    document.getElementById('searchLine').innerHTML='<option value="">ã™ã¹ã¦</option>';
    document.getElementById('searchSerialNo').value='';
    document.getElementById('searchKeyword').value='';
    document.getElementById('similarResults').innerHTML='';
  }

  function updateStatistics(){
    const total=anomalyData.length;
    const completed=anomalyData.filter(it=>it.status==='complete').length;
    const pending=total-completed;
    const now=new Date();
    const thisMonth=anomalyData.filter(it=>{
      const d=new Date(it.occurrenceDate);
      return d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear();
    }).length;

    let avg=0, n=0;
    anomalyData.forEach(it=>{
      if(it.occurrenceTime && it.restartTime){
        const [oh,om]=it.occurrenceTime.split(':').map(Number);
        const [rh,rm]=it.restartTime.split(':').map(Number);
        let min=(rh*60+rm)-(oh*60+om); if(min<0) min+=1440; avg+=min; n++;
      }
    });
    avg = n>0 ? Math.round(avg/n) : 0;

    const div=document.getElementById('statisticsDisplay');
    div.innerHTML=`
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
        <div class="stat-card"><h4>ç·ç•°å¸¸ä»¶æ•°</h4><div class="stat-value">${total}</div><div class="stat-label">ä»¶</div></div>
        <div class="stat-card" style="background:linear-gradient(135deg,#2e7d32 0%,#66bb6a 100%);"><h4>å¯¾å¿œå®Œäº†</h4><div class="stat-value">${completed}</div><div class="stat-label">ä»¶ (${total>0?Math.round(completed/total*100):0}%)</div></div>
        <div class="stat-card" style="background:linear-gradient(135deg,#f57c00 0%,#ffb74d 100%);"><h4>å¯¾å¿œå¾…ã¡</h4><div class="stat-value">${pending}</div><div class="stat-label">ä»¶</div></div>
        <div class="stat-card" style="background:linear-gradient(135deg,#c62828 0%,#ef5350 100%);"><h4>ä»Šæœˆã®ç•°å¸¸</h4><div class="stat-value">${thisMonth}</div><div class="stat-label">ä»¶</div></div>
        <div class="stat-card" style="background:linear-gradient(135deg,#1976d2 0%,#42a5f5 100%);"><h4>å¹³å‡å¯¾å¿œæ™‚é–“</h4><div class="stat-value">${avg}</div><div class="stat-label">åˆ†</div></div>
      </div>`;
  }

  function updateTrendAnalysis(){
    const monthly={};
    anomalyData.forEach(it=>{
      const d=new Date(it.occurrenceDate);
      const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      monthly[key]=(monthly[key]||0)+1;
    });
    const months=Object.keys(monthly).sort();
    const max=Math.max(...Object.values(monthly),1);
    const chart=document.getElementById('trendChart');
    chart.innerHTML = months.map(m=>{
      const c=monthly[m]; const w=c/max*100;
      return `<div style="margin-bottom:15px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;"><span style="font-weight:bold;">${m}</span><span style="color:#666;">${c}ä»¶</span></div>
        <div style="background:#e0e0e0;height:30px;border-radius:4px;overflow:hidden;"><div class="chart-bar" style="width:${w}%;">${c}ä»¶</div></div>
      </div>`;
    }).join('');

    const analysis=document.getElementById('trendAnalysis');
    if(months.length>=3){
      const recent3=months.slice(-3).map(m=>monthly[m]);
      const avgRecent=recent3.reduce((a,b)=>a+b,0)/3;
      const prev=months.slice(-6,-3).map(m=>monthly[m]);
      const avgPrev=prev.length>0 ? prev.reduce((a,b)=>a+b,0)/prev.length : avgRecent;
      let trend='æ¨ªã°ã„', cls='trend-stable';
      if(avgRecent>avgPrev*1.2){ trend='å¢—åŠ å‚¾å‘'; cls='trend-increase'; }
      else if(avgRecent<avgPrev*0.8){ trend='æ¸›å°‘å‚¾å‘'; cls='trend-decrease'; }
      analysis.innerHTML=`<div class="analysis-insight"><strong>ğŸ“Š å‚¾å‘åˆ†æ:</strong> ç›´è¿‘3ãƒ¶æœˆå¹³å‡ã¯<strong>${avgRecent.toFixed(1)}ä»¶/æœˆ</strong>ã§ã€<span class="trend-badge ${cls}">${trend}</span>ã§ã™ã€‚</div>`;
    }else{
      analysis.innerHTML='<p style="color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã‚‹ãŸã‚ã€å‚¾å‘åˆ†æã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“</p>';
    }
  }

  function updateDepartmentAnalysis(){
    const dept={}, line={};
    anomalyData.forEach(it=>{
      if(it.department) dept[it.department]=(dept[it.department]||0)+1;
      if(it.lineName) line[it.lineName]=(line[it.lineName]||0)+1;
    });
    const maxD=Math.max(...Object.values(dept),1);
    const maxL=Math.max(...Object.values(line),1);
    const div=document.getElementById('departmentAnalysis');
    let html='<h4 style="color:#666;margin-bottom:10px;">éƒ¨ç½²åˆ¥ç•°å¸¸ä»¶æ•°</h4>';
    for(const [k,v] of Object.entries(dept).sort((a,b)=>b[1]-a[1])){
      html+=`<div style="margin-bottom:10px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;"><span>${k}</span><span style="color:#666;">${v}ä»¶</span></div>
        <div style="background:#e0e0e0;height:25px;border-radius:4px;overflow:hidden;"><div class="chart-bar" style="width:${v/maxD*100}%;height:25px;font-size:.85rem;">${v}ä»¶</div></div>
      </div>`;
    }
    html+='<h4 style="color:#666;margin:20px 0 10px;">ãƒ©ã‚¤ãƒ³åˆ¥ç•°å¸¸ä»¶æ•°</h4>';
    for(const [k,v] of Object.entries(line).sort((a,b)=>b[1]-a[1])){
      html+=`<div style="margin-bottom:10px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;"><span>${k}</span><span style="color:#666;">${v}ä»¶</span></div>
        <div style="background:#e0e0e0;height:25px;border-radius:4px;overflow:hidden;"><div class="chart-bar" style="width:${v/maxL*100}%;height:25px;font-size:.85rem;background:linear-gradient(90deg,#f57c00 0%,#ffb74d 100%);">${v}ä»¶</div></div>
      </div>`;
    }
    div.innerHTML = html || '<p style="color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
  }

  function updateRecurrenceAnalysis(){
    const rec=anomalyData.filter(it=>it.recurrenceType==='å†ç™º').length;
    const nw=anomalyData.filter(it=>it.recurrenceType==='æ–°è¦').length;
    const total=rec+nw;
    const div=document.getElementById('recurrenceAnalysis');
    if(total===0){ div.innerHTML='<p style="color:#999;">æŠ€è¡“å¯¾å¿œæ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>'; return; }
    const rate=(rec/total*100).toFixed(1);
    div.innerHTML=`
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
        <div style="text-align:center;padding:20px;background:#ffebee;border-radius:8px;"><div style="font-size:3rem;font-weight:bold;color:#c62828;">${rec}</div><div style="color:#666;margin-top:5px;">å†ç™ºä»¶æ•°</div></div>
        <div style="text-align:center;padding:20px;background:#e8f5e9;border-radius:8px;"><div style="font-size:3rem;font-weight:bold;color:#2e7d32;">${nw}</div><div style="color:#666;margin-top:5px;">æ–°è¦ä»¶æ•°</div></div>
      </div>
      <div class="analysis-insight"><strong>ğŸ”„ å†ç™ºç‡:</strong> ${rate}% (${rec}/${total}ä»¶)</div>`;
  }

  // === å±¥æ­´ â†’ LINEè»¢é€ï¼ˆå”¯ä¸€ã®LINEæ©Ÿèƒ½ï¼‰ ===
  let currentLineRecordId=null;

  function buildLineMessage(item){
    const lines=[];
    lines.push(`ã€ç•°å¸¸é€£çµ¡ã€‘${item.serialNo}`);
    if(item.department||item.lineName) lines.push(`éƒ¨ç½²/ãƒ©ã‚¤ãƒ³ï¼š${item.department||'-'} / ${item.lineName||'-'}`);
    lines.push(`ç™ºç”Ÿæ—¥ï¼š${item.occurrenceDate}${item.occurrenceTime?` ${item.occurrenceTime}`:''}`);
    lines.push(`ç•°å¸¸å†…å®¹ï¼š${item.anomalyContent}`);
    lines.push(`è£½é€ å‡¦ç½®ï¼š${item.actionTaken}`);
    if(item.status==='complete' && item.techRequest==='è¦è«‹'){
      if(item.rootCauseAction) lines.push(`æŠ€è¡“å¯¾ç­–ï¼š${item.rootCauseAction}`);
      if(item.recurrenceType) lines.push(`åŒºåˆ†ï¼š${item.recurrenceType}`);
    }
    lines.push(`å‡¦ç½®è€…ï¼š${item.handler}${item.techHandler?` / æŠ€è¡“ï¼š${item.techHandler}`:''}`);
    return lines.join('\n');
  }

  function openLineSendModal(id){
    currentLineRecordId=id;
    const item=anomalyData.find(it=>it.id===id);
    if(!item) return;
    const msg=buildLineMessage(item);
    document.getElementById('lineMessage').value=msg;
    const savedUrl=localStorage.getItem('lineDestUrl')||'';
    document.getElementById('lineDestUrl').value=savedUrl;
    document.getElementById('lineSendModal').classList.add('active');
  }
  function closeLineSendModal(){
    document.getElementById('lineSendModal').classList.remove('active');
  }
  async function sendLine(){
    const url=document.getElementById('lineDestUrl').value.trim();
    const text=document.getElementById('lineMessage').value;
    if(!url) return alert('è»¢é€å…ˆURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    const item=anomalyData.find(it=>it.id===currentLineRecordId);
    if(!item) return alert('å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');

    try{
      localStorage.setItem('lineDestUrl',url);
      const res = await fetch(url,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ text, record: item })
      });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      alert('é€ä¿¡ã—ã¾ã—ãŸ âœ“');
      closeLineSendModal();
    }catch(err){
      console.error(err);
      alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Webhook URL ã¨å—ã‘å´ã®è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
    }
  }

  // åˆæœŸåŒ–
  handlePhotoUpload('mfgPhotos','mfgPhotoPreview',mfgPhotos);
  handlePhotoUpload('techPhotos','techPhotoPreview',techPhotos);
  loadData();
  setNowDate();
</script>
</body>
</html>