<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ç•°å¸¸å±¥æ­´å…¥åŠ›ãƒ„ãƒ¼ãƒ«</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Hiragino Sans',sans-serif;background:#f5f5f5}
  .container{max-width:800px;margin:0 auto;padding:10px}
  .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  .header h1{font-size:1.5rem;margin-bottom:5px}

  .tabs{display:flex;background:#fff;margin:15px 0 0;border-radius:8px 8px 0 0;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,.1)}
  .tab{flex:1;padding:15px;text-align:center;cursor:pointer;background:#f8f9fa;border:none;font-size:1rem;font-weight:bold;transition:.3s;color:#666}
  .tab.active{background:#fff;color:#667eea;border-bottom:3px solid #667eea}
  .tab-content{display:none;background:#fff;padding:20px;border-radius:0 0 8px 8px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  .tab-content.active{display:block}

  .form-group{margin-bottom:20px}
  .form-group label{display:block;margin-bottom:8px;font-weight:bold;color:#333;font-size:.95rem}
  .form-group input,.form-group textarea,.form-group select{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:6px;font-size:1rem;transition:border-color .3s}
  .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:#667eea}
  .form-group textarea{min-height:100px;resize:vertical}
  .time-group{display:grid;grid-template-columns:1fr 1fr;gap:10px}

  .photo-upload{border:2px dashed #e0e0e0;border-radius:6px;padding:20px;text-align:center;cursor:pointer;transition:.3s}
  .photo-upload:hover{border-color:#667eea;background:#f8f9ff}
  .photo-upload input[type=file]{display:none}
  .photo-preview{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-top:15px}
  .photo-item{position:relative;aspect-ratio:1;border-radius:6px;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,.1)}
  .photo-item img{width:100%;height:100%;object-fit:cover}
  .photo-item .remove-btn{position:absolute;top:5px;right:5px;background:rgba(255,59,48,.9);color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:14px;line-height:1}

  .btn{width:100%;padding:15px;border:none;border-radius:6px;font-size:1rem;font-weight:bold;cursor:pointer;transition:.3s;margin-top:10px}
  .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
  .btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,.4)}
  .btn-secondary{background:#6c757d;color:#fff}
  .btn-export{background:#28a745;color:#fff}
  .btn-import{background:#17a2b8;color:#fff}

  .history-controls{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
  .view-toggle{display:flex;gap:5px}
  .view-toggle button{padding:8px 15px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:6px;cursor:pointer;font-weight:bold}
  .view-toggle button.active{background:#667eea;color:#fff}

  .card-view{display:grid;gap:15px}
  .anomaly-card{background:#fff;border-radius:8px;padding:15px;box-shadow:0 2px 8px rgba(0,0,0,.1);border-left:4px solid #667eea}
  .anomaly-card.complete{border-left-color:#28a745}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #e0e0e0}
  .card-id{font-size:1.2rem;font-weight:bold;color:#667eea}
  .card-status{padding:4px 12px;border-radius:12px;font-size:.85rem;font-weight:bold}
  .status-pending{background:#fff3cd;color:#856404}
  .status-complete{background:#d4edda;color:#155724}
  .card-body{display:grid;gap:8px}
  .card-field{display:grid;grid-template-columns:120px 1fr;gap:10px}
  .field-label{font-weight:bold;color:#666}
  .field-value{color:#333}

  .table-view{overflow-x:auto;display:none}
  .table-view.active{display:block}
  table{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.1)}
  th,td{padding:12px;text-align:left;border-bottom:1px solid #e0e0e0}
  th{background:#667eea;color:#fff;font-weight:bold;position:sticky;top:0}
  tr:hover{background:#f8f9ff}
  .action-btns{display:flex;gap:5px}
  .btn-small{padding:5px 10px;border:none;border-radius:4px;cursor:pointer;font-size:.85rem}
  .btn-edit{background:#ffc107;color:#000}
  .btn-delete{background:#dc3545;color:#fff}

  .empty-state{text-align:center;padding:40px 20px;color:#999}
  .empty-state-icon{font-size:3rem;margin-bottom:15px}

  .master-item{display:flex;justify-content:space-between;align-items:center;padding:12px 15px;background:#f8f9fa;border-radius:6px;border-left:3px solid #667eea}
  .master-item-name{font-weight:500;color:#333}
  .master-item .btn-delete{padding:5px 12px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:.85rem}
  .master-item .btn-delete:hover{background:#c82333}

  .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;border-radius:8px;text-align:center}
  .stat-card h4{font-size:.9rem;margin-bottom:10px;opacity:.9}
  .stat-card .stat-value{font-size:2.5rem;font-weight:bold;margin-bottom:5px}
  .stat-card .stat-label{font-size:.85rem;opacity:.8}

  .chart-bar{background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);height:30px;border-radius:4px;display:flex;align-items:center;padding:0 10px;color:#fff;font-weight:bold;margin-bottom:10px;transition:.3s}
  .chart-bar:hover{transform:translateX(5px);box-shadow:0 2px 8px rgba(102,126,234,.4)}
  .analysis-insight{background:#e3f2fd;border-left:4px solid #2196f3;padding:15px;border-radius:6px;margin-top:15px}
  .trend-badge{display:inline-block;padding:5px 15px;border-radius:20px;font-weight:bold;font-size:.9rem;margin:5px}
  .trend-increase{background:#ffebee;color:#c62828}
  .trend-decrease{background:#e8f5e9;color:#2e7d32}
  .trend-stable{background:#fff3e0;color:#ef6c00}

  .similar-item{background:#f8f9fa;padding:15px;border-radius:6px;margin-bottom:10px;border-left:4px solid #ff9800}
  .similar-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #e0e0e0}
  .similar-score{background:#ff9800;color:#fff;padding:4px 12px;border-radius:12px;font-size:.85rem;font-weight:bold}

  .past-history-item{background:#fff;padding:15px;border-radius:6px;margin-bottom:15px;border-left:4px solid #ff9800;box-shadow:0 2px 5px rgba(0,0,0,.1)}
  .past-history-item:last-child{margin-bottom:0}
  .past-history-date{font-size:.85rem;color:#666;margin-bottom:8px}
  .past-history-field{margin-bottom:10px;padding:8px;background:#f5f5f5;border-radius:4px}
  .copy-btn{display:inline-block;padding:5px 12px;margin-left:10px;background:#ff9800;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:.85rem;transition:.3s}
  .copy-btn:hover{background:#f57c00;transform:translateY(-1px)}

  @media (max-width:600px){
    .card-field{grid-template-columns:1fr;gap:5px}
    .time-group{grid-template-columns:1fr}
    table{font-size:.85rem}
    th,td{padding:8px}
  }
</style>
</head>
<body>
  <div class="header">
    <h1>ğŸ“‹ ç•°å¸¸å±¥æ­´å…¥åŠ›ãƒ„ãƒ¼ãƒ«</h1>
    <p>è£½é€ ãƒ»æŠ€è¡“éƒ¨é–€é€£æºã‚·ã‚¹ãƒ†ãƒ </p>
  </div>

  <div class="container">
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="manufacturing" type="button">è£½é€ å…¥åŠ›</button>
      <button class="tab" data-tab="technical" type="button">æŠ€è¡“å…¥åŠ›</button>
      <button class="tab" data-tab="history" type="button">å±¥æ­´</button>
      <button class="tab" data-tab="analysis" type="button">ğŸ“Š åˆ†æ</button>
      <button class="tab" data-tab="master" type="button">âš™ï¸ ç®¡ç†</button>
    </div>

    <!-- è£½é€ å…¥åŠ› -->
    <div id="manufacturing" class="tab-content active">
      <h2 style="margin-bottom:20px;color:#667eea;">è£½é€ éƒ¨é–€ - ç•°å¸¸å ±å‘Š</h2>
      <p style="margin-bottom:20px;color:#666;">ã„ã¤ãƒ»ã©ã“ã§ãƒ»ã©ã®æ•´ç†Noã§ãƒ»ä½•ãŒã‚ã£ãŸ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>

      <form id="manufacturingForm">
        <!-- ã„ã¤ -->
        <div style="background:#f0f7ff;padding:15px;border-radius:6px;margin-bottom:20px;">
          <h3 style="color:#667eea;margin-bottom:15px;font-size:1.1rem;">ğŸ“… ã„ã¤</h3>

          <div class="form-group">
            <label for="occurrenceDate">ç™ºç”Ÿæ—¥ *</label>
            <div style="display:flex;gap:10px;">
              <input type="date" id="occurrenceDate" required style="flex:1;">
              <button id="btnNowDate" class="btn btn-secondary" type="button" style="width:auto;padding:12px 20px;margin:0;background:#17a2b8;">ğŸ“… NOW</button>
            </div>
            <p style="font-size:.85rem;color:#666;margin-top:5px;">â€»å‹¤å‹™æ™‚é–“: 8:00ã€œç¿Œ6:00 (0:00ã€œ6:00ã®ç•°å¸¸ã¯å‰æ—¥æ‰±ã„)</p>
          </div>

          <div class="form-group">
            <label>æ™‚åˆ»</label>
            <div class="time-group">
              <div>
                <label style="font-weight:normal;font-size:.9rem;" for="occurrenceTime">ç™ºç”Ÿæ™‚åˆ»</label>
                <div style="display:flex;gap:5px;">
                  <input type="time" id="occurrenceTime" style="flex:1;">
                  <button class="btn btn-secondary" id="btnNowOccTime" type="button" style="width:auto;padding:8px 12px;margin:0;font-size:.85rem;background:#17a2b8;">NOW</button>
                </div>
              </div>
              <div>
                <label style="font-weight:normal;font-size:.9rem;" for="restartTime">å†é–‹æ™‚åˆ»</label>
                <div style="display:flex;gap:5px;">
                  <input type="time" id="restartTime" style="flex:1;">
                  <button class="btn btn-secondary" id="btnNowResTime" type="button" style="width:auto;padding:8px 12px;margin:0;font-size:.85rem;background:#17a2b8;">NOW</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ã©ã“ã§ -->
        <div style="background:#fff4e6;padding:15px;border-radius:6px;margin-bottom:20px;">
          <h3 style="color:#f57c00;margin-bottom:15px;font-size:1.1rem;">ğŸ“ ã©ã“ã§</h3>

          <div class="form-group">
            <label for="department">éƒ¨ç½² *</label>
            <select id="department" required></select>
          </div>

          <div class="form-group">
            <label for="lineName">ãƒ©ã‚¤ãƒ³å *</label>
            <select id="lineName" required>
              <option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>

          <div class="form-group">
            <label for="handler">å‡¦ç½®è€… *</label>
            <select id="handler" required>
              <option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
        </div>

        <!-- ã©ã®æ•´ç†Noã§ -->
        <div style="background:#f3e5f5;padding:15px;border-radius:6px;margin-bottom:20px;">
          <h3 style="color:#8e24aa;margin-bottom:15px;font-size:1.1rem;">ğŸ”¢ ã©ã®æ•´ç†Noã§</h3>
          <div class="form-group">
            <label for="serialNo">æ•´ç†No *</label>
            <input type="text" id="serialNo" required placeholder="ä¾‹: 2024-001">
            <p style="margin-top:5px;font-size:.85rem;color:#666;">â€»å…¥åŠ›ã™ã‚‹ã¨éå»ã®åŒä¸€å“ç•ªã‹ã‚‰å€™è£œãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
          </div>
          <!-- å€™è£œï¼ˆè£½é€ å´ã®ã¿ï¼‰ -->
          <div id="suggestionArea" style="display:none;margin-top:15px;padding:15px;background:#fff;border-radius:6px;border:2px solid #8e24aa;">
            <h4 style="color:#8e24aa;margin-bottom:10px;font-size:.95rem;">ğŸ’¡ éå»ã®é¡ä¼¼æ•´ç†Noã‹ã‚‰å€™è£œã‚’è¡¨ç¤º</h4>
            <div id="suggestionButtons"></div>
          </div>
        </div>

        <!-- ä½•ãŒã‚ã£ãŸ -->
        <div style="background:#e8f5e9;padding:15px;border-radius:6px;margin-bottom:20px;">
          <h3 style="color:#2e7d32;margin-bottom:15px;font-size:1.1rem;">ğŸ“ ä½•ãŒã‚ã£ãŸ</h3>
          <div class="form-group">
            <label for="anomalyContent">ç•°å¸¸å†…å®¹ *</label>
            <textarea id="anomalyContent" required placeholder="ç™ºç”Ÿã—ãŸç•°å¸¸ã®è©³ç´°ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„"></textarea>
          </div>
          <div class="form-group">
            <label for="actionTaken">è£½é€ å‡¦ç½®å†…å®¹ *</label>
            <textarea id="actionTaken" required placeholder="å®Ÿæ–½ã—ãŸå‡¦ç½®å†…å®¹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„"></textarea>
          </div>
          <div class="form-group">
            <label for="traceback">é¡ã‚Š *</label>
            <select id="traceback" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="æœ‰">æœ‰</option>
              <option value="ç„¡">ç„¡</option>
            </select>
          </div>
          <div class="form-group">
            <label for="techRequest">æŠ€è¡“è¦è«‹ *</label>
            <select id="techRequest" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="è¦è«‹">æŠ€è¡“è¦è«‹ã‚ã‚Šï¼ˆæŠ€è¡“éƒ¨é–€ã®å…¥åŠ›ãŒå¿…è¦ï¼‰</option>
              <option value="å®Œçµ">è£½é€ ã§å®Œçµï¼ˆæŠ€è¡“å…¥åŠ›ä¸è¦ï¼‰</option>
            </select>
            <p style="margin-top:5px;font-size:.85rem;color:#666;">â€»è£½é€ ã§å®Œçµã™ã‚‹å ´åˆã¯ã€Œè£½é€ ã§å®Œçµã€ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
          </div>
          <div class="form-group">
            <label>å†™çœŸ</label>
            <div class="photo-upload" id="mfgUpload">
              <div style="font-size:2rem;">ğŸ“¸</div>
              <p>å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</p>
              <input type="file" id="mfgPhotos" accept="image/*" multiple>
            </div>
            <div id="mfgPhotoPreview" class="photo-preview"></div>
          </div>
        </div>

        <button id="mfgSubmit" class="btn btn-primary" type="submit">ç™»éŒ²</button>
      </form>
    </div>

    <!-- æŠ€è¡“å…¥åŠ› -->
    <div id="technical" class="tab-content">
      <h2 style="margin-bottom:20px;color:#667eea;">æŠ€è¡“éƒ¨é–€ - è¿½åŠ å…¥åŠ›</h2>
      <div class="form-group">
        <label for="selectSerialNo">å¯¾è±¡ã®æ¡ˆä»¶é¸æŠ *</label>
        <select id="selectSerialNo">
          <option value="">æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
        <p style="margin-top:5px;font-size:.85rem;color:#666;">â€»[å“ç•ª] æ—¥ä»˜ - ç•°å¸¸å†…å®¹ ã®å½¢å¼ã§è¡¨ç¤ºã•ã‚Œã¾ã™</p>
      </div>

      <div id="selectedDataDisplay" style="background:#f8f9ff;padding:15px;border-radius:6px;margin-bottom:20px;display:none;">
        <h3 style="color:#667eea;margin-bottom:10px;">è£½é€ éƒ¨é–€å…¥åŠ›å†…å®¹</h3>
        <div id="displayContent"></div>
      </div>

      <!-- éå»ã®åŒä¸€æ•´ç†Noã®å¯¾å¿œå±¥æ­´ï¼ˆæœ€æ–°1ä»¶ï¼‹ä»–â—¯ä»¶ãƒˆã‚°ãƒ«ï¼‰ -->
      <div id="pastHistoryArea" style="display:none;margin-bottom:20px;padding:15px;background:#fff3e0;border-radius:6px;border:2px solid #ff9800;">
        <h3 style="color:#ff9800;margin-bottom:10px;font-size:1.1rem;">ğŸ“š éå»ã®åŒä¸€æ•´ç†Noã®å¯¾å¿œå±¥æ­´</h3>
        <div id="pastHistoryContent"></div>
      </div>

      <form id="technicalForm">
        <div class="form-group">
          <label for="techHandler">æŠ€è¡“å‡¦ç½®è€… *</label>
          <input type="text" id="techHandler" required placeholder="æŠ€è¡“å‡¦ç½®è€…åã‚’å…¥åŠ›">
        </div>
        <div class="form-group">
          <label for="lifespan">å‘½æ•°æœ‰ç„¡ *</label>
          <select id="lifespan" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="æœ‰">æœ‰</option>
            <option value="ç„¡">ç„¡</option>
          </select>
        </div>
        <div class="form-group">
          <label for="maintenanceUnit">ä¿å…¨å˜ä½ *</label>
          <input type="text" id="maintenanceUnit" required placeholder="ä¾‹: ãƒ¢ãƒ¼ã‚¿ãƒ¼ã€ãƒ™ã‚¢ãƒªãƒ³ã‚°">
        </div>
        <div class="form-group">
          <label for="rootCauseAction">ä½•ãŒæ‚ªãã©ã†ã—ãŸ *</label>
          <textarea id="rootCauseAction" required placeholder="åŸå› ã¨å¯¾ç­–ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„"></textarea>
        </div>
        <div class="form-group">
          <label for="recurrenceType">å†ç™ºã‹æ–°è¦ã‹ *</label>
          <select id="recurrenceType" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="å†ç™º">å†ç™º</option>
            <option value="æ–°è¦">æ–°è¦</option>
          </select>
        </div>
        <div class="form-group">
          <label>å†™çœŸ</label>
          <div class="photo-upload" id="techUpload">
            <div style="font-size:2rem;">ğŸ“¸</div>
            <p>å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</p>
            <input type="file" id="techPhotos" accept="image/*" multiple>
          </div>
          <div id="techPhotoPreview" class="photo-preview"></div>
        </div>

        <button id="techSubmit" class="btn btn-primary" type="submit">ç™»éŒ²</button>
      </form>
    </div>

    <!-- å±¥æ­´ -->
    <div id="history" class="tab-content">
      <h2 style="margin-bottom:20px;color:#667eea;">ç•°å¸¸å±¥æ­´</h2>
      <div class="history-controls">
        <div class="view-toggle" id="viewToggle">
          <button class="active" data-view="card" type="button">ã‚«ãƒ¼ãƒ‰</button>
          <button data-view="table" type="button">ãƒ†ãƒ¼ãƒ–ãƒ«</button>
        </div>
        <button class="btn btn-export" id="btnExport" type="button" style="flex:1;">ğŸ“¥ CSVå‡ºåŠ›</button>
        <button class="btn btn-import" id="btnImport" type="button" style="flex:1;">ğŸ“¤ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        <input type="file" id="csvImport" accept=".csv" style="display:none;">
      </div>
      <div id="cardView" class="card-view"></div>
      <div id="tableView" class="table-view"></div>
    </div>

    <!-- åˆ†æ -->
    <div id="analysis" class="tab-content">
      <h2 style="margin-bottom:20px;color:#ff9800;">ğŸ“Š ç•°å¸¸ãƒ‡ãƒ¼ã‚¿åˆ†æ</h2>

      <!-- æ¤œç´¢ -->
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#ff9800;margin-bottom:15px;">ğŸ” é¡ä¼¼ç•°å¸¸æ¤œç´¢</h3>

        <div style="background:#f8f9fa;padding:15px;border-radius:6px;margin-bottom:15px;">
          <h4 style="font-size:1rem;margin-bottom:10px;color:#666;">çµã‚Šè¾¼ã¿æ¡ä»¶</h4>
          <div class="form-group" style="margin-bottom:15px;">
            <label for="searchDepartment">éƒ¨ç½²</label>
            <select id="searchDepartment"></select>
          </div>
          <div class="form-group" style="margin-bottom:15px;">
            <label for="searchLine">ãƒ©ã‚¤ãƒ³å</label>
            <select id="searchLine"><option value="">ã™ã¹ã¦</option></select>
          </div>
          <div class="form-group" style="margin-bottom:0;">
            <label for="searchSerialNo">æ•´ç†No</label>
            <input type="text" id="searchSerialNo" placeholder="æ•´ç†Noã§çµã‚Šè¾¼ã¿ï¼ˆä¾‹: 2024-001ï¼‰">
          </div>
        </div>

        <div class="form-group">
          <label for="searchKeyword">æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="text" id="searchKeyword" placeholder="ç•°å¸¸å†…å®¹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆä¾‹: ãƒ¢ãƒ¼ã‚¿ãƒ¼ã€åœæ­¢ã€ç•°éŸ³ï¼‰">
        </div>

        <div style="display:flex;gap:10px;">
          <button id="btnSearch" class="btn btn-primary" type="button" style="background:#ff9800;flex:1;">æ¤œç´¢</button>
          <button id="btnClearSearch" class="btn btn-secondary" type="button" style="flex:1;">ã‚¯ãƒªã‚¢</button>
        </div>

        <div id="similarResults" style="margin-top:20px;"></div>
      </div>

      <!-- çµ±è¨ˆ -->
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#ff9800;margin-bottom:15px;">ğŸ“ˆ çµ±è¨ˆæƒ…å ±</h3>
        <div id="statisticsDisplay" style="display:grid;gap:15px;"></div>
      </div>

      <!-- å‚¾å‘ -->
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#ff9800;margin-bottom:15px;">ğŸ“Š æœˆåˆ¥å‚¾å‘åˆ†æ</h3>
        <div id="trendChart" style="min-height:300px;"></div>
        <div id="trendAnalysis" style="margin-top:15px;"></div>
      </div>

      <!-- éƒ¨ç½²ãƒ»ãƒ©ã‚¤ãƒ³ -->
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#ff9800;margin-bottom:15px;">ğŸ¢ éƒ¨ç½²ãƒ»ãƒ©ã‚¤ãƒ³åˆ¥åˆ†æ</h3>
        <div id="departmentAnalysis" style="display:grid;gap:15px;"></div>
      </div>

      <!-- å†ç™º -->
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);">
        <h3 style="color:#ff9800;margin-bottom:15px;">ğŸ”„ å†ç™ºãƒ»æ–°è¦åˆ†æ</h3>
        <div id="recurrenceAnalysis"></div>
      </div>
    </div>

    <!-- ãƒã‚¹ã‚¿ç®¡ç† -->
    <div id="master" class="tab-content">
      <h2 style="margin-bottom:20px;color:#667eea;">âš™ï¸ ãƒã‚¹ã‚¿ç®¡ç†</h2>

      <!-- éƒ¨ç½² -->
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#667eea;margin-bottom:15px;">éƒ¨ç½²ç®¡ç†</h3>
        <div style="display:flex;gap:10px;margin-bottom:15px;">
          <input type="text" id="newDepartment" placeholder="æ–°ã—ã„éƒ¨ç½²åã‚’å…¥åŠ›" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button id="btnAddDept" class="btn btn-primary" type="button" style="width:auto;padding:10px 20px;margin:0;">è¿½åŠ </button>
        </div>
        <div id="departmentList" style="display:grid;gap:10px;"></div>
      </div>

      <!-- ãƒ©ã‚¤ãƒ³ -->
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#f57c00;margin-bottom:15px;">ãƒ©ã‚¤ãƒ³åç®¡ç†</h3>
        <div class="form-group">
          <label for="lineManageDept">å¯¾è±¡éƒ¨ç½²</label>
          <select id="lineManageDept"><option value="">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</option></select>
        </div>
        <div style="display:flex;gap:10px;margin-bottom:15px;">
          <input type="text" id="newLine" placeholder="æ–°ã—ã„ãƒ©ã‚¤ãƒ³åã‚’å…¥åŠ›" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button id="btnAddLine" class="btn btn-primary" type="button" style="width:auto;padding:10px 20px;margin:0;background:#f57c00;">è¿½åŠ </button>
        </div>
        <div id="lineList" style="display:grid;gap:10px;"></div>
      </div>

      <!-- å‡¦ç½®è€… -->
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);">
        <h3 style="color:#2e7d32;margin-bottom:15px;">å‡¦ç½®è€…ç®¡ç†</h3>
        <div class="form-group">
          <label for="handlerManageDept">å¯¾è±¡éƒ¨ç½²</label>
          <select id="handlerManageDept"><option value="">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</option></select>
        </div>
        <div style="display:flex;gap:10px;margin-bottom:15px;">
          <input type="text" id="newHandler" placeholder="æ–°ã—ã„å‡¦ç½®è€…åã‚’å…¥åŠ›" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button id="btnAddHandler" class="btn btn-primary" type="button" style="width:auto;padding:10px 20px;margin:0;background:#2e7d32;">è¿½åŠ </button>
        </div>
        <div id="handlerList" style="display:grid;gap:10px;"></div>
      </div>
    </div>
  </div>

<script>
  // ===== ãƒ‡ãƒ¼ã‚¿é ˜åŸŸ =====
  let anomalyData = [];
  let mfgPhotos = [];
  let techPhotos = [];
  let currentView = 'card';

  let masterData = {
    departments: [],
    lines: {},
    handlers: {}
  };

  // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  const $ = sel => document.querySelector(sel);
  const $$ = sel => document.querySelectorAll(sel);

  function saveData(){ localStorage.setItem('anomalyData', JSON.stringify(anomalyData)); }
  function saveMasterData(){ localStorage.setItem('masterData', JSON.stringify(masterData)); }

  function loadData(){
    try{
      const saved = localStorage.getItem('anomalyData');
      if (saved) anomalyData = JSON.parse(saved);
    }catch(e){ console.warn('anomalyData load error', e); }

    try{
      const savedMaster = localStorage.getItem('masterData');
      if (savedMaster) {
        masterData = JSON.parse(savedMaster);
      } else {
        masterData = {
          departments:['è£½é€ 1èª²','è£½é€ 2èª²','çµ„ç«‹èª²'],
          lines:{
            'è£½é€ 1èª²':['ãƒ©ã‚¤ãƒ³1','ãƒ©ã‚¤ãƒ³2'],
            'è£½é€ 2èª²':['ãƒ©ã‚¤ãƒ³A','ãƒ©ã‚¤ãƒ³B'],
            'çµ„ç«‹èª²':['çµ„ç«‹1','çµ„ç«‹2']
          },
          handlers:{
            'è£½é€ 1èª²':['å±±ç”°å¤ªéƒ','ä½è—¤èŠ±å­'],
            'è£½é€ 2èª²':['éˆ´æœ¨ä¸€éƒ','ç”°ä¸­ç¾å’²'],
            'çµ„ç«‹èª²':['é«˜æ©‹å¥å¤ª','ä¼Šè—¤æ„›']
          }
        };
        saveMasterData();
      }
    }catch(e){ console.warn('masterData load error', e); }

    updateHistory();
    updateSerialNoSelect();
    updateAllDepartmentSelects();
  }

  // ===== ã‚¿ãƒ– =====
  function switchTab(tabName, btn){
    $$('.tab').forEach(t=>t.classList.remove('active'));
    $$('.tab-content').forEach(c=>c.classList.remove('active'));
    if (btn) btn.classList.add('active');
    const pane = document.getElementById(tabName);
    if (pane) pane.classList.add('active');

    if (tabName==='history') updateHistory();
    if (tabName==='technical') updateSerialNoSelect();
    if (tabName==='analysis') updateAnalysis();
  }

  // ===== NOWç³» =====
  function setNowDate(){
    const now = new Date();
    const hour = now.getHours();
    if (hour>=0 && hour<6) now.setDate(now.getDate()-1);
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,'0');
    const d = String(now.getDate()).padStart(2,'0');
    $('#occurrenceDate').value = `${y}-${m}-${d}`;
  }
  function setNowTime(id){
    const now = new Date();
    const hh = String(now.getHours()).padStart(2,'0');
    const mm = String(now.getMinutes()).padStart(2,'0');
    const el = document.getElementById(id);
    if (el) el.value = `${hh}:${mm}`;
  }

  // ===== ãƒã‚¹ã‚¿é¸æŠè‚¢ =====
  function updateAllDepartmentSelects(){
    updateDepartmentSelect('department');
    updateDepartmentSelect('lineManageDept');
    updateDepartmentSelect('handlerManageDept');
    updateDepartmentList();
  }
  function updateDepartmentSelect(selectId){
    const sel = document.getElementById(selectId);
    if (!sel) return;
    const cur = sel.value;
    sel.innerHTML = (selectId==='department') ? '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' :
                      '<option value="">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    masterData.departments.forEach(d=>{
      const op = document.createElement('option');
      op.value = d; op.textContent = d;
      sel.appendChild(op);
    });
    if (cur && masterData.departments.includes(cur)) sel.value = cur;
  }
  function updateLineOptions(){
    const dept = $('#department').value;
    const lineSel = $('#lineName');
    const handlerSel = $('#handler');
    lineSel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    handlerSel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    (masterData.lines[dept]||[]).forEach(line=>{
      const op = document.createElement('option'); op.value=line; op.textContent=line; lineSel.appendChild(op);
    });
    (masterData.handlers[dept]||[]).forEach(h=>{
      const op = document.createElement('option'); op.value=h; op.textContent=h; handlerSel.appendChild(op);
    });
  }

  // ===== éƒ¨ç½²ç®¡ç† =====
  function addDepartment(){
    const input = $('#newDepartment');
    const name = (input.value||'').trim();
    if (!name) return alert('éƒ¨ç½²åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    if (masterData.departments.includes(name)) return alert('ã“ã®éƒ¨ç½²ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
    masterData.departments.push(name);
    masterData.lines[name]=[]; masterData.handlers[name]=[];
    saveMasterData(); updateAllDepartmentSelects(); input.value='';
  }
  function deleteDepartment(dept){
    if (!confirm(`ã€Œ${dept}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\né–¢é€£ã™ã‚‹ãƒ©ã‚¤ãƒ³åã¨å‡¦ç½®è€…ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) return;
    masterData.departments = masterData.departments.filter(d=>d!==dept);
    delete masterData.lines[dept]; delete masterData.handlers[dept];
    saveMasterData(); updateAllDepartmentSelects();
  }
  function updateDepartmentList(){
    const list = $('#departmentList'); list.innerHTML='';
    if (masterData.departments.length===0){
      list.innerHTML='<p style="color:#999;text-align:center;">éƒ¨ç½²ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; return;
    }
    masterData.departments.forEach(dept=>{
      const div=document.createElement('div'); div.className='master-item';
      div.innerHTML = `
        <span class="master-item-name">${dept}</span>
        <button class="btn-delete" type="button" data-del-dept="${dept}">å‰Šé™¤</button>`;
      list.appendChild(div);
    });
  }

  // ===== ãƒ©ã‚¤ãƒ³ç®¡ç† =====
  function addLine(){
    const dept = $('#lineManageDept').value;
    const input = $('#newLine');
    const name = (input.value||'').trim();
    if (!dept) return alert('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„');
    if (!name) return alert('ãƒ©ã‚¤ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    masterData.lines[dept] = masterData.lines[dept]||[];
    if (masterData.lines[dept].includes(name)) return alert('ã“ã®ãƒ©ã‚¤ãƒ³åã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
    masterData.lines[dept].push(name);
    saveMasterData(); updateLineManageList(); input.value='';
  }
  function deleteLine(dept, line){
    if (!confirm(`ã€Œ${line}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
    masterData.lines[dept] = (masterData.lines[dept]||[]).filter(l=>l!==line);
    saveMasterData(); updateLineManageList();
  }
  function updateLineManageList(){
    const dept = $('#lineManageDept').value;
    const list = $('#lineList'); list.innerHTML='';
    if (!dept){ list.innerHTML='<p style="color:#999;text-align:center;">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</p>'; return; }
    const arr = masterData.lines[dept]||[];
    if (arr.length===0){ list.innerHTML='<p style="color:#999;text-align:center;">ãƒ©ã‚¤ãƒ³åãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; return; }
    arr.forEach(line=>{
      const div=document.createElement('div'); div.className='master-item';
      div.innerHTML = `
        <span class="master-item-name">${line}</span>
        <button class="btn-delete" type="button" data-del-line="${line}" data-dept="${dept}">å‰Šé™¤</button>`;
      list.appendChild(div);
    });
  }

  // ===== å‡¦ç½®è€…ç®¡ç† =====
  function addHandler(){
    const dept = $('#handlerManageDept').value;
    const input = $('#newHandler');
    const name = (input.value||'').trim();
    if (!dept) return alert('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„');
    if (!name) return alert('å‡¦ç½®è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    masterData.handlers[dept] = masterData.handlers[dept]||[];
    if (masterData.handlers[dept].includes(name)) return alert('ã“ã®å‡¦ç½®è€…ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
    masterData.handlers[dept].push(name);
    saveMasterData(); updateHandlerManageList(); input.value='';
  }
  function deleteHandler(dept, name){
    if (!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
    masterData.handlers[dept] = (masterData.handlers[dept]||[]).filter(h=>h!==name);
    saveMasterData(); updateHandlerManageList();
  }
  function updateHandlerManageList(){
    const dept = $('#handlerManageDept').value;
    const list = $('#handlerList'); list.innerHTML='';
    if (!dept){ list.innerHTML='<p style="color:#999;text-align:center;">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</p>'; return; }
    const arr = masterData.handlers[dept]||[];
    if (arr.length===0){ list.innerHTML='<p style="color:#999;text-align:center;">å‡¦ç½®è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; return; }
    arr.forEach(h=>{
      const div=document.createElement('div'); div.className='master-item';
      div.innerHTML = `
        <span class="master-item-name">${h}</span>
        <button class="btn-delete" type="button" data-del-handler="${h}" data-dept="${dept}">å‰Šé™¤</button>`;
      list.appendChild(div);
    });
  }

  // ===== å€™è£œè¡¨ç¤ºï¼ˆè£½é€ ã®ã¿ï¼‰ =====
  function escapeHtml(text){ return String(text).replace(/'/g,"\\'").replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function truncateText(t, n){ return t.length<=n ? t : t.substring(0,n)+'...'; }
  function extractTopCandidates(dataArray, field, maxCount){
    const freq={};
    dataArray.forEach(it=>{
      const t = it[field];
      if (t && t.trim()) freq[t] = (freq[t]||0)+1;
    });
    return Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,maxCount).map(e=>e[0]);
  }
  function applySuggestion(fieldId, text){
    const el = document.getElementById(fieldId);
    if (!el) return;
    el.value = text;
    if (el.tagName==='TEXTAREA'){ el.style.height='auto'; el.style.height=el.scrollHeight+'px'; }
    el.style.background = '#e1bee7';
    setTimeout(()=>{ el.style.background=''; }, 500);
  }
  function searchSimilarSerialNo(){
    const inputSerialNo = ($('#serialNo').value||'').trim();
    const area = $('#suggestionArea'); const box = $('#suggestionButtons');
    if (!inputSerialNo){ area.style.display='none'; return; }
    const similar = anomalyData.filter(it=>it.serialNo===inputSerialNo).slice(0,10);
    if (similar.length===0){ area.style.display='none'; return; }
    const anomalies = extractTopCandidates(similar,'anomalyContent',4);
    const actions = extractTopCandidates(similar,'actionTaken',4);
    let html='';
    if (anomalies.length>0){
      html += `
        <div class="suggestion-category">
          <div class="suggestion-category-title">ğŸ“ ç•°å¸¸å†…å®¹ã®å€™è£œï¼ˆå“ç•ª: ${inputSerialNo}ï¼‰</div>
          <div>${anomalies.map(t=>`<button class="suggestion-btn" type="button" data-apply="anomalyContent" data-text="${escapeHtml(t)}">${truncateText(t,30)}</button>`).join('')}</div>
        </div>`;
    }
    if (actions.length>0){
      html += `
        <div class="suggestion-category">
          <div class="suggestion-category-title">ğŸ”§ è£½é€ å‡¦ç½®å†…å®¹ã®å€™è£œï¼ˆå“ç•ª: ${inputSerialNo}ï¼‰</div>
          <div>${actions.map(t=>`<button class="suggestion-btn" type="button" data-apply="actionTaken" data-text="${escapeHtml(t)}">${truncateText(t,30)}</button>`).join('')}</div>
        </div>`;
    }
    if (html){ box.innerHTML=html; area.style.display='block'; } else { area.style.display='none'; }
  }

  // ===== ç”»åƒ =====
  function handlePhotoUpload(inputId, previewId, arr){
    const input = document.getElementById(inputId);
    input.addEventListener('change', e=>{
      const files = Array.from(e.target.files);
      files.forEach(f=>{
        const reader = new FileReader();
        reader.onload = ev => { arr.push(ev.target.result); displayPhotos(previewId, arr); }
        reader.readAsDataURL(f);
      });
      input.value = '';
    });
  }
  function displayPhotos(previewId, arr){
    const preview = document.getElementById(previewId);
    preview.innerHTML='';
    arr.forEach((photo, idx)=>{
      const div = document.createElement('div');
      div.className='photo-item';
      div.innerHTML = `
        <img src="${photo}" alt="Photo ${idx+1}">
        <button class="remove-btn" type="button" data-remove-photo="${previewId}" data-index="${idx}">Ã—</button>`;
      preview.appendChild(div);
    });
  }

  // ===== å±¥æ­´æç”» =====
  function updateHistory(){
    if (currentView==='card') updateCardView(); else updateTableView();
  }
  function cardStatus(item){
    if (item.status==='pending') return {text:'æŠ€è¡“å…¥åŠ›å¾…ã¡', cls:'status-pending'};
    if (item.status==='complete' && item.techRequest==='å®Œçµ') return {text:'å®Œäº†ï¼ˆè£½é€ å®Œçµï¼‰', cls:'status-complete'};
    return {text:'å®Œäº†', cls:'status-complete'};
  }
  function updateCardView(){
    const wrap = $('#cardView');
    if (anomalyData.length===0){
      wrap.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;
      return;
    }
    wrap.innerHTML = anomalyData.map(item=>{
      const st = cardStatus(item);
      return `
      <div class="anomaly-card ${item.status==='complete'?'complete':''}">
        <div class="card-header">
          <div class="card-id">${item.serialNo}</div>
          <div class="card-status ${st.cls}">${st.text}</div>
        </div>
        <div class="card-body">
          ${item.department?`<div class="card-field"><div class="field-label">éƒ¨ç½²</div><div class="field-value">${item.department}</div></div>`:''}
          ${item.lineName?`<div class="card-field"><div class="field-label">ãƒ©ã‚¤ãƒ³å</div><div class="field-value">${item.lineName}</div></div>`:''}
          ${item.techRequest?`<div class="card-field"><div class="field-label">æŠ€è¡“è¦è«‹</div><div class="field-value">${item.techRequest==='è¦è«‹'?'æŠ€è¡“è¦è«‹ã‚ã‚Š':'è£½é€ ã§å®Œçµ'}</div></div>`:''}
          <div class="card-field"><div class="field-label">ç•°å¸¸å†…å®¹</div><div class="field-value">${item.anomalyContent}</div></div>
          <div class="card-field"><div class="field-label">è£½é€ å‡¦ç½®</div><div class="field-value">${item.actionTaken}</div></div>
          <div class="card-field"><div class="field-label">ç™ºç”Ÿæ—¥æ™‚</div><div class="field-value">${item.occurrenceDate} ${item.occurrenceTime||''}</div></div>
          <div class="card-field"><div class="field-label">å‡¦ç½®è€…</div><div class="field-value">${item.handler}</div></div>
          ${item.status==='complete' && item.techRequest==='è¦è«‹' ? `
            <div class="card-field"><div class="field-label">æŠ€è¡“å‡¦ç½®è€…</div><div class="field-value">${item.techHandler||'-'}</div></div>
            <div class="card-field"><div class="field-label">åŸå› ãƒ»å¯¾ç­–</div><div class="field-value">${item.rootCauseAction||'-'}</div></div>
            <div class="card-field"><div class="field-label">å†ç™º/æ–°è¦</div><div class="field-value">${item.recurrenceType||'-'}</div></div>` : ''
          }
          <div class="action-btns" style="margin-top:10px;">
            <button class="btn-small btn-delete" type="button" data-id="${item.id}">å‰Šé™¤</button>
          </div>
        </div>
      </div>`;
    }).join('');
  }
  function updateTableView(){
    const wrap = $('#tableView');
    if (anomalyData.length===0){
      wrap.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;
      return;
    }
    wrap.innerHTML = `
      <table>
        <thead><tr>
          <th>æ•´ç†No</th><th>éƒ¨ç½²</th><th>ãƒ©ã‚¤ãƒ³</th><th>ç•°å¸¸å†…å®¹</th>
          <th>ç™ºç”Ÿæ—¥</th><th>å‡¦ç½®è€…</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th>
        </tr></thead>
        <tbody>
          ${anomalyData.map(item=>{
            const st = item.status==='complete' ? 'å®Œäº†' : 'å¾…ã¡';
            const cls = item.status==='complete' ? 'status-complete' : 'status-pending';
            return `
            <tr>
              <td>${item.serialNo}</td>
              <td>${item.department||'-'}</td>
              <td>${item.lineName||'-'}</td>
              <td>${item.anomalyContent.substring(0,30)}...</td>
              <td>${item.occurrenceDate}</td>
              <td>${item.handler}</td>
              <td><span class="card-status ${cls}">${st}</span></td>
              <td><button class="btn-small btn-delete" type="button" data-id="${item.id}">å‰Šé™¤</button></td>
            </tr>`}).join('')}
        </tbody>
      </table>`;
  }
  function deleteRecord(id){
    if (!confirm('ã“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    anomalyData = anomalyData.filter(it=>it.id!==id);
    saveData(); updateHistory(); updateSerialNoSelect();
  }

  // ===== æŠ€è¡“å…¥åŠ›è£œåŠ© =====
  function updateSerialNoSelect(){
    const sel = $('#selectSerialNo'); sel.innerHTML = '<option value="">æ•´ç†Noã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    anomalyData
      .filter(it=>it.status==='pending' && it.techRequest==='è¦è«‹')
      .sort((a,b)=> new Date(b.occurrenceDate)-new Date(a.occurrenceDate))
      .forEach(it=>{
        const op=document.createElement('option');
        op.value = it.id;
        op.textContent = `[${it.serialNo}] ${it.occurrenceDate} - ${it.anomalyContent.substring(0,30)}...`;
        sel.appendChild(op);
      });
  }
  function loadManufacturingData(){
    const id = $('#selectSerialNo').value;
    const display = $('#displayContent');
    const box = $('#selectedDataDisplay');
    const area = $('#pastHistoryArea');
    if (!id){ box.style.display='none'; area.style.display='none'; display.innerHTML=''; return; }
    const data = anomalyData.find(it=> String(it.id)===String(id));
    if (!data){ box.style.display='none'; area.style.display='none'; display.innerHTML=''; return; }

    display.innerHTML = `
      <div style="display:grid;gap:10px;">
        <div><strong>æ•´ç†Noï¼ˆå“ç•ªï¼‰:</strong> ${data.serialNo}</div>
        ${data.department?`<div><strong>éƒ¨ç½²:</strong> ${data.department}</div>`:''}
        ${data.lineName?`<div><strong>ãƒ©ã‚¤ãƒ³å:</strong> ${data.lineName}</div>`:''}
        <div><strong>ç•°å¸¸å†…å®¹:</strong> ${data.anomalyContent}</div>
        <div><strong>è£½é€ å‡¦ç½®:</strong> ${data.actionTaken}</div>
        <div><strong>ç™ºç”Ÿæ—¥:</strong> ${data.occurrenceDate}</div>
        <div><strong>å‡¦ç½®è€…:</strong> ${data.handler}</div>
      </div>`;
    box.style.display='block';

    // éå»åŒä¸€æ•´ç†Noï¼šæœ€æ–°1ä»¶ï¼‹ä»–â—¯ä»¶ãƒˆã‚°ãƒ«ï¼ˆä¿å…¨å˜ä½ã¯è¡¨ç¤ºã—ãªã„ï¼‰
    showPastHistoryLatestOnly(data.serialNo, data.id, data.anomalyContent);
  }
  function showPastHistoryLatestOnly(serialNo, currentId, currentAnomaly){
    const area = $('#pastHistoryArea');
    const content = $('#pastHistoryContent');
    const keywords = String(currentAnomaly||'').toLowerCase()
      .replace(/[ã€ã€‚ï¼Œï¼,.\s]+/g,' ').split(' ').filter(w=>w.length>=2);

    let past = anomalyData.filter(it=>{
      if (it.serialNo!==serialNo) return false;
      if (String(it.id)===String(currentId)) return false;
      if (it.status!=='complete') return false;
      if (it.techRequest!=='è¦è«‹') return false;
      if (!it.rootCauseAction || !it.anomalyContent) return false;
      const txt = it.anomalyContent.toLowerCase();
      return keywords.length===0 || keywords.some(k=>txt.includes(k));
    }).sort((a,b)=> new Date(b.occurrenceDate)-new Date(a.occurrenceDate));

    if (past.length===0){ area.style.display='none'; return; }

    const latest = past[0];
    const restCount = past.length-1;

    let html = `
      <div style="margin-bottom:10px;padding:10px;background:#fff;border-radius:4px;border-left:3px solid #4caf50;">
        <strong style="color:#2e7d32;">âœ… ã“ã®å“ç•ªï¼ˆ${serialNo}ï¼‰ã§é¡ä¼¼ã®ç•°å¸¸ãŒéå»ã«${past.length}ä»¶ã‚ã‚Šã¾ã™</strong>
        <div style="font-size:.85rem;color:#666;margin-top:5px;">ç¾åœ¨ã®ç•°å¸¸: ${currentAnomaly}</div>
      </div>

      <div class="past-history-item">
        <div class="past-history-date">ğŸ“… ${latest.occurrenceDate} ${latest.occurrenceTime?`(${latest.occurrenceTime})`:''}
          <span style="background:#4caf50;color:#fff;padding:2px 8px;border-radius:10px;margin-left:10px;font-size:.8rem;">æœ€æ–°</span>
        </div>
        <div class="past-history-field"><strong>ğŸ“ ç•°å¸¸å†…å®¹</strong><div>${latest.anomalyContent}</div></div>
        <div class="past-history-field"><strong>ğŸ”§ è£½é€ å‡¦ç½®å†…å®¹</strong><div>${latest.actionTaken}</div></div>
        <div class="past-history-field"><strong>ğŸ’¡ æŠ€è¡“å‡¦ç½®å†…å®¹ï¼ˆä½•ãŒæ‚ªãã©ã†ã—ãŸï¼‰</strong>
          <div>${latest.rootCauseAction}</div>
          <button class="copy-btn" type="button" data-apply="rootCauseAction" data-text="${escapeHtml(latest.rootCauseAction)}">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
        </div>
        <div style="margin-top:10px;font-size:.85rem;color:#666;">
          ${latest.techHandler ? `æŠ€è¡“å‡¦ç½®è€…: ${latest.techHandler} | ` : ''}${latest.recurrenceType ? `åŒºåˆ†: ${latest.recurrenceType}`:''}
        </div>
      </div>
    `;

    if (restCount>0){
      html += `
        <div style="text-align:right;">
          <button class="btn" type="button" id="btnToggleMore" data-open="0" style="width:auto;background:#fff;color:#ff9800;border:2px solid #ff9800;border-radius:20px;padding:6px 12px;font-weight:bold;">ä»–${restCount}ä»¶ã‚’è¡¨ç¤º</button>
        </div>
        <div id="moreHistory" style="display:none;margin-top:10px;">
          ${past.slice(1).map(it=>`
          <div class="past-history-item">
            <div class="past-history-date">ğŸ“… ${it.occurrenceDate} ${it.occurrenceTime?`(${it.occurrenceTime})`:''}</div>
            <div class="past-history-field"><strong>ğŸ“ ç•°å¸¸å†…å®¹</strong><div>${it.anomalyContent}</div></div>
            <div class="past-history-field"><strong>ğŸ”§ è£½é€ å‡¦ç½®å†…å®¹</strong><div>${it.actionTaken}</div></div>
            <div class="past-history-field"><strong>ğŸ’¡ æŠ€è¡“å‡¦ç½®å†…å®¹ï¼ˆä½•ãŒæ‚ªãã©ã†ã—ãŸï¼‰</strong>
              <div>${it.rootCauseAction}</div>
              <button class="copy-btn" type="button" data-apply="rootCauseAction" data-text="${escapeHtml(it.rootCauseAction)}">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
            </div>
            <div style="margin-top:10px;font-size:.85rem;color:#666;">
              ${it.techHandler ? `æŠ€è¡“å‡¦ç½®è€…: ${it.techHandler} | ` : ''}${it.recurrenceType ? `åŒºåˆ†: ${it.recurrenceType}`:''}
            </div>
          </div>`).join('')}
        </div>`;
    }

    content.innerHTML = html;
    area.style.display='block';
  }

  // ===== ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ =====
  function requireFilled(ids){
    const miss = ids.filter(id=>{
      const el = document.getElementById(id);
      return !el || !el.value || (el.tagName==='SELECT' && el.value==='');
    });
    if (miss.length){
      const names = miss.map(id=>{
        const label = document.querySelector(`label[for="${id}"]`)?.textContent
          || document.querySelector(`#${id}`)?.closest('.form-group')?.querySelector('label')?.textContent
          || id;
        return `ãƒ»${label.replace(/\s*\*?\s*$/,'')}`;
      }).join('\n');
      alert(`æœªå…¥åŠ›ã®é …ç›®ãŒã‚ã‚Šã¾ã™ã€‚\n\n${names}`);
      return false;
    }
    return true;
  }

  // ===== CSV =====
  function exportCSV(){
    if (anomalyData.length===0) return alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
    const headers = ['æ•´ç†No','éƒ¨ç½²','ãƒ©ã‚¤ãƒ³å','ç™ºç”Ÿæ—¥','ç™ºç”Ÿæ™‚åˆ»','å†é–‹æ™‚åˆ»','ç•°å¸¸å†…å®¹','è£½é€ å‡¦ç½®å†…å®¹','é¡ã‚Š','å‡¦ç½®è€…','æŠ€è¡“è¦è«‹','æŠ€è¡“å‡¦ç½®è€…','å‘½æ•°æœ‰ç„¡','ä¿å…¨å˜ä½','åŸå› å¯¾ç­–','å†ç™ºæ–°è¦','çŠ¶æ…‹'];
    const rows = anomalyData.map(it=>[
      it.serialNo,it.department||'',it.lineName||'',it.occurrenceDate,it.occurrenceTime||'',it.restartTime||'',
      it.anomalyContent,it.actionTaken,it.traceback,it.handler,
      it.techRequest==='è¦è«‹'?'æŠ€è¡“è¦è«‹ã‚ã‚Š':it.techRequest==='å®Œçµ'?'è£½é€ ã§å®Œçµ':'',
      it.techHandler||'',it.lifespan||'',it.maintenanceUnit||'',it.rootCauseAction||'',it.recurrenceType||'',
      it.status==='complete'?'å®Œäº†':'æŠ€è¡“å…¥åŠ›å¾…ã¡'
    ]);
    let csv = '\uFEFF'+headers.join(',')+'\n';
    rows.forEach(r=>{ csv += r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')+'\n'; });
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `ç•°å¸¸å±¥æ­´_${new Date().toISOString().split('T')[0]}.csv`; a.click();
  }
  function importCSV(file){
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e=>{
      try{
        const text = e.target.result;
        const lines = text.split('\n').filter(l=>l.trim());
        if (lines.length<2) return alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™');
        const dataLines = lines.slice(1);
        let count=0;
        dataLines.forEach((line, idx)=>{
          const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
          if (!values) return;
          const vals = values.map(v=>v.replace(/^"|"$/g,'').replace(/""/g,'"'));
          if (vals.length>=10){
            let techReq = '';
            if (vals[10]==='æŠ€è¡“è¦è«‹ã‚ã‚Š') techReq='è¦è«‹';
            else if (vals[10]==='è£½é€ ã§å®Œçµ') techReq='å®Œçµ';
            const data = {
              id: Date.now()+idx,
              serialNo: vals[0],
              department: vals[1]||'',
              lineName: vals[2]||'',
              occurrenceDate: vals[3],
              occurrenceTime: vals[4]||'',
              restartTime: vals[5]||'',
              anomalyContent: vals[6],
              actionTaken: vals[7],
              traceback: vals[8],
              handler: vals[9],
              techRequest: techReq,
              techHandler: vals[11]||'',
              lifespan: vals[12]||'',
              maintenanceUnit: vals[13]||'',
              rootCauseAction: vals[14]||'',
              recurrenceType: vals[15]||'',
              status: vals[16]==='å®Œäº†' ? 'complete' : 'pending',
              mfgPhotos:[], techPhotos:[],
              createdAt: new Date().toISOString()
            };
            anomalyData.push(data); count++;
          }
        });
        saveData(); updateHistory(); updateSerialNoSelect();
        alert(`${count}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
      }catch(err){
        console.error(err); alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    };
    reader.readAsText(file,'UTF-8');
  }

  // ===== åˆ†æ =====
  function updateAnalysis(){
    updateStatistics(); updateTrendAnalysis(); updateDepartmentAnalysis(); updateRecurrenceAnalysis(); updateSearchDepartmentSelect();
  }
  function updateStatistics(){
    const total = anomalyData.length;
    const completed = anomalyData.filter(it=>it.status==='complete').length;
    const pending = total-completed;
    const now = new Date();
    const thisMonth = anomalyData.filter(it=>{
      const d = new Date(it.occurrenceDate);
      return d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear();
    }).length;
    let avg=0, cnt=0;
    anomalyData.forEach(it=>{
      if (it.occurrenceTime && it.restartTime){
        const [oh,om]=it.occurrenceTime.split(':').map(Number);
        const [rh,rm]=it.restartTime.split(':').map(Number);
        let minutes = (rh*60+rm)-(oh*60+om);
        if (minutes<0) minutes += 24*60;
        avg += minutes; cnt++;
      }
    });
    avg = cnt>0 ? Math.round(avg/cnt) : 0;
    const div = $('#statisticsDisplay');
    div.innerHTML = `
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
        <div class="stat-card"><h4>ç·ç•°å¸¸ä»¶æ•°</h4><div class="stat-value">${total}</div><div class="stat-label">ä»¶</div></div>
        <div class="stat-card" style="background:linear-gradient(135deg,#2e7d32 0%,#66bb6a 100%);"><h4>å¯¾å¿œå®Œäº†</h4><div class="stat-value">${completed}</div><div class="stat-label">ä»¶ (${total>0?Math.round(completed/total*100):0}%)</div></div>
        <div class="stat-card" style="background:linear-gradient(135deg,#f57c00 0%,#ffb74d 100%);"><h4>å¯¾å¿œå¾…ã¡</h4><div class="stat-value">${pending}</div><div class="stat-label">ä»¶</div></div>
        <div class="stat-card" style="background:linear-gradient(135deg,#c62828 0%,#ef5350 100%);"><h4>ä»Šæœˆã®ç•°å¸¸</h4><div class="stat-value">${thisMonth}</div><div class="stat-label">ä»¶</div></div>
        <div class="stat-card" style="background:linear-gradient(135deg,#1976d2 0%,#42a5f5 100%);"><h4>å¹³å‡å¯¾å¿œæ™‚é–“</h4><div class="stat-value">${avg}</div><div class="stat-label">åˆ†</div></div>
      </div>`;
  }
  function updateTrendAnalysis(){
    const monthly={};
    anomalyData.forEach(it=>{
      const d=new Date(it.occurrenceDate);
      const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      monthly[key]=(monthly[key]||0)+1;
    });
    const months = Object.keys(monthly).sort();
    const max = Math.max(...Object.values(monthly), 1);
    $('#trendChart').innerHTML = months.map(m=>{
      const c = monthly[m]; const p = (c/max)*100;
      return `
        <div style="margin-bottom:15px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
            <span style="font-weight:bold;">${m}</span><span style="color:#666;">${c}ä»¶</span>
          </div>
          <div style="background:#e0e0e0;height:30px;border-radius:4px;overflow:hidden;">
            <div class="chart-bar" style="width:${p}%;">${c}ä»¶</div>
          </div>
        </div>`;
    }).join('');
    const ana = $('#trendAnalysis');
    if (months.length>=3){
      const recent3 = months.slice(-3).map(m=>monthly[m]);
      const avgR = recent3.reduce((a,b)=>a+b,0)/3;
      const prev = months.slice(-6,-3).map(m=>monthly[m]);
      const avgP = prev.length>0 ? prev.reduce((a,b)=>a+b,0)/prev.length : avgR;
      let trend='æ¨ªã°ã„', cls='trend-stable';
      if (avgR>avgP*1.2){ trend='å¢—åŠ å‚¾å‘'; cls='trend-increase'; }
      else if (avgR<avgP*0.8){ trend='æ¸›å°‘å‚¾å‘'; cls='trend-decrease'; }
      ana.innerHTML = `
        <div class="analysis-insight">
          <strong>ğŸ“Š å‚¾å‘åˆ†æ:</strong> ç›´è¿‘3ãƒ¶æœˆã®å¹³å‡ã¯<strong>${avgR.toFixed(1)}ä»¶/æœˆ</strong>ã§ã€
          <span class="trend-badge ${cls}">${trend}</span>ã§ã™ã€‚
          ${trend==='å¢—åŠ å‚¾å‘'?'âš ï¸ ç•°å¸¸ç™ºç”ŸãŒå¢—ãˆã¦ã„ã¾ã™ã€‚åŸå› ç‰¹å®šã¨å¯¾ç­–ã‚’ã€‚':''}
          ${trend==='æ¸›å°‘å‚¾å‘'?'âœ… æ”¹å–„ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚ç¾è¡Œã®å–ã‚Šçµ„ã¿ç¶™ç¶šã‚’ã€‚':''}
        </div>`;
    } else {
      ana.innerHTML = '<p style="color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã‚‹ãŸã‚ã€å‚¾å‘åˆ†æã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“</p>';
    }
  }
  function updateDepartmentAnalysis(){
    const dAgg={}, lAgg={};
    anomalyData.forEach(it=>{
      if (it.department) dAgg[it.department]=(dAgg[it.department]||0)+1;
      if (it.lineName) lAgg[it.lineName]=(lAgg[it.lineName]||0)+1;
    });
    const maxD = Math.max(...Object.values(dAgg),1);
    const maxL = Math.max(...Object.values(lAgg),1);
    let html = '<h4 style="color:#666;margin-bottom:10px;">éƒ¨ç½²åˆ¥ç•°å¸¸ä»¶æ•°</h4>';
    Object.entries(dAgg).sort((a,b)=>b[1]-a[1]).forEach(([dept,c])=>{
      html += `
        <div style="margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
            <span>${dept}</span><span style="color:#666;">${c}ä»¶</span>
          </div>
          <div style="background:#e0e0e0;height:25px;border-radius:4px;overflow:hidden;">
            <div class="chart-bar" style="width:${(c/maxD)*100}%;height:25px;font-size:.85rem;">${c}ä»¶</div>
          </div>
        </div>`;
    });
    html += '<h4 style="color:#666;margin:20px 0 10px;">ãƒ©ã‚¤ãƒ³åˆ¥ç•°å¸¸ä»¶æ•°</h4>';
    Object.entries(lAgg).sort((a,b)=>b[1]-a[1]).forEach(([line,c])=>{
      html += `
        <div style="margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
            <span>${line}</span><span style="color:#666;">${c}ä»¶</span>
          </div>
          <div style="background:#e0e0e0;height:25px;border-radius:4px;overflow:hidden;">
            <div class="chart-bar" style="width:${(c/maxL)*100}%;height:25px;font-size:.85rem;background:linear-gradient(90deg,#f57c00 0%,#ffb74d 100%);">${c}ä»¶</div>
          </div>
        </div>`;
    });
    $('#departmentAnalysis').innerHTML = html || '<p style="color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
  }
  function updateRecurrenceAnalysis(){
    const rec = anomalyData.filter(it=>it.recurrenceType==='å†ç™º').length;
    const nw = anomalyData.filter(it=>it.recurrenceType==='æ–°è¦').length;
    const total = rec+nw;
    const div = $('#recurrenceAnalysis');
    if (total===0){ div.innerHTML='<p style="color:#999;">æŠ€è¡“å¯¾å¿œæ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>'; return; }
    const rate = (rec/total*100).toFixed(1);
    div.innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
        <div style="text-align:center;padding:20px;background:#ffebee;border-radius:8px;">
          <div style="font-size:3rem;font-weight:bold;color:#c62828;">${rec}</div>
          <div style="color:#666;margin-top:5px;">å†ç™ºä»¶æ•°</div>
        </div>
        <div style="text-align:center;padding:20px;background:#e8f5e9;border-radius:8px;">
          <div style="font-size:3rem;font-weight:bold;color:#2e7d32;">${nw}</div>
          <div style="color:#666;margin-top:5px;">æ–°è¦ä»¶æ•°</div>
        </div>
      </div>
      <div class="analysis-insight">
        <strong>ğŸ”„ å†ç™ºç‡:</strong> ${rate}% (${rec}/${total}ä»¶)
        ${rate>30 ? '<br>âš ï¸ å†ç™ºç‡ãŒé«˜ã‚ã§ã™ã€‚æ ¹æœ¬åŸå› ã®è¿½æ±‚ã¨æ’ä¹…å¯¾ç­–ãŒå¿…è¦ã§ã™ã€‚' : ''}
        ${rate<20 ? '<br>âœ… å†ç™ºç‡ã¯è‰¯å¥½ã§ã™ã€‚ç¾åœ¨ã®å¯¾ç­–ã‚’ç¶™ç¶šã—ã¾ã—ã‚‡ã†ã€‚' : ''}
      </div>`;
  }

  // ===== æ¤œç´¢UI =====
  function updateSearchDepartmentSelect(){
    const sel = $('#searchDepartment');
    const cur = sel.value;
    sel.innerHTML = '<option value="">ã™ã¹ã¦</option>';
    masterData.departments.forEach(d=>{
      const op=document.createElement('option');
      op.value=d; op.textContent=d;
      sel.appendChild(op);
    });
    if (cur && masterData.departments.includes(cur)){ sel.value=cur; updateSearchLineOptions(); }
  }
  function updateSearchLineOptions(){
    const dept = $('#searchDepartment').value;
    const sel = $('#searchLine');
    sel.innerHTML = '<option value="">ã™ã¹ã¦</option>';
    (masterData.lines[dept]||[]).forEach(line=>{
      const op=document.createElement('option'); op.value=line; op.textContent=line; sel.appendChild(op);
    });
  }
  function clearSearchFilters(){
    $('#searchDepartment').value=''; updateSearchLineOptions();
    $('#searchSerialNo').value=''; $('#searchKeyword').value=''; $('#similarResults').innerHTML='';
  }
  function searchSimilarAnomalies(){
    const keyword = ($('#searchKeyword').value||'').trim().toLowerCase();
    const dept = $('#searchDepartment').value;
    const line = $('#searchLine').value;
    const serialNo = ($('#searchSerialNo').value||'').trim();
    const out = $('#similarResults');

    let results = anomalyData.filter(it=>{
      if (dept && it.department!==dept) return false;
      if (line && it.lineName!==line) return false;
      if (serialNo && !String(it.serialNo).toLowerCase().includes(serialNo.toLowerCase())) return false;
      if (keyword){
        const txt = (it.anomalyContent+' '+it.actionTaken+' '+(it.rootCauseAction||'')).toLowerCase();
        return txt.includes(keyword);
      }
      return true;
    });

    if (keyword){
      results = results.map(it=>{
        const txt=(it.anomalyContent+' '+it.actionTaken+' '+(it.rootCauseAction||'')).toLowerCase();
        const score=(txt.match(new RegExp(keyword,'g'))||[]).length;
        return {...it, score};
      }).sort((a,b)=> (b.score||0)-(a.score||0));
    } else {
      results.sort((a,b)=> new Date(b.occurrenceDate)-new Date(a.occurrenceDate));
    }

    if (results.length===0){ out.innerHTML='<p style="color:#999;">è©²å½“ã™ã‚‹ç•°å¸¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>'; return; }

    const info=[];
    if (dept) info.push(`éƒ¨ç½²: ${dept}`);
    if (line) info.push(`ãƒ©ã‚¤ãƒ³: ${line}`);
    if (serialNo) info.push(`æ•´ç†No: ${serialNo}`);
    if (keyword) info.push(`ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${keyword}`);

    out.innerHTML = `
      <div style="margin-bottom:15px;padding:10px;background:#e3f2fd;border-radius:6px;">
        <strong>æ¤œç´¢æ¡ä»¶:</strong> ${info.length?info.join(' / '):'ã™ã¹ã¦'}
      </div>
      <p style="margin-bottom:15px;font-weight:bold;color:#333;">è©²å½“ä»¶æ•°: ${results.length}ä»¶</p>
      ${results.map(it=>`
        <div class="similar-item">
          <div class="similar-item-header">
            <div><strong style="color:#ff9800;">${it.serialNo}</strong><span style="color:#666;margin-left:10px;">${it.occurrenceDate}</span></div>
            ${keyword && it.score ? `<span class="similar-score">ä¸€è‡´åº¦: ${it.score}</span>`:''}
          </div>
          ${(it.department||it.lineName)?`
            <div style="margin-bottom:8px;">
              ${it.department?`<span style="background:#e3f2fd;padding:3px 10px;border-radius:12px;font-size:.85rem;margin-right:5px;">${it.department}</span>`:''}
              ${it.lineName?`<span style="background:#fff3e0;padding:3px 10px;border-radius:12px;font-size:.85rem;">${it.lineName}</span>`:''}
            </div>`:''}
          <div style="margin-bottom:8px;"><strong>ç•°å¸¸å†…å®¹:</strong> ${it.anomalyContent}</div>
          <div style="margin-bottom:8px;"><strong>è£½é€ å‡¦ç½®:</strong> ${it.actionTaken}</div>
          ${it.rootCauseAction?`
            <div style="margin-bottom:8px;background:#f1f8e9;padding:10px;border-radius:4px;border-left:3px solid #8bc34a;">
              <strong style="color:#558b2f;">ğŸ’¡ æŠ€è¡“å¯¾ç­–:</strong> ${it.rootCauseAction}
            </div>`:''}
          <div style="font-size:.85rem;color:#666;margin-top:5px;">
            ${it.handler?`å‡¦ç½®è€…: ${it.handler}`:''}
            ${(it.handler&&it.techHandler)?' / ':''}
            ${it.techHandler?`æŠ€è¡“å‡¦ç½®è€…: ${it.techHandler}`:''}
          </div>
        </div>`).join('')}
    `;
  }

  // ===== èµ·å‹•æ™‚ãƒã‚¤ãƒ³ãƒ‰ =====
  document.addEventListener('DOMContentLoaded', ()=>{
    // ã‚¿ãƒ–
    $('#tabs').addEventListener('click', (e)=>{
      const btn = e.target.closest('.tab'); if (!btn) return;
      const tab = btn.dataset.tab; if (!tab) return;
      switchTab(tab, btn);
    });

    // NOW
    $('#btnNowDate').addEventListener('click', setNowDate);
    $('#btnNowOccTime').addEventListener('click', ()=>setNowTime('occurrenceTime'));
    $('#btnNowResTime').addEventListener('click', ()=>setNowTime('restartTime'));

    // éƒ¨ç½²â†’ãƒ©ã‚¤ãƒ³/å‡¦ç½®è€…
    $('#department').addEventListener('change', updateLineOptions);

    // è£½é€ ï¼šæ•´ç†No blurã§å€™è£œ
    $('#serialNo').addEventListener('blur', searchSimilarSerialNo);

    // å€™è£œãƒœã‚¿ãƒ³ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
    $('#suggestionArea').addEventListener('click', (e)=>{
      const b = e.target.closest('button[data-apply]'); if (!b) return;
      applySuggestion(b.dataset.apply, b.dataset.text || '');
    });

    // ç”»åƒ
    $('#mfgUpload').addEventListener('click', ()=>$('#mfgPhotos').click());
    $('#techUpload').addEventListener('click', ()=>$('#techPhotos').click());
    handlePhotoUpload('mfgPhotos','mfgPhotoPreview', mfgPhotos);
    handlePhotoUpload('techPhotos','techPhotoPreview', techPhotos);
    document.addEventListener('click', (e)=>{
      const r = e.target.closest('button[data-remove-photo]'); if (!r) return;
      const pv = r.dataset.removePhoto; const idx = Number(r.dataset.index);
      const arr = (pv==='mfgPhotoPreview') ? mfgPhotos : techPhotos;
      arr.splice(idx,1); displayPhotos(pv, arr);
    });

    // ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿
    $('#viewToggle').addEventListener('click', (e)=>{
      const b = e.target.closest('button[data-view]'); if (!b) return;
      $$('#viewToggle button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      currentView = b.dataset.view;
      $('#cardView').style.display = currentView==='card' ? 'grid' : 'none';
      $('#tableView').style.display = currentView==='table' ? 'block' : 'none';
      updateHistory();
    });

    // å‰Šé™¤ï¼ˆã‚«ãƒ¼ãƒ‰/ãƒ†ãƒ¼ãƒ–ãƒ«å…±é€šãƒ»å§”è­²ï¼‰
    document.addEventListener('click', (e)=>{
      const del = e.target.closest('button.btn-delete[data-id]');
      if (del){ deleteRecord(Number(del.dataset.id)); return; }
      // ãƒã‚¹ã‚¿å‰Šé™¤
      const dDept = e.target.closest('button[data-del-dept]');
      if (dDept){ deleteDepartment(dDept.dataset.delDept); return; }
      const dLine = e.target.closest('button[data-del-line]');
      if (dLine){ deleteLine(dLine.dataset.dept, dLine.dataset.delLine); return; }
      const dHandler = e.target.closest('button[data-del-handler]');
      if (dHandler){ deleteHandler(dHandler.dataset.dept, dHandler.dataset.delHandler); return; }

      // éå»å±¥æ­´ï¼šä»–â—¯ä»¶ãƒˆã‚°ãƒ«
      const tog = e.target.closest('#btnToggleMore');
      if (tog){
        const open = tog.dataset.open==='1';
        $('#moreHistory').style.display = open ? 'none' : 'block';
        tog.dataset.open = open ? '0' : '1';
        tog.textContent = open ? `ä»–ã‚’éè¡¨ç¤º` : tog.textContent.replace('éè¡¨ç¤º','è¡¨ç¤º'); // åˆå›æ–‡è¨€ç¶­æŒ
      }

      // éå»å±¥æ­´ï¼šã‚³ãƒ”ãƒ¼
      const cp = e.target.closest('button.copy-btn[data-apply]');
      if (cp){ applySuggestion(cp.dataset.apply, cp.dataset.text||''); }
    });

    // CSV
    $('#btnExport').addEventListener('click', exportCSV);
    $('#btnImport').addEventListener('click', ()=>$('#csvImport').click());
    $('#csvImport').addEventListener('change', e=>{
      const file = e.target.files[0]; if (!file) return;
      importCSV(file); e.target.value='';
    });

    // æ¤œç´¢
    $('#btnSearch').addEventListener('click', searchSimilarAnomalies);
    $('#btnClearSearch').addEventListener('click', clearSearchFilters);

    // æŠ€è¡“ï¼šæ¡ˆä»¶é¸æŠ
    $('#selectSerialNo').addEventListener('change', loadManufacturingData);

    // ãƒã‚¹ã‚¿è¿½åŠ 
    $('#btnAddDept').addEventListener('click', addDepartment);
    $('#lineManageDept').addEventListener('change', updateLineManageList);
    $('#btnAddLine').addEventListener('click', addLine);
    $('#handlerManageDept').addEventListener('change', updateHandlerManageList);
    $('#btnAddHandler').addEventListener('click', addHandler);

    // åˆæœŸãƒ­ãƒ¼ãƒ‰
    loadData();
    setNowDate(); // ã‚·ãƒ•ãƒˆè€ƒæ…®

    // è£½é€ ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    $('#manufacturingForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const ok = requireFilled(['occurrenceDate','department','lineName','handler','serialNo','anomalyContent','actionTaken','traceback','techRequest']);
      if (!ok) return;
      const techReq = $('#techRequest').value;
      const data = {
        id: Date.now()+Math.random(),
        department: $('#department').value,
        lineName: $('#lineName').value,
        serialNo: $('#serialNo').value,
        occurrenceDate: $('#occurrenceDate').value,
        occurrenceTime: $('#occurrenceTime').value,
        restartTime: $('#restartTime').value,
        anomalyContent: $('#anomalyContent').value,
        actionTaken: $('#actionTaken').value,
        traceback: $('#traceback').value,
        handler: $('#handler').value,
        techRequest: techReq,
        mfgPhotos:[...mfgPhotos],
        status: techReq==='å®Œçµ' ? 'complete' : 'pending',
        createdAt: new Date().toISOString()
      };
      anomalyData.push(data); saveData();
      // ãƒªã‚»ãƒƒãƒˆ
      e.target.reset(); mfgPhotos=[]; $('#mfgPhotoPreview').innerHTML='';
      $('#lineName').innerHTML='<option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>';
      $('#handler').innerHTML='<option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>';
      updateHistory(); updateSerialNoSelect();
      alert('ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
    });

    // æŠ€è¡“ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    $('#technicalForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const ok = requireFilled(['selectSerialNo','techHandler','lifespan','maintenanceUnit','rootCauseAction','recurrenceType']);
      if (!ok) return;
      const id = $('#selectSerialNo').value;
      const idx = anomalyData.findIndex(it=> String(it.id)===String(id));
      if (idx===-1) return alert('å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      Object.assign(anomalyData[idx], {
        techHandler: $('#techHandler').value,
        lifespan: $('#lifespan').value,
        maintenanceUnit: $('#maintenanceUnit').value,
        rootCauseAction: $('#rootCauseAction').value,
        recurrenceType: $('#recurrenceType').value,
        techPhotos:[...techPhotos],
        status:'complete',
        completedAt: new Date().toISOString()
      });
      saveData();
      // ãƒªã‚»ãƒƒãƒˆ
      e.target.reset(); techPhotos=[]; $('#techPhotoPreview').innerHTML='';
      $('#selectedDataDisplay').style.display='none';
      $('#pastHistoryArea').style.display='none';
      updateSerialNoSelect(); updateHistory();
      alert('ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
    });
  });
</script>
</body>
</html>