<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•°å¸¸å±¥æ­´å…¥åŠ›ãƒ„ãƒ¼ãƒ«ï¼ˆç·¨é›†å¯¾å¿œç‰ˆãƒ»LINEæ©Ÿèƒ½ãªã—ï¼‰</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Hiragino Sans',sans-serif;background:#f5f5f5}

  .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  .header h1{font-size:1.5rem;margin-bottom:5px}

  .container{max-width:800px;margin:0 auto;padding:10px}
  .tabs{display:flex;background:#fff;margin:15px 0 0;border-radius:8px 8px 0 0;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,.1)}
  .tab{flex:1;padding:15px;text-align:center;cursor:pointer;background:#f8f9fa;border:none;font-size:1rem;font-weight:bold;transition:.3s;color:#666}
  .tab.active{background:#fff;color:#667eea;border-bottom:3px solid #667eea}
  .tab-content{display:none;background:#fff;padding:20px;border-radius:0 0 8px 8px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  .tab-content.active{display:block}

  .form-group{margin-bottom:20px}
  .form-group label{display:block;margin-bottom:8px;font-weight:bold;color:#333;font-size:.95rem}
  .form-group input,.form-group textarea,.form-group select{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:6px;font-size:1rem;transition:border-color .3s}
  .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:#667eea}
  .form-group textarea{min-height:100px;resize:vertical}
  .time-group{display:grid;grid-template-columns:1fr 1fr;gap:10px}

  .photo-upload{border:2px dashed #e0e0e0;border-radius:6px;padding:20px;text-align:center;cursor:pointer;transition:.3s}
  .photo-upload:hover{border-color:#667eea;background:#f8f9ff}
  .photo-upload input[type=file]{display:none}
  .photo-preview{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-top:15px}
  .photo-item{position:relative;aspect-ratio:1;border-radius:6px;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,.1)}
  .photo-item img{width:100%;height:100%;object-fit:cover}
  .photo-item .remove-btn{position:absolute;top:5px;right:5px;background:rgba(255,59,48,.9);color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:14px;line-height:1}

  .btn{width:100%;padding:15px;border:none;border-radius:6px;font-size:1rem;font-weight:bold;cursor:pointer;transition:.3s;margin-top:10px}
  .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
  .btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,.4)}
  .btn-secondary{background:#6c757d;color:#fff}
  .btn-export{background:#28a745;color:#fff}
  .btn-import{background:#17a2b8;color:#fff}

  .history-controls{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
  .view-toggle{display:flex;gap:5px}
  .view-toggle button{padding:8px 15px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:6px;cursor:pointer;font-weight:bold}
  .view-toggle button.active{background:#667eea;color:#fff}

  .card-view{display:grid;gap:15px}
  .anomaly-card{background:#fff;border-radius:8px;padding:15px;box-shadow:0 2px 8px rgba(0,0,0,.1);border-left:4px solid #667eea}
  .anomaly-card.complete{border-left-color:#28a745}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #e0e0e0}
  .card-id{font-size:1.2rem;font-weight:bold;color:#667eea}
  .card-status{padding:4px 12px;border-radius:12px;font-size:.85rem;font-weight:bold}
  .status-pending{background:#fff3cd;color:#856404}
  .status-complete{background:#d4edda;color:#155724}
  .card-body{display:grid;gap:8px}
  .card-field{display:grid;grid-template-columns:120px 1fr;gap:10px}
  .field-label{font-weight:bold;color:#666}
  .field-value{color:#333}

  .table-view{overflow-x:auto;display:none}
  .table-view.active{display:block}
  table{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.1)}
  th,td{padding:12px;text-align:left;border-bottom:1px solid #e0e0e0}
  th{background:#667eea;color:#fff;font-weight:bold;position:sticky;top:0}
  tr:hover{background:#f8f9ff}

  .action-btns{display:flex;gap:6px;flex-wrap:wrap}
  .btn-small{padding:6px 10px;border:none;border-radius:4px;cursor:pointer;font-size:.85rem}
  .btn-edit{background:#ffc107;color:#000}
  .btn-delete{background:#dc3545;color:#fff}

  .empty-state{text-align:center;padding:40px 20px;color:#999}
  .empty-state-icon{font-size:3rem;margin-bottom:15px}

  /* ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
  .modal.active{display:flex}
  .modal-content{background:#fff;padding:20px;border-radius:8px;max-width:680px;width:95%;max-height:90vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .modal-title{font-size:1.1rem;font-weight:bold;margin-bottom:10px;color:#333}
  .edit-tabs{display:flex;gap:8px;margin:8px 0 16px}
  .edit-tab{flex:1;padding:10px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:6px;cursor:pointer;font-weight:bold}
  .edit-tab.active{background:#667eea;color:#fff}
  .modal-actions{display:flex;gap:10px;margin-top:10px}
  .btn-cancel{background:#9e9e9e;color:#fff}

  @media (max-width:600px){
    .card-field{grid-template-columns:1fr;gap:5px}
    .time-group{grid-template-columns:1fr}
    table{font-size:.85rem}
    th,td{padding:8px}
  }
</style>
</head>
<body>
  <div class="header">
    <h1>ğŸ“‹ ç•°å¸¸å±¥æ­´å…¥åŠ›ãƒ„ãƒ¼ãƒ«</h1>
    <p>è£½é€ ãƒ»æŠ€è¡“éƒ¨é–€é€£æºã‚·ã‚¹ãƒ†ãƒ ï¼ˆå±¥æ­´ã‹ã‚‰ç·¨é›†å¯¾å¿œï¼LINEæ©Ÿèƒ½ãªã—ï¼‰</p>
  </div>

  <div class="container">
    <div class="tabs">
      <button class="tab active" data-tab="manufacturing">è£½é€ å…¥åŠ›</button>
      <button class="tab" data-tab="technical">æŠ€è¡“å…¥åŠ›</button>
      <button class="tab" data-tab="history">å±¥æ­´</button>
      <button class="tab" data-tab="analysis">ğŸ“Š åˆ†æ</button>
      <button class="tab" data-tab="master">âš™ï¸ ç®¡ç†</button>
    </div>

    <!-- è£½é€ å…¥åŠ› -->
    <div id="manufacturing" class="tab-content active">
      <h2 style="margin-bottom:20px;color:#667eea;">è£½é€ éƒ¨é–€ - ç•°å¸¸å ±å‘Š</h2>
      <p style="margin-bottom:20px;color:#666;">ã„ã¤ãƒ»ã©ã“ã§ãƒ»ã©ã®æ•´ç†Noã§ãƒ»ä½•ãŒã‚ã£ãŸ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>

      <form id="manufacturingForm">
        <!-- ã„ã¤ -->
        <div style="background:#f0f7ff;padding:15px;border-radius:6px;margin-bottom:20px;">
          <h3 style="color:#667eea;margin-bottom:15px;font-size:1.1rem;">ğŸ“… ã„ã¤</h3>
          <div class="form-group">
            <label>ç™ºç”Ÿæ—¥ *</label>
            <div style="display:flex;gap:10px;">
              <input type="date" id="occurrenceDate" required style="flex:1;">
              <button type="button" class="btn btn-secondary" style="width:auto;padding:12px 20px;margin:0;background:#17a2b8;" id="btnNowDate">ğŸ“… NOW</button>
            </div>
            <p style="font-size:.85rem;color:#666;margin-top:5px;">â€»å‹¤å‹™æ™‚é–“: 8:00ã€œç¿Œ6:00 (0:00ã€œ6:00ã®ç•°å¸¸ã¯å‰æ—¥æ‰±ã„)</p>
          </div>

          <div class="form-group">
            <label>æ™‚åˆ»</label>
            <div class="time-group">
              <div>
                <label style="font-weight:normal;font-size:.9rem;">ç™ºç”Ÿæ™‚åˆ»</label>
                <div style="display:flex;gap:5px;">
                  <input type="time" id="occurrenceTime" style="flex:1;">
                  <button type="button" class="btn btn-secondary" style="width:auto;padding:8px 12px;margin:0;font-size:.85rem;background:#17a2b8;" data-now="occurrenceTime">NOW</button>
                </div>
              </div>
              <div>
                <label style="font-weight:normal;font-size:.9rem;">å†é–‹æ™‚åˆ»</label>
                <div style="display:flex;gap:5px;">
                  <input type="time" id="restartTime" style="flex:1;">
                  <button type="button" class="btn btn-secondary" style="width:auto;padding:8px 12px;margin:0;font-size:.85rem;background:#17a2b8;" data-now="restartTime">NOW</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ã©ã“ã§ -->
        <div style="background:#fff4e6;padding:15px;border-radius:6px;margin-bottom:20px;">
          <h3 style="color:#f57c00;margin-bottom:15px;font-size:1.1rem;">ğŸ“ ã©ã“ã§</h3>
          <div class="form-group">
            <label>éƒ¨ç½² *</label>
            <select id="department" required></select>
          </div>
          <div class="form-group">
            <label>ãƒ©ã‚¤ãƒ³å *</label>
            <select id="lineName" required>
              <option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          <div class="form-group">
            <label>å‡¦ç½®è€… *</label>
            <select id="handler" required>
              <option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
        </div>

        <!-- ã©ã®æ•´ç†Noã§ -->
        <div style="background:#f3e5f5;padding:15px;border-radius:6px;margin-bottom:20px;">
          <h3 style="color:#8e24aa;margin-bottom:15px;font-size:1.1rem;">ğŸ”¢ ã©ã®æ•´ç†Noã§</h3>
          <div class="form-group">
            <label>æ•´ç†No *</label>
            <input type="text" id="serialNo" required placeholder="ä¾‹: 2024-001">
          </div>
        </div>

        <!-- ä½•ãŒã‚ã£ãŸ -->
        <div style="background:#e8f5e9;padding:15px;border-radius:6px;margin-bottom:20px;">
          <h3 style="color:#2e7d32;margin-bottom:15px;font-size:1.1rem;">ğŸ“ ä½•ãŒã‚ã£ãŸ</h3>
          <div class="form-group">
            <label>ç•°å¸¸å†…å®¹ *</label>
            <textarea id="anomalyContent" required placeholder="ç™ºç”Ÿã—ãŸç•°å¸¸ã®è©³ç´°ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„"></textarea>
          </div>
          <div class="form-group">
            <label>è£½é€ å‡¦ç½®å†…å®¹ *</label>
            <textarea id="actionTaken" required placeholder="å®Ÿæ–½ã—ãŸå‡¦ç½®å†…å®¹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„"></textarea>
          </div>
          <div class="form-group">
            <label>é¡ã‚Š *</label>
            <select id="traceback" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="æœ‰">æœ‰</option>
              <option value="ç„¡">ç„¡</option>
            </select>
          </div>
          <div class="form-group">
            <label>æŠ€è¡“è¦è«‹ *</label>
            <select id="techRequest" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="è¦è«‹">æŠ€è¡“è¦è«‹ã‚ã‚Šï¼ˆæŠ€è¡“éƒ¨é–€ã®å…¥åŠ›ãŒå¿…è¦ï¼‰</option>
              <option value="å®Œçµ">è£½é€ ã§å®Œçµï¼ˆæŠ€è¡“å…¥åŠ›ä¸è¦ï¼‰</option>
            </select>
          </div>

          <div class="form-group">
            <label>å†™çœŸ</label>
            <div class="photo-upload" onclick="document.getElementById('mfgPhotos').click()">
              <div style="font-size:2rem;">ğŸ“¸</div>
              <p>å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</p>
              <input type="file" id="mfgPhotos" accept="image/*" multiple>
            </div>
            <div id="mfgPhotoPreview" class="photo-preview"></div>
          </div>
        </div>

        <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
      </form>
    </div>

    <!-- æŠ€è¡“å…¥åŠ› -->
    <div id="technical" class="tab-content">
      <h2 style="margin-bottom:20px;color:#667eea;">æŠ€è¡“éƒ¨é–€ - è¿½åŠ å…¥åŠ›</h2>

      <div class="form-group">
        <label>å¯¾è±¡ã®æ¡ˆä»¶é¸æŠ *</label>
        <select id="selectSerialNo">
          <option value="">æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
        <p style="margin-top:5px;font-size:.85rem;color:#666;">â€»[å“ç•ª] æ—¥ä»˜ - ç•°å¸¸å†…å®¹ ã®å½¢å¼ã§è¡¨ç¤ºã•ã‚Œã¾ã™</p>
      </div>

      <div id="selectedDataDisplay" style="background:#f8f9ff;padding:15px;border-radius:6px;margin-bottom:20px;display:none;">
        <h3 style="color:#667eea;margin-bottom:10px;">è£½é€ éƒ¨é–€å…¥åŠ›å†…å®¹</h3>
        <div id="displayContent"></div>
      </div>

      <!-- æŠ€è¡“ãƒ•ã‚©ãƒ¼ãƒ  -->
      <form id="technicalForm">
        <div class="form-group">
          <label>æŠ€è¡“å‡¦ç½®è€… *</label>
          <input type="text" id="techHandler" placeholder="æŠ€è¡“å‡¦ç½®è€…åã‚’å…¥åŠ›">
        </div>
        <div class="form-group">
          <label>å‘½æ•°æœ‰ç„¡ *</label>
          <select id="lifespan">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="æœ‰">æœ‰</option>
            <option value="ç„¡">ç„¡</option>
          </select>
        </div>
        <div class="form-group">
          <label>ä¿å…¨å˜ä½ *</label>
          <input type="text" id="maintenanceUnit" placeholder="ä¾‹: ãƒ¢ãƒ¼ã‚¿ãƒ¼ã€ãƒ™ã‚¢ãƒªãƒ³ã‚°">
        </div>
        <div class="form-group">
          <label>ä½•ãŒæ‚ªãã©ã†ã—ãŸ *</label>
          <textarea id="rootCauseAction" placeholder="åŸå› ã¨å¯¾ç­–ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„"></textarea>
        </div>
        <div class="form-group">
          <label>å†ç™ºã‹æ–°è¦ã‹ *</label>
          <select id="recurrenceType">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="å†ç™º">å†ç™º</option>
            <option value="æ–°è¦">æ–°è¦</option>
          </select>
        </div>
        <div class="form-group">
          <label>å†™çœŸ</label>
          <div class="photo-upload" onclick="document.getElementById('techPhotos').click()">
            <div style="font-size:2rem;">ğŸ“¸</div>
            <p>å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</p>
            <input type="file" id="techPhotos" accept="image/*" multiple>
          </div>
          <div id="techPhotoPreview" class="photo-preview"></div>
        </div>
        <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
      </form>
    </div>

    <!-- å±¥æ­´ -->
    <div id="history" class="tab-content">
      <h2 style="margin-bottom:20px;color:#667eea;">ç•°å¸¸å±¥æ­´</h2>
      <div class="history-controls">
        <div class="view-toggle">
          <button class="active" data-view="card">ã‚«ãƒ¼ãƒ‰</button>
          <button data-view="table">ãƒ†ãƒ¼ãƒ–ãƒ«</button>
        </div>
        <button class="btn btn-export" style="flex:1;" id="btnExport">ğŸ“¥ CSVå‡ºåŠ›</button>
        <button class="btn btn-import" style="flex:1;" id="btnImport">ğŸ“¤ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        <input type="file" id="csvImport" accept=".csv" style="display:none;">
      </div>
      <div id="cardView" class="card-view"></div>
      <div id="tableView" class="table-view"></div>
    </div>

    <!-- åˆ†æ -->
    <div id="analysis" class="tab-content">
      <h2 style="margin-bottom:20px;color:#ff9800;">ğŸ“Š ç•°å¸¸ãƒ‡ãƒ¼ã‚¿åˆ†æ</h2>
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#ff9800;margin-bottom:15px;">ğŸ“ˆ çµ±è¨ˆæƒ…å ±</h3>
        <div id="statisticsDisplay" style="display:grid;gap:15px;"></div>
      </div>
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#ff9800;margin-bottom:15px;">ğŸ“Š æœˆåˆ¥å‚¾å‘åˆ†æ</h3>
        <div id="trendChart" style="min-height:300px;"></div>
        <div id="trendAnalysis" style="margin-top:15px;"></div>
      </div>
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#ff9800;margin-bottom:15px;">ğŸ¢ éƒ¨ç½²ãƒ»ãƒ©ã‚¤ãƒ³åˆ¥åˆ†æ</h3>
        <div id="departmentAnalysis" style="display:grid;gap:15px;"></div>
      </div>
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);">
        <h3 style="color:#ff9800;margin-bottom:15px;">ğŸ”„ å†ç™ºãƒ»æ–°è¦åˆ†æ</h3>
        <div id="recurrenceAnalysis"></div>
      </div>
    </div>

    <!-- ç®¡ç† -->
    <div id="master" class="tab-content">
      <h2 style="margin-bottom:20px;color:#667eea;">âš™ï¸ ãƒã‚¹ã‚¿ç®¡ç†</h2>
      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#667eea;margin-bottom:15px;">éƒ¨ç½²ç®¡ç†</h3>
        <div style="display:flex;gap:10px;margin-bottom:15px;">
          <input type="text" id="newDepartment" placeholder="æ–°ã—ã„éƒ¨ç½²åã‚’å…¥åŠ›" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button class="btn btn-primary" style="width:auto;padding:10px 20px;margin:0;" id="btnAddDept">è¿½åŠ </button>
        </div>
        <div id="departmentList" style="display:grid;gap:10px;"></div>
      </div>

      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;">
        <h3 style="color:#f57c00;margin-bottom:15px;">ãƒ©ã‚¤ãƒ³åç®¡ç†</h3>
        <div class="form-group">
          <label>å¯¾è±¡éƒ¨ç½²</label>
          <select id="lineManageDept"><option value="">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</option></select>
        </div>
        <div style="display:flex;gap:10px;margin-bottom:15px;">
          <input type="text" id="newLine" placeholder="æ–°ã—ã„ãƒ©ã‚¤ãƒ³åã‚’å…¥åŠ›" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button class="btn btn-primary" style="width:auto;padding:10px 20px;margin:0;background:#f57c00;" id="btnAddLine">è¿½åŠ </button>
        </div>
        <div id="lineList" style="display:grid;gap:10px;"></div>
      </div>

      <div style="background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);">
        <h3 style="color:#2e7d32;margin-bottom:15px;">å‡¦ç½®è€…ç®¡ç†</h3>
        <div class="form-group">
          <label>å¯¾è±¡éƒ¨ç½²</label>
          <select id="handlerManageDept"><option value="">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</option></select>
        </div>
        <div style="display:flex;gap:10px;margin-bottom:15px;">
          <input type="text" id="newHandler" placeholder="æ–°ã—ã„å‡¦ç½®è€…åã‚’å…¥åŠ›" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button class="btn btn-primary" style="width:auto;padding:10px 20px;margin:0;background:#2e7d32;" id="btnAddHandler">è¿½åŠ </button>
        </div>
        <div id="handlerList" style="display:grid;gap:10px;"></div>
      </div>
    </div>
  </div>

  <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="editModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-title">âœï¸ å±¥æ­´ãƒ¬ã‚³ãƒ¼ãƒ‰ç·¨é›†</div>
      <div class="edit-tabs">
        <button class="edit-tab active" data-edit-tab="mfg">è£½é€ </button>
        <button class="edit-tab" data-edit-tab="tech">æŠ€è¡“</button>
      </div>

      <!-- è£½é€ ç·¨é›† -->
      <div id="editMfg" class="edit-pane">
        <div class="form-group">
          <label>ç™ºç”Ÿæ—¥ *</label>
          <input type="date" id="edit_occurrenceDate">
        </div>
        <div class="form-group">
          <label>ç™ºç”Ÿæ™‚åˆ» / å†é–‹æ™‚åˆ»</label>
          <div class="time-group">
            <input type="time" id="edit_occurrenceTime">
            <input type="time" id="edit_restartTime">
          </div>
        </div>
        <div class="form-group">
          <label>éƒ¨ç½² *</label>
          <select id="edit_department"></select>
        </div>
        <div class="form-group">
          <label>ãƒ©ã‚¤ãƒ³å *</label>
          <select id="edit_lineName"></select>
        </div>
        <div class="form-group">
          <label>å‡¦ç½®è€… *</label>
          <select id="edit_handler"></select>
        </div>
        <div class="form-group">
          <label>æ•´ç†No *</label>
          <input type="text" id="edit_serialNo">
        </div>
        <div class="form-group">
          <label>ç•°å¸¸å†…å®¹ *</label>
          <textarea id="edit_anomalyContent"></textarea>
        </div>
        <div class="form-group">
          <label>è£½é€ å‡¦ç½®å†…å®¹ *</label>
          <textarea id="edit_actionTaken"></textarea>
        </div>
        <div class="form-group">
          <label>é¡ã‚Š *</label>
          <select id="edit_traceback">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="æœ‰">æœ‰</option>
            <option value="ç„¡">ç„¡</option>
          </select>
        </div>
        <div class="form-group">
          <label>æŠ€è¡“è¦è«‹ *</label>
          <select id="edit_techRequest">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="è¦è«‹">æŠ€è¡“è¦è«‹ã‚ã‚Šï¼ˆæŠ€è¡“éƒ¨é–€ã®å…¥åŠ›ãŒå¿…è¦ï¼‰</option>
            <option value="å®Œçµ">è£½é€ ã§å®Œçµï¼ˆæŠ€è¡“å…¥åŠ›ä¸è¦ï¼‰</option>
          </select>
        </div>
      </div>

      <!-- æŠ€è¡“ç·¨é›† -->
      <div id="editTech" class="edit-pane" style="display:none;">
        <div class="form-group">
          <label>æŠ€è¡“å‡¦ç½®è€…</label>
          <input type="text" id="edit_techHandler">
        </div>
        <div class="form-group">
          <label>å‘½æ•°æœ‰ç„¡</label>
          <select id="edit_lifespan">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="æœ‰">æœ‰</option>
            <option value="ç„¡">ç„¡</option>
          </select>
        </div>
        <div class="form-group">
          <label>ä¿å…¨å˜ä½</label>
          <input type="text" id="edit_maintenanceUnit">
        </div>
        <div class="form-group">
          <label>ä½•ãŒæ‚ªãã©ã†ã—ãŸ</label>
          <textarea id="edit_rootCauseAction"></textarea>
        </div>
        <div class="form-group">
          <label>å†ç™ºã‹æ–°è¦ã‹</label>
          <select id="edit_recurrenceType">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="å†ç™º">å†ç™º</option>
            <option value="æ–°è¦">æ–°è¦</option>
          </select>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-cancel" id="btnEditCancel" style="flex:1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" id="btnEditSave" style="flex:1;">ä¿å­˜</button>
      </div>
    </div>
  </div>

<script>
  let anomalyData = [];
  let mfgPhotos = [];
  let techPhotos = [];
  let currentView = 'card';
  let editingId = null;

  // ãƒã‚¹ã‚¿
  let masterData = {
    departments: ['è£½é€ 1èª²','è£½é€ 2èª²','çµ„ç«‹èª²'],
    lines: {'è£½é€ 1èª²':['ãƒ©ã‚¤ãƒ³1','ãƒ©ã‚¤ãƒ³2'],'è£½é€ 2èª²':['ãƒ©ã‚¤ãƒ³A','ãƒ©ã‚¤ãƒ³B'],'çµ„ç«‹èª²':['çµ„ç«‹1','çµ„ç«‹2']},
    handlers: {'è£½é€ 1èª²':['å±±ç”°å¤ªéƒ','ä½è—¤èŠ±å­'],'è£½é€ 2èª²':['éˆ´æœ¨ä¸€éƒ','ç”°ä¸­ç¾å’²'],'çµ„ç«‹èª²':['é«˜æ©‹å¥å¤ª','ä¼Šè—¤æ„›']}
  };

  // ==== åˆæœŸåŒ– ====
  function saveData(){ localStorage.setItem('anomalyData', JSON.stringify(anomalyData)); }
  function saveMaster(){ localStorage.setItem('masterData', JSON.stringify(masterData)); }

  function loadData(){
    try{
      const saved = localStorage.getItem('anomalyData');
      if (saved) anomalyData = JSON.parse(saved);
    }catch(e){ console.warn('load anomalyData error', e); }
    try{
      const savedM = localStorage.getItem('masterData');
      if (savedM) masterData = JSON.parse(savedM);
      else saveMaster();
    }catch(e){ console.warn('load masterData error', e); }

    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç„¡åŠ¹IDã¯ç”»é¢ã«å‡ºã•ãªã„ï¼ˆä»»æ„ï¼‰
    anomalyData = anomalyData.filter(it => it && it.id !== undefined && it.id !== null && it.id !== '');

    updateHistory();
    updateSerialNoSelect();
    updateAllDepartmentSelects();
  }

  // éƒ¨ç½²ç³»ã‚»ãƒ¬ã‚¯ãƒˆæ›´æ–°
  function updateAllDepartmentSelects(){
    updateDepartmentSelect('department');
    updateDepartmentSelect('lineManageDept');
    updateDepartmentSelect('handlerManageDept');
    updateDepartmentList();
  }
  function updateDepartmentSelect(selectId){
    const sel = document.getElementById(selectId);
    if (!sel) return;
    const keep = sel.value;
    sel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    masterData.departments.forEach(d=>{
      const o = document.createElement('option'); o.value = o.textContent = d; sel.appendChild(o);
    });
    if (keep && masterData.departments.includes(keep)) sel.value = keep;
  }

  // è£½é€ ãƒ•ã‚©ãƒ¼ãƒ ï¼šéƒ¨ç½²å¤‰æ›´ã§ãƒ©ã‚¤ãƒ³ãƒ»å‡¦ç½®è€…
  function refreshLineAndHandler(deptSelId, lineSelId, handlerSelId){
    const dept = document.getElementById(deptSelId).value;
    const lineSel = document.getElementById(lineSelId);
    const handlerSel = document.getElementById(handlerSelId);
    lineSel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    handlerSel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    (masterData.lines[dept]||[]).forEach(l=>{
      const o = document.createElement('option'); o.value=o.textContent=l; lineSel.appendChild(o);
    });
    (masterData.handlers[dept]||[]).forEach(h=>{
      const o = document.createElement('option'); o.value=o.textContent=h; handlerSel.appendChild(o);
    });
  }

  // ==== ã‚¿ãƒ– ====
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.dataset.tab;
      document.getElementById(id).classList.add('active');
      if (id==='history') updateHistory();
      else if (id==='technical') updateSerialNoSelect();
      else if (id==='analysis') updateAnalysis();
    });
  });

  // ==== NOW ====
  function setNowDateTo(id){
    const now = new Date();
    const hour = now.getHours();
    if (hour>=0 && hour<6) now.setDate(now.getDate()-1);
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,'0');
    const d = String(now.getDate()).padStart(2,'0');
    document.getElementById(id).value = `${y}-${m}-${d}`;
  }
  function setNowTimeTo(id){
    const now = new Date();
    const hh = String(now.getHours()).padStart(2,'0');
    const mm = String(now.getMinutes()).padStart(2,'0');
    document.getElementById(id).value = `${hh}:${mm}`;
  }
  document.getElementById('btnNowDate').addEventListener('click', ()=>setNowDateTo('occurrenceDate'));
  document.querySelectorAll('button[data-now]').forEach(b=>{
    b.addEventListener('click', ()=> setNowTimeTo(b.getAttribute('data-now')));
  });

  // ==== å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ====
  function handlePhotoUpload(inputId, previewId, arrRef){
    const input = document.getElementById(inputId);
    input.addEventListener('change', (e)=>{
      const files = Array.from(e.target.files||[]);
      files.forEach(file=>{
        const r = new FileReader();
        r.onload = ev=>{ arrRef.push(ev.target.result); displayPhotos(previewId, arrRef); };
        r.readAsDataURL(file);
      });
      input.value = '';
    });
  }
  function displayPhotos(previewId, arr){
    const wrap = document.getElementById(previewId);
    wrap.innerHTML = '';
    arr.forEach((src,idx)=>{
      const div = document.createElement('div');
      div.className='photo-item';
      div.innerHTML = `<img src="${src}"><button class="remove-btn" data-photo="${previewId}" data-index="${idx}">Ã—</button>`;
      wrap.appendChild(div);
    });
  }
  document.addEventListener('click', (e)=>{
    const rm = e.target.closest('.remove-btn[data-photo]');
    if (!rm) return;
    const id = rm.getAttribute('data-photo');
    const idx = Number(rm.getAttribute('data-index'));
    if (id==='mfgPhotoPreview'){ mfgPhotos.splice(idx,1); displayPhotos(id,mfgPhotos); }
    else if (id==='techPhotoPreview'){ techPhotos.splice(idx,1); displayPhotos(id,techPhotos); }
  });

  handlePhotoUpload('mfgPhotos','mfgPhotoPreview', mfgPhotos);
  handlePhotoUpload('techPhotos','techPhotoPreview', techPhotos);

  // ==== è£½é€ ãƒ•ã‚©ãƒ¼ãƒ ç™»éŒ² ====
  document.getElementById('department').addEventListener('change', ()=>refreshLineAndHandler('department','lineName','handler'));
  document.getElementById('manufacturingForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const techReq = document.getElementById('techRequest').value;

    const rec = {
      id: Date.now() + Math.random(),
      department: document.getElementById('department').value,
      lineName: document.getElementById('lineName').value,
      serialNo: document.getElementById('serialNo').value,
      occurrenceDate: document.getElementById('occurrenceDate').value,
      occurrenceTime: document.getElementById('occurrenceTime').value,
      restartTime: document.getElementById('restartTime').value,
      anomalyContent: document.getElementById('anomalyContent').value,
      actionTaken: document.getElementById('actionTaken').value,
      traceback: document.getElementById('traceback').value,
      handler: document.getElementById('handler').value,
      techRequest: techReq,
      mfgPhotos:[...mfgPhotos],
      status: techReq==='å®Œçµ' ? 'complete' : 'pending',
      createdAt: new Date().toISOString()
    };
    anomalyData.push(rec);
    saveData();

    // ãƒªã‚»ãƒƒãƒˆ
    e.target.reset();
    mfgPhotos = [];
    document.getElementById('mfgPhotoPreview').innerHTML='';
    document.getElementById('lineName').innerHTML='<option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>';
    document.getElementById('handler').innerHTML='<option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>';

    updateHistory();
    updateSerialNoSelect();
    alert('ç™»éŒ²ã—ã¾ã—ãŸã€‚');
  });

  // ==== æŠ€è¡“ãƒ•ã‚©ãƒ¼ãƒ  ====
  function updateSerialNoSelect(){
    const sel = document.getElementById('selectSerialNo');
    sel.innerHTML = '<option value="">æ•´ç†Noã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    anomalyData
      .filter(x=>x.status==='pending' && x.techRequest==='è¦è«‹')
      .sort((a,b)=> new Date(b.occurrenceDate)-new Date(a.occurrenceDate))
      .forEach(x=>{
        const o = document.createElement('option');
        o.value = x.id;
        o.textContent = `[${x.serialNo}] ${x.occurrenceDate} - ${x.anomalyContent.substring(0,30)}...`;
        sel.appendChild(o);
      });
  }

  document.getElementById('selectSerialNo').addEventListener('change', ()=>{
    const id = document.getElementById('selectSerialNo').value;
    const d = anomalyData.find(it=> String(it.id)===String(id));
    const wrap = document.getElementById('displayContent');
    const box = document.getElementById('selectedDataDisplay');

    if (!d){ box.style.display='none'; wrap.innerHTML=''; return; }

    wrap.innerHTML = `
      <div style="display:grid;gap:10px;">
        <div><strong>æ•´ç†Noï¼ˆå“ç•ªï¼‰:</strong> ${d.serialNo}</div>
        ${d.department?`<div><strong>éƒ¨ç½²:</strong> ${d.department}</div>`:''}
        ${d.lineName?`<div><strong>ãƒ©ã‚¤ãƒ³å:</strong> ${d.lineName}</div>`:''}
        <div><strong>ç•°å¸¸å†…å®¹:</strong> ${d.anomalyContent}</div>
        <div><strong>è£½é€ å‡¦ç½®:</strong> ${d.actionTaken}</div>
        <div><strong>ç™ºç”Ÿæ—¥:</strong> ${d.occurrenceDate}</div>
        <div><strong>å‡¦ç½®è€…:</strong> ${d.handler}</div>
      </div>
    `;
    box.style.display='block';
  });

  document.getElementById('technicalForm').addEventListener('submit',(e)=>{
    e.preventDefault();
    const id = document.getElementById('selectSerialNo').value;
    const ix = anomalyData.findIndex(it=> String(it.id)===String(id));
    if (ix<0){ alert('å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

    const tgt = anomalyData[ix];
    tgt.techHandler = document.getElementById('techHandler').value;
    tgt.lifespan = document.getElementById('lifespan').value;
    tgt.maintenanceUnit = document.getElementById('maintenanceUnit').value;
    tgt.rootCauseAction = document.getElementById('rootCauseAction').value;
    tgt.recurrenceType = document.getElementById('recurrenceType').value;
    tgt.techPhotos = [...techPhotos];
    // æŠ€è¡“è¦è«‹ã ã£ãŸæ¡ˆä»¶ãŒæŠ€è¡“å…¥åŠ›ã§å®Œäº†
    tgt.status = 'complete';
    tgt.completedAt = new Date().toISOString();

    saveData();
    e.target.reset();
    techPhotos=[];
    document.getElementById('techPhotoPreview').innerHTML='';
    document.getElementById('selectedDataDisplay').style.display='none';
    updateSerialNoSelect();
    updateHistory();
    alert('æŠ€è¡“å…¥åŠ›ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚');
  });

  // ==== å±¥æ­´æç”» ====
  function cardStatus(item){
    if (item.status==='pending') return {text:'æŠ€è¡“å…¥åŠ›å¾…ã¡', cls:'status-pending'};
    if (item.status==='complete' && item.techRequest==='å®Œçµ') return {text:'å®Œäº†ï¼ˆè£½é€ å®Œçµï¼‰', cls:'status-complete'};
    return {text:'å®Œäº†', cls:'status-complete'};
  }

  function updateHistory(){
    if (currentView==='card') updateCardView(); else updateTableView();
  }

  function updateCardView(){
    const wrap = document.getElementById('cardView');
    if (!anomalyData.length){
      wrap.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;
      return;
    }
    wrap.innerHTML = anomalyData.map((item,idx)=>{
      const st = cardStatus(item);
      return `
        <div class="anomaly-card ${item.status==='complete'?'complete':''}">
          <div class="card-header">
            <div class="card-id">${item.serialNo}</div>
            <div class="card-status ${st.cls}">${st.text}</div>
          </div>
          <div class="card-body">
            ${item.department?`<div class="card-field"><div class="field-label">éƒ¨ç½²</div><div class="field-value">${item.department}</div></div>`:''}
            ${item.lineName?`<div class="card-field"><div class="field-label">ãƒ©ã‚¤ãƒ³å</div><div class="field-value">${item.lineName}</div></div>`:''}
            ${item.techRequest?`<div class="card-field"><div class="field-label">æŠ€è¡“è¦è«‹</div><div class="field-value">${item.techRequest==='è¦è«‹'?'æŠ€è¡“è¦è«‹ã‚ã‚Š':'è£½é€ ã§å®Œçµ'}</div></div>`:''}
            <div class="card-field"><div class="field-label">ç•°å¸¸å†…å®¹</div><div class="field-value">${item.anomalyContent}</div></div>
            <div class="card-field"><div class="field-label">è£½é€ å‡¦ç½®</div><div class="field-value">${item.actionTaken}</div></div>
            <div class="card-field"><div class="field-label">ç™ºç”Ÿæ—¥æ™‚</div><div class="field-value">${item.occurrenceDate} ${item.occurrenceTime||''}</div></div>
            <div class="card-field"><div class="field-label">å‡¦ç½®è€…</div><div class="field-value">${item.handler}</div></div>
            ${item.status==='complete' && item.techRequest==='è¦è«‹' ? `
              <div class="card-field"><div class="field-label">æŠ€è¡“å‡¦ç½®è€…</div><div class="field-value">${item.techHandler||'-'}</div></div>
              <div class="card-field"><div class="field-label">ä¿å…¨å˜ä½</div><div class="field-value">${item.maintenanceUnit||'-'}</div></div>
              <div class="card-field"><div class="field-label">åŸå› ãƒ»å¯¾ç­–</div><div class="field-value">${item.rootCauseAction||'-'}</div></div>
              <div class="card-field"><div class="field-label">å†ç™º/æ–°è¦</div><div class="field-value">${item.recurrenceType||'-'}</div></div>
            `:''}
            <div class="action-btns" style="margin-top:10px;">
              <button class="btn-small btn-edit" data-edit="${item.id}">ç·¨é›†</button>
              <button class="btn-small btn-delete" data-del="${item.id}" data-idx="${idx}">å‰Šé™¤</button>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function updateTableView(){
    const wrap = document.getElementById('tableView');
    if (!anomalyData.length){
      wrap.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;
      return;
    }
    wrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>æ•´ç†No</th><th>éƒ¨ç½²</th><th>ãƒ©ã‚¤ãƒ³</th><th>ç•°å¸¸å†…å®¹</th>
            <th>ç™ºç”Ÿæ—¥</th><th>å‡¦ç½®è€…</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          ${anomalyData.map((it,idx)=>{
            const st = it.status==='complete'?'å®Œäº†':'å¾…ã¡';
            const cls = it.status==='complete'?'status-complete':'status-pending';
            return `
              <tr>
                <td>${it.serialNo}</td>
                <td>${it.department||'-'}</td>
                <td>${it.lineName||'-'}</td>
                <td>${(it.anomalyContent||'').substring(0,30)}...</td>
                <td>${it.occurrenceDate}</td>
                <td>${it.handler||'-'}</td>
                <td><span class="card-status ${cls}">${st}</span></td>
                <td class="action-btns">
                  <button class="btn-small btn-edit" data-edit="${it.id}">ç·¨é›†</button>
                  <button class="btn-small btn-delete" data-del="${it.id}" data-idx="${idx}">å‰Šé™¤</button>
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    `;
  }

  // ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿
  document.querySelectorAll('.view-toggle button').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.view-toggle button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      currentView = b.dataset.view;
      document.getElementById('cardView').style.display = currentView==='card'?'grid':'none';
      document.getElementById('tableView').style.display = currentView==='table'?'block':'none';
      updateHistory();
    });
  });

  // ==== ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ====
  function openEditModal(id){
    editingId = id;
    const rec = anomalyData.find(x=> String(x.id)===String(id));
    if (!rec){ alert('å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

    // è£½é€ ãƒ‘ãƒ¼ãƒˆã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³æº–å‚™
    fillDeptLineHandlerForEdit(rec);

    // å€¤ã‚»ãƒƒãƒˆï¼ˆè£½é€ ï¼‰
    document.getElementById('edit_occurrenceDate').value = rec.occurrenceDate || '';
    document.getElementById('edit_occurrenceTime').value = rec.occurrenceTime || '';
    document.getElementById('edit_restartTime').value   = rec.restartTime || '';
    document.getElementById('edit_serialNo').value      = rec.serialNo || '';
    document.getElementById('edit_anomalyContent').value= rec.anomalyContent || '';
    document.getElementById('edit_actionTaken').value   = rec.actionTaken || '';
    document.getElementById('edit_traceback').value     = rec.traceback || '';
    document.getElementById('edit_techRequest').value   = rec.techRequest || '';

    // å€¤ã‚»ãƒƒãƒˆï¼ˆæŠ€è¡“ï¼‰
    document.getElementById('edit_techHandler').value     = rec.techHandler || '';
    document.getElementById('edit_lifespan').value        = rec.lifespan || '';
    document.getElementById('edit_maintenanceUnit').value = rec.maintenanceUnit || '';
    document.getElementById('edit_rootCauseAction').value = rec.rootCauseAction || '';
    document.getElementById('edit_recurrenceType').value  = rec.recurrenceType || '';

    // ã‚¿ãƒ–çŠ¶æ…‹
    document.querySelectorAll('.edit-tab').forEach(t=>t.classList.remove('active'));
    document.querySelector('.edit-tab[data-edit-tab="mfg"]').classList.add('active');
    document.getElementById('editMfg').style.display='block';
    document.getElementById('editTech').style.display='none';

    document.getElementById('editModal').classList.add('active');
    document.getElementById('editModal').setAttribute('aria-hidden','false');
  }

  function fillDeptLineHandlerForEdit(rec){
    const depSel = document.getElementById('edit_department');
    depSel.innerHTML = '';
    masterData.departments.forEach(d=>{
      const o = document.createElement('option'); o.value=o.textContent=d; depSel.appendChild(o);
    });
    depSel.value = rec.department || '';

    // ãƒ©ã‚¤ãƒ³ãƒ»å‡¦ç½®è€…
    const lineSel = document.getElementById('edit_lineName');
    const hSel = document.getElementById('edit_handler');
    lineSel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    hSel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    (masterData.lines[depSel.value]||[]).forEach(l=>{ const o=document.createElement('option');o.value=o.textContent=l; lineSel.appendChild(o); });
    (masterData.handlers[depSel.value]||[]).forEach(h=>{ const o=document.createElement('option');o.value=o.textContent=h; hSel.appendChild(o); });

    lineSel.value = rec.lineName || '';
    hSel.value = rec.handler || '';
  }

  // ç·¨é›†ã‚¿ãƒ–åˆ‡æ›¿
  document.querySelectorAll('.edit-tab').forEach(t=>{
    t.addEventListener('click', ()=>{
      document.querySelectorAll('.edit-tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const which = t.dataset.editTab;
      document.getElementById('editMfg').style.display = (which==='mfg')?'block':'none';
      document.getElementById('editTech').style.display= (which==='tech')?'block':'none';
    });
  });

  // ç·¨é›†å†…ï¼šéƒ¨ç½²å¤‰æ›´
  document.getElementById('edit_department').addEventListener('change', ()=>{
    const dep = document.getElementById('edit_department').value;
    const lineSel = document.getElementById('edit_lineName');
    const hSel = document.getElementById('edit_handler');
    lineSel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    hSel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    (masterData.lines[dep]||[]).forEach(l=>{ const o=document.createElement('option'); o.value=o.textContent=l; lineSel.appendChild(o); });
    (masterData.handlers[dep]||[]).forEach(h=>{ const o=document.createElement('option'); o.value=o.textContent=h; hSel.appendChild(o); });
  });

  // ä¿å­˜
  document.getElementById('btnEditSave').addEventListener('click', ()=>{
    if (editingId==null) return;
    const ix = anomalyData.findIndex(x=> String(x.id)===String(editingId));
    if (ix<0){ alert('å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

    const rec = anomalyData[ix];

    // è£½é€ 
    rec.occurrenceDate  = document.getElementById('edit_occurrenceDate').value || rec.occurrenceDate;
    rec.occurrenceTime  = document.getElementById('edit_occurrenceTime').value || '';
    rec.restartTime     = document.getElementById('edit_restartTime').value || '';
    rec.department      = document.getElementById('edit_department').value || '';
    rec.lineName        = document.getElementById('edit_lineName').value || '';
    rec.handler         = document.getElementById('edit_handler').value || '';
    rec.serialNo        = document.getElementById('edit_serialNo').value || rec.serialNo;
    rec.anomalyContent  = document.getElementById('edit_anomalyContent').value || '';
    rec.actionTaken     = document.getElementById('edit_actionTaken').value || '';
    rec.traceback       = document.getElementById('edit_traceback').value || '';
    rec.techRequest     = document.getElementById('edit_techRequest').value || rec.techRequest;

    // æŠ€è¡“
    rec.techHandler     = document.getElementById('edit_techHandler').value || '';
    rec.lifespan        = document.getElementById('edit_lifespan').value || '';
    rec.maintenanceUnit = document.getElementById('edit_maintenanceUnit').value || '';
    rec.rootCauseAction = document.getElementById('edit_rootCauseAction').value || '';
    rec.recurrenceType  = document.getElementById('edit_recurrenceType').value || '';

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ•´åˆ
    if (rec.techRequest==='å®Œçµ'){
      rec.status = 'complete';
    }else{
      // è¦è«‹ï¼šæŠ€è¡“å´ä¸»è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã„ãšã‚Œã‹ãŒå…¥ã£ã¦ã„ã‚Œã°å®Œäº†æ‰±ã„
      const hasTech = (rec.techHandler||rec.lifespan||rec.maintenanceUnit||rec.rootCauseAction||rec.recurrenceType);
      rec.status = hasTech ? 'complete' : 'pending';
    }

    saveData();
    closeEditModal();
    updateHistory();
    updateSerialNoSelect();
    alert('æ›´æ–°ã—ã¾ã—ãŸã€‚');
  });

  function closeEditModal(){
    editingId = null;
    document.getElementById('editModal').classList.remove('active');
    document.getElementById('editModal').setAttribute('aria-hidden','true');
  }
  document.getElementById('btnEditCancel').addEventListener('click', closeEditModal);

  // å±¥æ­´ï¼šç·¨é›†ï¼å‰Šé™¤ ã‚¯ãƒªãƒƒã‚¯å§”è­²
  document.addEventListener('click', (e)=>{
    const ed = e.target.closest('button.btn-edit[data-edit]');
    if (ed){ openEditModal(ed.getAttribute('data-edit')); return; }
    const del = e.target.closest('button.btn-delete[data-del]');
    if (del){
      const id = del.getAttribute('data-del');
      const idx = Number(del.getAttribute('data-idx'));
      if (!confirm('ã“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
      const before = anomalyData.length;
      anomalyData = anomalyData.filter(x=> String(x.id)!==String(id));
      if (anomalyData.length===before && !Number.isNaN(idx)) anomalyData.splice(idx,1);
      saveData(); updateHistory(); updateSerialNoSelect();
      return;
    }
  });

  // CSVå‡ºåŠ›ï¼ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  document.getElementById('btnExport').addEventListener('click', ()=>{
    if (!anomalyData.length){ alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const headers = ['æ•´ç†No','éƒ¨ç½²','ãƒ©ã‚¤ãƒ³å','ç™ºç”Ÿæ—¥','ç™ºç”Ÿæ™‚åˆ»','å†é–‹æ™‚åˆ»','ç•°å¸¸å†…å®¹','è£½é€ å‡¦ç½®å†…å®¹','é¡ã‚Š','å‡¦ç½®è€…','æŠ€è¡“è¦è«‹','æŠ€è¡“å‡¦ç½®è€…','å‘½æ•°æœ‰ç„¡','ä¿å…¨å˜ä½','åŸå› å¯¾ç­–','å†ç™ºæ–°è¦','çŠ¶æ…‹','id'];
    const rows = anomalyData.map(item=>[
      item.serialNo,item.department||'',item.lineName||'',item.occurrenceDate,item.occurrenceTime||'',item.restartTime||'',
      item.anomalyContent,item.actionTaken,item.traceback,item.handler,
      item.techRequest==='è¦è«‹'?'æŠ€è¡“è¦è«‹ã‚ã‚Š':item.techRequest==='å®Œçµ'?'è£½é€ ã§å®Œçµ':'',
      item.techHandler||'',item.lifespan||'',item.maintenanceUnit||'',item.rootCauseAction||'',item.recurrenceType||'',
      item.status==='complete'?'å®Œäº†':'æŠ€è¡“å…¥åŠ›å¾…ã¡', item.id
    ]);
    let csv = '\uFEFF' + headers.join(',') + '\n';
    rows.forEach(r=>{ csv += r.map(c=>`"${(c??'').toString().replace(/"/g,'""')}"`).join(',')+'\n'; });
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download=`ç•°å¸¸å±¥æ­´_${new Date().toISOString().split('T')[0]}.csv`; a.click();
  });

  document.getElementById('btnImport').addEventListener('click', ()=> document.getElementById('csvImport').click());
  document.getElementById('csvImport').addEventListener('change', (event)=>{
    const file = event.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      try{
        const text = ev.target.result;
        const lines = text.split('\n').filter(l=>l.trim());
        if (lines.length<2){ alert('CSVãŒç©ºã§ã™'); return; }
        const dataLines = lines.slice(1);
        let cnt=0;
        dataLines.forEach((line,i)=>{
          const vals = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)?.map(v=>v.replace(/^"|"$/g,'').replace(/""/g,'"')) || [];
          if (vals.length>=17){
            let techRequest = '';
            if (vals[10]==='æŠ€è¡“è¦è«‹ã‚ã‚Š') techRequest = 'è¦è«‹';
            else if (vals[10]==='è£½é€ ã§å®Œçµ') techRequest = 'å®Œçµ';
            const idv = vals[17] || (Date.now()+i);
            const rec = {
              id:idv, serialNo:vals[0], department:vals[1]||'', lineName:vals[2]||'',
              occurrenceDate:vals[3], occurrenceTime:vals[4]||'', restartTime:vals[5]||'',
              anomalyContent:vals[6], actionTaken:vals[7], traceback:vals[8], handler:vals[9],
              techRequest, techHandler:vals[11]||'', lifespan:vals[12]||'', maintenanceUnit:vals[13]||'',
              rootCauseAction:vals[14]||'', recurrenceType:vals[15]||'',
              status: vals[16]==='å®Œäº†'?'complete':'pending', mfgPhotos:[], techPhotos:[], createdAt:new Date().toISOString()
            };
            anomalyData.push(rec); cnt++;
          }
        });
        saveData(); updateHistory(); updateSerialNoSelect();
        alert(`${cnt}ä»¶ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
      }catch(err){ console.error(err); alert('CSVèª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
      event.target.value='';
    };
    reader.readAsText(file, 'UTF-8');
  });

  // ==== ç®¡ç†ï¼šéƒ¨ç½²/ãƒ©ã‚¤ãƒ³/å‡¦ç½®è€… ====
  function updateDepartmentList(){
    const list = document.getElementById('departmentList');
    list.innerHTML='';
    if (!masterData.departments.length){
      list.innerHTML='<p style="color:#999;text-align:center;">éƒ¨ç½²ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; return;
    }
    masterData.departments.forEach(dept=>{
      const div = document.createElement('div');
      div.className='master-item';
      div.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:12px 15px;background:#f8f9fa;border-radius:6px;border-left:3px solid #667eea;';
      div.innerHTML = `<span class="master-item-name" style="font-weight:500;color:#333">${dept}</span>
        <button class="btn-small btn-delete" data-del-dept="${dept}">å‰Šé™¤</button>`;
      list.appendChild(div);
    });
  }
  document.getElementById('btnAddDept').addEventListener('click', ()=>{
    const input = document.getElementById('newDepartment');
    const name = (input.value||'').trim();
    if (!name){ alert('éƒ¨ç½²åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    if (masterData.departments.includes(name)){ alert('æ—¢ã«ç™»éŒ²æ¸ˆã§ã™'); return; }
    masterData.departments.push(name);
    masterData.lines[name]=[]; masterData.handlers[name]=[];
    saveMaster(); updateAllDepartmentSelects(); input.value='';
  });
  document.addEventListener('click', (e)=>{
    const del = e.target.closest('button[data-del-dept]');
    if (!del) return;
    const name = del.getAttribute('data-del-dept');
    if (!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ é–¢é€£ãƒ©ã‚¤ãƒ³/å‡¦ç½®è€…ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) return;
    masterData.departments = masterData.departments.filter(d=>d!==name);
    delete masterData.lines[name]; delete masterData.handlers[name];
    saveMaster(); updateAllDepartmentSelects();
  });

  function updateLineManageList(){
    const dept = document.getElementById('lineManageDept').value;
    const list = document.getElementById('lineList');
    list.innerHTML='';
    if (!dept){ list.innerHTML='<p style="color:#999;text-align:center;">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</p>'; return; }
    const arr = masterData.lines[dept]||[];
    if (!arr.length){ list.innerHTML='<p style="color:#999;text-align:center;">ãƒ©ã‚¤ãƒ³åãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; return; }
    arr.forEach(line=>{
      const div = document.createElement('div');
      div.className='master-item';
      div.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:12px 15px;background:#f8f9fa;border-radius:6px;border-left:3px solid #f57c00;';
      div.innerHTML = `<span class="master-item-name" style="font-weight:500;color:#333">${line}</span>
        <button class="btn-small btn-delete" data-del-line="${line}" data-dept="${dept}">å‰Šé™¤</button>`;
      list.appendChild(div);
    });
  }
  document.getElementById('lineManageDept').addEventListener('change', updateLineManageList);
  document.getElementById('btnAddLine').addEventListener('click', ()=>{
    const dept = document.getElementById('lineManageDept').value;
    const name = (document.getElementById('newLine').value||'').trim();
    if (!dept){ alert('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    if (!name){ alert('ãƒ©ã‚¤ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    if (!masterData.lines[dept]) masterData.lines[dept]=[];
    if (masterData.lines[dept].includes(name)){ alert('æ—¢ã«ç™»éŒ²æ¸ˆã§ã™'); return; }
    masterData.lines[dept].push(name); saveMaster(); updateLineManageList(); document.getElementById('newLine').value='';
  });
  document.addEventListener('click', (e)=>{
    const del = e.target.closest('button[data-del-line]');
    if (!del) return;
    const line = del.getAttribute('data-del-line'); const dept = del.getAttribute('data-dept');
    if (!confirm(`ã€Œ${line}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    masterData.lines[dept] = (masterData.lines[dept]||[]).filter(l=>l!==line);
    saveMaster(); updateLineManageList();
  });

  function updateHandlerManageList(){
    const dept = document.getElementById('handlerManageDept').value;
    const list = document.getElementById('handlerList');
    list.innerHTML='';
    if (!dept){ list.innerHTML='<p style="color:#999;text-align:center;">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</p>'; return; }
    const arr = masterData.handlers[dept]||[];
    if (!arr.length){ list.innerHTML='<p style="color:#999;text-align:center;">å‡¦ç½®è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; return; }
    arr.forEach(h=>{
      const div = document.createElement('div');
      div.className='master-item';
      div.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:12px 15px;background:#f8f9fa;border-radius:6px;border-left:3px solid #2e7d32;';
      div.innerHTML = `<span class="master-item-name" style="font-weight:500;color:#333">${h}</span>
        <button class="btn-small btn-delete" data-del-handler="${h}" data-dept="${dept}">å‰Šé™¤</button>`;
      list.appendChild(div);
    });
  }
  document.getElementById('handlerManageDept').addEventListener('change', updateHandlerManageList);
  document.getElementById('btnAddHandler').addEventListener('click', ()=>{
    const dept = document.getElementById('handlerManageDept').value;
    const name = (document.getElementById('newHandler').value||'').trim();
    if (!dept){ alert('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    if (!name){ alert('å‡¦ç½®è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    if (!masterData.handlers[dept]) masterData.handlers[dept]=[];
    if (masterData.handlers[dept].includes(name)){ alert('æ—¢ã«ç™»éŒ²æ¸ˆã§ã™'); return; }
    masterData.handlers[dept].push(name); saveMaster(); updateHandlerManageList(); document.getElementById('newHandler').value='';
  });
  document.addEventListener('click', (e)=>{
    const del = e.target.closest('button[data-del-handler]');
    if (!del) return;
    const h = del.getAttribute('data-del-handler'); const dept = del.getAttribute('data-dept');
    if (!confirm(`ã€Œ${h}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    masterData.handlers[dept] = (masterData.handlers[dept]||[]).filter(x=>x!==h);
    saveMaster(); updateHandlerManageList();
  });

  // ==== åˆ†æ ====
  function updateAnalysis(){ updateStatistics(); updateTrendAnalysis(); updateDepartmentAnalysis(); updateRecurrenceAnalysis(); }
  function updateStatistics(){
    const total = anomalyData.length;
    const completed = anomalyData.filter(x=>x.status==='complete').length;
    const pending = total - completed;
    const now = new Date();
    const thisMonth = anomalyData.filter(x=>{
      const d=new Date(x.occurrenceDate); return d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear();
    }).length;
    let avg=0, cnt=0;
    anomalyData.forEach(x=>{
      if (x.occurrenceTime && x.restartTime){
        const [oh,om]=x.occurrenceTime.split(':').map(Number);
        const [rh,rm]=x.restartTime.split(':').map(Number);
        let m=(rh*60+rm)-(oh*60+om); if (m<0) m+=1440;
        avg+=m; cnt++;
      }
    });
    avg = cnt?Math.round(avg/cnt):0;
    const stats = document.getElementById('statisticsDisplay');
    stats.innerHTML = `
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
        <div class="stat-card" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;border-radius:8px;text-align:center;">
          <h4 style="font-size:.9rem;margin-bottom:10px;opacity:.9;">ç·ç•°å¸¸ä»¶æ•°</h4>
          <div style="font-size:2.5rem;font-weight:bold;margin-bottom:5px;">${total}</div>
          <div style="font-size:.85rem;opacity:.8;">ä»¶</div>
        </div>
        <div class="stat-card" style="background:linear-gradient(135deg,#2e7d32 0%,#66bb6a 100%);color:#fff;padding:20px;border-radius:8px;text-align:center;">
          <h4 style="font-size:.9rem;margin-bottom:10px;opacity:.9;">å¯¾å¿œå®Œäº†</h4>
          <div style="font-size:2.5rem;font-weight:bold;margin-bottom:5px;">${completed}</div>
          <div style="font-size:.85rem;opacity:.8;">ä»¶ (${total?Math.round(completed/total*100):0}%)</div>
        </div>
        <div class="stat-card" style="background:linear-gradient(135deg,#f57c00 0%,#ffb74d 100%);color:#fff;padding:20px;border-radius:8px;text-align:center;">
          <h4 style="font-size:.9rem;margin-bottom:10px;opacity:.9;">å¯¾å¿œå¾…ã¡</h4>
          <div style="font-size:2.5rem;font-weight:bold;margin-bottom:5px;">${pending}</div>
          <div style="font-size:.85rem;opacity:.8;">ä»¶</div>
        </div>
        <div class="stat-card" style="background:linear-gradient(135deg,#c62828 0%,#ef5350 100%);color:#fff;padding:20px;border-radius:8px;text-align:center;">
          <h4 style="font-size:.9rem;margin-bottom:10px;opacity:.9;">ä»Šæœˆã®ç•°å¸¸</h4>
          <div style="font-size:2.5rem;font-weight:bold;margin-bottom:5px;">${thisMonth}</div>
          <div style="font-size:.85rem;opacity:.8;">ä»¶</div>
        </div>
        <div class="stat-card" style="background:linear-gradient(135deg,#1976d2 0%,#42a5f5 100%);color:#fff;padding:20px;border-radius:8px;text-align:center;">
          <h4 style="font-size:.9rem;margin-bottom:10px;opacity:.9;">å¹³å‡å¯¾å¿œæ™‚é–“</h4>
          <div style="font-size:2.5rem;font-weight:bold;margin-bottom:5px;">${avg}</div>
          <div style="font-size:.85rem;opacity:.8;">åˆ†</div>
        </div>
      </div>
    `;
  }
  function updateTrendAnalysis(){
    const monthly = {};
    anomalyData.forEach(x=>{
      const d=new Date(x.occurrenceDate);
      const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      monthly[k]=(monthly[k]||0)+1;
    });
    const months = Object.keys(monthly).sort();
    const max = Math.max(...Object.values(monthly),1);
    const chart = document.getElementById('trendChart');
    chart.innerHTML = months.map(m=>{
      const c = monthly[m]; const pct = (c/max)*100;
      return `
        <div style="margin-bottom:15px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
            <span style="font-weight:bold;">${m}</span><span style="color:#666;">${c}ä»¶</span>
          </div>
          <div style="background:#e0e0e0;height:30px;border-radius:4px;overflow:hidden;">
            <div style="background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);height:30px;width:${pct}%;display:flex;align-items:center;padding:0 10px;color:#fff;font-weight:bold;">${c}ä»¶</div>
          </div>
        </div>
      `;
    }).join('');
    const ana = document.getElementById('trendAnalysis');
    if (months.length>=3){
      const r3 = months.slice(-3).map(m=>monthly[m]);
      const avgR = r3.reduce((a,b)=>a+b,0)/3;
      const prev = months.slice(-6,-3).map(m=>monthly[m]);
      const avgP = prev.length? prev.reduce((a,b)=>a+b,0)/prev.length : avgR;
      let trend='æ¨ªã°ã„', cls='background:#fff3e0;color:#ef6c00;';
      if (avgR>avgP*1.2){ trend='å¢—åŠ å‚¾å‘'; cls='background:#ffebee;color:#c62828;'; }
      else if (avgR<avgP*0.8){ trend='æ¸›å°‘å‚¾å‘'; cls='background:#e8f5e9;color:#2e7d32;'; }
      ana.innerHTML = `<div style="border-left:4px solid #2196f3;padding:15px;border-radius:6px;background:#e3f2fd;">
        <strong>ğŸ“Š å‚¾å‘åˆ†æ:</strong> ç›´è¿‘3ãƒ¶æœˆå¹³å‡ <strong>${avgR.toFixed(1)}ä»¶/æœˆ</strong> â†’
        <span style="display:inline-block;padding:5px 15px;border-radius:20px;font-weight:bold;${cls}">${trend}</span>
      </div>`;
    }else{
      ana.innerHTML = '<p style="color:#999;">ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã®ãŸã‚å‚¾å‘åˆ†æã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“</p>';
    }
  }
  function updateDepartmentAnalysis(){
    const dept={}, line={};
    anomalyData.forEach(x=>{
      if (x.department) dept[x.department]=(dept[x.department]||0)+1;
      if (x.lineName) line[x.lineName]=(line[x.lineName]||0)+1;
    });
    const maxD = Math.max(...Object.values(dept),1);
    const maxL = Math.max(...Object.values(line),1);
    const div = document.getElementById('departmentAnalysis');
    let html = '<h4 style="color:#666;margin-bottom:10px;">éƒ¨ç½²åˆ¥ç•°å¸¸ä»¶æ•°</h4>';
    Object.entries(dept).sort((a,b)=>b[1]-a[1]).forEach(([k,c])=>{
      const pct=(c/maxD)*100;
      html += `<div style="margin-bottom:10px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;"><span>${k}</span><span style="color:#666;">${c}ä»¶</span></div>
        <div style="background:#e0e0e0;height:25px;border-radius:4px;overflow:hidden;">
          <div style="background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);height:25px;width:${pct}%;font-size:.85rem;color:#fff;display:flex;align-items:center;padding:0 8px;">${c}ä»¶</div>
        </div>
      </div>`;
    });
    html += '<h4 style="color:#666;margin:20px 0 10px;">ãƒ©ã‚¤ãƒ³åˆ¥ç•°å¸¸ä»¶æ•°</h4>';
    Object.entries(line).sort((a,b)=>b[1]-a[1]).forEach(([k,c])=>{
      const pct=(c/maxL)*100;
      html += `<div style="margin-bottom:10px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;"><span>${k}</span><span style="color:#666;">${c}ä»¶</span></div>
        <div style="background:#e0e0e0;height:25px;border-radius:4px;overflow:hidden;">
          <div style="background:linear-gradient(90deg,#f57c00 0%,#ffb74d 100%);height:25px;width:${pct}%;font-size:.85rem;color:#fff;display:flex;align-items:center;padding:0 8px;">${c}ä»¶</div>
        </div>
      </div>`;
    });
    div.innerHTML = html || '<p style="color:#999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
  }
  function updateRecurrenceAnalysis(){
    const recCnt = anomalyData.filter(x=>x.recurrenceType==='å†ç™º').length;
    const newCnt = anomalyData.filter(x=>x.recurrenceType==='æ–°è¦').length;
    const total = recCnt+newCnt;
    const div = document.getElementById('recurrenceAnalysis');
    if (!total){ div.innerHTML='<p style="color:#999;">æŠ€è¡“å¯¾å¿œæ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>'; return; }
    const rate = (recCnt/total*100).toFixed(1);
    div.innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
        <div style="text-align:center;padding:20px;background:#ffebee;border-radius:8px;">
          <div style="font-size:3rem;font-weight:bold;color:#c62828;">${recCnt}</div>
          <div style="color:#666;margin-top:5px;">å†ç™ºä»¶æ•°</div>
        </div>
        <div style="text-align:center;padding:20px;background:#e8f5e9;border-radius:8px;">
          <div style="font-size:3rem;font-weight:bold;color:#2e7d32;">${newCnt}</div>
          <div style="color:#666;margin-top:5px;">æ–°è¦ä»¶æ•°</div>
        </div>
      </div>
      <div style="border-left:4px solid #2196f3;padding:15px;border-radius:6px;background:#e3f2fd;">
        <strong>ğŸ”„ å†ç™ºç‡:</strong> ${rate}% (${recCnt}/${total}ä»¶)
        ${rate>30 ? '<br>âš ï¸ å†ç™ºç‡ãŒé«˜ã‚ã§ã™ã€‚æ ¹æœ¬åŸå› ã®è¿½æ±‚ã¨æ’ä¹…å¯¾ç­–ãŒå¿…è¦ã§ã™ã€‚' : ''}
        ${rate<20 ? '<br>âœ… å†ç™ºç‡ã¯è‰¯å¥½ã§ã™ã€‚ç¾åœ¨ã®å¯¾ç­–ã‚’ç¶™ç¶šã—ã¾ã—ã‚‡ã†ã€‚' : ''}
      </div>
    `;
  }

  // ==== èµ·å‹•æ™‚å‡¦ç† ====
  document.addEventListener('DOMContentLoaded', ()=>{
    // è£½é€ ï¼šéƒ¨ç½²ã‚»ãƒ¬ã‚¯ãƒˆåˆæœŸåŒ–
    updateDepartmentSelect('department');
    // åˆæœŸæ—¥ä»˜ã‚»ãƒƒãƒˆ
    setNowDateTo('occurrenceDate');
    // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆæœŸåŒ–æ¸ˆ

    loadData();
  });
</script>
</body>
</html>