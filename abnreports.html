<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>出荷作業 異常履歴管理（RTDB版）</title>
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --ink:#1f2937; --muted:#6b7280;
    --brand:#6366f1; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --b:#e5e7eb;
  }
  *{ box-sizing:border-box }
  body{ margin:0; background:var(--bg); color:var(--ink); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,"Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif }
  .container{ max-width:1200px; margin:24px auto; padding:0 16px }
  .header{ background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,.12) }
  .grid{ display:grid; gap:16px }
  @media(min-width:980px){ .grid-2{ grid-template-columns:1fr 1fr } .grid-3{ grid-template-columns:1fr 1fr 1fr } }
  .card{ background:var(--card); border:1px solid var(--b); border-radius:12px; box-shadow:0 1px 4px rgba(0,0,0,.04) }
  .card h3{ margin:0; padding:14px 16px; border-bottom:1px solid var(--b) }
  .card .body{ padding:14px 16px }
  label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px }
  input,select,textarea{ width:100%; padding:10px 12px; border:1px solid var(--b); border-radius:10px; background:#fff; font-size:14px }
  textarea{ min-height:80px; resize:vertical }
  .row{ display:grid; gap:10px; grid-template-columns:1fr 1fr }
  .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:10px; border:1px solid var(--b); background:#fff; cursor:pointer; font-weight:600 }
  .btn.brand{ background:var(--brand); color:#fff; border-color:transparent }
  .btn.ok{ background:var(--ok); color:#fff; border-color:transparent }
  .btn.bad{ background:var(--bad); color:#fff; border-color:transparent }
  .btn.small{ padding:6px 10px; font-size:12px }
  .list .item{ display:flex; gap:12px; padding:12px 10px; border-bottom:1px solid var(--b); align-items:flex-start }
  .pill{ display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--b); color:var(--muted) }
  .muted{ color:var(--muted) }
  .thumbs{ display:flex; gap:8px; flex-wrap:wrap }
  .thumbs img{ width:100px; height:100px; object-fit:cover; border-radius:8px; border:1px solid var(--b) }
  .toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:6px 0 12px }
  .right{ margin-left:auto }
  .hidden{ display:none !important }
  .danger{ color:var(--bad) }
  .hr{ height:1px; background:var(--b); margin:10px 0 }
  .footer-info{ font-size:12px; color:var(--muted); padding-top:8px }
  /* サインインモーダル */
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.4); display:flex; align-items:center; justify-content:center; z-index:50 }
  .modal .dialog{ width:min(420px,92vw); background:#fff; border-radius:12px; padding:20px; box-shadow:0 20px 60px rgba(0,0,0,.25) }
  .dialog h2{ margin:0 0 8px }
  .center{ text-align:center }
</style>
</head>
<body>
  <div id="authModal" class="modal">
    <div class="dialog">
      <h2>サインイン</h2>
      <p class="muted" style="margin:0 0 12px">メールアドレスとパスワードを入力してください。</p>
      <label>メール</label>
      <input id="email" type="email" placeholder="you@example.com"/>
      <label>パスワード</label>
      <input id="password" type="password" placeholder="••••••••"/>
      <div class="toolbar" style="margin-top:12px">
        <button id="btnSignIn" class="btn brand">サインイン</button>
        <button id="btnRegister" class="btn">新規登録</button>
        <span id="authMsg" class="muted"></span>
      </div>
    </div>
  </div>

  <div id="app" class="container hidden">
    <div class="header">
      <h1 style="margin:0 0 6px;">出荷作業 異常履歴管理（RTDB版）</h1>
      <div class="toolbar">
        <span id="loginInfo" class="pill">—</span>
        <span class="right"></span>
        <button id="btnSignOut" class="btn">サインアウト</button>
      </div>
    </div>

    <div class="grid grid-2" style="margin-top:16px">
      <!-- 製造入力 -->
      <div class="card">
        <h3>① 製造／現場入力</h3>
        <div class="body">
          <div class="row">
            <div>
              <label>部署</label>
              <select id="mfgDepartment"></select>
            </div>
            <div>
              <label>ライン</label>
              <select id="mfgLine"></select>
            </div>
          </div>
          <div class="row">
            <div>
              <label>発生日（YYYY-MM-DD HH:mm）</label>
              <input id="occurAt" type="datetime-local"/>
            </div>
            <div>
              <label>作業者</label>
              <input id="mfgOperator" placeholder="氏名"/>
            </div>
          </div>
          <label>異常分類</label>
          <select id="mfgCategory">
            <option value="品違い">品違い</option>
            <option value="数量違い">数量違い</option>
            <option value="ラベル不備">ラベル不備</option>
            <option value="作業ミス">作業ミス</option>
            <option value="その他">その他</option>
          </select>
          <label>異常内容（現象）</label>
          <textarea id="mfgDetail" placeholder="現象を簡潔に…"></textarea>
          <label>一次処置（現場）</label>
          <textarea id="mfgAction" placeholder="隔離、手直し、差し替え 等"></textarea>

          <label>写真（複数可／jpg,png）</label>
          <input id="mfgPhotos" type="file" accept="image/*" multiple/>

          <div class="toolbar" style="margin-top:10px">
            <button id="btnMfgSubmit" class="btn ok">登録</button>
            <span id="mfgMsg" class="muted"></span>
          </div>
        </div>
      </div>

      <!-- 技術入力 -->
      <div class="card">
        <h3>② 技術／品管 追記</h3>
        <div class="body">
          <div class="row">
            <div>
              <label>対象（履歴から選択）</label>
              <select id="techTarget"></select>
            </div>
            <div>
              <label>処置者</label>
              <select id="techHandler"></select>
            </div>
          </div>
          <label>原因（推定／確定）</label>
          <textarea id="techCause" placeholder="なぜ起きたか。4M・なぜなぜ等"></textarea>
          <label>恒久対策／横展</label>
          <textarea id="techCounter" placeholder="対策、再発防止、横展先 等"></textarea>

          <label>写真追加</label>
          <input id="techPhotos" type="file" accept="image/*" multiple/>

          <div class="toolbar" style="margin-top:10px">
            <button id="btnTechUpdate" class="btn brand">更新</button>
            <span id="techMsg" class="muted"></span>
          </div>
        </div>
      </div>

      <!-- マスタ管理 -->
      <div class="card">
        <h3>③ マスタ管理</h3>
        <div class="body">
          <div class="grid grid-3">
            <div>
              <label>部署 追加</label>
              <div class="row">
                <input id="newDepartment" placeholder="例：出荷"/>
                <button id="btnAddDept" class="btn small">追加</button>
              </div>
              <div id="departmentList" class="list" style="margin-top:8px"></div>
            </div>
            <div>
              <label>ライン 追加</label>
              <div class="row">
                <select id="lineDept"></select>
                <input id="newLine" placeholder="例：C1"/>
              </div>
              <div class="toolbar" style="margin-top:6px">
                <button id="btnAddLine" class="btn small">追加</button>
              </div>
              <div id="lineList" class="list" style="margin-top:8px"></div>
            </div>
            <div>
              <label>処置者 追加</label>
              <div class="row">
                <select id="handlerDept"></select>
                <input id="newHandler" placeholder="例：品質・中村"/>
              </div>
              <div class="toolbar" style="margin-top:6px">
                <button id="btnAddHandler" class="btn small">追加</button>
              </div>
              <div id="handlerList" class="list" style="margin-top:8px"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 履歴 -->
      <div class="card" style="grid-column:1/-1">
        <h3>④ 履歴</h3>
        <div class="body">
          <div class="toolbar">
            <input id="qText" placeholder="キーワード検索（現象・対策・原因）"/>
            <select id="qDept"></select>
            <select id="qCategory">
              <option value="">分類すべて</option>
              <option>品違い</option><option>数量違い</option><option>ラベル不備</option><option>作業ミス</option><option>その他</option>
            </select>
            <span class="right"></span>
            <button id="btnExport" class="btn">CSV出力</button>
          </div>
          <div id="history" class="list"></div>
          <div class="footer-info">最新50件を表示（検索条件により変動）</div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  // --- Firebase SDKs ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getDatabase, ref, child, get, set, push, update, remove, onValue, query, orderByChild, equalTo, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL, listAll, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

  // --- Firebase Config ---
  const firebaseConfig = {
    // TODO: あなたの firebaseConfig に置き換え
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_PROJECT.appspot.com",
    appId: "YOUR_APP_ID"
  };

  // --- Init ---
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const storage = getStorage(app);

  // --- Refs helper ---
  const R = {
    anomalies:      () => ref(db, "anomalies"),
    anomaly:        (id) => ref(db, `anomalies/${id}`),
    masters: {
      departments:  () => ref(db, "masters/department/items"),
      lines:        () => ref(db, "masters/line/items"),
      handlers:     () => ref(db, "masters/handler/items"),
    },
    storage: {
      anomalyFolder: (id, folder) => sRef(storage, `anomalies/${id}/${folder}`),
      anomalyFile:   (id, folder, filename) => sRef(storage, `anomalies/${id}/${folder}/${filename}`),
    }
  };

  // --- DOM ---
  const $ = (id)=>document.getElementById(id);
  const el = {
    authModal: $("authModal"), app: $("app"),
    email: $("email"), password:$("password"), btnSignIn:$("btnSignIn"), btnRegister:$("btnRegister"), btnSignOut:$("btnSignOut"), authMsg:$("authMsg"), loginInfo:$("loginInfo"),
    mfgDepartment:$("mfgDepartment"), mfgLine:$("mfgLine"), occurAt:$("occurAt"), mfgOperator:$("mfgOperator"), mfgCategory:$("mfgCategory"), mfgDetail:$("mfgDetail"), mfgAction:$("mfgAction"), mfgPhotos:$("mfgPhotos"), btnMfgSubmit:$("btnMfgSubmit"), mfgMsg:$("mfgMsg"),
    techTarget:$("techTarget"), techHandler:$("techHandler"), techCause:$("techCause"), techCounter:$("techCounter"), techPhotos:$("techPhotos"), btnTechUpdate:$("btnTechUpdate"), techMsg:$("techMsg"),
    newDepartment:$("newDepartment"), btnAddDept:$("btnAddDept"), departmentList:$("departmentList"),
    lineDept:$("lineDept"), newLine:$("newLine"), btnAddLine:$("btnAddLine"), lineList:$("lineList"),
    handlerDept:$("handlerDept"), newHandler:$("newHandler"), btnAddHandler:$("btnAddHandler"), handlerList:$("handlerList"),
    qText:$("qText"), qDept:$("qDept"), qCategory:$("qCategory"), history:$("history"), btnExport:$("btnExport")
  };

  // --- State ---
  let anomalyCache = []; // {_id, ...}
  let masters = { departments:[], linesByDept:{}, handlersByDept:{} };

  // --- Auth ---
  el.btnSignIn.addEventListener("click", async ()=>{
    el.authMsg.textContent = "サインイン中…";
    try{
      const cred = await signInWithEmailAndPassword(auth, el.email.value, el.password.value);
      el.authMsg.textContent = "OK";
    }catch(e){ el.authMsg.textContent = "サインイン失敗：" + e.message; }
  });
  el.btnRegister.addEventListener("click", async ()=>{
    el.authMsg.textContent = "登録中…";
    try{
      await createUserWithEmailAndPassword(auth, el.email.value, el.password.value);
      el.authMsg.textContent = "登録完了。続けてサインインしました。";
    }catch(e){ el.authMsg.textContent = "登録失敗：" + e.message; }
  });
  el.btnSignOut.addEventListener("click", async ()=>{ await signOut(auth); });

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      el.authModal.classList.add("hidden");
      el.app.classList.remove("hidden");
      el.loginInfo.textContent = user.email || user.uid;
      await boot();
    }else{
      el.app.classList.add("hidden");
      el.authModal.classList.remove("hidden");
      anomalyCache = [];
    }
  });

  // --- Boot (after auth) ---
  async function boot(){
    await loadMasters();
    bindMasterUI();
    subscribeAnomalies();
  }

  // --- Masters ---
  async function loadMasters(){
    const [dep, line, h] = await Promise.all([
      get(R.masters.departments()),
      get(R.masters.lines()),
      get(R.masters.handlers()),
    ]);
    const depObj = dep.val()||{};
    const lineObj= line.val()||{};
    const hObj   = h.val()  ||{};

    const departments = Object.entries(depObj).map(([id,v])=>({id, name:v.name})).sort((a,b)=>a.name.localeCompare(b.name));
    const linesByDept = {};
    Object.entries(lineObj).forEach(([id,v])=>{
      const d = v.department; (linesByDept[d] ||= []).push({id, name:v.name});
    });
    Object.keys(linesByDept).forEach(k=> linesByDept[k].sort((a,b)=>a.name.localeCompare(b.name)));

    const handlersByDept = {};
    Object.entries(hObj).forEach(([id,v])=>{
      const d = v.department; (handlersByDept[d] ||= []).push({id, name:v.name});
    });
    Object.keys(handlersByDept).forEach(k=> handlersByDept[k].sort((a,b)=>a.name.localeCompare(b.name)));

    masters = { departments, linesByDept, handlersByDept };

    // フォームへ反映
    fillSelect(el.mfgDepartment, departments.map(x=>x.name));
    fillSelect(el.lineDept,     departments.map(x=>x.name));
    fillSelect(el.handlerDept,  departments.map(x=>x.name));
    fillSelect(el.qDept,        ["部署すべて", ...departments.map(x=>x.name)]);

    onDeptChangeForLines();
    onDeptChangeForHandlers();
  }

  function fillSelect(sel, arr){
    const v = sel.value;
    sel.innerHTML = arr.map(s=>`<option>${escapeHtml(s)}</option>`).join("");
    if(arr.includes(v)) sel.value = v;
  }

  function onDeptChangeForLines(){
    const d = el.mfgDepartment.value;
    const arr = (masters.linesByDept[d]||[]).map(x=>x.name);
    fillSelect(el.mfgLine, arr);
    renderLineList(); // マスタ側
  }
  function onDeptChangeForHandlers(){
    const d = el.handlerDept.value;
    const arr = (masters.handlersByDept[d]||[]).map(x=>x.name);
    fillSelect(el.techHandler, arr);
    renderHandlerList();
  }

  el.mfgDepartment.addEventListener("change", onDeptChangeForLines);
  el.handlerDept.addEventListener("change", onDeptChangeForHandlers);
  el.lineDept.addEventListener("change", renderLineList);

  // 部署追加／削除
  el.btnAddDept.addEventListener("click", async ()=>{
    const name = (el.newDepartment.value||"").trim();
    if(!name) return;
    await set(push(R.masters.departments()), { name });
    el.newDepartment.value="";
    await loadMasters();
    renderDepartmentList();
  });
  function renderDepartmentList(){
    const list = masters.departments;
    el.departmentList.innerHTML = list.length
      ? list.map(d => rowDeletable(d.name, ()=>deleteDepartmentByName(d.name))).join("")
      : `<div class="muted">部署がありません</div>`;
  }
  async function deleteDepartmentByName(name){
    const snap = await get(R.masters.departments());
    const obj = snap.val()||{};
    const target = Object.entries(obj).find(([,v])=>v.name===name);
    if(!target) return;
    await remove(child(R.masters.departments(), target[0]));
    await loadMasters();
    renderDepartmentList();
  }

  // ライン追加／削除
  el.btnAddLine.addEventListener("click", async ()=>{
    const dep = el.lineDept.value;
    const name= (el.newLine.value||"").trim();
    if(!dep || !name) return;
    await set(push(R.masters.lines()), { department:dep, name });
    el.newLine.value="";
    await loadMasters();
    renderLineList();
  });
  function renderLineList(){
    const dep = el.lineDept.value;
    const arr = masters.linesByDept[dep]||[];
    el.lineList.innerHTML = arr.length
      ? arr.map(x=>rowDeletable(x.name, ()=>deleteLineByName(dep, x.name))).join("")
      : `<div class="muted">ラインがありません</div>`;
  }
  async function deleteLineByName(dep, name){
    const snap = await get(R.masters.lines());
    const obj = snap.val()||{};
    const hit = Object.entries(obj).find(([,v])=> v.department===dep && v.name===name);
    if(!hit) return;
    await remove(child(R.masters.lines(), hit[0]));
    await loadMasters();
    renderLineList();
  }

  // 処置者追加／削除
  el.btnAddHandler.addEventListener("click", async ()=>{
    const dep = el.handlerDept.value;
    const name= (el.newHandler.value||"").trim();
    if(!dep || !name) return;
    await set(push(R.masters.handlers()), { department:dep, name });
    el.newHandler.value="";
    await loadMasters();
    renderHandlerList();
  });
  function renderHandlerList(){
    const dep = el.handlerDept.value;
    const arr = masters.handlersByDept[dep]||[];
    el.handlerList.innerHTML = arr.length
      ? arr.map(x=>rowDeletable(x.name, ()=>deleteHandlerByName(dep, x.name))).join("")
      : `<div class="muted">処置者がありません</div>`;
  }
  async function deleteHandlerByName(dep, name){
    const snap = await get(R.masters.handlers());
    const obj = snap.val()||{};
    const hit = Object.entries(obj).find(([,v])=> v.department===dep && v.name===name);
    if(!hit) return;
    await remove(child(R.masters.handlers(), hit[0]));
    await loadMasters();
    renderHandlerList();
  }

  function rowDeletable(text, onDel){
    const id = "del_" + Math.random().toString(36).slice(2);
    queueMicrotask(()=>{ const b=document.getElementById(id); if(b) b.onclick=onDel; });
    return `<div class="item" style="justify-content:space-between;align-items:center">
      <div>${escapeHtml(text)}</div>
      <button id="${id}" class="btn small">削除</button>
    </div>`;
  }

  // --- Anomalies: subscribe ---
  function subscribeAnomalies(){
    onValue(R.anomalies(), (snap)=>{
      const obj = snap.val()||{};
      anomalyCache = Object.entries(obj).map(([id,v])=>({_id:id, ...v}));
      // 発生日時降順
      anomalyCache.sort((a,b)=> (b.occurrenceDate||"").localeCompare(a.occurrenceDate||""));
      renderHistory();
      renderTechTargetSelect();
    });
  }

  // --- Create (MFG submit) ---
  el.btnMfgSubmit.addEventListener("click", async ()=>{
    el.mfgMsg.textContent = "登録中…";
    try{
      const base = {
        department: el.mfgDepartment.value || "",
        line: el.mfgLine.value || "",
        operator: (el.mfgOperator.value||"").trim(),
        category: el.mfgCategory.value,
        detail: (el.mfgDetail.value||"").trim(),
        action: (el.mfgAction.value||"").trim(),
        occurrenceDate: el.occurAt.value || toLocalDateTimeInput(new Date()),
        status: "pending",
        techRequest: "要請",
        createdAt: serverTimestamp(),
        createdBy: (auth.currentUser && auth.currentUser.uid) || ""
      };
      const newRef = push(R.anomalies());
      const id = newRef.key;
      await set(newRef, base);

      // 写真アップロード
      const files = Array.from(el.mfgPhotos.files || []);
      if(files.length){
        const urls = await uploadPhotos(id, "mfg", files);
        await update(R.anomaly(id), { mfgPhotoUrls: urls });
      }

      el.mfgMsg.textContent = "登録しました";
      clearMfgForm();
    }catch(e){
      console.error(e);
      el.mfgMsg.textContent = "登録失敗：" + e.message;
    }
  });

  function clearMfgForm(){
    el.mfgOperator.value=""; el.mfgDetail.value=""; el.mfgAction.value="";
    el.mfgPhotos.value=""; el.occurAt.value="";
  }

  // --- Tech update ---
  el.btnTechUpdate.addEventListener("click", async ()=>{
    el.techMsg.textContent = "更新中…";
    try{
      const id = el.techTarget.value;
      if(!id){ el.techMsg.textContent="対象を選択してください"; return; }
      const updates = {
        handler: el.techHandler.value || "",
        cause: (el.techCause.value||"").trim(),
        counter: (el.techCounter.value||"").trim(),
        status: "closed",
        updatedAt: serverTimestamp(),
        updatedBy: (auth.currentUser && auth.currentUser.uid) || ""
      };
      await update(R.anomaly(id), updates);

      const files = Array.from(el.techPhotos.files || []);
      if(files.length){
        const urls = await uploadPhotos(id, "tech", files);
        const cur = (await get(R.anomaly(id))).val() || {};
        const merged = [ ...(cur.techPhotoUrls||[]), ...urls ];
        await update(R.anomaly(id), { techPhotoUrls: merged });
      }
      el.techMsg.textContent = "更新しました";
      el.techCause.value=""; el.techCounter.value=""; el.techPhotos.value="";
    }catch(e){
      el.techMsg.textContent = "更新失敗：" + e.message;
    }
  });

  function renderTechTargetSelect(){
    const options = anomalyCache
      .filter(x=> x.status!=="closed")
      .slice(0,100)
      .map(x=> `<option value="${x._id}">[${escapeHtml(x.department)}/${escapeHtml(x.line)}] ${escapeHtml(x.category)} ${escapeHtml((x.detail||"").slice(0,24))}</option>`);
    el.techTarget.innerHTML = `<option value="">未選択</option>` + options.join("");
  }

  // --- History ---
  function renderHistory(){
    const kw = (el.qText.value||"").trim().toLowerCase();
    const dept = (el.qDept.value||"部署すべて");
    const cat = el.qCategory.value || "";

    const filtered = anomalyCache.filter(x=>{
      const okDept = (dept==="部署すべて") || x.department===dept;
      const okCat  = !cat || x.category===cat;
      const text = [
        x.detail||"", x.action||"", x.cause||"", x.counter||"",
        x.department||"", x.line||"", x.operator||""
      ].join(" ").toLowerCase();
      const okKw = !kw || text.includes(kw);
      return okDept && okCat && okKw;
    }).slice(0,50);

    el.history.innerHTML = filtered.map(renderItem).join("") || `<div class="muted">該当なし</div>`;

    // 削除ボタン紐付け
    filtered.forEach(it=>{
      const btn = document.getElementById(`del_${it._id}`);
      if(btn){ btn.onclick = ()=> deleteAnomaly(it._id); }
    });
  }

  function renderItem(x){
    const mThumbs = (x.mfgPhotoUrls||[]).map(u=>`<img src="${u}"/>`).join("");
    const tThumbs = (x.techPhotoUrls||[]).map(u=>`<img src="${u}"/>`).join("");
    const statusPill = `<span class="pill" style="border-color:${x.status==='closed'?'#10b981':'#f59e0b'};color:${x.status==='closed'?'#065f46':'#92400e'}">${x.status}</span>`;
    return `<div class="item">
      <div style="min-width:220px">
        <div><strong>${escapeHtml(x.category||"-")}</strong> ${statusPill}</div>
        <div class="muted">${escapeHtml(x.department||"-")} / ${escapeHtml(x.line||"-")}</div>
        <div class="muted">${escapeHtml(formatDate(x.occurrenceDate))}</div>
        <div class="toolbar" style="margin-top:6px">
          <button id="del_${x._id}" class="btn small danger">削除</button>
        </div>
      </div>
      <div style="flex:1">
        <div><span class="pill">現象</span> ${escapeHtml(x.detail||"")}</div>
        ${x.action? `<div style="margin-top:4px"><span class="pill">一次処置</span> ${escapeHtml(x.action)}</div>`:""}
        ${x.cause?  `<div style="margin-top:4px"><span class="pill">原因</span> ${escapeHtml(x.cause)}</div>`:""}
        ${x.counter?`<div style="margin-top:4px"><span class="pill">恒久対策</span> ${escapeHtml(x.counter)}</div>`:""}
        <div class="hr"></div>
        <div class="thumbs">${mThumbs}${tThumbs}</div>
      </div>
    </div>`;
  }

  // --- Delete (RTDB + Storage) ---
  async function deleteAnomaly(id){
    if(!confirm("この履歴を削除しますか？（写真も含めて削除）")) return;
    try{
      // Storage: mfg, tech 配下を削除
      await deleteAllInFolder(R.storage.anomalyFolder(id,"mfg"));
      await deleteAllInFolder(R.storage.anomalyFolder(id,"tech"));
    }catch(e){
      console.warn("Storage削除で警告:", e.message);
    }
    // RTDB
    await remove(R.anomaly(id));
  }

  async function deleteAllInFolder(folderRef){
    const list = await listAll(folderRef);
    // 子フォルダは今回なし想定。あっても再帰可能。
    await Promise.all(list.items.map(it=> deleteObject(it)));
  }

  // --- Upload Photos ---
  async function uploadPhotos(id, folder, files){
    const urls = [];
    for(const f of files){
      const key = Date.now() + "_" + sanitizeFilename(f.name||"photo");
      const r = R.storage.anomalyFile(id, folder, key);
      await uploadBytes(r, f, { contentType:f.type || "application/octet-stream" });
      const url = await getDownloadURL(r);
      urls.push(url);
    }
    return urls;
  }

  // --- Search / Export ---
  el.qText.addEventListener("input", renderHistory);
  el.qDept.addEventListener("change", renderHistory);
  el.qCategory.addEventListener("change", renderHistory);
  el.btnExport.addEventListener("click", ()=> exportCsv());

  function exportCsv(){
    const rows = [["id","部署","ライン","分類","現象","一次処置","原因","恒久対策","発生日時","状態"]];
    anomalyCache.forEach(x=>{
      rows.push([x._id, x.department||"", x.line||"", x.category||"", cleanse(x.detail), cleanse(x.action), cleanse(x.cause), cleanse(x.counter), formatDate(x.occurrenceDate), x.status||""]);
    });
    const csv = rows.map(r=> r.map(csvCell).join(",")).join("\r\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "anomalies.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // --- Helpers ---
  function toLocalDateTimeInput(d){
    const z = (n)=> String(n).padStart(2,"0");
    return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}T${z(d.getHours())}:${z(d.getMinutes())}`;
  }
  function formatDate(s){
    if(!s) return "-";
    // s はローカル入力の文字列 or ISO 文字列
    try{
      if(typeof s==="string" && s.includes("T")) return s.replace("T"," ");
      return String(s);
    }catch{ return String(s); }
  }
  function cleanse(t){ return (t||"").replace(/\r?\n/g," "); }
  function csvCell(x){
    const s = (x==null?"":String(x)).replace(/"/g,'""');
    return `"${s}"`;
  }
  function sanitizeFilename(n){ return n.replace(/[^\w\-.]+/g,"_"); }
  function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

  // 初期値（日付）
  el.occurAt.value = toLocalDateTimeInput(new Date());

  // マスタ一覧 初期描画フック
  function bindMasterUI(){
    renderDepartmentList();
    renderLineList();
    renderHandlerList();
  }
</script>
</body>
</html>
