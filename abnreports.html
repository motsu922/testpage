<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•°å¸¸å±¥æ­´å…¥åŠ›ãƒ„ãƒ¼ãƒ«ï¼ˆPCæ¨ªé•·æœ€é©åŒ–ç‰ˆï¼‰</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Hiragino Sans',sans-serif;background:#f5f5f5}
  .header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:18px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.12)}
  .header h1{font-size:1.6rem;margin-bottom:4px}
  .container{max-width:1600px;margin:0 auto;padding:14px}

  /* ã‚¿ãƒ– */
  .tabs{display:flex;background:#fff;margin:14px 0 0;border-radius:10px 10px 0 0;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  .tab{flex:1;padding:12px 10px;text-align:center;cursor:pointer;background:#f7f8fa;border:none;font-size:1rem;font-weight:700;color:#5f6b7a;transition:.2s}
  .tab.active{background:#fff;color:#667eea;border-bottom:3px solid #667eea}
  .tab-content{display:none;background:#fff;padding:16px;border-radius:0 0 10px 10px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
  .tab-content.active{display:block}

  /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
  .form-group{margin-bottom:12px}
  .form-group label{display:block;margin-bottom:6px;font-weight:700;color:#333}
  .form-group input,.form-group textarea,.form-group select{width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:1rem}
  .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:#667eea;background:#f8fbff}
  .form-group textarea{min-height:96px;resize:vertical}
  .time-group{display:grid;grid-template-columns:1fr 1fr;gap:10px}

  /* å†™çœŸ */
  .photo-upload{border:2px dashed #e0e0e0;border-radius:8px;padding:12px;text-align:center;cursor:pointer}
  .photo-upload:hover{border-color:#667eea;background:#f8f9ff}
  .photo-upload input[type=file]{display:none}
  .photo-preview{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px;margin-top:8px}
  .photo-item{position:relative;aspect-ratio:1;border-radius:6px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.08)}
  .photo-item img{width:100%;height:100%;object-fit:cover}
  .remove-btn{position:absolute;top:4px;right:4px;background:#ff3b30;color:#fff;border:none;border-radius:50%;width:22px;height:22px;font-size:13px;cursor:pointer}

  /* ãƒœã‚¿ãƒ³ */
  .btn{width:100%;padding:12px;border:none;border-radius:8px;font-weight:800;cursor:pointer;transition:.15s;margin-top:8px}
  .btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
  .btn-secondary{background:#6c757d;color:#fff}
  .btn-ghost{background:#fff;border:2px solid #e5e7eb;color:#444;width:auto;padding:8px 12px}
  .btn-ghost:hover{border-color:#667eea;color:#667eea}
  .btn-export{background:#28a745;color:#fff;width:auto;padding:8px 12px}
  .btn-small{padding:6px 10px;border:none;border-radius:6px;font-size:.86rem;cursor:pointer}
  .btn-edit{background:#ffc107;color:#000}
  .btn-delete{background:#dc3545;color:#fff}

  /* å±¥æ­´ï¼ˆPCæ¨ªé•·ï¼‰ */
  .history-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .view-toggle{display:flex;gap:6px}
  .view-toggle button{padding:8px 12px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:8px;font-weight:800;cursor:pointer}
  .view-toggle button.active{background:#667eea;color:#fff}
  .card-view{display:grid;gap:10px}
  @media (min-width:1024px){ .card-view{grid-template-columns:1fr 1fr} }
  @media (min-width:1400px){ .card-view{grid-template-columns:1fr 1fr 1fr} } /* åºƒã„ç”»é¢ã§3åˆ— */

  .anomaly-card{position:relative;background:#fff;border-radius:10px;padding:12px;box-shadow:0 1px 6px rgba(0,0,0,.08);border-left:4px solid #667eea}
  .anomaly-card.complete{border-left-color:#28a745}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;padding-bottom:6px;border-bottom:1px solid #ececec}
  .card-id{font-size:1.02rem;font-weight:900;color:#667eea}
  .card-status{padding:2px 10px;border-radius:12px;font-size:.82rem;font-weight:900;white-space:nowrap}
  .status-pending{background:#fff3cd;color:#856404}
  .status-complete{background:#d4edda;color:#155724}
  .card-body{display:grid;gap:8px}
  .card-body.with-photos{grid-template-columns:1.2fr .8fr;gap:10px;align-items:start} /* å·¦=ãƒ†ã‚­ã‚¹ãƒˆ å³=å†™çœŸ */
  .card-field{display:grid;grid-template-columns:120px 1fr;gap:6px}
  .field-label{font-weight:800;color:#666}
  .field-value{color:#333}
  .card-photos{display:grid;gap:8px}
  .card-photos .thumbs{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .card-photos .thumb{aspect-ratio:1;border-radius:6px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.08);cursor:pointer}
  .card-photos .thumb img{width:100%;height:100%;object-fit:cover}
  .card-photos .more{font-size:.85rem;color:#666;text-align:center}

  /* ãƒ†ãƒ¼ãƒ–ãƒ« */
  .table-view{display:none}
  .table-view.active{display:block}
  table{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 1px 6px rgba(0,0,0,.08)}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
  th{background:#667eea;color:#fff;position:sticky;top:0}
  tr:hover{background:#f8f9ff}
  .action-btns{display:flex;gap:6px;flex-wrap:wrap}

  /* åœæ­¢æ™‚é–“ãƒãƒƒã‚¸ï¼ˆæ§ãˆã‚ï¼‰ */
  .stop-badge{position:absolute;right:10px;top:10px;padding:4px 9px;border-radius:14px;font-weight:900;font-size:.85rem;color:#fff;background:#1976d2;box-shadow:0 1px 4px rgba(0,0,0,.12)}
  .stop-badge.warn{background:#f57c00}
  .stop-badge.danger{background:#d32f2f}

  /* èªè¨¼UI */
  #authGate{position:fixed;inset:0;background:#f5f5f5;display:flex;align-items:center;justify-content:center;z-index:2000}
  #authCard{background:#fff;max-width:380px;width:92%;padding:22px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
  #signOutBtn{position:fixed;right:12px;top:12px;background:#ef5350;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;z-index:1500}

  /* ã‚µã‚¸ã‚§ã‚¹ãƒˆ */
  .word-suggestions{position:relative}
  .word-suggestion-box{position:absolute;z-index:100;background:#fff;border:2px solid #667eea;border-radius:8px;padding:10px;max-height:280px;overflow:auto;box-shadow:0 4px 12px rgba(0,0,0,.15);display:none;width:100%;margin-top:5px}
  .word-suggestion-box.active{display:block}
  .word-suggestion-header{font-size:.85rem;color:#667eea;font-weight:900;margin-bottom:8px;border-bottom:1px solid #e0e0e0;padding-bottom:5px}
  .word-tag{display:inline-block;background:#f0f7ff;color:#667eea;padding:6px 10px;margin:3px;border-radius:14px;cursor:pointer;font-size:.85rem;border:1px solid #e3f2fd}
  .word-tag:hover{background:#667eea;color:#fff}

  @media (max-width:768px){
    .card-field{grid-template-columns:1fr}
    .time-group{grid-template-columns:1fr}
    .card-body.with-photos{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <button id="signOutBtn" style="display:none;">ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ</button>

  <div id="authGate">
    <div id="authCard">
      <h2 style="margin-bottom:10px;color:#667eea;">ğŸ” ã‚µã‚¤ãƒ³ã‚¤ãƒ³</h2>
      <p style="color:#666;margin-bottom:12px;">ç¤¾å†…ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
      <div class="form-group"><label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><input type="email" id="authEmail" placeholder="user@miyama-unitec.co.jp"></div>
      <div class="form-group"><label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input type="password" id="authPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"></div>
      <button class="btn btn-primary" id="authLoginBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <p id="authMsg" style="color:#c62828;margin-top:10px;"></p>
    </div>
  </div>

  <div class="header">
    <h1>ğŸ“‹ ç•°å¸¸å±¥æ­´å…¥åŠ›ãƒ„ãƒ¼ãƒ«</h1>
    <p>Firebaseé€£æºç‰ˆï¼ˆAuth / Firestore / Storageï¼‰</p>
  </div>

  <div class="container" id="appRoot" style="display:none;">
    <div class="tabs">
      <button class="tab active" data-tab="manufacturing">è£½é€ å…¥åŠ›</button>
      <button class="tab" data-tab="technical">æŠ€è¡“å…¥åŠ›</button>
      <button class="tab" data-tab="history">å±¥æ­´</button>
      <button class="tab" data-tab="master">âš™ï¸ ç®¡ç†</button>
    </div>

    <!-- è£½é€ å…¥åŠ› -->
    <div id="manufacturing" class="tab-content active">
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
        <button type="button" class="btn-ghost" id="btnPastFromMfg">ğŸ“š éå»ã®ç•°å¸¸å±¥æ­´</button>
      </div>
      <form id="manufacturingForm">
        <div style="background:#f0f7ff;padding:12px;border-radius:8px;margin-bottom:12px;">
          <h3 style="color:#667eea;margin-bottom:8px;">ğŸ“… ã„ã¤</h3>
          <div class="form-group">
            <label>ç™ºç”Ÿæ—¥ *</label>
            <div style="display:flex;gap:8px;">
              <input type="date" id="occurrenceDate" required style="flex:1;">
              <button type="button" class="btn-secondary" style="width:auto;padding:8px 12px;margin:0;background:#17a2b8;" id="btnNowDate">ğŸ“… NOW</button>
            </div>
          </div>
          <div class="form-group">
            <label>æ™‚åˆ»</label>
            <div class="time-group">
              <div>
                <label style="font-weight:600;font-size:.9rem;">ç™ºç”Ÿæ™‚åˆ»</label>
                <div style="display:flex;gap:6px;">
                  <input type="time" id="occurrenceTime"><button type="button" class="btn-secondary" style="width:auto;padding:6px 10px;margin:0;background:#17a2b8;" data-now="occurrenceTime">NOW</button>
                </div>
              </div>
              <div>
                <label style="font-weight:600;font-size:.9rem;">å†é–‹æ™‚åˆ»</label>
                <div style="display:flex;gap:6px;">
                  <input type="time" id="restartTime"><button type="button" class="btn-secondary" style="width:auto;padding:6px 10px;margin:0;background:#17a2b8;" data-now="restartTime">NOW</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="background:#fff4e6;padding:12px;border-radius:8px;margin-bottom:12px;">
          <h3 style="color:#f57c00;margin-bottom:8px;">ğŸ“ ã©ã“ã§</h3>
          <div class="form-group"><label>éƒ¨ç½² *</label><select id="department" required></select></div>
          <div class="form-group"><label>ãƒ©ã‚¤ãƒ³å *</label><select id="lineName" required><option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option></select></div>
          <div class="form-group"><label>å‡¦ç½®è€… *</label><select id="handler" required><option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option></select></div>
        </div>

        <div style="background:#f3e5f5;padding:12px;border-radius:8px;margin-bottom:12px;">
          <h3 style="color:#8e24aa;margin-bottom:8px;">ğŸ”¢ æ•´ç†No</h3>
          <div class="form-group word-suggestions">
            <label>æ•´ç†No *</label>
            <input type="text" id="serialNo" required placeholder="ä¾‹: 2024-001" list="serialNoList">
            <datalist id="serialNoList"></datalist>
            <div id="serialNoInfo" style="display:none;margin-top:6px;padding:8px;background:#f3e5f5;border-radius:6px;font-size:.88rem;color:#8e24aa;">
              <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ:</strong> ã“ã®æ•´ç†Noã®éå»ãƒ‡ãƒ¼ã‚¿: <span id="serialNoCount">0</span>ä»¶
            </div>
          </div>
        </div>

        <div style="background:#e8f5e9;padding:12px;border-radius:8px;margin-bottom:12px;">
          <h3 style="color:#2e7d32;margin-bottom:8px;">ğŸ“ ä½•ãŒã‚ã£ãŸ</h3>
          <div class="form-group word-suggestions">
            <label>ç•°å¸¸å†…å®¹ *</label>
            <textarea id="anomalyContent" required></textarea>
            <div id="anomalyWordSuggestions" class="word-suggestion-box">
              <div class="word-suggestion-header">ğŸ’¡ ã‚ˆãä½¿ã‚ã‚Œã‚‹è¡¨ç¾ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ï¼‰</div>
              <div id="anomalyWords"></div>
            </div>
          </div>
          <div class="form-group word-suggestions">
            <label>è£½é€ å‡¦ç½®å†…å®¹ *</label>
            <textarea id="actionTaken" required></textarea>
            <div id="actionWordSuggestions" class="word-suggestion-box">
              <div class="word-suggestion-header">ğŸ’¡ ã‚ˆãä½¿ã‚ã‚Œã‚‹è¡¨ç¾ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ï¼‰</div>
              <div id="actionWords"></div>
            </div>
          </div>
          <div class="form-group"><label>é¡ã‚Š *</label>
            <select id="traceback" required><option value="">é¸æŠ</option><option value="æœ‰">æœ‰</option><option value="ç„¡">ç„¡</option></select>
          </div>
          <div class="form-group"><label>æŠ€è¡“è¦è«‹ *</label>
            <select id="techRequest" required>
              <option value="">é¸æŠ</option><option value="è¦è«‹">æŠ€è¡“è¦è«‹ã‚ã‚Š</option><option value="å®Œçµ">è£½é€ ã§å®Œçµ</option>
            </select>
          </div>
          <div class="form-group">
            <label>å†™çœŸ</label>
            <div class="photo-upload" onclick="document.getElementById('mfgPhotos').click()">
              <div style="font-size:1.6rem;">ğŸ“¸</div><p style="font-size:.92rem;color:#666">å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</p>
              <input type="file" id="mfgPhotos" accept="image/*" multiple>
            </div>
            <div id="mfgPhotoPreview" class="photo-preview"></div>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
      </form>
    </div>

    <!-- æŠ€è¡“å…¥åŠ› -->
    <div id="technical" class="tab-content">
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
        <button type="button" class="btn-ghost" id="btnPastFromTech">ğŸ“š éå»ã®ç•°å¸¸å±¥æ­´</button>
      </div>
      <h3 style="color:#667eea;margin-bottom:8px;">å¯¾è±¡ã®æ¡ˆä»¶é¸æŠ *</h3>
      <div class="form-group">
        <select id="selectSerialNo"><option value="">æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„</option></select>
      </div>

      <div id="selectedDataDisplay" style="display:none;background:#f8f9ff;padding:12px;border-radius:8px;margin-bottom:12px;">
        <h3 style="color:#667eea;margin-bottom:6px;">è£½é€ éƒ¨é–€å…¥åŠ›å†…å®¹</h3>
        <div id="displayContent"></div>
      </div>

      <form id="technicalForm">
        <div class="form-group"><label>æŠ€è¡“å‡¦ç½®è€… *</label><input type="text" id="techHandler" required></div>
        <div class="form-group"><label>ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚° *</label>
          <select id="discoveryTiming" required>
            <option value="">é¸æŠ</option><option value="é‹è»¢ä¸­">é‹è»¢ä¸­</option><option value="é ­å‡ºã—">é ­å‡ºã—</option><option value="åˆç‰©">åˆç‰©</option><option value="çµ‚ç‰©">çµ‚ç‰©</option><option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>
        <div class="form-group" id="previousCheckGroup" style="display:none;">
          <label>å‰å›çµ‚ç‰©ç¢ºèªï¼ˆç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒåˆç‰©ã®å ´åˆï¼‰</label>
          <select id="previousCheck"><option value="">é¸æŠ</option><option value="ä¸è¦">ä¸è¦</option><option value="æœª">æœª</option><option value="ç¢ºèªæ¸ˆ">ç¢ºèªæ¸ˆ</option></select>
        </div>
        <div class="form-group"><label>å‘½æ•°æœ‰ç„¡ *</label><select id="lifespan" required><option value="">é¸æŠ</option><option value="æœ‰">æœ‰</option><option value="ç„¡">ç„¡</option></select></div>
        <div class="form-group"><label>å‘½æ•°åˆ°é” *</label><select id="lifespanReached" required><option value="">é¸æŠ</option><option value="è‡³">è‡³</option><option value="ä¸é”">ä¸é”</option></select></div>
        <div class="form-group"><label>ä¿å…¨å˜ä½</label><input type="text" id="maintenanceUnit"></div>
        <div class="form-group"><label>ä½•ãŒæ‚ªãã©ã†ã—ãŸ</label><textarea id="rootCauseAction"></textarea></div>
        <div class="form-group"><label>å†ç™ºã‹æ–°è¦ã‹ *</label><select id="recurrenceType" required><option value="">é¸æŠ</option><option value="å†ç™º">å†ç™º</option><option value="æ–°è¦">æ–°è¦</option></select></div>
        <div class="form-group"><label>è‚¯å®š *</label><select id="affirmation" required><option value="">é¸æŠ</option><option value="æœ‰">æœ‰</option><option value="ç„¡">ç„¡</option></select></div>
        <div class="form-group">
          <label>å†™çœŸ</label>
          <div class="photo-upload" onclick="document.getElementById('techPhotos').click()">
            <div style="font-size:1.6rem;">ğŸ“¸</div><p style="font-size:.92rem;color:#666">å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</p>
            <input type="file" id="techPhotos" accept="image/*" multiple>
          </div>
          <div id="techPhotoPreview" class="photo-preview"></div>
        </div>
        <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
      </form>
    </div>

    <!-- å±¥æ­´ -->
    <div id="history" class="tab-content">
      <div class="history-controls">
        <div class="view-toggle">
          <button class="active" data-view="card">ã‚«ãƒ¼ãƒ‰</button>
          <button data-view="table">ãƒ†ãƒ¼ãƒ–ãƒ«</button>
        </div>
        <button class="btn-export" id="btnExport">ğŸ“¥ CSVå‡ºåŠ›</button>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
          <span id="loadedCount" style="color:#666;font-size:.92rem;"></span>
          <button class="btn-ghost" id="btnLoadMore">ã•ã‚‰ã«èª­ã¿è¾¼ã‚€</button>
        </div>
      </div>
      <div id="cardView" class="card-view"></div>
      <div id="tableView" class="table-view"></div>
    </div>

    <!-- ç®¡ç† -->
    <div id="master" class="tab-content">
      <h3 style="color:#667eea;margin-bottom:8px;">ãƒã‚¹ã‚¿ç®¡ç†</h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px;">
        <section style="background:#fff;padding:12px;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,.08);">
          <h4 style="color:#667eea;margin-bottom:8px;">éƒ¨ç½²ç®¡ç†</h4>
          <div style="display:flex;gap:8px;margin-bottom:8px;">
            <input id="newDepartment" placeholder="æ–°ã—ã„éƒ¨ç½²å" style="flex:1;padding:10px;border:2px solid #e5e7eb;border-radius:8px;">
            <button class="btn-primary" id="btnAddDept" style="width:auto;padding:8px 12px;margin:0;">è¿½åŠ </button>
          </div>
          <div id="departmentList" style="display:grid;gap:8px;"></div>
        </section>

        <section style="background:#fff;padding:12px;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,.08);">
          <h4 style="color:#f57c00;margin-bottom:8px;">ãƒ©ã‚¤ãƒ³åç®¡ç†</h4>
          <div class="form-group"><label>å¯¾è±¡éƒ¨ç½²</label><select id="lineManageDept"><option value="">éƒ¨ç½²ã‚’é¸æŠ</option></select></div>
          <div style="display:flex;gap:8px;margin-bottom:8px;">
            <input id="newLine" placeholder="æ–°ã—ã„ãƒ©ã‚¤ãƒ³å" style="flex:1;padding:10px;border:2px solid #e5e7eb;border-radius:8px;">
            <button class="btn-primary" id="btnAddLine" style="width:auto;padding:8px 12px;margin:0;background:#f57c00;">è¿½åŠ </button>
          </div>
          <div id="lineList" style="display:grid;gap:8px;"></div>
        </section>

        <section style="background:#fff;padding:12px;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,.08);">
          <h4 style="color:#2e7d32;margin-bottom:8px;">å‡¦ç½®è€…ç®¡ç†</h4>
          <div class="form-group"><label>å¯¾è±¡éƒ¨ç½²</label><select id="handlerManageDept"><option value="">éƒ¨ç½²ã‚’é¸æŠ</option></select></div>
          <div style="display:flex;gap:8px;margin-bottom:8px;">
            <input id="newHandler" placeholder="æ–°ã—ã„å‡¦ç½®è€…å" style="flex:1;padding:10px;border:2px solid #e5e7eb;border-radius:8px;">
            <button class="btn-primary" id="btnAddHandler" style="width:auto;padding:8px 12px;margin:0;background:#2e7d32;">è¿½åŠ </button>
          </div>
          <div id="handlerList" style="display:grid;gap:8px;"></div>
        </section>
      </div>
    </div>
  </div>

  <!-- å†™çœŸãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="photoModal" class="modal" aria-hidden="true">
    <div class="modal-content" style="max-width:960px;">
      <h3 class="modal-title">ğŸ“· å†™çœŸä¸€è¦§</h3>
      <div id="photoModalContent" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin:16px 0;"></div>
      <button class="btn-secondary" id="btnPhotoClose">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- éå»ã®ç•°å¸¸å±¥æ­´ï¼ˆå…±é€šï¼‰ -->
  <div id="pastCasesModal" class="modal" aria-hidden="true">
    <div class="modal-content" style="max-width:1200px;">
      <h3 class="modal-title">ğŸ“š éå»ã®ç•°å¸¸å±¥æ­´</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
        <input id="pastSerialInput" placeholder="æ•´ç†Noï¼ˆä¾‹: 2024-001ï¼‰" style="flex:1;padding:10px;border:2px solid #e5e7eb;border-radius:8px;">
        <input id="pastLineInput" placeholder="ãƒ©ã‚¤ãƒ³åï¼ˆä»»æ„ï¼‰" style="flex:1;padding:10px;border:2px solid #e5e7eb;border-radius:8px;">
        <button class="btn-primary" id="btnPastSearch" style="width:auto;padding:8px 12px;margin:0;">æ¤œç´¢</button>
      </div>
      <div id="pastCasesResult" style="display:grid;grid-template-columns:1fr;gap:10px;"></div>
      <button class="btn-secondary" id="btnPastClose">é–‰ã˜ã‚‹</button>
    </div>
  </div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
  import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy, updateDoc, doc, deleteDoc, serverTimestamp, where, startAfter, limit as fbLimit } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
  import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js';

  /* ==== Firebase ==== */
  const firebaseConfig = {
    apiKey: "AIzaSyA0YUIpIDh4WB4p1ewiNB0XfwHve0ByljU",
    authDomain: "abnreport-fd733.firebaseapp.com",
    projectId: "abnreport-fd733",
    storageBucket: "abnreport-fd733.appspot.com",
    messagingSenderId: "349748947315",
    appId: "1:349748947315:web:010cb671d2a95bcf1f7d06"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const storage = getStorage(app);

  /* ==== èª­ã¿å–ã‚Šæœ€å°åŒ–ï¼ˆåˆå›200ä»¶ï¼‹ãƒšãƒ¼ã‚¸ãƒ³ã‚°ï¼‰ ==== */
  const HISTORY_LIMIT = 200;
  const PAGE_SIZE = 200;
  let anomalyCache = [];
  let lastDoc = null;
  let liveUnsub = null;

  /* ==== èªè¨¼ ==== */
  const gate=document.getElementById('authGate'), appRoot=document.getElementById('appRoot'), signOutBtn=document.getElementById('signOutBtn');
  document.getElementById('authLoginBtn').addEventListener('click', async ()=>{
    const email=(document.getElementById('authEmail').value||'').trim();
    const pw=document.getElementById('authPassword').value;
    try{ await setPersistence(auth,browserLocalPersistence); await signInWithEmailAndPassword(auth,email,pw); }
    catch(e){ document.getElementById('authMsg').textContent='ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: '+(e.code||e.message); }
  });
  signOutBtn.addEventListener('click',()=>signOut(auth));
  onAuthStateChanged(auth,(user)=>{
    if(user){ gate.style.display='none'; appRoot.style.display='block'; signOutBtn.style.display='inline-block'; bootAfterLogin(); }
    else{ appRoot.style.display='none'; gate.style.display='flex'; signOutBtn.style.display='none'; if(typeof liveUnsub==='function'){liveUnsub(); liveUnsub=null;} }
  });

  /* ==== ãƒã‚¹ã‚¿å–å¾— ==== */
  async function fetchMasters(){
    const depSnap = await getDocs(collection(db,'masters','department','items'));
    const lineSnap= await getDocs(collection(db,'masters','line','items'));
    const hSnap   = await getDocs(collection(db,'masters','handler','items'));
    const departments = depSnap.docs.map(d=>d.data().name).sort();
    const lines={}; lineSnap.forEach(d=>{ const {department,name}=d.data(); (lines[department]??=[]).push(name); });
    Object.keys(lines).forEach(k=>lines[k].sort());
    const handlers={}; hSnap.forEach(d=>{ const {department,name}=d.data(); (handlers[department]??=[]).push(name); });
    Object.keys(handlers).forEach(k=>handlers[k].sort());
    return {departments,lines,handlers};
  }
  let mastersCache=null;

  function updateDepartmentSelect(id, list){ const sel=document.getElementById(id); const keep=sel?.value||''; if(!sel) return;
    sel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>'; list.forEach(d=>{const o=document.createElement('option');o.value=o.textContent=d; sel.appendChild(o);});
    if(list.includes(keep)) sel.value=keep;
  }
  function refreshLineAndHandler(deptId,lineId,handlerId,lines,handlers){
    const dept=document.getElementById(deptId).value;
    const lineSel=document.getElementById(lineId), hSel=document.getElementById(handlerId);
    lineSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>'; (lines[dept]||[]).forEach(l=>{const o=document.createElement('option');o.value=o.textContent=l;lineSel.appendChild(o);});
    hSel.innerHTML  ='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>'; (handlers[dept]||[]).forEach(h=>{const o=document.createElement('option');o.value=o.textContent=h;hSel.appendChild(o);});
  }

  /* ==== å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ==== */
  let mfgPhotos=[], techPhotos=[];
  function displayPhotos(previewId, arr){
    const wrap=document.getElementById(previewId); wrap.innerHTML='';
    arr.forEach((p,idx)=>{ wrap.insertAdjacentHTML('beforeend',`
      <div class="photo-item"><img src="${p.preview}"><button class="remove-btn" data-photo="${previewId}" data-index="${idx}">Ã—</button></div>`);});
  }
  function hookUpload(inputId, previewId, storeArr){
    const input=document.getElementById(inputId);
    input.addEventListener('change',e=>{
      [...(e.target.files||[])].forEach(file=>{
        const r=new FileReader();
        r.onload=ev=>{ storeArr.push({name:file.name,file,preview:ev.target.result}); displayPhotos(previewId,storeArr); };
        r.readAsDataURL(file);
      }); input.value='';
    });
  }

  async function uploadPhotos(docId, kind, items){
    const urls=[];
    for(const it of items){
      const path=`anomalies/${docId}/${kind}/${Date.now()}_${it.name}`;
      const sref=ref(storage,path);
      await uploadBytes(sref, it.file);
      urls.push(await getDownloadURL(sref));
    }
    return urls;
  }

  /* ==== ãƒ˜ãƒ«ãƒ‘ãƒ¼ ==== */
  function calcStopMinutes(item){
    const ot=item.occurrenceTime||'', rt=item.restartTime||''; if(!ot||!rt) return null;
    const [oh,om]=ot.split(':').map(Number); const [rh,rm]=rt.split(':').map(Number);
    let diff=(rh*60+rm)-(oh*60+om); if(isNaN(diff)) return null; if(diff<0) diff+=1440; return diff;
  }
  function badgeClassByMinutes(m){ if(m===null) return ''; if(m>=30) return 'danger'; if(m>=10) return 'warn'; return ''; }
  function buildThumbs(urls,max=4){ if(!urls||!urls.length) return '';
    const show=urls.slice(0,max), more=urls.length>max?`<div class="more">+${urls.length-max} æš</div>`:''; 
    return `<div class="thumbs">${show.map(u=>`<div class="thumb" onclick="window.open('${u}','_blank')"><img src="${u}"></div>`).join('')}</div>${more}`;
  }

  /* ==== å±¥æ­´æç”»ï¼ˆæ¨ªé•·æœ€é©ï¼‰ ==== */
  function renderHistory(){
    const items=[...anomalyCache].sort((a,b)=>(b.createdAt?b.createdAt.seconds:0)-(a.createdAt?a.createdAt.seconds:0));
    const cardWrap=document.getElementById('cardView');
    if(!items.length){ cardWrap.innerHTML=`<div style="text-align:center;color:#999;padding:28px;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`; }
    else{
      cardWrap.innerHTML=items.map(item=>{
        const st=item.status==='pending'?{t:'æŠ€è¡“å…¥åŠ›å¾…ã¡',cls:'status-pending'}:(item.techRequest==='å®Œçµ'?{t:'å®Œäº†ï¼ˆè£½é€ å®Œçµï¼‰',cls:'status-complete'}:{t:'å®Œäº†',cls:'status-complete'});
        const photos=[...(item.mfgPhotoUrls||[]),...(item.techPhotoUrls||[])]; const hasP=photos.length>0;
        const stop=calcStopMinutes(item); const badgeCls=badgeClassByMinutes(stop);
        const left=`
          ${item.department?`<div class="card-field"><div class="field-label">éƒ¨ç½²</div><div class="field-value">${item.department}</div></div>`:''}
          ${item.lineName?`<div class="card-field"><div class="field-label">ãƒ©ã‚¤ãƒ³å</div><div class="field-value">${item.lineName}</div></div>`:''}
          ${item.techRequest?`<div class="card-field"><div class="field-label">æŠ€è¡“è¦è«‹</div><div class="field-value">${item.techRequest==='è¦è«‹'?'æŠ€è¡“è¦è«‹ã‚ã‚Š':'è£½é€ ã§å®Œçµ'}</div></div>`:''}
          <div class="card-field"><div class="field-label">ç•°å¸¸å†…å®¹</div><div class="field-value">${item.anomalyContent||''}</div></div>
          <div class="card-field"><div class="field-label">è£½é€ å‡¦ç½®</div><div class="field-value">${item.actionTaken||''}</div></div>
          <div class="card-field"><div class="field-label">ç™ºç”Ÿæ—¥æ™‚</div><div class="field-value">${item.occurrenceDate||''} ${item.occurrenceTime||''}</div></div>
          <div class="card-field"><div class="field-label">å†é–‹æ™‚åˆ»</div><div class="field-value">${item.restartTime||''}</div></div>
          <div class="card-field"><div class="field-label">å‡¦ç½®è€…</div><div class="field-value">${item.handler||''}</div></div>
          ${item.status==='complete'&&item.techRequest==='è¦è«‹'?`
            <div class="card-field"><div class="field-label">æŠ€è¡“å‡¦ç½®è€…</div><div class="field-value">${item.techHandler||'-'}</div></div>
            <div class="card-field"><div class="field-label">ä¿å…¨å˜ä½</div><div class="field-value">${item.maintenanceUnit||'-'}</div></div>
            <div class="card-field"><div class="field-label">åŸå› ãƒ»å¯¾ç­–</div><div class="field-value">${item.rootCauseAction||'-'}</div></div>
            <div class="card-field"><div class="field-label">å†ç™º/æ–°è¦</div><div class="field-value">${item.recurrenceType||'-'}</div></div>`:''}
          <div class="action-btns" style="margin-top:6px;">
            <button class="btn-small btn-edit" data-edit="${item._id}">ç·¨é›†</button>
            <button class="btn-small btn-delete" data-del="${item._id}">å‰Šé™¤</button>
          </div>`;
        const right = hasP?`<div class="card-photos">${buildThumbs(photos,4)}</div>`:'';
        return `
          <div class="anomaly-card ${item.status==='complete'?'complete':''}">
            ${stop!==null?`<div class="stop-badge ${badgeCls}">åœæ­¢æ™‚é–“ï¼š${stop}åˆ†</div>`:''}
            <div class="card-header">
              <div class="card-id">${item.serialNo||'(No ID)'}</div>
              <div class="card-status ${st.cls}">${st.t}</div>
            </div>
            <div class="card-body ${hasP?'with-photos':''}">
              <div>${left}</div>
              ${right}
            </div>
          </div>`;
      }).join('');
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«
    const tableWrap=document.getElementById('tableView');
    if(!items.length){ tableWrap.innerHTML=`<div style="text-align:center;color:#999;padding:28px;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`; }
    else{
      tableWrap.innerHTML=`
      <div style="overflow-x:auto;">
        <table style="min-width:2200px;">
          <thead><tr>
            <th>æ•´ç†No</th><th>éƒ¨ç½²</th><th>ãƒ©ã‚¤ãƒ³</th><th>ç™ºç”Ÿæ—¥</th><th>ç™ºç”Ÿæ™‚åˆ»</th><th>å†é–‹æ™‚åˆ»</th><th>åœæ­¢æ™‚é–“(åˆ†)</th>
            <th>ç•°å¸¸å†…å®¹</th><th>è£½é€ å‡¦ç½®</th><th>é¡ã‚Š</th><th>å‡¦ç½®è€…</th><th>æŠ€è¡“è¦è«‹</th><th>æŠ€è¡“å‡¦ç½®è€…</th>
            <th>ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°</th><th>å‰å›çµ‚ç‰©ç¢ºèª</th><th>å‘½æ•°æœ‰ç„¡</th><th>å‘½æ•°åˆ°é”</th><th>ä¿å…¨å˜ä½</th><th>åŸå› å¯¾ç­–</th>
            <th>å†ç™ºæ–°è¦</th><th>è‚¯å®š</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th>
          </tr></thead>
          <tbody>
            ${items.map(it=>{
              const stop=calcStopMinutes(it);
              const statusTxt=it.status==='complete'?'å®Œäº†':'å¾…ã¡';
              const cls=it.status==='complete'?'status-complete':'status-pending';
              return `<tr>
                <td>${it.serialNo||'-'}</td><td>${it.department||'-'}</td><td>${it.lineName||'-'}</td>
                <td>${it.occurrenceDate||'-'}</td><td>${it.occurrenceTime||'-'}</td><td>${it.restartTime||'-'}</td>
                <td>${stop!==null?stop:'-'}</td>
                <td style="min-width:180px;">${(it.anomalyContent||'').slice(0,80)}${(it.anomalyContent||'').length>80?'...':''}</td>
                <td style="min-width:180px;">${(it.actionTaken||'').slice(0,80)}${(it.actionTaken||'').length>80?'...':''}</td>
                <td>${it.traceback||'-'}</td><td>${it.handler||'-'}</td>
                <td>${it.techRequest==='è¦è«‹'?'æŠ€è¡“è¦è«‹':it.techRequest==='å®Œçµ'?'è£½é€ å®Œçµ':'-'}</td>
                <td>${it.techHandler||'-'}</td><td>${it.discoveryTiming||'-'}</td><td>${it.previousCheck||'-'}</td>
                <td>${it.lifespan||'-'}</td><td>${it.lifespanReached||'-'}</td><td>${it.maintenanceUnit||'-'}</td>
                <td style="min-width:180px;">${(it.rootCauseAction||'').slice(0,80)}${(it.rootCauseAction||'').length>80?'...':''}</td>
                <td>${it.recurrenceType||'-'}</td><td>${it.affirmation||'-'}</td>
                <td><span class="card-status ${cls}">${statusTxt}</span></td>
                <td class="action-btns"><button class="btn-small btn-edit" data-edit="${it._id}">ç·¨é›†</button><button class="btn-small btn-delete" data-del="${it._id}">å‰Šé™¤</button></td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>`;
    }

    document.getElementById('loadedCount').textContent = `è¡¨ç¤ºä»¶æ•°: ${items.length}ä»¶`;
  }

  /* ==== ãƒšãƒ¼ã‚¸ãƒ³ã‚°è³¼èª­ ==== */
  async function subscribeInitial(){
    if(liveUnsub) { liveUnsub(); liveUnsub=null; }
    const q = query(collection(db,'anomalies'), orderBy('createdAt','desc'), fbLimit(HISTORY_LIMIT));
    liveUnsub = onSnapshot(q, snap=>{
      anomalyCache = snap.docs.map(d=>({_id:d.id, ...d.data()}));
      lastDoc = snap.docs.length?snap.docs[snap.docs.length-1]:null;
      renderHistory(); renderTechTargetSelect(); updateSerialNoList();
    }, err=>console.error(err));
  }
  async function loadMore(){
    if(!lastDoc) return;
    const q = query(collection(db,'anomalies'), orderBy('createdAt','desc'), startAfter(lastDoc), fbLimit(PAGE_SIZE));
    const snap = await getDocs(q);
    const add = snap.docs.map(d=>({_id:d.id, ...d.data()}));
    anomalyCache = anomalyCache.concat(add);
    lastDoc = snap.docs.length?snap.docs[snap.docs.length-1]:null;
    renderHistory(); renderTechTargetSelect(); updateSerialNoList();
  }

  /* ==== è£½é€ ãƒ»æŠ€è¡“ãƒ•ã‚©ãƒ¼ãƒ  ==== */
  function setNowDateTo(id){ const now=new Date(); const h=now.getHours(); if(h>=0&&h<6) now.setDate(now.getDate()-1);
    const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0'); document.getElementById(id).value=`${y}-${m}-${d}`;}
  function setNowTimeTo(id){ const n=new Date(); const hh=String(n.getHours()).padStart(2,'0'), mm=String(n.getMinutes()).padStart(2,'0'); document.getElementById(id).value=`${hh}:${mm}`;}
  document.getElementById('btnNowDate').addEventListener('click',()=>setNowDateTo('occurrenceDate'));
  document.querySelectorAll('button[data-now]').forEach(b=> b.addEventListener('click',()=>setNowTimeTo(b.dataset.now)));

  hookUpload('mfgPhotos','mfgPhotoPreview',mfgPhotos);
  hookUpload('techPhotos','techPhotoPreview',techPhotos);
  document.addEventListener('click',e=>{
    const rm=e.target.closest('.remove-btn[data-photo]'); if(!rm) return;
    const id=rm.getAttribute('data-photo'); const idx=Number(rm.getAttribute('data-index'));
    if(id==='mfgPhotoPreview'){ mfgPhotos.splice(idx,1); displayPhotos(id,mfgPhotos); }
    if(id==='techPhotoPreview'){ techPhotos.splice(idx,1); displayPhotos(id,techPhotos); }
  });

  document.getElementById('manufacturingForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const techReq=document.getElementById('techRequest').value;
    const base={
      department:document.getElementById('department').value,
      lineName:document.getElementById('lineName').value,
      serialNo:document.getElementById('serialNo').value,
      occurrenceDate:document.getElementById('occurrenceDate').value,
      occurrenceTime:document.getElementById('occurrenceTime').value||'',
      restartTime:document.getElementById('restartTime').value||'',
      anomalyContent:document.getElementById('anomalyContent').value,
      actionTaken:document.getElementById('actionTaken').value,
      traceback:document.getElementById('traceback').value,
      handler:document.getElementById('handler').value,
      techRequest:techReq,
      status: techReq==='å®Œçµ'?'complete':'pending',
      createdAt: serverTimestamp(),
      techHandler:'',discoveryTiming:'',previousCheck:'',lifespan:'',lifespanReached:'',
      maintenanceUnit:'',rootCauseAction:'',recurrenceType:'',affirmation:'',
      mfgPhotoUrls:[], techPhotoUrls:[]
    };
    const created=await addDoc(collection(db,'anomalies'),base);
    if(mfgPhotos.length){ const urls=await uploadPhotos(created.id,'mfg',mfgPhotos);
      await updateDoc(doc(db,'anomalies',created.id),{mfgPhotoUrls:urls}); }
    e.target.reset(); mfgPhotos=[]; document.getElementById('mfgPhotoPreview').innerHTML='';
    document.getElementById('lineName').innerHTML='<option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>';
    document.getElementById('handler').innerHTML='<option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>';
    alert('ç™»éŒ²ã—ã¾ã—ãŸã€‚');
  });

  document.getElementById('technicalForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const id=document.getElementById('selectSerialNo').value;
    if(!id) return alert('æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„');
    const updates={
      techHandler:document.getElementById('techHandler').value,
      discoveryTiming:document.getElementById('discoveryTiming').value,
      previousCheck:document.getElementById('previousCheck').value||'',
      lifespan:document.getElementById('lifespan').value,
      lifespanReached:document.getElementById('lifespanReached').value,
      maintenanceUnit:document.getElementById('maintenanceUnit').value,
      rootCauseAction:document.getElementById('rootCauseAction').value,
      recurrenceType:document.getElementById('recurrenceType').value,
      affirmation:document.getElementById('affirmation').value,
      status:'complete',
      completedAt:serverTimestamp()
    };
    if(techPhotos.length){
      const urls=await uploadPhotos(id,'tech',techPhotos);
      const cur=(anomalyCache.find(x=>x._id===id)?.techPhotoUrls)||[];
      updates.techPhotoUrls = cur.concat(urls);
    }
    await updateDoc(doc(db,'anomalies',id),updates);
    e.target.reset(); techPhotos=[]; document.getElementById('techPhotoPreview').innerHTML='';
    document.getElementById('selectedDataDisplay').style.display='none';
    alert('æŠ€è¡“å…¥åŠ›ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚');
  });

  /* ==== å±¥æ­´æ“ä½œ ==== */
  document.querySelectorAll('.view-toggle button').forEach(b=>{
    b.addEventListener('click',()=>{
      document.querySelectorAll('.view-toggle button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      const v=b.dataset.view;
      document.getElementById('cardView').style.display = v==='card'?'grid':'none';
      document.getElementById('tableView').style.display = v==='table'?'block':'none';
    });
  });
  document.getElementById('btnLoadMore').addEventListener('click',loadMore);

  // ç·¨é›†ï¼å‰Šé™¤ï¼å†™çœŸ
  async function deleteRecord(id){
    if(!confirm('ã“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆç”»åƒã‚‚å‰Šé™¤ï¼‰')) return;
    const item = anomalyCache.find(a=>a._id===id);
    async function delList(list){ if(!list) return; for(const url of list){ try{ await deleteObject(ref(storage,url)); }catch{} } }
    await delList(item?.mfgPhotoUrls); await delList(item?.techPhotoUrls);
    await deleteDoc(doc(db,'anomalies',id)); alert('å‰Šé™¤ã—ã¾ã—ãŸ');
  }
  function showPhotos(id){
    const item=anomalyCache.find(a=>a._id===id); if(!item) return;
    const modal=document.getElementById('photoModal'); const content=document.getElementById('photoModalContent');
    let html='';
    (item.mfgPhotoUrls||[]).forEach(u=> html+=`<div style="aspect-ratio:1;border-radius:8px;overflow:hidden;"><img src="${u}" style="width:100%;height:100%;object-fit:cover;cursor:pointer" onclick="window.open('${u}','_blank')"></div>`);
    (item.techPhotoUrls||[]).forEach(u=> html+=`<div style="aspect-ratio:1;border-radius:8px;overflow:hidden;"><img src="${u}" style="width:100%;height:100%;object-fit:cover;cursor:pointer" onclick="window.open('${u}','_blank')"></div>`);
    content.innerHTML = html || '<div style="text-align:center;color:#999;padding:20px;">å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“</div>';
    modal.classList.add('active'); modal.setAttribute('aria-hidden','false');
  }
  const editModal = (()=>{ // ã‚·ãƒ³ãƒ—ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ç”Ÿæˆ
    const wrapper=document.createElement('div'); wrapper.className='modal'; wrapper.id='editModal';
    wrapper.innerHTML=`
      <div class="modal-content" style="max-width:900px;">
        <h3 class="modal-title">âœï¸ å±¥æ­´ãƒ¬ã‚³ãƒ¼ãƒ‰ç·¨é›†</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div class="form-group"><label>ç™ºç”Ÿæ—¥</label><input type="date" id="edit_occurrenceDate"></div>
          <div class="form-group"><label>ç™ºç”Ÿæ™‚åˆ»</label><input type="time" id="edit_occurrenceTime"></div>
          <div class="form-group"><label>å†é–‹æ™‚åˆ»</label><input type="time" id="edit_restartTime"></div>
          <div class="form-group"><label>éƒ¨ç½²</label><select id="edit_department"></select></div>
          <div class="form-group"><label>ãƒ©ã‚¤ãƒ³å</label><select id="edit_lineName"></select></div>
          <div class="form-group"><label>å‡¦ç½®è€…</label><select id="edit_handler"></select></div>
          <div class="form-group" style="grid-column:1/-1;"><label>æ•´ç†No</label><input id="edit_serialNo"></div>
          <div class="form-group" style="grid-column:1/-1;"><label>ç•°å¸¸å†…å®¹</label><textarea id="edit_anomalyContent"></textarea></div>
          <div class="form-group" style="grid-column:1/-1;"><label>è£½é€ å‡¦ç½®</label><textarea id="edit_actionTaken"></textarea></div>
        </div>
        <div class="modal-actions">
          <button class="btn-secondary" id="btnEditCancel" style="flex:1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn-primary" id="btnEditSave" style="flex:1;">ä¿å­˜</button>
        </div>
      </div>`;
    document.body.appendChild(wrapper);
    return wrapper;
  })();
  let editCurrentId=null;
  function openEdit(id){
    const rec=anomalyCache.find(x=>x._id===id); if(!rec) return alert('å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    editCurrentId=id;
    const depSel=editModal.querySelector('#edit_department'), lineSel=editModal.querySelector('#edit_lineName'), hSel=editModal.querySelector('#edit_handler');
    depSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>'; mastersCache.departments.forEach(d=>{const o=document.createElement('option');o.value=o.textContent=d; depSel.appendChild(o);});
    function refill(dep){ lineSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>'; (mastersCache.lines[dep]||[]).forEach(l=>{const o=document.createElement('option');o.value=o.textContent=l; lineSel.appendChild(o);});
      hSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>'; (mastersCache.handlers[dep]||[]).forEach(h=>{const o=document.createElement('option');o.value=o.textContent=h; hSel.appendChild(o);}); }
    depSel.addEventListener('change',()=>refill(depSel.value),{once:true});
    editModal.querySelector('#edit_occurrenceDate').value=rec.occurrenceDate||'';
    editModal.querySelector('#edit_occurrenceTime').value=rec.occurrenceTime||'';
    editModal.querySelector('#edit_restartTime').value=rec.restartTime||'';
    depSel.value=rec.department||''; refill(depSel.value);
    lineSel.value=rec.lineName||''; hSel.value=rec.handler||'';
    editModal.querySelector('#edit_serialNo').value=rec.serialNo||'';
    editModal.querySelector('#edit_anomalyContent').value=rec.anomalyContent||'';
    editModal.querySelector('#edit_actionTaken').value=rec.actionTaken||'';
    editModal.classList.add('active'); editModal.setAttribute('aria-hidden','false');
  }
  editModal.querySelector('#btnEditCancel').addEventListener('click',()=>{ editModal.classList.remove('active'); editModal.setAttribute('aria-hidden','true'); editCurrentId=null; });
  editModal.querySelector('#btnEditSave').addEventListener('click', async ()=>{
    if(!editCurrentId) return;
    const updates={
      occurrenceDate:editModal.querySelector('#edit_occurrenceDate').value||'',
      occurrenceTime:editModal.querySelector('#edit_occurrenceTime').value||'',
      restartTime:editModal.querySelector('#edit_restartTime').value||'',
      department:editModal.querySelector('#edit_department').value||'',
      lineName:editModal.querySelector('#edit_lineName').value||'',
      handler:editModal.querySelector('#edit_handler').value||'',
      serialNo:editModal.querySelector('#edit_serialNo').value||'',
      anomalyContent:editModal.querySelector('#edit_anomalyContent').value||'',
      actionTaken:editModal.querySelector('#edit_actionTaken').value||'',
    };
    await updateDoc(doc(db,'anomalies',editCurrentId), updates);
    editModal.classList.remove('active'); editModal.setAttribute('aria-hidden','true'); editCurrentId=null;
    alert('æ›´æ–°ã—ã¾ã—ãŸã€‚');
  });

  document.addEventListener('click', (e)=>{
    const t=e.target;
    const ed=t.closest('button.btn-edit[data-edit]'); if(ed) openEdit(ed.getAttribute('data-edit'));
    const del=t.closest('button.btn-delete[data-del]'); if(del) deleteRecord(del.getAttribute('data-del'));
  });

  // å†™çœŸãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜
  document.getElementById('btnPhotoClose').addEventListener('click',()=>{
    const m=document.getElementById('photoModal'); m.classList.remove('active'); m.setAttribute('aria-hidden','true');
  });
  document.getElementById('photoModal').addEventListener('click',(e)=>{ if(e.target.id==='photoModal'){ const m=e.currentTarget; m.classList.remove('active'); m.setAttribute('aria-hidden','true'); }});

  /* ==== ã€Œéå»ã®ç•°å¸¸å±¥æ­´ã€ ==== */
  function openPastModal(){ document.getElementById('pastCasesModal').classList.add('active'); document.getElementById('pastCasesModal').setAttribute('aria-hidden','false'); }
  document.getElementById('btnPastFromMfg').addEventListener('click', openPastModal);
  document.getElementById('btnPastFromTech').addEventListener('click', openPastModal);
  document.getElementById('btnPastClose').addEventListener('click',()=>{
    const m=document.getElementById('pastCasesModal'); m.classList.remove('active'); m.setAttribute('aria-hidden','true');
  });
  document.getElementById('btnPastSearch').addEventListener('click', async ()=>{
    const serial=(document.getElementById('pastSerialInput').value||'').trim();
    const line=(document.getElementById('pastLineInput').value||'').trim();
    if(!serial){ alert('æ•´ç†Noã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    // è»½é‡æ¤œç´¢ï¼šæ•´ç†Noå›ºå®šã€ãƒ©ã‚¤ãƒ³ã¯ where æ¡ä»¶ã‚’è¿½åŠ ï¼ˆä»»æ„ï¼‰
    let q = query(collection(db,'anomalies'), where('serialNo','==', serial), orderBy('createdAt','desc'), fbLimit(50));
    // Firestoreã®åˆ¶é™ä¸Šã€whereã‚’2ã¤ä½¿ã†å ´åˆã¯è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå¿…è¦ã«ãªã‚‹ãŸã‚ã€ãƒ©ã‚¤ãƒ³ã¯å¾Œãƒ•ã‚£ãƒ«ã‚¿ã«è½ã¨ã™
    const snap = await getDocs(q);
    const rows = snap.docs.map(d=>({_id:d.id, ...d.data()})).filter(r=> !line || (r.lineName||'')===line);
    const box=document.getElementById('pastCasesResult');
    if(!rows.length){ box.innerHTML='<div style="text-align:center;color:#999;padding:16px;">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
    box.innerHTML = rows.map(item=>{
      const photos=[...(item.mfgPhotoUrls||[]),...(item.techPhotoUrls||[])];
      return `<div style="border:1px solid #eee;border-radius:10px;padding:10px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <div style="font-weight:900;color:#667eea;">${item.serialNo||''}</div>
          <div style="font-size:.9rem;color:#666;">${item.occurrenceDate||''} ${item.occurrenceTime||''}</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr ${photos.length? '220px':'0'};gap:10px;align-items:start;">
          <div>
            <div style="display:grid;gap:6px;">
              <div><strong>éƒ¨ç½²:</strong> ${item.department||'-'}ï¼<strong>ãƒ©ã‚¤ãƒ³:</strong> ${item.lineName||'-'}</div>
              <div><strong>ç•°å¸¸å†…å®¹:</strong> ${item.anomalyContent||'-'}</div>
              <div><strong>è£½é€ å‡¦ç½®:</strong> ${item.actionTaken||'-'}</div>
              ${item.rootCauseAction?`<div><strong>æŠ€è¡“å¯¾ç­–:</strong> ${item.rootCauseAction}</div>`:''}
            </div>
          </div>
          ${photos.length?`<div>${buildThumbs(photos,4)}</div>`:''}
        </div>
      </div>`;
    }).join('');
  });

  /* ==== ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ï¼ˆæŠ€è¡“å¯¾è±¡ï¼‰ ==== */
  function renderTechTargetSelect(){
    const sel=document.getElementById('selectSerialNo');
    sel.innerHTML='<option value="">æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    anomalyCache.filter(x=>x.status==='pending' && x.techRequest==='è¦è«‹')
      .sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0))
      .forEach(x=>{
        const o=document.createElement('option');
        o.value=x._id; o.textContent=`[${x.serialNo}] ${x.occurrenceDate||''} - ${(x.anomalyContent||'').slice(0,30)}...`;
        sel.appendChild(o);
      });
  }
  document.getElementById('selectSerialNo').addEventListener('change',()=>{
    const id=document.getElementById('selectSerialNo').value;
    const d=anomalyCache.find(it=>it._id===id);
    const box=document.getElementById('selectedDataDisplay'), wrap=document.getElementById('displayContent');
    if(!d){ box.style.display='none'; wrap.innerHTML=''; return; }
    wrap.innerHTML = `
      <div style="display:grid;gap:6px;">
        <div><strong>æ•´ç†No:</strong> ${d.serialNo}</div>
        <div><strong>éƒ¨ç½²/ãƒ©ã‚¤ãƒ³:</strong> ${d.department||'-'} / ${d.lineName||'-'}</div>
        <div><strong>ç•°å¸¸å†…å®¹:</strong> ${d.anomalyContent||''}</div>
        <div><strong>è£½é€ å‡¦ç½®:</strong> ${d.actionTaken||''}</div>
        <div><strong>ç™ºç”Ÿæ—¥:</strong> ${d.occurrenceDate||''}</div>
        <div><strong>å‡¦ç½®è€…:</strong> ${d.handler||''}</div>
      </div>`;
    box.style.display='block';
  });

  /* ==== CSVå‡ºåŠ› ==== */
  document.getElementById('btnExport').addEventListener('click',()=>{
    if(!anomalyCache.length) return alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
    const headers=['æ•´ç†No','éƒ¨ç½²','ãƒ©ã‚¤ãƒ³å','ç™ºç”Ÿæ—¥','ç™ºç”Ÿæ™‚åˆ»','å†é–‹æ™‚åˆ»','åœæ­¢æ™‚é–“(åˆ†)','ç•°å¸¸å†…å®¹','è£½é€ å‡¦ç½®å†…å®¹','é¡ã‚Š','å‡¦ç½®è€…','æŠ€è¡“è¦è«‹','æŠ€è¡“å‡¦ç½®è€…','ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°','å‰å›çµ‚ç‰©ç¢ºèª','å‘½æ•°æœ‰ç„¡','å‘½æ•°åˆ°é”','ä¿å…¨å˜ä½','åŸå› å¯¾ç­–','å†ç™ºæ–°è¦','è‚¯å®š','çŠ¶æ…‹','_id'];
    const rows = anomalyCache.map(item=>{
      const stop=calcStopMinutes(item);
      return [
        item.serialNo||'',item.department||'',item.lineName||'',item.occurrenceDate||'',item.occurrenceTime||'',item.restartTime||'',
        stop!==null?stop:'',
        item.anomalyContent||'',item.actionTaken||'',item.traceback||'',item.handler||'',
        item.techRequest==='è¦è«‹'?'æŠ€è¡“è¦è«‹ã‚ã‚Š':item.techRequest==='å®Œçµ'?'è£½é€ ã§å®Œçµ':'',
        item.techHandler||'',item.discoveryTiming||'',item.previousCheck||'',item.lifespan||'',item.lifespanReached||'',
        item.maintenanceUnit||'',item.rootCauseAction||'',item.recurrenceType||'',item.affirmation||'',
        item.status==='complete'?'å®Œäº†':'æŠ€è¡“å…¥åŠ›å¾…ã¡', item._id
      ];
    });
    let csv='\uFEFF'+headers.join(',')+'\n';
    rows.forEach(r=>{ csv += r.map(c=>`"${(c??'').toString().replace(/"/g,'""')}"`).join(',')+'\n'; });
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download=`ç•°å¸¸å±¥æ­´_${new Date().toISOString().slice(0,10)}.csv`; a.click();
  });

  /* ==== èµ·å‹• ==== */
  async function bootAfterLogin(){
    mastersCache = await fetchMasters();
    updateDepartmentSelect('department', mastersCache.departments);
    updateDepartmentSelect('lineManageDept', mastersCache.departments);
    updateDepartmentSelect('handlerManageDept', mastersCache.departments);
    document.getElementById('department').addEventListener('change',()=> refreshLineAndHandler('department','lineName','handler',mastersCache.lines,mastersCache.handlers));

    // ãƒã‚¹ã‚¿ç”»é¢ã®å‰Šé™¤/è¿½åŠ ï¼ˆç°¡ç•¥ï¼‰
    document.getElementById('btnAddDept').addEventListener('click', async ()=>{
      const name=(document.getElementById('newDepartment').value||'').trim(); if(!name) return alert('éƒ¨ç½²åã‚’å…¥åŠ›');
      await addDoc(collection(db,'masters','department','items'),{name}); mastersCache=await fetchMasters(); updateDepartmentSelect('department',mastersCache.departments); updateDepartmentSelect('lineManageDept',mastersCache.departments); updateDepartmentSelect('handlerManageDept',mastersCache.departments); document.getElementById('newDepartment').value='';
    });
    document.getElementById('btnAddLine').addEventListener('click', async ()=>{
      const dept=document.getElementById('lineManageDept').value; const name=(document.getElementById('newLine').value||'').trim();
      if(!dept) return alert('éƒ¨ç½²ã‚’é¸æŠ'); if(!name) return alert('ãƒ©ã‚¤ãƒ³åã‚’å…¥åŠ›');
      await addDoc(collection(db,'masters','line','items'),{department:dept,name}); mastersCache=await fetchMasters(); document.getElementById('newLine').value='';
    });
    document.getElementById('btnAddHandler').addEventListener('click', async ()=>{
      const dept=document.getElementById('handlerManageDept').value; const name=(document.getElementById('newHandler').value||'').trim();
      if(!dept) return alert('éƒ¨ç½²ã‚’é¸æŠ'); if(!name) return alert('å‡¦ç½®è€…åã‚’å…¥åŠ›');
      await addDoc(collection(db,'masters','handler','items'),{department:dept,name}); mastersCache=await fetchMasters(); document.getElementById('newHandler').value='';
    });

    // åˆæœŸè³¼èª­
    await subscribeInitial();
    setNowDateTo('occurrenceDate');
  }

  /* ã‚µã‚¸ã‚§ã‚¹ãƒˆï¼ˆç°¡æ˜“ï¼‰ */
  function extractCommon(field, serial=null){
    const words={}; let list=anomalyCache;
    if(serial){ const sel=anomalyCache.filter(a=>a.serialNo===serial); if(sel.length>=3) list=sel; }
    list.forEach(it=>{ const tx=(it[field]||''); tx.split(/[ã€‚ã€\n]/).map(s=>s.trim()).filter(s=>s.length>=2&&s.length<=50).forEach(s=>words[s]=(words[s]||0)+1); });
    return Object.entries(words).sort((a,b)=>b[1]-a[1]).slice(0,20).map(([w])=>w);
  }
  function updateSerialNoList(){
    const counts={}; anomalyCache.forEach(a=>{ if(a.serialNo){ counts[a.serialNo]=(counts[a.serialNo]||0)+1; } });
    const list=Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(([no,c])=>({no,c}));
    const dl=document.getElementById('serialNoList'); dl.innerHTML = list.map(({no,c})=>`<option value="${no}">${no} (${c}ä»¶)</option>`).join('');
  }
  function showSuggestion(targetId, boxId, wordsId, field){
    const serial=(document.getElementById('serialNo').value||'').trim();
    const words=extractCommon(field, serial);
    const box=document.getElementById(boxId), cont=document.getElementById(wordsId);
    if(!words.length){ box.classList.remove('active'); return; }
    cont.innerHTML=words.map(w=>`<span class="word-tag" data-word="${w}">${w}</span>`).join('');
    box.classList.add('active');
    cont.querySelectorAll('.word-tag').forEach(tag=>{
      tag.addEventListener('click',()=>{
        const ta=document.getElementById(targetId); const w=tag.getAttribute('data-word');
        const pos=ta.selectionStart; const v=ta.value; const needSpace = pos>0 && !v.substring(0,pos).match(/[\sã€ã€‚\n]$/);
        const ins=(needSpace?' ':'')+w; ta.value=v.slice(0,pos)+ins+v.slice(pos); ta.focus(); ta.selectionStart=ta.selectionEnd=pos+ins.length;
      });
    });
  }
  document.getElementById('anomalyContent').addEventListener('focus',()=>showSuggestion('anomalyContent','anomalyWordSuggestions','anomalyWords','anomalyContent'));
  document.getElementById('actionTaken').addEventListener('focus',()=>showSuggestion('actionTaken','actionWordSuggestions','actionWords','actionTaken'));
  document.getElementById('anomalyContent').addEventListener('blur',()=>setTimeout(()=>document.getElementById('anomalyWordSuggestions').classList.remove('active'),200));
  document.getElementById('actionTaken').addEventListener('blur',()=>setTimeout(()=>document.getElementById('actionWordSuggestions').classList.remove('active'),200));
  document.getElementById('serialNo').addEventListener('input',()=>{
    const serial=document.getElementById('serialNo').value.trim(); const info=document.getElementById('serialNoInfo'); const cnt=anomalyCache.filter(a=>a.serialNo===serial).length;
    if(serial && cnt>0){ info.style.display='block'; document.getElementById('serialNoCount').textContent=cnt; } else { info.style.display='none'; }
  });

</script>
</body>
</html>
