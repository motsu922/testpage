<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•°å¸¸å±¥æ­´å…¥åŠ›ãƒ„ãƒ¼ãƒ«</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Hiragino Sans',sans-serif;background:#f5f5f5}
  .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  .header h1{font-size:1.5rem;margin-bottom:5px}
  .container{max-width:900px;margin:0 auto;padding:10px}
  .tabs{display:flex;background:#fff;margin:15px 0 0;border-radius:8px 8px 0 0;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,.1)}
  .tab{flex:1;padding:15px;text-align:center;cursor:pointer;background:#f8f9fa;border:none;font-size:1rem;font-weight:bold;transition:.3s;color:#666}
  .tab.active{background:#fff;color:#667eea;border-bottom:3px solid #667eea}
  .tab-content{display:none;background:#fff;padding:20px;border-radius:0 0 8px 8px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  .tab-content.active{display:block}
  .form-group{margin-bottom:16px}
  .form-group label{display:block;margin-bottom:8px;font-weight:bold;color:#333;font-size:.95rem}
  .form-group input,.form-group textarea,.form-group select{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:6px;font-size:1rem;transition:border-color .3s}
  .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:#667eea}
  .form-group textarea{min-height:100px;resize:vertical}
  .time-group{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .photo-upload{border:2px dashed #e0e0e0;border-radius:6px;padding:20px;text-align:center;cursor:pointer;transition:.3s}
  .photo-upload:hover{border-color:#667eea;background:#f8f9ff}
  .photo-upload input[type=file]{display:none}
  .photo-preview{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-top:15px}
  .photo-item{position:relative;aspect-ratio:1;border-radius:6px;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,.1)}
  .photo-item img{width:100%;height:100%;object-fit:cover}
  .photo-item .remove-btn{position:absolute;top:5px;right:5px;background:rgba(255,59,48,.9);color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:14px;line-height:1}
  .btn{width:100%;padding:14px;border:none;border-radius:6px;font-size:1rem;font-weight:bold;cursor:pointer;transition:.3s;margin-top:10px}
  .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
  .btn-secondary{background:#6c757d;color:#fff}
  .btn-export{background:#28a745;color:#fff}
  
  /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ */
  .filter-panel{background:#f8f9ff;border:2px solid #667eea;border-radius:8px;padding:16px;margin-bottom:16px;}
  .filter-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
  .filter-title{font-size:1.05rem;font-weight:bold;color:#667eea;display:flex;align-items:center;gap:8px;}
  .filter-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:12px;}
  .filter-date-group{display:flex;gap:8px;align-items:center;}
  .filter-date-group input{flex:1;}
  .filter-date-group .date-btn{padding:8px 12px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:6px;cursor:pointer;font-weight:bold;font-size:.85rem;white-space:nowrap;}
  .filter-date-group .date-btn:hover{background:#667eea;color:#fff;}
  .filter-date-group .date-btn.active{background:#667eea;color:#fff;}
  .filter-actions{display:flex;gap:8px;}
  .filter-actions button{padding:10px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;font-size:.9rem;}
  .btn-filter-apply{background:#667eea;color:#fff;}
  .btn-filter-clear{background:#e0e0e0;color:#333;}
  .filter-result-count{margin-top:12px;padding:10px;background:#fff;border-radius:6px;text-align:center;color:#666;font-size:.9rem;}
  .filter-result-count strong{color:#667eea;}
  
  .history-controls{display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap}
  .view-toggle{display:flex;gap:5px}
  .view-toggle button{padding:8px 12px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:6px;cursor:pointer;font-weight:bold}
  .view-toggle button.active{background:#667eea;color:#fff}
  
  /* PCå‘ã‘æ¨ªé•·ã‚«ãƒ¼ãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
  .card-view{display:grid;gap:16px;}
  .anomaly-card{
    position:relative;
    background:#fff;
    border-radius:8px;
    padding:20px;
    box-shadow:0 2px 8px rgba(0,0,0,.1);
    border-left:4px solid #667eea;
    display:grid;
    grid-template-columns: 200px 1fr 180px;
    gap:20px;
    align-items:start;
  }
  .anomaly-card.complete{border-left-color:#28a745}
  
  /* å·¦ã‚«ãƒ©ãƒ ï¼šåŸºæœ¬æƒ…å ± */
  .card-left{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .card-id{
    font-size:1.2rem;
    font-weight:700;
    color:#667eea;
    margin-bottom:4px;
  }
  .card-status{
    padding:4px 12px;
    border-radius:12px;
    font-size:.85rem;
    font-weight:700;
    text-align:center;
    width:fit-content;
  }
  .status-pending{background:#fff3cd;color:#856404}
  .status-complete{background:#d4edda;color:#155724}
  
  .card-meta{
    display:flex;
    flex-direction:column;
    gap:6px;
    font-size:.9rem;
  }
  .card-meta-item{
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .card-meta-label{
    font-size:.75rem;
    color:#888;
    text-transform:uppercase;
    letter-spacing:0.5px;
  }
  .card-meta-value{
    color:#333;
    font-weight:500;
  }
  
  /* ä¸­å¤®ã‚«ãƒ©ãƒ ï¼šå†…å®¹ */
  .card-center{
    display:flex;
    flex-direction:column;
    gap:12px;
    min-width:0;
  }
  
  .card-content-section{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .card-content-label{
    font-size:.85rem;
    font-weight:bold;
    color:#667eea;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .card-content-text{
    color:#333;
    line-height:1.6;
    font-size:.95rem;
  }
  
  .card-tech-info{
    background:#f8f9ff;
    padding:12px;
    border-radius:6px;
    border-left:3px solid #667eea;
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px;
    font-size:.85rem;
  }
  .tech-info-item{
    display:flex;
    gap:8px;
  }
  .tech-info-label{
    color:#666;
    font-weight:600;
  }
  .tech-info-value{
    color:#333;
  }
  
  /* å³ã‚«ãƒ©ãƒ ï¼šå†™çœŸã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
  .card-right{
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  
  .card-photos-compact{
    display:grid;
    grid-template-columns:repeat(2, 1fr);
    gap:6px;
  }
  .photo-thumb-compact{
    aspect-ratio:1;
    border-radius:6px;
    overflow:hidden;
    box-shadow:0 2px 5px rgba(0,0,0,.1);
    cursor:pointer;
    transition:transform .2s;
  }
  .photo-thumb-compact:hover{
    transform:scale(1.05);
  }
  .photo-thumb-compact img{
    width:100%;
    height:100%;
    object-fit:cover;
  }
  .photo-count-badge{
    text-align:center;
    font-size:.85rem;
    color:#666;
    margin-top:4px;
  }
  
  .action-btns{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .btn-small{
    padding:8px 12px;
    border:none;
    border-radius:4px;
    cursor:pointer;
    font-size:.85rem;
    font-weight:600;
    transition:.2s;
  }
  .btn-edit{background:#ffc107;color:#000}
  .btn-edit:hover{background:#ffb300}
  .btn-delete{background:#dc3545;color:#fff}
  .btn-delete:hover{background:#c82333}
  
/* åœæ­¢æ™‚é–“ãƒãƒƒã‚¸ */
.stop-badge{
  position:absolute;
  right:16px;
  bottom:16px;
  padding:6px 12px;
  border-radius:14px;
  font-weight:700;
  font-size:.9rem;
  color:#fff;
  background:#1976d2;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
}
.stop-badge.warn{background:#f57c00;}
.stop-badge.danger{background:#d32f2f;}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–æ™‚ã®ãƒãƒƒã‚¸ä½ç½®èª¿æ•´ */
@media (max-width:900px){
  .stop-badge{
    right:16px;
    top:auto;
    bottom:16px;
  }
}
  
  /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ“ãƒ¥ãƒ¼ */
  .table-view{overflow-x:auto;display:none}
  .table-view.active{display:block}
  table{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 1px 6px rgba(0,0,0,.08)}
  th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #eaeaea}
  th{background:#667eea;color:#fff;font-weight:bold;position:sticky;top:0}
  tr:hover{background:#f8f9ff}
  
  .empty-state{text-align:center;padding:36px 20px;color:#999}
  .empty-state-icon{font-size:2.5rem;margin-bottom:10px}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
  .modal.active{display:flex}
  .modal-content{background:#fff;padding:20px;border-radius:8px;max-width:680px;width:95%;max-height:90vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .modal-title{font-size:1.1rem;font-weight:bold;margin-bottom:10px;color:#333}
  .edit-tabs{display:flex;gap:8px;margin:8px 0 16px}
  .edit-tab{flex:1;padding:10px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:6px;cursor:pointer;font-weight:bold}
  .edit-tab.active{background:#667eea;color:#fff}
  .modal-actions{display:flex;gap:10px;margin-top:10px}
  .btn-cancel{background:#9e9e9e;color:#fff}
  
  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ï¼šã‚¿ãƒ–ãƒ¬ãƒƒãƒˆä»¥ä¸‹ */
  @media (max-width:900px){
    .anomaly-card{
      grid-template-columns: 1fr;
      gap:16px;
    }
    .card-right{
      flex-direction:row;
      justify-content:space-between;
    }
    .card-photos-compact{
      flex:1;
      max-width:200px;
    }
    .action-btns{
      flex:1;
    }
    .card-tech-info{
      grid-template-columns:1fr;
    }
    .filter-grid{
      grid-template-columns:1fr;
    }
    .filter-date-group{
      flex-direction:column;
      align-items:stretch;
    }
    .filter-date-group .date-btn{
      width:100%;
    }
  }
  
  @media (max-width:600px){
    .time-group{grid-template-columns:1fr}
    table{font-size:.85rem}
    th,td{padding:8px}
    .card-tech-info{
      grid-template-columns:1fr;
    }
  }
  
  #authGate{position:fixed;inset:0;background:#f5f5f5;display:flex;align-items:center;justify-content:center;z-index:2000}
  #authCard{background:#fff;max-width:380px;width:92%;padding:24px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
  #signOutBtn{position:fixed;right:12px;top:12px;background:#ef5350;color:#fff;border:none;border-radius:6px;padding:8px 12px;cursor:pointer;z-index:1500}
  
  /* ãƒ¯ãƒ¼ãƒ‰å€™è£œ */
  .word-suggestions{position:relative;}
  .word-suggestion-box{position:absolute;z-index:100;background:#fff;border:2px solid #667eea;border-radius:8px;padding:10px;max-height:300px;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,.15);display:none;width:100%;margin-top:5px;}
  .word-suggestion-box.active{display:block;}
  .word-suggestion-header{font-size:.85rem;color:#667eea;font-weight:bold;margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid #e0e0e0;}
  .word-tag{display:inline-block;background:#f0f7ff;color:#667eea;padding:6px 12px;margin:3px;border-radius:16px;cursor:pointer;font-size:.85rem;transition:.2s;border:1px solid #e3f2fd;}
  .word-tag:hover{background:#667eea;color:#fff;transform:translateY(-2px);box-shadow:0 2px 8px rgba(102,126,234,.3);}
  
  /* é¡ä¼¼æ¡ˆä»¶ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ« */
  .similar-cases-box{background:#fff4e6;border:2px solid #f57c00;border-radius:8px;padding:15px;margin-bottom:20px;display:none;}
  .similar-cases-box.active{display:block;}
  .similar-cases-header{color:#f57c00;font-weight:bold;margin-bottom:15px;font-size:1rem;display:flex;align-items:center;gap:8px;}
  .similar-case-item{background:#fff;border-left:3px solid #f57c00;border-radius:6px;padding:12px;margin-bottom:10px;}
  .similar-case-item:last-child{margin-bottom:0;}
  .similar-case-date{font-weight:bold;color:#f57c00;margin-bottom:8px;font-size:.95rem;}
  .similar-case-content{font-size:.9rem;color:#333;line-height:1.5;margin-bottom:8px;}
  .similar-case-tech{margin-top:8px;padding-top:8px;border-top:1px solid #ffe0b2;font-size:.9rem;color:#666;}
  .similar-case-tech strong{color:#f57c00;}
  .show-more-btn{width:100%;padding:10px;background:#fff;color:#f57c00;border:2px solid #f57c00;border-radius:6px;font-weight:bold;cursor:pointer;transition:.2s;margin-top:10px;}
  .show-more-btn:hover{background:#f57c00;color:#fff;}
  .similar-photos{margin-top:8px;display:grid;grid-template-columns:repeat(4,1fr);gap:6px;}
  .similar-photos .thumb{aspect-ratio:1;overflow:hidden;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,.1);cursor:pointer;}
  .similar-photos .thumb img{width:100%;height:100%;object-fit:cover;}
.recurrence-badge{
  display:inline-flex;               /* ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ‰±ã„ */
  align-items:center;
  justify-content:center;
  padding:2px 10px;                  /* æ¨ªå¹…ã‚’æŠ‘ãˆã‚ã« */
  border-radius:999px;
  font-size:.80rem;
  font-weight:500;
  background:#e8f5e9;
  color:#1b5e20;
  align-self:flex-start;             /* â† ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼šæ¨ªã„ã£ã±ã„ã«ä¼¸ã³ãªã„ */
}

/* å†ç™ºã®ã¨ãã ã‘è‰²ã‚’å¤‰ãˆã‚‹ */
.recurrence-badge.recurrence-repeat{
  background:#ffebee;
  color:#b71c1c;
}
.recurrence-badge.recurrence-new{
  background:#e8f5e9;
  color:#1b5e20;
}

.recurrence-badge {
  display:inline-block;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 600;
}

/* æ–°è¦ */
.recurrence-new {
  background: #e0f2fe;
  color: #0369a1;
}

/* å†ç™º */
.recurrence-repeat {
  background: #fee2e2;
  color: #b91c1c;
}

/* èª¿ç¯€ */
.recurrence-adjust {
  background: #fef9c3;
  color: #854d0e;
}

/* å¤‰åŒ–ç‚¹ãƒãƒƒã‚¸ */
.changepoint-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 10px;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 600;
  background: #e3f2fd;
  color: #1565c0;
  margin-top: 4px;
  width: fit-content;
  max-width: 100%;
  flex: 0 0 auto;
  
}
.changepoint-badge.cp-human { background: #fce4ec; color: #c2185b; }
.changepoint-badge.cp-method { background: #e8f5e9; color: #2e7d32; }
.changepoint-badge.cp-material { background: #fff3e0; color: #ef6c00; }
.changepoint-badge.cp-mold { background: #ede7f6; color: #5e35b1; }
.changepoint-badge.cp-equipment { background: #e3f2fd; color: #1565c0; }
.changepoint-badge.cp-other { background: #eceff1; color: #546e7a; }

/* å¤‰åŒ–ç‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.changepoint-section {
  background: #e3f2fd;
  padding: 15px;
  border-radius: 6px;
  margin-bottom: 14px;
  border: 2px solid #1976d2;
}
.changepoint-section h3 {
  color: #1565c0;
  margin-bottom: 12px;
  font-size: 1.05rem;
}
.changepoint-toggle {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 12px;
}
.changepoint-toggle input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
}
.changepoint-toggle label {
  font-weight: bold;
  color: #1565c0;
  cursor: pointer;
}
.changepoint-fields {
  display: none;
}
.changepoint-fields.active {
  display: block;
}

/* éå»ã®å¤‰åŒ–ç‚¹ãƒœãƒƒã‚¯ã‚¹ */
.past-changepoints-box {
  background: #e3f2fd;
  border: 2px solid #1976d2;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 20px;
  display: none;
}
.past-changepoints-box.active {
  display: block;
}
.past-changepoints-header {
  color: #1565c0;
  font-weight: bold;
  margin-bottom: 15px;
  font-size: 1rem;
  display: flex;
  align-items: center;
  gap: 8px;
}
.past-changepoint-item {
  background: #fff;
  border-left: 3px solid #1976d2;
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 10px;
}
.past-changepoint-item:last-child {
  margin-bottom: 0;
}
.past-cp-date {
  font-weight: bold;
  color: #1565c0;
  margin-bottom: 8px;
  font-size: .95rem;
}
.past-cp-category {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: .8rem;
  font-weight: 600;
  margin-left: 8px;
}
.past-cp-content {
  font-size: .9rem;
  color: #333;
  line-height: 1.5;
}
</style>
</head>
<body>
  <button id="signOutBtn" style="display:none;">ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ</button>
  <div id="authGate">
    <div id="authCard">
      <h2 style="margin-bottom:20px;text-align:center;">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <div class="form-group">
        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="email" id="authEmail" placeholder="user@example.com">
      </div>
      <div class="form-group">
        <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="authPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <button class="btn btn-primary" id="authLoginBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <p id="authMsg" style="color:#c62828;margin-top:10px;"></p>
    </div>
  </div>

  <div class="header">
    <h1>ğŸ“‹ ç•°å¸¸å±¥æ­´å…¥åŠ›ãƒ„ãƒ¼ãƒ«</h1>
  </div>

  <div class="container" style="display:none" id="appRoot">
    <div class="tabs">
      <button class="tab active" data-tab="manufacturing">ç™ºä¿¡éƒ¨ç½²å…¥åŠ›</button>
      <button class="tab" data-tab="technical">å¯¾å¿œéƒ¨ç½²å…¥åŠ›</button>
      <button class="tab" data-tab="history">å±¥æ­´</button>
      <button class="tab" data-tab="master">âš™ï¸ ç®¡ç†</button>
    </div>

    <!-- ç™ºä¿¡éƒ¨ç½²å…¥åŠ› -->
    <div id="manufacturing" class="tab-content active">
      <h2 style="margin-bottom:16px;color:#667eea;">ç•°å¸¸å ±å‘Š</h2>
      <form id="manufacturingForm">
        <div style="background:#f0f7ff;padding:15px;border-radius:6px;margin-bottom:14px;">
          <h3 style="color:#667eea;margin-bottom:12px;font-size:1.05rem;">ğŸ“… ã„ã¤</h3>
          <div class="form-group">
            <label>ç™ºç”Ÿæ—¥ *</label>
            <div style="display:flex;gap:10px;">
              <input type="date" id="occurrenceDate" required style="flex:1;">
              <button type="button" class="btn btn-secondary" style="width:auto;padding:10px 16px;margin:0;background:#17a2b8;" id="btnNowDate">ğŸ“… NOW</button>
            </div>
          </div>
          <div class="form-group">
            <label>æ™‚åˆ»</label>
            <div class="time-group">
              <div>
                <label style="font-weight:normal;font-size:.9rem;">ç™ºç”Ÿæ™‚åˆ»</label>
                <div style="display:flex;gap:5px;">
                  <input type="time" id="occurrenceTime" style="flex:1;">
                  <button type="button" class="btn btn-secondary" style="width:auto;padding:6px 10px;margin:0;font-size:.85rem;background:#17a2b8;" data-now="occurrenceTime">NOW</button>
                </div>
              </div>
              <div>
                <label style="font-weight:normal;font-size:.9rem;">å†é–‹æ™‚åˆ»</label>
                <div style="display:flex;gap:5px;">
                  <input type="time" id="restartTime" style="flex:1;">
                  <button type="button" class="btn btn-secondary" style="width:auto;padding:6px 10px;margin:0;font-size:.85rem;background:#17a2b8;" data-now="restartTime">NOW</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="background:#fff4e6;padding:15px;border-radius:6px;margin-bottom:14px;">
          <h3 style="color:#f57c00;margin-bottom:12px;font-size:1.05rem;">ğŸ“ ã©ã“ã§</h3>
          <div class="form-group"><label>ç™ºä¿¡éƒ¨ç½² *</label><select id="department" required></select></div>
          <div class="form-group"><label>ãƒ©ã‚¤ãƒ³å *</label><select id="lineName" required><option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option></select></div>
          <div class="form-group"><label>å‡¦ç½®è€… *</label><select id="handler" required><option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option></select></div>
        </div>

        <div style="background:#f3e5f5;padding:15px;border-radius:6px;margin-bottom:14px;">
          <h3 style="color:#8e24aa;margin-bottom:12px;font-size:1.05rem;">ğŸ”¢ æ•´ç†No</h3>
          <div class="form-group word-suggestions">
            <label>æ•´ç†No *</label>
            <input type="text" id="serialNo" required placeholder="ä¾‹:6769" list="serialNoList">
            <datalist id="serialNoList"></datalist>
            <div id="serialNoInfo" style="margin-top:8px;padding:8px;background:#f3e5f5;border-radius:4px;font-size:.85rem;color:#8e24aa;display:none;">
              <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ:</strong> ã“ã®æ•´ç†Noã®éå»ãƒ‡ãƒ¼ã‚¿: <span id="serialNoCount">0</span>ä»¶
            </div>
          </div>
        </div>

        <div style="background:#e8f5e9;padding:15px;border-radius:6px;margin-bottom:14px;">
          <h3 style="color:#2e7d32;margin-bottom:12px;font-size:1.05rem;">ğŸ“ ä½•ãŒã‚ã£ãŸ</h3>
          <div class="form-group word-suggestions">
            <label>ç•°å¸¸å†…å®¹ *</label>
            <textarea id="anomalyContent" required></textarea>
            <div id="anomalyWordSuggestions" class="word-suggestion-box">
              <div class="word-suggestion-header">ğŸ’¡ ã‚ˆãä½¿ã‚ã‚Œã‚‹è¡¨ç¾ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ï¼‰</div>
              <div id="anomalyWords"></div>
            </div>
          </div>
            <div class="form-group">
          <label>ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚° *</label>
          <select id="discoveryTiming" required>
            <option value="">é¸æŠ</option>
            <option value="ç”Ÿç”£ä¸­">ç”Ÿç”£ä¸­</option>
            <option value="é ­å‡ºã—">é ­å‡ºã—</option>
            <option value="åˆç‰©">åˆç‰©</option>
            <option value="çµ‚ç‰©">çµ‚ç‰©</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>
        <div class="form-group" id="previousCheckGroup" style="display:none;">
          <label>å‰å›çµ‚ç‰©ç¢ºèªï¼ˆç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒåˆç‰©ã®å ´åˆï¼‰</label>
          <select id="previousCheck">
            <option value="">é¸æŠ</option>
            <option value="ä¸è¦">ä¸è¦</option>
            <option value="æœª">æœª</option>
            <option value="ç¢ºèªæ¸ˆ">ç¢ºèªæ¸ˆ</option>
          </select>
        </div>
          <div class="form-group word-suggestions">
            <label>ç¾å ´å¯¾å¿œ *</label>
            <textarea id="actionTaken" required></textarea>
            <div id="actionWordSuggestions" class="word-suggestion-box">
              <div class="word-suggestion-header">ğŸ’¡ ã‚ˆãä½¿ã‚ã‚Œã‚‹è¡¨ç¾ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ï¼‰</div>
              <div id="actionWords"></div>
            </div>
          </div>
<div class="form-group"><label>é¡ã‚Š *</label>
  <input type="text" id="traceback" required placeholder="ä¾‹: 300å€‹å»ƒå´ã€€å“è³ªåˆ¤æ–­ã‚ˆã‚Šç”Ÿç”£åˆ†æµå‹• ãªã©">
</div>

         <div class="form-group">
  <label>LotNo</label>
  <input type="text" id="lotNo" placeholder="ä¾‹: M501">
</div>
         
<!-- å“è³ªå¯¾å¿œ -->
<div class="form-group">
  <label>å“è³ªå¯¾å¿œ</label>
  <textarea id="qualityResponse" placeholder="å“è³ªåˆ¤å®šå±¥æ­´ãƒ»å‚™è€ƒãªã©"></textarea>
</div>

<!-- å†ç™º/æ–°è¦ï¼ˆç™ºä¿¡éƒ¨ç½²ã§ã‚‚å…¥åŠ›å¯ï¼‰ -->
<div class="form-group">
  <label>å†ç™º / æ–°è¦</label>
  <select id="mfg_recurrenceType">
    <option value="">é¸æŠ</option>
    <option value="å†ç™º">å†ç™º</option>
    <option value="æ–°è¦">æ–°è¦</option>
  
  </select>
</div>

<!-- å¯¾ç­–çŠ¶æ³ï¼ˆå†ç™ºã®ã¨ãã ã‘è¡¨ç¤ºï¼‰ -->
<div class="form-group" id="mfg_measureStatusGroup" style="display:none;">
  <label>å¯¾ç­–çŠ¶æ³ï¼ˆå†ç™ºã®å ´åˆï¼‰</label>
  <select id="mfg_measureStatus">
    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
    <option value="å¯¾ç­–æ¤œè¨ä¸­">å¯¾ç­–æ¤œè¨ä¸­</option>
    <option value="æš«å®šå¯¾ç­–ä¸­">æš«å®šå¯¾ç­–ä¸­</option>
    <option value="å¯¾ç­–éƒ¨å“å¾…ã¡">å¯¾ç­–éƒ¨å“å¾…ã¡</option>
    <option value="æ’ä¹…å¯¾ç­–æ¸ˆ">æ’ä¹…å¯¾ç­–æ¸ˆ</option>
    <option value="å¯¾ç­–åŠ¹æœç¢ºèªä¸­">å¯¾ç­–åŠ¹æœç¢ºèªä¸­</option>
  </select>
</div>

<!-- å¯¾å¿œåŒºåˆ†ï¼ˆæ—¢å­˜ã®techRequestï¼‰ -->
<div class="form-group">
  <label>å¯¾å¿œåŒºåˆ† *</label>
  <select id="techRequest" required>
    <option value="">é¸æŠ</option>
    <option value="è¦è«‹">æŠ€è¡“ãƒ»ç”ŸæŠ€å¯¾å¿œ</option>
    <option value="å®Œçµ">å®Œäº†</option>
  </select>
</div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button type="button" id="btnShowPastOnMfg" class="btn btn-secondary" style="background:#1976d2;flex:1;">éå»ã®ç•°å¸¸å±¥æ­´</button>
            <button type="button" id="btnShowPastChangePoints" class="btn btn-secondary" style="background:#0d47a1;flex:1;">ğŸ”„ éå»ã®å¤‰åŒ–ç‚¹</button>
          </div>

          <div class="form-group">
            <label>å†™çœŸ</label>
            <div class="photo-upload" onclick="document.getElementById('mfgPhotos').click()">
              <div style="font-size:2rem;">ğŸ“¸</div><p>å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</p>

             
             <input type="file" id="mfgPhotos" accept="image/*" multiple>
            </div>
            <div id="mfgPhotoPreview" class="photo-preview"></div>
          </div>
        </div>

        <!-- å¤‰åŒ–ç‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç™ºä¿¡éƒ¨ç½²ï¼‰ -->
        <div class="changepoint-section">
          <h3>ğŸ”„ å¤‰åŒ–ç‚¹</h3>
          <div class="changepoint-toggle">
            <input type="checkbox" id="mfg_hasChangePoint">
            <label for="mfg_hasChangePoint">å¤‰åŒ–ç‚¹ã‚ã‚Š</label>
          </div>
          <div id="mfg_changePointFields" class="changepoint-fields">
            <div class="form-group">
              <label>å¤‰åŒ–ç‚¹åˆ†é¡ *</label>
              <select id="mfg_changePointCategory">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option value="äºº">äºº</option>
                <option value="æ–¹æ³•">æ–¹æ³•</option>
                <option value="ææ–™">ææ–™</option>
                <option value="é‡‘å‹">é‡‘å‹</option>
                <option value="è¨­å‚™">è¨­å‚™</option>
                <option value="ãã®ä»–">ãã®ä»–</option>
              </select>
            </div>
            <div class="form-group">
              <label>å¤‰åŒ–ç‚¹å†…å®¹</label>
              <textarea id="mfg_changePointContent" placeholder="å¤‰åŒ–ç‚¹ã®è©³ç´°ã‚’å…¥åŠ›..."></textarea>
              <button type="button" id="btnAutoFillChangePoint" class="btn btn-secondary" style="margin-top:8px;background:#1976d2;">
                ğŸ“‹ ç•°å¸¸å†…å®¹ã‹ã‚‰è‡ªå‹•åæ˜ 
              </button>
            </div>
          </div>
        </div>

        <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
      </form>

      <div id="mfgSimilarBox" class="similar-cases-box" style="margin-top:14px;">
        <div class="similar-cases-header">ğŸ” éå»ã®ç•°å¸¸å±¥æ­´</div>
        <div id="mfgSimilarContent"></div>
        <button type="button" id="mfgShowMore" class="show-more-btn" style="display:none;">ã‚‚ã£ã¨è¡¨ç¤º</button>
      </div>

      <!-- éå»ã®å¤‰åŒ–ç‚¹ãƒœãƒƒã‚¯ã‚¹ -->
      <div id="mfgPastChangePointsBox" class="past-changepoints-box" style="margin-top:14px;">
        <div class="past-changepoints-header">ğŸ”„ éå»ã®å¤‰åŒ–ç‚¹</div>
        <div id="mfgPastChangePointsContent"></div>
        <button type="button" id="mfgShowMoreChangePoints" class="show-more-btn" style="display:none;">ã‚‚ã£ã¨è¡¨ç¤º</button>
      </div>
    </div>

   <!-- å¯¾å¿œéƒ¨ç½²å…¥åŠ› -->
    <div id="technical" class="tab-content">
<div class="tab-header">
  <h2 style="color:#667eea;">æŠ€è¡“éƒ¨é–€ - è¿½åŠ å…¥åŠ›</h2>
  <button class="btn btn-secondary btn-icon" id="btnRefreshTech">ğŸ”„ æ›´æ–°</button>
</div>

      <div class="form-group">
        <label>å¯¾è±¡ã®æ¡ˆä»¶é¸æŠ *</label>
        <select id="selectSerialNo"><option value="">æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„</option></select>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
        <button type="button" id="btnShowPastOnTech" class="btn btn-secondary" style="background:#1976d2;flex:1;">éå»ã®ç•°å¸¸å±¥æ­´</button>
        <button type="button" id="btnShowPastChangePointsTech" class="btn btn-secondary" style="background:#0d47a1;flex:1;">ğŸ”„ éå»ã®å¤‰åŒ–ç‚¹</button>
      </div>

      <div id="similarCasesBox" class="similar-cases-box">
        <div class="similar-cases-header">ğŸ” åŒã˜æ•´ç†Noã®éå»å¯¾å¿œäº‹ä¾‹</div>
        <div id="similarCasesContent"></div>
        <button type="button" id="showMoreCases" class="show-more-btn" style="display:none;">ä»–ã®é¡ä¼¼æ¡ˆä»¶ã‚’è¡¨ç¤º</button>
      </div>

      <!-- éå»ã®å¤‰åŒ–ç‚¹ãƒœãƒƒã‚¯ã‚¹ï¼ˆæŠ€è¡“ï¼‰ -->
      <div id="techPastChangePointsBox" class="past-changepoints-box">
        <div class="past-changepoints-header">ğŸ”„ éå»ã®å¤‰åŒ–ç‚¹</div>
        <div id="techPastChangePointsContent"></div>
        <button type="button" id="techShowMoreChangePoints" class="show-more-btn" style="display:none;">ã‚‚ã£ã¨è¡¨ç¤º</button>
      </div>

      <div id="selectedDataDisplay" style="background:#f8f9ff;padding:15px;border-radius:6px;margin-bottom:14px;display:none;">
        <h3 style="color:#667eea;margin-bottom:8px;">ç™ºä¿¡éƒ¨ç½²å…¥åŠ›å†…å®¹</h3>
        <div id="displayContent"></div>
      </div>

      <form id="technicalForm">
        <div class="form-group"><label>å¯¾å¿œéƒ¨ç½²_å‡¦ç½®è€… *</label><input type="text" id="techHandler"></div>
     
        <div class="form-group"><label>å‘½æ•°æœ‰ç„¡ *</label><select id="lifespan"><option value="">é¸æŠ</option><option value="æœ‰">æœ‰</option><option value="ç„¡">ç„¡</option></select></div>
        <div class="form-group">
          <label>å‘½æ•°åˆ°é” *</label>
          <select id="lifespanReached" required>
            <option value="">é¸æŠ</option>
            <option value="è‡³">è‡³</option>
            <option value="æœª">æœª</option>
          </select>
        </div>
        <div class="form-group"><label>ä¿å…¨å˜ä½</label><input type="text" id="maintenanceUnit"></div>
        <div class="form-group"><label>ä½•ãŒæ‚ªãã©ã†ã—ãŸ</label><textarea id="rootCauseAction"></textarea></div>

        <!-- å†ç™ºã‹æ–°è¦ã‹ -->

       
        <div class="form-group">
          <label>å†ç™ºã‹æ–°è¦ã‹ *</label>
          <select id="recurrenceType">
            <option value="">é¸æŠ</option>
            <option value="å†ç™º">å†ç™º</option>
            <option value="æ–°è¦">æ–°è¦</option>
            <option value="èª¿ç¯€">èª¿ç¯€</option>
          </select>
        </div>

<div class="form-group" id="measureStatusGroup" style="display:none;">
  <label>å¯¾ç­–çŠ¶æ³ï¼ˆå†ç™ºæ™‚ã®ã¿ï¼‰</label>
  <select id="measureStatus">
    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
    <option value="å¯¾ç­–æ¤œè¨ä¸­">å¯¾ç­–æ¤œè¨ä¸­</option>
    <option value="æš«å®šå¯¾ç­–ä¸­">æš«å®šå¯¾ç­–ä¸­</option>
    <option value="å¯¾ç­–éƒ¨å“å¾…ã¡">å¯¾ç­–éƒ¨å“å¾…ã¡</option>
    <option value="æ’ä¹…å¯¾ç­–æ¸ˆ">æ’ä¹…å¯¾ç­–æ¸ˆ</option>
    <option value="å¯¾ç­–åŠ¹æœç¢ºèªä¸­">å¯¾ç­–åŠ¹æœç¢ºèªä¸­</option>
  </select>
</div>


        <div class="form-group">
          <label>æš«å®š *</label>
          <select id="affirmation" required>
            <option value="">é¸æŠ</option>
            <option value="æœ‰">æœ‰</option>
            <option value="ç„¡">ç„¡</option>
          </select>
        </div>

        <!-- å¤‰åŒ–ç‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæŠ€è¡“éƒ¨é–€ï¼‰ -->
        <div class="changepoint-section">
          <h3>ğŸ”„ å¤‰åŒ–ç‚¹</h3>
          <div class="changepoint-toggle">
            <input type="checkbox" id="tech_hasChangePoint">
            <label for="tech_hasChangePoint">å¤‰åŒ–ç‚¹ã‚ã‚Š</label>
          </div>
          <div id="tech_changePointFields" class="changepoint-fields">
            <div class="form-group">
              <label>å¤‰åŒ–ç‚¹åˆ†é¡ *</label>
              <select id="tech_changePointCategory">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option value="äºº">äºº</option>
                <option value="æ–¹æ³•">æ–¹æ³•</option>
                <option value="ææ–™">ææ–™</option>
                <option value="é‡‘å‹">é‡‘å‹</option>
                <option value="è¨­å‚™">è¨­å‚™</option>
                <option value="ãã®ä»–">ãã®ä»–</option>
              </select>
            </div>
            <div class="form-group">
              <label>å¤‰åŒ–ç‚¹å†…å®¹</label>
              <textarea id="tech_changePointContent" placeholder="å¤‰åŒ–ç‚¹ã®è©³ç´°ã‚’å…¥åŠ›..."></textarea>
              <button type="button" id="btnAutoFillChangePointTech" class="btn btn-secondary" style="margin-top:8px;background:#1976d2;">
                ğŸ“‹ å‡¦ç½®å†…å®¹ã‹ã‚‰è‡ªå‹•åæ˜ 
              </button>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>å†™çœŸ</label>
          <div class="photo-upload" onclick="document.getElementById('techPhotos').click()">
            <div style="font-size:2rem;">ğŸ“¸</div><p>å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</p>
            <input type="file" id="techPhotos" accept="image/*" multiple>
          </div>
          <div id="techPhotoPreview" class="photo-preview"></div>
        </div>
        <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
      </form>
    </div>

    <!-- å±¥æ­´ -->
    <div id="history" class="tab-content">
      <h2 style="margin-bottom:16px;color:#667eea;">ç•°å¸¸å±¥æ­´</h2>
      
      <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒãƒ« -->
      <div class="filter-panel">
        <div class="filter-header">
          <div class="filter-title">ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¤œç´¢</div>
        </div>
        <div class="filter-grid">
          <div class="form-group" style="margin-bottom:0;">
            <label style="font-size:.9rem;margin-bottom:6px;">éƒ¨ç½²</label>
            <select id="filterDepartment">
              <option value="">ã™ã¹ã¦</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom:0;">
            <label style="font-size:.9rem;margin-bottom:6px;">æ•´ç†No</label>
            <input type="text" id="filterSerialNo" placeholder="éƒ¨åˆ†ä¸€è‡´æ¤œç´¢">
          </div>
          <div class="form-group" style="margin-bottom:0;">
            <label style="font-size:.9rem;margin-bottom:6px;">ãƒ©ã‚¤ãƒ³å</label>
            <select id="filterLine">
              <option value="">ã™ã¹ã¦</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom:0;">
            <label style="font-size:.9rem;margin-bottom:6px;">å¤‰åŒ–ç‚¹</label>
            <select id="filterChangePoint">
              <option value="">ã™ã¹ã¦</option>
              <option value="hasChangePoint">å¤‰åŒ–ç‚¹ã‚ã‚Š</option>
              <option value="äºº">äºº</option>
              <option value="æ–¹æ³•">æ–¹æ³•</option>
              <option value="ææ–™">ææ–™</option>
              <option value="é‡‘å‹">é‡‘å‹</option>
              <option value="è¨­å‚™">è¨­å‚™</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
          </div>
        </div>
        <div class="form-group" style="margin-bottom:0;margin-top:12px;">
          <label style="font-size:.9rem;margin-bottom:6px;">ç™ºç”Ÿæ—¥</label>
          <div class="filter-date-group">
            <button type="button" class="date-btn" id="btnFilterYesterday">æ˜¨æ—¥</button>
            <button type="button" class="date-btn" id="btnFilterToday">ä»Šæ—¥</button>
            <input type="date" id="filterDateFrom" placeholder="é–‹å§‹æ—¥">
            <span style="color:#666;">ã€œ</span>
            <input type="date" id="filterDateTo" placeholder="çµ‚äº†æ—¥">
          </div>
        </div>
        <div class="filter-actions">
          <button type="button" class="btn-filter-apply" id="btnApplyFilter">æ¤œç´¢</button>
          <button type="button" class="btn-filter-clear" id="btnClearFilter">ã‚¯ãƒªã‚¢</button>
        </div>
        <div class="filter-result-count" id="filterResultCount" style="display:none;">
          <strong>0</strong> ä»¶ã®å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ
        </div>
      </div>

      <div class="history-controls">
        <div class="view-toggle"><button class="active" data-view="card">ã‚«ãƒ¼ãƒ‰</button><button data-view="table">ãƒ†ãƒ¼ãƒ–ãƒ«</button></div>
        <button class="btn btn-secondary" style="flex:1;" id="btnImport">ğŸ“¤ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        <button class="btn btn-export" style="flex:1;" id="btnExport">ğŸ“¥ CSVå‡ºåŠ›</button>
      </div>
      <div id="cardView" class="card-view"></div>
      <div id="tableView" class="table-view"></div>
    </div>

    <!-- ç®¡ç† -->
    <div id="master" class="tab-content">
      <h2 style="margin-bottom:16px;color:#667eea;">âš™ï¸ ãƒã‚¹ã‚¿ç®¡ç†</h2>
      <div style="background:#fff;padding:18px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:16px;">
        <h3 style="color:#667eea;margin-bottom:10px;">éƒ¨ç½²ç®¡ç†</h3>
        <div style="display:flex;gap:10px;margin-bottom:12px;">
          <input type="text" id="newDepartment" placeholder="æ–°ã—ã„éƒ¨ç½²å" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button class="btn btn-primary" style="width:auto;padding:10px 20px;margin:0;" id="btnAddDept">è¿½åŠ </button>
        </div>
        <div id="departmentList" style="display:grid;gap:8px;"></div>
      </div>

      <div style="background:#fff;padding:18px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:16px;">
        <h3 style="color:#f57c00;margin-bottom:10px;">ãƒ©ã‚¤ãƒ³åç®¡ç†</h3>
        <div class="form-group"><label>å¯¾è±¡éƒ¨ç½²</label><select id="lineManageDept"><option value="">éƒ¨ç½²ã‚’é¸æŠ</option></select></div>
        <div style="display:flex;gap:10px;margin-bottom:12px;">
          <input type="text" id="newLine" placeholder="æ–°ã—ã„ãƒ©ã‚¤ãƒ³å" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button class="btn btn-primary" style="width:auto;padding:10px 20px;margin:0;background:#f57c00;" id="btnAddLine">è¿½åŠ </button>
        </div>
        <div id="lineList" style="display:grid;gap:8px;"></div>
      </div>

      <div style="background:#fff;padding:18px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);">
        <h3 style="color:#2e7d32;margin-bottom:10px;">å‡¦ç½®è€…ç®¡ç†</h3>
        <div class="form-group"><label>å¯¾è±¡éƒ¨ç½²</label><select id="handlerManageDept"><option value="">éƒ¨ç½²ã‚’é¸æŠ</option></select></div>
        <div style="display:flex;gap:10px;margin-bottom:12px;">
          <input type="text" id="newHandler" placeholder="æ–°ã—ã„å‡¦ç½®è€…å" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button class="btn btn-primary" style="width:auto;padding:10px 20px;margin:0;background:#2e7d32;" id="btnAddHandler">è¿½åŠ </button>
        </div>
        <div id="handlerList" style="display:grid;gap:8px;"></div>
      </div>
    </div>
  </div>

  <!-- å†™çœŸãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="photoModal" class="modal" aria-hidden="true">
    <div class="modal-content" style="max-width:800px;">
      <h3 class="modal-title">ğŸ“· å†™çœŸä¸€è¦§</h3>
      <div id="photoModalContent" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0;"></div>
      <button class="btn btn-cancel" id="btnPhotoClose">é–‰ã˜ã‚‹</button>
    </div>
  </div>
 
  <!-- CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="importModal" class="modal" aria-hidden="true">
    <div class="modal-content" style="max-width:920px;">
      <h3 class="modal-title">ğŸ“¤ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
      <div style="display:grid;gap:12px;">
        <div>
          <label style="font-weight:bold;display:block;margin-bottom:6px;">CSVãƒ•ã‚¡ã‚¤ãƒ«</label>
          <input type="file" id="csvFileInput" accept=".csv,text/csv">
          <div style="color:#666;font-size:.9rem;margin-top:6px;">
            â€» å‰å›ã®ã€ŒğŸ“¥ CSVå‡ºåŠ›ã€ã§å‡ºã—ãŸãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã«å¯¾å¿œã—ã¦ã„ã¾ã™ï¼ˆå…ˆé ­è¡ŒãŒãƒ˜ãƒƒãƒ€ï¼‰ã€‚
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div>
            <label style="font-weight:bold;display:block;margin-bottom:6px;">é‡è¤‡æ™‚ã®å‡¦ç†</label>
            <select id="dupPolicy" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
              <option value="skip">ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ¨å¥¨ï¼‰</option>
              <option value="overwrite_id">_id ãŒä¸€è‡´ã™ã‚‹è¡Œã®ã¿ä¸Šæ›¸ã</option>
              <option value="always_new">å¸¸ã«æ–°è¦ä½œæˆï¼ˆ_id ã¯ç„¡è¦–ï¼‰</option>
            </select>
            <div style="color:#666;font-size:.85rem;margin-top:6px;">
              ãƒ»ã€Œã‚¹ã‚­ãƒƒãƒ—ã€â€¦ ç”»é¢ä¸Šã®å±¥æ­´ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨æ¯”è¼ƒã—ã€åŒä¸€ã¨æ¨å®šã—ãŸè¡Œã‚’é£›ã°ã—ã¾ã™ã€‚<br>
              ãƒ»ã€Œ_idã§ä¸Šæ›¸ãã€â€¦ CSVã«å«ã¾ã‚Œã‚‹ <code>_id</code> ã¨ä¸€è‡´ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã ã‘ã‚’æ›´æ–°ã—ã¾ã™ã€‚<br>
              ãƒ»ã€Œå¸¸ã«æ–°è¦ã€â€¦ å…¨è¡Œã‚’æ–°è¦ç™»éŒ²ï¼ˆæ¨å®šé‡è¤‡ã§ã‚‚ä½œæˆï¼‰ã€‚
            </div>
          </div>
          <div>
            <label style="font-weight:bold;display:block;margin-bottom:6px;">ã‚ªãƒ—ã‚·ãƒ§ãƒ³</label>
            <label style="display:flex;align-items:center;gap:8px;">
              <input type="checkbox" id="dryRun" checked>
              ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆæ¤œè¨¼ã®ã¿ã§æ›¸ãè¾¼ã¾ãªã„ï¼‰
            </label>
            <label style="display:flex;align-items:center;gap:8px;margin-top:6px;">
              <input type="checkbox" id="useCreatedAtNow" checked>
              æ–°è¦ä½œæˆã® <code>createdAt</code> ã¯ç¾åœ¨æ™‚åˆ»ï¼ˆserverTimestampï¼‰
            </label>
          </div>
        </div>

        <details style="background:#f8f9ff;border:1px solid #e5e7eb;border-radius:8px;padding:10px;">
          <summary style="cursor:pointer;font-weight:bold;color:#667eea;">å¯¾å¿œãƒ˜ãƒƒãƒ€ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã¨åŒã˜ï¼‰</summary>
          <div style="font-size:.9rem;color:#333;margin-top:8px;line-height:1.6;">
            å¿…é ˆ: æ•´ç†No, éƒ¨ç½², ç™ºç”Ÿæ—¥, ç•°å¸¸å†…å®¹, ç¾å ´å¯¾å¿œ<br>
            ä»»æ„: ãƒ©ã‚¤ãƒ³å, ç™ºç”Ÿæ™‚åˆ», å†é–‹æ™‚åˆ», é¡ã‚Š, å“è³ªå¯¾å¿œ, å‡¦ç½®è€…, å¯¾å¿œåŒºåˆ†, å¯¾å¿œéƒ¨ç½²_å‡¦ç½®è€…, ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°, å‰å›çµ‚ç‰©ç¢ºèª, å‘½æ•°æœ‰ç„¡, å‘½æ•°åˆ°é”, ä¿å…¨å˜ä½, å‡¦ç½®æ–¹æ³•, å†ç™ºæ–°è¦, å¯¾ç­–çŠ¶æ³, æš«å®š, çŠ¶æ…‹, _id, å¤‰åŒ–ç‚¹åˆ†é¡, å¤‰åŒ–ç‚¹å†…å®¹
          </div>
        </details>

        <div id="importPreview" style="max-height:260px;overflow:auto;border:1px solid #e0e0e0;padding:10px;border-radius:6px;font-size:.85rem;display:none;"></div>

        <div style="display:flex;gap:10px;margin-top:8px;">
          <button class="btn btn-primary" style="flex:1;" id="btnImportStart">ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
          <button class="btn btn-cancel" style="flex:1;" id="btnImportClose">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  <!-- é¡ä¼¼æ¡ˆä»¶è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="similarCaseDetailModal" class="modal" aria-hidden="true">
    <div class="modal-content" style="max-width:900px;">
      <h3 class="modal-title">ğŸ“‹ é¡ä¼¼æ¡ˆä»¶ã®è©³ç´°</h3>
      <div id="similarCaseDetailContent" style="margin:20px 0;"></div>
      <button class="btn btn-cancel" id="btnSimilarCaseDetailClose">é–‰ã˜ã‚‹</button>
    </div>
  </div>

<script type="module">

/* =====================================================
    è»¢é€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º ï¼† å†™çœŸURLå«ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
===================================================== */

let shareTargetData = null; // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ä¿æŒ

window.openSharePreview = function(id){
  const item = anomalyCache.find(x => x._id === id);
  if (!item) return;

  // å†™çœŸURLï¼ˆè£½é€  + æŠ€è¡“ï¼‰ã‚’çµ±åˆ
  const photos = [
    ...(item.mfgPhotoUrls || []),
    ...(item.techPhotoUrls || [])
  ];

  // å¤‰åŒ–ç‚¹æƒ…å ±
  const changePointInfo = item.changePointCategory 
    ? `\nã€å¤‰åŒ–ç‚¹ã€‘\nåˆ†é¡: ${item.changePointCategory}\nå†…å®¹: ${item.changePointContent || 'ï¼ˆæœªå…¥åŠ›ï¼‰'}`
    : '';

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ç”Ÿæˆï¼ˆå†™çœŸURLå«ã‚€ï¼‰
  const text =
`ã€ç•°å¸¸å±¥æ­´ã€‘
æ•´ç†No: ${item.serialNo || ''}
éƒ¨ç½²: ${item.department || ''}
ãƒ©ã‚¤ãƒ³: ${item.lineName || ''}
ç™ºç”Ÿæ—¥: ${item.occurrenceDate || ''} ${item.occurrenceTime || ''}

ã€å†…å®¹ã€‘
ç•°å¸¸: ${item.anomalyContent || ''}
å¯¾å¿œ: ${item.actionTaken || ''}
é¡ã‚Š: ${item.traceback || ''}

ã€LotNoã€‘
${item.lotNo || ''}

ã€å‡¦ç½®å†…å®¹ã€‘
${item.rootCauseAction || 'ï¼ˆæœªå…¥åŠ›ï¼‰'}
${changePointInfo}
ã€å†™çœŸURLã€‘
${photos.length ? photos.join('\n') : 'ï¼ˆãªã—ï¼‰'}
`;

  shareTargetData = { item, text, photos };

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã«åæ˜ 
  document.getElementById('sharePreviewContent').textContent = text;
  document.getElementById('sharePreviewModal').classList.add('active');
};

/* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ */
document.getElementById('sharePreviewClose')?.addEventListener('click', ()=>{
  document.getElementById('sharePreviewModal').classList.remove('active');
});

/* LINEé€ä¿¡ */
document.getElementById('shareSendLine')?.addEventListener('click', ()=>{
  if (!shareTargetData) return;
  const url = "https://line.me/R/msg/text/?" + encodeURIComponent(shareTargetData.text);
  window.open(url, "_blank");
});

/* ãƒ¡ãƒ¼ãƒ«é€ä¿¡ */
document.getElementById('shareSendMail')?.addEventListener('click', ()=>{
  if (!shareTargetData) return;

  const subject = `ã€ç•°å¸¸å ±å‘Šã€‘æ•´ç†No:${shareTargetData.item.serialNo}`;
  const mailto = 
    `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(shareTargetData.text)}`;

  window.location.href = mailto;
});

 
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
  import {
    getFirestore,
    collection, addDoc, getDocs, onSnapshot, query, orderBy, updateDoc,
    doc, deleteDoc, serverTimestamp, where, limit, startAfter,getDoc
  } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
  import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js';

  // ãƒšãƒ¼ã‚¸ãƒ³ã‚°è¨­å®š
  const PAGE_SIZE = 25;
  let lastVisibleDoc = null;
  let hasMoreData = true;
  let isLoadingMore = false;


 const firebaseConfig = {
  apiKey: "AIzaSyA0YUIpIDh4WB4p1ewiNB0XfwHve0ByljU",
  authDomain: "abnreport-fd733.firebaseapp.com",
  databaseURL: "https://abnreport-fd733-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "abnreport-fd733",
  storageBucket: "abnreport-fd733.firebasestorage.app",
  messagingSenderId: "349748947315",
  appId: "1:349748947315:web:010cb671d2a95bcf1f7d06"
};

 

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  const gate = document.getElementById('authGate');
  const appRoot = document.getElementById('appRoot');
  const signOutBtn = document.getElementById('signOutBtn');
// --- å†ç™ºæ™‚ã®å¯¾ç­–çŠ¶æ³ åˆ‡æ›¿UI ---
const recurrenceSelect = document.getElementById('recurrenceType');
const measureStatusGroup = document.getElementById('measureStatusGroup');
const measureStatusInput = document.getElementById('measureStatus');

function toggleMeasureStatusUI(){
  if (recurrenceSelect.value === 'å†ç™º'){
    measureStatusGroup.style.display = 'block';
    measureStatusInput.setAttribute('required', '');
  } else {
    measureStatusGroup.style.display = 'none';
    measureStatusInput.removeAttribute('required');
    measureStatusInput.value = '';
  }
}

// åˆæœŸçŠ¶æ…‹ã®åæ˜  & å¤‰æ›´æ™‚ã®åæ˜ 
toggleMeasureStatusUI();
recurrenceSelect.addEventListener('change', toggleMeasureStatusUI);

// --- ç™ºä¿¡éƒ¨ç½²ã®å†ç™ºæ™‚å¯¾ç­–çŠ¶æ³ ---
const mfgRecurrenceSelect = document.getElementById('mfg_recurrenceType');
const mfgMeasureStatusGroup = document.getElementById('mfg_measureStatusGroup');

function toggleMfgMeasureStatusUI(){
  if (mfgRecurrenceSelect && mfgRecurrenceSelect.value === 'å†ç™º'){
    mfgMeasureStatusGroup.style.display = 'block';
  } else {
    mfgMeasureStatusGroup.style.display = 'none';
  }
}
if (mfgRecurrenceSelect) {
  toggleMfgMeasureStatusUI();
  mfgRecurrenceSelect.addEventListener('change', toggleMfgMeasureStatusUI);
}

// --- å¤‰åŒ–ç‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤ºåˆ‡æ›¿ ---
function setupChangePointToggle(checkboxId, fieldsId) {
  const checkbox = document.getElementById(checkboxId);
  const fields = document.getElementById(fieldsId);
  if (checkbox && fields) {
    checkbox.addEventListener('change', () => {
      fields.classList.toggle('active', checkbox.checked);
    });
  }
}
setupChangePointToggle('mfg_hasChangePoint', 'mfg_changePointFields');
setupChangePointToggle('tech_hasChangePoint', 'tech_changePointFields');

// --- å¤‰åŒ–ç‚¹å†…å®¹ã®è‡ªå‹•åæ˜  ---
document.getElementById('btnAutoFillChangePoint')?.addEventListener('click', () => {
  const anomalyContent = document.getElementById('anomalyContent').value;
  const actionTaken = document.getElementById('actionTaken').value;
  const combined = `ã€ç•°å¸¸å†…å®¹ã€‘\n${anomalyContent}\n\nã€ç¾å ´å¯¾å¿œã€‘\n${actionTaken}`;
  document.getElementById('mfg_changePointContent').value = combined;
});

document.getElementById('btnAutoFillChangePointTech')?.addEventListener('click', () => {
  const rootCauseAction = document.getElementById('rootCauseAction').value;
  document.getElementById('tech_changePointContent').value = rootCauseAction;
});

  document.getElementById('authLoginBtn').addEventListener('click', async ()=>{
    const email = (document.getElementById('authEmail').value||'').trim();
    const pw = document.getElementById('authPassword').value;
    try{
      await setPersistence(auth, browserLocalPersistence);
      await signInWithEmailAndPassword(auth, email, pw);
    }catch(e){
      document.getElementById('authMsg').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ' + (e.code||e.message);
    }
  });
  signOutBtn.addEventListener('click', ()=> signOut(auth));

onAuthStateChanged(auth, (user)=>{
  if (user){
    gate.style.display='none';
    appRoot.style.display='block';
    signOutBtn.style.display='inline-block';
    bootAfterLogin();
    bindPhotoInputs();
  } else {
    appRoot.style.display='none';
    gate.style.display='flex';
    signOutBtn.style.display='none';
  }
});

function openEditModal(){
  renderEditModalUI();
  bindPhotoInputs();
}

let filterShownCount = 25;
const FILTER_PAGE_SIZE = 25;
  let anomalyCache = [];
  let filteredCache = [];
  let mfgPhotos = [];
  let techPhotos = [];
 let editMfgPhotos = [];
let editTechPhotos = [];
  let currentView='card';
  let mastersCache = null;
  let unsubscribeSnapshot = null;

  // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦å†åˆ©ç”¨
  async function fetchMasters(){
    if (mastersCache) return mastersCache;
    
    const [depSnap, lineSnap, hSnap] = await Promise.all([
      getDocs(collection(db,'masters','department','items')),
      getDocs(collection(db,'masters','line','items')),
      getDocs(collection(db,'masters','handler','items'))
    ]);
    
    const departments = depSnap.docs.map(d=>d.data().name).sort();
    const lines = {};
    lineSnap.docs.forEach(d=>{
      const data = d.data();
      if (!lines[data.department]) lines[data.department] = [];
      lines[data.department].push(data.name);
    });
    const handlers = {};
    hSnap.docs.forEach(d=>{
      const data = d.data();
      if (!handlers[data.department]) handlers[data.department] = [];
      handlers[data.department].push(data.name);
    });
    
    mastersCache = { departments, lines, handlers };
    return mastersCache;
  }

  // æ•´ç†Noã®æ­£è¦åŒ–
  function normalizeSerial(val){
    return String(val||'').trim().replace(/[\s\u3000]/g,'').toLowerCase();
  }

  // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«å–å¾—ã™ã‚‹é–¢æ•°
  let allDataCache = null;
  let allDataCacheTime = 0;
  const CACHE_TTL = 60000; // 1åˆ†

  async function fetchAllData(){
    const now = Date.now();
    if (allDataCache && (now - allDataCacheTime) < CACHE_TTL) {
      return allDataCache;
    }
    
    const results = [];
    const q = query(collection(db,'anomalies'), orderBy('createdAt','desc'));
    const snap = await getDocs(q);
    snap.forEach(d => results.push({_id:d.id, ...d.data()}));
    
    allDataCache = results;
    allDataCacheTime = now;
    return results;
  }

  // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  async function loadInitialData(){
    try {
      const q = query(
        collection(db,'anomalies'),
        orderBy('createdAt','desc'),
        limit(PAGE_SIZE)
      );
      const snap = await getDocs(q);
      
      anomalyCache = [];
      snap.docs.forEach(d => {
        anomalyCache.push({ _id: d.id, ...d.data() });
      });
      
      if (snap.docs.length > 0) {
        lastVisibleDoc = snap.docs[snap.docs.length - 1];
      }
      hasMoreData = snap.docs.length === PAGE_SIZE;
      
      filteredCache = [...anomalyCache];
      renderHistory();
      renderTechTargetSelect();
      updateSerialNoList();
      
    } catch (error) {
      console.error('Error loading initial data:', error);
    }
  }

  // è¿½åŠ èª­ã¿è¾¼ã¿
  async function loadMoreData(){
    if (isLoadingMore || !hasMoreData || !lastVisibleDoc) return;
    
    isLoadingMore = true;
    try {
      const q = query(
        collection(db,'anomalies'),
        orderBy('createdAt','desc'),
        startAfter(lastVisibleDoc),
        limit(PAGE_SIZE)
      );
      const snap = await getDocs(q);
      
      snap.docs.forEach(d => {
        const exists = anomalyCache.some(x => x._id === d.id);
        if (!exists) {
          anomalyCache.push({ _id: d.id, ...d.data() });
        }
      });
      
      if (snap.docs.length > 0) {
        lastVisibleDoc = snap.docs[snap.docs.length - 1];
      }
      hasMoreData = snap.docs.length === PAGE_SIZE;
      
      filteredCache = [...anomalyCache];
      renderHistory();
      
    } catch (error) {
      console.error('Error loading more data:', error);
    } finally {
      isLoadingMore = false;
    }
  }

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ãƒ¬ã‚¯ãƒˆã®åˆæœŸåŒ–
  function initializeFilterSelects(){
    if (!mastersCache) return;
    
    const filterDept = document.getElementById('filterDepartment');
    const filterLine = document.getElementById('filterLine');
    
    filterDept.innerHTML = '<option value="">ã™ã¹ã¦</option>';
    mastersCache.departments.forEach(d => {
      filterDept.innerHTML += `<option value="${d}">${d}</option>`;
    });
    
    filterDept.addEventListener('change', () => {
      const dept = filterDept.value;
      filterLine.innerHTML = '<option value="">ã™ã¹ã¦</option>';
      if (dept && mastersCache.lines[dept]) {
        mastersCache.lines[dept].forEach(l => {
          filterLine.innerHTML += `<option value="${l}">${l}</option>`;
        });
      }
    });
  }

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
  function applyFilter(){
    const dept = document.getElementById('filterDepartment').value;
    const serialNo = document.getElementById('filterSerialNo').value.trim();
    const line = document.getElementById('filterLine').value;
    const dateFrom = document.getElementById('filterDateFrom').value;
    const dateTo = document.getElementById('filterDateTo').value;
    const changePoint = document.getElementById('filterChangePoint').value;
    
    filteredCache = anomalyCache.filter(item => {
      if (dept && item.department !== dept) return false;
      if (serialNo && !normalizeSerial(item.serialNo).includes(normalizeSerial(serialNo))) return false;
      if (line && item.lineName !== line) return false;
      if (dateFrom && item.occurrenceDate < dateFrom) return false;
      if (dateTo && item.occurrenceDate > dateTo) return false;
      
      // å¤‰åŒ–ç‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      if (changePoint) {
        if (changePoint === 'hasChangePoint') {
          if (!item.changePointCategory) return false;
        } else {
          if (item.changePointCategory !== changePoint) return false;
        }
      }
      
      return true;
    });
    
    filterShownCount = FILTER_PAGE_SIZE;
    renderHistory();
    
    const countEl = document.getElementById('filterResultCount');
    countEl.style.display = 'block';
    countEl.innerHTML = `<strong>${filteredCache.length}</strong> ä»¶ã®å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;
  }

  function checkFilterActive(){
    const dept = document.getElementById('filterDepartment').value;
    const serialNo = document.getElementById('filterSerialNo').value.trim();
    const line = document.getElementById('filterLine').value;
    const dateFrom = document.getElementById('filterDateFrom').value;
    const dateTo = document.getElementById('filterDateTo').value;
    const changePoint = document.getElementById('filterChangePoint').value;
    return !!(dept || serialNo || line || dateFrom || dateTo || changePoint);
  }

  function clearFilter(){
    document.getElementById('filterDepartment').value = '';
    document.getElementById('filterSerialNo').value = '';
    document.getElementById('filterLine').value = '';
    document.getElementById('filterDateFrom').value = '';
    document.getElementById('filterDateTo').value = '';
    document.getElementById('filterChangePoint').value = '';
    document.getElementById('filterResultCount').style.display = 'none';
    
    filteredCache = [...anomalyCache];
    filterShownCount = FILTER_PAGE_SIZE;
    renderHistory();
  }

  document.getElementById('btnApplyFilter').addEventListener('click', applyFilter);
  document.getElementById('btnClearFilter').addEventListener('click', clearFilter);

  // æ—¥ä»˜ãƒœã‚¿ãƒ³
  document.getElementById('btnFilterToday').addEventListener('click', () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('filterDateFrom').value = today;
    document.getElementById('filterDateTo').value = today;
  });
  document.getElementById('btnFilterYesterday').addEventListener('click', () => {
    const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
    document.getElementById('filterDateFrom').value = yesterday;
    document.getElementById('filterDateTo').value = yesterday;
  });

  // å¤‰åŒ–ç‚¹ãƒãƒƒã‚¸ã®ã‚¯ãƒ©ã‚¹å–å¾—
  function getChangePointBadgeClass(category) {
    const classMap = {
      'äºº': 'cp-human',
      'æ–¹æ³•': 'cp-method',
      'ææ–™': 'cp-material',
      'é‡‘å‹': 'cp-mold',
      'è¨­å‚™': 'cp-equipment',
      'ãã®ä»–': 'cp-other'
    };
    return classMap[category] || 'cp-other';
  }

  // å±¥æ­´æç”»
  function renderHistory(){
    const allItems = [...filteredCache].sort(
      (a,b)=> (b.occurrenceDate||'').localeCompare(a.occurrenceDate||'')
    );

    const cardWrap  = document.getElementById('cardView');
    const tableWrap = document.getElementById('tableView');

    const items = checkFilterActive()
      ? allItems.slice(0, filterShownCount)
      : allItems;

    // ã‚«ãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼
    if (!items.length){
      cardWrap.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“­</div>
          <p>è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
        </div>`;
    } else {
      cardWrap.innerHTML = items.map((item)=>{
        const status = item.status==='pending'
          ? {text:'å¯¾å¿œéƒ¨ç½²å…¥åŠ›å¾…ã¡',cls:'status-pending'}
          : (item.techRequest==='å®Œçµ'
              ? {text:'å®Œäº†ï¼ˆç™ºä¿¡éƒ¨ç½²å®Œçµï¼‰',cls:'status-complete'}
              : {text:'å®Œäº†',cls:'status-complete'});

        const allPhotos = [ ...(item.mfgPhotoUrls || []), ...(item.techPhotoUrls || []) ];
        const stopMin = calcStopMinutes(item);
        const badgeCls = badgeClassByMinutes(stopMin);
        const stopBadge = (stopMin !== null)
          ? `<div class="stop-badge ${badgeCls}">åœæ­¢ï¼š${stopMin}åˆ†</div>`
          : '';
        
        // å†ç™º/æ–°è¦ãƒãƒƒã‚¸
        const recurrenceBadge = item.recurrenceType
          ? (() => {
              let label, cls;
              if (item.recurrenceType === 'å†ç™º') {
                label = 'å†ç™º'; cls = 'recurrence-repeat';
              } else if (item.recurrenceType === 'èª¿ç¯€') {
                label = 'èª¿ç¯€'; cls = 'recurrence-adjust';
              } else {
                label = 'æ–°è¦'; cls = 'recurrence-new';
              }
              return `<div class="recurrence-badge ${cls}">${label}</div>`;
            })()
          : '';

        // å¤‰åŒ–ç‚¹ãƒãƒƒã‚¸
        const changePointBadge = item.changePointCategory
          ? `<div class="changepoint-badge ${getChangePointBadgeClass(item.changePointCategory)}">
               ğŸ”„ ${item.changePointCategory}å¤‰åŒ–ç‚¹ã‚ã‚Š
             </div>`
          : '';

        const leftHtml = `
          <div class="card-left">
            <div class="card-id">${item.serialNo || '(No ID)'}</div>
            <div class="card-status ${status.cls}">${status.text}</div>
            ${recurrenceBadge}
            ${changePointBadge}
            <div class="card-meta">
              ${item.department ? `
                <div class="card-meta-item">
                  <div class="card-meta-label">éƒ¨ç½²</div>
                  <div class="card-meta-value">${item.department}</div>
                </div>
              ` : ''}
              ${item.lineName ? `
                <div class="card-meta-item">
                  <div class="card-meta-label">ãƒ©ã‚¤ãƒ³</div>
                  <div class="card-meta-value">${item.lineName}</div>
                </div>
              ` : ''}
              <div class="card-meta-item">
                <div class="card-meta-label">ç™ºç”Ÿæ—¥æ™‚</div>
                <div class="card-meta-value">${item.occurrenceDate||''} ${item.occurrenceTime||''}</div>
              </div>
              ${item.lotNo ? `
                <div class="card-meta-item">
                  <div class="card-meta-label">LotNo</div>
                  <div class="card-meta-value">${item.lotNo}</div>
                </div>
              ` : ''}
              ${item.restartTime ? `
                <div class="card-meta-item">
                  <div class="card-meta-label">å†é–‹æ™‚åˆ»</div>
                  <div class="card-meta-value">${item.restartTime}</div>
                </div>
              ` : ''}
              ${item.handler ? `
                <div class="card-meta-item">
                  <div class="card-meta-label">å‡¦ç½®è€…</div>
                  <div class="card-meta-value">${item.handler}</div>
                </div>
              ` : ''}
            </div>
          </div>
        `;

        const centerHtml = `
          <div class="card-center">
            <div class="card-content-section">
              <div class="card-content-label">ğŸš¨ ç•°å¸¸å†…å®¹</div>
              <div class="card-content-text">${item.anomalyContent||'-'}</div>
            </div>
            <div class="card-content-section">
              <div class="card-content-label">ğŸ”§ ç¾å ´å¯¾å¿œ</div>
              <div class="card-content-text">${item.actionTaken||'-'}</div>
            </div>
            ${item.qualityResponse ? `
              <div class="card-content-section">
                <div class="card-content-label">âœ… å“è³ªå¯¾å¿œ</div>
                <div class="card-content-text">${item.qualityResponse}</div>
              </div>
            ` : ''}
            ${item.changePointCategory ? `
              <div class="card-content-section" style="background:#e3f2fd;padding:10px;border-radius:6px;">
                <div class="card-content-label" style="color:#1565c0;">ğŸ”„ å¤‰åŒ–ç‚¹æƒ…å ±</div>
                <div class="card-content-text">
                  <strong>åˆ†é¡:</strong> ${item.changePointCategory}<br>
                  ${item.changePointContent ? `<strong>å†…å®¹:</strong> ${item.changePointContent}` : ''}
                </div>
              </div>
            ` : ''}
            ${item.status==='complete' && item.techRequest==='è¦è«‹' ? `
              <div class="card-tech-info">
                ${item.techHandler ? `<div class="tech-info-item"><span class="tech-info-label">å¯¾å¿œéƒ¨ç½²_å‡¦ç½®è€…:</span><span class="tech-info-value">${item.techHandler}</span></div>` : ''}
                ${item.maintenanceUnit ? `<div class="tech-info-item"><span class="tech-info-label">ä¿å…¨å˜ä½:</span><span class="tech-info-value">${item.maintenanceUnit}</span></div>` : ''}
                ${item.lifespan ? `<div class="tech-info-item"><span class="tech-info-label">å‘½æ•°:</span><span class="tech-info-value">${item.lifespan}</span></div>` : ''}
                ${item.rootCauseAction ? `<div class="tech-info-item" style="grid-column:1/-1;"><span class="tech-info-label">å‡¦ç½®æ–¹æ³•:</span><span class="tech-info-value">${item.rootCauseAction}</span></div>` : ''}
                ${(item.recurrenceType==='å†ç™º' && item.measureStatus)
                  ? `<div class="tech-info-item" style="grid-column:1/-1;">
                       <span class="tech-info-label">å¯¾ç­–çŠ¶æ³:</span>
                       <span class="tech-info-value">${item.measureStatus}</span>
                     </div>`
                  : ''
                }
              </div>
            ` : ''}
          </div>
        `;

        const rightHtml = `
          <div class="card-right">
            ${allPhotos.length > 0 ? `
              <div>
                <div class="card-photos-compact">
                  ${allPhotos.slice(0,4).map(url => `
                    <div class="photo-thumb-compact" onclick="window.open('${url}','_blank')">
                      <img src="${url}" alt="">
                    </div>
                  `).join('')}
                </div>
                ${allPhotos.length > 4 ? `<div class="photo-count-badge">ä»– ${allPhotos.length - 4} æš</div>` : ''}
              </div>
            ` : ''}
            <div class="action-btns">
              <button class="btn-small" onclick="openSharePreview('${item._id}')">ğŸ“¤ è»¢é€</button>
              <button class="btn-small btn-edit" data-edit="${item._id}">âœï¸ ç·¨é›†</button>
              <button class="btn-small btn-delete" data-del="${item._id}">ğŸ—‘ï¸ å‰Šé™¤</button>
            </div>
          </div>
        `;

        return `
          <div class="anomaly-card ${item.status==='complete'?'complete':''}">
            ${stopBadge}
            ${leftHtml}
            ${centerHtml}
            ${rightHtml}
          </div>
        `;
      }).join('');

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ™‚ã®ã•ã‚‰ã«è¡¨ç¤ºãƒœã‚¿ãƒ³
      if (checkFilterActive() && allItems.length > filterShownCount) {
        cardWrap.innerHTML += `
          <div style="text-align:center;margin-top:20px;">
            <button id="btnLoadMoreFilteredCard" class="btn btn-secondary" style="max-width:300px;">
              ã•ã‚‰ã«è¡¨ç¤ºï¼ˆç¾åœ¨${items.length}ä»¶ï¼å…¨${allItems.length}ä»¶ï¼‰
            </button>
          </div>
        `;
        setTimeout(() => {
          const btn = document.getElementById('btnLoadMoreFilteredCard');
          if (btn) {
            btn.addEventListener('click', () => {
              filterShownCount = Math.min(filterShownCount + FILTER_PAGE_SIZE, allItems.length);
              renderHistory();
            });
          }
        }, 0);
      }

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç„¡ã—ã§è¿½åŠ èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³
      if (!checkFilterActive() && hasMoreData) {
        cardWrap.innerHTML += `
          <div style="text-align:center;margin-top:20px;">
            <button id="btnLoadMore" class="btn btn-secondary" style="max-width:300px;">
              ã•ã‚‰ã«èª­ã¿è¾¼ã‚€ï¼ˆç¾åœ¨${anomalyCache.length}ä»¶è¡¨ç¤ºä¸­ï¼‰
            </button>
          </div>
        `;
        setTimeout(() => {
          const btn = document.getElementById('btnLoadMore');
          if (btn) btn.addEventListener('click', loadMoreData);
        }, 0);
      }
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ“ãƒ¥ãƒ¼
    if (!items.length){
      tableWrap.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“­</div>
          <p>è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
        </div>`;
    } else {
      tableWrap.innerHTML = `
        <div style="overflow-x:auto;">
          <table style="min-width:2400px;">
            <thead><tr>
              <th>æ•´ç†No</th><th>éƒ¨ç½²</th><th>ãƒ©ã‚¤ãƒ³</th><th>ç™ºç”Ÿæ—¥</th><th>ç™ºç”Ÿæ™‚åˆ»</th>
              <th>å†é–‹æ™‚åˆ»</th><th>åœæ­¢æ™‚é–“(åˆ†)</th><th>ç•°å¸¸å†…å®¹</th><th>å‡¦ç½®å†…å®¹</th><th>é¡ã‚Š</th><th>å“è³ªå¯¾å¿œ</th>
              <th>å‡¦ç½®è€…</th><th>å¯¾å¿œåŒºåˆ†</th><th>å¯¾å¿œéƒ¨ç½²_å‡¦ç½®è€…</th><th>ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°</th><th>å‰å›çµ‚ç‰©ç¢ºèª</th>
              <th>å‘½æ•°æœ‰ç„¡</th><th>å‘½æ•°åˆ°é”</th><th>ä¿å…¨å˜ä½</th><th>å‡¦ç½®æ–¹æ³•</th><th>å†ç™ºæ–°è¦</th><th>å¯¾ç­–çŠ¶æ³</th>
              <th>æš«å®š</th><th>å¤‰åŒ–ç‚¹åˆ†é¡</th><th>å¤‰åŒ–ç‚¹å†…å®¹</th><th>å†™çœŸ</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th>
            </tr></thead>
            <tbody>
              ${items.map(it=>{
                const st = it.status==='complete'?'å®Œäº†':'å¾…ã¡';
                const cls = it.status==='complete'?'status-complete':'status-pending';
                const photoCount = (it.mfgPhotoUrls?.length||0)+(it.techPhotoUrls?.length||0);
                const stopMin = calcStopMinutes(it);
                return `
                  <tr>
                    <td>${it.serialNo||'-'}</td>
                    <td>${it.department||'-'}</td>
                    <td>${it.lineName||'-'}</td>
                    <td>${it.occurrenceDate||'-'}</td>
                    <td>${it.occurrenceTime||'-'}</td>
                    <td>${it.restartTime||'-'}</td>
                    <td>${stopMin!==null?stopMin:'-'}</td>
                    <td style="min-width:150px;">${(it.anomalyContent||'-').slice(0,50)}${(it.anomalyContent||'').length>50?'...':''}</td>
                    <td style="min-width:150px;">${(it.actionTaken||'-').slice(0,50)}${(it.actionTaken||'').length>50?'...':''}</td>
                    <td>${it.traceback||'-'}</td>
                    <td style="min-width:150px;">${(it.qualityResponse||'-').slice(0,50)}${(it.qualityResponse||'').length>50?'...':''}</td>
                    <td>${it.handler||'-'}</td>
                    <td>${it.techRequest==='è¦è«‹'?'æŠ€è¡“ãƒ»ç”ŸæŠ€å¯¾å¿œ':it.techRequest==='å®Œçµ'?'å®Œäº†':'-'}</td>
                    <td>${it.techHandler||'-'}</td>
                    <td>${it.discoveryTiming||'-'}</td>
                    <td>${it.previousCheck||'-'}</td>
                    <td>${it.lifespan||'-'}</td>
                    <td>${it.lifespanReached||'-'}</td>
                    <td>${it.maintenanceUnit||'-'}</td>
                    <td style="min-width:150px;">${(it.rootCauseAction||'-').slice(0,50)}${(it.rootCauseAction||'').length>50?'...':''}</td>
                    <td>${it.recurrenceType||'-'}</td>
                    <td style="min-width:150px;">${(it.measureStatus||'-').slice(0,50)}${(it.measureStatus||'').length>50?'...':''}</td>
                    <td>${it.affirmation||'-'}</td>
                    <td>${it.changePointCategory||'-'}</td>
                    <td style="min-width:150px;">${(it.changePointContent||'-').slice(0,50)}${(it.changePointContent||'').length>50?'...':''}</td>
                    <td>${photoCount ? `<button class="btn-small" style="background:#2196f3;color:#fff;" data-photos="${it._id}">ğŸ“· ${photoCount}</button>` : '-'}</td>
                    <td><span class="card-status ${cls}">${st}</span></td>
                    <td class="action-btns">
                      <button class="btn-small btn-edit" data-edit="${it._id}">ç·¨é›†</button>
                      <button class="btn-small btn-delete" data-del="${it._id}">å‰Šé™¤</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;

      // ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¿½åŠ èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³
      if (checkFilterActive() && allItems.length > filterShownCount) {
        tableWrap.innerHTML += `
          <div style="text-align:center;margin-top:20px;">
            <button id="btnLoadMoreFilteredTable" class="btn btn-secondary" style="max-width:300px;">
              ã•ã‚‰ã«è¡¨ç¤ºï¼ˆç¾åœ¨${items.length}ä»¶ï¼å…¨${allItems.length}ä»¶ï¼‰
            </button>
          </div>
        `;
        setTimeout(() => {
          const btn = document.getElementById('btnLoadMoreFilteredTable');
          if (btn) {
            btn.addEventListener('click', () => {
              filterShownCount = Math.min(filterShownCount + FILTER_PAGE_SIZE, allItems.length);
              renderHistory();
            });
          }
        }, 0);
      }

      if (!checkFilterActive() && hasMoreData) {
        tableWrap.innerHTML += `
          <div style="text-align:center;margin-top:20px;">
            <button id="btnLoadMoreTable" class="btn btn-secondary" style="max-width:300px;">
              ã•ã‚‰ã«èª­ã¿è¾¼ã‚€ï¼ˆç¾åœ¨${anomalyCache.length}ä»¶è¡¨ç¤ºä¸­ï¼‰
            </button>
          </div>
        `;
        setTimeout(() => {
          const btn = document.getElementById('btnLoadMoreTable');
          if (btn) btn.addEventListener('click', loadMoreData);
        }, 0);
      }
    }
  }

  function renderTechTargetSelect(){
    const sel = document.getElementById('selectSerialNo');
    sel.innerHTML = '<option value="">æ•´ç†Noã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    anomalyCache
      .filter(x=>x.status==='pending' && x.techRequest==='è¦è«‹')
      .sort((a,b)=> (b.occurrenceDate||'').localeCompare(a.occurrenceDate||''))
      .forEach(x=>{
        const o=document.createElement('option');
        o.value = x._id;
        o.textContent = `[${x.serialNo}] ${x.occurrenceDate} - ${x.anomalyContent?.slice(0,30)||''}...`;
        sel.appendChild(o);
      });
  }

  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      const targetId = tab.getAttribute('data-tab');
      document.getElementById(targetId).classList.add('active');
    });
  });

 async function bootAfterLogin(){
    mastersCache = await fetchMasters();
    updateDepartmentSelect('department', mastersCache.departments);
    updateDepartmentSelect('lineManageDept', mastersCache.departments);
    updateDepartmentSelect('handlerManageDept', mastersCache.departments);
    initializeFilterSelects();

    document.getElementById('department').addEventListener('change', ()=> {
      refreshLineAndHandler('department','lineName','handler', mastersCache.lines, mastersCache.handlers);
    });
    document.getElementById('lineManageDept').addEventListener('change', async ()=> { await updateLineManageList(); });
    document.getElementById('handlerManageDept').addEventListener('change', async ()=> { await updateHandlerManageList(); });

    document.getElementById('discoveryTiming').addEventListener('change', ()=> {
      const timing = document.getElementById('discoveryTiming').value;
      const previousCheckGroup = document.getElementById('previousCheckGroup');
      if (timing === 'åˆç‰©') { previousCheckGroup.style.display = 'block'; }
      else { previousCheckGroup.style.display = 'none'; document.getElementById('previousCheck').value = ''; }
    });

    await loadInitialData();
    await updateDepartmentList();
    setNowDateTo('occurrenceDate');
  }

// æ¡ˆä»¶é¸æŠæ™‚ã®å‡¦ç†
document.getElementById('selectSerialNo').addEventListener('change', async ()=>{
  const id = document.getElementById('selectSerialNo').value;
  const box   = document.getElementById('selectedDataDisplay');
  const wrap  = document.getElementById('displayContent');
  const simBox= document.getElementById('similarCasesBox');
  const content = document.getElementById('similarCasesContent');
  const showMoreBtn = document.getElementById('showMoreCases');

  showingAllCases = false;
  allSimilarCases = [];
  if (!id){
    box.style.display='none';
    wrap.innerHTML='';
    simBox.classList.remove('active');
    return;
  }

  const d = anomalyCache.find(it=> it._id===id);
  if (!d){
    box.style.display='none';
    wrap.innerHTML='';
    simBox.classList.remove('active');
    return;
  }

  // å¤‰åŒ–ç‚¹ãŒã‚ã‚Œã°è¡¨ç¤ºã«è¿½åŠ 
  const changePointInfo = d.changePointCategory 
    ? `<p><strong>å¤‰åŒ–ç‚¹:</strong> ${d.changePointCategory} - ${d.changePointContent || 'ï¼ˆå†…å®¹ãªã—ï¼‰'}</p>`
    : '';

  wrap.innerHTML = `
    <p><strong>æ•´ç†No:</strong> ${d.serialNo}</p>
    <p><strong>éƒ¨ç½²:</strong> ${d.department} / ${d.lineName}</p>
    <p><strong>ç™ºç”Ÿæ—¥æ™‚:</strong> ${d.occurrenceDate} ${d.occurrenceTime||''}</p>
    <p><strong>ç•°å¸¸å†…å®¹:</strong> ${d.anomalyContent}</p>
    <p><strong>ç¾å ´å¯¾å¿œ:</strong> ${d.actionTaken}</p>
    ${changePointInfo}
  `;
  box.style.display='block';

  // ç™ºä¿¡éƒ¨ç½²ãŒå…¥åŠ›ã—ãŸå¤‰åŒ–ç‚¹ãŒã‚ã‚Œã°ã€æŠ€è¡“å´ã«ã‚‚åæ˜ 
  if (d.changePointCategory) {
    document.getElementById('tech_hasChangePoint').checked = true;
    document.getElementById('tech_changePointFields').classList.add('active');
    document.getElementById('tech_changePointCategory').value = d.changePointCategory;
    document.getElementById('tech_changePointContent').value = d.changePointContent || '';
  } else {
    document.getElementById('tech_hasChangePoint').checked = false;
    document.getElementById('tech_changePointFields').classList.remove('active');
    document.getElementById('tech_changePointCategory').value = '';
    document.getElementById('tech_changePointContent').value = '';
  }

  // é¡ä¼¼æ¡ˆä»¶ã‚’è¡¨ç¤º
  const similar = findSimilarCandidates(d, 3);
  allSimilarCases = findSimilarCandidates(d, 20);
  
  if (similar.length > 0){
    content.innerHTML = renderSimilarList(similar);
    simBox.classList.add('active');
    showMoreBtn.style.display = (allSimilarCases.length > 3) ? 'block' : 'none';
  } else {
    simBox.classList.remove('active');
  }
});


// éå»ã®å¤‰åŒ–ç‚¹ã‚’å–å¾—ãƒ»è¡¨ç¤ºã™ã‚‹é–¢æ•°ï¼ˆchangepointsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ï¼‰
async function showPastChangePoints(serialNo, boxId, contentId, showMoreBtnId) {
  const box = document.getElementById(boxId);
  const content = document.getElementById(contentId);
  const showMoreBtn = document.getElementById(showMoreBtnId);
  
  if (!serialNo || serialNo.trim() === '') {
    box.classList.remove('active');
    return;
  }
  
  content.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">æ¤œç´¢ä¸­...</div>';
  box.classList.add('active');
  
  try {
    // changepointsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰æ¤œç´¢
    const q = query(collection(db, 'changepoints'), orderBy('occurrenceDate', 'desc'));
    const snap = await getDocs(q);
    
    const normalizedSearch = normalizeSerial(serialNo);
    
    // serialNoãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆæ–‡å­—åˆ—ï¼‰ã§éƒ¨åˆ†ä¸€è‡´æ¤œç´¢ & type='planned'ã®ã¿
    const changePointData = snap.docs
      .map(d => ({ _id: d.id, ...d.data() }))
.filter(item => {
  // typeãŒç„¡ã„æ—§ãƒ‡ãƒ¼ã‚¿ã‚‚ã€suddenã‚‚ plannedã‚‚æ‹¾ã†
  const t = item.type || 'planned';
  if (!['planned', 'sudden'].includes(t)) return false;

  // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚ºãƒ¬å¯¾ç­–ï¼ˆæ—§ãƒ‡ãƒ¼ã‚¿æ•‘æ¸ˆï¼‰
  const rawSerial =
    item.serialNo ??
    item.targetSerials ??
    item.targetSerial ??
    '';

  const itemSerial = normalizeSerial(String(rawSerial));

  return itemSerial.includes(normalizedSearch) ||
         normalizedSearch.includes(itemSerial);
})
      .sort((a, b) => (b.occurrenceDate || '').localeCompare(a.occurrenceDate || ''));
    
    if (changePointData.length === 0) {
      content.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">ã“ã®æ•´ç†Noã®éå»ã®å¤‰åŒ–ç‚¹ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      showMoreBtn.style.display = 'none';
      return;
    }
    
    const displayCount = 5;
    const displayData = changePointData.slice(0, displayCount);
    
    const renderItem = (item) => `
      <div class="past-changepoint-item">
        <div class="past-cp-date">
          ğŸ“… ${item.occurrenceDate || ''} ${item.occurrenceTime || ''}
          <span class="past-cp-category changepoint-badge ${getChangePointBadgeClass(item.category)}">
            ${item.category || ''}
          </span>
        </div>
        <div class="past-cp-content">
          <strong>èµ·æ¡ˆéƒ¨ç½²:</strong> ${item.planneddepartment || '-'}<br>
          <strong>ç™ºç”Ÿéƒ¨ç½²:</strong> ${item.department || '-'}<br>
          <strong>å¯¾è±¡ãƒ©ã‚¤ãƒ³:</strong> ${item.lineName || '-'}<br>
          <strong>å¯¾è±¡æ•´ç†No:</strong> ${item.serialNo || '-'}<br>
          <strong>å¤‰åŒ–ç‚¹å†…å®¹:</strong> ${item.content || '-'}
        </div>
      </div>
    `;
    
    content.innerHTML = displayData.map(renderItem).join('');
    
    if (changePointData.length > displayCount) {
      showMoreBtn.style.display = 'block';
      showMoreBtn.onclick = () => {
        content.innerHTML = changePointData.map(renderItem).join('');
        showMoreBtn.style.display = 'none';
      };
    } else {
      showMoreBtn.style.display = 'none';
    }
    
  } catch (error) {
    console.error('Error fetching change points:', error);
    content.innerHTML = '<div style="text-align:center;padding:20px;color:#c62828;">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
  }
}

// éå»ã®å¤‰åŒ–ç‚¹ãƒœã‚¿ãƒ³ï¼ˆç™ºä¿¡éƒ¨ç½²ï¼‰
document.getElementById('btnShowPastChangePoints').addEventListener('click', () => {
  const serialNo = document.getElementById('serialNo').value.trim();
  if (!serialNo) {
    alert('æ•´ç†Noã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  showPastChangePoints(serialNo, 'mfgPastChangePointsBox', 'mfgPastChangePointsContent', 'mfgShowMoreChangePoints');
});

// éå»ã®å¤‰åŒ–ç‚¹ãƒœã‚¿ãƒ³ï¼ˆæŠ€è¡“éƒ¨é–€ï¼‰
document.getElementById('btnShowPastChangePointsTech').addEventListener('click', () => {
  const id = document.getElementById('selectSerialNo').value;
  if (!id) {
    alert('æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }
  const d = anomalyCache.find(it => it._id === id);
  if (!d) return;
  showPastChangePoints(d.serialNo, 'techPastChangePointsBox', 'techPastChangePointsContent', 'techShowMoreChangePoints');
});

  let showingAllCases = false;
  let allSimilarCases = [];
  
  function calculateSimilarity(text1, text2) {
    if (!text1 || !text2) return 0;
    const normalize = (text) => text.toLowerCase().replace(/[\s\u3000]/g, '').replace(/[ã€ã€‚ï¼Œï¼]/g, '');
    const t1 = normalize(text1); const t2 = normalize(text2);
    if (t1 === t2) return 100;
    if (t1.length === 0 || t2.length === 0) return 0;
    let matches = 0;
    const minLen = Math.min(t1.length, t2.length);
    const maxLen = Math.max(t1.length, t2.length);
    for (let len = minLen; len >= 2; len--) {
      for (let i = 0; i <= t1.length - len; i++) {
        const substr = t1.substring(i, i + len);
        if (t2.includes(substr)) { matches += len; break; }
      }
      if (matches > 0) break;
    }
    return Math.round((matches / maxLen) * 100);
  }

 function findSimilarCandidates(base, limitN = 10){
  if (!base) return [];
  const baseSN = normalizeSerial(base.serialNo);

  let candidates = anomalyCache
    .filter(x => x._id !== base._id && x.status === 'complete')
    .filter(x => normalizeSerial(x.serialNo) === baseSN);

  const withScore = candidates.map(it => ({
    ...it,
    similarity: calculateSimilarity(base.anomalyContent || '', it.anomalyContent || '')
  }));

  return withScore
    .filter(x => x.similarity >= 30)
    .sort((a,b) => (b.similarity !== a.similarity)
        ? (b.similarity - a.similarity)
        : (b.occurrenceDate || '').localeCompare(a.occurrenceDate || '')
    )
    .slice(0, limitN);
}
  
  function renderSimilarList(items){
    return items.map((item) => {
      const allPhotos = [ ...(item.mfgPhotoUrls || []), ...(item.techPhotoUrls || []) ];
      const photosHtml = allPhotos.length ? `
        <div class="similar-photos">
          ${allPhotos.slice(0,8).map(u=>`
            <div class="thumb" onclick="window.open('${u}','_blank')">
              <img src="${u}" alt="">
            </div>
          `).join('')}
        </div>
      ` : '';
      
      // å¤‰åŒ–ç‚¹æƒ…å ±
      const changePointHtml = item.changePointCategory ? `
        <div style="margin-top:8px;padding:8px;background:#e3f2fd;border-radius:4px;">
          <strong style="color:#1565c0;">ğŸ”„ å¤‰åŒ–ç‚¹:</strong> ${item.changePointCategory}
          ${item.changePointContent ? ` - ${item.changePointContent}` : ''}
        </div>
      ` : '';
      
      return `
        <div class="similar-case-item">
          <div class="similar-case-date">
            ğŸ“… ${item.occurrenceDate || ''} ã®å¯¾å¿œäº‹ä¾‹
            <span style="background:#4caf50;color:#fff;padding:2px 8px;border-radius:12px;font-size:.8rem;margin-left:8px;">
              é¡ä¼¼åº¦ ${item.similarity}%
            </span>
          </div>
          <div class="similar-case-content">
            <strong>ç•°å¸¸å†…å®¹:</strong> ${item.anomalyContent || '-'}<br>
            <strong>ç¾å ´å¯¾å¿œ:</strong> ${item.actionTaken || '-'}
          </div>
          ${changePointHtml}
          <div class="similar-case-tech">
            <strong>ğŸ”§ å‡¦ç½®æ–¹æ³•:</strong><br>
            ${item.techHandler ? `å¯¾å¿œéƒ¨ç½²_å‡¦ç½®è€…: ${item.techHandler}<br>` : ''}
            ${item.rootCauseAction ? `åŸå› ãƒ»å¯¾ç­–: ${item.rootCauseAction}<br>` : ''}
            ${item.maintenanceUnit ? `ä¿å…¨å˜ä½: ${item.maintenanceUnit}<br>` : ''}
            ${item.lifespan ? `å‘½æ•°æœ‰ç„¡: ${item.lifespan}<br>` : ''}
            ${item.recurrenceType ? `åˆ†é¡: ${item.recurrenceType}` : ''}
          </div>
          ${photosHtml}
          <button class="btn-small" style="background:#2196f3;color:#fff;margin-top:10px;width:100%;" onclick="showSimilarCaseDetail('${item._id}')">
            ğŸ“‹ è©³ç´°ã‚’è¦‹ã‚‹
          </button>
        </div>
      `;
    }).join('');
  }

  function setNowDateTo(id){
    const now = new Date(); const hour=now.getHours();
    if (hour>=0 && hour<6) now.setDate(now.getDate()-1);
    const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0');
    document.getElementById(id).value = `${y}-${m}-${d}`;
  }
  function setNowTimeTo(id){
    const now=new Date(); const hh=String(now.getHours()).padStart(2,'0'), mm=String(now.getMinutes()).padStart(2,'0');
    document.getElementById(id).value = `${hh}:${mm}`;
  }
  document.getElementById('btnNowDate').addEventListener('click', ()=>setNowDateTo('occurrenceDate'));
  document.querySelectorAll('button[data-now]').forEach(b=> b.addEventListener('click', ()=> setNowTimeTo(b.getAttribute('data-now')) ));

  function displayPhotos(previewId, arr){
    const wrap = document.getElementById(previewId); wrap.innerHTML='';
    arr.forEach((src,idx)=>{
      const div=document.createElement('div'); div.className='photo-item';
      div.innerHTML = `<img src="${src}"><button class="remove-btn" data-photo="${previewId}" data-index="${idx}">Ã—</button>`;
      wrap.appendChild(div);
    });
  }

function handlePhotoUpload(inputId, previewId, arrRef){
  const input = document.getElementById(inputId);
  if (!input) return;

  if (input._photoHandler) {
    input.removeEventListener('change', input._photoHandler);
  }

  const handler = (e)=>{
    (Array.from(e.target.files||[])).forEach(file=>{
      const r=new FileReader();
      r.onload = ev=>{
        arrRef.push({name:file.name, file, preview:ev.target.result});
        displayPhotos(previewId, arrRef.map(x=>x.preview));
      };
      r.readAsDataURL(file);
    });
    input.value='';
  };

  input.addEventListener('change', handler);
  input._photoHandler = handler;
}

  document.addEventListener('click',(e)=>{
    const rm=e.target.closest('.remove-btn[data-photo]'); if(!rm) return;
    const id=rm.getAttribute('data-photo'); const idx=Number(rm.getAttribute('data-index'));
    if (id==='mfgPhotoPreview'){ mfgPhotos.splice(idx,1); displayPhotos(id, mfgPhotos.map(x=>x.preview)); }
    if (id==='techPhotoPreview'){ techPhotos.splice(idx,1); displayPhotos(id, techPhotos.map(x=>x.preview)); }
  });

function bindPhotoInputs(){
  handlePhotoUpload('mfgPhotos','mfgPhotoPreview', mfgPhotos);
  handlePhotoUpload('techPhotos','techPhotoPreview', techPhotos);
  handlePhotoUpload('edit_mfgPhotos','edit_mfgPhotoPreview', editMfgPhotos);
  handlePhotoUpload('edit_techPhotos','edit_techPhotoPreview', editTechPhotos);
}

  function updateDepartmentSelect(selectId, departments){
    const sel=document.getElementById(selectId); if(!sel) return;
    const keep=sel.value;
    sel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    departments.forEach(d=>{ const o=document.createElement('option'); o.value=o.textContent=d; sel.appendChild(o); });
    if (departments.includes(keep)) sel.value=keep;
  }
  function refreshLineAndHandler(deptSelId, lineSelId, handlerSelId, lines, handlers){
    const dept=document.getElementById(deptSelId).value;
    const lineSel=document.getElementById(lineSelId), handlerSel=document.getElementById(handlerSelId);
    lineSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    handlerSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    (lines[dept]||[]).forEach(l=>{ const o=document.createElement('option'); o.value=o.textContent=l; lineSel.appendChild(o); });
    (handlers[dept]||[]).forEach(h=>{ const o=document.createElement('option'); o.value=o.textContent=h; handlerSel.appendChild(o); });
  }

  function calcStopMinutes(item){
    const ot = item.occurrenceTime || '';
    const rt = item.restartTime || '';
    if (!ot || !rt) return null;
    const [oh,om] = ot.split(':').map(Number);
    const [rh,rm] = rt.split(':').map(Number);
    let diff = (rh*60+rm) - (oh*60+om);
    if (isNaN(diff)) return null;
    if (diff < 0) diff += 1440;
    return diff;
  }
  function badgeClassByMinutes(m){
    if (m === null) return '';
    if (m >= 30) return 'danger';
    if (m >= 10) return 'warn';
    return '';
  }

async function uploadPhotos(docId, kind, items) {
  console.log(`=== Starting upload: ${items.length} files for ${kind} ===`);
  const urls = [];
  
  for (let i = 0; i < items.length; i++) {
    const item = items[i];
    try {
      const timestamp = Date.now() + i;
      const extension = item.name.split('.').pop();
      const fileName = `${timestamp}.${extension}`;
      const path = `anomalies/${docId}/${kind}/${fileName}`;
      
      const storageRef = ref(storage, path);
      const metadata = {
        contentType: item.file.type,
        customMetadata: {
          'originalName': item.name,
          'uploadedAt': new Date().toISOString()
        }
      };
      
      const uploadResult = await uploadBytes(storageRef, item.file, metadata);
      const url = await getDownloadURL(uploadResult.ref);
      urls.push(url);
      
    } catch (error) {
      console.error(`âŒ Upload failed for file ${i + 1}:`, error);
      let errorMsg = `ç”»åƒ ${i + 1} ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n`;
      if (error.code === 'storage/unauthorized') {
        errorMsg += 'ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚Firebase Storageã®ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
      } else if (error.code === 'storage/quota-exceeded') {
        errorMsg += 'ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®å®¹é‡ãŒä¸Šé™ã«é”ã—ã¦ã„ã¾ã™ã€‚';
      } else {
        errorMsg += `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
      }
      alert(errorMsg);
      throw error;
    }
  }
  
  return urls;
}

// ç™ºä¿¡éƒ¨ç½²ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
let isSubmittingMfg = false;

document.getElementById('manufacturingForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  if (isSubmittingMfg) return;
  
  isSubmittingMfg = true;
  
  const submitBtn = e.target.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.textContent = 'ç™»éŒ²ä¸­...';
  
  try {
    const techReq = document.getElementById('techRequest').value;
    const mRec = (document.getElementById('mfg_recurrenceType')?.value || '').trim();
    const mMs  = (document.getElementById('mfg_measureStatus')?.value || '').trim();

    if (mRec === 'å†ç™º' && !mMs) {
      const go = confirm('ã€Œå†ç™ºã€ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™ãŒã€å¯¾ç­–çŠ¶æ³ãŒæœªå…¥åŠ›ã§ã™ã€‚\nã“ã®ã¾ã¾ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ');
      if (!go) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ç™»éŒ²';
        isSubmittingMfg = false;
        return;
      }
    }

    // å¤‰åŒ–ç‚¹ãƒ‡ãƒ¼ã‚¿
    const hasChangePoint = document.getElementById('mfg_hasChangePoint').checked;
    const changePointCategory = hasChangePoint ? document.getElementById('mfg_changePointCategory').value : '';
    const changePointContent = hasChangePoint ? document.getElementById('mfg_changePointContent').value : '';

    if (hasChangePoint && !changePointCategory) {
      alert('å¤‰åŒ–ç‚¹ã‚ã‚Šã®å ´åˆã¯ã€å¤‰åŒ–ç‚¹åˆ†é¡ã‚’é¸æŠã—ã¦ãã ã•ã„');
      submitBtn.disabled = false;
      submitBtn.textContent = 'ç™»éŒ²';
      isSubmittingMfg = false;
      return;
    }

const base = {
  department: document.getElementById('department').value,
  lineName: document.getElementById('lineName').value,
  serialNo: document.getElementById('serialNo').value,
  lotNo: document.getElementById('lotNo').value || '',
  occurrenceDate: document.getElementById('occurrenceDate').value,
  occurrenceTime: document.getElementById('occurrenceTime').value || '',
  restartTime: document.getElementById('restartTime').value || '',
  anomalyContent: document.getElementById('anomalyContent').value,
  actionTaken: document.getElementById('actionTaken').value,
  traceback: document.getElementById('traceback').value,
  qualityResponse: document.getElementById('qualityResponse').value || '',
  handler: document.getElementById('handler').value,
  techRequest: techReq,
  status: techReq === 'å®Œçµ' ? 'complete' : 'pending',
  createdAt: serverTimestamp(),
  techHandler: '',
  lifespan: '',
  maintenanceUnit: '',
  rootCauseAction: '',
  discoveryTiming: document.getElementById('discoveryTiming').value || '',
  recurrenceType: mRec,
  measureStatus: (mRec === 'å†ç™º') ? mMs : '',
  previousCheck: '',
  lifespanReached: '',
  affirmation: '',
  mfgPhotoUrls: [],
  techPhotoUrls: [],
  // å¤‰åŒ–ç‚¹ãƒ‡ãƒ¼ã‚¿
  changePointCategory: changePointCategory,
  changePointContent: changePointContent
};

    const docRef = await addDoc(collection(db, 'anomalies'), base);
       // å¤‰åŒ–ç‚¹ãŒã‚ã‚‹å ´åˆã€changepointsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚‚è¨˜éŒ²
    if (hasChangePoint && changePointCategory) {
      const changepointData = {
        type: 'sudden',
        category: changePointCategory,
        content: changePointContent,
        department: base.department,
        lineName: base.lineName,
        serialNo: base.serialNo,
        occurrenceDate: base.occurrenceDate,
        occurrenceTime: base.occurrenceTime || '',
        relatedAnomalyId: docRef.id,
        createdAt: serverTimestamp()
      };
      await addDoc(collection(db, 'changepoints'), changepointData);
    }
    if (mfgPhotos.length > 0) {
      submitBtn.textContent = `ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­... (${mfgPhotos.length}æš)`;
      const photoUrls = await uploadPhotos(docRef.id, 'mfg', mfgPhotos);
      await updateDoc(doc(db, 'anomalies', docRef.id), { mfgPhotoUrls: photoUrls });
      
      const newDoc = { _id: docRef.id, ...base, mfgPhotoUrls: photoUrls };
      anomalyCache.unshift(newDoc);
      filteredCache = [newDoc, ...filteredCache];
      renderHistory();
    } else {
      const newDoc = { _id: docRef.id, ...base };
      anomalyCache.unshift(newDoc);
      filteredCache = [newDoc, ...filteredCache];
      renderHistory();
    }
    
    e.target.reset();
    mfgPhotos = [];
    document.getElementById('mfgPhotoPreview').innerHTML = '';
    document.getElementById('lineName').innerHTML = '<option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>';
    document.getElementById('handler').innerHTML = '<option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>';

    // å¤‰åŒ–ç‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('mfg_hasChangePoint').checked = false;
    document.getElementById('mfg_changePointFields').classList.remove('active');
    document.getElementById('mfg_changePointCategory').value = '';
    document.getElementById('mfg_changePointContent').value = '';

    const mfgRecSel2 = document.getElementById('mfg_recurrenceType');
    const mfgMs2 = document.getElementById('mfg_measureStatus');
    const mfgMsGrp2 = document.getElementById('mfg_measureStatusGroup');
    if (mfgRecSel2) mfgRecSel2.value = '';
    if (mfgMs2) mfgMs2.value = '';
    if (mfgMsGrp2) mfgMsGrp2.style.display = 'none';

    alert('ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
    
  } catch (error) {
    console.error('Form submission error:', error);
    alert(`ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ${error.message}`);
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'ç™»éŒ²';
    isSubmittingMfg = false;
  }
});

// æŠ€è¡“ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
let isSubmittingTech = false;

document.getElementById('technicalForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  if (isSubmittingTech) return;
  
  isSubmittingTech = true;
  
  const submitBtn = e.target.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.textContent = 'ç™»éŒ²ä¸­...';
  
  try {
    const id = document.getElementById('selectSerialNo').value;
    if (!id) {
      alert('æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    
    const recType = document.getElementById('recurrenceType').value;
    const ms = (document.getElementById('measureStatus')?.value || '').trim();
    const rootText = document.getElementById('rootCauseAction').value || '';

    // å¤‰åŒ–ç‚¹ãƒ‡ãƒ¼ã‚¿
    const hasChangePoint = document.getElementById('tech_hasChangePoint').checked;
    const changePointCategory = hasChangePoint ? document.getElementById('tech_changePointCategory').value : '';
    const changePointContent = hasChangePoint ? document.getElementById('tech_changePointContent').value : '';

    if (hasChangePoint && !changePointCategory) {
      alert('å¤‰åŒ–ç‚¹ã‚ã‚Šã®å ´åˆã¯ã€å¤‰åŒ–ç‚¹åˆ†é¡ã‚’é¸æŠã—ã¦ãã ã•ã„');
      submitBtn.disabled = false;
      submitBtn.textContent = 'ç™»éŒ²';
      isSubmittingTech = false;
      return;
    }

const updates = {
  techHandler: document.getElementById('techHandler').value,
  previousCheck: document.getElementById('previousCheck').value || '',
  lifespan: document.getElementById('lifespan').value,
  lifespanReached: document.getElementById('lifespanReached').value,
  maintenanceUnit: document.getElementById('maintenanceUnit').value,
  rootCauseAction: rootText,
  recurrenceType: recType,
  measureStatus: (recType === 'å†ç™º') ? ms : '',
  affirmation: document.getElementById('affirmation').value,
  // å¤‰åŒ–ç‚¹ãƒ‡ãƒ¼ã‚¿
  changePointCategory: changePointCategory,
  changePointContent: changePointContent
};

if (rootText.trim()) {
  updates.status = 'complete';
  updates.completedAt = serverTimestamp();
} else {
  updates.status = 'pending';
}

    if (techPhotos.length > 0) {
      submitBtn.textContent = `ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­... (${techPhotos.length}æš)`;
      const photoUrls = await uploadPhotos(id, 'tech', techPhotos);
      const existingUrls = anomalyCache.find(x => x._id === id)?.techPhotoUrls || [];
      updates.techPhotoUrls = [...existingUrls, ...photoUrls];
    }
    
    await updateDoc(doc(db, 'anomalies', id), updates);
      // å¤‰åŒ–ç‚¹ãŒã‚ã‚‹å ´åˆã€changepointsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚‚è¨˜éŒ²
    if (hasChangePoint && changePointCategory) {
      const existingItem = anomalyCache.find(x => x._id === id);
      const changepointData = {
        type: 'sudden',
        category: changePointCategory,
        content: changePointContent,
        department: existingItem?.department || '',
        lineName: existingItem?.lineName || '',
        serialNo: existingItem?.serialNo || '',
        occurrenceDate: existingItem?.occurrenceDate || '',
        occurrenceTime: existingItem?.occurrenceTime || '',
        relatedAnomalyId: id,
        createdAt: serverTimestamp()
      };
      await addDoc(collection(db, 'changepoints'), changepointData);
    }
    const cacheIndex = anomalyCache.findIndex(x => x._id === id);
    if (cacheIndex !== -1) {
      anomalyCache[cacheIndex] = { ...anomalyCache[cacheIndex], ...updates };
      filteredCache = [...anomalyCache];
      renderHistory();
    }
    
    e.target.reset();
    techPhotos = [];
    document.getElementById('techPhotoPreview').innerHTML = '';
    document.getElementById('selectedDataDisplay').style.display = 'none';
    document.getElementById('similarCasesBox').classList.remove('active');
    document.getElementById('previousCheckGroup').style.display = 'none';
    document.getElementById('measureStatusGroup').style.display = 'none';
    
    // å¤‰åŒ–ç‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('tech_hasChangePoint').checked = false;
    document.getElementById('tech_changePointFields').classList.remove('active');
    document.getElementById('tech_changePointCategory').value = '';
    document.getElementById('tech_changePointContent').value = '';
    
    // éå»ã®å¤‰åŒ–ç‚¹ãƒœãƒƒã‚¯ã‚¹ã‚’é–‰ã˜ã‚‹
    document.getElementById('techPastChangePointsBox').classList.remove('active');
    
    showingAllCases = false;
    
    alert('å¯¾å¿œéƒ¨ç½²å…¥åŠ›ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
    
  } catch (error) {
    console.error('Tech form submission error:', error);
    alert(`ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ${error.message}`);
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'ç™»éŒ²';
    isSubmittingTech = false;
  }
});

  // æ•´ç†Noãƒªã‚¹ãƒˆæ›´æ–°
  function updateSerialNoList(){
    const serialNoCounts = {};
    anomalyCache.forEach(item => {
      if (item.serialNo && item.serialNo.trim() !== '') {
        const no = item.serialNo.trim();
        serialNoCounts[no] = (serialNoCounts[no] || 0) + 1;
      }
    });
    const sortedSerialNos = Object.entries(serialNoCounts)
      .sort((a, b) => b[1] - a[1])
      .map(([no, count]) => ({no, count}));
    const datalist = document.getElementById('serialNoList');
    datalist.innerHTML = sortedSerialNos.map(({no, count}) => 
      `<option value="${no}">${no} (${count}ä»¶)</option>`
    ).join('');
  }

/* ãƒ¯ãƒ¼ãƒ‰å€™è£œ - éƒ¨åˆ†ä¸€è‡´å¯¾å¿œç‰ˆï¼ˆFirestoreå…¨ä½“æ¤œç´¢ï¼‰ */

// éƒ¨åˆ†ä¸€è‡´ã§Firestoreå…¨ä½“ã‚’æ¤œç´¢
async function fetchBySerialNoPartialMatch(searchTerm){
  if (!searchTerm || searchTerm.trim() === '') return [];
  
  const normalizedSearch = normalizeSerial(searchTerm);
  if (normalizedSearch.length < 1) return [];
  
  // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const allData = await fetchAllData();
  
  // éƒ¨åˆ†ä¸€è‡´ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  return allData.filter(item => {
    const normalizedSerial = normalizeSerial(item.serialNo || '');
    return normalizedSerial.includes(normalizedSearch);
  });
}

// éåŒæœŸç‰ˆï¼šFirestoreå…¨ä½“ã‹ã‚‰éƒ¨åˆ†ä¸€è‡´æ¤œç´¢
async function extractCommonWordsAsync(field, filterSerialNo = null){
  const words = {};
  
  if (!filterSerialNo || filterSerialNo.trim() === '') {
    return { words: [], count: 0, partialCount: 0 };
  }
  
  // Firestoreå…¨ä½“ã‹ã‚‰éƒ¨åˆ†ä¸€è‡´æ¤œç´¢
  const targetData = await fetchBySerialNoPartialMatch(filterSerialNo);
  
  if (targetData.length === 0) {
    return { words: [], count: 0, partialCount: 0 };
  }
  
  // å®Œå…¨ä¸€è‡´ã®ã‚«ã‚¦ãƒ³ãƒˆ
  const normalizedSearch = normalizeSerial(filterSerialNo);
  const exactMatchCount = targetData.filter(item => 
    normalizeSerial(item.serialNo || '') === normalizedSearch
  ).length;
  
  targetData.forEach(item => {
    const text = item[field] || '';
    const segments = text.split(/[ã€‚ã€\n]/).filter(s => s.trim().length >= 2);
    segments.forEach(seg => {
      const trimmed = seg.trim();
      if (trimmed.length >= 2 && trimmed.length <= 50) {
        words[trimmed] = (words[trimmed] || 0) + 1;
      }
    });
  });
  
  const sortedWords = Object.entries(words)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 20)
    .map(([word]) => word);
  
  return { 
    words: sortedWords, 
    count: exactMatchCount, 
    partialCount: targetData.length 
  };
}

// æ—§é–¢æ•°ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã¿æ¤œç´¢ï¼‰
function extractCommonWords(field, filterSerialNo = null){
  const words = {};
  let targetData = anomalyCache;
  
  if (filterSerialNo && filterSerialNo.trim() !== '') {
    const normalizedSearch = normalizeSerial(filterSerialNo);
    targetData = anomalyCache.filter(item => {
      const normalizedSerial = normalizeSerial(item.serialNo || '');
      return normalizedSerial.includes(normalizedSearch);
    });
    if (targetData.length === 0) return [];
  } else {
    return [];
  }
  
  targetData.forEach(item => {
    const text = item[field] || '';
    const segments = text.split(/[ã€‚ã€\n]/).filter(s => s.trim().length >= 2);
    segments.forEach(seg => {
      const trimmed = seg.trim();
      if (trimmed.length >= 2 && trimmed.length <= 50) {
        words[trimmed] = (words[trimmed] || 0) + 1;
      }
    });
  });
  return Object.entries(words)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 20)
    .map(([word]) => word);
}

// éåŒæœŸç‰ˆãƒ¯ãƒ¼ãƒ‰å€™è£œè¡¨ç¤ºï¼ˆFirestoreå…¨ä½“æ¤œç´¢ï¼‰
async function showWordSuggestionsAsync(targetId, suggestionsBoxId, wordsContainerId, field){
  const serialNo = document.getElementById('serialNo').value.trim();
  const box = document.getElementById(suggestionsBoxId);
  const container = document.getElementById(wordsContainerId);
  const header = box.querySelector('.word-suggestion-header');
  
  if (!serialNo) { 
    box.classList.remove('active'); 
    return; 
  }
  
  // æ¤œç´¢ä¸­è¡¨ç¤º
  if (header) header.innerHTML = 'ğŸ” æ¤œç´¢ä¸­...';
  container.innerHTML = '<div class="searching-indicator"><div class="spinner"></div>Firestoreå…¨ä½“ã‚’æ¤œç´¢ä¸­...</div>';
  box.classList.add('active');
  
  try {
    const result = await extractCommonWordsAsync(field, serialNo);
    
    if (result.words.length === 0) { 
      if (header) header.textContent = 'ğŸ’¡ å€™è£œãªã—';
      container.innerHTML = '<div style="color:#999;padding:10px;">è©²å½“ã™ã‚‹éå»ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return; 
    }
    
    const headerText = `ğŸ’¡ æ•´ç†Noã€Œ${serialNo}ã€ã®éå»ã®è¡¨ç¾ï¼ˆå®Œå…¨ä¸€è‡´:${result.count}ä»¶ï¼éƒ¨åˆ†ä¸€è‡´:${result.partialCount}ä»¶ï¼‰`;
    if (header) header.textContent = headerText;
    
    container.innerHTML = result.words.map(word => 
      `<span class="word-tag" data-word="${word}">${word}</span>`
    ).join('');
    
    container.querySelectorAll('.word-tag').forEach(tag => {
      tag.addEventListener('click', () => {
        const textarea = document.getElementById(targetId);
        const word = tag.getAttribute('data-word');
        const currentValue = textarea.value;
        const cursorPos = textarea.selectionStart;
        const before = currentValue.substring(0, cursorPos);
        const after = currentValue.substring(cursorPos);
        const needsSpace = before.length > 0 && !before.match(/[\sã€ã€‚\n]$/);
        const insertion = (needsSpace ? ' ' : '') + word;
        textarea.value = before + insertion + after;
        textarea.focus();
        textarea.selectionStart = textarea.selectionEnd = cursorPos + insertion.length;
      });
    });
  } catch (error) {
    console.error('Word suggestions error:', error);
    if (header) header.textContent = 'ğŸ’¡ ã‚¨ãƒ©ãƒ¼';
    container.innerHTML = '<div style="color:#c62828;padding:10px;">æ¤œç´¢ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
  }
}

// åŒæœŸç‰ˆï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
function showWordSuggestions(targetId, suggestionsBoxId, wordsContainerId, field){
  showWordSuggestionsAsync(targetId, suggestionsBoxId, wordsContainerId, field);
}

document.getElementById('anomalyContent').addEventListener('focus', () => {
  showWordSuggestions('anomalyContent', 'anomalyWordSuggestions', 'anomalyWords', 'anomalyContent');
});
document.getElementById('actionTaken').addEventListener('focus', () => {
  showWordSuggestions('actionTaken', 'actionWordSuggestions', 'actionWords', 'actionTaken');
});

// æ•´ç†Noå…¥åŠ›æ™‚ã®æƒ…å ±æ›´æ–°ï¼ˆéåŒæœŸç‰ˆãƒ»éƒ¨åˆ†ä¸€è‡´å¯¾å¿œï¼‰
let serialNoSearchTimeout = null;
document.getElementById('serialNo').addEventListener('input', () => {
  const serialNo = document.getElementById('serialNo').value.trim();
  const infoBox = document.getElementById('serialNoInfo');
  const countSpan = document.getElementById('serialNoCount');
  const partialCountSpan = document.getElementById('serialNoPartialCount');
  
  // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ï¼ˆ300mså¾…æ©Ÿï¼‰
  clearTimeout(serialNoSearchTimeout);
  
  if (serialNo !== '') {
    infoBox.style.display = 'block';
    countSpan.textContent = 'æ¤œç´¢ä¸­...';
    if (partialCountSpan) partialCountSpan.textContent = '';
    
    serialNoSearchTimeout = setTimeout(async () => {
      try {
        const targetData = await fetchBySerialNoPartialMatch(serialNo);
        const normalizedSearch = normalizeSerial(serialNo);
        const exactCount = targetData.filter(item => 
          normalizeSerial(item.serialNo || '') === normalizedSearch
        ).length;
        
        countSpan.textContent = exactCount;
        if (partialCountSpan) partialCountSpan.textContent = targetData.length;
        infoBox.style.display = targetData.length > 0 ? 'block' : 'none';
        
        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚Œã¦ã„ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å€™è£œã‚’æ›´æ–°
        const activeElement = document.activeElement;
        if (activeElement.id === 'anomalyContent') {
          showWordSuggestions('anomalyContent', 'anomalyWordSuggestions', 'anomalyWords', 'anomalyContent');
        } else if (activeElement.id === 'actionTaken') {
          showWordSuggestions('actionTaken', 'actionWordSuggestions', 'actionWords', 'actionTaken');
        }
      } catch (error) {
        console.error('Serial search error:', error);
        countSpan.textContent = 'ã‚¨ãƒ©ãƒ¼';
      }
    }, 300);
  } else {
    infoBox.style.display = 'none';
  }
});

document.getElementById('serialNo').addEventListener('change', () => {
  const anomalyBox = document.getElementById('anomalyWordSuggestions');
  const actionBox = document.getElementById('actionWordSuggestions');
  if (anomalyBox.classList.contains('active')) {
    showWordSuggestions('anomalyContent', 'anomalyWordSuggestions', 'anomalyWords', 'anomalyContent');
  }
  if (actionBox.classList.contains('active')) {
    showWordSuggestions('actionTaken', 'actionWordSuggestions', 'actionWords', 'actionTaken');
  }
});

document.getElementById('anomalyContent').addEventListener('blur', () => {
  setTimeout(() => document.getElementById('anomalyWordSuggestions').classList.remove('active'), 200);
});
document.getElementById('actionTaken').addEventListener('blur', () => {
  setTimeout(() => document.getElementById('actionWordSuggestions').classList.remove('active'), 200);
});

  // ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
  document.querySelectorAll('.view-toggle button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.view-toggle button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentView = btn.getAttribute('data-view');
      
      document.getElementById('cardView').style.display = currentView === 'card' ? 'grid' : 'none';
      document.getElementById('tableView').style.display = currentView === 'table' ? 'block' : 'none';
    });
  });

  // å‰Šé™¤å‡¦ç†
  document.addEventListener('click', async (e) => {
    const delBtn = e.target.closest('button[data-del]');
    if (!delBtn) return;
    
    if (!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    
    const id = delBtn.getAttribute('data-del');
    try {
      await deleteDoc(doc(db, 'anomalies', id));
      anomalyCache = anomalyCache.filter(x => x._id !== id);
      filteredCache = filteredCache.filter(x => x._id !== id);
      renderHistory();
      renderTechTargetSelect();
    } catch (error) {
      alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    }
  });

  // å†™çœŸãƒ¢ãƒ¼ãƒ€ãƒ«
  document.addEventListener('click', (e) => {
    const photoBtn = e.target.closest('button[data-photos]');
    if (!photoBtn) return;
    
    const id = photoBtn.getAttribute('data-photos');
    const item = anomalyCache.find(x => x._id === id);
    if (!item) return;
    
    const allPhotos = [...(item.mfgPhotoUrls || []), ...(item.techPhotoUrls || [])];
    const modal = document.getElementById('photoModal');
    const content = document.getElementById('photoModalContent');
    
    content.innerHTML = allPhotos.map(url => `
      <div style="cursor:pointer;" onclick="window.open('${url}','_blank')">
        <img src="${url}" style="width:100%;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.1);">
      </div>
    `).join('');
    
    modal.classList.add('active');
  });

  document.getElementById('btnPhotoClose').addEventListener('click', () => {
    document.getElementById('photoModal').classList.remove('active');
  });
  document.getElementById('photoModal').addEventListener('click', (e) => {
    if (e.target.id === 'photoModal') {
      document.getElementById('photoModal').classList.remove('active');
    }
  });

  document.getElementById('btnSimilarCaseDetailClose').addEventListener('click', () => {
    document.getElementById('similarCaseDetailModal').classList.remove('active');
  });
  document.getElementById('similarCaseDetailModal').addEventListener('click', (e) => {
    if (e.target.id === 'similarCaseDetailModal') {
      document.getElementById('similarCaseDetailModal').classList.remove('active');
    }
  });

  // CSVå‡ºåŠ›
  document.getElementById('btnExport').addEventListener('click', () => {
    if (!anomalyCache.length){ alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const headers = ['æ•´ç†No','éƒ¨ç½²','ãƒ©ã‚¤ãƒ³å','ç™ºç”Ÿæ—¥','ç™ºç”Ÿæ™‚åˆ»','å†é–‹æ™‚åˆ»','åœæ­¢æ™‚é–“(åˆ†)','ç•°å¸¸å†…å®¹','ç¾å ´å¯¾å¿œ','é¡ã‚Š','å‡¦ç½®è€…','å¯¾å¿œåŒºåˆ†','å¯¾å¿œéƒ¨ç½²_å‡¦ç½®è€…','ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°','å‰å›çµ‚ç‰©ç¢ºèª','å‘½æ•°æœ‰ç„¡','å‘½æ•°åˆ°é”','ä¿å…¨å˜ä½','å‡¦ç½®æ–¹æ³•','å†ç™ºæ–°è¦','å¯¾ç­–çŠ¶æ³','æš«å®š','å¤‰åŒ–ç‚¹åˆ†é¡','å¤‰åŒ–ç‚¹å†…å®¹','çŠ¶æ…‹','_id'];
    const rows = anomalyCache.map(item=>{
      const stopMin = calcStopMinutes(item);
      return [
        item.serialNo||'',item.department||'',item.lineName||'',item.occurrenceDate||'',item.occurrenceTime||'',item.restartTime||'',
        (stopMin!==null?stopMin:''),
        item.anomalyContent||'',item.actionTaken||'',item.traceback||'',item.handler||'',
        item.techRequest==='è¦è«‹'?'æŠ€è¡“ãƒ»ç”ŸæŠ€å¯¾å¿œ':item.techRequest==='å®Œçµ'?'å®Œäº†':'',
        item.techHandler||'',item.discoveryTiming||'',item.previousCheck||'',item.lifespan||'',item.lifespanReached||'',
        item.maintenanceUnit||'',item.rootCauseAction||'',item.recurrenceType||'',item.measureStatus||'',item.affirmation||'',
        item.changePointCategory||'',item.changePointContent||'',
        item.status==='complete'?'å®Œäº†':'å¯¾å¿œéƒ¨ç½²å…¥åŠ›å¾…ã¡', item._id
      ];
    });
    let csv = '\uFEFF' + headers.join(',') + '\n';
    rows.forEach(r=>{ csv += r.map(c=>`"${(c??'').toString().replace(/"/g,'""')}"`).join(',')+'\n'; });
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download=`ç•°å¸¸å±¥æ­´_${new Date().toISOString().split('T')[0]}.csv`; a.click();
  });

  // ãƒã‚¹ã‚¿ç®¡ç†
  async function updateDepartmentList(){
    const list=document.getElementById('departmentList'); list.innerHTML='';
    const snap=await getDocs(collection(db,'masters','department','items'));
    const arr = snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=> a.name.localeCompare(b.name));
    if (!arr.length){ list.innerHTML='<p style="color:#999;text-align:center;">éƒ¨ç½²ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; return; }
    arr.forEach(row=>{
      const div=document.createElement('div');
      div.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#f8f9fa;border-radius:6px;border-left:3px solid #667eea;';
      div.innerHTML = `<span style="font-weight:500;color:#333">${row.name}</span>
        <button class="btn-small btn-delete" data-del-dept="${row.id}">å‰Šé™¤</button>`;
      list.appendChild(div);
    });
    mastersCache = await fetchMasters();
    updateDepartmentSelect('department', mastersCache.departments);
    updateDepartmentSelect('lineManageDept', mastersCache.departments);
    updateDepartmentSelect('handlerManageDept', mastersCache.departments);
  }
  document.getElementById('btnAddDept').addEventListener('click', async ()=>{
    const name=(document.getElementById('newDepartment').value||'').trim();
    if (!name){ alert('éƒ¨ç½²åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    await addDoc(collection(db,'masters','department','items'), {name});
    document.getElementById('newDepartment').value='';
    updateDepartmentList();
  });
document.addEventListener('click', async (e)=>{
  const del = e.target.closest('button[data-del-dept]');
  if (!del) return;

  if (!confirm('ã“ã®éƒ¨ç½²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆç´ã¥ããƒ©ã‚¤ãƒ³ã‚„å‡¦ç½®è€…ã«ã‚‚å½±éŸ¿ã—ã¾ã™ï¼‰')) return;

  await deleteDoc(doc(db,'masters','department','items', del.getAttribute('data-del-dept')));
  updateDepartmentList();
});


  async function updateLineManageList(){
    const dept=document.getElementById('lineManageDept').value;
    const list=document.getElementById('lineList'); 
    list.innerHTML='';
    if (!dept){ list.innerHTML='<p style="color:#999;text-align:center;">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</p>'; return; }
    const snap=await getDocs(query(collection(db,'masters','line','items'), where('department','==',dept)));
    const arr=snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=> a.name.localeCompare(b.name));
    if (!arr.length){ list.innerHTML='<p style="color:#999;text-align:center;">ãƒ©ã‚¤ãƒ³åãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; return; }
    arr.forEach(row=>{
      const div=document.createElement('div');
      div.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#f8f9fa;border-radius:6px;border-left:3px solid #f57c00;';
      div.innerHTML = `<span style="font-weight:500;color:#333">${row.name}</span>
        <button class="btn-small btn-delete" data-del-line="${row.id}">å‰Šé™¤</button>`;
      list.appendChild(div);
    });
  }
  document.getElementById('btnAddLine').addEventListener('click', async ()=>{
    const dept=document.getElementById('lineManageDept').value;
    const name=(document.getElementById('newLine').value||'').trim();
    if (!dept){ alert('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    if (!name){ alert('ãƒ©ã‚¤ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    await addDoc(collection(db,'masters','line','items'), {department:dept, name});
    document.getElementById('newLine').value='';
    mastersCache = await fetchMasters();
    await updateLineManageList();
  });
document.addEventListener('click', async (e)=>{
  const del = e.target.closest('button[data-del-line]');
  if (!del) return;

  if (!confirm('ã“ã®ãƒ©ã‚¤ãƒ³åã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

  await deleteDoc(doc(db,'masters','line','items', del.getAttribute('data-del-line')));
  mastersCache = await fetchMasters();
  await updateLineManageList();
});


  async function updateHandlerManageList(){
    const dept=document.getElementById('handlerManageDept').value;
    const list=document.getElementById('handlerList'); 
    list.innerHTML='';
    if (!dept){ list.innerHTML='<p style="color:#999;text-align:center;">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</p>'; return; }
    const snap=await getDocs(query(collection(db,'masters','handler','items'), where('department','==',dept)));
    const arr=snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=> a.name.localeCompare(b.name));
    if (!arr.length){ list.innerHTML='<p style="color:#999;text-align:center;">å‡¦ç½®è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; return; }
    arr.forEach(row=>{
      const div=document.createElement('div');
      div.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#f8f9fa;border-radius:6px;border-left:3px solid #2e7d32;';
      div.innerHTML = `<span style="font-weight:500;color:#333">${row.name}</span>
        <button class="btn-small btn-delete" data-del-handler="${row.id}">å‰Šé™¤</button>`;
      list.appendChild(div);
    });
  }
  document.getElementById('btnAddHandler').addEventListener('click', async ()=>{
    const dept=document.getElementById('handlerManageDept').value;
    const name=(document.getElementById('newHandler').value||'').trim();
    if (!dept){ alert('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    if (!name){ alert('å‡¦ç½®è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    await addDoc(collection(db,'masters','handler','items'), {department:dept, name});
    document.getElementById('newHandler').value='';
    mastersCache = await fetchMasters();
    await updateHandlerManageList();
  });
  document.addEventListener('click', async (e)=>{
    const del=e.target.closest('button[data-del-handler]'); if (!del) return;
    await deleteDoc(doc(db,'masters','handler','items', del.getAttribute('data-del-handler')));
    mastersCache = await fetchMasters();
    await updateHandlerManageList();
  });

  // éå»ã®ç•°å¸¸å±¥æ­´ãƒœã‚¿ãƒ³
  document.getElementById('btnShowPastOnMfg')?.addEventListener('click', async () => {
    const serialNo = document.getElementById('serialNo').value.trim();
    if (!serialNo) {
      alert('æ•´ç†Noã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    const box = document.getElementById('mfgSimilarBox');
    const content = document.getElementById('mfgSimilarContent');
    
    content.innerHTML = '<div style="text-align:center;padding:20px;">æ¤œç´¢ä¸­...</div>';
    box.classList.add('active');
    
    try {
      const allData = await fetchAllData();
      const normalizedSearch = normalizeSerial(serialNo);
      
      const matchingData = allData.filter(item => {
        const normalizedSerial = normalizeSerial(item.serialNo || '');
        return normalizedSerial.includes(normalizedSearch) && item.status === 'complete';
      }).sort((a, b) => (b.occurrenceDate || '').localeCompare(a.occurrenceDate || ''));
      
      if (matchingData.length === 0) {
        content.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">è©²å½“ã™ã‚‹éå»ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      const displayData = matchingData.slice(0, 5);
      content.innerHTML = renderSimilarList(displayData.map(item => ({
        ...item,
        similarity: 100
      })));
      
      const showMoreBtn = document.getElementById('mfgShowMore');
      if (matchingData.length > 5) {
        showMoreBtn.style.display = 'block';
        showMoreBtn.onclick = () => {
          content.innerHTML = renderSimilarList(matchingData.map(item => ({
            ...item,
            similarity: 100
          })));
          showMoreBtn.style.display = 'none';
        };
      } else {
        showMoreBtn.style.display = 'none';
      }
      
    } catch (error) {
      console.error('Error fetching past data:', error);
      content.innerHTML = '<div style="text-align:center;padding:20px;color:#c62828;">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
    }
  });

  document.getElementById('btnShowPastOnTech')?.addEventListener('click', async () => {
    const id = document.getElementById('selectSerialNo').value;
    if (!id) {
      alert('æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    
    const d = anomalyCache.find(it => it._id === id);
    if (!d) return;
    
    const box = document.getElementById('similarCasesBox');
    const content = document.getElementById('similarCasesContent');
    
    const similar = findSimilarCandidates(d, 20);
    if (similar.length > 0) {
      content.innerHTML = renderSimilarList(similar);
      box.classList.add('active');
    } else {
      content.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">é¡ä¼¼æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      box.classList.add('active');
    }
  });

  // æŠ€è¡“æ›´æ–°ãƒœã‚¿ãƒ³
  document.getElementById('btnRefreshTech')?.addEventListener('click', async () => {
    await loadInitialData();
    renderTechTargetSelect();
    alert('ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
  });

  // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  const importModal = document.getElementById('importModal');
  document.getElementById('btnImport').addEventListener('click', () => {
    importModal.classList.add('active');
  });
  document.getElementById('btnImportClose').addEventListener('click', () => {
    importModal.classList.remove('active');
  });

  // é¡ä¼¼æ¡ˆä»¶è©³ç´°è¡¨ç¤º
  window.showSimilarCaseDetail = function(id) {
    const item = anomalyCache.find(x => x._id === id);
    if (!item) return;
    
    const allPhotos = [...(item.mfgPhotoUrls || []), ...(item.techPhotoUrls || [])];
    const photosHtml = allPhotos.length ? `
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-top:15px;">
        ${allPhotos.map(url => `
          <div style="cursor:pointer;" onclick="window.open('${url}','_blank')">
            <img src="${url}" style="width:100%;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.1);">
          </div>
        `).join('')}
      </div>
    ` : '';
    
    // å¤‰åŒ–ç‚¹æƒ…å ±
    const changePointHtml = item.changePointCategory ? `
      <div style="margin-top:15px;padding:12px;background:#e3f2fd;border-radius:6px;">
        <h4 style="color:#1565c0;margin-bottom:8px;">ğŸ”„ å¤‰åŒ–ç‚¹æƒ…å ±</h4>
        <p><strong>åˆ†é¡:</strong> ${item.changePointCategory}</p>
        ${item.changePointContent ? `<p><strong>å†…å®¹:</strong> ${item.changePointContent}</p>` : ''}
      </div>
    ` : '';
    
    const modal = document.getElementById('similarCaseDetailModal');
    const content = document.getElementById('similarCaseDetailContent');
    
    content.innerHTML = `
      <div style="display:grid;gap:12px;">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div><strong>æ•´ç†No:</strong> ${item.serialNo || '-'}</div>
          <div><strong>ç™ºç”Ÿæ—¥:</strong> ${item.occurrenceDate || '-'} ${item.occurrenceTime || ''}</div>
          <div><strong>éƒ¨ç½²:</strong> ${item.department || '-'}</div>
          <div><strong>ãƒ©ã‚¤ãƒ³:</strong> ${item.lineName || '-'}</div>
        </div>
        <div style="background:#f8f9fa;padding:12px;border-radius:6px;">
          <h4 style="color:#667eea;margin-bottom:8px;">ç•°å¸¸å†…å®¹</h4>
          <p>${item.anomalyContent || '-'}</p>
        </div>
        <div style="background:#f8f9fa;padding:12px;border-radius:6px;">
          <h4 style="color:#667eea;margin-bottom:8px;">ç¾å ´å¯¾å¿œ</h4>
          <p>${item.actionTaken || '-'}</p>
        </div>
        <div style="background:#e8f5e9;padding:12px;border-radius:6px;">
          <h4 style="color:#2e7d32;margin-bottom:8px;">å‡¦ç½®æ–¹æ³•</h4>
          <p>${item.rootCauseAction || '-'}</p>
          ${item.techHandler ? `<p><strong>å¯¾å¿œéƒ¨ç½²_å‡¦ç½®è€…:</strong> ${item.techHandler}</p>` : ''}
          ${item.maintenanceUnit ? `<p><strong>ä¿å…¨å˜ä½:</strong> ${item.maintenanceUnit}</p>` : ''}
        </div>
        ${changePointHtml}
        ${photosHtml}
      </div>
    `;
    
    modal.classList.add('active');
  };
// ========== ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½ ==========
  let editingId = null;
  let editCurrentTab = 'mfg';

  // ç·¨é›†ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  document.addEventListener('click', (e) => {
    const editBtn = e.target.closest('button[data-edit]');
    if (!editBtn) return;
    
    editingId = editBtn.getAttribute('data-edit');
    editCurrentTab = 'mfg';
    editMfgPhotos = [];
    editTechPhotos = [];
    renderEditModalUI();
    document.getElementById('editModal').classList.add('active');
  });

  // ç·¨é›†ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
  document.addEventListener('click', (e) => {
    const tab = e.target.closest('.edit-tab');
    if (!tab) return;
    
    document.querySelectorAll('.edit-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    editCurrentTab = tab.getAttribute('data-edit-tab');
    renderEditModalUI();
  });

  // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«UIæç”»
  function renderEditModalUI() {
    const item = anomalyCache.find(x => x._id === editingId);
    if (!item) return;
    
    const container = document.getElementById('editFormContent');
    
    if (editCurrentTab === 'mfg') {
      container.innerHTML = `
        <div class="form-group"><label>æ•´ç†No</label><input type="text" id="edit_serialNo" value="${item.serialNo || ''}"></div>
        <div class="form-group"><label>ç™ºç”Ÿæ—¥</label><input type="date" id="edit_occurrenceDate" value="${item.occurrenceDate || ''}"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div class="form-group"><label>ç™ºç”Ÿæ™‚åˆ»</label><input type="time" id="edit_occurrenceTime" value="${item.occurrenceTime || ''}"></div>
          <div class="form-group"><label>å†é–‹æ™‚åˆ»</label><input type="time" id="edit_restartTime" value="${item.restartTime || ''}"></div>
        </div>
        <div class="form-group"><label>ç•°å¸¸å†…å®¹</label><textarea id="edit_anomalyContent">${item.anomalyContent || ''}</textarea></div>
        <div class="form-group"><label>ç¾å ´å¯¾å¿œ</label><textarea id="edit_actionTaken">${item.actionTaken || ''}</textarea></div>
        <div class="form-group"><label>é¡ã‚Š</label><input type="text" id="edit_traceback" value="${item.traceback || ''}"></div>
        <div class="form-group"><label>LotNo</label><input type="text" id="edit_lotNo" value="${item.lotNo || ''}"></div>
        <div class="form-group"><label>å“è³ªå¯¾å¿œ</label><textarea id="edit_qualityResponse">${item.qualityResponse || ''}</textarea></div>
        <div class="form-group">
          <label>å¤‰åŒ–ç‚¹åˆ†é¡</label>
          <select id="edit_changePointCategory">
            <option value="">ãªã—</option>
            <option value="äºº" ${item.changePointCategory === 'äºº' ? 'selected' : ''}>äºº</option>
            <option value="æ–¹æ³•" ${item.changePointCategory === 'æ–¹æ³•' ? 'selected' : ''}>æ–¹æ³•</option>
            <option value="ææ–™" ${item.changePointCategory === 'ææ–™' ? 'selected' : ''}>ææ–™</option>
            <option value="é‡‘å‹" ${item.changePointCategory === 'é‡‘å‹' ? 'selected' : ''}>é‡‘å‹</option>
            <option value="è¨­å‚™" ${item.changePointCategory === 'è¨­å‚™' ? 'selected' : ''}>è¨­å‚™</option>
            <option value="ãã®ä»–" ${item.changePointCategory === 'ãã®ä»–' ? 'selected' : ''}>ãã®ä»–</option>
          </select>
        </div>
        <div class="form-group"><label>å¤‰åŒ–ç‚¹å†…å®¹</label><textarea id="edit_changePointContent">${item.changePointContent || ''}</textarea></div>
        <div class="form-group">
          <label>å†™çœŸè¿½åŠ </label>
          <div class="photo-upload" onclick="document.getElementById('edit_mfgPhotos').click()">
            <div style="font-size:1.5rem;">ğŸ“¸</div><p>å†™çœŸã‚’è¿½åŠ </p>
            <input type="file" id="edit_mfgPhotos" accept="image/*" multiple>
          </div>
          <div id="edit_mfgPhotoPreview" class="photo-preview"></div>
        </div>
        ${(item.mfgPhotoUrls && item.mfgPhotoUrls.length) ? `
          <div class="form-group">
            <label>æ—¢å­˜å†™çœŸï¼ˆç™ºä¿¡éƒ¨ç½²ï¼‰</label>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
              ${item.mfgPhotoUrls.map(url => `<img src="${url}" style="width:100%;border-radius:4px;cursor:pointer;" onclick="window.open('${url}','_blank')">`).join('')}
            </div>
          </div>
        ` : ''}
      `;
    } else {
      container.innerHTML = `
        <div class="form-group"><label>å¯¾å¿œéƒ¨ç½²_å‡¦ç½®è€…</label><input type="text" id="edit_techHandler" value="${item.techHandler || ''}"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div class="form-group">
            <label>å‘½æ•°æœ‰ç„¡</label>
            <select id="edit_lifespan">
              <option value="">é¸æŠ</option>
              <option value="æœ‰" ${item.lifespan === 'æœ‰' ? 'selected' : ''}>æœ‰</option>
              <option value="ç„¡" ${item.lifespan === 'ç„¡' ? 'selected' : ''}>ç„¡</option>
            </select>
          </div>
          <div class="form-group">
            <label>å‘½æ•°åˆ°é”</label>
            <select id="edit_lifespanReached">
              <option value="">é¸æŠ</option>
              <option value="è‡³" ${item.lifespanReached === 'è‡³' ? 'selected' : ''}>è‡³</option>
              <option value="æœª" ${item.lifespanReached === 'æœª' ? 'selected' : ''}>æœª</option>
            </select>
          </div>
        </div>
        <div class="form-group"><label>ä¿å…¨å˜ä½</label><input type="text" id="edit_maintenanceUnit" value="${item.maintenanceUnit || ''}"></div>
        <div class="form-group"><label>ä½•ãŒæ‚ªãã©ã†ã—ãŸ</label><textarea id="edit_rootCauseAction">${item.rootCauseAction || ''}</textarea></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div class="form-group">
            <label>å†ç™º/æ–°è¦</label>
            <select id="edit_recurrenceType">
              <option value="">é¸æŠ</option>
              <option value="å†ç™º" ${item.recurrenceType === 'å†ç™º' ? 'selected' : ''}>å†ç™º</option>
              <option value="æ–°è¦" ${item.recurrenceType === 'æ–°è¦' ? 'selected' : ''}>æ–°è¦</option>
              <option value="èª¿ç¯€" ${item.recurrenceType === 'èª¿ç¯€' ? 'selected' : ''}>èª¿ç¯€</option>
            </select>
          </div>
          <div class="form-group">
            <label>æš«å®š</label>
            <select id="edit_affirmation">
              <option value="">é¸æŠ</option>
              <option value="æœ‰" ${item.affirmation === 'æœ‰' ? 'selected' : ''}>æœ‰</option>
              <option value="ç„¡" ${item.affirmation === 'ç„¡' ? 'selected' : ''}>ç„¡</option>
            </select>
          </div>
        </div>
        <div class="form-group"><label>å¯¾ç­–çŠ¶æ³</label>
          <select id="edit_measureStatus">
            <option value="">é¸æŠ</option>
            <option value="å¯¾ç­–æ¤œè¨ä¸­" ${item.measureStatus === 'å¯¾ç­–æ¤œè¨ä¸­' ? 'selected' : ''}>å¯¾ç­–æ¤œè¨ä¸­</option>
            <option value="æš«å®šå¯¾ç­–ä¸­" ${item.measureStatus === 'æš«å®šå¯¾ç­–ä¸­' ? 'selected' : ''}>æš«å®šå¯¾ç­–ä¸­</option>
            <option value="å¯¾ç­–éƒ¨å“å¾…ã¡" ${item.measureStatus === 'å¯¾ç­–éƒ¨å“å¾…ã¡' ? 'selected' : ''}>å¯¾ç­–éƒ¨å“å¾…ã¡</option>
            <option value="æ’ä¹…å¯¾ç­–æ¸ˆ" ${item.measureStatus === 'æ’ä¹…å¯¾ç­–æ¸ˆ' ? 'selected' : ''}>æ’ä¹…å¯¾ç­–æ¸ˆ</option>
            <option value="å¯¾ç­–åŠ¹æœç¢ºèªä¸­" ${item.measureStatus === 'å¯¾ç­–åŠ¹æœç¢ºèªä¸­' ? 'selected' : ''}>å¯¾ç­–åŠ¹æœç¢ºèªä¸­</option>
          </select>
        </div>
        <div style="background:#e3f2fd;padding:15px;border-radius:6px;margin:16px 0;border:2px solid #1976d2;">
          <h4 style="color:#1565c0;margin-bottom:12px;">ğŸ”„ å¤‰åŒ–ç‚¹</h4>
          <div class="form-group">
            <label>å¤‰åŒ–ç‚¹åˆ†é¡</label>
            <select id="edit_tech_changePointCategory">
              <option value="">ãªã—</option>
              <option value="äºº" ${item.changePointCategory === 'äºº' ? 'selected' : ''}>äºº</option>
              <option value="æ–¹æ³•" ${item.changePointCategory === 'æ–¹æ³•' ? 'selected' : ''}>æ–¹æ³•</option>
              <option value="ææ–™" ${item.changePointCategory === 'ææ–™' ? 'selected' : ''}>ææ–™</option>
              <option value="é‡‘å‹" ${item.changePointCategory === 'é‡‘å‹' ? 'selected' : ''}>é‡‘å‹</option>
              <option value="è¨­å‚™" ${item.changePointCategory === 'è¨­å‚™' ? 'selected' : ''}>è¨­å‚™</option>
              <option value="ãã®ä»–" ${item.changePointCategory === 'ãã®ä»–' ? 'selected' : ''}>ãã®ä»–</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom:0;">
            <label>å¤‰åŒ–ç‚¹å†…å®¹</label>
            <textarea id="edit_tech_changePointContent">${item.changePointContent || ''}</textarea>
          </div>
        </div>
        <div class="form-group">
          <label>å†™çœŸè¿½åŠ </label>
          <div class="photo-upload" onclick="document.getElementById('edit_techPhotos').click()">
            <div style="font-size:1.5rem;">ğŸ“¸</div><p>å†™çœŸã‚’è¿½åŠ </p>
            <input type="file" id="edit_techPhotos" accept="image/*" multiple>
          </div>
          <div id="edit_techPhotoPreview" class="photo-preview"></div>
        </div>
        ${(item.techPhotoUrls && item.techPhotoUrls.length) ? `
          <div class="form-group">
            <label>æ—¢å­˜å†™çœŸï¼ˆå¯¾å¿œéƒ¨ç½²ï¼‰</label>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
              ${item.techPhotoUrls.map(url => `<img src="${url}" style="width:100%;border-radius:4px;cursor:pointer;" onclick="window.open('${url}','_blank')">`).join('')}
            </div>
          </div>
        ` : ''}
      `;
    }
    
    bindPhotoInputs();
  }

  // ç·¨é›†ä¿å­˜
  document.getElementById('btnEditSave').addEventListener('click', async () => {
    if (!editingId) return;
    
    const item = anomalyCache.find(x => x._id === editingId);
    if (!item) return;
    
    const btn = document.getElementById('btnEditSave');
    btn.disabled = true;
    btn.textContent = 'ä¿å­˜ä¸­...';
    
    try {
      const updates = {};
      
      if (editCurrentTab === 'mfg') {
        updates.serialNo = document.getElementById('edit_serialNo')?.value || '';
        updates.occurrenceDate = document.getElementById('edit_occurrenceDate')?.value || '';
        updates.occurrenceTime = document.getElementById('edit_occurrenceTime')?.value || '';
        updates.restartTime = document.getElementById('edit_restartTime')?.value || '';
        updates.anomalyContent = document.getElementById('edit_anomalyContent')?.value || '';
        updates.actionTaken = document.getElementById('edit_actionTaken')?.value || '';
        updates.traceback = document.getElementById('edit_traceback')?.value || '';
        updates.lotNo = document.getElementById('edit_lotNo')?.value || '';
        updates.qualityResponse = document.getElementById('edit_qualityResponse')?.value || '';
        updates.changePointCategory = document.getElementById('edit_changePointCategory')?.value || '';
        updates.changePointContent = document.getElementById('edit_changePointContent')?.value || '';
        
        if (editMfgPhotos.length > 0) {
          const newUrls = await uploadPhotos(editingId, 'mfg', editMfgPhotos);
          updates.mfgPhotoUrls = [...(item.mfgPhotoUrls || []), ...newUrls];
        }
      } else {
        updates.techHandler = document.getElementById('edit_techHandler')?.value || '';
        updates.lifespan = document.getElementById('edit_lifespan')?.value || '';
        updates.lifespanReached = document.getElementById('edit_lifespanReached')?.value || '';
        updates.maintenanceUnit = document.getElementById('edit_maintenanceUnit')?.value || '';
        updates.rootCauseAction = document.getElementById('edit_rootCauseAction')?.value || '';
        updates.recurrenceType = document.getElementById('edit_recurrenceType')?.value || '';
        updates.affirmation = document.getElementById('edit_affirmation')?.value || '';
        updates.measureStatus = document.getElementById('edit_measureStatus')?.value || '';
        updates.changePointCategory = document.getElementById('edit_tech_changePointCategory')?.value || '';
        updates.changePointContent = document.getElementById('edit_tech_changePointContent')?.value || '';
        if (editTechPhotos.length > 0) {
          const newUrls = await uploadPhotos(editingId, 'tech', editTechPhotos);
          updates.techPhotoUrls = [...(item.techPhotoUrls || []), ...newUrls];
        }
      }
      
      await updateDoc(doc(db, 'anomalies', editingId), updates);
      
      const idx = anomalyCache.findIndex(x => x._id === editingId);
      if (idx !== -1) {
        anomalyCache[idx] = { ...anomalyCache[idx], ...updates };
        filteredCache = [...anomalyCache];
        renderHistory();
      }
      
      document.getElementById('editModal').classList.remove('active');
      editMfgPhotos = [];
      editTechPhotos = [];
      alert('ä¿å­˜ã—ã¾ã—ãŸ');
      
    } catch (error) {
      alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    } finally {
      btn.disabled = false;
      btn.textContent = 'ä¿å­˜';
    }
  });

  // ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  document.getElementById('btnEditCancel').addEventListener('click', () => {
    document.getElementById('editModal').classList.remove('active');
    editMfgPhotos = [];
    editTechPhotos = [];
  });

  document.getElementById('editModal').addEventListener('click', (e) => {
    if (e.target.id === 'editModal') {
      document.getElementById('editModal').classList.remove('active');
      editMfgPhotos = [];
      editTechPhotos = [];
    }
  });
</script>
 <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="editModal" class="modal" aria-hidden="true">
  <div class="modal-content" style="max-width:800px;">
    <h3 class="modal-title">âœï¸ å±¥æ­´ã®ç·¨é›†</h3>
    <div class="edit-tabs">
      <button class="edit-tab active" data-edit-tab="mfg">ç™ºä¿¡éƒ¨ç½²</button>
      <button class="edit-tab" data-edit-tab="tech">å¯¾å¿œéƒ¨ç½²</button>
    </div>
    <div id="editFormContent"></div>
    <div class="modal-actions">
      <button class="btn btn-primary" id="btnEditSave">ä¿å­˜</button>
      <button class="btn btn-cancel" id="btnEditCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>
 <!-- è»¢é€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="sharePreviewModal" class="modal" aria-hidden="true">
  <div class="modal-content" style="max-width:700px;">
    <h3 class="modal-title">ğŸ“¤ é€ä¿¡å†…å®¹ã®ç¢ºèª</h3>
    <div id="sharePreviewContent"
         style="white-space:pre-wrap; background:#f8f9ff; padding:12px; border-radius:6px; margin-bottom:20px; font-size:.9rem;"></div>

    <div style="display:flex; gap:10px;">
      <button class="btn btn-primary" id="shareSendLine" style="flex:1;">LINEã§é€ä¿¡</button>
      <button class="btn btn-secondary" id="shareSendMail" style="flex:1;">ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡</button>
    </div>
    <button class="btn btn-cancel" id="sharePreviewClose" style="margin-top:12px;">é–‰ã˜ã‚‹</button>
  </div>
</div>

</body>
</html>
