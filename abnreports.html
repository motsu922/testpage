<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•°å¸¸å±¥æ­´å…¥åŠ›ãƒ„ãƒ¼ãƒ«</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Hiragino Sans',sans-serif;background:#f5f5f5}
  .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  .header h1{font-size:1.5rem;margin-bottom:5px}
  .container{max-width:900px;margin:0 auto;padding:10px}
  .tabs{display:flex;background:#fff;margin:15px 0 0;border-radius:8px 8px 0 0;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,.1)}
  .tab{flex:1;padding:15px;text-align:center;cursor:pointer;background:#f8f9fa;border:none;font-size:1rem;font-weight:bold;transition:.3s;color:#666}
  .tab.active{background:#fff;color:#667eea;border-bottom:3px solid #667eea}
  .tab-content{display:none;background:#fff;padding:20px;border-radius:0 0 8px 8px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  .tab-content.active{display:block}
  .form-group{margin-bottom:16px}
  .form-group label{display:block;margin-bottom:8px;font-weight:bold;color:#333;font-size:.95rem}
  .form-group input,.form-group textarea,.form-group select{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:6px;font-size:1rem;transition:border-color .3s}
  .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:#667eea}
  .form-group textarea{min-height:100px;resize:vertical}
  .time-group{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .photo-upload{border:2px dashed #e0e0e0;border-radius:6px;padding:20px;text-align:center;cursor:pointer;transition:.3s}
  .photo-upload:hover{border-color:#667eea;background:#f8f9ff}
  .photo-upload input[type=file]{display:none}
  .photo-preview{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-top:15px}
  .photo-item{position:relative;aspect-ratio:1;border-radius:6px;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,.1)}
  .photo-item img{width:100%;height:100%;object-fit:cover}
  .photo-item .remove-btn{position:absolute;top:5px;right:5px;background:rgba(255,59,48,.9);color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:14px;line-height:1}
  .btn{width:100%;padding:14px;border:none;border-radius:6px;font-size:1rem;font-weight:bold;cursor:pointer;transition:.3s;margin-top:10px}
  .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
  .btn-secondary{background:#6c757d;color:#fff}
  .btn-export{background:#28a745;color:#fff}
  
  /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ */
  .filter-panel{background:#f8f9ff;border:2px solid #667eea;border-radius:8px;padding:16px;margin-bottom:16px;}
  .filter-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
  .filter-title{font-size:1.05rem;font-weight:bold;color:#667eea;display:flex;align-items:center;gap:8px;}
  .filter-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:12px;}
  .filter-date-group{display:flex;gap:8px;align-items:center;}
  .filter-date-group input{flex:1;}
  .filter-date-group .date-btn{padding:8px 12px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:6px;cursor:pointer;font-weight:bold;font-size:.85rem;white-space:nowrap;}
  .filter-date-group .date-btn:hover{background:#667eea;color:#fff;}
  .filter-date-group .date-btn.active{background:#667eea;color:#fff;}
  .filter-actions{display:flex;gap:8px;}
  .filter-actions button{padding:10px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;font-size:.9rem;}
  .btn-filter-apply{background:#667eea;color:#fff;}
  .btn-filter-clear{background:#e0e0e0;color:#333;}
  .filter-result-count{margin-top:12px;padding:10px;background:#fff;border-radius:6px;text-align:center;color:#666;font-size:.9rem;}
  .filter-result-count strong{color:#667eea;}
  
  .history-controls{display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap}
  .view-toggle{display:flex;gap:5px}
  .view-toggle button{padding:8px 12px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:6px;cursor:pointer;font-weight:bold}
  .view-toggle button.active{background:#667eea;color:#fff}
  
  /* PCå‘ã‘æ¨ªé•·ã‚«ãƒ¼ãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
  .card-view{display:grid;gap:16px;}
  .anomaly-card{
    position:relative;
    background:#fff;
    border-radius:8px;
    padding:20px;
    box-shadow:0 2px 8px rgba(0,0,0,.1);
    border-left:4px solid #667eea;
    display:grid;
    grid-template-columns: 200px 1fr 180px;
    gap:20px;
    align-items:start;
  }
  .anomaly-card.complete{border-left-color:#28a745}
  
  /* å·¦ã‚«ãƒ©ãƒ ï¼šåŸºæœ¬æƒ…å ± */
  .card-left{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .card-id{
    font-size:1.2rem;
    font-weight:700;
    color:#667eea;
    margin-bottom:4px;
  }
  .card-status{
    padding:4px 12px;
    border-radius:12px;
    font-size:.85rem;
    font-weight:700;
    text-align:center;
    width:fit-content;
  }
  .status-pending{background:#fff3cd;color:#856404}
  .status-complete{background:#d4edda;color:#155724}
  
  .card-meta{
    display:flex;
    flex-direction:column;
    gap:6px;
    font-size:.9rem;
  }
  .card-meta-item{
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .card-meta-label{
    font-size:.75rem;
    color:#888;
    text-transform:uppercase;
    letter-spacing:0.5px;
  }
  .card-meta-value{
    color:#333;
    font-weight:500;
  }
  
  /* ä¸­å¤®ã‚«ãƒ©ãƒ ï¼šå†…å®¹ */
  .card-center{
    display:flex;
    flex-direction:column;
    gap:12px;
    min-width:0;
  }
  
  .card-content-section{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .card-content-label{
    font-size:.85rem;
    font-weight:bold;
    color:#667eea;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .card-content-text{
    color:#333;
    line-height:1.6;
    font-size:.95rem;
  }
  
  .card-tech-info{
    background:#f8f9ff;
    padding:12px;
    border-radius:6px;
    border-left:3px solid #667eea;
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px;
    font-size:.85rem;
  }
  .tech-info-item{
    display:flex;
    gap:8px;
  }
  .tech-info-label{
    color:#666;
    font-weight:600;
  }
  .tech-info-value{
    color:#333;
  }
  
  /* å³ã‚«ãƒ©ãƒ ï¼šå†™çœŸã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
  .card-right{
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  
  .card-photos-compact{
    display:grid;
    grid-template-columns:repeat(2, 1fr);
    gap:6px;
  }
  .photo-thumb-compact{
    aspect-ratio:1;
    border-radius:6px;
    overflow:hidden;
    box-shadow:0 2px 5px rgba(0,0,0,.1);
    cursor:pointer;
    transition:transform .2s;
  }
  .photo-thumb-compact:hover{
    transform:scale(1.05);
  }
  .photo-thumb-compact img{
    width:100%;
    height:100%;
    object-fit:cover;
  }
  .photo-count-badge{
    text-align:center;
    font-size:.85rem;
    color:#666;
    margin-top:4px;
  }
  
  .action-btns{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .btn-small{
    padding:8px 12px;
    border:none;
    border-radius:4px;
    cursor:pointer;
    font-size:.85rem;
    font-weight:600;
    transition:.2s;
  }
  .btn-edit{background:#ffc107;color:#000}
  .btn-edit:hover{background:#ffb300}
  .btn-delete{background:#dc3545;color:#fff}
  .btn-delete:hover{background:#c82333}
  
/* åœæ­¢æ™‚é–“ãƒãƒƒã‚¸ */
.stop-badge{
  position:absolute;
  right:16px;
  bottom:16px;
  padding:6px 12px;
  border-radius:14px;
  font-weight:700;
  font-size:.9rem;
  color:#fff;
  background:#1976d2;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
}
.stop-badge.warn{background:#f57c00;}
.stop-badge.danger{background:#d32f2f;}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–æ™‚ã®ãƒãƒƒã‚¸ä½ç½®èª¿æ•´ */
@media (max-width:900px){
  .stop-badge{
    right:16px;
    top:auto;
    bottom:16px;
  }
}
  
  /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ“ãƒ¥ãƒ¼ */
  .table-view{overflow-x:auto;display:none}
  .table-view.active{display:block}
 .table-view.fullscreen{
  position:fixed;
  inset:0;
  z-index:1500;
  background:#fff;
  display:block;
  padding:20px;
  overflow:auto;
}
.table-view.fullscreen table{
  font-size:0.9rem;
}
.table-view.fullscreen thead{
  position:sticky;
  top:60px; /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®é«˜ã•åˆ† */
  z-index:5;
}
.fullscreen-controls{
  position:sticky;
  top:0;
  background:#fff;
  padding:10px 0;
  margin-bottom:10px;
  border-bottom:2px solid #667eea;
  display:flex;
  justify-content:space-between;
  align-items:center;
  z-index:10;
}
.fullscreen-controls h3{
  color:#667eea;
  margin:0;
} 
  table{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 1px 6px rgba(0,0,0,.08)}
  th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #eaeaea}
  th{background:#667eea;color:#fff;font-weight:bold;position:sticky;top:0}
  tr:hover{background:#f8f9ff}
  
  .empty-state{text-align:center;padding:36px 20px;color:#999}
  .empty-state-icon{font-size:2.5rem;margin-bottom:10px}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
  .modal.active{display:flex}
  .modal-content{background:#fff;padding:20px;border-radius:8px;max-width:680px;width:95%;max-height:90vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .modal-title{font-size:1.1rem;font-weight:bold;margin-bottom:10px;color:#333}
  .edit-tabs{display:flex;gap:8px;margin:8px 0 16px}
  .edit-tab{flex:1;padding:10px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:6px;cursor:pointer;font-weight:bold}
  .edit-tab.active{background:#667eea;color:#fff}
  .modal-actions{display:flex;gap:10px;margin-top:10px}
  .btn-cancel{background:#9e9e9e;color:#fff}
  
  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ï¼šã‚¿ãƒ–ãƒ¬ãƒƒãƒˆä»¥ä¸‹ */
  @media (max-width:900px){
    .anomaly-card{
      grid-template-columns: 1fr;
      gap:16px;
    }
    .card-right{
      flex-direction:row;
      justify-content:space-between;
    }
    .card-photos-compact{
      flex:1;
      max-width:200px;
    }
    .action-btns{
      flex:1;
    }
    .card-tech-info{
      grid-template-columns:1fr;
    }
    .filter-grid{
      grid-template-columns:1fr;
    }
    .filter-date-group{
      flex-direction:column;
      align-items:stretch;
    }
    .filter-date-group .date-btn{
      width:100%;
    }
  }
  
  @media (max-width:600px){
    .time-group{grid-template-columns:1fr}
    table{font-size:.85rem}
    th,td{padding:8px}
    .card-tech-info{
      grid-template-columns:1fr;
    }
  }
  
  #authGate{position:fixed;inset:0;background:#f5f5f5;display:flex;align-items:center;justify-content:center;z-index:2000}
  #authCard{background:#fff;max-width:380px;width:92%;padding:24px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
  #signOutBtn{position:fixed;right:12px;top:12px;background:#ef5350;color:#fff;border:none;border-radius:6px;padding:8px 12px;cursor:pointer;z-index:1500}
  
  /* ãƒ¯ãƒ¼ãƒ‰å€™è£œ */
  .word-suggestions{position:relative;}
  .word-suggestion-box{position:absolute;z-index:100;background:#fff;border:2px solid #667eea;border-radius:8px;padding:10px;max-height:300px;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,.15);display:none;width:100%;margin-top:5px;}
  .word-suggestion-box.active{display:block;}
  .word-suggestion-header{font-size:.85rem;color:#667eea;font-weight:bold;margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid #e0e0e0;}
  .word-tag{display:inline-block;background:#f0f7ff;color:#667eea;padding:6px 12px;margin:3px;border-radius:16px;cursor:pointer;font-size:.85rem;transition:.2s;border:1px solid #e3f2fd;}
  .word-tag:hover{background:#667eea;color:#fff;transform:translateY(-2px);box-shadow:0 2px 8px rgba(102,126,234,.3);}
  
  /* é¡ä¼¼æ¡ˆä»¶ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ« */
  .similar-cases-box{background:#fff4e6;border:2px solid #f57c00;border-radius:8px;padding:15px;margin-bottom:20px;display:none;}
  .similar-cases-box.active{display:block;}
  .similar-cases-header{color:#f57c00;font-weight:bold;margin-bottom:15px;font-size:1rem;display:flex;align-items:center;gap:8px;}
  .similar-case-item{background:#fff;border-left:3px solid #f57c00;border-radius:6px;padding:12px;margin-bottom:10px;}
  .similar-case-item:last-child{margin-bottom:0;}
  .similar-case-date{font-weight:bold;color:#f57c00;margin-bottom:8px;font-size:.95rem;}
  .similar-case-content{font-size:.9rem;color:#333;line-height:1.5;margin-bottom:8px;}
  .similar-case-tech{margin-top:8px;padding-top:8px;border-top:1px solid #ffe0b2;font-size:.9rem;color:#666;}
  .similar-case-tech strong{color:#f57c00;}
  .show-more-btn{width:100%;padding:10px;background:#fff;color:#f57c00;border:2px solid #f57c00;border-radius:6px;font-weight:bold;cursor:pointer;transition:.2s;margin-top:10px;}
  .show-more-btn:hover{background:#f57c00;color:#fff;}
  .similar-photos{margin-top:8px;display:grid;grid-template-columns:repeat(4,1fr);gap:6px;}
  .similar-photos .thumb{aspect-ratio:1;overflow:hidden;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,.1);cursor:pointer;}
  .similar-photos .thumb img{width:100%;height:100%;object-fit:cover;}
/* å†ç™ºãƒãƒƒã‚¸ */
.anomaly-card { position: relative; } /* å¿µã®ãŸã‚ */
.recur-badge{
  position:absolute;
  bottom:52px;
  right:16px;
  background:#ef4444;     /* èµ¤ç³» */
  color:#fff;
  font-weight:700;
  padding:4px 10px;
  border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
  letter-spacing:.02em;
  z-index:2;
}


 
</style>
</head>
<body>
  <button id="signOutBtn" style="display:none;">ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ</button>

  <div id="authGate">
    <div id="authCard">
      <h2 style="margin-bottom:10px;color:#667eea;">ğŸ” ã‚µã‚¤ãƒ³ã‚¤ãƒ³</h2>
      <p style="color:#666;margin-bottom:15px;">ç¤¾å†…ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
      <div class="form-group">
        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="email" id="authEmail" placeholder="user@miyama-unitec.co.jp">
      </div>
      <div class="form-group">
        <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="authPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <button class="btn btn-primary" id="authLoginBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <p id="authMsg" style="color:#c62828;margin-top:10px;"></p>
    </div>
  </div>

  <div class="header">
    <h1>ğŸ“‹ ç•°å¸¸å±¥æ­´å…¥åŠ›ãƒ„ãƒ¼ãƒ«</h1>
  </div>

  <div class="container" style="display:none" id="appRoot">
    <div class="tabs">
      <button class="tab active" data-tab="manufacturing">ç™ºä¿¡éƒ¨ç½²å…¥åŠ›</button>
      <button class="tab" data-tab="technical">æŠ€è¡“å…¥åŠ›</button>
      <button class="tab" data-tab="history">å±¥æ­´</button>
      <button class="tab" data-tab="master">âš™ï¸ ç®¡ç†</button>
    </div>

    <!-- ç™ºä¿¡éƒ¨ç½²å…¥åŠ› -->
    <div id="manufacturing" class="tab-content active">
      <h2 style="margin-bottom:16px;color:#667eea;">ç•°å¸¸å ±å‘Š</h2>
      <form id="manufacturingForm">
        <div style="background:#f0f7ff;padding:15px;border-radius:6px;margin-bottom:14px;">
          <h3 style="color:#667eea;margin-bottom:12px;font-size:1.05rem;">ğŸ“… ã„ã¤</h3>
          <div class="form-group">
            <label>ç™ºç”Ÿæ—¥ *</label>
            <div style="display:flex;gap:10px;">
              <input type="date" id="occurrenceDate" required style="flex:1;">
              <button type="button" class="btn btn-secondary" style="width:auto;padding:10px 16px;margin:0;background:#17a2b8;" id="btnNowDate">ğŸ“… NOW</button>
            </div>
          </div>
          <div class="form-group">
            <label>æ™‚åˆ»</label>
            <div class="time-group">
              <div>
                <label style="font-weight:normal;font-size:.9rem;">ç™ºç”Ÿæ™‚åˆ»</label>
                <div style="display:flex;gap:5px;">
                  <input type="time" id="occurrenceTime" style="flex:1;">
                  <button type="button" class="btn btn-secondary" style="width:auto;padding:6px 10px;margin:0;font-size:.85rem;background:#17a2b8;" data-now="occurrenceTime">NOW</button>
                </div>
              </div>
              <div>
                <label style="font-weight:normal;font-size:.9rem;">å†é–‹æ™‚åˆ»</label>
                <div style="display:flex;gap:5px;">
                  <input type="time" id="restartTime" style="flex:1;">
                  <button type="button" class="btn btn-secondary" style="width:auto;padding:6px 10px;margin:0;font-size:.85rem;background:#17a2b8;" data-now="restartTime">NOW</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="background:#fff4e6;padding:15px;border-radius:6px;margin-bottom:14px;">
          <h3 style="color:#f57c00;margin-bottom:12px;font-size:1.05rem;">ğŸ“ ã©ã“ã§</h3>
          <div class="form-group"><label>ç™ºä¿¡éƒ¨ç½² *</label><select id="department" required></select></div>
          <div class="form-group"><label>ãƒ©ã‚¤ãƒ³å *</label><select id="lineName" required><option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option></select></div>
          <div class="form-group"><label>å‡¦ç½®è€… *</label><select id="handler" required><option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option></select></div>
        </div>

        <div style="background:#f3e5f5;padding:15px;border-radius:6px;margin-bottom:14px;">
          <h3 style="color:#8e24aa;margin-bottom:12px;font-size:1.05rem;">ğŸ”¢ æ•´ç†No</h3>
          <div class="form-group word-suggestions">
            <label>æ•´ç†No *</label>
            <input type="text" id="serialNo" required placeholder="ä¾‹:6769" list="serialNoList">
            <datalist id="serialNoList"></datalist>
            <div id="serialNoInfo" style="margin-top:8px;padding:8px;background:#f3e5f5;border-radius:4px;font-size:.85rem;color:#8e24aa;display:none;">
              <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ:</strong> ã“ã®æ•´ç†Noã®éå»ãƒ‡ãƒ¼ã‚¿: <span id="serialNoCount">0</span>ä»¶
            </div>
          </div>
        </div>

        <div style="background:#e8f5e9;padding:15px;border-radius:6px;margin-bottom:14px;">
          <h3 style="color:#2e7d32;margin-bottom:12px;font-size:1.05rem;">ğŸ“ ä½•ãŒã‚ã£ãŸ</h3>
          <div class="form-group word-suggestions">
            <label>ç•°å¸¸å†…å®¹ *</label>
            <textarea id="anomalyContent" required></textarea>
            <div id="anomalyWordSuggestions" class="word-suggestion-box">
              <div class="word-suggestion-header">ğŸ’¡ ã‚ˆãä½¿ã‚ã‚Œã‚‹è¡¨ç¾ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ï¼‰</div>
              <div id="anomalyWords"></div>
            </div>
          </div>
          <div class="form-group word-suggestions">
            <label>å¯¾å¿œå†…å®¹ *</label>
            <textarea id="actionTaken" required></textarea>
            <div id="actionWordSuggestions" class="word-suggestion-box">
              <div class="word-suggestion-header">ğŸ’¡ ã‚ˆãä½¿ã‚ã‚Œã‚‹è¡¨ç¾ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ï¼‰</div>
              <div id="actionWords"></div>
            </div>
          </div>
<div class="form-group"><label>é¡ã‚Š *</label>
  <input type="text" id="traceback" required placeholder="ä¾‹: 300å€‹å»ƒå´ã€€å“è³ªåˆ¤æ–­ã‚ˆã‚Šç”Ÿç”£åˆ†æµå‹• ãªã©">
</div>
         <div class="form-group">
  <label>å“è³ªå¯¾å¿œ</label>
  <textarea id="qualityResponse" placeholder="å“è³ªåˆ¤å®šå±¥æ­´ãƒ»å‚™è€ƒãªã©"></textarea>
</div>
          <div class="form-group"><label>æŠ€è¡“å¯¾å¿œ *</label>
            <select id="techRequest" required>
              <option value="">é¸æŠ</option><option value="è¦è«‹">æŠ€è¡“å¯¾å¿œã‚ã‚Š</option><option value="å®Œçµ">å®Œäº†</option>
            </select>
          </div>
<!-- ï¼ˆç™ºä¿¡éƒ¨ç½²ï¼‰å†ç™º/æ–°è¦ï¼ˆä»»æ„ï¼‰ -->
<div class="form-group">
  <label>å†ç™º/æ–°è¦</label>
  <select id="mfg_recurrenceType">
    <option value="">é¸æŠ</option>
    <option value="å†ç™º">å†ç™º</option>
    <option value="æ–°è¦">æ–°è¦</option>
  </select>
</div>

<!-- ï¼ˆç™ºä¿¡éƒ¨ç½²ï¼‰å¯¾ç­–çŠ¶æ³ï¼šå†ç™ºã®ã¨ãã ã‘è¡¨ç¤ºï¼ä»»æ„å…¥åŠ› -->
<div class="form-group" id="mfg_measureStatusGroup" style="display:none;">
  <label>å¯¾ç­–çŠ¶æ³ï¼ˆå†ç™ºã®å ´åˆï¼‰</label>
  <textarea id="mfg_measureStatus" placeholder="ä¾‹ï¼‰æ’ä¹…å¯¾ç­–ï¼šå‹éƒ¨å“å¤‰æ›´ã€å®Ÿæ–½æ™‚æœŸï¼š11/20 äºˆå®š ãªã©"></textarea>
</div>

          <button type="button" id="btnShowPastOnMfg" class="btn btn-secondary" style="background:#1976d2;">éå»ã®ç•°å¸¸å±¥æ­´</button>

          <div class="form-group">
            <label>å†™çœŸ</label>
            <div class="photo-upload" onclick="document.getElementById('mfgPhotos').click()">
              <div style="font-size:2rem;">ğŸ“¸</div><p>å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</p>

             
             <input type="file" id="mfgPhotos" accept="image/*" multiple>
            </div>
            <div id="mfgPhotoPreview" class="photo-preview"></div>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
      </form>

      <div id="mfgSimilarBox" class="similar-cases-box" style="margin-top:14px;">
        <div class="similar-cases-header">ğŸ” éå»ã®ç•°å¸¸å±¥æ­´</div>
        <div id="mfgSimilarContent"></div>
        <button type="button" id="mfgShowMore" class="show-more-btn" style="display:none;">ã‚‚ã£ã¨è¡¨ç¤º</button>
      </div>
    </div>

   <!-- æŠ€è¡“å…¥åŠ› -->
    <div id="technical" class="tab-content">
<div class="tab-header">
  <h2 style="color:#667eea;">æŠ€è¡“éƒ¨é–€ - è¿½åŠ å…¥åŠ›</h2>
  <button class="btn btn-secondary btn-icon" id="btnRefreshTech">ğŸ”„ æ›´æ–°</button>
</div>

      <div class="form-group">
        <label>å¯¾è±¡ã®æ¡ˆä»¶é¸æŠ *</label>
        <select id="selectSerialNo"><option value="">æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„</option></select>
      </div>

      <button type="button" id="btnShowPastOnTech" class="btn btn-secondary" style="background:#1976d2;margin-bottom:10px;">éå»ã®ç•°å¸¸å±¥æ­´</button>

      <div id="similarCasesBox" class="similar-cases-box">
        <div class="similar-cases-header">ğŸ” åŒã˜æ•´ç†Noã®éå»å¯¾å¿œäº‹ä¾‹</div>
        <div id="similarCasesContent"></div>
        <button type="button" id="showMoreCases" class="show-more-btn" style="display:none;">ä»–ã®é¡ä¼¼æ¡ˆä»¶ã‚’è¡¨ç¤º</button>
      </div>

      <div id="selectedDataDisplay" style="background:#f8f9ff;padding:15px;border-radius:6px;margin-bottom:14px;display:none;">
        <h3 style="color:#667eea;margin-bottom:8px;">ç™ºä¿¡éƒ¨ç½²å…¥åŠ›å†…å®¹</h3>
        <div id="displayContent"></div>
      </div>

      <form id="technicalForm">
        <div class="form-group"><label>æŠ€è¡“å‡¦ç½®è€… *</label><input type="text" id="techHandler"></div>
        <div class="form-group">
          <label>ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚° *</label>
          <select id="discoveryTiming" required>
            <option value="">é¸æŠ</option>
            <option value="é‹è»¢ä¸­">é‹è»¢ä¸­</option>
            <option value="é ­å‡ºã—">é ­å‡ºã—</option>
            <option value="åˆç‰©">åˆç‰©</option>
            <option value="çµ‚ç‰©">çµ‚ç‰©</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>
        <div class="form-group" id="previousCheckGroup" style="display:none;">
          <label>å‰å›çµ‚ç‰©ç¢ºèªï¼ˆç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒåˆç‰©ã®å ´åˆï¼‰</label>
          <select id="previousCheck">
            <option value="">é¸æŠ</option>
            <option value="ä¸è¦">ä¸è¦</option>
            <option value="æœª">æœª</option>
            <option value="ç¢ºèªæ¸ˆ">ç¢ºèªæ¸ˆ</option>
          </select>
        </div>
        <div class="form-group"><label>å‘½æ•°æœ‰ç„¡ *</label><select id="lifespan"><option value="">é¸æŠ</option><option value="æœ‰">æœ‰</option><option value="ç„¡">ç„¡</option></select></div>
        <div class="form-group">
          <label>å‘½æ•°åˆ°é” *</label>
          <select id="lifespanReached" required>
            <option value="">é¸æŠ</option>
            <option value="è‡³">è‡³</option>
            <option value="ä¸é”">ä¸é”</option>
          </select>
        </div>
        <div class="form-group"><label>ä¿å…¨å˜ä½</label><input type="text" id="maintenanceUnit"></div>
        <div class="form-group"><label>ä½•ãŒæ‚ªãã©ã†ã—ãŸ</label><textarea id="rootCauseAction"></textarea></div>

        <!-- å†ç™ºã‹æ–°è¦ã‹ -->

       
        <div class="form-group">
          <label>å†ç™ºã‹æ–°è¦ã‹ *</label>
          <select id="recurrenceType">
            <option value="">é¸æŠ</option>
            <option value="å†ç™º">å†ç™º</option>
            <option value="æ–°è¦">æ–°è¦</option>
          </select>
        </div>

<div class="form-group" id="measureStatusGroup" style="display:none;">
  <label>å¯¾ç­–çŠ¶æ³ï¼ˆå†ç™ºæ™‚ã®ã¿ï¼‰</label>
  <textarea id="measureStatus" placeholder="ä¾‹ï¼šæ’ä¹…å¯¾ç­–æ¤œè¨ä¸­ï¼ä»®å¯¾ç­–å®Ÿæ–½æ¸ˆã¿ï¼æ¨ªå±•æº–å‚™ä¸­ ãªã©"></textarea>
</div>


        <div class="form-group">
          <label>æš«å®š *</label>
          <select id="affirmation" required>
            <option value="">é¸æŠ</option>
            <option value="æœ‰">æœ‰</option>
            <option value="ç„¡">ç„¡</option>
          </select>
        </div>

        <div class="form-group">
          <label>å†™çœŸ</label>
          <div class="photo-upload" onclick="document.getElementById('techPhotos').click()">
            <div style="font-size:2rem;">ğŸ“¸</div><p>å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</p>
            <input type="file" id="techPhotos" accept="image/*" multiple>
          </div>
          <div id="techPhotoPreview" class="photo-preview"></div>
        </div>
        <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
      </form>
    </div>

    <!-- å±¥æ­´ -->
    <div id="history" class="tab-content">
      <h2 style="margin-bottom:16px;color:#667eea;">ç•°å¸¸å±¥æ­´</h2>
      
      <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒãƒ« -->
      <div class="filter-panel">
        <div class="filter-header">
          <div class="filter-title">ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¤œç´¢</div>
        </div>
<div class="form-group" style="margin-bottom:0;">
  <label style="font-size:.9rem;margin-bottom:6px;">éƒ¨ç½²ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
  <select id="filterDepartment" multiple style="height:120px;">
    <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯å‹•çš„ã«è¿½åŠ  -->
  </select>
  <div style="font-size:.75rem;color:#666;margin-top:4px;">Ctrl/Cmd+ã‚¯ãƒªãƒƒã‚¯ã§è¤‡æ•°é¸æŠ</div>
</div>
          <div class="form-group" style="margin-bottom:0;">
            <label style="font-size:.9rem;margin-bottom:6px;">æ•´ç†No</label>
            <input type="text" id="filterSerialNo" placeholder="éƒ¨åˆ†ä¸€è‡´æ¤œç´¢">
          </div>
          <div class="form-group" style="margin-bottom:0;">
            <label style="font-size:.9rem;margin-bottom:6px;">ãƒ©ã‚¤ãƒ³å</label>
            <select id="filterLine">
              <option value="">ã™ã¹ã¦</option>
            </select>
          </div>
        </div>
        <div class="form-group" style="margin-bottom:0;margin-top:12px;">
          <label style="font-size:.9rem;margin-bottom:6px;">ç™ºç”Ÿæ—¥</label>
          <div class="filter-date-group">
            <button type="button" class="date-btn" id="btnFilterYesterday">æ˜¨æ—¥</button>
            <button type="button" class="date-btn" id="btnFilterToday">ä»Šæ—¥</button>
            <input type="date" id="filterDateFrom" placeholder="é–‹å§‹æ—¥">
            <span style="color:#666;">ã€œ</span>
            <input type="date" id="filterDateTo" placeholder="çµ‚äº†æ—¥">
          </div>
        </div>
        <div class="filter-actions">
          <button type="button" class="btn-filter-apply" id="btnApplyFilter">æ¤œç´¢</button>
          <button type="button" class="btn-filter-clear" id="btnClearFilter">ã‚¯ãƒªã‚¢</button>
        </div>
        <div class="filter-result-count" id="filterResultCount" style="display:none;">
          <strong>0</strong> ä»¶ã®å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ
        </div>
      </div>

      <div class="history-controls">
        <div class="view-toggle"><button class="active" data-view="card">ã‚«ãƒ¼ãƒ‰</button><button data-view="table">ãƒ†ãƒ¼ãƒ–ãƒ«</button></div>
        <button class="btn btn-secondary" style="flex:1;" id="btnImport">ğŸ“¤ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        <button class="btn btn-export" style="flex:1;" id="btnExport">ğŸ“¥ CSVå‡ºåŠ›</button>
        <button class="btn btn-secondary" style="flex:1;display:none;" id="btnFullscreen">ğŸ–¥ï¸ å…¨ç”»é¢è¡¨ç¤º</button>
      </div>
      <div id="cardView" class="card-view"></div>
      <div id="tableView" class="table-view"></div>
    </div>

    <!-- ç®¡ç† -->
    <div id="master" class="tab-content">
      <h2 style="margin-bottom:16px;color:#667eea;">âš™ï¸ ãƒã‚¹ã‚¿ç®¡ç†</h2>
      <div style="background:#fff;padding:18px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:16px;">
        <h3 style="color:#667eea;margin-bottom:10px;">éƒ¨ç½²ç®¡ç†</h3>
        <div style="display:flex;gap:10px;margin-bottom:12px;">
          <input type="text" id="newDepartment" placeholder="æ–°ã—ã„éƒ¨ç½²å" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button class="btn btn-primary" style="width:auto;padding:10px 20px;margin:0;" id="btnAddDept">è¿½åŠ </button>
        </div>
        <div id="departmentList" style="display:grid;gap:8px;"></div>
      </div>

      <div style="background:#fff;padding:18px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:16px;">
        <h3 style="color:#f57c00;margin-bottom:10px;">ãƒ©ã‚¤ãƒ³åç®¡ç†</h3>
        <div class="form-group"><label>å¯¾è±¡éƒ¨ç½²</label><select id="lineManageDept"><option value="">éƒ¨ç½²ã‚’é¸æŠ</option></select></div>
        <div style="display:flex;gap:10px;margin-bottom:12px;">
          <input type="text" id="newLine" placeholder="æ–°ã—ã„ãƒ©ã‚¤ãƒ³å" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button class="btn btn-primary" style="width:auto;padding:10px 20px;margin:0;background:#f57c00;" id="btnAddLine">è¿½åŠ </button>
        </div>
        <div id="lineList" style="display:grid;gap:8px;"></div>
      </div>

      <div style="background:#fff;padding:18px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);">
        <h3 style="color:#2e7d32;margin-bottom:10px;">å‡¦ç½®è€…ç®¡ç†</h3>
        <div class="form-group"><label>å¯¾è±¡éƒ¨ç½²</label><select id="handlerManageDept"><option value="">éƒ¨ç½²ã‚’é¸æŠ</option></select></div>
        <div style="display:flex;gap:10px;margin-bottom:12px;">
          <input type="text" id="newHandler" placeholder="æ–°ã—ã„å‡¦ç½®è€…å" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button class="btn btn-primary" style="width:auto;padding:10px 20px;margin:0;background:#2e7d32;" id="btnAddHandler">è¿½åŠ </button>
        </div>
        <div id="handlerList" style="display:grid;gap:8px;"></div>
      </div>
    </div>
  </div>

  <!-- å†™çœŸãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="photoModal" class="modal" aria-hidden="true">
    <div class="modal-content" style="max-width:800px;">
      <h3 class="modal-title">ğŸ“· å†™çœŸä¸€è¦§</h3>
      <div id="photoModalContent" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0;"></div>
      <button class="btn btn-cancel" id="btnPhotoClose">é–‰ã˜ã‚‹</button>
    </div>
  </div>
 
  <!-- CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="importModal" class="modal" aria-hidden="true">
    <div class="modal-content" style="max-width:920px;">
      <h3 class="modal-title">ğŸ“¤ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
      <div style="display:grid;gap:12px;">
        <div>
          <label style="font-weight:bold;display:block;margin-bottom:6px;">CSVãƒ•ã‚¡ã‚¤ãƒ«</label>
          <input type="file" id="csvFileInput" accept=".csv,text/csv">
          <div style="color:#666;font-size:.9rem;margin-top:6px;">
            â€» å‰å›ã®ã€ŒğŸ“¥ CSVå‡ºåŠ›ã€ã§å‡ºã—ãŸãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã«å¯¾å¿œã—ã¦ã„ã¾ã™ï¼ˆå…ˆé ­è¡ŒãŒãƒ˜ãƒƒãƒ€ï¼‰ã€‚
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div>
            <label style="font-weight:bold;display:block;margin-bottom:6px;">é‡è¤‡æ™‚ã®å‡¦ç†</label>
            <select id="dupPolicy" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
              <option value="skip">ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ¨å¥¨ï¼‰</option>
              <option value="overwrite_id">_id ãŒä¸€è‡´ã™ã‚‹è¡Œã®ã¿ä¸Šæ›¸ã</option>
              <option value="always_new">å¸¸ã«æ–°è¦ä½œæˆï¼ˆ_id ã¯ç„¡è¦–ï¼‰</option>
            </select>
            <div style="color:#666;font-size:.85rem;margin-top:6px;">
              ãƒ»ã€Œã‚¹ã‚­ãƒƒãƒ—ã€â€¦ ç”»é¢ä¸Šã®å±¥æ­´ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨æ¯”è¼ƒã—ã€åŒä¸€ã¨æ¨å®šã—ãŸè¡Œã‚’é£›ã°ã—ã¾ã™ã€‚<br>
              ãƒ»ã€Œ_idã§ä¸Šæ›¸ãã€â€¦ CSVã«å«ã¾ã‚Œã‚‹ <code>_id</code> ã¨ä¸€è‡´ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã ã‘ã‚’æ›´æ–°ã—ã¾ã™ã€‚<br>
              ãƒ»ã€Œå¸¸ã«æ–°è¦ã€â€¦ å…¨è¡Œã‚’æ–°è¦ç™»éŒ²ï¼ˆæ¨å®šé‡è¤‡ã§ã‚‚ä½œæˆï¼‰ã€‚
            </div>
          </div>
          <div>
            <label style="font-weight:bold;display:block;margin-bottom:6px;">ã‚ªãƒ—ã‚·ãƒ§ãƒ³</label>
            <label style="display:flex;align-items:center;gap:8px;">
              <input type="checkbox" id="dryRun" checked>
              ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆæ¤œè¨¼ã®ã¿ã§æ›¸ãè¾¼ã¾ãªã„ï¼‰
            </label>
            <label style="display:flex;align-items:center;gap:8px;margin-top:6px;">
              <input type="checkbox" id="useCreatedAtNow" checked>
              æ–°è¦ä½œæˆã® <code>createdAt</code> ã¯ç¾åœ¨æ™‚åˆ»ï¼ˆserverTimestampï¼‰
            </label>
          </div>
        </div>

<details style="background:#f8f9ff;border:1px solid #e5e7eb;border-radius:8px;padding:10px;">
  <summary style="cursor:pointer;font-weight:bold;color:#667eea;">å¯¾å¿œãƒ˜ãƒƒãƒ€ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã¨åŒã˜ï¼‰</summary>
  <div style="font-size:.9rem;color:#333;margin-top:8px;line-height:1.6;">
     </div>
</details>

        <div id="importPreview" style="background:#fff;border:1px solid #eee;border-radius:8px;padding:12px;min-height:80px;">
          <em style="color:#777;">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã¶ã¨ã€ã“ã“ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨æ¤œè¨¼çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</em>
        </div>
      </div>
      <div class="modal-actions" style="margin-top:12px;">
        <button class="btn btn-cancel" id="btnImportCancel" style="flex:1;">é–‰ã˜ã‚‹</button>
        <button class="btn btn-primary" id="btnImportStart" style="flex:1;">ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹</button>
      </div>
    </div>
  </div>

  <!-- é¡ä¼¼æ¡ˆä»¶è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="similarCaseDetailModal" class="modal" aria-hidden="true">
    <div class="modal-content" style="max-width:900px;">
      <h3 class="modal-title">ğŸ“‹ é¡ä¼¼æ¡ˆä»¶ã®è©³ç´°</h3>
      <div id="similarCaseDetailContent" style="margin:20px 0;"></div>
      <button class="btn btn-cancel" id="btnSimilarCaseDetailClose">é–‰ã˜ã‚‹</button>
    </div>
  </div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
  import {
    getFirestore,
    collection, addDoc, getDocs, onSnapshot, query, orderBy, updateDoc,
    doc, deleteDoc, serverTimestamp, where, limit, startAfter
  } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
  import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js';

  // ãƒšãƒ¼ã‚¸ãƒ³ã‚°è¨­å®š
  const PAGE_SIZE = 25;
  let lastVisibleDoc = null;
  let hasMoreData = true;
  let isLoadingMore = false;


 const firebaseConfig = {
  apiKey: "AIzaSyA0YUIpIDh4WB4p1ewiNB0XfwHve0ByljU",
  authDomain: "abnreport-fd733.firebaseapp.com",
  databaseURL: "https://abnreport-fd733-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "abnreport-fd733",
  storageBucket: "abnreport-fd733.firebasestorage.app", // â† ã“ã“ã‚’ä¿®æ­£
  messagingSenderId: "349748947315",
  appId: "1:349748947315:web:010cb671d2a95bcf1f7d06"
};

 

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  const gate = document.getElementById('authGate');
  const appRoot = document.getElementById('appRoot');
  const signOutBtn = document.getElementById('signOutBtn');
// --- å†ç™ºæ™‚ã®å¯¾ç­–çŠ¶æ³ åˆ‡æ›¿UI ---
const recurrenceSelect = document.getElementById('recurrenceType');
const measureStatusGroup = document.getElementById('measureStatusGroup');
const measureStatusInput = document.getElementById('measureStatus');

function toggleMeasureStatusUI(){
  if (recurrenceSelect.value === 'å†ç™º'){
    measureStatusGroup.style.display = 'block';
    measureStatusInput.setAttribute('required', '');
  } else {
    measureStatusGroup.style.display = 'none';
    measureStatusInput.removeAttribute('required');
    measureStatusInput.value = '';
  }
}

// åˆæœŸçŠ¶æ…‹ã®åæ˜  & å¤‰æ›´æ™‚ã®åæ˜ 
toggleMeasureStatusUI();
recurrenceSelect.addEventListener('change', toggleMeasureStatusUI);

  document.getElementById('authLoginBtn').addEventListener('click', async ()=>{
    const email = (document.getElementById('authEmail').value||'').trim();
    const pw = document.getElementById('authPassword').value;
    try{
      await setPersistence(auth, browserLocalPersistence);
      await signInWithEmailAndPassword(auth, email, pw);
    }catch(e){
      document.getElementById('authMsg').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ' + (e.code||e.message);
    }
  });
  signOutBtn.addEventListener('click', ()=> signOut(auth));

onAuthStateChanged(auth, (user)=>{
  if (user){
    gate.style.display='none';
    appRoot.style.display='block';
    signOutBtn.style.display='inline-block';
    bootAfterLogin();
    bindPhotoInputs();   // â† ã“ã“ã§ä¸€åº¦ã ã‘
  } else {
    appRoot.style.display='none';
    gate.style.display='flex';
    signOutBtn.style.display='none';
  }
});

// ä¾‹ï¼šç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãé–¢æ•°ã®æœ«å°¾ã§
function openEditModal(/* ... */){
  renderEditModalUI();   // ã“ã“ã§ edit_* ã® input ãŒç”Ÿæˆã•ã‚Œã‚‹
  bindPhotoInputs();     // ã“ã“ã§æ”¹ã‚ã¦ãƒã‚¤ãƒ³ãƒ‰ï¼ˆãƒŒãƒ«ã‚¬ãƒ¼ãƒ‰ï¼†å¤šé‡é˜²æ­¢ãªã®ã§å®‰å…¨ï¼‰
}


  let anomalyCache = [];
  let filteredCache = [];
  let mfgPhotos = [];
  let techPhotos = [];
 let editMfgPhotos = [];
let editTechPhotos = [];
  let currentView='card';
  let mastersCache = null;
  let unsubscribeSnapshot = null;

  // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦å†åˆ©ç”¨
  async function fetchMasters(){
    if (mastersCache) return mastersCache;
    
    const [depSnap, lineSnap, hSnap] = await Promise.all([
      getDocs(collection(db,'masters','department','items')),
      getDocs(collection(db,'masters','line','items')),
      getDocs(collection(db,'masters','handler','items'))
    ]);
    
    const departments = depSnap.docs.map(d=>d.data().name).sort();
    const lines = {};
    lineSnap.forEach(d=>{
      const {department,name} = d.data();
      if (!lines[department]) lines[department]=[];
      lines[department].push(name);
    });
    Object.keys(lines).forEach(k=> lines[k].sort());
    
    const handlers = {};
    hSnap.forEach(d=>{
      const {department,name} = d.data();
      if (!handlers[department]) handlers[department]=[];
      handlers[department].push(name);
    });
    Object.keys(handlers).forEach(k=> handlers[k].sort());
    
    mastersCache = {departments, lines, handlers};
    return mastersCache;
  }

// åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆ25ä»¶ã®ã¿ï¼‰
  async function loadInitialData(){
    const q = query(
      collection(db,'anomalies'), 
      orderBy('createdAt','desc'), 
      limit(PAGE_SIZE)
    );
    
    const snapshot = await getDocs(q);
    anomalyCache = snapshot.docs.map(d=> ({_id:d.id, ...d.data()}));
    
    if (snapshot.docs.length > 0) {
      lastVisibleDoc = snapshot.docs[snapshot.docs.length - 1];
      hasMoreData = snapshot.docs.length === PAGE_SIZE;
    } else {
      hasMoreData = false;
    }
    
    filteredCache = [...anomalyCache];
    renderHistory();
    renderTechTargetSelect();
    updateSerialNoList();
  }
// ==== ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ç³»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====
// å±¥æ­´ã®ãƒšãƒ¼ã‚¸ãƒ³ã‚°çŠ¶æ…‹ã‚’åˆæœŸåŒ–
function resetPaging(){
  lastVisibleDoc = null;
  hasMoreData = true;
  isLoadingMore = false;
}

// ç™ºä¿¡éƒ¨ç½²ã‚¿ãƒ–ã®æ›´æ–°ï¼šãƒã‚¹ã‚¿å†å–å¾—ï¼‹ã‚·ãƒªã‚¢ãƒ«å€™è£œå†æ§‹ç¯‰
async function refreshManufacturing(){
  mastersCache = null;
  mastersCache = await fetchMasters();
  updateDepartmentSelect('department', mastersCache.departments);
  // éƒ¨ç½²é¸æŠã«å¿œã˜ã¦ãƒ©ã‚¤ãƒ³ï¼å‡¦ç½®è€…ã‚’å†æ§‹ç¯‰
  refreshLineAndHandler('department','lineName','handler', mastersCache.lines, mastersCache.handlers);
  // å±¥æ­´ã‚‚æœ€æ–°åŒ–ï¼ˆå€™è£œã‚„é¡ä¼¼æ¤œç´¢ã®æ¯é›†å›£ãŒå¢—ãˆã‚‹ï¼‰
  resetPaging();
  await loadInitialData();
  updateSerialNoList();
}

// æŠ€è¡“ã‚¿ãƒ–ã®æ›´æ–°ï¼šå±¥æ­´æœ€æ–°åŒ–ï¼‹å¯¾è±¡ã‚»ãƒ¬ã‚¯ãƒˆå†æç”»
async function refreshTechnical(){
  resetPaging();
  await loadInitialData();
  renderTechTargetSelect(); // loadInitialDataå†…ã§ã‚‚å‘¼ã°ã‚Œã‚‹ãŒå¿µã®ãŸã‚
}

// å±¥æ­´ã‚¿ãƒ–ã®æ›´æ–°ï¼šå±¥æ­´æœ€æ–°åŒ–ï¼‹ãƒ•ã‚£ãƒ«ã‚¿åˆæœŸåŒ–ç¶­æŒ
async function refreshHistory(){
  const filterDeptSelect = document.getElementById('filterDepartment');
  const keep = {
    deps: Array.from(filterDeptSelect.selectedOptions).map(opt => opt.value),
    sn : document.getElementById('filterSerialNo').value,
    line: document.getElementById('filterLine').value,
    from: document.getElementById('filterDateFrom').value,
    to  : document.getElementById('filterDateTo').value
  };
  resetPaging();
  await loadInitialData();
  initializeFilterSelects();
  
  // è¤‡æ•°éƒ¨ç½²ã‚’å†é¸æŠ
  keep.deps.forEach(dept => {
    const option = Array.from(filterDeptSelect.options).find(opt => opt.value === dept);
    if (option) option.selected = true;
  });
  
  const evt = new Event('change');
  filterDeptSelect.dispatchEvent(evt);
  document.getElementById('filterSerialNo').value = keep.sn;
  document.getElementById('filterLine').value = keep.line;
  document.getElementById('filterDateFrom').value = keep.from;
  document.getElementById('filterDateTo').value = keep.to;

  if (keep.deps.length || keep.sn || keep.line || keep.from || keep.to){
    applyFilter();
  }else{
    filteredCache = [...anomalyCache];
    renderHistory();
  }
}

// ç®¡ç†ã‚¿ãƒ–ã®æ›´æ–°ï¼šãƒã‚¹ã‚¿ä¸€è¦§ã‚’æœ€æ–°åŒ–
async function refreshMaster(){
  mastersCache = null; // æ¬¡å› fetchMasters ã§å–ã‚Šç›´ã—
  await updateDepartmentList();
  await updateLineManageList();
  await updateHandlerManageList();
}

// ==== ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ ====
// ï¼ˆonAuthStateChanged -> bootAfterLogin å¾Œãªã‚‰è¦ç´ ãŒå­˜åœ¨ï¼‰
document.addEventListener('click', (e)=>{
  if (e.target && e.target.id === 'btnRefreshMfg'){
    (async ()=>{ await refreshManufacturing(); alert('ç™ºä¿¡éƒ¨ç½²ã‚¿ãƒ–ã‚’æ›´æ–°ã—ã¾ã—ãŸ'); })();
  }
  if (e.target && e.target.id === 'btnRefreshTech'){
    (async ()=>{ await refreshTechnical(); alert('æŠ€è¡“ã‚¿ãƒ–ã‚’æ›´æ–°ã—ã¾ã—ãŸ'); })();
  }
  if (e.target && e.target.id === 'btnRefreshHistory'){
    (async ()=>{ await refreshHistory(); alert('å±¥æ­´ã‚’æ›´æ–°ã—ã¾ã—ãŸ'); })();
  }
  if (e.target && e.target.id === 'btnRefreshMaster'){
    (async ()=>{ await refreshMaster(); alert('ãƒã‚¹ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ'); })();
  }
});

  // è¿½åŠ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  async function loadMoreData(){
    if (!hasMoreData || isLoadingMore || !lastVisibleDoc) return;
    
    isLoadingMore = true;
    const loadMoreBtn = document.getElementById('btnLoadMore');
    if (loadMoreBtn) loadMoreBtn.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
    
    try {
      const q = query(
        collection(db,'anomalies'),
        orderBy('createdAt','desc'),
        startAfter(lastVisibleDoc),
        limit(PAGE_SIZE)
      );
      
      const snapshot = await getDocs(q);
      const newData = snapshot.docs.map(d=> ({_id:d.id, ...d.data()}));
      
      anomalyCache = [...anomalyCache, ...newData];
      
      if (snapshot.docs.length > 0) {
        lastVisibleDoc = snapshot.docs[snapshot.docs.length - 1];
        hasMoreData = snapshot.docs.length === PAGE_SIZE;
      } else {
        hasMoreData = false;
      }
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒé©ç”¨ã•ã‚Œã¦ã„ãªã„å ´åˆã¯å†æç”»
      const filterActive = checkFilterActive();
      if (!filterActive) {
        filteredCache = [...anomalyCache];
        renderHistory();
      }
      
      updateSerialNoList();
      
    } finally {
      isLoadingMore = false;
      if (loadMoreBtn) {
        loadMoreBtn.textContent = hasMoreData ? 'ã•ã‚‰ã«èª­ã¿è¾¼ã‚€' : 'ã™ã¹ã¦èª­ã¿è¾¼ã¿æ¸ˆã¿';
        loadMoreBtn.disabled = !hasMoreData;
      }
    }
  }

 // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼ˆæ–°è¦è¿½åŠ ãƒ»æ›´æ–°ãƒ»å‰Šé™¤ã®ã¿ç›£è¦–ï¼‰
  function setupRealtimeUpdates(){
    if (unsubscribeSnapshot) unsubscribeSnapshot();
    
    const q = query(
      collection(db,'anomalies'),
      orderBy('createdAt','desc'),
      limit(PAGE_SIZE) // 25ä»¶ã«å¤‰æ›´
    );
    
    unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
      snapshot.docChanges().forEach((change) => {
        const data = {_id: change.doc.id, ...change.doc.data()};
        const existingIndex = anomalyCache.findIndex(item => item._id === data._id);
        
        if (change.type === 'added' && existingIndex === -1) {
          // æ–°è¦è¿½åŠ 
          anomalyCache.unshift(data);
          if (!checkFilterActive()) {
            filteredCache.unshift(data);
          }
        } else if (change.type === 'modified' && existingIndex !== -1) {
          // æ›´æ–°
          anomalyCache[existingIndex] = data;
          const filteredIndex = filteredCache.findIndex(item => item._id === data._id);
          if (filteredIndex !== -1) {
            filteredCache[filteredIndex] = data;
          }
        } else if (change.type === 'removed') {
          // å‰Šé™¤
          anomalyCache = anomalyCache.filter(item => item._id !== data._id);
          filteredCache = filteredCache.filter(item => item._id !== data._id);
        }
      });
      
      renderHistory();
      renderTechTargetSelect();
      updateSerialNoList();
    });
  }

function checkFilterActive(){
  const filterDeptSelect = document.getElementById('filterDepartment');
  const filterDepts = Array.from(filterDeptSelect.selectedOptions).map(opt => opt.value);
  
  return filterDepts.length > 0 ||
         document.getElementById('filterSerialNo').value.trim() !== '' ||
         document.getElementById('filterLine').value !== '' ||
         document.getElementById('filterDateFrom').value !== '' ||
         document.getElementById('filterDateTo').value !== '';
}

  /* ==== ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ ==== */
  function getDateString(daysOffset = 0) {
    const d = new Date();
    d.setDate(d.getDate() + daysOffset);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }

function applyFilter() {
  const filterDeptSelect = document.getElementById('filterDepartment');
  const filterDepts = Array.from(filterDeptSelect.selectedOptions).map(opt => opt.value);
  const filterSerial = document.getElementById('filterSerialNo').value.trim().toLowerCase();
  const filterLine = document.getElementById('filterLine').value;
  const filterDateFrom = document.getElementById('filterDateFrom').value;
  const filterDateTo = document.getElementById('filterDateTo').value;

  filteredCache = anomalyCache.filter(item => {
    if (filterDepts.length > 0 && !filterDepts.includes(item.department)) return false;
    if (filterSerial && !(item.serialNo||'').toLowerCase().includes(filterSerial)) return false;
    if (filterLine && item.lineName !== filterLine) return false;
    if (filterDateFrom && item.occurrenceDate < filterDateFrom) return false;
    if (filterDateTo && item.occurrenceDate > filterDateTo) return false;
    return true;
  });

  const resultCount = document.getElementById('filterResultCount');
  resultCount.innerHTML = `<strong>${filteredCache.length}</strong> ä»¶ã®å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;
  resultCount.style.display = 'block';

  renderHistory();
}

function clearFilter() {
  const filterDeptSelect = document.getElementById('filterDepartment');
  filterDeptSelect.selectedIndex = -1; // ã™ã¹ã¦ã®é¸æŠã‚’è§£é™¤
  document.getElementById('filterSerialNo').value = '';
  document.getElementById('filterLine').value = '';
  document.getElementById('filterDateFrom').value = '';
  document.getElementById('filterDateTo').value = '';
  document.getElementById('filterResultCount').style.display = 'none';
  
  document.getElementById('btnFilterYesterday').classList.remove('active');
  document.getElementById('btnFilterToday').classList.remove('active');
  
  filteredCache = [...anomalyCache];
  renderHistory();
}

  document.getElementById('btnApplyFilter').addEventListener('click', applyFilter);
  document.getElementById('btnClearFilter').addEventListener('click', clearFilter);

  document.getElementById('btnFilterYesterday').addEventListener('click', () => {
    const yesterday = getDateString(-1);
    document.getElementById('filterDateFrom').value = yesterday;
    document.getElementById('filterDateTo').value = yesterday;
    document.getElementById('btnFilterYesterday').classList.add('active');
    document.getElementById('btnFilterToday').classList.remove('active');
    applyFilter();
  });

  document.getElementById('btnFilterToday').addEventListener('click', () => {
    const today = getDateString(0);
    document.getElementById('filterDateFrom').value = today;
    document.getElementById('filterDateTo').value = today;
    document.getElementById('btnFilterToday').classList.add('active');
    document.getElementById('btnFilterYesterday').classList.remove('active');
    applyFilter();
  });

document.getElementById('filterDepartment').addEventListener('change', () => {
  const filterDeptSelect = document.getElementById('filterDepartment');
  const selectedDepts = Array.from(filterDeptSelect.selectedOptions).map(opt => opt.value);
  const lineSelect = document.getElementById('filterLine');
  lineSelect.innerHTML = '<option value="">ã™ã¹ã¦</option>';
  
  if (selectedDepts.length > 0 && mastersCache) {
    const allLines = new Set();
    selectedDepts.forEach(dept => {
      if (mastersCache.lines[dept]) {
        mastersCache.lines[dept].forEach(line => allLines.add(line));
      }
    });
    Array.from(allLines).sort().forEach(line => {
      const option = document.createElement('option');
      option.value = line;
      option.textContent = line;
      lineSelect.appendChild(option);
    });
  }
});
  function initializeFilterSelects() {
    if (!mastersCache) return;
    
    const deptSelect = document.getElementById('filterDepartment');
    deptSelect.innerHTML = '<option value="">ã™ã¹ã¦</option>';
    mastersCache.departments.forEach(dept => {
      const option = document.createElement('option');
      option.value = dept;
      option.textContent = dept;
      deptSelect.appendChild(option);
    });
  }

const HEADER_MAP = {
   'æ•´ç†â„–':'serialNo',     
  'æ•´ç†No':'serialNo',
  'éƒ¨ç½²':'department',
  'ãƒ©ã‚¤ãƒ³å':'lineName',
  'ç™ºç”Ÿæ—¥':'occurrenceDate',
  'ç™ºç”Ÿæ™‚åˆ»':'occurrenceTime',
  'å†é–‹æ™‚åˆ»':'restartTime',
  'ç•°å¸¸å†…å®¹':'anomalyContent',
  'å¯¾å¿œå†…å®¹':'actionTaken',
  'é¡ã‚Š':'traceback',
  'å“è³ªå¯¾å¿œ':'qualityResponse',
  'å‡¦ç½®è€…':'handler',
  'æŠ€è¡“å¯¾å¿œ':'techRequest',
  'æŠ€è¡“å¯¾å¿œåŒºåˆ†':'techRequest',
  'æŠ€è¡“å‡¦ç½®è€…':'techHandler',
  'æœ€çµ‚è€…å':'techHandler',  // â† è¿½åŠ ï¼ˆæŠ€è¡“å‡¦ç½®è€…ã¨åŒã˜ï¼‰
  'ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°':'discoveryTiming',
  'ç™ºç”Ÿã‚¿ã‚¤ãƒŸãƒ³ã‚°':'discoveryTiming',  // â† è¿½åŠ ï¼ˆç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨åŒã˜ï¼‰
  'å‰å›çµ‚ç‰©ç¢ºèª':'previousCheck',
  'å‘½æ•°æœ‰ç„¡':'lifespan',
  'å‘½æ•°åˆ°é”':'lifespanReached',
  'ä¿å…¨å˜ä½':'maintenanceUnit',
  'æŠ€è¡“å¯¾å¿œå†…å®¹':'rootCauseAction',
  'å†ç™ºæ–°è¦':'recurrenceType',
  'å¯¾ç­–çŠ¶æ³':'measureStatus',
  'æš«å®š':'affirmation',
  'çŠ¶æ…‹':'_statusText',
  'åœæ­¢æ™‚é–“(åˆ†)':'_stopMin',
  '_id':'_id'
};
/* CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ */
  function parseCSVLoose(text){
    const rows=[]; let cur=''; let row=[]; let inQuotes=false;
    for (let i=0;i<text.length;i++){
      const ch=text[i], next=text[i+1];
      if (inQuotes){
        if (ch === '"' && next === '"'){ cur+='"'; i++; }
        else if (ch === '"'){ inQuotes=false; }
        else { cur+=ch; }
      }else{
        if (ch === '"'){ inQuotes=true; }
        else if (ch === ','){ row.push(cur); cur=''; }
        else if (ch === '\n' || ch === '\r'){
          if (ch === '\r' && next === '\n'){ i++; }
          row.push(cur); rows.push(row); row=[]; cur='';
        }else{ cur+=ch; }
      }
    }
    if (cur.length>0 || row.length>0){ row.push(cur); rows.push(row); }
    return rows;
  }

// ãƒ˜ãƒƒãƒ€
const headers = [
  'æ•´ç†No','éƒ¨ç½²','ãƒ©ã‚¤ãƒ³å','ç™ºç”Ÿæ—¥','ç™ºç”Ÿæ™‚åˆ»','å†é–‹æ™‚åˆ»','åœæ­¢æ™‚é–“(åˆ†)',
  'ç•°å¸¸å†…å®¹','å¯¾å¿œå†…å®¹','é¡ã‚Š','å‡¦ç½®è€…',
  'æŠ€è¡“å¯¾å¿œåŒºåˆ†','æŠ€è¡“å‡¦ç½®è€…','ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°','å‰å›çµ‚ç‰©ç¢ºèª',
  'å‘½æ•°æœ‰ç„¡','å‘½æ•°åˆ°é”','ä¿å…¨å˜ä½',
  'æŠ€è¡“å¯¾å¿œå†…å®¹','å†ç™ºæ–°è¦','å¯¾ç­–çŠ¶æ³','æš«å®š','çŠ¶æ…‹','_id'
];

// è¡Œ
const rows = anomalyCache.map(item=>{
  const stopMin = calcStopMinutes(item);
  return [
    item.serialNo||'', item.department||'', item.lineName||'',
    item.occurrenceDate||'', item.occurrenceTime||'', item.restartTime||'',
    (stopMin!==null?stopMin:''),
    item.anomalyContent||'', item.actionTaken||'', item.traceback||'',ã€€item.qualityResponse||'', item.handler||'',
    // æŠ€è¡“å¯¾å¿œåŒºåˆ†
    item.techRequest==='è¦è«‹'?'æŠ€è¡“å¯¾å¿œã‚ã‚Š':item.techRequest==='å®Œçµ'?'å®Œäº†':'',
    item.techHandler||'', item.discoveryTiming||'', item.previousCheck||'',
    item.lifespan||'', item.lifespanReached||'', item.maintenanceUnit||'',
    // æŠ€è¡“å¯¾å¿œå†…å®¹
    item.rootCauseAction||'',
    item.recurrenceType||'', item.measureStatus||'',
    item.affirmation||'',
    item.status==='complete'?'å®Œäº†':'æŠ€è¡“å…¥åŠ›å¾…ã¡',
    item._id
  ];
});


  let importParsed = null;

  function normalizeTechRequest(v){
    if (!v) return '';
    if (v.includes('å®Œçµ')) return 'å®Œçµ';
    if (v.includes('æŠ€è¡“')) return 'è¦è«‹';
    if (v === 'è¦è«‹') return 'è¦è«‹';
    return v;
  }
  function normalizeStatus(v){
    if (!v) return '';
    if (v.includes('å®Œäº†')) return 'complete';
    return 'pending';
  }

  function guessDuplicateKey(item){
    return [item.serialNo||'', item.occurrenceDate||'', item.occurrenceTime||''].join('|');
  }
  function buildCacheIndex(){
    const idx = new Map();
    anomalyCache.forEach(it => {
      idx.set( guessDuplicateKey(it), it._id );
    });
    return idx;
  }

  const importModal = document.getElementById('importModal');
  document.getElementById('btnImport').addEventListener('click', ()=>{
    document.getElementById('csvFileInput').value = '';
    document.getElementById('dryRun').checked = true;
    document.getElementById('dupPolicy').value = 'skip';
    document.getElementById('useCreatedAtNow').checked = true;
    document.getElementById('importPreview').innerHTML =
      '<em style="color:#777;">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã¶ã¨ã€ã“ã“ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨æ¤œè¨¼çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</em>';
    importParsed = null;
    importModal.classList.add('active'); importModal.setAttribute('aria-hidden','false');
  });
  document.getElementById('btnImportCancel').addEventListener('click', ()=>{
    importModal.classList.remove('active'); importModal.setAttribute('aria-hidden','true');
  });
  importModal.addEventListener('click', (e)=>{
    if (e.target.id === 'importModal'){
      importModal.classList.remove('active'); importModal.setAttribute('aria-hidden','true');
    }
  });

document.getElementById('csvFileInput').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if (!f) return;
  const text = await f.text();
  const rows = parseCSVLoose(text);
  if (!rows.length){ document.getElementById('importPreview').innerHTML = '<span style="color:#c62828;">CSVãŒç©ºã§ã™ã€‚</span>'; return; }
  const headers = rows[0];

  const mapIdx = headers.map(h => HEADER_MAP[h] || null);
  const dataRows = rows.slice(1).filter(r => r.some(c => (c??'').toString().trim() !== ''));
  
  const mappedRows = dataRows.map(r => {
    const obj={};
    mapIdx.forEach((key, i)=>{
      if (!key) return;
      obj[key] = (r[i]??'').toString().trim();
    });
    
    // æ™‚åˆ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®æ­£è¦åŒ–ï¼ˆHH:MM:SS â†’ HH:MMï¼‰
    if (obj.occurrenceTime && /^\d{1,2}:\d{2}:\d{2}$/.test(obj.occurrenceTime)) {
      obj.occurrenceTime = obj.occurrenceTime.substring(0, 5);
    }
    if (obj.restartTime && /^\d{1,2}:\d{2}:\d{2}$/.test(obj.restartTime)) {
      obj.restartTime = obj.restartTime.substring(0, 5);
    }
    
    obj.techRequest = normalizeTechRequest(obj.techRequest);
    if (obj._statusText){ obj.status = normalizeStatus(obj._statusText); delete obj._statusText; }
    return obj;
  });

  const errors=[];
  mappedRows.forEach((o, i)=>{
    const rowNo = i+2;
    
    // æ­£è¦åŒ–å¾Œã®æ™‚åˆ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆHH:MMå½¢å¼ã®ã¿ï¼‰
    if (o.occurrenceTime && !/^\d{1,2}:\d{2}$/.test(o.occurrenceTime)){ 
      errors.push(`Row ${rowNo}: ç™ºç”Ÿæ™‚åˆ»ã®å½¢å¼ãŒä¸æ­£`);
    }
    if (o.restartTime && !/^\d{1,2}:\d{2}$/.test(o.restartTime)){ 
      errors.push(`Row ${rowNo}: å†é–‹æ™‚åˆ»ã®å½¢å¼ãŒä¸æ­£`);
    }
  });

  const previewCount = Math.min(5, mappedRows.length);
  const sample = mappedRows.slice(0, previewCount).map(o => ({
    æ•´ç†No:o.serialNo||'-', 
    éƒ¨ç½²:o.department||'-', 
    ç™ºç”Ÿæ—¥:o.occurrenceDate||'-',
    ç•°å¸¸å†…å®¹:(o.anomalyContent||'-').slice(0,20)+(o.anomalyContent?.length>20?'...':''),
    å¯¾å¿œå†…å®¹:(o.actionTaken||'-').slice(0,20)+(o.actionTaken?.length>20?'...':''), 
    _id:o._id||''
  }));

  const previewEl = document.getElementById('importPreview');
  previewEl.innerHTML = `
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px;">
      <div>ç·è¡Œæ•°: <strong>${mappedRows.length}</strong></div>
      <div>ã‚¨ãƒ©ãƒ¼: <strong style="color:${errors.length?'#d32f2f':'#2e7d32'};">${errors.length}</strong></div>
    </div>
    <div style="overflow:auto;max-height:220px;border:1px solid #eee;border-radius:6px;">
      <table style="width:100%;border-collapse:collapse;">
        <thead><tr>
          <th style="background:#667eea;color:#fff;padding:6px;">æ•´ç†No</th>
          <th style="background:#667eea;color:#fff;padding:6px;">éƒ¨ç½²</th>
          <th style="background:#667eea;color:#fff;padding:6px;">ç™ºç”Ÿæ—¥</th>
          <th style="background:#667eea;color:#fff;padding:6px;">ç•°å¸¸å†…å®¹</th>
          <th style="background:#667eea;color:#fff;padding:6px;">å¯¾å¿œå†…å®¹</th>
          <th style="background:#667eea;color:#fff;padding:6px;">_id</th>
        </tr></thead>
        <tbody>
          ${sample.map(r=>`
            <tr>
              <td style="border-bottom:1px solid #eee;padding:6px;">${r.æ•´ç†No}</td>
              <td style="border-bottom:1px solid #eee;padding:6px;">${r.éƒ¨ç½²}</td>
              <td style="border-bottom:1px solid #eee;padding:6px;">${r.ç™ºç”Ÿæ—¥}</td>
              <td style="border-bottom:1px solid #eee;padding:6px;">${r.ç•°å¸¸å†…å®¹}</td>
              <td style="border-bottom:1px solid #eee;padding:6px;">${r.å¯¾å¿œå†…å®¹}</td>
              <td style="border-bottom:1px solid #eee;padding:6px;">${r._id}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
    <div style="margin-top:8px;color:#666;font-size:.9rem;">
      â€» ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯å…ˆé ­${previewCount}ä»¶ã®ã¿è¡¨ç¤ºã€‚ã‚¨ãƒ©ãƒ¼ãŒ0ã§ã‚ã‚Œã°ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯èƒ½ã§ã™ã€‚
    </div>
    ${errors.length ? `<div style="margin-top:8px;color:#d32f2f;font-size:.9rem;"><strong>æ¤œè¨¼ã‚¨ãƒ©ãƒ¼</strong><br>${errors.slice(0,10).map(e=>`ãƒ»${e}`).join('<br>')}${errors.length>10?'<br>â€¦':''}</div>`:''}
  `;
  importParsed = { headers, rows:dataRows, mappedRows, errors };
});

  document.getElementById('btnImportStart').addEventListener('click', async ()=>{
    if (!importParsed){ alert('CSVã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    if (importParsed.errors.length){ alert('ã‚¨ãƒ©ãƒ¼ã‚’è§£æ¶ˆã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„'); return; }
    const dryRun = document.getElementById('dryRun').checked;
    const dupPolicy = document.getElementById('dupPolicy').value;
    const useCreatedAtNow = document.getElementById('useCreatedAtNow').checked;

    const cacheIdx = buildCacheIndex();
    let ok=0, skip=0, upd=0, ng=0;
    const problems=[];

    // ãƒãƒƒãƒå‡¦ç†ã§åŠ¹ç‡åŒ–
    const batchSize = 10;
    for (let i=0; i<importParsed.mappedRows.length; i+=batchSize){
      const batch = importParsed.mappedRows.slice(i, i+batchSize);
      
      await Promise.all(batch.map(async (row) => {
        try{
          const key = guessDuplicateKey(row);
          const cacheHitId = cacheIdx.get(key) || null;

          if (dupPolicy === 'skip' && cacheHitId){
            skip++; return;
          }

          if (dupPolicy === 'overwrite_id' && row._id){
            if (dryRun){ upd++; return; }
            const updates = { ...row };
            delete updates._id; delete updates._stopMin;
            if (updates.status && !['complete','pending'].includes(updates.status)) delete updates.status;
            await updateDoc(doc(db,'anomalies', row._id), updates);
            upd++; return;
          }

          const payload = {
            department: row.department||'',
            lineName:   row.lineName||'',
            serialNo:   row.serialNo||'',
            occurrenceDate: row.occurrenceDate||'',
            occurrenceTime: row.occurrenceTime||'',
            restartTime: row.restartTime||'',
            anomalyContent: row.anomalyContent||'',
            actionTaken: row.actionTaken||'',
            traceback: row.traceback||'',
            handler: row.handler||'',
            techRequest: row.techRequest||'',
            techHandler: row.techHandler||'',
            discoveryTiming: row.discoveryTiming||'',
            previousCheck: row.previousCheck||'',
            lifespan: row.lifespan||'',
            lifespanReached: row.lifespanReached||'',
            maintenanceUnit: row.maintenanceUnit||'',
            rootCauseAction: row.rootCauseAction||'',
            recurrenceType: row.recurrenceType||'',
            affirmation: row.affirmation||'',
             measureStatus: row.measureStatus || '',   // â† è¿½åŠ 
            status: row.status || (row.techRequest==='å®Œçµ' ? 'complete' : 'pending'),
            mfgPhotoUrls: [], techPhotoUrls: []
          };
          if (useCreatedAtNow) payload.createdAt = serverTimestamp();

          if (dryRun){ ok++; return; }
          await addDoc(collection(db,'anomalies'), payload);
          ok++;
        }catch(e){
          ng++; problems.push(`Row ${i+2}: ${e.code||e.message}`);
        }
      }));
    }

    alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆçµæœ
- ä½œæˆ: ${ok}
- ä¸Šæ›¸ã: ${upd}
- ã‚¹ã‚­ãƒƒãƒ—: ${skip}
- å¤±æ•—: ${ng}
${problems.length?'\nä¸€éƒ¨ã‚¨ãƒ©ãƒ¼:\n'+problems.slice(0,10).join('\n'):''}`);

    importModal.classList.remove('active'); importModal.setAttribute('aria-hidden','true');
  });

 /* ãƒ¯ãƒ¼ãƒ‰å€™è£œ */
  function extractCommonWords(field, filterSerialNo = null){
    const words = {};
    let targetData = anomalyCache;
    
    // æ•´ç†Noã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    if (filterSerialNo && filterSerialNo.trim() !== '') {
      targetData = anomalyCache.filter(item => item.serialNo === filterSerialNo.trim());
      
      // æ•´ç†Noã«è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç©ºé…åˆ—ã‚’è¿”ã™
      if (targetData.length === 0) {
        return [];
      }
    } else {
      // æ•´ç†NoãŒå…¥åŠ›ã•ã‚Œã¦ã„ãªã„å ´åˆã¯å€™è£œã‚’è¡¨ç¤ºã—ãªã„
      return [];
    }
    
    targetData.forEach(item => {
      const text = item[field] || '';
      const segments = text.split(/[ã€‚ã€\n]/).filter(s => s.trim().length >= 2);
      segments.forEach(seg => {
        const trimmed = seg.trim();
        if (trimmed.length >= 2 && trimmed.length <= 50) {
          words[trimmed] = (words[trimmed] || 0) + 1;
        }
      });
    });
    return Object.entries(words)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 20)
      .map(([word]) => word);
  }
  
  function updateSerialNoList(){
    const serialNoCounts = {};
    anomalyCache.forEach(item => {
      if (item.serialNo && item.serialNo.trim() !== '') {
        const no = item.serialNo.trim();
        serialNoCounts[no] = (serialNoCounts[no] || 0) + 1;
      }
    });
    const sortedSerialNos = Object.entries(serialNoCounts)
      .sort((a, b) => b[1] - a[1])
      .map(([no, count]) => ({no, count}));
    const datalist = document.getElementById('serialNoList');
    datalist.innerHTML = sortedSerialNos.map(({no, count}) => 
      `<option value="${no}">${no} (${count}ä»¶)</option>`
    ).join('');
  }
  
  function showWordSuggestions(targetId, suggestionsBoxId, wordsContainerId, field){
    const serialNo = document.getElementById('serialNo').value.trim();
    const words = extractCommonWords(field, serialNo);
    const box = document.getElementById(suggestionsBoxId);
    const container = document.getElementById(wordsContainerId);
    
    if (words.length === 0) { 
      box.classList.remove('active'); 
      return; 
    }
    
    const filteredCount = anomalyCache.filter(item => item.serialNo === serialNo).length;
    const headerText = `ğŸ’¡ æ•´ç†Noã€Œ${serialNo}ã€ã®éå»ã®è¡¨ç¾ï¼ˆ${filteredCount}ä»¶ã®å±¥æ­´ã‹ã‚‰ï¼‰`;
    
    const header = box.querySelector('.word-suggestion-header');
    if (header) header.textContent = headerText;
    container.innerHTML = words.map(word => `<span class="word-tag" data-word="${word}">${word}</span>`).join('');
    box.classList.add('active');
    container.querySelectorAll('.word-tag').forEach(tag => {
      tag.addEventListener('click', () => {
        const textarea = document.getElementById(targetId);
        const word = tag.getAttribute('data-word');
        const currentValue = textarea.value;
        const cursorPos = textarea.selectionStart;
        const before = currentValue.substring(0, cursorPos);
        const after = currentValue.substring(cursorPos);
        const needsSpace = before.length > 0 && !before.match(/[\sã€ã€‚\n]$/);
        const insertion = (needsSpace ? ' ' : '') + word;
        textarea.value = before + insertion + after;
        textarea.focus();
        textarea.selectionStart = textarea.selectionEnd = cursorPos + insertion.length;
      });
    });
  }
  
  document.getElementById('anomalyContent').addEventListener('focus', () => {
    showWordSuggestions('anomalyContent', 'anomalyWordSuggestions', 'anomalyWords', 'anomalyContent');
  });
  document.getElementById('actionTaken').addEventListener('focus', () => {
    showWordSuggestions('actionTaken', 'actionWordSuggestions', 'actionWords', 'actionTaken');
  });
  document.getElementById('serialNo').addEventListener('input', () => {
    const serialNo = document.getElementById('serialNo').value.trim();
    const infoBox = document.getElementById('serialNoInfo');
    const countSpan = document.getElementById('serialNoCount');
    if (serialNo !== '') {
      const count = anomalyCache.filter(item => item.serialNo === serialNo).length;
      countSpan.textContent = count;
      infoBox.style.display = count > 0 ? 'block' : 'none';
    } else {
      infoBox.style.display = 'none';
    }
    
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚Œã¦ã„ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å€™è£œã‚’æ›´æ–°
    const activeElement = document.activeElement;
    if (activeElement.id === 'anomalyContent') {
      showWordSuggestions('anomalyContent', 'anomalyWordSuggestions', 'anomalyWords', 'anomalyContent');
    } else if (activeElement.id === 'actionTaken') {
      showWordSuggestions('actionTaken', 'actionWordSuggestions', 'actionWords', 'actionTaken');
    }
  });
  document.getElementById('serialNo').addEventListener('change', () => {
    const anomalyBox = document.getElementById('anomalyWordSuggestions');
    const actionBox = document.getElementById('actionWordSuggestions');
    if (anomalyBox.classList.contains('active')) {
      showWordSuggestions('anomalyContent', 'anomalyWordSuggestions', 'anomalyWords', 'anomalyContent');
    }
    if (actionBox.classList.contains('active')) {
      showWordSuggestions('actionTaken', 'actionWordSuggestions', 'actionWords', 'actionTaken');
    }
  });
  document.getElementById('anomalyContent').addEventListener('blur', () => {
    setTimeout(() => document.getElementById('anomalyWordSuggestions').classList.remove('active'), 200);
  });
  document.getElementById('actionTaken').addEventListener('blur', () => {
    setTimeout(() => document.getElementById('actionWordSuggestions').classList.remove('active'), 200);
  });
 
  /* é¡ä¼¼æ¡ˆä»¶ */
  let showingAllCases = false;
  let allSimilarCases = [];
  
  function calculateSimilarity(text1, text2) {
    if (!text1 || !text2) return 0;
    const normalize = (text) => text.toLowerCase().replace(/[\s\u3000]/g, '').replace(/[ã€ã€‚ï¼Œï¼]/g, '');
    const t1 = normalize(text1); const t2 = normalize(text2);
    if (t1 === t2) return 100;
    if (t1.length === 0 || t2.length === 0) return 0;
    let matches = 0;
    const minLen = Math.min(t1.length, t2.length);
    const maxLen = Math.max(t1.length, t2.length);
    for (let len = minLen; len >= 2; len--) {
      for (let i = 0; i <= t1.length - len; i++) {
        const substr = t1.substring(i, i + len);
        if (t2.includes(substr)) { matches += len; break; }
      }
      if (matches > 0) break;
    }
    return Math.round((matches / maxLen) * 100);
  }
  function bindPhotoInputsOnce() {
  const el1 = document.getElementById('mfgPhotos');
  const el2 = document.getElementById('techPhotos');

  // æ—¢ã«ãƒã‚¤ãƒ³ãƒ‰æ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„
  if (el1 && !el1._photoBound) {
    handlePhotoUpload('mfgPhotos','mfgPhotoPreview', mfgPhotos);
    el1._photoBound = true;
  }
  if (el2 && !el2._photoBound) {
    handlePhotoUpload('techPhotos','techPhotoPreview', techPhotos);
    el2._photoBound = true;
  }
}

// DOMã§ããŸã‚‰ä¸€å›ã ã‘
window.addEventListener('DOMContentLoaded', bindPhotoInputsOnce);

  function findSimilarCandidates(base, limitN=10){
    if (!base) return [];
    let candidates = anomalyCache
      .filter(x => x._id !== base._id && x.status==='complete');
    if (base.serialNo) {
      const same = candidates.filter(x => x.serialNo === base.serialNo);
      if (same.length >= 1) candidates = same;
    }
    const withScore = candidates.map(it => ({
      ...it,
      similarity: calculateSimilarity(base.anomalyContent||'', it.anomalyContent||'')
    }));
    return withScore
      .filter(x => x.similarity >= 30)
      .sort((a,b) => (b.similarity!==a.similarity) ? (b.similarity-a.similarity) : (b.occurrenceDate||'').localeCompare(a.occurrenceDate||''))
      .slice(0, limitN);
  }
  
  function renderSimilarList(items){
    return items.map((item) => {
      const allPhotos = [ ...(item.mfgPhotoUrls || []), ...(item.techPhotoUrls || []) ];
      const photosHtml = allPhotos.length ? `
        <div class="similar-photos">
          ${allPhotos.slice(0,8).map(u=>`
            <div class="thumb" onclick="window.open('${u}','_blank')">
              <img src="${u}" alt="">
            </div>
          `).join('')}
        </div>
      ` : '';
      return `
        <div class="similar-case-item">
          <div class="similar-case-date">
            ğŸ“… ${item.occurrenceDate || ''} ã®å¯¾å¿œäº‹ä¾‹
            <span style="background:#4caf50;color:#fff;padding:2px 8px;border-radius:12px;font-size:.8rem;margin-left:8px;">
              é¡ä¼¼åº¦ ${item.similarity}%
            </span>
          </div>
          <div class="similar-case-content">
            <strong>ç•°å¸¸å†…å®¹:</strong> ${item.anomalyContent || '-'}<br>
            <strong>å¯¾å¿œå†…å®¹:</strong> ${item.actionTaken || '-'}
          </div>
          <div class="similar-case-tech">
            <strong>ğŸ”§ æŠ€è¡“å¯¾å¿œå†…å®¹:</strong><br>
            ${item.techHandler ? `æŠ€è¡“å‡¦ç½®è€…: ${item.techHandler}<br>` : ''}
            ${item.rootCauseAction ? `åŸå› ãƒ»å¯¾ç­–: ${item.rootCauseAction}<br>` : ''}
            ${item.maintenanceUnit ? `ä¿å…¨å˜ä½: ${item.maintenanceUnit}<br>` : ''}
            ${item.lifespan ? `å‘½æ•°æœ‰ç„¡: ${item.lifespan}<br>` : ''}
            ${item.recurrenceType ? `åˆ†é¡: ${item.recurrenceType}` : ''}
          </div>
          ${photosHtml}
          <button class="btn-small" style="background:#2196f3;color:#fff;margin-top:10px;width:100%;" onclick="showSimilarCaseDetail('${item._id}')">
            ğŸ“‹ è©³ç´°ã‚’è¦‹ã‚‹
          </button>
        </div>
      `;
    }).join('');
  }

  function setNowDateTo(id){
    const now = new Date(); const hour=now.getHours();
    if (hour>=0 && hour<6) now.setDate(now.getDate()-1);
    const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0'), d=String(now.getDate()).padStart(2,'0');
    document.getElementById(id).value = `${y}-${m}-${d}`;
  }
  function setNowTimeTo(id){
    const now=new Date(); const hh=String(now.getHours()).padStart(2,'0'), mm=String(now.getMinutes()).padStart(2,'0');
    document.getElementById(id).value = `${hh}:${mm}`;
  }
  document.getElementById('btnNowDate').addEventListener('click', ()=>setNowDateTo('occurrenceDate'));
  document.querySelectorAll('button[data-now]').forEach(b=> b.addEventListener('click', ()=> setNowTimeTo(b.getAttribute('data-now')) ));

  function displayPhotos(previewId, arr){
    const wrap = document.getElementById(previewId); wrap.innerHTML='';
    arr.forEach((src,idx)=>{
      const div=document.createElement('div'); div.className='photo-item';
      div.innerHTML = `<img src="${src}"><button class="remove-btn" data-photo="${previewId}" data-index="${idx}">Ã—</button>`;
      wrap.appendChild(div);
    });
  }
function handlePhotoUpload(inputId, previewId, arrRef){
  const input = document.getElementById(inputId);
  if (!input) return; // â† è¦ç´ ãŒç„¡ã„æ™‚ã¯ä½•ã‚‚ã—ãªã„ï¼ˆè½ã¡ãªã„ï¼‰

  // å¤šé‡ãƒã‚¤ãƒ³ãƒ‰é˜²æ­¢ï¼ˆåŒã˜IDã«äºŒé‡ã§ä»˜ã‹ãªã„ã‚ˆã†ã«ï¼‰
  if (input._photoHandler) {
    input.removeEventListener('change', input._photoHandler);
  }

  const handler = (e)=>{
    (Array.from(e.target.files||[])).forEach(file=>{
      const r=new FileReader();
      r.onload = ev=>{
        arrRef.push({name:file.name, file, preview:ev.target.result});
        displayPhotos(previewId, arrRef.map(x=>x.preview));
      };
      r.readAsDataURL(file);
    });
    input.value='';
  };

  input.addEventListener('change', handler);
  input._photoHandler = handler;
}

  handlePhotoUpload('mfgPhotos','mfgPhotoPreview', mfgPhotos);
  handlePhotoUpload('techPhotos','techPhotoPreview', techPhotos);
 // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
 
handlePhotoUpload('edit_mfgPhotos','edit_mfgPhotoPreview', editMfgPhotos);
handlePhotoUpload('edit_techPhotos','edit_techPhotoPreview', editTechPhotos);

// æ—¢å­˜å†™çœŸã®å‰Šé™¤ãƒœã‚¿ãƒ³å‡¦ç†
document.addEventListener('click', (e) => {
  const deleteBtn = e.target.closest('button[data-delete-existing]');
  if (deleteBtn) {
    const kind = deleteBtn.getAttribute('data-delete-existing');
    const url = deleteBtn.getAttribute('data-url');
    
    if (confirm('ã“ã®å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      editPhotosToDelete.push(url);
      deleteBtn.closest('.photo-item').remove();
      
      // ãƒªã‚¹ãƒˆãŒç©ºã«ãªã£ãŸã‚‰ã€Œå†™çœŸãªã—ã€ã‚’è¡¨ç¤º
      const listId = kind === 'mfg' ? 'edit_mfgPhotosList' : 'edit_techPhotosList';
      const list = document.getElementById(listId);
      if (list.querySelectorAll('.photo-item').length === 0) {
        list.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">å†™çœŸãªã—</p>';
      }
    }
  }
});
  document.addEventListener('click',(e)=>{
    const rm=e.target.closest('.remove-btn[data-photo]'); if(!rm) return;
    const id=rm.getAttribute('data-photo'); const idx=Number(rm.getAttribute('data-index'));
    if (id==='mfgPhotoPreview'){ mfgPhotos.splice(idx,1); displayPhotos(id, mfgPhotos.map(x=>x.preview)); }
    if (id==='techPhotoPreview'){ techPhotos.splice(idx,1); displayPhotos(id, techPhotos.map(x=>x.preview)); }
  });
function bindPhotoInputs(){
  handlePhotoUpload('mfgPhotos','mfgPhotoPreview', mfgPhotos);
  handlePhotoUpload('techPhotos','techPhotoPreview', techPhotos);
  // â†“ ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã¯ã¾ã ç„¡ã„ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ã€ã‚ã£ã¦ã‚‚ç„¡ãã¦ã‚‚OKãªæ›¸ãæ–¹
  handlePhotoUpload('edit_mfgPhotos','edit_mfgPhotoPreview', editMfgPhotos);
  handlePhotoUpload('edit_techPhotos','edit_techPhotoPreview', editTechPhotos);
}

  function updateDepartmentSelect(selectId, departments){
    const sel=document.getElementById(selectId); if(!sel) return;
    const keep=sel.value;
    sel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    departments.forEach(d=>{ const o=document.createElement('option'); o.value=o.textContent=d; sel.appendChild(o); });
    if (departments.includes(keep)) sel.value=keep;
  }
  function refreshLineAndHandler(deptSelId, lineSelId, handlerSelId, lines, handlers){
    const dept=document.getElementById(deptSelId).value;
    const lineSel=document.getElementById(lineSelId), handlerSel=document.getElementById(handlerSelId);
    lineSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    handlerSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    (lines[dept]||[]).forEach(l=>{ const o=document.createElement('option'); o.value=o.textContent=l; lineSel.appendChild(o); });
    (handlers[dept]||[]).forEach(h=>{ const o=document.createElement('option'); o.value=o.textContent=h; handlerSel.appendChild(o); });
  }

  function calcStopMinutes(item){
    const ot = item.occurrenceTime || '';
    const rt = item.restartTime || '';
    if (!ot || !rt) return null;
    const [oh,om] = ot.split(':').map(Number);
    const [rh,rm] = rt.split(':').map(Number);
    let diff = (rh*60+rm) - (oh*60+om);
    if (isNaN(diff)) return null;
    if (diff < 0) diff += 1440;
    return diff;
  }
  function badgeClassByMinutes(m){
    if (m === null) return '';
    if (m >= 30) return 'danger';
    if (m >= 10) return 'warn';
    return '';
  }
// --- è¿½åŠ ï¼šæ•´ç†Noã§å…¨ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆå¿…è¦ãªã‚‰ãƒšãƒ¼ã‚¸ãƒ³ã‚°ï¼‰ ---
async function fetchAllBySerialNo(serialNo){
  if (!serialNo) return [];
  // ã¾ãš createdAt ã§ä¸¦ã¹ã¦å–å¾—ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã« createdAt ãŒç„¡ã„å ´åˆã«å‚™ãˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  try{
    const results = [];
    let last = null;
    const BATCH = 500; // 1å›ã®å–å¾—ä¸Šé™ã®ç›®å®‰

    while(true){
      const q = last
        ? query(
            collection(db,'anomalies'),
            where('serialNo','==', serialNo),
            orderBy('createdAt','desc'),
            startAfter(last),
            limit(BATCH)
          )
        : query(
            collection(db,'anomalies'),
            where('serialNo','==', serialNo),
            orderBy('createdAt','desc'),
            limit(BATCH)
          );
      const snap = await getDocs(q);
      if (snap.empty) break;
      snap.docs.forEach(d => results.push({_id:d.id, ...d.data()}));
      if (snap.docs.length < BATCH){ break; }
      last = snap.docs[snap.docs.length - 1];
    }

    // createdAtã®ç„¡ã„å¤ã„ãƒ¬ã‚³ãƒ¼ãƒ‰æ··åœ¨å¯¾ç­–ã¨ã—ã¦ã€æ—¥ä»˜ã§æœ€çµ‚ä¸¦ã¹æ›¿ãˆ
    results.sort((a,b)=> (b.occurrenceDate||'').localeCompare(a.occurrenceDate||''));
    return results;
  }catch(e){
    // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœªä½œæˆãªã©ã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆorderByç„¡ã—ãƒ»ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚½ãƒ¼ãƒˆï¼‰
    const results = [];
    const q = query(collection(db,'anomalies'), where('serialNo','==', serialNo));
    const snap = await getDocs(q);
    snap.forEach(d => results.push({_id:d.id, ...d.data()}));
    results.sort((a,b)=> (b.occurrenceDate||'').localeCompare(a.occurrenceDate||''));
    return results;
  }
}

  function anomaliesRef(){ return collection(db,'anomalies'); }

  // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®æœ€é©åŒ–ï¼ˆä¸¦åˆ—å‡¦ç†ï¼‰
// uploadPhotos é–¢æ•°ã‚’æ”¹å–„
// ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢æ•°ï¼ˆå®Œå…¨å†æ§‹ç¯‰ç‰ˆï¼‰
async function uploadPhotos(docId, kind, items) {
  console.log(`=== Starting upload: ${items.length} files for ${kind} ===`);
  const urls = [];
  
  for (let i = 0; i < items.length; i++) {
    const item = items[i];
    try {
      // ãƒ•ã‚¡ã‚¤ãƒ«åã®ç”Ÿæˆ
      const timestamp = Date.now() + i; // é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚
      const extension = item.name.split('.').pop();
      const fileName = `${timestamp}.${extension}`;
      const path = `anomalies/${docId}/${kind}/${fileName}`;
      
      console.log(`[${i + 1}/${items.length}] Uploading to: ${path}`);
      console.log(`File size: ${item.file.size} bytes`);
      console.log(`File type: ${item.file.type}`);
      
      // Storageã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      const storageRef = ref(storage, path);
      const metadata = {
        contentType: item.file.type,
        customMetadata: {
          'originalName': item.name,
          'uploadedAt': new Date().toISOString()
        }
      };
      
      const uploadResult = await uploadBytes(storageRef, item.file, metadata);
      console.log(`Upload complete: ${uploadResult.metadata.fullPath}`);
      
      // URLã®å–å¾—
      const url = await getDownloadURL(uploadResult.ref);
      console.log(`Download URL obtained: ${url}`);
      
      urls.push(url);
      
    } catch (error) {
      console.error(`âŒ Upload failed for file ${i + 1}:`, error);
      console.error('Error details:', {
        code: error.code,
        message: error.message,
        serverResponse: error.serverResponse
      });
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ã‹ã‚Šã‚„ã™ã„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      let errorMsg = `ç”»åƒ ${i + 1} ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n`;
      if (error.code === 'storage/unauthorized') {
        errorMsg += 'ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚Firebase Storageã®ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
      } else if (error.code === 'storage/quota-exceeded') {
        errorMsg += 'ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®å®¹é‡ãŒä¸Šé™ã«é”ã—ã¦ã„ã¾ã™ã€‚';
      } else {
        errorMsg += `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
      }
      
      alert(errorMsg);
      throw error;
    }
  }
  
  console.log(`=== Upload complete: ${urls.length} files uploaded successfully ===`);
  return urls;
}

// ç™ºä¿¡éƒ¨ç½²ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ï¼ˆäºŒé‡é€ä¿¡é˜²æ­¢ç‰ˆï¼‰
let isSubmittingMfg = false;

document.getElementById('manufacturingForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  if (isSubmittingMfg) {
    console.log('Already submitting, ignoring duplicate submission');
    return;
  }
  
  isSubmittingMfg = true;
  console.log('=== Form submission started ===');
  
  const submitBtn = e.target.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.textContent = 'ç™»éŒ²ä¸­...';
  
  try {
    const techReq = document.getElementById('techRequest').value;
    const mfgRecType = document.getElementById('mfg_recurrenceType')?.value || '';
const mfgMeasure = document.getElementById('mfg_measureStatus')?.value || '';

    const base = {
     recurrenceType: mfgRecType,                                // è£½é€ ã§ã‚‚è¨­å®šå¯ï¼ˆä»»æ„ï¼‰
measureStatus: (mfgRecType === 'å†ç™º') ? mfgMeasure : '',   // ä»»æ„

      department: document.getElementById('department').value,
      lineName: document.getElementById('lineName').value,
      serialNo: document.getElementById('serialNo').value,
      occurrenceDate: document.getElementById('occurrenceDate').value,
      occurrenceTime: document.getElementById('occurrenceTime').value || '',
      restartTime: document.getElementById('restartTime').value || '',
      anomalyContent: document.getElementById('anomalyContent').value,
      actionTaken: document.getElementById('actionTaken').value,
      traceback: document.getElementById('traceback').value,
     qualityResponse: document.getElementById('qualityResponse').value || '',
      handler: document.getElementById('handler').value,
      techRequest: techReq,
      status: techReq === 'å®Œçµ' ? 'complete' : 'pending',
      createdAt: serverTimestamp(),
      techHandler: '', 
      lifespan: '', 
      maintenanceUnit: '', 
      rootCauseAction: '', 
      recurrenceType: '',
      discoveryTiming: '', 
      previousCheck: '', 
      lifespanReached: '', 
      affirmation: '',
      measureStatus: '',
      mfgPhotoUrls: [], 
      techPhotoUrls: []
    };
    
    console.log('Creating document with data:', base);
    const docRef = await addDoc(collection(db, 'anomalies'), base);
    console.log('Document created with ID:', docRef.id);
    
    if (mfgPhotos.length > 0) {
      console.log(`Uploading ${mfgPhotos.length} photos...`);
      submitBtn.textContent = `ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­... (${mfgPhotos.length}æš)`;
      
      const photoUrls = await uploadPhotos(docRef.id, 'mfg', mfgPhotos);
      console.log('Photos uploaded, URLs:', photoUrls);
      
      await updateDoc(doc(db, 'anomalies', docRef.id), {
        mfgPhotoUrls: photoUrls
      });
      console.log('Document updated with photo URLs');
      
      const newDoc = {
        _id: docRef.id,
        ...base,
        mfgPhotoUrls: photoUrls
      };
      anomalyCache.unshift(newDoc);
      filteredCache = [newDoc, ...filteredCache];
      renderHistory();
    } else {
      const newDoc = {
        _id: docRef.id,
        ...base
      };
      anomalyCache.unshift(newDoc);
      filteredCache = [newDoc, ...filteredCache];
      renderHistory();
    }
    
    e.target.reset();
    mfgPhotos = [];
    document.getElementById('mfgPhotoPreview').innerHTML = '';
    document.getElementById('lineName').innerHTML = '<option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>';
    document.getElementById('handler').innerHTML = '<option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option>';
   document.getElementById('mfg_recurrenceType').value = '';
document.getElementById('mfg_measureStatus').value = '';
document.getElementById('mfg_measureStatusGroup').style.display = 'none';

    
    alert('ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
    console.log('=== Form submission completed successfully ===');
    
  } catch (error) {
    console.error('=== Form submission error ===', error);
    alert(`ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ${error.message}`);
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'ç™»éŒ²';
    isSubmittingMfg = false;
  }
});


// æŠ€è¡“ãƒ•ã‚©ãƒ¼ãƒ ã‚‚åŒæ§˜ã«ä¿®æ­£
// æŠ€è¡“ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ï¼ˆäºŒé‡é€ä¿¡é˜²æ­¢ç‰ˆï¼‰
let isSubmittingTech = false;

document.getElementById('technicalForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  if (isSubmittingTech) {
    console.log('Already submitting, ignoring duplicate submission');
    return;
  }
  
  isSubmittingTech = true;
  console.log('=== Tech form submission started ===');
  
  const submitBtn = e.target.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.textContent = 'ç™»éŒ²ä¸­...';
  
  try {
    const id = document.getElementById('selectSerialNo').value;
    if (!id) {
      alert('æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    
    const recType = document.getElementById('recurrenceType').value;
    const ms = (document.getElementById('measureStatus')?.value || '').trim();
    
    const updates = {
      techHandler: document.getElementById('techHandler').value,
      discoveryTiming: document.getElementById('discoveryTiming').value,
      previousCheck: document.getElementById('previousCheck').value || '',
      lifespan: document.getElementById('lifespan').value,
      lifespanReached: document.getElementById('lifespanReached').value,
      maintenanceUnit: document.getElementById('maintenanceUnit').value,
      rootCauseAction: document.getElementById('rootCauseAction').value,
      recurrenceType: recType,
      measureStatus: (recType === 'å†ç™º') ? ms : '',
      affirmation: document.getElementById('affirmation').value,
      status: 'complete',
      completedAt: serverTimestamp()
    };
    
    console.log('Updating document:', id, updates);
    
    if (techPhotos.length > 0) {
      console.log(`Uploading ${techPhotos.length} tech photos...`);
      submitBtn.textContent = `ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­... (${techPhotos.length}æš)`;
      
      const photoUrls = await uploadPhotos(id, 'tech', techPhotos);
      console.log('Tech photos uploaded, URLs:', photoUrls);
      
      const existingUrls = anomalyCache.find(x => x._id === id)?.techPhotoUrls || [];
      updates.techPhotoUrls = [...existingUrls, ...photoUrls];
    }
    
    await updateDoc(doc(db, 'anomalies', id), updates);
    console.log('Document updated successfully');
    
    const cacheIndex = anomalyCache.findIndex(x => x._id === id);
    if (cacheIndex !== -1) {
      anomalyCache[cacheIndex] = { ...anomalyCache[cacheIndex], ...updates };
      filteredCache = [...anomalyCache];
      renderHistory();
    }
    
    e.target.reset();
    techPhotos = [];
    document.getElementById('techPhotoPreview').innerHTML = '';
    document.getElementById('selectedDataDisplay').style.display = 'none';
    document.getElementById('similarCasesBox').classList.remove('active');
    document.getElementById('previousCheckGroup').style.display = 'none';
    document.getElementById('measureStatusGroup').style.display = 'none';
    showingAllCases = false;
    
    alert('æŠ€è¡“å…¥åŠ›ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
    console.log('=== Tech form submission completed successfully ===');
    
  } catch (error) {
    console.error('=== Tech form submission error ===', error);
    alert(`ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ${error.message}`);
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'ç™»éŒ²';
    isSubmittingTech = false;
  }
});

 /* å±¥æ­´æç”»ï¼šãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¯¾å¿œ + ãƒšãƒ¼ã‚¸ãƒ³ã‚° */
  function renderHistory(){
    const items=[...filteredCache].sort((a,b)=> (b.occurrenceDate||'').localeCompare(a.occurrenceDate||''));
    const cardWrap=document.getElementById('cardView');
    
    if (!items.length){
      cardWrap.innerHTML=`<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;
    }else{
      cardWrap.innerHTML = items.map((item)=>{
        const status = item.status==='pending'
          ? {text:'æŠ€è¡“å…¥åŠ›å¾…ã¡',cls:'status-pending'}
          : (item.techRequest==='å®Œçµ' ? {text:'å®Œäº†ï¼ˆç™ºä¿¡éƒ¨ç½²å®Œçµï¼‰',cls:'status-complete'} : {text:'å®Œäº†',cls:'status-complete'});

        const allPhotos = [ ...(item.mfgPhotoUrls || []), ...(item.techPhotoUrls || []) ];
        const stopMin = calcStopMinutes(item);
        const badgeCls = badgeClassByMinutes(stopMin);
        const stopBadge = (stopMin !== null)
          ? `<div class="stop-badge ${badgeCls}">åœæ­¢ï¼š${stopMin}åˆ†</div>`
          : '';
// å†ç™ºãƒãƒƒã‚¸
const recurBadge = (item.recurrenceType === 'å†ç™º')
  ? `<div class="recur-badge">å†ç™º</div>`
  : '';

        const leftHtml = `
          <div class="card-left">
            <div class="card-id">${item.serialNo || '(No ID)'}</div>
            <div class="card-status ${status.cls}">${status.text}</div>
            <div class="card-meta">
              ${item.department ? `
                <div class="card-meta-item">
                  <div class="card-meta-label">éƒ¨ç½²</div>
                  <div class="card-meta-value">${item.department}</div>
                </div>
              ` : ''}
              ${item.lineName ? `
                <div class="card-meta-item">
                  <div class="card-meta-label">ãƒ©ã‚¤ãƒ³</div>
                  <div class="card-meta-value">${item.lineName}</div>
                </div>
              ` : ''}
              <div class="card-meta-item">
                <div class="card-meta-label">ç™ºç”Ÿæ—¥æ™‚</div>
                <div class="card-meta-value">${item.occurrenceDate||''} ${item.occurrenceTime||''}</div>
              </div>
              ${item.restartTime ? `
                <div class="card-meta-item">
                  <div class="card-meta-label">å†é–‹æ™‚åˆ»</div>
                  <div class="card-meta-value">${item.restartTime}</div>
                </div>
              ` : ''}
              ${item.handler ? `
                <div class="card-meta-item">
                  <div class="card-meta-label">å‡¦ç½®è€…</div>
                  <div class="card-meta-value">${item.handler}</div>
                </div>
              ` : ''}
            </div>
          </div>
        `;

const centerHtml = `
  <div class="card-center">
    <div class="card-content-section">
      <div class="card-content-label">ğŸš¨ ç•°å¸¸å†…å®¹</div>
      <div class="card-content-text">${item.anomalyContent||'-'}</div>
    </div>
    <div class="card-content-section">
      <div class="card-content-label">ğŸ”§ å¯¾å¿œå†…å®¹</div>
      <div class="card-content-text">${item.actionTaken||'-'}</div>
    </div>
    ${item.qualityResponse ? `
      <div class="card-content-section">
        <div class="card-content-label">âœ… å“è³ªå¯¾å¿œ</div>
        <div class="card-content-text">${item.qualityResponse}</div>
      </div>
    ` : ''}
    ${item.status==='complete' && item.techRequest==='è¦è«‹' ? `
              <div class="card-tech-info">
                ${item.techHandler ? `<div class="tech-info-item"><span class="tech-info-label">æŠ€è¡“å‡¦ç½®è€…:</span><span class="tech-info-value">${item.techHandler}</span></div>` : ''}
                ${item.maintenanceUnit ? `<div class="tech-info-item"><span class="tech-info-label">ä¿å…¨å˜ä½:</span><span class="tech-info-value">${item.maintenanceUnit}</span></div>` : ''}
                ${item.recurrenceType ? `<div class="tech-info-item"><span class="tech-info-label">åˆ†é¡:</span><span class="tech-info-value">${item.recurrenceType}</span></div>` : ''}
                ${item.lifespan ? `<div class="tech-info-item"><span class="tech-info-label">å‘½æ•°:</span><span class="tech-info-value">${item.lifespan}</span></div>` : ''}
                ${item.rootCauseAction ? `<div class="tech-info-item" style="grid-column:1/-1;"><span class="tech-info-label">æŠ€è¡“å¯¾å¿œ:</span><span class="tech-info-value">${item.rootCauseAction}</span></div>` : ''}
${(item.recurrenceType==='å†ç™º' && item.measureStatus) ? 
  `<div class="tech-info-item" style="grid-column:1/-1;">
     <span class="tech-info-label">å¯¾ç­–çŠ¶æ³:</span>
     <span class="tech-info-value">${item.measureStatus}</span>
   </div>` : ''
}
              </div>
            ` : ''}
          </div>
        `;

        const rightHtml = `
          <div class="card-right">
            ${allPhotos.length > 0 ? `
              <div>
                <div class="card-photos-compact">
                  ${allPhotos.slice(0,4).map(url => `
                    <div class="photo-thumb-compact" onclick="window.open('${url}','_blank')">
                      <img src="${url}" alt="">
                    </div>
                  `).join('')}
                </div>
                ${allPhotos.length > 4 ? `<div class="photo-count-badge">ä»– ${allPhotos.length - 4} æš</div>` : ''}
              </div>
            ` : ''}
            <div class="action-btns">
              <button class="btn-small btn-edit" data-edit="${item._id}">âœï¸ ç·¨é›†</button>
              <button class="btn-small btn-delete" data-del="${item._id}">ğŸ—‘ï¸ å‰Šé™¤</button>
            </div>
          </div>
        `;

        return `
          <div class="anomaly-card ${item.status==='complete'?'complete':''}">
            ${stopBadge}
            ${recurBadge} 
            ${leftHtml}
            ${centerHtml}
            ${rightHtml}
          </div>
        `;
      }).join('');
      
      // ãƒšãƒ¼ã‚¸ãƒ³ã‚°ç”¨ã®ã€Œã‚‚ã£ã¨èª­ã¿è¾¼ã‚€ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
      if (!checkFilterActive() && hasMoreData) {
        cardWrap.innerHTML += `
          <div style="text-align:center;margin-top:20px;">
            <button id="btnLoadMore" class="btn btn-secondary" style="max-width:300px;">
              ã•ã‚‰ã«èª­ã¿è¾¼ã‚€ï¼ˆç¾åœ¨${anomalyCache.length}ä»¶è¡¨ç¤ºä¸­ï¼‰
            </button>
          </div>
        `;
        // ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
        setTimeout(() => {
          const btn = document.getElementById('btnLoadMore');
          if (btn) btn.addEventListener('click', loadMoreData);
        }, 0);
      }
    }

    const tableWrap=document.getElementById('tableView');
    if (!items.length){
      tableWrap.innerHTML=`<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;
    }else{
      tableWrap.innerHTML = `
        <div style="overflow-x:auto;">
        <table style="min-width:2200px;">
          <thead><tr>
            <th>æ•´ç†No</th><th>éƒ¨ç½²</th><th>ãƒ©ã‚¤ãƒ³</th><th>ç™ºç”Ÿæ—¥</th><th>ç™ºç”Ÿæ™‚åˆ»</th>
            <th>å†é–‹æ™‚åˆ»</th><th>åœæ­¢æ™‚é–“(åˆ†)</th><th>ç•°å¸¸å†…å®¹</th><th>å‡¦ç½®å†…å®¹</th><th>é¡ã‚Š</th><th>å“è³ªå¯¾å¿œ</th>
            <th>å‡¦ç½®è€…</th><th>æŠ€è¡“å¯¾å¿œ</th><th>æŠ€è¡“å‡¦ç½®è€…</th><th>ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°</th><th>å‰å›çµ‚ç‰©ç¢ºèª</th>
            <th>å‘½æ•°æœ‰ç„¡</th><th>å‘½æ•°åˆ°é”</th><th>ä¿å…¨å˜ä½</th><th>æŠ€è¡“å¯¾å¿œ</th><th>å†ç™ºæ–°è¦</th><th>å¯¾ç­–çŠ¶æ³</th>
            <th>æš«å®š</th><th>å†™çœŸ</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th>
          </tr></thead>
          <tbody>
            ${items.map(it=>{
              const st = it.status==='complete'?'å®Œäº†':'å¾…ã¡';
              const cls = it.status==='complete'?'status-complete':'status-pending';
              const photoCount = (it.mfgPhotoUrls?.length||0)+(it.techPhotoUrls?.length||0);
              const stopMin = calcStopMinutes(it);
              return `
                <tr>
                  <td>${it.serialNo||'-'}</td>
                  <td>${it.department||'-'}</td>
                  <td>${it.lineName||'-'}</td>
                  <td>${it.occurrenceDate||'-'}</td>
                  <td>${it.occurrenceTime||'-'}</td>
                  <td>${it.restartTime||'-'}</td>
                  <td>${stopMin!==null?stopMin:'-'}</td>
                  <td style="min-width:150px;">${(it.anomalyContent||'-').slice(0,50)}${(it.anomalyContent||'').length>50?'...':''}</td>
                  <td style="min-width:150px;">${(it.actionTaken||'-').slice(0,50)}${(it.actionTaken||'').length>50?'...':''}</td>
                  <td>${it.traceback||'-'}</td>
                  <td style="min-width:150px;">${(it.qualityResponse||'-').slice(0,50)}${(it.qualityResponse||'').length>50?'...':''}</td>
                  <td>${it.handler||'-'}</td>
                  <td>${it.techRequest==='è¦è«‹'?'æŠ€è¡“å¯¾å¿œ':it.techRequest==='å®Œçµ'?'ç™ºä¿¡éƒ¨ç½²å®Œçµ':'-'}</td>
                  <td>${it.techHandler||'-'}</td>
                  <td>${it.discoveryTiming||'-'}</td>
                  <td>${it.previousCheck||'-'}</td>
                  <td>${it.lifespan||'-'}</td>
                  <td>${it.lifespanReached||'-'}</td>
                  <td>${it.maintenanceUnit||'-'}</td>
                  <td style="min-width:150px;">${(it.rootCauseAction||'-').slice(0,50)}${(it.rootCauseAction||'').length>50?'...':''}</td>
                  <td>${it.recurrenceType||'-'}</td>
                  <td style="min-width:150px;">${(it.measureStatus||'-').slice(0,50)}${(it.measureStatus||'').length>50?'...':''}</td>

                  <td>${it.affirmation||'-'}</td>
                  <td>${photoCount ? `<button class="btn-small" style="background:#2196f3;color:#fff;" data-photos="${it._id}">ğŸ“· ${photoCount}</button>` : '-'}</td>
                  <td><span class="card-status ${cls}">${st}</span></td>
                  <td class="action-btns">
                    <button class="btn-small btn-edit" data-edit="${it._id}">ç·¨é›†</button>
                    <button class="btn-small btn-delete" data-del="${it._id}">å‰Šé™¤</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
        </div>
      `;
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ“ãƒ¥ãƒ¼ã«ã‚‚ã€Œã‚‚ã£ã¨èª­ã¿è¾¼ã‚€ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
      if (!checkFilterActive() && hasMoreData) {
        tableWrap.innerHTML += `
          <div style="text-align:center;margin-top:20px;">
            <button id="btnLoadMoreTable" class="btn btn-secondary" style="max-width:300px;">
              ã•ã‚‰ã«èª­ã¿è¾¼ã‚€ï¼ˆç¾åœ¨${anomalyCache.length}ä»¶è¡¨ç¤ºä¸­ï¼‰
            </button>
          </div>
        `;
        setTimeout(() => {
          const btn = document.getElementById('btnLoadMoreTable');
          if (btn) btn.addEventListener('click', loadMoreData);
        }, 0);
      }
    }
  }

  function renderTechTargetSelect(){
    const sel = document.getElementById('selectSerialNo');
    sel.innerHTML = '<option value="">æ•´ç†Noã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    anomalyCache
      .filter(x=>x.status==='pending' && x.techRequest==='è¦è«‹')
      .sort((a,b)=> (b.occurrenceDate||'').localeCompare(a.occurrenceDate||''))
      .forEach(x=>{
        const o=document.createElement('option');
        o.value = x._id;
        o.textContent = `[${x.serialNo}] ${x.occurrenceDate} - ${x.anomalyContent?.slice(0,30)||''}...`;
        sel.appendChild(o);
      });
  }

  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      const targetId = tab.getAttribute('data-tab');
      document.getElementById(targetId).classList.add('active');
    });
  });

 async function bootAfterLogin(){
    mastersCache = await fetchMasters();
    updateDepartmentSelect('department', mastersCache.departments);
    updateDepartmentSelect('lineManageDept', mastersCache.departments);
    updateDepartmentSelect('handlerManageDept', mastersCache.departments);
    initializeFilterSelects();

    document.getElementById('department').addEventListener('change', ()=> {
      refreshLineAndHandler('department','lineName','handler', mastersCache.lines, mastersCache.handlers);
    });
    document.getElementById('lineManageDept').addEventListener('change', async ()=> { await updateLineManageList(); });
    document.getElementById('handlerManageDept').addEventListener('change', async ()=> { await updateHandlerManageList(); });

    document.getElementById('discoveryTiming').addEventListener('change', ()=> {
      const timing = document.getElementById('discoveryTiming').value;
      const previousCheckGroup = document.getElementById('previousCheckGroup');
      if (timing === 'åˆç‰©') { previousCheckGroup.style.display = 'block'; }
      else { previousCheckGroup.style.display = 'none'; document.getElementById('previousCheck').value = ''; }
    });
  // æŠ€è¡“ã‚¿ãƒ–ï¼šå†ç™º/æ–°è¦ã® UI é€£å‹•ï¼ˆä»»æ„å…¥åŠ›ã®ã¾ã¾ï¼‰
document.getElementById('recurrenceType')?.addEventListener('change', ()=>{
  const v = document.getElementById('recurrenceType').value;
  const g = document.getElementById('measureStatusGroup');
  g.style.display = (v === 'å†ç™º') ? 'block' : 'none';
  if (v !== 'å†ç™º') document.getElementById('measureStatus').value = '';
});

  // ç™ºä¿¡éƒ¨ç½²ï¼šå†ç™º/æ–°è¦ é¸æŠã§ã€Œå¯¾ç­–çŠ¶æ³ã€ã‚’é–‹é–‰
document.getElementById('mfg_recurrenceType')?.addEventListener('change', ()=>{
  const v = document.getElementById('mfg_recurrenceType').value;
  const g = document.getElementById('mfg_measureStatusGroup');
  g.style.display = (v === 'å†ç™º') ? 'block' : 'none';
  if (v !== 'å†ç™º') document.getElementById('mfg_measureStatus').value = '';
});


    // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆ25ä»¶ï¼‰
    await loadInitialData();
    
    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®è¨­å®šã‚’å‰Šé™¤ã¾ãŸã¯å¤‰æ›´
    // setupRealtimeUpdates(); // ã“ã®è¡Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã¾ãŸã¯å‰Šé™¤

    await updateDepartmentList();
    setNowDateTo('occurrenceDate');
  }


  document.getElementById('selectSerialNo').addEventListener('change', ()=>{
    const id = document.getElementById('selectSerialNo').value;
    const d = anomalyCache.find(it=> it._id===id);
    const box=document.getElementById('selectedDataDisplay'), wrap=document.getElementById('displayContent');
    showingAllCases = false;
    if (!d){
      box.style.display='none';
      wrap.innerHTML='';
      document.getElementById('similarCasesBox').classList.remove('active');
      return;
    }
    wrap.innerHTML = `
      <div style="display:grid;gap:8px;">
        <div><strong>æ•´ç†No:</strong> ${d.serialNo}</div>
        ${d.department?`<div><strong>éƒ¨ç½²:</strong> ${d.department}</div>`:''}
        ${d.lineName?`<div><strong>ãƒ©ã‚¤ãƒ³å:</strong> ${d.lineName}</div>`:''}
        <div><strong>ç•°å¸¸å†…å®¹:</strong> ${d.anomalyContent||''}</div>
        <div><strong>å¯¾å¿œå†…å®¹:</strong> ${d.actionTaken||''}</div>
        <div><strong>ç™ºç”Ÿæ—¥:</strong> ${d.occurrenceDate||''}</div>
        <div><strong>å‡¦ç½®è€…:</strong> ${d.handler||''}</div>
      </div>
    `;
    box.style.display='block';

    const candidates = findSimilarCandidates(d, 10);
    allSimilarCases = candidates;
    const content = document.getElementById('similarCasesContent');
    const simBox = document.getElementById('similarCasesBox');
    if (candidates.length){
      content.innerHTML = renderSimilarList(showingAllCases ? candidates : candidates.slice(0,1));
      const showMoreBtn = document.getElementById('showMoreCases');
      if (candidates.length > 1 && !showingAllCases) {
        showMoreBtn.style.display = 'block';
        showMoreBtn.textContent = `ä»–ã®é¡ä¼¼æ¡ˆä»¶ã‚’è¡¨ç¤ºï¼ˆã‚ã¨${candidates.length - 1}ä»¶ï¼‰`;
      } else {
        showMoreBtn.style.display = 'none';
      }
      simBox.classList.add('active');
    }else{
      simBox.classList.remove('active');
    }
  });

  document.getElementById('showMoreCases').addEventListener('click', () => {
    showingAllCases = true;
    const content = document.getElementById('similarCasesContent');
    content.innerHTML = renderSimilarList(allSimilarCases);
    document.getElementById('showMoreCases').style.display='none';
  });

document.getElementById('btnShowPastOnTech').addEventListener('click', async ()=>{
  const id = document.getElementById('selectSerialNo').value;
  if (!id){ alert('å¯¾è±¡æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

  const d = anomalyCache.find(it=> it._id===id);
  if (!d){ alert('å¯¾è±¡æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

  // æ•´ç†Noæœªå…¥åŠ›ï¼ˆ=é¸æŠæ¡ˆä»¶ã«serialNoç„¡ã—ï¼‰ã®å ´åˆã¯æ¤œç´¢ã—ãªã„
  const serialNo = (d.serialNo||'').trim();
  if (!serialNo){
    alert('é¸æŠä¸­ã®æ¡ˆä»¶ã«æ•´ç†NoãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆæ¤œç´¢ã‚’é–‹å§‹ã—ã¾ã›ã‚“ï¼‰');
    return;
  }

  // å…¨ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è©²å½“æ•´ç†Noã‚’å–å¾—ã—ã€é¸æŠä¸­æ¡ˆä»¶è‡ªèº«ã¯é™¤å¤–
  const all = (await fetchAllBySerialNo(serialNo)).filter(x => x._id !== d._id);

  // é¡ä¼¼åº¦ã¯ã€Œé¸æŠæ¡ˆä»¶ã®ç•°å¸¸å†…å®¹ã€ã‚’åŸºæº–ã«ç®—å‡º
  const withScore = all.map(it => ({
    ...it,
    similarity: calculateSimilarity(d.anomalyContent||'', it.anomalyContent||'')
  }))
  .filter(x => x.similarity >= 30)
  .sort((a,b)=> (b.similarity!==a.similarity) ? (b.similarity-a.similarity) : (b.occurrenceDate||'').localeCompare(a.occurrenceDate||''));

  const content = document.getElementById('similarCasesContent');
  const simBox = document.getElementById('similarCasesBox');
  const showMoreBtn = document.getElementById('showMoreCases');

  if (withScore.length){
    content.innerHTML = renderSimilarList(withScore.slice(0,1));
    if (withScore.length > 1) {
      showMoreBtn.style.display = 'block';
      showMoreBtn.textContent = `ä»–ã®é¡ä¼¼æ¡ˆä»¶ã‚’è¡¨ç¤ºï¼ˆã‚ã¨${withScore.length - 1}ä»¶ï¼‰`;
      showMoreBtn.onclick = ()=>{
        content.innerHTML = renderSimilarList(withScore);
        showMoreBtn.style.display = 'none';
      };
    } else {
      showMoreBtn.style.display = 'none';
    }
    simBox.classList.add('active');
    simBox.scrollIntoView({behavior:'smooth', block:'start'});
  }else{
    simBox.classList.add('active');
    content.innerHTML = '<div style="color:#666;">å€™è£œãŒã‚ã‚Šã¾ã›ã‚“</div>';
    showMoreBtn.style.display='none';
  }
});


document.getElementById('btnShowPastOnMfg').addEventListener('click', async ()=>{
  const serialNo = (document.getElementById('serialNo').value||'').trim();

  // æ•´ç†Noæœªå…¥åŠ›æ™‚ã¯æ¤œç´¢ã—ãªã„
  if (!serialNo){
    alert('æ•´ç†Noã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  // å…¨ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è©²å½“æ•´ç†Noã‚’å–å¾—
  const all = await fetchAllBySerialNo(serialNo);

  // é¡ä¼¼åº¦è¨ˆç®—ï¼ˆå…¥åŠ›ä¸­ã®ç•°å¸¸å†…å®¹ã‚’åŸºæº–ã«ï¼‰
  const baseText = (document.getElementById('anomalyContent').value||'');
  const withScore = all.map(it => ({
    ...it,
    similarity: calculateSimilarity(baseText, it.anomalyContent||'')
  }))
  .filter(x => x._id !== '(temp)') // å¿µã®ãŸã‚
  .sort((a,b)=> (b.similarity!==a.similarity) ? (b.similarity-a.similarity) : (b.occurrenceDate||'').localeCompare(a.occurrenceDate||''));

  const box = document.getElementById('mfgSimilarBox');
  const content = document.getElementById('mfgSimilarContent');
  const more = document.getElementById('mfgShowMore');

  if (withScore.length){
    content.innerHTML = renderSimilarList(withScore.slice(0,3));
    more.style.display = withScore.length>3 ? 'block' : 'none';
    more.onclick = ()=>{
      content.innerHTML = renderSimilarList(withScore);
      more.style.display = 'none';
    };
    box.classList.add('active');
    box.scrollIntoView({behavior:'smooth', block:'start'});
  }else{
    box.classList.add('active');
    content.innerHTML = '<div style="color:#666;">å€™è£œãŒã‚ã‚Šã¾ã›ã‚“</div>';
    more.style.display='none';
  }
});



document.querySelectorAll('.view-toggle button').forEach(b=>{
  b.addEventListener('click', ()=>{
    document.querySelectorAll('.view-toggle button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active'); 
    currentView=b.dataset.view;
    
    const cardView = document.getElementById('cardView');
    const tableView = document.getElementById('tableView');
    const fullscreenBtn = document.getElementById('btnFullscreen');
    
    if (currentView === 'card') {
      cardView.style.display = 'grid';
      tableView.style.display = 'none';
      tableView.classList.remove('fullscreen');
      fullscreenBtn.style.display = 'none';
    } else {
      cardView.style.display = 'none';
      tableView.style.display = 'block';
      fullscreenBtn.style.display = 'inline-block';
    }
    
    renderHistory();
  });
});

// ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åˆ‡ã‚Šæ›¿ãˆ
document.getElementById('btnFullscreen').addEventListener('click', ()=>{
  const tableView = document.getElementById('tableView');
  const fullscreenBtn = document.getElementById('btnFullscreen');
  const isFullscreen = tableView.classList.contains('fullscreen');
  
  if (isFullscreen) {
    // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è§£é™¤
    tableView.classList.remove('fullscreen');
    fullscreenBtn.innerHTML = 'ğŸ–¥ï¸ å…¨ç”»é¢è¡¨ç¤º';
    // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å‰Šé™¤
    const controls = tableView.querySelector('.fullscreen-controls');
    if (controls) controls.remove();
  } else {
    // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åŒ–
    tableView.classList.add('fullscreen');
    fullscreenBtn.innerHTML = 'â†©ï¸ å…ƒã«æˆ»ã™';
    
    // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ç”¨ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’è¿½åŠ 
    const controls = document.createElement('div');
    controls.className = 'fullscreen-controls';
    controls.innerHTML = `
      <h3>ğŸ“‹ ç•°å¸¸å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ« - å…¨ç”»é¢è¡¨ç¤º</h3>
      <button class="btn btn-secondary" style="width:auto;padding:8px 16px;margin:0;" onclick="document.getElementById('btnFullscreen').click()">
        â†©ï¸ å…ƒã«æˆ»ã™
      </button>
    `;
    tableView.insertBefore(controls, tableView.firstChild);
  }
});

// ESCã‚­ãƒ¼ã§ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è§£é™¤
document.addEventListener('keydown', (e)=>{
  if (e.key === 'Escape') {
    const tableView = document.getElementById('tableView');
    if (tableView.classList.contains('fullscreen')) {
      document.getElementById('btnFullscreen').click();
    }
  }
});

/* ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */
/* ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */
const editModalHtml = `
  <div class="modal-content" style="max-width:800px;">
    <div class="modal-title">âœï¸ å±¥æ­´ãƒ¬ã‚³ãƒ¼ãƒ‰ç·¨é›†</div>
    <div class="edit-tabs">
      <button class="edit-tab active" data-edit-tab="mfg">ç™ºä¿¡éƒ¨ç½²</button>
      <button class="edit-tab" data-edit-tab="tech">æŠ€è¡“</button>
      <button class="edit-tab" data-edit-tab="photos">å†™çœŸ</button>
    </div>
    <div id="editMfg" class="edit-pane">
      <div class="form-group"><label>ç™ºç”Ÿæ—¥ *</label><input type="date" id="edit_occurrenceDate"></div>
      <div class="form-group"><label>ç™ºç”Ÿæ™‚åˆ» / å†é–‹æ™‚åˆ»</label><div class="time-group"><input type="time" id="edit_occurrenceTime"><input type="time" id="edit_restartTime"></div></div>
      <div class="form-group"><label>éƒ¨ç½² *</label><select id="edit_department"></select></div>
      <div class="form-group"><label>ãƒ©ã‚¤ãƒ³å *</label><select id="edit_lineName"></select></div>
      <div class="form-group"><label>å‡¦ç½®è€… *</label><select id="edit_handler"></select></div>
      <div class="form-group"><label>æ•´ç†No *</label><input type="text" id="edit_serialNo"></div>
      <div class="form-group"><label>ç•°å¸¸å†…å®¹ *</label><textarea id="edit_anomalyContent"></textarea></div>
      <div class="form-group"><label>å¯¾å¿œå†…å®¹ *</label><textarea id="edit_actionTaken"></textarea></div>
      <div class="form-group"><label>é¡ã‚Š *</label><input type="text" id="edit_traceback"></div>
      <div class="form-group"><label>å“è³ªå¯¾å¿œ</label><textarea id="edit_qualityResponse" placeholder="å“è³ªåˆ¤å®šå±¥æ­´ãƒ»å‚™è€ƒãªã©"></textarea></div>
      <div class="form-group"><label>æŠ€è¡“å¯¾å¿œ *</label><select id="edit_techRequest"><option value="">é¸æŠ</option><option value="è¦è«‹">æŠ€è¡“å¯¾å¿œã‚ã‚Š</option><option value="å®Œçµ">å®Œäº†</option></select></div>
    </div>
    <div id="editTech" class="edit-pane" style="display:none;">
      <div class="form-group"><label>æŠ€è¡“å‡¦ç½®è€…</label><input type="text" id="edit_techHandler"></div>
      <div class="form-group"><label>ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°</label>
        <select id="edit_discoveryTiming">
          <option value="">é¸æŠ</option>
          <option value="é‹è»¢ä¸­">é‹è»¢ä¸­</option>
          <option value="é ­å‡ºã—">é ­å‡ºã—</option>
          <option value="åˆç‰©">åˆç‰©</option>
          <option value="çµ‚ç‰©">çµ‚ç‰©</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </div>
      <div class="form-group"><label>å‰å›çµ‚ç‰©ç¢ºèª</label>
        <select id="edit_previousCheck">
          <option value="">é¸æŠ</option>
          <option value="ä¸è¦">ä¸è¦</option>
          <option value="æœª">æœª</option>
          <option value="ç¢ºèªæ¸ˆ">ç¢ºèªæ¸ˆ</option>
        </select>
      </div>
      <div class="form-group"><label>å‘½æ•°æœ‰ç„¡</label><select id="edit_lifespan"><option value="">é¸æŠ</option><option value="æœ‰">æœ‰</option><option value="ç„¡">ç„¡</option></select></div>
      <div class="form-group"><label>å‘½æ•°åˆ°é”</label>
        <select id="edit_lifespanReached">
          <option value="">é¸æŠ</option>
          <option value="è‡³">è‡³</option>
          <option value="ä¸é”">ä¸é”</option>
        </select>
      </div>
      <div class="form-group"><label>ä¿å…¨å˜ä½</label><input type="text" id="edit_maintenanceUnit"></div>
      <div class="form-group"><label>ä½•ãŒæ‚ªãã©ã†ã—ãŸ</label><textarea id="edit_rootCauseAction"></textarea></div>
      <div class="form-group"><label>å†ç™ºã‹æ–°è¦ã‹</label><select id="edit_recurrenceType"><option value="">é¸æŠ</option><option value="å†ç™º">å†ç™º</option><option value="æ–°è¦">æ–°è¦</option></select></div>
      <div class="form-group" id="edit_measureStatusGroup" style="display:none;">
        <label>å¯¾ç­–çŠ¶æ³ï¼ˆå†ç™ºã®å ´åˆï¼‰</label>
        <textarea id="edit_measureStatus"></textarea>
      </div>
      <div class="form-group"><label>æš«å®š</label>
        <select id="edit_affirmation">
          <option value="">é¸æŠ</option>
          <option value="æœ‰">æœ‰</option>
          <option value="ç„¡">ç„¡</option>
        </select>
      </div>
    </div>
    <div id="editPhotos" class="edit-pane" style="display:none;">
      <div style="margin-bottom:20px;">
        <h4 style="color:#667eea;margin-bottom:10px;">ğŸ“¸ ç™ºä¿¡éƒ¨ç½²éƒ¨é–€ã®å†™çœŸ</h4>
        <div id="edit_mfgPhotosList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-bottom:15px;"></div>
        <div class="photo-upload" onclick="document.getElementById('edit_mfgPhotos').click()">
          <div style="font-size:1.5rem;">ğŸ“¸</div>
          <p style="font-size:.9rem;">ç™ºä¿¡éƒ¨ç½²å†™çœŸã‚’è¿½åŠ </p>
          <input type="file" id="edit_mfgPhotos" accept="image/*" multiple style="display:none;">
        </div>
        <div id="edit_mfgPhotoPreview" class="photo-preview"></div>
      </div>
      <div>
        <h4 style="color:#f57c00;margin-bottom:10px;">ğŸ”§ æŠ€è¡“éƒ¨é–€ã®å†™çœŸ</h4>
        <div id="edit_techPhotosList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-bottom:15px;"></div>
        <div class="photo-upload" onclick="document.getElementById('edit_techPhotos').click()">
          <div style="font-size:1.5rem;">ğŸ“¸</div>
          <p style="font-size:.9rem;">æŠ€è¡“å†™çœŸã‚’è¿½åŠ </p>
          <input type="file" id="edit_techPhotos" accept="image/*" multiple style="display:none;">
        </div>
        <div id="edit_techPhotoPreview" class="photo-preview"></div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-cancel" id="btnEditCancel" style="flex:1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" id="btnEditSave" style="flex:1;">ä¿å­˜</button>
    </div>
  </div>`;
 
  const modal = document.createElement('div'); modal.className='modal'; modal.id='editModal'; modal.innerHTML=editModalHtml; document.body.appendChild(modal);


 let editCurrentId = null;
let editMastersCache = null;

let editPhotosToDelete = [];
function openEdit(id){
  const rec = anomalyCache.find(x=>x._id===id);
  if(!rec){ alert('å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
  
  editCurrentId = id;
  editMfgPhotos = [];
  editTechPhotos = [];
  editPhotosToDelete = [];
  
  (async ()=>{
    editMastersCache = mastersCache || await fetchMasters();
    
    // éƒ¨ç½²ãƒ»ãƒ©ã‚¤ãƒ³ãƒ»å‡¦ç½®è€…ã®è¨­å®š
    const depSel = document.getElementById('edit_department');
    depSel.innerHTML='';
    editMastersCache.departments.forEach(d=>{ 
      const o=document.createElement('option'); 
      o.value=o.textContent=d; 
      depSel.appendChild(o); 
    });
    depSel.value = rec.department||'';
    
    const lineSel=document.getElementById('edit_lineName');
    const hSel=document.getElementById('edit_handler');
    lineSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    (editMastersCache.lines[depSel.value]||[]).forEach(l=>{ 
      const o=document.createElement('option'); 
      o.value=o.textContent=l; 
      lineSel.appendChild(o); 
    });
    hSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    (editMastersCache.handlers[depSel.value]||[]).forEach(h=>{ 
      const o=document.createElement('option'); 
      o.value=o.textContent=h; 
      hSel.appendChild(o); 
    });

    lineSel.value = rec.lineName||'';
    hSel.value = rec.handler||'';

    // ãƒ•ã‚©ãƒ¼ãƒ å€¤ã®è¨­å®š
    document.getElementById('edit_occurrenceDate').value = rec.occurrenceDate||'';
    document.getElementById('edit_occurrenceTime').value = rec.occurrenceTime||'';
    document.getElementById('edit_restartTime').value = rec.restartTime||'';
    document.getElementById('edit_serialNo').value = rec.serialNo||'';
    document.getElementById('edit_anomalyContent').value = rec.anomalyContent||'';
    document.getElementById('edit_actionTaken').value = rec.actionTaken||'';
    document.getElementById('edit_traceback').value = rec.traceback||'';
   document.getElementById('edit_qualityResponse').value = rec.qualityResponse||'';
    document.getElementById('edit_techRequest').value = rec.techRequest||'';
    document.getElementById('edit_techHandler').value = rec.techHandler||'';
    document.getElementById('edit_discoveryTiming').value = rec.discoveryTiming||'';
    document.getElementById('edit_previousCheck').value = rec.previousCheck||'';
    document.getElementById('edit_lifespan').value = rec.lifespan||'';
    document.getElementById('edit_lifespanReached').value = rec.lifespanReached||'';
    document.getElementById('edit_maintenanceUnit').value = rec.maintenanceUnit||'';
    document.getElementById('edit_rootCauseAction').value = rec.rootCauseAction||'';
    document.getElementById('edit_recurrenceType').value = rec.recurrenceType||'';
    document.getElementById('edit_affirmation').value = rec.affirmation||'';
    document.getElementById('edit_measureStatus').value = rec.measureStatus || '';
    document.getElementById('edit_measureStatusGroup').style.display = (rec.recurrenceType === 'å†ç™º') ? 'block' : 'none';
    
    // æ—¢å­˜å†™çœŸã®è¡¨ç¤º
    displayEditExistingPhotos('mfg', rec.mfgPhotoUrls || []);
    displayEditExistingPhotos('tech', rec.techPhotoUrls || []);
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
    document.getElementById('edit_mfgPhotoPreview').innerHTML = '';
    document.getElementById('edit_techPhotoPreview').innerHTML = '';
    
    modal.classList.add('active');
    modal.setAttribute('aria-hidden','false');
     setTimeout(() => {
    bindPhotoInputs(); // å†™çœŸå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å†ãƒã‚¤ãƒ³ãƒ‰
  }, 100);

  })();
}

// æ—¢å­˜å†™çœŸã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
function displayEditExistingPhotos(kind, urls) {
  const listId = kind === 'mfg' ? 'edit_mfgPhotosList' : 'edit_techPhotosList';
  const list = document.getElementById(listId);
  list.innerHTML = '';
  
  if (!urls || urls.length === 0) {
    list.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">å†™çœŸãªã—</p>';
    return;
  }
  
  urls.forEach((url, idx) => {
    const div = document.createElement('div');
    div.className = 'photo-item';
    div.innerHTML = `
      <img src="${url}" alt="">
      <button class="remove-btn" data-delete-existing="${kind}" data-url="${url}" data-index="${idx}">Ã—</button>
    `;
    list.appendChild(div);
  });
}

 // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã®å†ç™º/æ–°è¦åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
  document.getElementById('edit_recurrenceType').addEventListener('change', function(){
    const group = document.getElementById('edit_measureStatusGroup');
    if (this.value === 'å†ç™º') {
      group.style.display = 'block';
    } else {
      group.style.display = 'none';
      document.getElementById('edit_measureStatus').value = '';
    }
  });
  document.addEventListener('change', (e)=>{
    if (e.target.id==='edit_department' && editMastersCache){
      const dep=e.target.value;
      const lineSel=document.getElementById('edit_lineName'), hSel=document.getElementById('edit_handler');
      lineSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      (editMastersCache.lines[dep]||[]).forEach(l=>{ const o=document.createElement('option'); o.value=o.textContent=l; lineSel.appendChild(o); });
      hSel.innerHTML='<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      (editMastersCache.handlers[dep]||[]).forEach(h=>{ const o=document.createElement('option'); o.value=o.textContent=h; hSel.appendChild(o); });
    }
  });
  document.addEventListener('click', (e)=>{
    const t=e.target;
    if (t.matches('.edit-tab')){
      document.querySelectorAll('.edit-tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
     const tab = t.dataset.editTab;
      document.getElementById('editMfg').style.display = t.dataset.editTab==='mfg'?'block':'none';
      document.getElementById('editTech').style.display= t.dataset.editTab==='tech'?'block':'none';
     document.getElementById('editPhotos').style.display = (tab==='photos')? 'block' : 'none';
    }
    const ed = t.closest('button.btn-edit[data-edit]'); if (ed){ openEdit(ed.getAttribute('data-edit')); }
    const del= t.closest('button.btn-delete[data-del]'); if (del){ deleteRecord(del.getAttribute('data-del')); }
    const photos = t.closest('button[data-photos]'); if (photos){ showPhotos(photos.getAttribute('data-photos')); }
  });
  document.getElementById('btnEditCancel').addEventListener('click', ()=>{
    modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); editCurrentId=null;
  });
document.getElementById('btnEditSave').addEventListener('click', async () => {
  if (!editCurrentId) return;
  
  const saveBtn = document.getElementById('btnEditSave');
  saveBtn.disabled = true;
  saveBtn.textContent = 'ä¿å­˜ä¸­...';
  
  try {
    const updates = {
      occurrenceDate: document.getElementById('edit_occurrenceDate').value||'',
      occurrenceTime: document.getElementById('edit_occurrenceTime').value||'',
      restartTime: document.getElementById('edit_restartTime').value||'',
      department: document.getElementById('edit_department').value||'',
      lineName: document.getElementById('edit_lineName').value||'',
      handler: document.getElementById('edit_handler').value||'',
      serialNo: document.getElementById('edit_serialNo').value||'',
      anomalyContent: document.getElementById('edit_anomalyContent').value||'',
      actionTaken: document.getElementById('edit_actionTaken').value||'',
      traceback: document.getElementById('edit_traceback').value||'',
     qualityResponse: document.getElementById('edit_qualityResponse').value||'',
      techRequest: document.getElementById('edit_techRequest').value||'',
      techHandler: document.getElementById('edit_techHandler').value||'',
      discoveryTiming: document.getElementById('edit_discoveryTiming').value||'',
      previousCheck: document.getElementById('edit_previousCheck').value||'',
      lifespan: document.getElementById('edit_lifespan').value||'',
      lifespanReached: document.getElementById('edit_lifespanReached').value||'',
      maintenanceUnit: document.getElementById('edit_maintenanceUnit').value||'',
      rootCauseAction: document.getElementById('edit_rootCauseAction').value||'',
      recurrenceType: document.getElementById('edit_recurrenceType').value||'',
      affirmation: document.getElementById('edit_affirmation').value||'',
      measureStatus: (document.getElementById('edit_recurrenceType').value === 'å†ç™º')
        ? (document.getElementById('edit_measureStatus').value || '')
        : ''
    };

    if (updates.techRequest === 'å®Œçµ') {
      updates.status = 'complete';
    } else {
      const hasTech = (updates.techHandler || updates.lifespan || updates.maintenanceUnit || updates.rootCauseAction || updates.recurrenceType);
      updates.status = hasTech ? 'complete' : 'pending';
    }
    
    // å‰Šé™¤ã™ã‚‹å†™çœŸã‚’å‡¦ç†
    if (editPhotosToDelete.length > 0) {
      saveBtn.textContent = 'ç”»åƒå‰Šé™¤ä¸­...';
      for (const url of editPhotosToDelete) {
        try {
          await deleteObject(ref(storage, url));
          console.log('Deleted photo:', url);
        } catch (e) {
          console.log('Failed to delete photo:', e);
        }
      }
    }
    
    // æ—¢å­˜ã®å†™çœŸURLã‚’å–å¾—ï¼ˆå‰Šé™¤ã•ã‚ŒãŸã‚‚ã®ã‚’é™¤ãï¼‰
    const currentItem = anomalyCache.find(x => x._id === editCurrentId);
    let remainingMfgUrls = (currentItem?.mfgPhotoUrls || []).filter(url => !editPhotosToDelete.includes(url));
    let remainingTechUrls = (currentItem?.techPhotoUrls || []).filter(url => !editPhotosToDelete.includes(url));
    
    // æ–°ã—ã„å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    if (editMfgPhotos.length > 0) {
      saveBtn.textContent = `ç™ºä¿¡éƒ¨ç½²å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­... (${editMfgPhotos.length}æš)`;
      const newUrls = await uploadPhotos(editCurrentId, 'mfg', editMfgPhotos);
      remainingMfgUrls = [...remainingMfgUrls, ...newUrls];
    }
    
    if (editTechPhotos.length > 0) {
      saveBtn.textContent = `æŠ€è¡“å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­... (${editTechPhotos.length}æš)`;
      const newUrls = await uploadPhotos(editCurrentId, 'tech', editTechPhotos);
      remainingTechUrls = [...remainingTechUrls, ...newUrls];
    }
    
    updates.mfgPhotoUrls = remainingMfgUrls;
    updates.techPhotoUrls = remainingTechUrls;
    
    saveBtn.textContent = 'ä¿å­˜ä¸­...';
    await updateDoc(doc(db, 'anomalies', editCurrentId), updates);
    
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
    const cacheIndex = anomalyCache.findIndex(x => x._id === editCurrentId);
    if (cacheIndex !== -1) {
      anomalyCache[cacheIndex] = { ...anomalyCache[cacheIndex], ...updates };
      filteredCache = [...anomalyCache];
      renderHistory();
    }
    
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden','true');
    editCurrentId = null;
    editMfgPhotos = [];
    editTechPhotos = [];
    editPhotosToDelete = [];
    
    alert('æ›´æ–°ã—ã¾ã—ãŸï¼');
    
  } catch (error) {
    console.error('Edit save error:', error);
    alert(`æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ${error.message}`);
  } finally {
    saveBtn.disabled = false;
    saveBtn.textContent = 'ä¿å­˜';
  }
});

async function deleteRecord(id){
  if (!confirm('ã“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆç”»åƒã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰')) return;
  
  console.log('Deleting record:', id);
  const item = anomalyCache.find(a => a._id === id);
  
  if (!item) {
    alert('å‰Šé™¤å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }
  
  try {
    // ç”»åƒå‰Šé™¤
    const deletePromises = [];
    if (item.mfgPhotoUrls && Array.isArray(item.mfgPhotoUrls)){
      item.mfgPhotoUrls.forEach(url => {
        deletePromises.push(
          deleteObject(ref(storage, url)).catch(e => console.log('Failed to delete mfg photo:', e))
        );
      });
    }
    if (item.techPhotoUrls && Array.isArray(item.techPhotoUrls)){
      item.techPhotoUrls.forEach(url => {
        deletePromises.push(
          deleteObject(ref(storage, url)).catch(e => console.log('Failed to delete tech photo:', e))
        );
      });
    }
    await Promise.all(deletePromises);
    
    // Firestoreã‹ã‚‰å‰Šé™¤
    await deleteDoc(doc(db, 'anomalies', id));
    console.log('Document deleted from Firestore');
    
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å‰Šé™¤ã—ã¦å³åº§ã«å†æç”»
    anomalyCache = anomalyCache.filter(item => item._id !== id);
    filteredCache = filteredCache.filter(item => item._id !== id);
    
    renderHistory();
    renderTechTargetSelect();
    updateSerialNoList();
    
    alert('å‰Šé™¤ã—ã¾ã—ãŸ');
    console.log('Cache updated and UI re-rendered');
    
  } catch (err) {
    console.error('Error deleting record:', err);
    alert(`å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ${err.message}`);
  }
}
  function showPhotos(id){
    const item = anomalyCache.find(a => a._id === id);
    if (!item) return;
    const modal = document.getElementById('photoModal');
    const content = document.getElementById('photoModalContent');
    let html = '';
    if (item.mfgPhotoUrls && item.mfgPhotoUrls.length > 0){
      html += '<div style="grid-column:1/-1;"><h4 style="color:#667eea;margin-bottom:10px;">ç™ºä¿¡éƒ¨ç½²éƒ¨é–€ã®å†™çœŸ</h4></div>';
      item.mfgPhotoUrls.forEach(url => {
        html += `<div style="position:relative;aspect-ratio:1;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.1);">
          <img src="${url}" style="width:100%;height:100%;object-fit:cover;cursor:pointer;" onclick="window.open('${url}','_blank')">
        </div>`;
      });
    }
    if (item.techPhotoUrls && item.techPhotoUrls.length > 0){
      html += '<div style="grid-column:1/-1;margin-top:20px;"><h4 style="color:#f57c00;margin-bottom:10px;">æŠ€è¡“éƒ¨é–€ã®å†™çœŸ</h4></div>';
      item.techPhotoUrls.forEach(url => {
        html += `<div style="position:relative;aspect-ratio:1;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.1);">
          <img src="${url}" style="width:100%;height:100%;object-fit:cover;cursor:pointer;" onclick="window.open('${url}','_blank')">
        </div>`;
      });
    }
    if (!html) html = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999;">å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“</div>';
    content.innerHTML = html;
    modal.classList.add('active');
    modal.setAttribute('aria-hidden', 'false');
  }

  window.showSimilarCaseDetail = function(caseId) {
    const item = anomalyCache.find(x => x._id === caseId);
    if (!item) return;
    const modal = document.getElementById('similarCaseDetailModal');
    const content = document.getElementById('similarCaseDetailContent');
    const techId = document.getElementById('selectSerialNo').value;
    const selected = anomalyCache.find(x => x._id === techId) || { anomalyContent: (document.getElementById('anomalyContent').value||'') };
    const similarity = calculateSimilarity(selected.anomalyContent || '', item.anomalyContent || '');
    content.innerHTML = `
      <div style="background:#f8f9ff;padding:20px;border-radius:8px;margin-bottom:20px;">
        <h4 style="color:#667eea;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center;">
          <span>ğŸ“‹ åŸºæœ¬æƒ…å ±</span>
          <span style="background:#4caf50;color:#fff;padding:4px 12px;border-radius:12px;font-size:.9rem;">é¡ä¼¼åº¦ ${similarity}%</span>
        </h4>
        <div style="display:grid;gap:12px;">
          <div><strong>æ•´ç†No:</strong> ${item.serialNo || '-'}</div>
          <div><strong>éƒ¨ç½²:</strong> ${item.department || '-'}</div>
          <div><strong>ãƒ©ã‚¤ãƒ³å:</strong> ${item.lineName || '-'}</div>
          <div><strong>ç™ºç”Ÿæ—¥:</strong> ${item.occurrenceDate || '-'} ${item.occurrenceTime || ''}</div>
          <div><strong>å†é–‹æ™‚åˆ»:</strong> ${item.restartTime || '-'}</div>
          <div><strong>å‡¦ç½®è€…:</strong> ${item.handler || '-'}</div>
        </div>
      </div>
      <div style="background:#fff4e6;padding:20px;border-radius:8px;margin-bottom:20px;">
        <h4 style="color:#f57c00;margin-bottom:15px;">ğŸ”§ ç™ºä¿¡éƒ¨ç½²ã®å¯¾å¿œ</h4>
        <div style="display:grid;gap:12px;">
          <div><strong>ç•°å¸¸å†…å®¹:</strong><div style="background:#fff;padding:12px;border-radius:6px;margin-top:8px;white-space:pre-wrap;">${item.anomalyContent || '-'}</div></div>
          <div><strong>å¯¾å¿œå†…å®¹:</strong><div style="background:#fff;padding:12px;border-radius:6px;margin-top:8px;white-space:pre-wrap;">${item.actionTaken || '-'}</div></div>
          <div><strong>é¡ã‚Š:</strong> ${item.traceback || '-'}</div>
          <div><strong>æŠ€è¡“å¯¾å¿œ:</strong> ${item.techRequest === 'è¦è«‹' ? 'æŠ€è¡“å¯¾å¿œã‚ã‚Š' : 'å®Œäº†'}</div>
        </div>
      </div>
      ${item.status === 'complete' && item.techRequest === 'è¦è«‹' ? `
        <div style="background:#e8f5e9;padding:20px;border-radius:8px;margin-bottom:20px;">
          <h4 style="color:#2e7d32;margin-bottom:15px;">âš™ï¸ æŠ€è¡“éƒ¨é–€ã®å¯¾å¿œ</h4>
          <div style="display:grid;gap:12px;">
            <div><strong>æŠ€è¡“å‡¦ç½®è€…:</strong> ${item.techHandler || '-'}</div>
            <div><strong>ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°:</strong> ${item.discoveryTiming || '-'}</div>
            <div><strong>å‰å›çµ‚ç‰©ç¢ºèª:</strong> ${item.previousCheck || '-'}</div>
            <div><strong>å‘½æ•°æœ‰ç„¡:</strong> ${item.lifespan || '-'}</div>
            <div><strong>å‘½æ•°åˆ°é”:</strong> ${item.lifespanReached || '-'}</div>
            <div><strong>ä¿å…¨å˜ä½:</strong> ${item.maintenanceUnit || '-'}</div>
            <div><strong>åŸå› ãƒ»å¯¾ç­–:</strong><div style="background:#fff;padding:12px;border-radius:6px;margin-top:8px;white-space:pre-wrap;">${item.rootCauseAction || '-'}</div></div>
            <div><strong>å†ç™º/æ–°è¦:</strong> ${item.recurrenceType || '-'}</div>
            <div><strong>æš«å®š:</strong> ${item.affirmation || '-'}</div>
          </div>
        </div>` : ''}
      ${(item.mfgPhotoUrls?.length || item.techPhotoUrls?.length) ? `
        <div style="background:#e3f2fd;padding:20px;border-radius:8px;">
          <h4 style="color:#1976d2;margin-bottom:15px;">ğŸ“· å†™çœŸ</h4>
          ${item.mfgPhotoUrls?.length ? `
            <div style="margin-bottom:8px;color:#667eea;font-weight:bold;">ç™ºä¿¡éƒ¨ç½²éƒ¨é–€</div>
            <div class="similar-photos">
              ${item.mfgPhotoUrls.map(u=>`<div class="thumb" onclick="window.open('${u}','_blank')"><img src="${u}" alt=""></div>`).join('')}
            </div>`:''}
          ${item.techPhotoUrls?.length ? `
            <div style="margin:14px 0 8px;color:#f57c00;font-weight:bold;">æŠ€è¡“éƒ¨é–€</div>
            <div class="similar-photos">
              ${item.techPhotoUrls.map(u=>`<div class="thumb" onclick="window.open('${u}','_blank')"><img src="${u}" alt=""></div>`).join('')}
            </div>`:''}
        </div>` : ''}
    `;
    modal.classList.add('active');
    modal.setAttribute('aria-hidden', 'false');
  };

  document.getElementById('btnPhotoClose').addEventListener('click', ()=>{
    const modal = document.getElementById('photoModal');
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden', 'true');
  });
  document.getElementById('btnSimilarCaseDetailClose').addEventListener('click', ()=>{
    const modal = document.getElementById('similarCaseDetailModal');
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden', 'true');
  });
  document.getElementById('photoModal').addEventListener('click', (e)=>{
    if (e.target.id === 'photoModal') {
      document.getElementById('photoModal').classList.remove('active');
      document.getElementById('photoModal').setAttribute('aria-hidden', 'true');
    }
  });
  document.getElementById('similarCaseDetailModal').addEventListener('click', (e)=>{
    if (e.target.id === 'similarCaseDetailModal') {
      document.getElementById('similarCaseDetailModal').classList.remove('active');
      document.getElementById('similarCaseDetailModal').setAttribute('aria-hidden', 'true');
    }
  });

/* CSVå‡ºåŠ› */
document.getElementById('btnExport').addEventListener('click', ()=>{
  if (!anomalyCache.length){ alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ–°ã—ã„é †åºã«å¤‰æ›´
  const headers = [
    'éƒ¨ç½²', 'ç™ºç”Ÿæ—¥', 'ç™ºç”Ÿæ™‚åˆ»', 'å†é–‹æ™‚åˆ»', 'åœæ­¢æ™‚é–“(åˆ†)', 'é¡ã‚Š', 
    'ãƒ©ã‚¤ãƒ³å', 'æ•´ç†No', 'ç•°å¸¸å†…å®¹', 'å¯¾å¿œå†…å®¹', 'é¡ã‚Š', 
    'å‡¦ç½®è€…', 'æŠ€è¡“å¯¾å¿œ', 'æœ€çµ‚è€…å', 'å¯¾ç­–çŠ¶æ³', 'æŠ€è¡“å‡¦ç½®è€…', 'ä¿å…¨å˜ä½', 
    'ç™ºç”Ÿã‚¿ã‚¤ãƒŸãƒ³ã‚°', 'å‰å›çµ‚ç‰©ç¢ºèª', 'æŠ€è¡“å¯¾å¿œ', 'å‘½æ•°åˆ°é”', 'æš«å®š', 'çŠ¶æ…‹', '_id'
  ];
  
  const rows = anomalyCache.map(item=>{
    const stopMin = calcStopMinutes(item);
    return [
      item.department||'',           // éƒ¨ç½²
      item.occurrenceDate||'',       // ç™ºç”Ÿæ—¥
      item.occurrenceTime||'',       // ç™ºç”Ÿæ™‚åˆ»
      item.restartTime||'',          // å†é–‹æ™‚åˆ»
      (stopMin!==null?stopMin:''),   // åœæ­¢æ™‚é–“(åˆ†)
      item.traceback||'',            // é¡ã‚Š
      item.lineName||'',             // ãƒ©ã‚¤ãƒ³å
      item.serialNo||'',             // æ•´ç†No
      item.anomalyContent||'',       // ç•°å¸¸å†…å®¹
      item.actionTaken||'',          // å¯¾å¿œå†…å®¹
      item.qualityResponse||'',      // å“è³ªå¯¾å¿œï¼ˆé¡ã‚Šã®å¾Œï¼‰
      item.handler||'',              // å‡¦ç½®è€…
      item.techRequest==='è¦è«‹'?'æŠ€è¡“å¯¾å¿œã‚ã‚Š':item.techRequest==='å®Œçµ'?'å®Œäº†':'', // æŠ€è¡“å¯¾å¿œ
      item.techHandler||'',          // æœ€çµ‚è€…åï¼ˆæŠ€è¡“å‡¦ç½®è€…ï¼‰
      item.measureStatus||'',        // å¯¾ç­–çŠ¶æ³
      item.techHandler||'',          // æŠ€è¡“å‡¦ç½®è€…ï¼ˆé‡è¤‡ï¼Ÿï¼‰
      item.maintenanceUnit||'',      // ä¿å…¨å˜ä½
      item.discoveryTiming||'',      // ç™ºç”Ÿã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼ˆç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼‰
      item.previousCheck||'',        // å‰å›çµ‚ç‰©ç¢ºèª
      item.rootCauseAction||'',      // æŠ€è¡“å¯¾å¿œï¼ˆå†…å®¹ï¼‰
      item.lifespanReached||'',      // å‘½æ•°åˆ°é”
      item.affirmation||'',          // æš«å®š
      item.status==='complete'?'å®Œäº†':'æŠ€è¡“å…¥åŠ›å¾…ã¡', // çŠ¶æ…‹
      item._id                       // _id
    ];
  });
  
  let csv = '\uFEFF' + headers.join(',') + '\n';
  rows.forEach(r=>{ csv += r.map(c=>`"${(c??'').toString().replace(/"/g,'""')}"`).join(',')+'\n'; });
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download=`ç•°å¸¸å±¥æ­´_${new Date().toISOString().split('T')[0]}.csv`; a.click();
});

  /* ãƒã‚¹ã‚¿ç®¡ç† */
  async function updateDepartmentList(){
    const list=document.getElementById('departmentList'); list.innerHTML='';
    const snap=await getDocs(collection(db,'masters','department','items'));
    const arr = snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=> a.name.localeCompare(b.name));
    if (!arr.length){ list.innerHTML='<p style="color:#999;text-align:center;">éƒ¨ç½²ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; return; }
    arr.forEach(row=>{
      const div=document.createElement('div');
      div.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#f8f9fa;border-radius:6px;border-left:3px solid #667eea;';
      div.innerHTML = `<span style="font-weight:500;color:#333">${row.name}</span>
        <button class="btn-small btn-delete" data-del-dept="${row.id}">å‰Šé™¤</button>`;
      list.appendChild(div);
    });
    mastersCache = await fetchMasters();
    updateDepartmentSelect('department', mastersCache.departments);
    updateDepartmentSelect('lineManageDept', mastersCache.departments);
    updateDepartmentSelect('handlerManageDept', mastersCache.departments);
  }
  document.getElementById('btnAddDept').addEventListener('click', async ()=>{
    const name=(document.getElementById('newDepartment').value||'').trim();
    if (!name){ alert('éƒ¨ç½²åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    await addDoc(collection(db,'masters','department','items'), {name});
    document.getElementById('newDepartment').value='';
    updateDepartmentList();
  });
  document.addEventListener('click', async (e)=>{
    const del=e.target.closest('button[data-del-dept]'); if (!del) return;
    await deleteDoc(doc(db,'masters','department','items', del.getAttribute('data-del-dept')));
    updateDepartmentList();
  });

  async function updateLineManageList(){
    const dept=document.getElementById('lineManageDept').value;
    const list=document.getElementById('lineList'); 
    list.innerHTML='';
    if (!dept){ list.innerHTML='<p style="color:#999;text-align:center;">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</p>'; return; }
    const snap=await getDocs(query(collection(db,'masters','line','items'), where('department','==',dept)));
    const arr=snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=> a.name.localeCompare(b.name));
    if (!arr.length){ list.innerHTML='<p style="color:#999;text-align:center;">ãƒ©ã‚¤ãƒ³åãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; return; }
    arr.forEach(row=>{
      const div=document.createElement('div');
      div.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#f8f9fa;border-radius:6px;border-left:3px solid #f57c00;';
      div.innerHTML = `<span style="font-weight:500;color:#333">${row.name}</span>
        <button class="btn-small btn-delete" data-del-line="${row.id}">å‰Šé™¤</button>`;
      list.appendChild(div);
    });
  }
  document.getElementById('btnAddLine').addEventListener('click', async ()=>{
    const dept=document.getElementById('lineManageDept').value;
    const name=(document.getElementById('newLine').value||'').trim();
    if (!dept){ alert('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    if (!name){ alert('ãƒ©ã‚¤ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    await addDoc(collection(db,'masters','line','items'), {department:dept, name});
    document.getElementById('newLine').value='';
    mastersCache = await fetchMasters();
    await updateLineManageList();
  });
  document.addEventListener('click', async (e)=>{
    const del=e.target.closest('button[data-del-line]'); if (!del) return;
    await deleteDoc(doc(db,'masters','line','items', del.getAttribute('data-del-line')));
    mastersCache = await fetchMasters();
    await updateLineManageList();
  });

  async function updateHandlerManageList(){
    const dept=document.getElementById('handlerManageDept').value;
    const list=document.getElementById('handlerList'); 
    list.innerHTML='';
    if (!dept){ list.innerHTML='<p style="color:#999;text-align:center;">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</p>'; return; }
    const snap=await getDocs(query(collection(db,'masters','handler','items'), where('department','==',dept)));
    const arr=snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=> a.name.localeCompare(b.name));
    if (!arr.length){ list.innerHTML='<p style="color:#999;text-align:center;">å‡¦ç½®è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'; return; }
    arr.forEach(row=>{
      const div=document.createElement('div');
      div.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#f8f9fa;border-radius:6px;border-left:3px solid #2e7d32;';
      div.innerHTML = `<span style="font-weight:500;color:#333">${row.name}</span>
        <button class="btn-small btn-delete" data-del-handler="${row.id}">å‰Šé™¤</button>`;
      list.appendChild(div);
    });
  }
  document.getElementById('btnAddHandler').addEventListener('click', async ()=>{
    const dept=document.getElementById('handlerManageDept').value;
    const name=(document.getElementById('newHandler').value||'').trim();
    if (!dept){ alert('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    if (!name){ alert('å‡¦ç½®è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    await addDoc(collection(db,'masters','handler','items'), {department:dept, name});
    document.getElementById('newHandler').value='';
    mastersCache = await fetchMasters();
    await updateHandlerManageList();
  });
  document.addEventListener('click', async (e)=>{
    const del=e.target.closest('button[data-del-handler]'); if (!del) return;
    await deleteDoc(doc(db,'masters','handler','items', del.getAttribute('data-del-handler')));
    mastersCache = await fetchMasters();
    await updateHandlerManageList();
  });

</script>
</body>
</html>
