<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>æ£šå…¥å‡ºåº«ç®¡ç†</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="format-detection" content="telephone=no" />
<style>
:root {
  --bg: #0f1117;
  --surface: #1a1d27;
  --surface2: #222636;
  --border: #2e3347 !important;
  --accent-in: #00d084;
  --accent-out: #ff6b35;
  --accent-empty: #7c8db5;
  --accent-blue: #4f8ef7;
  --text: #e8ecf5;
  --muted: #7c8db5;
  --danger: #ff4d6a;
  --radius: 16px;
  --font: 'Courier New', 'Noto Sans JP', monospace;
}

- { box-sizing: border-box; margin: 0; padding: 0; }
  html { height: 100%; background: #0f1117 !important; }

/* ãƒœã‚¿ãƒ³ãƒ»å…¥åŠ›ã®ãƒ•ã‚©ãƒ³ãƒˆã‚’bodyã‹ã‚‰ç¶™æ‰¿ */
button, input, select, textarea {
font-family: inherit;
font-size: inherit;
color: inherit !important;
}

body {
height: 100%;
overflow-x: hidden;
background: #0f1117 !important;
color: var(â€“text) !important;
font-family: var(â€“font);
-webkit-touch-callout: none;
-webkit-user-select: none;
user-select: none;
-webkit-text-fill-color: #e8ecf5;
}

/* éè¡¨ç¤ºã‚¹ã‚­ãƒ£ãƒ³å…¥åŠ› */
#scanInput {
position: absolute; left: -9999px; top: -9999px;
width: 1px; height: 1px; opacity: 0; pointer-events: none;
}

/* ========== ãƒ˜ãƒƒãƒ€ãƒ¼ ========== */
header {
display: flex;
align-items: center;
justify-content: space-between;
padding: 14px 16px;
border-bottom: 1px solid var(â€“border) !important;
background: var(â€“surface) !important;
position: sticky;
top: 0;
z-index: 100;
}
.headerTitle {
font-size: 15px;
font-weight: 700;
letter-spacing: 0.12em;
color: var(â€“accent-blue) !important;
}
.headerBadge {
font-size: 11px;
color: var(â€“muted) !important;
background: var(â€“bg) !important;
border: 1px solid var(â€“border) !important;
padding: 3px 8px;
border-radius: 6px;
}

/* ========== ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ ========== */
#modeScreen {
display: block;
}
.modeTitle {
text-align: center;
padding: 32px 16px 24px;
font-size: 13px;
color: var(â€“muted) !important;
letter-spacing: 0.15em;
}
.modeCards {
padding: 0 16px 24px;
display: flex;
flex-direction: column;
gap: 14px;
}
.modeCard {
border-radius: 20px;
border: 2px solid var(â€“border) !important;
padding: 28px 24px;
cursor: pointer;
transition: all 0.2s ease;
position: relative;
overflow: hidden;
background: var(â€“surface) !important;
-webkit-tap-highlight-color: transparent !important;
}
.modeCard::before {
content: â€˜â€™;
position: absolute;
top: 0; left: 0;
width: 5px;
height: 100%;
}
.modeCard.inbound::before { background: var(â€“accent-in) !important; }
.modeCard.outbound::before { background: var(â€“accent-out) !important; }
.modeCard.empty::before { background: var(â€“accent-empty) !important; }

.modeCard:active { transform: scale(0.98); }
.modeCardIcon { font-size: 40px; margin-bottom: 12px; }
.modeCardLabel {
font-size: 22px;
font-weight: 900;
letter-spacing: 0.08em;
margin-bottom: 6px;
}
.modeCard.inbound .modeCardLabel { color: var(â€“accent-in) !important; }
.modeCard.outbound .modeCardLabel { color: var(â€“accent-out) !important; }
.modeCard.empty .modeCardLabel { color: var(â€“accent-empty) !important; }
.modeCardDesc {
font-size: 12px;
color: var(â€“muted) !important;
line-height: 1.6;
}

/* ========== ä½œæ¥­ç”»é¢å…±é€š ========== */
.workScreen { display: none; }
.workScreen.active { display: block; }

.backBtn {
display: inline-flex;
align-items: center;
gap: 8px;
padding: 10px 16px;
margin: 14px 16px;
border: 1px solid var(â€“border) !important;
border-radius: 10px;
background: var(â€“surface) !important;
color: var(â€“muted) !important;
font-size: 13px;
cursor: pointer;
-webkit-tap-highlight-color: transparent !important;
transition: all 0.2s;
}
.backBtn:active { background: var(â€“surface2) !important; }

.workTitle {
font-size: 18px;
font-weight: 900;
letter-spacing: 0.1em;
padding: 0 16px 16px;
border-bottom: 1px solid var(â€“border) !important;
margin-bottom: 16px;
}

/* ========== ã‚¹ãƒ†ãƒƒãƒ—UIï¼ˆå…¥åº«ï¼‰ ========== */
.stepWrap {
padding: 0 16px;
}
.stepRow {
display: flex;
align-items: flex-start;
gap: 14px;
margin-bottom: 16px;
}
.stepNum {
width: 32px;
height: 32px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 14px;
font-weight: 900;
flex-shrink: 0;
margin-top: 4px;
}
.stepNum.active { background: var(â€“accent-in) !important; color: #000 !important; }
.stepNum.done { background: var(â€“surface2) !important; color: var(â€“accent-in) !important; border: 2px solid var(â€“accent-in) !important; }
.stepNum.waiting { background: var(â€“surface2) !important; color: var(â€“muted) !important; border: 2px solid var(â€“border) !important; }

.stepCard {
flex: 1;
background: var(â€“surface) !important;
border: 1px solid var(â€“border) !important;
border-radius: var(â€“radius);
padding: 16px;
transition: all 0.3s;
}
.stepCard.active { border-color: var(â€“accent-in) !important; }
.stepCard.done { border-color: var(â€“border) !important; opacity: 0.7; }

.stepLabel {
font-size: 11px;
color: var(â€“muted) !important;
letter-spacing: 0.12em;
margin-bottom: 8px;
}
.stepValue {
font-size: 28px;
font-weight: 900;
color: var(â€“text) !important;
letter-spacing: 0.05em;
min-height: 36px;
}
.stepValue.placeholder {
color: var(â€“muted) !important;
font-size: 16px;
line-height: 2.2;
}
.stepHint {
margin-top: 8px;
font-size: 12px;
color: var(â€“accent-in) !important;
display: flex;
align-items: center;
gap: 6px;
}
.stepHint.hidden { display: none; }

/* å…¥åº«å®Œäº†ãƒãƒŠãƒ¼ */
.successBanner {
margin: 16px;
padding: 16px;
background: linear-gradient(135deg, rgba(0,208,132,0.15), rgba(0,208,132,0.05)) !important;
border: 1px solid var(â€“accent-in) !important;
border-radius: var(â€“radius);
text-align: center;
display: none;
}
.successBanner.show { display: block; }
.successBanner .successIcon { font-size: 36px; margin-bottom: 8px; }
.successBanner .successMsg { font-size: 16px; font-weight: 900; color: var(â€“accent-in) !important; margin-bottom: 4px; }
.successBanner .successSub { font-size: 12px; color: var(â€“muted) !important; }

/* ========== å‡ºåº«æ¤œç´¢ ========== */
.searchWrap {
padding: 0 16px 16px;
}
.searchLabel {
font-size: 11px;
color: var(â€“muted) !important;
letter-spacing: 0.12em;
margin-bottom: 8px;
}
.searchInputRow {
display: flex;
gap: 10px;
margin-bottom: 16px;
}
.searchInput {
flex: 1;
background: var(â€“surface) !important;
border: 2px solid var(â€“border) !important;
border-radius: 12px;
padding: 14px 16px;
font-size: 22px;
font-weight: 900;
color: var(â€“text) !important;
font-family: var(â€“font);
letter-spacing: 0.1em;
-webkit-user-select: auto;
user-select: auto;
}
.searchInput:focus {
outline: none;
border-color: var(â€“accent-out) !important;
}
.searchBtn {
padding: 14px 20px;
background: var(â€“accent-out) !important;
border: none !important;
border-radius: 12px;
color: #fff !important;
font-size: 20px;
cursor: pointer;
transition: all 0.2s;
-webkit-tap-highlight-color: transparent !important;
}
.searchBtn:active { transform: scale(0.95); }

/* å“ç•ªé¸æŠãƒœã‚¿ãƒ³ç¾¤ */
.productBtnSection {
margin-bottom: 20px;
}
.productBtnLabel {
font-size: 11px;
color: var(â€“muted) !important;
letter-spacing: 0.12em;
margin-bottom: 10px;
}
.productBtnGrid {
display: flex;
flex-wrap: wrap;
gap: 8px;
}
.productBtn {
padding: 10px 18px;
background: var(â€“surface) !important;
border: 1px solid var(â€“border) !important;
border-radius: 20px;
color: var(â€“text) !important;
font-size: 16px;
font-weight: 900;
letter-spacing: 0.08em;
cursor: pointer;
transition: all 0.2s;
-webkit-tap-highlight-color: transparent !important;
font-family: var(â€“font);
}
.productBtn:active {
background: rgba(255,107,53,0.15) !important;
border-color: var(â€“accent-out) !important;
color: var(â€“accent-out) !important;
transform: scale(0.96);
}
.productBtn.selected {
background: rgba(255,107,53,0.15) !important;
border-color: var(â€“accent-out) !important;
color: var(â€“accent-out) !important;
}
.productBtnEmpty {
font-size: 12px;
color: var(â€“muted) !important;
padding: 8px 0;
}

/* æ¤œç´¢çµæœ */
.resultHeader {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 12px;
}
.resultCount {
font-size: 12px;
color: var(â€“muted) !important;
}
.resultCountNum {
font-size: 18px;
font-weight: 900;
color: var(â€“accent-out) !important;
}

.shelfCard {
background: var(â€“surface) !important;
border: 1px solid var(â€“border) !important;
border-radius: var(â€“radius);
padding: 16px;
margin-bottom: 10px;
display: flex;
align-items: center;
gap: 16px;
transition: all 0.2s;
}
.shelfCard:active { background: var(â€“surface2) !important; }
.shelfRank {
width: 36px;
height: 36px;
border-radius: 10px;
background: var(â€“surface2) !important;
display: flex;
align-items: center;
justify-content: center;
font-size: 16px;
font-weight: 900;
color: var(â€“muted) !important;
flex-shrink: 0;
}
.shelfRank.first {
background: linear-gradient(135deg, #f59e0b, #d97706) !important;
color: #000 !important;
}
.shelfInfo { flex: 1; }
.shelfId {
font-size: 24px;
font-weight: 900;
color: var(â€“text) !important;
letter-spacing: 0.08em;
}
.shelfDate {
font-size: 11px;
color: var(â€“muted) !important;
margin-top: 4px;
}
.shelfAge {
font-size: 12px;
font-weight: 700;
padding: 4px 10px;
border-radius: 8px;
flex-shrink: 0;
}
.shelfAge.fresh { background: rgba(79,142,247,0.15) !important; color: var(â€“accent-blue) !important; }
.shelfAge.old { background: rgba(255,107,53,0.15) !important; color: var(â€“accent-out) !important; }
.shelfAge.oldest { background: rgba(255,77,106,0.15) !important; color: var(â€“danger) !important; }

.noResult {
text-align: center;
padding: 40px 16px;
color: var(â€“muted) !important;
font-size: 14px;
}
.noResultIcon { font-size: 40px; margin-bottom: 12px; }

/* ========== ç©ºãç™»éŒ² ========== */
.emptyWrap {
padding: 0 16px;
}
.emptyHint {
background: var(â€“surface) !important;
border: 1px solid var(â€“border) !important;
border-radius: var(â€“radius);
padding: 16px;
margin-bottom: 16px;
font-size: 13px;
color: var(â€“muted) !important;
line-height: 1.7;
}
.emptyTarget {
background: var(â€“surface) !important;
border: 2px solid var(â€“border) !important;
border-radius: var(â€“radius);
padding: 24px 16px;
text-align: center;
margin-bottom: 16px;
transition: all 0.3s;
}
.emptyTarget.active { border-color: var(â€“accent-empty) !important; }
.emptyTargetLabel {
font-size: 11px;
color: var(â€“muted) !important;
letter-spacing: 0.12em;
margin-bottom: 12px;
}
.emptyTargetValue {
font-size: 48px;
font-weight: 900;
color: var(â€“text) !important;
letter-spacing: 0.05em;
min-height: 60px;
}
.emptyTargetValue.placeholder {
font-size: 20px;
color: var(â€“muted) !important;
line-height: 3;
}
.emptyCurrentItem {
margin-top: 10px;
font-size: 12px;
color: var(â€“accent-out) !important;
}

.emptySuccessBanner {
margin-bottom: 16px;
padding: 16px;
background: linear-gradient(135deg, rgba(124,141,181,0.15), rgba(124,141,181,0.05)) !important;
border: 1px solid var(â€“accent-empty) !important;
border-radius: var(â€“radius);
text-align: center;
display: none;
}
.emptySuccessBanner.show { display: block; }

/* ========== ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ ========== */
.toast {
position: fixed;
bottom: 24px;
left: 50%;
transform: translateX(-50%) translateY(80px);
background: var(â€“surface2) !important;
border: 1px solid var(â€“border) !important;
color: var(â€“text) !important;
padding: 12px 24px;
border-radius: 40px;
font-size: 14px;
font-weight: 700;
z-index: 9999;
transition: transform 0.3s ease;
white-space: nowrap;
pointer-events: none;
}
.toast.show { transform: translateX(-50%) translateY(0); }
.toast.ok { border-color: var(â€“accent-in) !important; color: var(â€“accent-in) !important; }
.toast.error { border-color: var(â€“danger) !important; color: var(â€“danger) !important; }

/* ========== æ£šä¸€è¦§ã‚¿ãƒ–ï¼ˆå‡ºåº«ç”»é¢ï¼‰ ========== */
.tabRow {
display: flex;
gap: 8px;
margin-bottom: 16px;
}
.tab {
flex: 1;
padding: 10px;
border: 1px solid var(â€“border) !important;
border-radius: 10px;
background: var(â€“surface) !important;
color: var(â€“muted) !important;
font-size: 12px;
font-weight: 700;
cursor: pointer;
text-align: center;
transition: all 0.2s;
letter-spacing: 0.05em;
-webkit-tap-highlight-color: transparent !important;
}
.tab.active {
background: var(â€“surface2) !important;
border-color: var(â€“accent-out) !important;
color: var(â€“accent-out) !important;
}

/* ========== å…¨æ£šãƒªã‚¹ãƒˆ ========== */
.allShelvesGrid {
display: flex;
flex-direction: column;
gap: 8px;
}
.allShelfRow {
background: var(â€“surface) !important;
border: 1px solid var(â€“border) !important;
border-radius: 12px;
padding: 12px 16px;
display: flex;
align-items: center;
gap: 12px;
}
.allShelfId {
font-size: 18px;
font-weight: 900;
color: var(â€“text) !important;
}
.allShelfProduct {
font-size: 14px;
font-weight: 700;
padding: 4px 12px;
border-radius: 8px;
}
.allShelfProduct.occupied { background: rgba(0,208,132,0.15) !important; color: var(â€“accent-in) !important; }
.allShelfProduct.empty { background: rgba(124,141,181,0.1) !important; color: var(â€“muted) !important; }
.allShelfMeta {
font-size: 11px;
color: var(â€“muted) !important;
margin-top: 2px;
}

/* æ£šã”ã¨ã®å‡ºåº«ãƒœã‚¿ãƒ³ */
.shelfOutBtn {
padding: 8px 14px;
border: 1px solid var(â€“accent-empty) !important;
border-radius: 10px;
background: rgba(124,141,181,0.1) !important;
color: var(â€“accent-empty) !important;
font-size: 12px;
font-weight: 900;
cursor: pointer;
transition: all 0.2s;
-webkit-tap-highlight-color: transparent !important;
font-family: var(â€“font);
white-space: nowrap;
flex-shrink: 0;
}
.shelfOutBtn:active { background: rgba(124,141,181,0.3) !important; transform: scale(0.95); }
.shelfOutBtn:disabled { opacity: 0.4; cursor: not-allowed; }

/* æ£šå‰Šé™¤ãƒœã‚¿ãƒ³ */
.shelfDeleteBtn {
padding: 6px 10px;
border: 1px solid var(â€“danger) !important;
border-radius: 8px;
background: rgba(255,77,106,0.08) !important;
color: var(â€“danger) !important;
font-size: 13px;
cursor: pointer;
transition: all 0.2s;
-webkit-tap-highlight-color: transparent !important;
flex-shrink: 0;
}
.shelfDeleteBtn:active { background: rgba(255,77,106,0.2) !important; transform: scale(0.95); }

/* å…¥åº«å±¥æ­´ã‚«ãƒ¼ãƒ‰ */
.modeCard.history::before { background: var(â€“accent-blue) !important; }
.modeCard.history .modeCardLabel { color: var(â€“accent-blue) !important; }

/* å±¥æ­´ãƒªã‚¹ãƒˆ */
.historyWrap { padding: 0 16px 16px; }
.historyItem {
background: var(â€“surface) !important;
border: 1px solid var(â€“border) !important;
border-radius: 12px;
padding: 14px 16px;
margin-bottom: 8px;
display: flex;
align-items: center;
gap: 14px;
}
.historyItemIcon {
font-size: 22px;
flex-shrink: 0;
}
.historyItemInfo { flex: 1; min-width: 0; }
.historyItemProduct {
font-size: 20px;
font-weight: 900;
color: var(â€“text) !important;
letter-spacing: 0.06em;
}
.historyItemShelf {
font-size: 13px;
color: var(â€“accent-in) !important;
margin-top: 2px;
font-weight: 700;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}
.historyItemDate {
font-size: 11px;
color: var(â€“muted) !important;
flex-shrink: 0;
text-align: right;
line-height: 1.5;
}

/* æ£šç•ªé¸æŠãƒœã‚¿ãƒ³ï¼ˆå…¥åº«Step2ï¼‰ */
.shelfBtnSection {
margin-top: 12px;
}
.shelfBtnLabel {
font-size: 11px;
color: var(â€“accent-in) !important;
letter-spacing: 0.12em;
margin-bottom: 8px;
}
.shelfBtnGrid {
display: flex;
flex-wrap: wrap;
gap: 8px;
}
.shelfSelBtn {
padding: 10px 16px;
background: var(â€“surface2) !important;
border: 1px solid var(â€“border) !important;
border-radius: 12px;
color: var(â€“text) !important;
font-size: 15px;
font-weight: 900;
letter-spacing: 0.05em;
cursor: pointer;
transition: all 0.2s;
-webkit-tap-highlight-color: transparent !important;
font-family: var(â€“font);
}
.shelfSelBtn:active, .shelfSelBtn.selected {
background: rgba(0,208,132,0.15) !important;
border-color: var(â€“accent-in) !important;
color: var(â€“accent-in) !important;
transform: scale(0.97);
}
.shelfSelBtnEmpty {
font-size: 12px;
color: var(â€“muted) !important;
padding: 6px 0;
}

/* æ£šç•ªç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ */
.modeCard.shelfmaster::before { background: #f59e0b !important; }
.modeCard.shelfmaster .modeCardLabel { color: #f59e0b !important; }

/* æ£šç•ªç™»éŒ²ç”»é¢ */
.shelfMasterWrap { padding: 0 16px 24px; }
.shelfMasterInput {
display: flex;
gap: 10px;
margin-bottom: 16px;
}
.shelfMasterTextInput {
flex: 1;
background: var(â€“surface) !important;
border: 2px solid var(â€“border) !important;
border-radius: 12px;
padding: 14px 16px;
font-size: 20px;
font-weight: 900;
color: var(â€“text) !important;
font-family: var(â€“font);
letter-spacing: 0.1em;
-webkit-user-select: auto;
user-select: auto;
}
.shelfMasterTextInput:focus {
outline: none;
border-color: #f59e0b !important;
}
.shelfMasterAddBtn {
padding: 14px 20px;
background: #f59e0b !important;
border: none !important;
border-radius: 12px;
color: #000 !important;
font-size: 20px;
font-weight: 900;
cursor: pointer;
transition: all 0.2s;
-webkit-tap-highlight-color: transparent !important;
}
.shelfMasterAddBtn:active { transform: scale(0.95); }
.shelfMasterHint {
font-size: 12px;
color: var(â€“muted) !important;
margin-bottom: 16px;
line-height: 1.6;
background: var(â€“surface) !important;
border: 1px solid var(â€“border) !important;
border-radius: 10px;
padding: 12px;
}
.shelfMasterList {
display: flex;
flex-direction: column;
gap: 8px;
}
.shelfMasterRow {
display: flex;
align-items: center;
justify-content: space-between;
background: var(â€“surface) !important;
border: 1px solid var(â€“border) !important;
border-radius: 12px;
padding: 14px 16px;
gap: 12px;
}
.shelfMasterName {
font-size: 20px;
font-weight: 900;
color: var(â€“text) !important;
flex: 1;
}
.shelfMasterStatus {
font-size: 12px;
padding: 4px 10px;
border-radius: 8px;
}
.shelfMasterStatus.occupied { background: rgba(0,208,132,0.15) !important; color: var(â€“accent-in) !important; }
.shelfMasterStatus.empty { background: rgba(124,141,181,0.1) !important; color: var(â€“muted) !important; }
.shelfMasterStatus.unregistered { background: rgba(245,158,11,0.1) !important; color: #f59e0b !important; }
</style>

</head>
<body>

<!-- éè¡¨ç¤ºã‚¹ã‚­ãƒ£ãƒ³å…¥åŠ› -->

<input id="scanInput" type="text" readonly inputmode="none"
autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" aria-hidden="true" />

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->

<header>
  <div class="headerTitle">ğŸ“¦ æ£šç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </div>
  <div id="firebaseStatus" class="headerBadge">Firebase: æœªæ¥ç¶š</div>
</header>

<!-- ========== ãƒ¢ãƒ¼ãƒ‰é¸æŠ ========== -->

<div id="modeScreen">
  <div class="modeTitle">â–¸ ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
  <div class="modeCards">
    <div class="modeCard inbound" id="btnModeInbound">
      <div class="modeCardIcon">ğŸ“¥</div>
      <div class="modeCardLabel">å…¥ã€€åº«</div>
      <div class="modeCardDesc">è£½å“QR â†’ æ£šç•ªQR ã‚’èª­ã‚“ã§ç´ã¥ã‘ç™»éŒ²ã—ã¾ã™</div>
    </div>
    <div class="modeCard outbound" id="btnModeOutbound">
      <div class="modeCardIcon">ğŸ“¤</div>
      <div class="modeCardLabel">å‡ºã€€åº«</div>
      <div class="modeCardDesc">å“ç•ªã‚’å…¥åŠ› â†’ å…¥åº«æ—¥ãŒå¤ã„é †ã«æ£šç•ªã‚’è¡¨ç¤ºã—ã¾ã™</div>
    </div>
    <div class="modeCard history" id="btnModeHistory">
      <div class="modeCardIcon">ğŸ“‹</div>
      <div class="modeCardLabel">å…¥åº«å±¥æ­´</div>
      <div class="modeCardDesc">ç›´è¿‘ã®å…¥åº«ãƒ»ç©ºãç™»éŒ²ã®å±¥æ­´ã‚’ä¸€è¦§è¡¨ç¤ºã—ã¾ã™</div>
    </div>
    <div class="modeCard shelfmaster" id="btnModeShelfMaster">
      <div class="modeCardIcon">ğŸ·ï¸</div>
      <div class="modeCardLabel">æ£šç•ªç™»éŒ²</div>
      <div class="modeCardDesc">ç®¡ç†ã™ã‚‹æ£šç•ªã‚’è¿½åŠ ãƒ»å‰Šé™¤ã—ã¾ã™</div>
    </div>
    <div class="modeCard empty" id="btnModeEmpty">
      <div class="modeCardIcon">ğŸ—‘</div>
      <div class="modeCardLabel">ç©ºãç™»éŒ²</div>
      <div class="modeCardDesc">æ£šç•ªQRã‚’èª­ã‚“ã§ã€ãã®æ£šã‚’ç©ºãã¨ã—ã¦ç™»éŒ²ã—ã¾ã™</div>
    </div>
  </div>
</div>

<!-- ========== å…¥åº«ç”»é¢ ========== -->

<div id="inboundScreen" class="workScreen">
  <button class="backBtn" id="inboundBack">â—€ æˆ»ã‚‹</button>
  <div class="workTitle" style="color:var(--accent-in)">ğŸ“¥ å…¥åº«ç™»éŒ²</div>

  <div class="successBanner" id="inboundSuccess">
    <div class="successIcon">âœ…</div>
    <div class="successMsg" id="inboundSuccessMsg">ç™»éŒ²å®Œäº†ï¼</div>
    <div class="successSub">æ¬¡ã®è£½å“ã®QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
  </div>

  <div class="stepWrap">
    <!-- Step1: è£½å“QR -->
    <div class="stepRow">
      <div class="stepNum active" id="step1Num">1</div>
      <div class="stepCard active" id="step1Card">
        <div class="stepLabel">STEP 1 â€º è£½å“QRã‚’èª­ã¿è¾¼ã‚€</div>
        <div class="stepValue placeholder" id="step1Value">QRã‚’ã‚¹ã‚­ãƒ£ãƒ³...</div>
        <div class="stepHint" id="step1Hint">
          <span>â—‰</span><span>ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã§è£½å“QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</span>
        </div>
      </div>
    </div>

```
<!-- Step2: æ£šç•ªQR or ãƒœã‚¿ãƒ³é¸æŠ -->
<div class="stepRow">
  <div class="stepNum waiting" id="step2Num">2</div>
  <div class="stepCard" id="step2Card">
    <div class="stepLabel">STEP 2 â€º æ£šç•ªã‚’é¸æŠã¾ãŸã¯QRã‚¹ã‚­ãƒ£ãƒ³</div>
    <div class="stepValue placeholder" id="step2Value">è£½å“QRèª­è¾¼å¾Œ...</div>
    <div class="stepHint hidden" id="step2Hint">
      <span>â—‰</span><span>æ£šç•ªQRã‚’ã‚¹ã‚­ãƒ£ãƒ³ã€ã¾ãŸã¯ãƒœã‚¿ãƒ³ã§é¸æŠ</span>
    </div>
    <!-- æ£šç•ªãƒœã‚¿ãƒ³é¸æŠ -->
    <div class="shelfBtnSection" id="shelfBtnSection" style="display:none;">
      <div class="shelfBtnLabel">â–¸ æ£šç•ªã‚’é¸æŠ</div>
      <div class="shelfBtnGrid" id="shelfBtnGrid">
        <div class="shelfSelBtnEmpty">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>
</div>
```

  </div>
</div>

<!-- ========== å‡ºåº«ç”»é¢ ========== -->

<div id="outboundScreen" class="workScreen">
  <button class="backBtn" id="outboundBack">â—€ æˆ»ã‚‹</button>
  <div class="workTitle" style="color:var(--accent-out)">ğŸ“¤ å‡ºåº«ç¢ºèª</div>

  <div class="searchWrap">
    <!-- å…¥åº«æ¸ˆã¿å“ç•ªãƒœã‚¿ãƒ³ç¾¤ -->
    <div class="productBtnSection">
      <div class="productBtnLabel">å…¥åº«æ¸ˆã¿å“ç•ª â€º ã‚¿ãƒƒãƒ—ã§æ¤œç´¢</div>
      <div class="productBtnGrid" id="productBtnGrid">
        <div class="productBtnEmpty">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>

```
<!-- ã‚­ãƒ¼å…¥åŠ› -->
<div class="searchLabel">ã¾ãŸã¯ç›´æ¥å…¥åŠ›</div>
<div class="searchInputRow">
  <input type="text" id="outboundSearchInput" class="searchInput"
    placeholder="ä¾‹: SK012" maxlength="10"
    autocomplete="off" autocapitalize="characters" />
  <button class="searchBtn" id="outboundSearchBtn">ğŸ”</button>
</div>

<!-- ã‚¿ãƒ– -->
<div class="tabRow">
  <div class="tab active" id="tabSearch" data-tab="search">æ¤œç´¢çµæœ</div>
  <div class="tab" id="tabAll" data-tab="all">å…¨æ£šãƒªã‚¹ãƒˆ</div>
</div>

<!-- æ¤œç´¢çµæœã‚¿ãƒ– -->
<div id="tabContentSearch">
  <div class="resultHeader">
    <div class="resultCount">
      <span class="resultCountNum" id="resultCount">-</span> ä»¶
    </div>
    <div style="font-size:11px;color:var(--muted);">â˜… å…ˆå…¥å…ˆå‡ºã—é †</div>
  </div>
  <div id="searchResults">
    <div class="noResult">
      <div class="noResultIcon">ğŸ”</div>
      å“ç•ªã‚’é¸æŠã¾ãŸã¯å…¥åŠ›ã—ã¦ãã ã•ã„
    </div>
  </div>
</div>

<!-- å…¨æ£šãƒªã‚¹ãƒˆã‚¿ãƒ– -->
<div id="tabContentAll" style="display:none;">
  <div id="allShelvesList">
    <div class="noResult">
      <div class="noResultIcon">ğŸ“¦</div>
      èª­ã¿è¾¼ã¿ä¸­...
    </div>
  </div>
</div>
```

  </div>
</div>

<!-- ========== æ£šç•ªç™»éŒ²ç”»é¢ ========== -->

<div id="shelfMasterScreen" class="workScreen">
  <button class="backBtn" id="shelfMasterBack">â—€ æˆ»ã‚‹</button>
  <div class="workTitle" style="color:#f59e0b">ğŸ·ï¸ æ£šç•ªç™»éŒ²</div>
  <div class="shelfMasterWrap">
    <div class="shelfMasterHint">
      ç®¡ç†ã—ãŸã„æ£šç•ªã‚’ç™»éŒ²ã—ã¾ã™ã€‚ç™»éŒ²ã—ãŸæ£šç•ªã¯å…¥åº«æ™‚ã®ãƒœã‚¿ãƒ³é¸æŠã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
      æ£šç•ªQRã‚’ã‚¹ã‚­ãƒ£ãƒ³ã€ã¾ãŸã¯ç›´æ¥å…¥åŠ›ã—ã¦è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
    </div>
    <div class="shelfMasterInput">
      <input type="text" id="shelfMasterInput" class="shelfMasterTextInput"
        placeholder="ä¾‹: A-01" autocomplete="off" autocapitalize="characters" />
      <button class="shelfMasterAddBtn" id="shelfMasterAddBtn">ï¼‹</button>
    </div>
    <div id="shelfMasterList">
      <div class="noResult"><div class="noResultIcon">â³</div>èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  </div>
</div>

<!-- ========== å…¥åº«å±¥æ­´ç”»é¢ ========== -->

<div id="historyScreen" class="workScreen">
  <button class="backBtn" id="historyBack">â—€ æˆ»ã‚‹</button>
  <div class="workTitle" style="color:var(--accent-blue)">ğŸ“‹ å…¥åº«å±¥æ­´</div>
  <div class="historyWrap">
    <div id="historyList">
      <div class="noResult"><div class="noResultIcon">â³</div>èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  </div>
</div>

<!-- ========== ç©ºãç™»éŒ²ç”»é¢ ========== -->

<div id="emptyScreen" class="workScreen">
  <button class="backBtn" id="emptyBack">â—€ æˆ»ã‚‹</button>
  <div class="workTitle" style="color:var(--accent-empty)">ğŸ—‘ ç©ºãç™»éŒ²</div>

  <div class="emptyWrap">
    <div class="emptyHint">
      ç©ºã«ãªã£ãŸæ£šã®æ£šç•ªQRã‚’èª­ã¿è¾¼ã‚€ã¨ã€ãã®æ£šã‚’ã€Œç©ºãã€ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã€‚<br>
      â€» æ—¢å­˜ã®åœ¨åº«æƒ…å ±ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚
    </div>

```
<div class="emptySuccessBanner" id="emptySuccess">
  <div class="successIcon">ğŸ—‘</div>
  <div id="emptySuccessMsg" style="font-weight:900;color:var(--accent-empty);font-size:16px;margin-bottom:4px;"></div>
  <div style="font-size:12px;color:var(--muted);">ç©ºãç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ</div>
</div>

<div class="emptyTarget" id="emptyTarget">
  <div class="emptyTargetLabel">SHELF â€º æ£šç•ªQRã‚’ã‚¹ã‚­ãƒ£ãƒ³</div>
  <div class="emptyTargetValue placeholder" id="emptyTargetValue">QRã‚’ã‚¹ã‚­ãƒ£ãƒ³...</div>
</div>
```

  </div>
</div>

<!-- ãƒˆãƒ¼ã‚¹ãƒˆ -->

<div class="toast" id="toast"></div>

<script>
/* ================== è¨­å®š ================== */
const CUT_LENGTH = 5;
const MIN_QR_LENGTH = 6;
const SHELF_COLLECTION = "shelfInventory";

/* ================== çŠ¶æ…‹ ================== */
let currentMode = null;    // 'inbound' | 'outbound' | 'empty'
let inboundStep = 1;       // 1=è£½å“å¾…ã¡ / 2=æ£šç•ªå¾…ã¡
let inboundProduct = null; // åˆ‡ã‚Šå‡ºã—å¾Œã®å“ç•ª
let inboundProductRaw = null;
let emptyTargetShelf = null;

/* ================== QRå…±é€š ================== */
function normalizeSeiriNo(s){ return String(s||"").trim().replace(/\s+/g,""); }
function cutQR(qr){
  const cleaned = String(qr || "").replace(/^[\s:&;]+/, '');
  const match = cleaned.match(/^[^\s]+/);
  if (!match) return '';
  return match[0].substr(0, CUT_LENGTH);
}

/* ================== Utils ================== */
function nowString(){
  const d=new Date(); const pad=n=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function formatDate(iso){
  if(!iso) return "-";
  const d = new Date(iso);
  const pad=n=>String(n).padStart(2,"0");
  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function daysAgo(iso){
  if(!iso) return null;
  const diff = Date.now() - new Date(iso).getTime();
  return Math.floor(diff / (1000*60*60*24));
}

/* ãƒˆãƒ¼ã‚¹ãƒˆ */
let toastTimer = null;
function showToast(msg, type=''){
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `toast show ${type}`;
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ el.classList.remove('show'); }, 2500);
}

/* ================== ã‚¹ã‚­ãƒ£ãƒŠãƒ¼å…¥åŠ› ================== */
let buffer = "";
let idleTimer = null;
const IDLE_MS = 150;

function clearBuffer(){
  buffer = "";
  if(idleTimer){ clearTimeout(idleTimer); idleTimer = null; }
}

function flushBuffer(){
  if(!buffer) return;
  const qr = buffer.replace(/\r/g,"").split("\n").map(s=>s.trim()).filter(Boolean).slice(-1)[0] || "";
  clearBuffer();
  if(qr) processQR(qr);
}

function isModalOpen(){ return false; }

function ensureFocus(){
  const $input = document.getElementById("scanInput");
  if(document.activeElement !== $input) $input.focus();
}

document.addEventListener("keydown", (e)=>{
  // å‡ºåº«æ¤œç´¢ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹å ´åˆã¯é€šã™
  if(document.activeElement === document.getElementById('outboundSearchInput')) return;

  e.preventDefault();
  const k = e.key;
  if(k==="Enter" || k==="Tab" || k==="\n" || k==="\r"){ flushBuffer(); return; }
  if(k.length===1){
    buffer += k;
    if(idleTimer) clearTimeout(idleTimer);
    idleTimer = setTimeout(()=>flushBuffer(), IDLE_MS);
  }else if(k==="Backspace"){
    buffer = buffer.slice(0,-1);
  }
},{ passive:false });

setInterval(()=>ensureFocus(), 1000);
window.addEventListener("load", ()=>setTimeout(ensureFocus, 500));

/* ================== QRå‡¦ç†ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼‰ ================== */
function processQR(qrRaw){
  if(!qrRaw) return;

  const isShelfQR = (currentMode === 'empty') ||
                    (currentMode === 'inbound' && inboundStep === 2);

  // æ£šç•ªQRã¯é•·ã•ãƒã‚§ãƒƒã‚¯ãªã—ã€è£½å“QRã®ã¿æœ€å°é•·ãƒã‚§ãƒƒã‚¯
  if(!isShelfQR && String(qrRaw).length < MIN_QR_LENGTH) return;

  const sliced = cutQR(qrRaw);

  if(currentMode === 'inbound') processInboundQR(sliced, qrRaw);
  // outboundã¯QRã‚¹ã‚­ãƒ£ãƒ³ä¸ä½¿ç”¨
  else if(currentMode === 'empty') processEmptyQR(qrRaw);
  else if(currentMode === 'shelfmaster') {
    // æ£šç•ªç™»éŒ²ç”»é¢ã§ã®QRã‚¹ã‚­ãƒ£ãƒ³â†’æ£šç•ªã¨ã—ã¦ç™»éŒ²
    document.getElementById('shelfMasterInput').value = qrRaw;
    showToast(`æ£šç•ª ${qrRaw} ã‚’æ¤œå‡º`, '');
  } // æ£šç•ªã¯rawã‚’ãã®ã¾ã¾ä½¿ç”¨
}

/* ================== å…¥åº«ãƒ¢ãƒ¼ãƒ‰ ================== */
function processInboundQR(sliced, raw){
  if(inboundStep === 1){
    // è£½å“QRå—ä»˜
    inboundProduct = sliced;
    inboundProductRaw = raw;
    document.getElementById('step1Value').textContent = sliced;
    document.getElementById('step1Value').classList.remove('placeholder');
    document.getElementById('step1Hint').classList.add('hidden');

    // Step1å®Œäº† â†’ Step2ã¸
    document.getElementById('step1Num').className = 'stepNum done';
    document.getElementById('step1Num').textContent = 'âœ“';
    document.getElementById('step1Card').className = 'stepCard done';
    document.getElementById('step2Num').className = 'stepNum active';
    document.getElementById('step2Card').className = 'stepCard active';
    document.getElementById('step2Value').textContent = 'QRã‚’ã‚¹ã‚­ãƒ£ãƒ³...';
    document.getElementById('step2Value').classList.add('placeholder');
    document.getElementById('step2Hint').classList.remove('hidden');

    inboundStep = 2;
    showToast(`å“ç•ª: ${sliced} ã‚’ç¢ºèª`, '');
    // æ£šç•ªãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    loadShelfButtons();

  } else if(inboundStep === 2){
    // æ£šç•ªQRå—ä»˜ï¼ˆåˆ‡ã‚Šå‡ºã—ãªã—ãƒ»rawã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼‰
    const shelfId = raw;
    saveInbound(inboundProduct, inboundProductRaw, shelfId);
  }
}

async function saveInbound(productId, productQRRaw, shelfId){
  const now = new Date().toISOString();
  const data = {
    shelfId,
    productId,
    productQRRaw,
    inboundAt: now,
    inboundAtMs: Date.now(),
    status: 'occupied',
    updatedAt: now
  };

  try{
    if(window.__saveShelfItem){
      await window.__saveShelfItem(shelfId, data);
    }

    // æˆåŠŸè¡¨ç¤º
    document.getElementById('step2Value').textContent = shelfId;
    document.getElementById('step2Value').classList.remove('placeholder');
    document.getElementById('step2Hint').classList.add('hidden');
    document.getElementById('step2Num').className = 'stepNum done';
    document.getElementById('step2Num').textContent = 'âœ“';
    document.getElementById('step2Card').className = 'stepCard done';

    const banner = document.getElementById('inboundSuccess');
    document.getElementById('inboundSuccessMsg').textContent = `${productId} â†’ æ£š ${shelfId} ã«ç™»éŒ²ã—ã¾ã—ãŸ`;
    banner.classList.add('show');

    showToast(`âœ… ${productId} â†’ æ£š ${shelfId}`, 'ok');
    // å±¥æ­´ã«è¨˜éŒ²
    if(window.__addHistory){
      window.__addHistory({ type:'inbound', shelfId, productId, productQRRaw, at: now, atMs: Date.now() }).catch(()=>{});
    }

    // 2ç§’å¾Œã«æ¬¡ã®å…¥åº«ã¸ãƒªã‚»ãƒƒãƒˆ
    setTimeout(()=>resetInbound(), 2500);

  }catch(e){
    console.error(e);
    showToast('ä¿å­˜ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
  }
}

function resetInbound(){
  inboundStep = 1;
  inboundProduct = null;
  inboundProductRaw = null;

  document.getElementById('inboundSuccess').classList.remove('show');

  document.getElementById('step1Num').className = 'stepNum active';
  document.getElementById('step1Num').textContent = '1';
  document.getElementById('step1Card').className = 'stepCard active';
  document.getElementById('step1Value').textContent = 'QRã‚’ã‚¹ã‚­ãƒ£ãƒ³...';
  document.getElementById('step1Value').classList.add('placeholder');
  document.getElementById('step1Hint').classList.remove('hidden');

  document.getElementById('step2Num').className = 'stepNum waiting';
  document.getElementById('step2Num').textContent = '2';
  document.getElementById('step2Card').className = 'stepCard';
  document.getElementById('step2Value').textContent = 'è£½å“QRèª­è¾¼å¾Œ...';
  document.getElementById('step2Value').classList.add('placeholder');
  document.getElementById('step2Hint').classList.add('hidden');
}

/* ================== å‡ºåº«ãƒ¢ãƒ¼ãƒ‰ ================== */
/* å“ç•ªãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆï¼ˆå…¥åº«æ¸ˆã¿å“ç•ªã‚’å–å¾—ã—ã¦è¡¨ç¤ºï¼‰ */
async function loadProductButtons(){
  const grid = document.getElementById('productBtnGrid');
  grid.innerHTML = '<div class="productBtnEmpty">èª­ã¿è¾¼ã¿ä¸­...</div>';
  try{
    let items = [];
    if(window.__getAllShelves) items = await window.__getAllShelves();
    // occupied ãªå“ç•ªã ã‘æŠ½å‡ºãƒ»é‡è¤‡é™¤å»ãƒ»ã‚½ãƒ¼ãƒˆ
    const products = [...new Set(
      items
        .filter(i=>i.status==='occupied' && i.productId)
        .map(i=>i.productId)
    )].sort();

    if(products.length === 0){
      grid.innerHTML = '<div class="productBtnEmpty">å…¥åº«æ¸ˆã¿å“ç•ªãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }
    grid.innerHTML = products.map(p=>`
      <button class="productBtn" data-product="${p}">${p}</button>
    `).join('');
    grid.querySelectorAll('.productBtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        // é¸æŠçŠ¶æ…‹ã®è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        grid.querySelectorAll('.productBtn').forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected');
        const id = btn.getAttribute('data-product');
        document.getElementById('outboundSearchInput').value = id;
        searchProduct(id);
      });
    });
  }catch(e){
    grid.innerHTML = '<div class="productBtnEmpty">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
  }
}

async function searchProduct(productId){
  const id = String(productId||"").trim().toUpperCase();
  if(!id){ showToast('å“ç•ªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }

  document.getElementById('searchResults').innerHTML = `
    <div class="noResult"><div class="noResultIcon">â³</div>æ¤œç´¢ä¸­...</div>`;
  document.getElementById('resultCount').textContent = '-';

  try{
    let items = [];
    if(window.__queryShelfByProduct){
      items = await window.__queryShelfByProduct(id);
    }

    // å…¥åº«æ—¥æ™‚ã§ã‚½ãƒ¼ãƒˆï¼ˆå¤ã„é †ï¼‰
    items.sort((a,b)=> (a.inboundAtMs||0) - (b.inboundAtMs||0));

    document.getElementById('resultCount').textContent = items.length;

    if(items.length === 0){
      document.getElementById('searchResults').innerHTML = `
        <div class="noResult">
          <div class="noResultIcon">âŒ</div>
          ã€Œ${id}ã€ã®åœ¨åº«ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
        </div>`;
      return;
    }

    const html = items.map((item, i)=>{
      const days = daysAgo(item.inboundAt);
      const ageClass = days === null ? 'fresh' : days >= 7 ? 'oldest' : days >= 3 ? 'old' : 'fresh';
      const ageText = days === null ? '-' : days === 0 ? 'ä»Šæ—¥' : `${days}æ—¥å‰`;
      return `
        <div class="shelfCard" id="shelfCard_${esc(item.shelfId)}">
          <div class="shelfRank ${i===0?'first':''}">
            ${i===0 ? 'â­' : i+1}
          </div>
          <div class="shelfInfo">
            <div class="shelfId">${esc(item.shelfId)}</div>
            <div class="shelfDate">å…¥åº«: ${formatDate(item.inboundAt)}</div>
          </div>
          <div class="shelfAge ${ageClass}">${ageText}</div>
          <button class="shelfOutBtn" data-shelf="${esc(item.shelfId)}" data-product="${esc(item.productId||'')}">
            å‡ºåº«
          </button>
        </div>`;
    }).join('');

    document.getElementById('searchResults').innerHTML = html;

    // æ£šã”ã¨ã®å‡ºåº«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    document.querySelectorAll('#searchResults .shelfOutBtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const shelfId = btn.getAttribute('data-shelf');
        const productId = btn.getAttribute('data-product');
        registerOneEmpty(shelfId, productId, btn, id);
      });
    });

  }catch(e){
    console.error(e);
    document.getElementById('searchResults').innerHTML = `
      <div class="noResult">
        <div class="noResultIcon">âš ï¸</div>
        æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ${e.message}
      </div>`;
  }
}

/* ================== æ£š1ä»¶ã®å‡ºåº«å‡¦ç† ================== */
async function registerOneEmpty(shelfId, productId, btnEl, currentSearchId){
  if(!shelfId) return;
  if(btnEl){ btnEl.disabled = true; btnEl.textContent = 'å‡¦ç†ä¸­...'; }

  const now = new Date().toISOString();
  try{
    if(window.__saveShelfItem){
      await window.__saveShelfItem(shelfId, {
        shelfId,
        productId: null,
        productQRRaw: null,
        inboundAt: null,
        inboundAtMs: null,
        status: 'empty',
        updatedAt: now
      });
    }
    if(window.__addHistory){
      window.__addHistory({
        type: 'empty',
        shelfId,
        productId,
        at: now,
        atMs: Date.now()
      }).catch(()=>{});
    }
    // ã‚«ãƒ¼ãƒ‰ã‚’è¦–è¦šçš„ã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
    const card = document.getElementById(`shelfCard_${shelfId}`);
    if(card){ card.style.transition='opacity 0.4s'; card.style.opacity='0.25'; }
    showToast(`ğŸ—‘ æ£š ${shelfId} ã‚’ç©ºãç™»éŒ²`, 'ok');
    // 1ç§’å¾Œã«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
    setTimeout(()=>{
      loadProductButtons();
      if(currentSearchId) searchProduct(currentSearchId);
    }, 1000);
  }catch(e){
    console.error(e);
    if(btnEl){ btnEl.disabled = false; btnEl.textContent = 'å‡ºåº«'; }
    showToast('ç™»éŒ²ã‚¨ãƒ©ãƒ¼', 'error');
  }
}

/* ================== ç©ºãç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ ================== */
async function processEmptyQR(raw){
  // æ£šç•ªQRèª­ã¿å–ã‚Š â†’ å³æ™‚ç©ºãç™»éŒ²ï¼ˆç¢ºèªä¸è¦ï¼‰
  const target = document.getElementById('emptyTarget');
  target.classList.add('active');
  document.getElementById('emptyTargetValue').textContent = raw;
  document.getElementById('emptyTargetValue').classList.remove('placeholder');
  document.getElementById('emptySuccess').classList.remove('show');

  const now = new Date().toISOString();
  try{
    if(window.__saveShelfItem){
      await window.__saveShelfItem(raw, {
        shelfId: raw,
        productId: null,
        productQRRaw: null,
        inboundAt: null,
        inboundAtMs: null,
        status: 'empty',
        updatedAt: now
      });
    }
    // å±¥æ­´ã«ã‚‚è¨˜éŒ²
    if(window.__addHistory){
      window.__addHistory({ type:'empty', shelfId: raw, productId: null, at: now, atMs: Date.now() }).catch(()=>{});
    }

    const banner = document.getElementById('emptySuccess');
    document.getElementById('emptySuccessMsg').textContent = `æ£š ${raw} ã‚’ç©ºãã¨ã—ã¦ç™»éŒ²ã—ã¾ã—ãŸ`;
    banner.classList.add('show');
    showToast(`ğŸ—‘ æ£š ${raw} ã‚’ç©ºãç™»éŒ²`, 'ok');

    // 2ç§’å¾Œã«ãƒªã‚»ãƒƒãƒˆ
    setTimeout(()=>{
      emptyTargetShelf = null;
      target.classList.remove('active');
      document.getElementById('emptyTargetValue').textContent = 'QRã‚’ã‚¹ã‚­ãƒ£ãƒ³...';
      document.getElementById('emptyTargetValue').classList.add('placeholder');
      banner.classList.remove('show');
    }, 2000);

  }catch(e){
    console.error(e);
    showToast('ç™»éŒ²ã‚¨ãƒ©ãƒ¼', 'error');
  }
}

/* ================== å…¨æ£šãƒªã‚¹ãƒˆ ================== */
async function loadAllShelves(){
  document.getElementById('allShelvesList').innerHTML = `
    <div class="noResult"><div class="noResultIcon">â³</div>èª­ã¿è¾¼ã¿ä¸­...</div>`;
  try{
    let items = [];
    if(window.__getAllShelves) items = await window.__getAllShelves();
    items.sort((a,b)=> String(a.shelfId||"").localeCompare(String(b.shelfId||"")));

    if(items.length === 0){
      document.getElementById('allShelvesList').innerHTML = `
        <div class="noResult"><div class="noResultIcon">ğŸ“¦</div>ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ãªã—</div>`;
      return;
    }

    const html = `<div class="allShelvesGrid">${items.map(item=>`
      <div class="allShelfRow" id="allRow_${esc(item.shelfId)}">
        <div style="flex:1;min-width:0;">
          <div class="allShelfId">${esc(item.shelfId)}</div>
          <div class="allShelfMeta">${item.status==='occupied' ? formatDate(item.inboundAt) : 'ç©ºã'}</div>
        </div>
        <div class="allShelfProduct ${item.status}">
          ${item.status==='occupied' ? esc(item.productId||'-') : 'ç©ºã'}
        </div>
        <button class="shelfDeleteBtn" data-shelf="${esc(item.shelfId)}">ğŸ—‘</button>
      </div>`).join('')}</div>`;

    document.getElementById('allShelvesList').innerHTML = html;

    // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    document.querySelectorAll('#allShelvesList .shelfDeleteBtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const shelfId = btn.getAttribute('data-shelf');
        deleteShelf(shelfId);
      });
    });
  }catch(e){
    document.getElementById('allShelvesList').innerHTML = `
      <div class="noResult"><div class="noResultIcon">âš ï¸</div>èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>`;
  }
}


/* ================== æ£šç•ªãƒœã‚¿ãƒ³ï¼ˆå…¥åº«Step2ï¼‰ ================== */
async function loadShelfButtons(){
  const section = document.getElementById('shelfBtnSection');
  const grid = document.getElementById('shelfBtnGrid');
  section.style.display = 'block';
  grid.innerHTML = '<div class="shelfSelBtnEmpty">èª­ã¿è¾¼ã¿ä¸­...</div>';
  try{
    let shelves = [];
    if(window.__getAllShelfMasters) shelves = await window.__getAllShelfMasters();
    shelves.sort((a,b)=>String(a.shelfId||'').localeCompare(String(b.shelfId||'')));
    if(shelves.length === 0){
      grid.innerHTML = '<div class="shelfSelBtnEmpty">æ£šç•ªãŒæœªç™»éŒ²ã§ã™ï¼ˆæ£šç•ªç™»éŒ²ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ï¼‰</div>';
      return;
    }
    grid.innerHTML = shelves.map(s=>`
      <button class="shelfSelBtn" data-shelf="${esc(s.shelfId)}">${esc(s.shelfId)}</button>
    `).join('');
    grid.querySelectorAll('.shelfSelBtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if(inboundStep !== 2) return;
        grid.querySelectorAll('.shelfSelBtn').forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected');
        const shelfId = btn.getAttribute('data-shelf');
        saveInbound(inboundProduct, inboundProductRaw, shelfId);
      });
    });
  }catch(e){
    grid.innerHTML = '<div class="shelfSelBtnEmpty">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
  }
}

/* ================== æ£šç•ªç™»éŒ²ãƒã‚¹ã‚¿ãƒ¼ ================== */
async function loadShelfMasterList(){
  const list = document.getElementById('shelfMasterList');
  list.innerHTML = '<div class="noResult"><div class="noResultIcon">â³</div>èª­ã¿è¾¼ã¿ä¸­...</div>';
  try{
    let shelves = [];
    if(window.__getAllShelfMasters) shelves = await window.__getAllShelfMasters();
    // åœ¨åº«çŠ¶æ³ã‚‚å–å¾—ã—ã¦ãƒãƒ¼ã‚¸
    let inventory = [];
    if(window.__getAllShelves) inventory = await window.__getAllShelves();
    const invMap = {};
    inventory.forEach(i=>{ invMap[i.shelfId] = i; });

    shelves.sort((a,b)=>String(a.shelfId||'').localeCompare(String(b.shelfId||'')));

    if(shelves.length === 0){
      list.innerHTML = '<div class="noResult"><div class="noResultIcon">ğŸ·ï¸</div>æ£šç•ªãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
      return;
    }
    list.innerHTML = `<div class="shelfMasterList">${shelves.map(s=>{
      const inv = invMap[s.shelfId];
      let statusClass = 'unregistered', statusText = 'åœ¨åº«ãªã—';
      if(inv && inv.status === 'occupied'){
        statusClass = 'occupied'; statusText = inv.productId || '-';
      } else if(inv && inv.status === 'empty'){
        statusClass = 'empty'; statusText = 'ç©ºã';
      }
      return `<div class="shelfMasterRow" id="masterRow_${esc(s.shelfId)}">
        <div class="shelfMasterName">${esc(s.shelfId)}</div>
        <div class="shelfMasterStatus ${statusClass}">${esc(statusText)}</div>
        <button class="shelfDeleteBtn" data-shelf="${esc(s.shelfId)}">ğŸ—‘</button>
      </div>`;
    }).join('')}</div>`;

    list.querySelectorAll('.shelfDeleteBtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const shelfId = btn.getAttribute('data-shelf');
        deleteShelfMaster(shelfId);
      });
    });
  }catch(e){
    list.innerHTML = '<div class="noResult"><div class="noResultIcon">âš ï¸</div>èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
  }
}

async function addShelfMaster(shelfId){
  const id = String(shelfId||'').trim();
  if(!id){ showToast('æ£šç•ªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
  try{
    if(window.__saveShelfMaster) await window.__saveShelfMaster(id);
    document.getElementById('shelfMasterInput').value = '';
    showToast(`âœ… æ£š ${id} ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`, 'ok');
    loadShelfMasterList();
  }catch(e){
    showToast('ç™»éŒ²ã‚¨ãƒ©ãƒ¼', 'error');
  }
}

async function deleteShelfMaster(shelfId){
  if(!confirm(`æ£šã€Œ${shelfId}ã€ã‚’ãƒã‚¹ã‚¿ãƒ¼ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  try{
    if(window.__deleteShelfMaster) await window.__deleteShelfMaster(shelfId);
    const row = document.getElementById(`masterRow_${shelfId}`);
    if(row){ row.style.transition='opacity 0.3s'; row.style.opacity='0'; setTimeout(()=>row.remove(),300); }
    showToast(`ğŸ—‘ æ£š ${shelfId} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'ok');
  }catch(e){
    showToast('å‰Šé™¤ã‚¨ãƒ©ãƒ¼', 'error');
  }
}

/* ================== æ£šå‰Šé™¤ ================== */
async function deleteShelf(shelfId){
  if(!shelfId) return;
  if(!confirm(`æ£šã€Œ${shelfId}ã€ã‚’ãƒªã‚¹ãƒˆã‹ã‚‰å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€» ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“`)) return;
  try{
    if(window.__deleteShelfItem){
      await window.__deleteShelfItem(shelfId);
    }
    // è¡Œã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã—ã¦æ¶ˆã™
    const row = document.getElementById(`allRow_${shelfId}`);
    if(row){
      row.style.transition = 'opacity 0.4s';
      row.style.opacity = '0';
      setTimeout(()=>row.remove(), 400);
    }
    showToast(`ğŸ—‘ æ£š ${shelfId} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'ok');
    // å“ç•ªãƒœã‚¿ãƒ³ã‚‚æ›´æ–°
    loadProductButtons();
  }catch(e){
    console.error(e);
    showToast('å‰Šé™¤ã‚¨ãƒ©ãƒ¼', 'error');
  }
}

/* ================== ç”»é¢åˆ‡æ›¿ ================== */
function showMode(mode){
  document.getElementById('modeScreen').style.display = 'none';
  ['inboundScreen','outboundScreen','emptyScreen','historyScreen','shelfMasterScreen'].forEach(id=>{
    document.getElementById(id).classList.remove('active');
  });
  currentMode = mode;
  resetInbound();
  emptyTargetShelf = null;
  if(mode === 'shelfmaster'){
    document.getElementById('shelfMasterScreen').classList.add('active');
    loadShelfMasterList();
    return;
  }
  if(mode === 'history'){
    document.getElementById('historyScreen').classList.add('active');
    loadHistory();
    return;
  }
  if(mode === 'inbound'){
    document.getElementById('inboundScreen').classList.add('active');
  }else if(mode === 'outbound'){
    document.getElementById('outboundScreen').classList.add('active');
    loadProductButtons();
    loadAllShelves();
    // æ¤œç´¢æ¬„ãƒ»çµæœã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('outboundSearchInput').value = '';
    document.getElementById('searchResults').innerHTML = `<div class="noResult"><div class="noResultIcon">ğŸ”</div>å“ç•ªã‚’é¸æŠã¾ãŸã¯å…¥åŠ›ã—ã¦ãã ã•ã„</div>`;
    document.getElementById('resultCount').textContent = '-';
  }else if(mode === 'empty'){
    document.getElementById('emptyScreen').classList.add('active');
    document.getElementById('emptySuccess').classList.remove('show');
    document.getElementById('emptyTarget').classList.remove('active');
    document.getElementById('emptyTargetValue').textContent = 'QRã‚’ã‚¹ã‚­ãƒ£ãƒ³...';
    document.getElementById('emptyTargetValue').classList.add('placeholder');
    document.getElementById('emptyCurrentItem').style.display='none';
  }
}

function showModeSelect(){
  currentMode = null;
  document.getElementById('modeScreen').style.display = 'block';
  ['inboundScreen','outboundScreen','emptyScreen','historyScreen','shelfMasterScreen'].forEach(id=>{
    document.getElementById(id).classList.remove('active');
  });
}

/* ================== ã‚¤ãƒ™ãƒ³ãƒˆ ================== */
document.getElementById('btnModeInbound').addEventListener('click', ()=>showMode('inbound'));
document.getElementById('btnModeOutbound').addEventListener('click', ()=>showMode('outbound'));
document.getElementById('btnModeHistory').addEventListener('click', ()=>showMode('history'));
document.getElementById('btnModeEmpty').addEventListener('click', ()=>showMode('empty'));
document.getElementById('historyBack').addEventListener('click', showModeSelect);
document.getElementById('btnModeShelfMaster').addEventListener('click', ()=>showMode('shelfmaster'));
document.getElementById('shelfMasterBack').addEventListener('click', showModeSelect);
document.getElementById('shelfMasterAddBtn').addEventListener('click', ()=>{
  const v = document.getElementById('shelfMasterInput').value.trim();
  if(v) addShelfMaster(v);
});
document.getElementById('shelfMasterInput').addEventListener('keydown', (e)=>{
  if(e.key==='Enter'){
    const v = e.target.value.trim();
    if(v) addShelfMaster(v);
  }
});
document.getElementById('inboundBack').addEventListener('click', showModeSelect);
document.getElementById('outboundBack').addEventListener('click', showModeSelect);
document.getElementById('emptyBack').addEventListener('click', showModeSelect);

document.getElementById('outboundSearchBtn').addEventListener('click', ()=>{
  const v = document.getElementById('outboundSearchInput').value.trim().toUpperCase();
  if(v) searchProduct(v);
});

document.getElementById('outboundSearchInput').addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    const v = e.target.value.trim().toUpperCase();
    if(v) searchProduct(v);
  }
});


// ã‚¿ãƒ–åˆ‡æ›¿
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const name = tab.getAttribute('data-tab');
    document.getElementById('tabContentSearch').style.display = name==='search' ? 'block' : 'none';
    document.getElementById('tabContentAll').style.display = name==='all' ? 'block' : 'none';
    if(name === 'all') loadAllShelves();
  });
});

/* ================== å…¥åº«å±¥æ­´ ================== */
async function loadHistory(){
  const list = document.getElementById('historyList');
  list.innerHTML = '<div class="noResult"><div class="noResultIcon">â³</div>èª­ã¿è¾¼ã¿ä¸­...</div>';
  try{
    let items = [];
    if(window.__getHistory) items = await window.__getHistory();
    // æ–°ã—ã„é †
    items.sort((a,b)=>(b.atMs||0)-(a.atMs||0));
    if(items.length === 0){
      list.innerHTML = '<div class="noResult"><div class="noResultIcon">ğŸ“‹</div>å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }
    list.innerHTML = items.map(item=>{
      const icon = item.type === 'inbound' ? 'ğŸ“¥' : 'ğŸ—‘';
      const label = item.type === 'inbound'
        ? `<div class="historyItemProduct">${esc(item.productId||'-')}</div>
           <div class="historyItemShelf">æ£š: ${esc(item.shelfId||'-')}</div>`
        : `<div class="historyItemProduct" style="color:var(--accent-empty)">ç©ºãç™»éŒ²</div>
           <div class="historyItemShelf">æ£š: ${esc(item.shelfId||'-')}</div>`;
      const d = item.at ? new Date(item.at) : null;
      const pad = n=>String(n).padStart(2,'0');
      const dateStr = d ? `${d.getMonth()+1}/${d.getDate()}<br>${pad(d.getHours())}:${pad(d.getMinutes())}` : '-';
      return `<div class="historyItem">
        <div class="historyItemIcon">${icon}</div>
        <div class="historyItemInfo">${label}</div>
        <div class="historyItemDate">${dateStr}</div>
      </div>`;
    }).join('');
  }catch(e){
    list.innerHTML = '<div class="noResult"><div class="noResultIcon">âš ï¸</div>èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
  }
}

/* ================== esc ================== */
function esc(s){ return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
</script>

<!-- ========== Firebase SDK ========== -->

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, collection,
    getDocs, query, where, serverTimestamp, orderBy, limit, addDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAOMRoojKv9Hnh3OjVGwYV_k1LBTGOKepY",
    authDomain: "miyamaunitec-fb87a.firebaseapp.com",
    projectId: "miyamaunitec-fb87a",
    storageBucket: "miyamaunitec-fb87a.firebasestorage.app",
    messagingSenderId: "495316649507",
    appId: "1:495316649507:web:1f98ee3dd851474fa39396"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const statusEl = document.getElementById("firebaseStatus");
  const setStatus = (t,c)=>{ statusEl.textContent=`Firebase: ${t}`; statusEl.style.color=c; };

  try{
    await signInAnonymously(auth);
    setStatus("æ¥ç¶šæ¸ˆã¿","#00d084");
  }catch(e){
    console.warn("èªè¨¼å¤±æ•—:", e);
    setStatus("æœªæ¥ç¶š","#ff4d6a");
  }

  const COLL = "shelfInventory";

  /* æ£šãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆupsertï¼‰ */
  window.__saveShelfItem = async (shelfId, data) => {
    const ref = doc(db, COLL, String(shelfId));
    await setDoc(ref, {
      ...data,
      savedAt: serverTimestamp()
    }, { merge: false });
  };

  /* æ£šãƒ‡ãƒ¼ã‚¿ã‚’1ä»¶å–å¾— */
  window.__getShelfItem = async (shelfId) => {
    const snap = await getDoc(doc(db, COLL, String(shelfId)));
    return snap.exists() ? snap.data() : null;
  };

  /* å“ç•ªã§æ£šã‚’æ¤œç´¢ï¼ˆoccupied ã®ã¿ï¼‰ */
  window.__queryShelfByProduct = async (productId) => {
    const q = query(
      collection(db, COLL),
      where("productId", "==", productId),
      where("status", "==", "occupied")
    );
    const snap = await getDocs(q);
    return snap.docs.map(d => d.data());
  };

  /* å…¨æ£šãƒªã‚¹ãƒˆå–å¾— */
  window.__getAllShelves = async () => {
    const snap = await getDocs(collection(db, COLL));
    return snap.docs.map(d => d.data());
  };

  /* æ£šç•ªãƒã‚¹ã‚¿ãƒ¼ï¼šå…¨ä»¶å–å¾— */
  window.__getAllShelfMasters = async () => {
    const snap = await getDocs(collection(db, "shelfMaster"));
    return snap.docs.map(d => d.data());
  };

  /* æ£šç•ªãƒã‚¹ã‚¿ãƒ¼ï¼šè¿½åŠ  */
  window.__saveShelfMaster = async (shelfId) => {
    await setDoc(doc(db, "shelfMaster", String(shelfId)), {
      shelfId: String(shelfId),
      createdAt: serverTimestamp()
    });
  };

  /* æ£šç•ªãƒã‚¹ã‚¿ãƒ¼ï¼šå‰Šé™¤ */
  window.__deleteShelfMaster = async (shelfId) => {
    const { deleteDoc } = await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js");
    await deleteDoc(doc(db, "shelfMaster", String(shelfId)));
  };

  /* æ£šãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ */
  window.__deleteShelfItem = async (shelfId) => {
    const { deleteDoc } = await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js");
    await deleteDoc(doc(db, COLL, String(shelfId)));
  };

  /* å±¥æ­´ã‚’è¿½åŠ  */
  window.__addHistory = async (data) => {
    await addDoc(collection(db, "shelfHistory"), {
      ...data,
      createdAt: serverTimestamp()
    });
  };

  /* å±¥æ­´ã‚’å–å¾—ï¼ˆç›´è¿‘100ä»¶ï¼‰ */
  window.__getHistory = async () => {
    const q = query(
      collection(db, "shelfHistory"),
      orderBy("atMs", "desc"),
      limit(100)
    );
    const snap = await getDocs(q);
    return snap.docs.map(d => d.data());
  };
</script>

</body>
</html>