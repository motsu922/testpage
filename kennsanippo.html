<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>æ¤œæŸ»æ—¥å ±ã‚·ã‚¹ãƒ†ãƒ </title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
<style>
  :root{ --border:#e5e7eb; --muted:#6b7280; --ink:#111827; --brand:#2563eb; --ok:#1a7f37; --ng:#d1242f; }
  *{ box-sizing: border-box; -webkit-tap-highlight-color: rgba(0,0,0,0.1); }
  html{ height:100%; overflow-x:hidden; touch-action: pan-y pinch-zoom; }
  body{ height:100%; margin:0; font-family:system-ui,"Noto Sans JP",sans-serif; background:#f7f8fb; color:var(--ink); overflow-x:hidden; width:100%; position:relative; }
  header{ position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--border); }
  .wrap{ max-width:1400px; margin:0 auto; padding:4px 8px; }
  .bar{ display:flex; align-items:center; justify-content:space-between; gap:6px; flex-wrap:wrap; }
  h1{ font-size:11px; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .tabs{ display:flex; gap:4px; margin-top:4px; flex-wrap:wrap; }
  .tab{ appearance:none; border:1px solid var(--border); background:#fff; padding:6px 10px; border-radius:6px; cursor:pointer; font-weight:700; font-size:12px; min-height:32px; min-width:60px; touch-action:manipulation; }
  .tab[aria-selected="true"]{ background:#111827; color:#fff; border-color:#111827; }
  main.wrap{ padding-top:6px; overflow-x:hidden; }
  .view{ display:none; overflow-x:hidden; }
  .view.active{ display:block; }
  .firebase-status{ font-size:9px; color:#666; padding:3px 6px; background:#f0f0f0; border-radius:4px; }
  .firebase-status.connected{ background:#d4edda; color:#155724; }
  .firebase-status.disconnected{ background:#f8d7da; color:#721c24; }
  
  @media(max-width:768px){
    .wrap{ padding:2px 4px; }
    h1{ font-size:10px; max-width:120px; }
    .tabs{ gap:3px; margin-top:2px; }
    .tab{ padding:4px 8px; font-size:11px; min-height:28px; min-width:50px; border-radius:4px; }
    main.wrap{ padding-top:4px; }
    .firebase-status{ display:none; }
  }
  
  #settings-view .settings-container{ display:grid; grid-template-columns:1fr; gap:20px; }
  #settings-view .settings-card{ background:#fff; border-radius:12px; padding:20px; border:2px solid var(--border); }
  #settings-view .settings-card h2{ margin-bottom:20px; color:#2c3e50; font-size:20px; }
  #settings-view .form-group{ margin-bottom:15px; }
  #settings-view .form-label{ display:block; font-weight:600; margin-bottom:6px; color:#2c3e50; font-size:14px; }
  #settings-view .form-input{ width:100%; padding:12px; border:2px solid #e9ecef; border-radius:8px; font-size:16px; background:#f8f9fa; min-height:44px; }
  #settings-view .form-textarea{ min-height:150px; resize:vertical; font-family:'Courier New',monospace; }
  #settings-view .btn{ padding:12px 18px; border:none; border-radius:8px; font-size:15px; font-weight:600; cursor:pointer; margin:3px; min-height:44px; touch-action:manipulation; }
  #settings-view .btn-primary{ background:linear-gradient(135deg,#4a90e2,#357abd); color:#fff; }
  #settings-view .btn-success{ background:linear-gradient(135deg,#27ae60,#229954); color:#fff; }
  #settings-view .btn-danger{ background:linear-gradient(135deg,#e74c3c,#c0392b); color:#fff; }
  #settings-view .item-list{ max-height:400px; overflow-y:auto; border:2px solid #e9ecef; border-radius:8px; background:#f8f9fa; }
  #settings-view .item{ padding:14px; border-bottom:1px solid #e9ecef; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; }
  #settings-view .item:hover{ background:#e3f2fd; }
  #settings-view .item-name{ font-weight:600; color:#2c3e50; font-size:15px; }
  #settings-view .item-details{ font-size:13px; color:#6c757d; margin-top:4px; width:100%; }
  #settings-view .ng-tag{ display:inline-block; background:#e3f2fd; color:#1976d2; padding:4px 8px; border-radius:4px; margin:2px 4px 2px 0; font-size:12px; }
  #settings-view .alert{ padding:14px; border-radius:8px; margin-bottom:15px; font-size:15px; }
  #settings-view .alert-success{ background:#d4edda; border:1px solid #c3e6cb; color:#155724; }
  #settings-view .alert-error{ background:#f8d7da; border:1px solid #f5c6cb; color:#721c24; }
  
  #qr-view .qr-card{ background:#fff; border:1px solid var(--border); border-radius:14px; padding:16px; margin-bottom:18px; }
  #qr-view .qr-bigLabel{ font-size:18px; font-weight:700; margin-bottom:8px; }
  #qr-view .qr-grid{ display:grid; grid-template-columns:1fr; gap:16px; }
  #qr-view .qr-baseBox{ border:2px dashed #cbd5e1; border-radius:16px; background:#fbfdff; padding:20px; text-align:center; display:flex; flex-direction:column; justify-content:center; min-height:160px; }
  #qr-view .qr-baseHeading{ font-size:16px; color:#0f172a; margin-bottom:6px; }
  #qr-view .qr-baseValue{ font-weight:800; font-size:clamp(50px,15vw,100px); color:#0b3b75; word-break:break-all; }
  #qr-view .qr-placeholder{ color:#94a3b8; }
  #qr-view .qr-imgBox{ border:2px dashed #e5e7eb; border-radius:16px; background:#fff; padding:10px; display:flex; align-items:center; justify-content:center; min-height:220px; }
  #qr-view #qr-productImage{ max-width:100%; max-height:320px; object-fit:contain; display:none; }
  #qr-view .qr-imgHint{ color:#9ca3af; font-size:14px; text-align:center; }
  #qr-view .qr-resultArea{ text-align:center; padding:16px 10px 0; }
  #qr-view .qr-resultMark{ font-size:clamp(120px,30vw,200px); line-height:1; display:none; }
  #qr-view .qr-ok{ color: var(--ok); }
  #qr-view .qr-ng{ color: var(--ng); }
  #qr-view .qr-lock{ display:none; margin-top:10px; color: var(--ng); font-weight:700; font-size:16px; }
  #qr-view .qr-btn{ padding:14px 18px; border-radius:12px; border:1px solid #d1d5db; background:#fff; cursor:pointer; font-size:15px; margin:5px; min-height:44px; touch-action:manipulation; }
  #qr-view .qr-btn.warn{ background:#fef3f2; color:#b42318; border-color:#fecdcf; }
  #qr-view .qr-btn.brand{ background:#2563eb; color:#fff; border-color:#2563eb; }
  #qr-view .qr-status{ font-size:15px; color:var(--muted); margin-top:12px; }
  #qr-view .qr-small{ font-size:13px; color:#6b7280; }
  #qr-view input[type="file"]{ display:none; }
  #qr-view .qr-markRow{ display:flex; gap:8px; align-items:stretch; flex-wrap:wrap; margin-top:8px; }
  #qr-view .qr-markRow input[type="text"]{ flex:1 1 100%; min-width:200px; padding:12px; border:1px solid #d1d5db; border-radius:10px; font-size:15px; background:#fff; min-height:44px; }
  #qr-view .qr-lastBox{ font-size:12px; color:#6b7280; margin-top:6px; word-break:break-all; }
  #qr-view .qr-lastBox code{ background:#f3f4f6; padding:3px 7px; border-radius:6px; }
  #qr-view .qr-toast{ position:fixed; right:16px; bottom:16px; background:#111827; color:#fff; padding:12px 16px; border-radius:10px; font-size:14px; opacity:.96; display:none; z-index:9999; }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="bar">
      <h1>çµ±åˆã‚¢ãƒ—ãƒª(æ—¥å ±Ã—QRÃ—ãƒã‚¹ã‚¿ç®¡ç†)</h1>
      <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <span id="firebase-status" class="firebase-status">æ¥ç¶šä¸­...</span>
        <div class="tabs" role="tablist">
          <button id="tabDaily" class="tab" role="tab" aria-selected="true">ğŸ“ æ—¥å ±</button>
          <button id="tabQR" class="tab" role="tab" aria-selected="false">ğŸ” QR</button>
          <button id="tabSettings" class="tab" role="tab" aria-selected="false">âš™ï¸ è¨­å®š</button>
        </div>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <section id="daily-view" class="view active">
    <style>
    #daily-view *{margin:0;padding:0;box-sizing:border-box}
    #daily-view{font-family:Arial,sans-serif;min-height:100vh;padding:10px;overflow-x:hidden;width:100%}
    #daily-view .container{max-width:100%;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.1);overflow:hidden}
    #daily-view .header{background:linear-gradient(135deg,#2c3e50,#3498db);color:#fff;padding:16px;text-align:center;position:relative}
    #daily-view .header h1{font-size:18px}
    #daily-view .lang-selector{position:absolute;top:16px;right:16px;padding:8px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.5);background:rgba(255,255,255,0.9);color:#000;font-size:14px;cursor:pointer;min-height:44px}
    #daily-view .lang-selector:hover{background:rgba(255,255,255,1)}
    #daily-view .main{display:grid;grid-template-columns:1fr;min-height:400px;width:100%}
    #daily-view .table-section{padding:16px;background:#f8f9fa;overflow-x:auto;order:2;width:100%}
    #daily-view .input-panel{background:#fff;padding:20px;overflow-y:auto;order:1;width:100%}
    #daily-view .data-table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,.08);min-width:600px}
    #daily-view .data-table th{background:linear-gradient(135deg,#4a90e2,#357abd);color:#fff;padding:12px 8px;text-align:center;font-weight:600;font-size:12px;white-space:nowrap}
    #daily-view .data-table th.ng{background:linear-gradient(135deg,#f39c12,#e67e22);font-size:11px}
    #daily-view .data-table th.inspector{background:linear-gradient(135deg,#27ae60,#229954);font-size:11px}
    #daily-view .data-table td{padding:12px 8px;text-align:center;border-bottom:1px solid #e9ecef;font-size:13px;cursor:pointer;white-space:nowrap}
    #daily-view .data-table td.ng{background:#fff8e1;font-weight:600;color:#f57c00}
    #daily-view .data-table td.inspector{background:#e8f5e8;font-weight:600;color:#2e7d32}
    #daily-view .data-table tr:hover td{background:#f1f8ff}
    #daily-view .data-table tr.selected td{background:#e3f2fd;border-left:4px solid #2196f3}
    #daily-view .empty{text-align:center;padding:40px 20px;color:#6c757d;font-size:15px}
    #daily-view .group{margin-bottom:18px}
    #daily-view .label{display:block;font-weight:600;margin-bottom:8px;color:#2c3e50;font-size:15px}
    #daily-view .input,#daily-view .select{width:100%;padding:14px;border:2px solid #e9ecef;border-radius:8px;font-size:16px;background:#f8f9fa;min-height:48px;touch-action:manipulation}
    #daily-view .input:disabled{background:#e9ecef;cursor:not-allowed}
    #daily-view .textarea{width:100%;padding:14px;border:2px solid #e9ecef;border-radius:8px;font-size:16px;background:#f8f9fa;resize:vertical;min-height:80px;font-family:inherit}
    #daily-view .time-group{display:flex;gap:8px;align-items:center}
    #daily-view .btn-now{padding:14px 16px;background:linear-gradient(135deg,#f39c12,#e67e22);color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;min-height:48px;touch-action:manipulation}
    #daily-view .btn{padding:14px 22px;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;margin:4px;min-height:48px;display:inline-flex;align-items:center;justify-content:center;gap:8px;touch-action:manipulation}
    #daily-view .btn-primary{background:linear-gradient(135deg,#4a90e2,#357abd);color:#fff}
    #daily-view .btn-success{background:linear-gradient(135deg,#27ae60,#229954);color:#fff}
    #daily-view .btn-danger{background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff}
    #daily-view .btn-secondary{background:linear-gradient(135deg,#95a5a6,#7f8c8d);color:#fff}
    #daily-view .btn-small{padding:12px 16px;font-size:14px;min-height:44px}
    #daily-view .btn-row{display:flex;flex-wrap:wrap;gap:10px;margin-top:18px}
    #daily-view .status{background:#2c3e50;color:#fff;padding:14px 20px;display:flex;justify-content:space-between;align-items:center;font-size:14px;flex-wrap:wrap;gap:10px}
    #daily-view .counter{display:flex;align-items:center;border:2px solid #e9ecef;border-radius:8px;background:#fff;overflow:hidden}
    #daily-view .counter-btn{background:#f8f9fa;border:none;padding:12px;font-size:20px;font-weight:bold;color:#495057;cursor:pointer;min-width:48px;min-height:48px;display:flex;align-items:center;justify-content:center;touch-action:manipulation}
    #daily-view .counter-btn.minus{color:#dc3545;border-right:1px solid #e9ecef}
    #daily-view .counter-btn.plus{color:#28a745;border-left:1px solid #e9ecef}
    #daily-view .counter-input{border:none;padding:12px;font-size:16px;text-align:center;background:#fff;min-width:60px;flex:1}
    #daily-view .ng-section{border:2px solid #e9ecef;border-radius:8px;padding:16px;margin-top:12px;background:#f8f9fa}
    #daily-view .ng-title{font-weight:600;color:#2c3e50;margin-bottom:16px;font-size:16px}
    #daily-view .counter-item{margin-bottom:16px}
    #daily-view .ng-info{background:#e3f2fd;border:1px solid #90caf9;color:#1565c0;padding:12px;border-radius:6px;margin-bottom:16px;font-size:14px}
    #daily-view .inspector-section{border:2px solid #27ae60;border-radius:8px;padding:16px;margin-top:12px;background:#f1f8e9}
    #daily-view .inspector-title{font-weight:600;color:#2c3e50;margin-bottom:16px;font-size:16px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
    #daily-view .inspector-item{background:#fff;border:1px solid #e9ecef;border-radius:8px;padding:16px;margin-bottom:16px}
    #daily-view .inspector-item:last-child{margin-bottom:0}
    #daily-view .inspector-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px}
    #daily-view .inspector-name{font-weight:600;color:#2e7d32;font-size:15px}
    #daily-view .time-inputs{display:grid;grid-template-columns:1fr;gap:16px}
    #daily-view .total-time{background:#e8f5e8;border:1px solid #4caf50;color:#2e7d32;padding:12px;border-radius:6px;margin-top:16px;font-size:14px;font-weight:600;text-align:center}
    #daily-view .time-period{background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;padding:16px;margin-bottom:12px;position:relative}
    #daily-view .time-period-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    #daily-view .time-period-title{font-size:14px;font-weight:600;color:#495057}
    #daily-view .time-period-remove{background:none;border:none;color:#dc3545;cursor:pointer;font-size:14px;padding:8px;min-height:44px;touch-action:manipulation}
    #daily-view .time-periods{margin-top:12px}
    #daily-view .add-time-period{background:#e9ecef;border:1px dashed #adb5bd;border-radius:8px;padding:14px;text-align:center;margin-top:12px;cursor:pointer;color:#6c757d;font-size:14px;min-height:48px;display:flex;align-items:center;justify-content:center;touch-action:manipulation}
    #daily-view .add-time-period:hover{background:#dee2e6}
    #daily-view .time-summary{background:#e8f5e8;border:1px solid #4caf50;border-radius:6px;padding:10px;margin-top:12px;font-size:13px;color:#2e7d32;text-align:center}
    #daily-view .break-time-info{background:#fff3cd;border:1px solid #ffeaa7;color:#856404;padding:12px;border-radius:6px;margin-top:12px;font-size:13px;text-align:center}
    @media(min-width:900px){
      #daily-view .main{grid-template-columns:1fr 420px}
      #daily-view .input-panel{border-left:2px solid #e9ecef;order:2;max-height:calc(100vh - 150px)}
      #daily-view .table-section{order:1}
      #daily-view .time-inputs{grid-template-columns:1fr 1fr}
    }
    </style>
    
    <div class="container">
      <div class="header">
        <select id="langSelector" class="lang-selector" onchange="changeDailyLanguage(this.value)">
          <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
          <option value="pt">ğŸ‡§ğŸ‡· PortuguÃªs</option>
          <option value="th">ğŸ‡¹ğŸ‡­ à¹„à¸—à¸¢</option>
        </select>
        <h1 id="daily-title">ğŸ“Š æ¤œæŸ»ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ </h1>
      </div>
      <div class="main">
        <div class="table-section">
                    <div style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <button id="loadMoreBtn" class="btn btn-secondary btn-small" onclick="loadMoreData()" style="min-width:140px">ğŸ“¥ éå»ãƒ‡ãƒ¼ã‚¿èª­è¾¼(+100ä»¶)</button>
            <span id="loadStatus" style="font-size:13px;color:#6c757d"></span>
          </div>
          <table class="data-table" id="t">
            <thead id="th"></thead>
            <tbody id="tb"></tbody>
          </table>
          <div id="empty" class="empty" style="display:none">
            <p id="empty-msg1">ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
            <p id="empty-msg2">ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
          </div>
        </div>
        <div class="input-panel">
          <h3 id="data-input-title" style="margin-bottom:20px;color:#2c3e50;font-size:18px">ğŸ–Šï¸ ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h3>
          <div class="group">
            <label class="label" id="lbl-pd">ç”Ÿç”£æ—¥ä»˜</label>
            <input type="date" class="input" id="pd">
          </div>
          <div class="group">
            <label class="label" id="lbl-on">æ•´ç†No</label>
            <select class="select" id="on">
              <option value="" id="opt-select">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          <div class="group">
            <label class="label" id="lbl-it2">æ¤œæŸ»ç¨®é¡</label>
            <select class="select" id="it2">
              <option value="" id="opt-select2">é€šå¸¸æ¤œæŸ»</option>
              <option value="F">F - åˆæœŸæµå‹•</option>
              <option value="S">S - é¸åˆ¥</option>
              <option value="K">K - å·¥ç¨‹å¤‰æ›´</option>
              <option value="C">C - æ–°äººWãƒã‚§ãƒƒã‚¯</option>
              <option value="H">H - ç®±è©°ã‚</option>
              <option value="G">G - å¤–è¦³æ¤œæŸ»</option>
              <option value="R">R - ç©´ãƒãƒªæ¤œæŸ»</option>
              <option value="Z">Z - ç”»åƒæ¤œæŸ»+æ¢±åŒ…</option>
            </select>
          </div>
          <div class="group">
            <label class="label" id="lbl-ic">æ¤œæŸ»æ•°ï¼ˆå€‹æ•°ã¯å“ç•ªé¸æŠã§è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ï¼‰</label>
            <div style="display:grid;grid-template-columns:1fr auto 1fr auto 1fr 1.2fr;gap:6px;align-items:center;font-size:14px">
              <input type="number" inputmode="numeric" pattern="[0-9]*" class="input" id="pieces" placeholder="å€‹æ•°" onchange="calcTotalPieces()" style="margin:0;padding:10px;min-height:44px;font-size:15px;background:#e8f5e8">
              <span style="font-weight:600;color:#2c3e50;text-align:center">Ã—</span>
              <input type="number" inputmode="numeric" pattern="[0-9]*" class="input" id="boxes" placeholder="ç®±æ•°" onchange="calcTotalPieces()" style="margin:0;padding:10px;min-height:44px;font-size:15px">
              <span style="font-weight:600;color:#2c3e50;text-align:center">+</span>
              <input type="number" inputmode="numeric" pattern="[0-9]*" class="input" id="remainder" placeholder="ç«¯æ•°" onchange="calcTotalPieces()" style="margin:0;padding:10px;min-height:44px;font-size:15px">
              <input type="number" class="input" id="ic" placeholder="åˆè¨ˆ" disabled style="margin:0;padding:10px;min-height:44px;font-size:15px;background:#e8f5e8;font-weight:600">
            </div>
          </div>
          <div class="group">
            <label class="label" id="lbl-ln">ãƒ­ãƒƒãƒˆNoï¼ˆè‡ªå‹•çš„ã«å¤§æ–‡å­—å¤‰æ›ã•ã‚Œã¾ã™ï¼‰</label>
<input type="text" inputmode="text" pattern="[0-9A-Z\-]*"
  class="input" id="ln" placeholder="ä¾‹: M591"
  style="text-transform:uppercase"
  autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">
          </div>

          <div class="inspector-section">
            <div class="inspector-title">
              <span id="lbl-inspector">ğŸ‘¥ æ¤œæŸ»å“¡æƒ…å ±</span>
              <button class="btn btn-success btn-small" onclick="addInspector()" id="btn-add-inspector">â• æ¤œæŸ»å“¡è¿½åŠ </button>
            </div>
            <div id="inspectors">
              <p style="color:#6c757d;text-align:center;font-size:14px" id="msg-add-inspector">æ¤œæŸ»å“¡ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
            </div>
            <div class="total-time" id="totalTime" style="display:none">
              <span id="lbl-total-time">åˆè¨ˆæ¤œæŸ»æ™‚é–“:</span> <span id="totalTimeValue">0åˆ†</span>
            </div>
            <div class="break-time-info" id="break-info">
              ä¼‘æ†©æ™‚é–“: 10:30-10:40ã€12:10-12:50ã€14:20-14:30ã€17:00-17:10 (è‡ªå‹•é™¤å¤–)
            </div>
          </div>

          <div class="ng-section">
            <div class="ng-title" id="lbl-ng">ğŸš« NGé …ç›®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</div>
            <div id="ng">
              <p style="color:#6c757d;text-align:center;font-size:14px" id="msg-select-org">æ•´ç†Noã‚’é¸æŠã—ã¦ãã ã•ã„</p>
            </div>
          </div>
          
          <div class="group" style="margin-top:18px">
            <label class="label" id="lbl-rm">å‚™è€ƒ</label>
            <textarea class="textarea" id="rm" placeholder="ãƒ¡ãƒ¢ã‚„ç‰¹è¨˜äº‹é …ã‚’å…¥åŠ›"></textarea>
          </div>
          
          <div class="btn-row">
            <button class="btn btn-success" onclick="add()" style="flex:1;min-width:140px" id="btn-add">â• æ–°è¦è¿½åŠ </button>
            <button class="btn btn-primary" onclick="update()" style="flex:1;min-width:140px" id="btn-update">âœï¸ æ›´æ–°</button>
          </div>
          <div class="btn-row">
            <button class="btn btn-danger" onclick="del()" style="flex:1;min-width:140px" id="btn-delete">ğŸ—‘ï¸ å‰Šé™¤</button>
            <button class="btn btn-secondary" onclick="clear()" style="flex:1;min-width:140px" id="btn-clear">ğŸ”„ ã‚¯ãƒªã‚¢</button>
          </div>
          
          <div style="border-top:2px solid #e9ecef;margin:24px 0;padding-top:24px">
            <h4 style="margin-bottom:16px;color:#2c3e50;font-size:16px" id="lbl-csv">ğŸ“Š CSVé€£æº</h4>
            <div class="btn-row">
              <button class="btn btn-primary" onclick="expBoth()" style="width:100%" id="btn-export">ğŸ“¤ CSVå‡ºåŠ›</button>
            </div>
          </div>
        </div>
      </div>
      <div class="status">
        <span id="stat">Firebaseæ¥ç¶šæ¸ˆã¿</span>
        <span id="cnt">è¡Œæ•°: 0</span>
      </div>
    </div>
  </section>

  <section id="qr-view" class="view">
    <div class="qr-card">
      <div class="qr-bigLabel">ç”Ÿç”£ä¸­å“ç•ª</div>
      <div class="qr-grid">
        <div class="qr-baseBox">
          <div class="qr-baseHeading">(åŸºæº–QRã®åˆ‡ã‚Šå‡ºã—å€¤)</div>
          <div id="qr-baseDisplay" class="qr-baseValue qr-placeholder">æœªè¨­å®š</div>
          <div class="qr-lastBox" id="qr-lastScanView">Last: -</div>
        </div>
        <div class="qr-imgBox">
          <img id="qr-productImage" alt="åŸºæº–å“ç•ªã®ç”»åƒ" />
          <div id="qr-imgHint" class="qr-imgHint">ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>
      </div>

      <div class="qr-resultArea">
        <div id="qr-ok" class="qr-resultMark qr-ok">â—¯</div>
        <div id="qr-ng" class="qr-resultMark qr-ng">Ã—</div>
        <div id="qr-lockMsg" class="qr-lock">NG! ç®¡ç†è€…QRã‚’èª­ã¿è¾¼ã‚€ã¾ã§ãƒ­ãƒƒã‚¯ä¸­</div>
      </div>

      <div style="display:flex;flex-wrap:wrap;gap:8px">
        <button id="qr-resetBtn" class="qr-btn" style="flex:1;min-width:120px">è£½å“åˆ‡æ›¿ãˆ</button>
        <button id="qr-saveBtn" class="qr-btn" style="flex:1;min-width:120px">Log CSV</button>
        <button id="qr-exitBtn" class="qr-btn warn" style="flex:1;min-width:140px">ã‚·ã‚¹ãƒ†ãƒ çµ‚äº†</button>
      </div>

      <div class="qr-markRow">
        <input id="qr-markMsg" type="text" placeholder="(ä»»æ„) ç•°å¸¸å†…å®¹ã‚„å‡¦ç½®ãƒ¡ãƒ¢ã‚’å…¥åŠ›">
        <button id="qr-markBtn" class="qr-btn brand" style="width:100%">Mark last scan</button>
      </div>

      <div id="qr-mode" class="qr-status">åŸºæº–QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
      <div class="qr-small">åˆ‡ã‚Šå‡ºã—å›ºå®š:é–‹å§‹=3ã€é•·ã•=5</div>

      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
        <button id="qr-pickDirBtn" class="qr-btn" style="flex:1;min-width:140px">ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</button>
        <label class="qr-btn" for="qr-folderInput" style="flex:1;min-width:140px;text-align:center">ç”»åƒã‚’ä¸€æ‹¬èª­ã¿è¾¼ã¿</label>
        <input id="qr-folderInput" type="file" webkitdirectory multiple />
      </div>
    </div>
  </section>

  <section id="settings-view" class="view">
    <div class="settings-container">
      <div class="settings-card">
        <h2>ğŸ“¦ è£½å“ãƒã‚¹ã‚¿ç®¡ç†</h2>
        <div id="productAlertContainer"></div>
        
        <div class="form-group">
          <label class="form-label">å“ç•ªã‚³ãƒ¼ãƒ‰ï¼ˆè‡ªå‹•çš„ã«å¤§æ–‡å­—å¤‰æ›ã•ã‚Œã¾ã™ï¼‰</label>
          <input type="text" inputmode="text" pattern="[0-9A-Z\-]*" class="form-input" id="productCode" placeholder="ä¾‹: N0009" style="text-transform:uppercase" oninput="this.value=this.value.toUpperCase()">
        </div>
        
        <div class="form-group">
          <label class="form-label">1ç®±å½“ãŸã‚Šã®åå®¹æ•°</label>
          <input type="number" inputmode="numeric" pattern="[0-9]*" class="form-input" id="piecesPerBox" placeholder="ä¾‹: 100">
        </div>
        
        <div class="form-group">
          <label class="form-label">NGé …ç›® (1è¡Œã«1é …ç›®: ã‚³ãƒ¼ãƒ‰:åç§°)</label>
          <textarea class="form-input form-textarea" id="productNGItems" placeholder="18å€‹:18å€‹&#10;19å€‹:19å€‹&#10;125:ã‚¯ãƒ©ãƒƒã‚¯é»’"></textarea>
          <div style="font-size:13px;color:#6c757d;margin-top:6px;">
            æ³¨æ„: ã€Œ30:è½ä¸‹ã€ã¨ã€Œ52:ãã®ä»–ã€ã¯è‡ªå‹•è¿½åŠ ã•ã‚Œã¾ã™
          </div>
        </div>
        
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-success" onclick="addProduct()" style="flex:1;min-width:120px">â• è£½å“è¿½åŠ </button>
          <button class="btn btn-primary" onclick="updateProduct()" style="flex:1;min-width:120px">âœï¸ æ›´æ–°</button>
        </div>
        
        <h3 style="margin-top:24px;margin-bottom:12px;color:#2c3e50;font-size:17px;">ç™»éŒ²æ¸ˆã¿è£½å“</h3>
        <div class="item-list" id="productList">
          <div style="padding:24px;text-align:center;color:#6c757d;">è£½å“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
        </div>
      </div>

      <div class="settings-card">
        <h2>ğŸ‘¥ æ¤œæŸ»å“¡ãƒã‚¹ã‚¿ç®¡ç†</h2>
        <div id="inspectorAlertContainer"></div>
        
        <div class="form-group">
          <label class="form-label">æ¤œæŸ»å“¡å</label>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <input type="text" class="form-input" id="inspectorName" placeholder="ä¾‹: æ–°æ¤œæŸ»å“¡" style="flex:1;min-width:200px">
            <button class="btn btn-success" onclick="addInspectorMaster()" style="min-width:100px">â• è¿½åŠ </button>
          </div>
        </div>
        
        <h3 style="margin-top:24px;margin-bottom:12px;color:#2c3e50;font-size:17px;">ç™»éŒ²æ¸ˆã¿æ¤œæŸ»å“¡</h3>
        <div class="item-list" id="inspectorMasterList">
          <div style="padding:24px;text-align:center;color:#6c757d;">æ¤œæŸ»å“¡ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
        </div>
      </div>
    </div>
  </section>
</main>

<div id="qr-toast" class="qr-toast"></div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAOMRoojKv9Hnh3OjVGwYV_k1LBTGOKepY",
  authDomain: "miyamaunitec-fb87a.firebaseapp.com",
  projectId: "miyamaunitec-fb87a",
  storageBucket: "miyamaunitec-fb87a.firebasestorage.app",
  messagingSenderId: "495316649507",
  appId: "1:495316649507:web:fa195645f46e41b1a39396"
};

let db;
let unsubscribeDaily = null;
let unsubscribeProducts = null;
let unsubscribeInspectors = null;
function getLastNBusinessDays(n) {
  const dates = [];
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  let currentDate = new Date(today);
  while (dates.length < n) {
    const dayOfWeek = currentDate.getDay();
    if (dayOfWeek !== 0 && dayOfWeek !== 6) {
      dates.push(new Date(currentDate));
    }
    currentDate.setDate(currentDate.getDate() - 1);
  }
  
  return dates.reverse();
}

function formatDateForFirestore(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}/${month}/${day}`;
}
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  document.getElementById('firebase-status').textContent = 'âœ“ æ¥ç¶šæ¸ˆã¿';
  document.getElementById('firebase-status').classList.add('connected');
} catch (error) {
  console.error('FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
  document.getElementById('firebase-status').textContent = 'âœ— æ¥ç¶šå¤±æ•—';
  document.getElementById('firebase-status').classList.add('disconnected');
}

(function(){
  const tabDaily = document.getElementById('tabDaily');
  const tabQR = document.getElementById('tabQR');
  const tabSettings = document.getElementById('tabSettings');
  const viewDaily = document.getElementById('daily-view');
  const viewQR = document.getElementById('qr-view');
  const viewSettings = document.getElementById('settings-view');
  const KEY = 'unified.mode';

  function apply(mode){
    viewDaily.classList.toggle('active', mode === 'daily');
    viewQR.classList.toggle('active', mode === 'qr');
    viewSettings.classList.toggle('active', mode === 'settings');
    tabDaily.setAttribute('aria-selected', String(mode === 'daily'));
    tabQR.setAttribute('aria-selected', String(mode === 'qr'));
    tabSettings.setAttribute('aria-selected', String(mode === 'settings'));
    localStorage.setItem(KEY, mode);
  }
  
  tabDaily.addEventListener('click', () => apply('daily'));
  tabQR.addEventListener('click', () => apply('qr'));
  tabSettings.addEventListener('click', () => apply('settings'));
  document.addEventListener('keydown', e => {
    if(e.key === 'F1'){ e.preventDefault(); apply('daily'); }
    else if(e.key === 'F2'){ e.preventDefault(); apply('qr'); }
    else if(e.key === 'F3'){ e.preventDefault(); apply('settings'); }
  });
  apply(localStorage.getItem(KEY) || 'daily');
})();

const dailyTranslations = {
  ja: {
    title: 'ğŸ“Š æ¤œæŸ»ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ ',
    dataInput: 'ğŸ–Šï¸ ãƒ‡ãƒ¼ã‚¿å…¥åŠ›',
    productionDate: 'ç”Ÿç”£æ—¥ä»˜',
    organizationNo: 'æ•´ç†No',
    inspectionType: 'æ¤œæŸ»ç¨®é¡',
    inspectionCount: 'æ¤œæŸ»æ•°ï¼ˆå€‹æ•°ã¯å“ç•ªé¸æŠã§è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ï¼‰',
    lotNo: 'ãƒ­ãƒƒãƒˆNoï¼ˆè‡ªå‹•çš„ã«å¤§æ–‡å­—å¤‰æ›ã•ã‚Œã¾ã™ï¼‰',
    inspectorInfo: 'ğŸ‘¥ æ¤œæŸ»å“¡æƒ…å ±',
    addInspector: 'â• æ¤œæŸ»å“¡è¿½åŠ ',
    pleaseAddInspector: 'æ¤œæŸ»å“¡ã‚’è¿½åŠ ã—ã¦ãã ã•ã„',
    totalInspectionTime: 'åˆè¨ˆæ¤œæŸ»æ™‚é–“:',
    breakTimeInfo: 'ä¼‘æ†©æ™‚é–“: 10:30-10:40ã€12:10-12:50ã€14:20-14:30ã€17:00-17:10 (è‡ªå‹•é™¤å¤–)',
    ngItemCounter: 'ğŸš« NGé …ç›®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼',
    pleaseSelectOrganization: 'æ•´ç†Noã‚’é¸æŠã—ã¦ãã ã•ã„',
    remarks: 'å‚™è€ƒ',
    addNew: 'â• æ–°è¦è¿½åŠ ',
    update: 'âœï¸ æ›´æ–°',
    delete: 'ğŸ—‘ï¸ å‰Šé™¤',
    clear: 'ğŸ”„ ã‚¯ãƒªã‚¢',
    csvIntegration: 'ğŸ“Š CSVé€£æº',
    exportCsv: 'ğŸ“¤ CSVå‡ºåŠ›',
    noData: 'ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“',
    pleaseInputData: 'ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
    pleaseSelect: 'é¸æŠã—ã¦ãã ã•ã„',
    inspectorName: 'æ¤œæŸ»å“¡å',
    startTime: 'é–‹å§‹æ™‚é–“',
    endTime: 'çµ‚äº†æ™‚é–“',
    addTimePeriod: 'â• æ™‚é–“å¸¯ã‚’è¿½åŠ ',
    deleteBtn: 'ğŸ—‘ï¸ å‰Šé™¤',
    timePeriod: 'æ™‚é–“å¸¯',
    inspectionTime: 'æ¤œæŸ»æ™‚é–“:',
    minutes: 'åˆ†',
    hours: 'æ™‚é–“',
    tableProductionDate: 'ç”Ÿç”£æ—¥ä»˜',
    tableOrganizationNo: 'æ•´ç†No',
    tableInspectionCount: 'æ¤œæŸ»æ•°',
    tableTotalTime: 'åˆè¨ˆæ¤œæŸ»æ™‚é–“(åˆ†)',
    tableLotNo: 'ãƒ­ãƒƒãƒˆNo',
    tableInspectionType: 'æ¤œæŸ»ç¨®é¡',
    tableInspectorInfo: 'æ¤œæŸ»å“¡æƒ…å ±',
    tableRemarks: 'å‚™è€ƒ',
    ngItemsInfo: 'æ•´ç†Noã€Œ{0}ã€ã®NGé …ç›®({1}é …ç›®) | åå®¹æ•°: {2}å€‹/ç®±',
    productDataNotFound: 'è£½å“ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
    alertSelectOrganization: 'æ•´ç†Noã‚’é¸æŠã—ã¦ãã ã•ã„',
    alertEnterInspectionCount: 'æ¤œæŸ»æ•°ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„(å€‹æ•°Ã—ç®±æ•°)',
    alertEnterInspector: 'å°‘ãªãã¨ã‚‚1äººã®æ¤œæŸ»å“¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
    alertSelectRow: 'æ›´æ–°ã™ã‚‹è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„',
    alertDeleteConfirm: 'é¸æŠã—ãŸè¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹?',
    alertSelectDeleteRow: 'å‰Šé™¤ã™ã‚‹è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„'
  },
  pt: {
    title: 'ğŸ“Š Sistema de Entrada de Dados de InspeÃ§Ã£o',
    dataInput: 'ğŸ–Šï¸ Entrada de Dados',
    productionDate: 'Data de ProduÃ§Ã£o',
    organizationNo: 'No. de OrganizaÃ§Ã£o',
    inspectionType: 'Tipo de InspeÃ§Ã£o',
    inspectionCount: 'Quantidade de InspeÃ§Ã£o (Auto-preenchimento ao selecionar No. de peÃ§a)',
    lotNo: 'No. de Lote (ConversÃ£o automÃ¡tica para maiÃºsculas)',
    inspectorInfo: 'ğŸ‘¥ InformaÃ§Ãµes do Inspetor',
    addInspector: 'â• Adicionar Inspetor',
    pleaseAddInspector: 'Por favor, adicione um inspetor',
    totalInspectionTime: 'Tempo Total de InspeÃ§Ã£o:',
    breakTimeInfo: 'Tempo de intervalo: 10:30-10:40, 12:10-12:50, 14:20-14:30, 17:00-17:10 (ExcluÃ­do automaticamente)',
    ngItemCounter: 'ğŸš« Contador de Itens NG',
    pleaseSelectOrganization: 'Por favor, selecione o No. de OrganizaÃ§Ã£o',
    remarks: 'ObservaÃ§Ãµes',
    addNew: 'â• Adicionar Novo',
    update: 'âœï¸ Atualizar',
    delete: 'ğŸ—‘ï¸ Excluir',
    clear: 'ğŸ”„ Limpar',
    csvIntegration: 'ğŸ“Š IntegraÃ§Ã£o CSV',
    exportCsv: 'ğŸ“¤ Exportar CSV',
    noData: 'ğŸ“‹ Sem dados',
    pleaseInputData: 'Por favor, insira dados do formulÃ¡rio',
    pleaseSelect: 'Por favor, selecione',
    inspectorName: 'Nome do Inspetor',
    startTime: 'Hora de InÃ­cio',
    endTime: 'Hora de TÃ©rmino',
    addTimePeriod: 'â• Adicionar PerÃ­odo de Tempo',
    deleteBtn: 'ğŸ—‘ï¸ Excluir',
    timePeriod: 'PerÃ­odo',
    inspectionTime: 'Tempo de InspeÃ§Ã£o:',
    minutes: 'min',
    hours: 'h',
    tableProductionDate: 'Data de ProduÃ§Ã£o',
    tableOrganizationNo: 'No. de OrganizaÃ§Ã£o',
    tableInspectionCount: 'Qtd de InspeÃ§Ã£o',
    tableTotalTime: 'Tempo Total (min)',
    tableLotNo: 'No. de Lote',
    tableInspectionType: 'Tipo de InspeÃ§Ã£o',
    tableInspectorInfo: 'Info do Inspetor',
    tableRemarks: 'ObservaÃ§Ãµes',
    ngItemsInfo: 'Itens NG do No. de OrganizaÃ§Ã£o "{0}" ({1} itens) | Capacidade: {2} pÃ§s/caixa',
    productDataNotFound: 'Dados do produto nÃ£o encontrados',
    alertSelectOrganization: 'Por favor, selecione o No. de OrganizaÃ§Ã£o',
    alertEnterInspectionCount: 'Por favor, insira a quantidade de inspeÃ§Ã£o corretamente (peÃ§as Ã— caixas)',
    alertEnterInspector: 'Por favor, insira pelo menos um inspetor',
    alertSelectRow: 'Por favor, selecione a linha para atualizar',
    alertDeleteConfirm: 'Deseja excluir a linha selecionada?',
    alertSelectDeleteRow: 'Por favor, selecione a linha para excluir'
  },
  th: {
    title: 'ğŸ“Š à¸£à¸°à¸šà¸šà¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š',
    dataInput: 'ğŸ–Šï¸ à¸›à¹‰à¸­à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥',
    productionDate: 'à¸§à¸±à¸™à¸—à¸µà¹ˆà¸œà¸¥à¸´à¸•',
    organizationNo: 'à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸­à¸‡à¸„à¹Œà¸à¸£',
    inspectionType: 'à¸›à¸£à¸°à¹€à¸ à¸—à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š',
    inspectionCount: 'à¸ˆà¸³à¸™à¸§à¸™à¸—à¸µà¹ˆà¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š (à¸à¸£à¸­à¸à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸¥à¸·à¸­à¸à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸Šà¸´à¹‰à¸™à¸ªà¹ˆà¸§à¸™)',
    lotNo: 'à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸¥à¹‡à¸­à¸• (à¹à¸›à¸¥à¸‡à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¸à¸´à¸¡à¸à¹Œà¹ƒà¸«à¸à¹ˆà¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´)',
    inspectorInfo: 'ğŸ‘¥ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š',
    addInspector: 'â• à¹€à¸à¸´à¹ˆà¸¡à¸œà¸¹à¹‰à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š',
    pleaseAddInspector: 'à¸à¸£à¸¸à¸“à¸²à¹€à¸à¸´à¹ˆà¸¡à¸œà¸¹à¹‰à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š',
    totalInspectionTime: 'à¹€à¸§à¸¥à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸£à¸§à¸¡:',
    breakTimeInfo: 'à¹€à¸§à¸¥à¸²à¸à¸±à¸: 10:30-10:40, 12:10-12:50, 14:20-14:30, 17:00-17:10 (à¸¢à¸à¹€à¸§à¹‰à¸™à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´)',
    ngItemCounter: 'ğŸš« à¹€à¸„à¸²à¸™à¹Œà¹€à¸•à¸­à¸£à¹Œà¸£à¸²à¸¢à¸à¸²à¸£ NG',
    pleaseSelectOrganization: 'à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸­à¸‡à¸„à¹Œà¸à¸£',
    remarks: 'à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸',
    addNew: 'â• à¹€à¸à¸´à¹ˆà¸¡à¹ƒà¸«à¸¡à¹ˆ',
    update: 'âœï¸ à¸­à¸±à¸›à¹€à¸”à¸•',
    delete: 'ğŸ—‘ï¸ à¸¥à¸š',
    clear: 'ğŸ”„ à¸¥à¹‰à¸²à¸‡',
    csvIntegration: 'ğŸ“Š à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ CSV',
    exportCsv: 'ğŸ“¤ à¸ªà¹ˆà¸‡à¸­à¸­à¸ CSV',
    noData: 'ğŸ“‹ à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥',
    pleaseInputData: 'à¸à¸£à¸¸à¸“à¸²à¸›à¹‰à¸­à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸à¸Ÿà¸­à¸£à¹Œà¸¡',
    pleaseSelect: 'à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸',
    inspectorName: 'à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š',
    startTime: 'à¹€à¸§à¸¥à¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™',
    endTime: 'à¹€à¸§à¸¥à¸²à¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”',
    addTimePeriod: 'â• à¹€à¸à¸´à¹ˆà¸¡à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²',
    deleteBtn: 'ğŸ—‘ï¸ à¸¥à¸š',
    timePeriod: 'à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²',
    inspectionTime: 'à¹€à¸§à¸¥à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š:',
    minutes: 'à¸™à¸²à¸—à¸µ',
    hours: 'à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡',
    tableProductionDate: 'à¸§à¸±à¸™à¸—à¸µà¹ˆà¸œà¸¥à¸´à¸•',
    tableOrganizationNo: 'à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸­à¸‡à¸„à¹Œà¸à¸£',
    tableInspectionCount: 'à¸ˆà¸³à¸™à¸§à¸™à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š',
    tableTotalTime: 'à¹€à¸§à¸¥à¸²à¸£à¸§à¸¡ (à¸™à¸²à¸—à¸µ)',
    tableLotNo: 'à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸¥à¹‡à¸­à¸•',
    tableInspectionType: 'à¸›à¸£à¸°à¹€à¸ à¸—à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š',
    tableInspectorInfo: 'à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š',
    tableRemarks: 'à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸',
    ngItemsInfo: 'à¸£à¸²à¸¢à¸à¸²à¸£ NG à¸‚à¸­à¸‡à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸­à¸‡à¸„à¹Œà¸à¸£ "{0}" ({1} à¸£à¸²à¸¢à¸à¸²à¸£) | à¸„à¸§à¸²à¸¡à¸ˆà¸¸: {2} à¸Šà¸´à¹‰à¸™/à¸à¸¥à¹ˆà¸­à¸‡',
    productDataNotFound: 'à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¥à¸´à¸•à¸ à¸±à¸“à¸‘à¹Œ',
    alertSelectOrganization: 'à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸­à¸‡à¸„à¹Œà¸à¸£',
    alertEnterInspectionCount: 'à¸à¸£à¸¸à¸“à¸²à¸›à¹‰à¸­à¸™à¸ˆà¸³à¸™à¸§à¸™à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸­à¸¢à¹ˆà¸²à¸‡à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ (à¸Šà¸´à¹‰à¸™ Ã— à¸à¸¥à¹ˆà¸­à¸‡)',
    alertEnterInspector: 'à¸à¸£à¸¸à¸“à¸²à¸›à¹‰à¸­à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢ 1 à¸„à¸™',
    alertSelectRow: 'à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¹à¸–à¸§à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸­à¸±à¸›à¹€à¸”à¸•',
    alertDeleteConfirm: 'à¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¥à¸šà¹à¸–à¸§à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ?',
    alertSelectDeleteRow: 'à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¹à¸–à¸§à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¥à¸š'
  }
};

let currentDailyLang = 'ja';
let sel = -1, data = [], items = [], cols = new Map(), inspectorCount = 0, timePeriodCount = 0;
let master = {};
let inspectorNames = [];
let editingProductCode = null;
let lastVisibleDoc = null;
let isLoadingMore = false;
let hasMoreData = true;
const breakTimes = [
  {start: 630, end: 640},
  {start: 730, end: 780},
  {start: 860, end: 870},
  {start: 1020, end: 1030}
];

function changeDailyLanguage(lang) {
  currentDailyLang = lang;
  localStorage.setItem('dailyLanguage', lang);
  applyDailyTranslation();
}

function applyDailyTranslation() {
  const t = dailyTranslations[currentDailyLang];
  
  const setTextIfExists = (id, text) => {
    const el = document.getElementById(id);
    if (el) el.textContent = text;
  };
  
  setTextIfExists('daily-title', t.title);
  setTextIfExists('data-input-title', t.dataInput);
  setTextIfExists('lbl-pd', t.productionDate);
  setTextIfExists('lbl-on', t.organizationNo);
  setTextIfExists('lbl-it2', t.inspectionType);
  setTextIfExists('lbl-ic', t.inspectionCount);
  setTextIfExists('lbl-ln', t.lotNo);
  setTextIfExists('lbl-inspector', t.inspectorInfo);
  setTextIfExists('btn-add-inspector', t.addInspector);
  setTextIfExists('msg-add-inspector', t.pleaseAddInspector);
  setTextIfExists('lbl-total-time', t.totalInspectionTime);
  setTextIfExists('break-info', t.breakTimeInfo);
  setTextIfExists('lbl-ng', t.ngItemCounter);
  setTextIfExists('msg-select-org', t.pleaseSelectOrganization);
  setTextIfExists('lbl-rm', t.remarks);
  setTextIfExists('btn-add', t.addNew);
  setTextIfExists('btn-update', t.update);
  setTextIfExists('btn-delete', t.delete);
  setTextIfExists('btn-clear', t.clear);
  setTextIfExists('lbl-csv', t.csvIntegration);
  setTextIfExists('btn-export', t.exportCsv);
  setTextIfExists('empty-msg1', t.noData);
  setTextIfExists('empty-msg2', t.pleaseInputData);
  setTextIfExists('opt-select', t.pleaseSelect);
  setTextIfExists('opt-select2', t.pleaseSelect);
  
  renderHeader();
  updateProductSelect();
  updateAllInspectorSelects();
}

function updateAllInspectorSelects() {
  const t = dailyTranslations[currentDailyLang];
  document.querySelectorAll('[id^="inspector_name_"]').forEach(select => {
    const currentValue = select.value;
    let html = '<option value="">' + t.pleaseSelect + '</option>';
    inspectorNames.forEach(name => {
      html += `<option value="${name}">${name}</option>`;
    });
    select.innerHTML = html;
    if (currentValue) select.value = currentValue;
  });
}

function calculateWorkingMinutes(startMinutes, endMinutes) {
  if(endMinutes < startMinutes) endMinutes += 1440;
  let workingMinutes = 0;
  let currentStart = startMinutes;
  
  while(currentStart < endMinutes) {
    let nextBreakStart = null;
    let nextBreakEnd = null;
    
    for(let breakTime of breakTimes) {
      if(breakTime.start > currentStart && (nextBreakStart === null || breakTime.start < nextBreakStart)) {
        nextBreakStart = breakTime.start;
        nextBreakEnd = breakTime.end;
      }
    }
    
    if(nextBreakStart === null || nextBreakStart >= endMinutes) {
      workingMinutes += (endMinutes - currentStart);
      break;
    } else {
      workingMinutes += (nextBreakStart - currentStart);
      currentStart = nextBreakEnd;
    }
  }
  
  return workingMinutes;
}

function init(){
  document.getElementById('pd').value = new Date().toISOString().split('T')[0];
  document.getElementById('on').addEventListener('change', updateNG);
  updateCols();
  showEmpty();
  renderHeader();
  status('ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•å®Œäº†');
  addInspector();
  
  const savedLang = localStorage.getItem('dailyLanguage') || 'ja';
  currentDailyLang = savedLang;
  document.getElementById('langSelector').value = savedLang;
  applyDailyTranslation();
  
  if(db) {
    unsubscribeProducts = db.collection('productMaster').onSnapshot(snapshot => {
      master = {};
      snapshot.forEach(doc => {
        const d = doc.data();
        master[doc.id] = {
          piecesPerBox: d.piecesPerBox || 0,
          ngItems: d.ngItems || []
        };
      });
      updateProductSelect();
      updateProductList();
      updateCols();
      renderHeader();
      if(document.getElementById('on').value) updateNG();
    });
    
    unsubscribeInspectors = db.collection('inspectorMaster').orderBy('order').onSnapshot(snapshot => {
      inspectorNames = [];
      snapshot.forEach(doc => {
        inspectorNames.push(doc.data().name);
      });
      updateInspectorMasterList();
      updateAllInspectorSelects();
    });
    


// ã‚¯ã‚¨ãƒªã«æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ã‚’è¿½åŠ 
       unsubscribeDaily = db.collection('dailyReports')
      .orderBy('timestamp', 'desc')
      .limit(15)
      .onSnapshot(snapshot => {
        data = [];
        lastVisibleDoc = null;
        snapshot.forEach((doc, index) => {
      const d = doc.data();
      data.push({
        id: doc.id,
        pd: d.pd || '',
        on: d.on || '',
        pieces: d.pieces || '',
        boxes: d.boxes || '',
        remainder: d.remainder || '',
        ic: d.ic || '0',
        totalTime: d.totalTime || '0',
        ln: d.ln || '',
        it2: d.it2 || '',
        inspectors: d.inspectors || [],
        ngMap: d.ngMap ? new Map(Object.entries(d.ngMap)) : new Map(),
        rm: d.rm || ''
      });
    });
    render();
    updateCnt();
  });
  }
}

async function loadMoreData() {
  if (!db || isLoadingMore || !hasMoreData) return;
  
  isLoadingMore = true;
  const loadBtn = document.getElementById('loadMoreBtn');
  const originalText = loadBtn.textContent;
  loadBtn.textContent = 'èª­è¾¼ä¸­...';
  loadBtn.disabled = true;
  
  try {
    let query = db.collection('dailyReports')
      .orderBy('timestamp', 'desc')
      .limit(100);
    
    if (lastVisibleDoc) {
      query = query.startAfter(lastVisibleDoc);
    }
    
    const snapshot = await query.get();
    
    if (snapshot.empty) {
      hasMoreData = false;
      updateLoadStatus();
      loadBtn.textContent = 'å…¨ãƒ‡ãƒ¼ã‚¿èª­è¾¼æ¸ˆã¿';
      setTimeout(() => {
        loadBtn.textContent = originalText;
        loadBtn.disabled = false;
      }, 2000);
      isLoadingMore = false;
      return;
    }
    
    snapshot.forEach((doc, index) => {
      const d = doc.data();
      const exists = data.some(item => item.id === doc.id);
      if (!exists) {
        data.push({
          id: doc.id,
          pd: d.pd || '',
          on: d.on || '',
          pieces: d.pieces || '',
          boxes: d.boxes || '',
          remainder: d.remainder || '',
          ic: d.ic || '0',
          totalTime: d.totalTime || '0',
          ln: d.ln || '',
          it2: d.it2 || '',
          inspectors: d.inspectors || [],
          ngMap: d.ngMap ? new Map(Object.entries(d.ngMap)) : new Map(),
          rm: d.rm || ''
        });
      }
      if (index === snapshot.docs.length - 1) {
        lastVisibleDoc = doc;
      }
    });
            updateLoadStatus();
        render();
    render();
    updateCnt();
    updateLoadStatus();
    status(`éå»ãƒ‡ãƒ¼ã‚¿ ${snapshot.size}ä»¶ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
    
  } catch(error) {
    console.error('ãƒ‡ãƒ¼ã‚¿èª­è¾¼ã‚¨ãƒ©ãƒ¼:', error);
    alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
  } finally {
    loadBtn.textContent = originalText;
    loadBtn.disabled = false;
    isLoadingMore = false;
  }
}

function updateLoadStatus() {
  const statusEl = document.getElementById('loadStatus');
  if (!statusEl) return;
  
  if (!hasMoreData) {
    statusEl.textContent = '(å…¨ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºä¸­)';
    statusEl.style.color = '#28a745';
  } else if (data.length > 0) {
    statusEl.textContent = `(ç¾åœ¨ ${data.length}ä»¶è¡¨ç¤ºä¸­)`;
    statusEl.style.color = '#6c757d';
  } else {
    statusEl.textContent = '';
  }
}
function addProduct() {
  if(!db) {
    showProductAlert('error', 'Firebaseã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
    return;
  }
  
  const code = document.getElementById('productCode').value.trim();
  const piecesPerBox = document.getElementById('piecesPerBox').value.trim();
  const ngItemsText = document.getElementById('productNGItems').value.trim();
  
  if (!code) {
    showProductAlert('error', 'å“ç•ªã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  if (!piecesPerBox || parseInt(piecesPerBox) <= 0) {
    showProductAlert('error', '1ç®±å½“ãŸã‚Šã®åå®¹æ•°ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  let ngItems = [];
  
  if (ngItemsText) {
    const lines = ngItemsText.split('\n');
    lines.forEach(line => {
      const trimmed = line.trim();
      if (trimmed && trimmed.includes(':')) {
        const [ngCode, ngName] = trimmed.split(':');
        if (ngCode && ngName) {
          ngItems.push({ code: ngCode.trim(), name: ngName.trim() });
        }
      }
    });
  }
  
  ngItems.push({ code: "30", name: "è½ä¸‹" });
  ngItems.push({ code: "52", name: "ãã®ä»–" });
  
  const uniqueItems = [];
  const seen = new Set();
  ngItems.forEach(item => {
    if (!seen.has(item.code)) {
      seen.add(item.code);
      uniqueItems.push(item);
    }
  });
  
  db.collection('productMaster').doc(code).set({
    piecesPerBox: parseInt(piecesPerBox),
    ngItems: uniqueItems,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    document.getElementById('productCode').value = '';
    document.getElementById('piecesPerBox').value = '';
    document.getElementById('productNGItems').value = '';
    const wasEditing = editingProductCode !== null;
    editingProductCode = null;
    showProductAlert('success', `è£½å“ã€Œ${code}ã€ã‚’${wasEditing ? 'æ›´æ–°' : 'è¿½åŠ '}ã—ã¾ã—ãŸ`);
  }).catch(error => {
    console.error('è£½å“è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
    showProductAlert('error', 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
  });
}

function updateProduct() {
  if (!editingProductCode) {
    showProductAlert('error', 'ç·¨é›†ã™ã‚‹è£½å“ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }
  addProduct();
}

function editProduct(code) {
  editingProductCode = code;
  document.getElementById('productCode').value = code;
  
  const productData = master[code];
  if (productData) {
    document.getElementById('piecesPerBox').value = productData.piecesPerBox || '';
    const items = productData.ngItems || [];
    const customItems = items.filter(item => item.code !== '30' && item.code !== '52');
    document.getElementById('productNGItems').value = customItems.map(item => `${item.code}:${item.name}`).join('\n');
  }
  
  showProductAlert('success', `è£½å“ã€Œ${code}ã€ã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«ã—ã¾ã—ãŸ`);
}

function deleteProduct(code) {
  if (confirm(`è£½å“ã€Œ${code}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹?`)) {
    db.collection('productMaster').doc(code).delete().then(() => {
      if (editingProductCode === code) {
        editingProductCode = null;
        document.getElementById('productCode').value = '';
        document.getElementById('piecesPerBox').value = '';
        document.getElementById('productNGItems').value = '';
      }
      showProductAlert('success', `è£½å“ã€Œ${code}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
    }).catch(error => {
      showProductAlert('error', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    });
  }
}

function updateProductList() {
  const list = document.getElementById('productList');
  const codes = Object.keys(master);
  
  if (codes.length === 0) {
    list.innerHTML = '<div style="padding:24px;text-align:center;color:#6c757d;">è£½å“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
    return;
  }
  
  let html = '';
  codes.forEach(code => {
    const productData = master[code];
    const piecesPerBox = productData.piecesPerBox || 0;
    const items = productData.ngItems || [];
    
    html += '<div class="item">';
    html += '<div style="flex:1">';
    html += `<div class="item-name">${code} <span style="color:#2e7d32;font-size:13px;font-weight:normal">(${piecesPerBox}å€‹/ç®±)</span></div>`;
    html += '<div class="item-details">';
    items.forEach(item => {
      html += `<span class="ng-tag">${item.code}:${item.name}</span>`;
    });
    html += '</div>';
    html += '</div>';
    html += '<div style="display:flex;gap:6px;flex-wrap:wrap">';
    html += `<button onclick="editProduct('${code}')" style="background:#17a2b8;color:white;border:none;border-radius:6px;padding:10px 14px;font-size:13px;cursor:pointer;min-height:44px;touch-action:manipulation">ç·¨é›†</button>`;
    html += `<button onclick="deleteProduct('${code}')" style="background:#dc3545;color:white;border:none;border-radius:6px;padding:10px 14px;font-size:13px;cursor:pointer;min-height:44px;touch-action:manipulation">å‰Šé™¤</button>`;
    html += '</div>';
    html += '</div>';
  });
  
  list.innerHTML = html;
}

function updateProductSelect() {
  const select = document.getElementById('on');
  const currentValue = select.value;
  const t = dailyTranslations[currentDailyLang];
  
  let html = '<option value="">' + t.pleaseSelect + '</option>';
  Object.keys(master).sort().forEach(code => {
    html += `<option value="${code}">${code}</option>`;
  });
  
  select.innerHTML = html;
  if (currentValue) select.value = currentValue;
}

async function addInspectorMaster() {
  const name = document.getElementById('inspectorName').value.trim();
  
  if (!name) {
    showInspectorMasterAlert('error', 'æ¤œæŸ»å“¡åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  if (inspectorNames.includes(name)) {
    showInspectorMasterAlert('error', 'åŒã˜åå‰ã®æ¤œæŸ»å“¡ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™');
    return;
  }
  
  try {
    await db.collection('inspectorMaster').add({
      name: name,
      order: inspectorNames.length,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById('inspectorName').value = '';
    showInspectorMasterAlert('success', `æ¤œæŸ»å“¡ã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
  } catch(error) {
    showInspectorMasterAlert('error', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
  }
}

async function deleteInspectorMaster(name) {
  if (confirm(`æ¤œæŸ»å“¡ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹?`)) {
    try {
      const snapshot = await db.collection('inspectorMaster').where('name', '==', name).get();
      snapshot.forEach(doc => doc.ref.delete());
      showInspectorMasterAlert('success', `æ¤œæŸ»å“¡ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
    } catch(error) {
      showInspectorMasterAlert('error', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    }
  }
}

function updateInspectorMasterList() {
  const list = document.getElementById('inspectorMasterList');
  
  if (inspectorNames.length === 0) {
    list.innerHTML = '<div style="padding:24px;text-align:center;color:#6c757d;">æ¤œæŸ»å“¡ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
    return;
  }
  
  let html = '';
  inspectorNames.forEach(name => {
    html += '<div class="item">';
    html += `<div class="item-name">${name}</div>`;
    html += `<button onclick="deleteInspectorMaster('${name}')" style="background:#dc3545;color:white;border:none;border-radius:6px;padding:10px 14px;font-size:13px;cursor:pointer;min-height:44px;touch-action:manipulation">å‰Šé™¤</button>`;
    html += '</div>';
  });
  
  list.innerHTML = html;
}

function showProductAlert(type, message) {
  const container = document.getElementById('productAlertContainer');
  container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
  setTimeout(() => container.innerHTML = '', 3000);
}

function showInspectorMasterAlert(type, message) {
  const container = document.getElementById('inspectorAlertContainer');
  container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
  setTimeout(() => container.innerHTML = '', 3000);
}

function calcTotalPieces(){
  const pieces = parseInt(document.getElementById('pieces').value) || 0;
  const boxes = parseInt(document.getElementById('boxes').value) || 0;
  const remainder = parseInt(document.getElementById('remainder').value) || 0;
  const total = (pieces * boxes) + remainder;
  document.getElementById('ic').value = total > 0 ? total : '';
}

function addInspector(){
  inspectorCount++;
  const container = document.getElementById('inspectors');
  const t = dailyTranslations[currentDailyLang];
  
  if(container.querySelector('p')){
    container.innerHTML = '';
  }
  
  const inspectorDiv = document.createElement('div');
  inspectorDiv.className = 'inspector-item';
  inspectorDiv.id = 'inspector_' + inspectorCount;
  
  inspectorDiv.innerHTML = 
    '<div class="inspector-header">' +
      '<span class="inspector-name">æ¤œæŸ»å“¡ ' + inspectorCount + '</span>' +
      '<button class="btn btn-danger btn-small" onclick="removeInspector(' + inspectorCount + ')">' + t.deleteBtn + '</button>' +
    '</div>' +
    '<div class="group">' +
      '<label class="label">' + t.inspectorName + '</label>' +
      '<select class="select" id="inspector_name_' + inspectorCount + '" onchange="calcTotalTime()">' +
        '<option value="">' + t.pleaseSelect + '</option>' +
      '</select>' +
    '</div>' +
    '<div class="time-periods" id="time_periods_' + inspectorCount + '">' +
    '</div>' +
    '<div class="add-time-period" onclick="addTimePeriod(' + inspectorCount + ')">' +
      t.addTimePeriod +
    '</div>' +
    '<div class="time-summary" id="inspector_summary_' + inspectorCount + '" style="display:none">' +
      t.inspectionTime + ' 0' + t.minutes +
    '</div>';
  
  container.appendChild(inspectorDiv);
  
  const select = document.getElementById('inspector_name_' + inspectorCount);
  let html = '<option value="">' + t.pleaseSelect + '</option>';
  inspectorNames.forEach(name => {
    html += `<option value="${name}">${name}</option>`;
  });
  select.innerHTML = html;
  
  addTimePeriod(inspectorCount);
  calcTotalTime();
}

function removeInspector(id){
  const inspector = document.getElementById('inspector_' + id);
  if(inspector){
    inspector.remove();
    calcTotalTime();
    
    const remaining = document.querySelectorAll('.inspector-item');
    if(remaining.length === 0){
      const t = dailyTranslations[currentDailyLang];
      document.getElementById('inspectors').innerHTML = '<p style="color:#6c757d;text-align:center;font-size:14px">' + t.pleaseAddInspector + '</p>';
    }
  }
}

function addTimePeriod(inspectorId){
  timePeriodCount++;
  const container = document.getElementById('time_periods_' + inspectorId);
  const t = dailyTranslations[currentDailyLang];
  
  const timePeriodDiv = document.createElement('div');
  timePeriodDiv.className = 'time-period';
  timePeriodDiv.id = 'time_period_' + timePeriodCount;
  
  const existingPeriods = container.querySelectorAll('.time-period').length;
  
  timePeriodDiv.innerHTML = 
    '<div class="time-period-header">' +
      '<span class="time-period-title">' + t.timePeriod + ' ' + (existingPeriods + 1) + '</span>' +
      (existingPeriods > 0 ? 
        '<button class="time-period-remove" onclick="removeTimePeriod(' + timePeriodCount + ', ' + inspectorId + ')">' + t.deleteBtn + '</button>' : 
        '') +
    '</div>' +
    '<div class="time-inputs">' +
      '<div class="group">' +
        '<label class="label">' + t.startTime + '</label>' +
        '<div class="time-group">' +
          '<input type="time" class="input" id="start_time_' + timePeriodCount + '" onchange="calcInspectorTime(' + inspectorId + ')">' +
          '<button class="btn-now" onclick="setNow(\'start_time_' + timePeriodCount + '\', ' + inspectorId + ')">Now</button>' +
        '</div>' +
      '</div>' +
      '<div class="group">' +
        '<label class="label">' + t.endTime + '</label>' +
        '<div class="time-group">' +
          '<input type="time" class="input" id="end_time_' + timePeriodCount + '" onchange="calcInspectorTime(' + inspectorId + ')">' +
          '<button class="btn-now" onclick="setNow(\'end_time_' + timePeriodCount + '\', ' + inspectorId + ')">Now</button>' +
        '</div>' +
      '</div>' +
    '</div>';
  
  container.appendChild(timePeriodDiv);
  calcInspectorTime(inspectorId);
}

function removeTimePeriod(periodId, inspectorId){
  const period = document.getElementById('time_period_' + periodId);
  if(period){
    period.remove();
    updateTimePeriodLabels(inspectorId);
    calcInspectorTime(inspectorId);
  }
}

function updateTimePeriodLabels(inspectorId){
  const container = document.getElementById('time_periods_' + inspectorId);
  const periods = container.querySelectorAll('.time-period');
  const t = dailyTranslations[currentDailyLang];
  periods.forEach((period, index) => {
    const title = period.querySelector('.time-period-title');
    if(title){
      title.textContent = t.timePeriod + ' ' + (index + 1);
    }
  });
}

function setNow(fieldId, inspectorId){
  const now = new Date();
  document.getElementById(fieldId).value = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
  calcInspectorTime(inspectorId);
}

function calcInspectorTime(inspectorId){
  const container = document.getElementById('time_periods_' + inspectorId);
  const periods = container.querySelectorAll('.time-period');
  let totalMinutes = 0;
  const t = dailyTranslations[currentDailyLang];
  
  periods.forEach(period => {
    const startTimeInput = period.querySelector('input[id^="start_time_"]');
    const endTimeInput = period.querySelector('input[id^="end_time_"]');
    
    if(startTimeInput && endTimeInput){
      const startTime = startTimeInput.value;
      const endTime = endTimeInput.value;
      
      if(startTime && endTime){
        const startHour = parseInt(startTime.split(':')[0]);
        const startMin = parseInt(startTime.split(':')[1]);
        const endHour = parseInt(endTime.split(':')[0]);
        const endMin = parseInt(endTime.split(':')[1]);
        
        let startMinutes = startHour * 60 + startMin;
        let endMinutes = endHour * 60 + endMin;
        
        totalMinutes += calculateWorkingMinutes(startMinutes, endMinutes);
      }
    }
  });
  
  const summary = document.getElementById('inspector_summary_' + inspectorId);
  if(totalMinutes > 0){
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    summary.textContent = hours > 0 ? 
      t.inspectionTime + ' ' + hours + t.hours + minutes + t.minutes : 
      t.inspectionTime + ' ' + minutes + t.minutes;
    summary.style.display = 'block';
  } else {
    summary.style.display = 'none';
  }
  
  calcTotalTime();
}

function calcTotalTime(){
  let totalMinutes = 0;
  const inspectors = document.querySelectorAll('.inspector-item');
  const t = dailyTranslations[currentDailyLang];
  
  inspectors.forEach(inspector => {
    const id = inspector.id.split('_')[1];
    const container = document.getElementById('time_periods_' + id);
    if(container){
      const periods = container.querySelectorAll('.time-period');
      
      periods.forEach(period => {
        const startTimeInput = period.querySelector('input[id^="start_time_"]');
        const endTimeInput = period.querySelector('input[id^="end_time_"]');
        
        if(startTimeInput && endTimeInput){
          const startTime = startTimeInput.value;
          const endTime = endTimeInput.value;
          
          if(startTime && endTime){
            const startHour = parseInt(startTime.split(':')[0]);
            const startMin = parseInt(startTime.split(':')[1]);
            const endHour = parseInt(endTime.split(':')[0]);
            const endMin = parseInt(endTime.split(':')[1]);
            
            let startMinutes = startHour * 60 + startMin;
            let endMinutes = endHour * 60 + endMin;
            
            totalMinutes += calculateWorkingMinutes(startMinutes, endMinutes);
          }
        }
      });
    }
  });
  
  const totalTimeDiv = document.getElementById('totalTime');
  const totalTimeValue = document.getElementById('totalTimeValue');
  
  if(totalMinutes > 0){
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    totalTimeValue.textContent = hours > 0 ? 
      hours + t.hours + minutes + t.minutes : 
      minutes + t.minutes;
    totalTimeDiv.style.display = 'block';
  } else {
    totalTimeDiv.style.display = 'none';
  }
}

function getInspectorData(){
  const inspectors = [];
  const inspectorItems = document.querySelectorAll('.inspector-item');
  
  inspectorItems.forEach(item => {
    const id = item.id.split('_')[1];
    const name = document.getElementById('inspector_name_' + id).value;
    const container = document.getElementById('time_periods_' + id);
    const timePeriods = [];
    
    if(container){
      const periods = container.querySelectorAll('.time-period');
      periods.forEach(period => {
        const startTimeInput = period.querySelector('input[id^="start_time_"]');
        const endTimeInput = period.querySelector('input[id^="end_time_"]');
        
        if(startTimeInput && endTimeInput){
          const startTime = startTimeInput.value;
          const endTime = endTimeInput.value;
          
          if(startTime || endTime){
            timePeriods.push({
              startTime: startTime || '',
              endTime: endTime || ''
            });
          }
        }
      });
    }
    
    if(name || timePeriods.length > 0){
      inspectors.push({
        name: name || '',
        timePeriods: timePeriods
      });
    }
  });
  
  return inspectors;
}

function setInspectorData(inspectors){
  document.getElementById('inspectors').innerHTML = '';
  inspectorCount = 0;
  timePeriodCount = 0;
  
  if(!inspectors || inspectors.length === 0){
    addInspector();
    return;
  }
  
  inspectors.forEach((inspector) => {
    addInspector();
    const currentId = inspectorCount;
    
    if(inspector.name) {
      const select = document.getElementById('inspector_name_' + currentId);
      if(select) select.value = inspector.name;
    }
    
    const container = document.getElementById('time_periods_' + currentId);
    container.innerHTML = '';
    
    if(inspector.startTime !== undefined || inspector.endTime !== undefined){
      addTimePeriod(currentId);
      const periods = container.querySelectorAll('.time-period');
      if(periods.length > 0){
        const period = periods[0];
        const startTimeInput = period.querySelector('input[id^="start_time_"]');
        const endTimeInput = period.querySelector('input[id^="end_time_"]');
        if(startTimeInput && inspector.startTime) startTimeInput.value = inspector.startTime;
        if(endTimeInput && inspector.endTime) endTimeInput.value = inspector.endTime;
      }
    }
    else if(inspector.timePeriods && inspector.timePeriods.length > 0){
      inspector.timePeriods.forEach(timePeriod => {
        addTimePeriod(currentId);
        const periods = container.querySelectorAll('.time-period');
        const period = periods[periods.length - 1];
        const startTimeInput = period.querySelector('input[id^="start_time_"]');
        const endTimeInput = period.querySelector('input[id^="end_time_"]');
        if(startTimeInput && timePeriod.startTime) startTimeInput.value = timePeriod.startTime;
        if(endTimeInput && timePeriod.endTime) endTimeInput.value = timePeriod.endTime;
      });
    } else {
      addTimePeriod(currentId);
    }
    
    calcInspectorTime(currentId);
  });
}

function status(m){
  document.getElementById('stat').textContent = m;
  setTimeout(function(){document.getElementById('stat').textContent = 'Firebaseæ¥ç¶šæ¸ˆã¿'}, 3000);
}

function updateCnt(){
  document.getElementById('cnt').textContent = 'è¡Œæ•°: ' + data.length;
}

function changeCnt(id, c){
  const i = document.getElementById(id);
  if(i) i.value = Math.max(0, (parseInt(i.value) || 0) + c);
}

function validateCnt(i){
  if(parseInt(i.value) < 0) i.value = 0;
}

function updateCols(){
  cols.clear();
  Object.values(master).forEach(function(productData){
    const items = productData.ngItems || [];
    items.forEach(function(it){
      cols.set(it.code, it.name);
    });
  });
}

function updateNG(){
  const o = document.getElementById('on').value, c = document.getElementById('ng');
  const t = dailyTranslations[currentDailyLang];
  if(!o){
    c.innerHTML = '<p style="color:#6c757d;text-align:center;font-size:14px">' + t.pleaseSelectOrganization + '</p>';
    items = [];
    return;
  }
  
  const productData = master[o];
  if(!productData){
    c.innerHTML = '<p style="color:#6c757d;text-align:center;font-size:14px">' + t.productDataNotFound + '</p>';
    items = [];
    return;
  }
  
  const piecesPerBox = productData.piecesPerBox || 0;
  if(piecesPerBox > 0){
    document.getElementById('pieces').value = piecesPerBox;
    calcTotalPieces();
  }
  
  const its = productData.ngItems || [];
  const sorted = [];
  const bottom = ['31', '54'];
  its.forEach(function(it){
    if(!bottom.includes(it.code)) sorted.push(it);
  });
  its.forEach(function(it){
    if(it.code === '31') sorted.push(it);
  });
  its.forEach(function(it){
    if(it.code === '54') sorted.push(it);
  });
  items = sorted;
  const infoText = t.ngItemsInfo.replace('{0}', o).replace('{1}', its.length).replace('{2}', piecesPerBox);
  c.innerHTML = '<div class="ng-info">ğŸ“Œ ' + infoText + '</div>';
  sorted.forEach(function(it, i){
    const d = document.createElement('div');
    d.className = 'counter-item';
    d.innerHTML = '<label class="label">' + it.code + '(' + it.name + ')</label><div class="counter"><button class="counter-btn minus" onclick="changeCnt(\'ng_' + i + '\',-1)">âˆ’</button><input type="number" inputmode="numeric" pattern="[0-9]*" class="counter-input" id="ng_' + i + '" value="0" min="0" onchange="validateCnt(this)"><button class="counter-btn plus" onclick="changeCnt(\'ng_' + i + '\',1)">+</button></div>';
    c.appendChild(d);
  });
}

function renderHeader(){
  const h = document.getElementById('th');
  h.innerHTML = '';
  const r = document.createElement('tr');
  const t = dailyTranslations[currentDailyLang];
  [t.tableProductionDate, t.tableOrganizationNo, t.tableInspectionCount, t.tableTotalTime, t.tableLotNo, t.tableInspectionType].forEach(function(txt){
    const th = document.createElement('th');
    th.textContent = txt;
    r.appendChild(th);
  });
  
  const th_inspectors = document.createElement('th');
  th_inspectors.className = 'inspector';
  th_inspectors.textContent = t.tableInspectorInfo;
  r.appendChild(th_inspectors);
  
  Array.from(cols.entries()).sort().forEach(function(entry){
    const th = document.createElement('th');
    th.className = 'ng';
    th.innerHTML = entry[0] + '<br>' + entry[1];
    r.appendChild(th);
  });
  const th = document.createElement('th');
  th.textContent = t.tableRemarks;
  r.appendChild(th);
  h.appendChild(r);
}

function render(){
  const b = document.getElementById('tb');
  b.innerHTML = '';
  data.forEach(function(d, i){
    const r = document.createElement('tr');
    r.onclick = function(){select(i)};
    
    let inspectionCountDisplay = d.ic || '0';
    if(d.pieces && d.boxes){
      const base = d.pieces + 'å€‹Ã—' + d.boxes + 'ç®±';
      inspectionCountDisplay = d.remainder ? base + '+' + d.remainder + '=' + d.ic : base + '=' + d.ic;
    }
    
    [d.pd, d.on, inspectionCountDisplay, d.totalTime, d.ln, d.it2].forEach(function(v){
      const td = document.createElement('td');
      td.textContent = v || '';
      r.appendChild(td);
    });
    
    const td_inspectors = document.createElement('td');
    td_inspectors.className = 'inspector';
    if(d.inspectors && d.inspectors.length > 0){
      const inspectorInfo = d.inspectors.map(function(ins){
        if(ins.timePeriods && ins.timePeriods.length > 0){
          const timeInfo = ins.timePeriods.map(function(period){
            return period.startTime + '-' + period.endTime;
          }).join(',');
          return ins.name + '(' + timeInfo + ')';
        } else if(ins.startTime && ins.endTime){
          return ins.name + '(' + ins.startTime + '-' + ins.endTime + ')';
        } else {
          return ins.name;
        }
      }).join(', ');
      td_inspectors.textContent = inspectorInfo;
    } else {
      td_inspectors.textContent = '';
    }
    r.appendChild(td_inspectors);
    
    Array.from(cols.keys()).sort().forEach(function(c){
      const td = document.createElement('td');
      td.className = 'ng';
      td.textContent = d.ngMap && d.ngMap.get(c) || '0';
      r.appendChild(td);
    });
    const td = document.createElement('td');
    td.textContent = d.rm || '';
    r.appendChild(td);
    b.appendChild(r);
  });
  showEmpty();
}

function showEmpty(){
  document.getElementById('empty').style.display = data.length === 0 ? 'block' : 'none';
}

function select(i){
  document.querySelectorAll('#tb tr').forEach(function(r){r.classList.remove('selected')});
  document.querySelectorAll('#tb tr')[i].classList.add('selected');
  sel = i;
  const d = data[i];
  document.getElementById('pd').value = d.pd.replace(/\//g, '-');
  document.getElementById('on').value = d.on;
  
  if(d.pieces && d.boxes){
    document.getElementById('pieces').value = d.pieces;
    document.getElementById('boxes').value = d.boxes;
    document.getElementById('remainder').value = d.remainder || '';
    document.getElementById('ic').value = d.ic;
  } else {
    document.getElementById('pieces').value = '';
    document.getElementById('boxes').value = '';
    document.getElementById('remainder').value = '';
    document.getElementById('ic').value = d.ic;
  }
  
  document.getElementById('ln').value = d.ln || '';
  document.getElementById('it2').value = d.it2 || '';
  document.getElementById('rm').value = d.rm || '';
  
  setInspectorData(d.inspectors);
  
  updateNG();
  if(d.ngMap){
    items.forEach(function(it, idx){
      const c = document.getElementById('ng_' + idx);
      if(c) c.value = d.ngMap.get(it.code) || '0';
    });
  }
}

async function add(){
  const o = document.getElementById('on').value;
  const t = dailyTranslations[currentDailyLang];
  if(!o){alert(t.alertSelectOrganization); return;}
  
  const pieces = parseInt(document.getElementById('pieces').value) || 0;
  const boxes = parseInt(document.getElementById('boxes').value) || 0;
  const remainder = parseInt(document.getElementById('remainder').value) || 0;
  const totalPieces = (pieces * boxes) + remainder;
  
  if(totalPieces <= 0){
    alert(t.alertEnterInspectionCount);
    return;
  }
  
  const inspectors = getInspectorData();
  if(inspectors.length === 0 || !inspectors.some(function(ins){return ins.name})){
    alert(t.alertEnterInspector);
    return;
  }
  
  let totalMinutes = 0;
  inspectors.forEach(function(inspector){
    if(inspector.timePeriods && inspector.timePeriods.length > 0){
      inspector.timePeriods.forEach(function(period){
        if(period.startTime && period.endTime){
          const startHour = parseInt(period.startTime.split(':')[0]);
          const startMin = parseInt(period.startTime.split(':')[1]);
          const endHour = parseInt(period.endTime.split(':')[0]);
          const endMin = parseInt(period.endTime.split(':')[1]);
          let startMinutes = startHour * 60 + startMin;
          let endMinutes = endHour * 60 + endMin;
          
          totalMinutes += calculateWorkingMinutes(startMinutes, endMinutes);
        }
      });
    }
  });
  
  const m = new Map();
  items.forEach(function(it, i){
    const v = document.getElementById('ng_' + i) && document.getElementById('ng_' + i).value;
    if(v && v !== '0') m.set(it.code, v);
  });
  
  const newData = {
    pd: document.getElementById('pd').value.replace(/-/g, '/'),
    on: o,
    pieces: pieces.toString(),
    boxes: boxes.toString(),
    remainder: remainder.toString(),
    ic: totalPieces.toString(),
    totalTime: totalMinutes.toString(),
    ln: document.getElementById('ln').value || '',
    it2: document.getElementById('it2').value || '',
    inspectors: inspectors,
    ngMap: Object.fromEntries(m),
    rm: document.getElementById('rm').value || '',
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  };
  
  try {
    await db.collection('dailyReports').add(newData);
    clearExceptDate();
    status('æ–°ã—ã„è¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸ');
  } catch(error) {
    console.error('è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
    alert('ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ\n\nã‚¨ãƒ©ãƒ¼è©³ç´°:\n' + error.message);
  }
}

async function update(){
  const t = dailyTranslations[currentDailyLang];
  if(sel < 0){status(t.alertSelectRow); return;}
  const o = document.getElementById('on').value;
  if(!o){alert(t.alertSelectOrganization); return;}
  
  const pieces = parseInt(document.getElementById('pieces').value) || 0;
  const boxes = parseInt(document.getElementById('boxes').value) || 0;
  const remainder = parseInt(document.getElementById('remainder').value) || 0;
  const totalPieces = (pieces * boxes) + remainder;
  
  if(totalPieces <= 0){
    alert(t.alertEnterInspectionCount);
    return;
  }
  
  const inspectors = getInspectorData();
  if(inspectors.length === 0 || !inspectors.some(function(ins){return ins.name})){
    alert(t.alertEnterInspector);
    return;
  }
  
  let totalMinutes = 0;
  inspectors.forEach(function(inspector){
    if(inspector.timePeriods && inspector.timePeriods.length > 0){
      inspector.timePeriods.forEach(function(period){
        if(period.startTime && period.endTime){
          const startHour = parseInt(period.startTime.split(':')[0]);
          const startMin = parseInt(period.startTime.split(':')[1]);
          const endHour = parseInt(period.endTime.split(':')[0]);
          const endMin = parseInt(period.endTime.split(':')[1]);
          let startMinutes = startHour * 60 + startMin;
          let endMinutes = endHour * 60 + endMin;
          
          totalMinutes += calculateWorkingMinutes(startMinutes, endMinutes);
        }
      });
    }
  });
  
  const m = new Map();
  items.forEach(function(it, i){
    const v = document.getElementById('ng_' + i) && document.getElementById('ng_' + i).value;
    if(v && v !== '0') m.set(it.code, v);
  });
  
  const updateData = {
    pd: document.getElementById('pd').value.replace(/-/g, '/'),
    on: o,
    pieces: pieces.toString(),
    boxes: boxes.toString(),
    remainder: remainder.toString(),
    ic: totalPieces.toString(),
    totalTime: totalMinutes.toString(),
    ln: document.getElementById('ln').value || '',
    it2: document.getElementById('it2').value || '',
    inspectors: inspectors,
    ngMap: Object.fromEntries(m),
    rm: document.getElementById('rm').value || ''
  };
  
  try {
    await db.collection('dailyReports').doc(data[sel].id).update(updateData);
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ¼ã‚¿é…åˆ—ã‚‚æ›´æ–°ï¼ˆãƒªã‚¹ãƒŠãƒ¼ã®ç¯„å›²å¤–ã®ãƒ‡ãƒ¼ã‚¿å¯¾å¿œï¼‰
    data[sel] = {
      id: data[sel].id,
      pd: updateData.pd,
      on: updateData.on,
      pieces: updateData.pieces,
      boxes: updateData.boxes,
      remainder: updateData.remainder,
      ic: updateData.ic,
      totalTime: updateData.totalTime,
      ln: updateData.ln,
      it2: updateData.it2,
      inspectors: updateData.inspectors,
      ngMap: m,
      rm: updateData.rm
    };
    
    // ç”»é¢ã‚’å†æç”»
    render();
    
    clearExceptDate();
    status('è¡Œã‚’æ›´æ–°ã—ã¾ã—ãŸ');
  } catch(error) {
    console.error('æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    alert('ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}
async function del(){
  const t = dailyTranslations[currentDailyLang];
  if(sel < 0){status(t.alertSelectDeleteRow); return;}
  if(confirm(t.alertDeleteConfirm)){
    try {
      await db.collection('dailyReports').doc(data[sel].id).delete();
      sel = -1;
      clear();
      status('è¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    } catch(error) {
      console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
      alert('ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }
}

function clearExceptDate(){
  document.getElementById('on').value = '';
  document.getElementById('pieces').value = '';
  document.getElementById('boxes').value = '';
  document.getElementById('remainder').value = '';
  document.getElementById('ic').value = '';
  document.getElementById('ln').value = '';
  document.getElementById('it2').value = '';
  document.getElementById('rm').value = '';
  
  document.getElementById('inspectors').innerHTML = '';
  inspectorCount = 0;
  timePeriodCount = 0;
  addInspector();
  
  updateNG();
  sel = -1;
}

function clear(){
  document.getElementById('pd').value = new Date().toISOString().split('T')[0];
  clearExceptDate();
}

function exp(){
  if(data.length === 0){status('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return;}
  const h = ['ç”Ÿç”£æ—¥ä»˜', 'æ•´ç†No', 'å€‹æ•°', 'ç®±æ•°', 'æ¤œæŸ»æ•°', 'åˆè¨ˆæ¤œæŸ»æ™‚é–“(åˆ†)', 'ãƒ­ãƒƒãƒˆNo', 'æ¤œæŸ»ç¨®é¡', 'æ¤œæŸ»å“¡æƒ…å ±'];
  const nc = Array.from(cols.keys()).sort();
  const ah = h.concat(nc).concat(['å‚™è€ƒ']);
  const r = data.map(function(row){
    const inspectorInfo = row.inspectors ? 
      row.inspectors.map(function(ins){
        if(ins.timePeriods && ins.timePeriods.length > 0){
          const timeInfo = ins.timePeriods.map(function(period){
            return period.startTime + '-' + period.endTime;
          }).join(',');
          return ins.name + '(' + timeInfo + ')';
        } else if(ins.startTime && ins.endTime){
          return ins.name + '(' + ins.startTime + '-' + ins.endTime + ')';
        } else {
          return ins.name;
        }
      }).join('; ') : '';
    const bd = [row.pd || '', row.on || '', row.pieces || '', row.boxes || '', row.ic || '0', row.totalTime || '0', row.ln || '', row.it2 || '', inspectorInfo];
    const nd = nc.map(function(c){return row.ngMap && row.ngMap.get(c) || '0'});
    return bd.concat(nd).concat([row.rm || '']);
  });
  const csv = [ah.join(',')].concat(r.map(function(row){return row.map(function(c){return '"' + c + '"'}).join(',')})).join('\n');
  const b = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], {type: 'text/csv;charset=utf-8'});
  const l = document.createElement('a');
  l.href = URL.createObjectURL(b);
  l.download = 'inspection_data_' + new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5) + '.csv';
  l.click();
  status('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
}

function expBoth(){
  try { exp(); } catch(e){}
  setTimeout(() => { if(window.qrExport) window.qrExport(); }, 300);
}

document.addEventListener('DOMContentLoaded', init);

(function(){
  const CUT_START = 3, CUT_LENGTH = 5, ADMIN_QR = "ADMIN123";
  let baseQR = null, isLocked = false, buffer = "", lastScanIndex = -1;
  let logData = [["Timestamp", "RawQR", "CutQR", "Result", "LockState", "ImageFile", "Mark", "MarkMsg"]];

  const $mode = document.getElementById("qr-mode");
  const $ok = document.getElementById("qr-ok");
  const $ng = document.getElementById("qr-ng");
  const $lockMsg = document.getElementById("qr-lockMsg");
  const $baseDisplay = document.getElementById("qr-baseDisplay");
  const $productImage = document.getElementById("qr-productImage");
  const $imgHint = document.getElementById("qr-imgHint");
  const $lastScanView = document.getElementById("qr-lastScanView");
  const $markMsg = document.getElementById("qr-markMsg");
  const $toast = document.getElementById("qr-toast");
  const $pickDirBtn = document.getElementById("qr-pickDirBtn");
  const $folderInput = document.getElementById("qr-folderInput");

  let imageDirHandle = null;
  const imageMap = new Map();

  const pad = n => String(n).padStart(2, "0");
  function nowString(){ 
    const d = new Date(); 
    return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; 
  }
  function cutQR(qr){ return qr.substr(CUT_START, CUT_LENGTH).replace(/[\s\u3000]+/g, ""); }
  function showOK(){ $ok.style.display = "block"; $ng.style.display = "none"; setTimeout(() => { $ok.style.display = "none"; }, 1500); }
  function showNGPersistent(){ $ok.style.display = "none"; $ng.style.display = "block"; }
  function clearMarksUI(){ $ok.style.display = "none"; $ng.style.display = "none"; }
  function setLock(state){ isLocked = state; $lockMsg.style.display = state ? "block" : "none"; if(!state) clearMarksUI(); }
  function updateBaseDisplay(val){ 
    if(val){ 
      $baseDisplay.classList.remove("qr-placeholder"); 
      $baseDisplay.textContent = val; 
    } else { 
      $baseDisplay.classList.add("qr-placeholder"); 
      $baseDisplay.textContent = "æœªè¨­å®š"; 
    } 
  }
  function csvEscape(s){ s = String(s ?? ""); return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s; }
  function buildCSV(rows){ return rows.map(r => r.map(csvEscape).join(",")).join("\n"); }
  function downloadCSV(rows, baseName = "qr_log"){ 
    const ts = new Date(); 
    const name = `${baseName}_${ts.getFullYear()}${pad(ts.getMonth() + 1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}${pad(ts.getSeconds())}.csv`; 
    const blob = new Blob([buildCSV(rows)], {type: "text/csv;charset=utf-8"}); 
    const url = URL.createObjectURL(blob); 
    const a = document.createElement("a"); 
    a.href = url; 
    a.download = name; 
    a.click(); 
    URL.revokeObjectURL(url); 
  }
  function toast(msg){ $toast.textContent = msg; $toast.style.display = "block"; setTimeout(() => { $toast.style.display = "none"; }, 1800); }
  function updateLastScanView(row){ 
    if(!row){ 
      $lastScanView.textContent = "Last: -"; 
      return; 
    } 
    const [ts, raw, cut, res] = [row[0], row[1], row[2], row[3]]; 
    $lastScanView.innerHTML = `Last: <code>${ts}</code> | RawQR=<code>${csvEscape(raw)}</code> | CutQR=<code>${csvEscape(cut)}</code> | Result=<code>${res}</code>`; 
  }

  async function pickImageDirectory(){
    if(!window.showDirectoryPicker){ 
      alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ•ã‚©ãƒ«ãƒ€é¸æŠAPIã«æœªå¯¾å¿œã§ã™ã€‚"); 
      return; 
    }
    try{ 
      imageDirHandle = await window.showDirectoryPicker({id: "qr-image-dir", mode: "read"}); 
      $imgHint.textContent = "ãƒ•ã‚©ãƒ«ãƒ€é¸æŠæ¸ˆã¿:åŸºæº–å€¤ã¨åŒåã®ç”»åƒã‚’è¡¨ç¤ºã—ã¾ã™"; 
    }catch(e){ 
      console.warn(e); 
    }
  }
  
  async function findImageURLByBase(base){
    if(imageDirHandle){
      const exts = [".png", ".jpg", ".jpeg", ".webp", ".bmp", ".gif"];
      for await (const entry of imageDirHandle.values()){
        if(entry.kind === "file"){
          const nameLower = entry.name.toLowerCase();
          if(exts.some(ext => nameLower === (base.toLowerCase() + ext))){
            const file = await entry.getFile();
            return { url: URL.createObjectURL(file), name: entry.name };
          }
        }
      }
    }
    for(const [name, url] of imageMap.entries()){
      const lower = name.toLowerCase();
      if(lower.startsWith(base.toLowerCase() + ".")) return { url, name };
    }
    return null;
  }
  
  function showImage(url){ 
    if(url){ 
      $productImage.src = url; 
      $productImage.style.display = "block"; 
      $imgHint.style.display = "none"; 
    } 
  }

  document.addEventListener("keydown", e => {
    if(e.key === "Enter"){ 
      const qr = buffer.trim(); 
      buffer = ""; 
      if(qr.length > 0) processQR(qr); 
    }
    else if(e.key.length === 1){ 
      buffer += e.key; 
    }
  });

  async function processQR(qrRaw){
    const now = nowString();
    const sliced = cutQR(qrRaw);

    if(!baseQR){
      baseQR = sliced; 
      updateBaseDisplay(baseQR); 
      $mode.textContent = `ç…§åˆãƒ¢ãƒ¼ãƒ‰(åŸºæº–QR: ${baseQR})`;
      let imgName = "";
      try{ 
        const found = await findImageURLByBase(baseQR); 
        if(found){ 
          showImage(found.url); 
          imgName = found.name; 
        } else { 
          $productImage.style.display = "none"; 
          $imgHint.style.display = "block"; 
          $imgHint.textContent = `ç”»åƒæœªæ¤œå‡º:${baseQR}.*`; 
        } 
      }catch(e){ 
        console.warn(e); 
      }
      logData.push([now, qrRaw, sliced, "SET_BASE", isLocked ? "LOCKED" : "UNLOCK", imgName, "", ""]);
      updateLastScanView(null); 
      lastScanIndex = -1;
      return;
    }

    if(isLocked){
      if(qrRaw === ADMIN_QR){
        setLock(false); 
        showOK(); 
        $mode.textContent = "è§£é™¤ã•ã‚Œã¾ã—ãŸã€‚ç…§åˆã‚’å†é–‹ã—ã¾ã™ã€‚";
        logData.push([now, qrRaw, sliced, "UNLOCK_BY_ADMIN", "UNLOCK", "", "", ""]);
        updateLastScanView(null); 
        lastScanIndex = -1;
      }else{
        showNGPersistent();
        logData.push([now, qrRaw, sliced, "LOCK_REJECT", "LOCKED", "", "", ""]);
        updateLastScanView(null); 
        lastScanIndex = -1;
      }
      return;
    }

    const judgedOK = (sliced === baseQR);
    if(judgedOK){
      showOK(); 
      logData.push([now, qrRaw, sliced, "OK", "UNLOCK", "", "", ""]);
    }else{
      showNGPersistent(); 
      setLock(true); 
      $mode.textContent = "NG!ç®¡ç†è€…QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„";
      logData.push([now, qrRaw, sliced, "NG", "LOCKED", "", "", ""]);
    }
    lastScanIndex = logData.length - 1; 
    updateLastScanView(logData[lastScanIndex]);
  }

  document.getElementById("qr-markBtn").addEventListener("click", () => {
    let idx = (lastScanIndex > 0) ? lastScanIndex : findLatestScannableIndex();
    if(idx < 0){ 
      toast("å¯¾è±¡ã¨ãªã‚‹ç›´è¿‘ã®èª­ã¿å–ã‚Šãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"); 
      return; 
    }
    const msg = ($markMsg.value || "").trim();
    logData[idx][6] = "1";
    logData[idx][7] = msg;
    toast("Marked: ç›´è¿‘ã®èª­ã¿å–ã‚Šãƒ­ã‚°ã«ãƒãƒ¼ã‚­ãƒ³ã‚°ã—ã¾ã—ãŸã€‚");
  });
  
  function findLatestScannableIndex(){
    for(let i = logData.length - 1; i >= 1; i--){ 
      const res = logData[i][3]; 
      if(res === "OK" || res === "NG") return i; 
    }
    return -1;
  }

  document.getElementById("qr-resetBtn").addEventListener("click", () => {
    baseQR = null; 
    setLock(false); 
    clearMarksUI(); 
    updateBaseDisplay(null);
    $productImage.style.display = "none"; 
    $imgHint.style.display = "block"; 
    $imgHint.textContent = "ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™";
    $mode.textContent = "åŸºæº–QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„";
    logData.push([nowString(), "-", "-", "RESET", "UNLOCK", "", "", ""]);
    updateLastScanView(null); 
    lastScanIndex = -1;
  });
  
  document.getElementById("qr-saveBtn").addEventListener("click", () => downloadCSV(logData, "qr_log"));
  document.getElementById("qr-exitBtn").addEventListener("click", () => { downloadCSV(logData, "qr_log"); window.close(); });

  $pickDirBtn.addEventListener("click", pickImageDirectory);
  $folderInput.addEventListener("change", e => {
    imageMap.clear();
    const files = Array.from(e.target.files || []);
    for(const f of files){ imageMap.set(f.name, URL.createObjectURL(f)); }
    $imgHint.textContent = "ç”»åƒã‚’èª­ã¿è¾¼ã¿æ¸ˆã¿:åŸºæº–å€¤ã¨åŒåã®ç”»åƒã‚’è¡¨ç¤ºã—ã¾ã™";
  });

  window.qrExport = function(){
    try { downloadCSV(logData, "qr_log"); } catch(e){}
  };
})();
</script>
</body>
</html>
