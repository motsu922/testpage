<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•°å¸¸å±¥æ­´å…¥åŠ›ãƒ„ãƒ¼ãƒ«ï¼ˆFirebaseé€£æºç‰ˆï¼‰</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Hiragino Sans',sans-serif;background:#f5f5f5}
  .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  .header h1{font-size:1.5rem;margin-bottom:5px}
  .container{max-width:900px;margin:0 auto;padding:10px}
  .tabs{display:flex;background:#fff;margin:15px 0 0;border-radius:8px 8px 0 0;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,.1)}
  .tab{flex:1;padding:15px;text-align:center;cursor:pointer;background:#f8f9fa;border:none;font-size:1rem;font-weight:bold;transition:.3s;color:#666}
  .tab.active{background:#fff;color:#667eea;border-bottom:3px solid #667eea}
  .tab-content{display:none;background:#fff;padding:20px;border-radius:0 0 8px 8px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  .tab-content.active{display:block}
  .form-group{margin-bottom:16px}
  .form-group label{display:block;margin-bottom:8px;font-weight:bold;color:#333;font-size:.95rem}
  .form-group input,.form-group textarea,.form-group select{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:6px;font-size:1rem;transition:border-color .3s}
  .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:#667eea}
  .form-group textarea{min-height:100px;resize:vertical}
  .time-group{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .photo-upload{border:2px dashed #e0e0e0;border-radius:6px;padding:20px;text-align:center;cursor:pointer;transition:.3s}
  .photo-upload:hover{border-color:#667eea;background:#f8f9ff}
  .photo-upload input[type=file]{display:none}
  .photo-preview{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-top:15px}
  .photo-item{position:relative;aspect-ratio:1;border-radius:6px;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,.1)}
  .photo-item img{width:100%;height:100%;object-fit:cover}
  .photo-item .remove-btn{position:absolute;top:5px;right:5px;background:rgba(255,59,48,.9);color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:14px;line-height:1}
  .btn{width:100%;padding:14px;border:none;border-radius:6px;font-size:1rem;font-weight:bold;cursor:pointer;transition:.3s;margin-top:10px}
  .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
  .btn-secondary{background:#6c757d;color:#fff}
  .btn-export{background:#28a745;color:#fff}

  /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
  .filter-panel{background:#f8f9ff;border:2px solid #667eea;border-radius:8px;padding:16px;margin-bottom:16px;}
  .filter-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
  .filter-title{font-size:1.05rem;font-weight:bold;color:#667eea;display:flex;align-items:center;gap:8px;}
  .filter-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:12px;}
  .filter-date-group{display:flex;gap:8px;align-items:center;}
  .filter-date-group input{flex:1;}
  .filter-date-group .date-btn{padding:8px 12px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:6px;cursor:pointer;font-weight:bold;font-size:.85rem;white-space:nowrap;}
  .filter-date-group .date-btn:hover{background:#667eea;color:#fff;}
  .filter-date-group .date-btn.active{background:#667eea;color:#fff;}
  .filter-actions{display:flex;gap:8px;}
  .filter-actions button{padding:10px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;font-size:.9rem;}
  .btn-filter-apply{background:#667eea;color:#fff;}
  .btn-filter-clear{background:#e0e0e0;color:#333;}
  .filter-result-count{margin-top:12px;padding:10px;background:#fff;border-radius:6px;text-align:center;color:#666;font-size:.9rem;}
  .filter-result-count strong{color:#667eea;}

  .history-controls{display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap}
  .view-toggle{display:flex;gap:5px}
  .view-toggle button{padding:8px 12px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:6px;cursor:pointer;font-weight:bold}
  .view-toggle button.active{background:#667eea;color:#fff}

  /* ã‚«ãƒ¼ãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
  .card-view{display:grid;gap:16px;}
  .anomaly-card{
    position:relative;background:#fff;border-radius:8px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.1);
    border-left:4px solid #667eea;display:grid;grid-template-columns:200px 1fr 180px;gap:20px;align-items:start;
  }
  .anomaly-card.complete{border-left-color:#28a745}

  .card-left{display:flex;flex-direction:column;gap:10px;}
  .card-id{font-size:1.2rem;font-weight:700;color:#667eea;margin-bottom:4px;}
  .card-status{padding:4px 12px;border-radius:12px;font-size:.85rem;font-weight:700;text-align:center;width:fit-content;}
  .status-pending{background:#fff3cd;color:#856404}
  .status-complete{background:#d4edda;color:#155724}

  .card-meta{display:flex;flex-direction:column;gap:6px;font-size:.9rem;}
  .card-meta-item{display:flex;flex-direction:column;gap:2px;}
  .card-meta-label{font-size:.75rem;color:#888;text-transform:uppercase;letter-spacing:0.5px;}
  .card-meta-value{color:#333;font-weight:500;}

  .card-center{display:flex;flex-direction:column;gap:12px;min-width:0;}
  .card-content-section{display:flex;flex-direction:column;gap:6px;}
  .card-content-label{font-size:.85rem;font-weight:bold;color:#667eea;display:flex;align-items:center;gap:6px;}
  .card-content-text{color:#333;line-height:1.6;font-size:.95rem;}

  .card-tech-info{
    background:#f8f9ff;padding:12px;border-radius:6px;border-left:3px solid #667eea;
    display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:.85rem;
  }
  .tech-info-item{display:flex;gap:8px;}
  .tech-info-label{color:#666;font-weight:600;}
  .tech-info-value{color:#333;}

  .card-right{display:flex;flex-direction:column;gap:12px;}
  .card-photos-compact{display:grid;grid-template-columns:repeat(2, 1fr);gap:6px;}
  .photo-thumb-compact{aspect-ratio:1;border-radius:6px;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,.1);cursor:pointer;transition:transform .2s;}
  .photo-thumb-compact:hover{transform:scale(1.05);}
  .photo-thumb-compact img{width:100%;height:100%;object-fit:cover;}
  .photo-count-badge{text-align:center;font-size:.85rem;color:#666;margin-top:4px;}

  .action-btns{display:flex;flex-direction:column;gap:6px;}
  .btn-small{padding:8px 12px;border:none;border-radius:4px;cursor:pointer;font-size:.85rem;font-weight:600;transition:.2s;}
  .btn-edit{background:#ffc107;color:#000}
  .btn-edit:hover{background:#ffb300}
  .btn-delete{background:#dc3545;color:#fff}
  .btn-delete:hover{background:#c82333}

  /* åœæ­¢æ™‚é–“ */
  .stop-badge{position:absolute;right:16px;bottom:16px;padding:6px 12px;border-radius:14px;font-weight:700;font-size:.9rem;color:#fff;background:#1976d2;box-shadow:0 2px 6px rgba(0,0,0,.15);}
  .stop-badge.warn{background:#f57c00;}
  .stop-badge.danger{background:#d32f2f;}

  @media (max-width:900px){
    .anomaly-card{grid-template-columns:1fr;gap:16px;}
    .card-right{flex-direction:row;justify-content:space-between;}
    .card-photos-compact{flex:1;max-width:200px;}
    .action-btns{flex:1;}
    .card-tech-info{grid-template-columns:1fr;}
    .filter-grid{grid-template-columns:1fr;}
    .filter-date-group{flex-direction:column;align-items:stretch;}
    .filter-date-group .date-btn{width:100%;}
    .stop-badge{right:16px;bottom:16px;}
  }
  @media (max-width:600px){
    .time-group{grid-template-columns:1fr}
    table{font-size:.85rem}
    th,td{padding:8px}
    .card-tech-info{grid-template-columns:1fr;}
  }

  /* ãƒ†ãƒ¼ãƒ–ãƒ« */
  .table-view{overflow-x:auto;display:none}
  .table-view.active{display:block}
  table{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 1px 6px rgba(0,0,0,.08)}
  th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #eaeaea}
  th{background:#667eea;color:#fff;font-weight:bold;position:sticky;top:0}
  tr:hover{background:#f8f9ff}
  .empty-state{text-align:center;padding:36px 20px;color:#999}
  .empty-state-icon{font-size:2.5rem;margin-bottom:10px}

  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
  .modal.active{display:flex}
  .modal-content{background:#fff;padding:20px;border-radius:8px;max-width:680px;width:95%;max-height:90vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .modal-title{font-size:1.1rem;font-weight:bold;margin-bottom:10px;color:#333}
  .edit-tabs{display:flex;gap:8px;margin:8px 0 16px}
  .edit-tab{flex:1;padding:10px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:6px;cursor:pointer;font-weight:bold}
  .edit-tab.active{background:#667eea;color:#fff}
  .edit-pane .form-group{margin-bottom:12px;}
  .modal-actions{display:flex;gap:10px;margin-top:10px}
  .btn-cancel{background:#9e9e9e;color:#fff}

  /* ã‚µã‚¤ãƒ³ã‚¤ãƒ³ */
  #authGate{position:fixed;inset:0;background:#f5f5f5;display:flex;align-items:center;justify-content:center;z-index:2000}
  #authCard{background:#fff;max-width:380px;width:92%;padding:24px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
  #signOutBtn{position:fixed;right:12px;top:12px;background:#ef5350;color:#fff;border:none;border-radius:6px;padding:8px 12px;cursor:pointer;z-index:1500}

  /* ãƒ¯ãƒ¼ãƒ‰å€™è£œãƒ»é¡ä¼¼æ¡ˆä»¶ï¼ˆæ—¢å­˜ï¼‰ */
  .word-suggestions{position:relative;}
  .word-suggestion-box{position:absolute;z-index:100;background:#fff;border:2px solid #667eea;border-radius:8px;padding:10px;max-height:300px;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,.15);display:none;width:100%;margin-top:5px;}
  .word-suggestion-box.active{display:block;}
  .word-suggestion-header{font-size:.85rem;color:#667eea;font-weight:bold;margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid #e0e0e0;}
  .word-tag{display:inline-block;background:#f0f7ff;color:#667eea;padding:6px 12px;margin:3px;border-radius:16px;cursor:pointer;font-size:.85rem;transition:.2s;border:1px solid #e3f2fd;}
  .word-tag:hover{background:#667eea;color:#fff;transform:translateY(-2px);box-shadow:0 2px 8px rgba(102,126,234,.3);}

  .similar-cases-box{background:#fff4e6;border:2px solid #f57c00;border-radius:8px;padding:15px;margin-bottom:20px;display:none;}
  .similar-cases-box.active{display:block;}
  .similar-cases-header{color:#f57c00;font-weight:bold;margin-bottom:15px;font-size:1rem;display:flex;align-items:center;gap:8px;}
  .similar-case-item{background:#fff;border-left:3px solid #f57c00;border-radius:6px;padding:12px;margin-bottom:10px;}
  .similar-case-item:last-child{margin-bottom:0;}
  .similar-case-date{font-weight:bold;color:#f57c00;margin-bottom:8px;font-size:.95rem;}
  .similar-case-content{font-size:.9rem;color:#333;line-height:1.5;margin-bottom:8px;}
  .similar-case-tech{margin-top:8px;padding-top:8px;border-top:1px solid #ffe0b2;font-size:.9rem;color:#666;}
  .similar-case-tech strong{color:#f57c00;}
  .show-more-btn{width:100%;padding:10px;background:#fff;color:#f57c00;border:2px solid #f57c00;border-radius:6px;font-weight:bold;cursor:pointer;transition:.2s;margin-top:10px;}
  .show-more-btn:hover{background:#f57c00;color:#fff;}
  .similar-photos{margin-top:8px;display:grid;grid-template-columns:repeat(4,1fr);gap:6px;}
  .similar-photos .thumb{aspect-ratio:1;overflow:hidden;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,.1);cursor:pointer;}
  .similar-photos .thumb img{width:100%;height:100%;object-fit:cover;}
</style>
</head>
<body>
  <button id="signOutBtn" style="display:none;">ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ</button>

  <div id="authGate">
    <div id="authCard">
      <h2 style="margin-bottom:10px;color:#667eea;">ğŸ” ã‚µã‚¤ãƒ³ã‚¤ãƒ³</h2>
      <p style="color:#666;margin-bottom:15px;">ç¤¾å†…ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
      <div class="form-group">
        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="email" id="authEmail" placeholder="user@miyama-unitec.co.jp">
      </div>
      <div class="form-group">
        <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="authPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <button class="btn btn-primary" id="authLoginBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <p id="authMsg" style="color:#c62828;margin-top:10px;"></p>
    </div>
  </div>

  <div class="header">
    <h1>ğŸ“‹ ç•°å¸¸å±¥æ­´å…¥åŠ›ãƒ„ãƒ¼ãƒ«</h1>
    <p>Firebaseé€£æºç‰ˆï¼ˆAuth / Firestore / Storageï¼‰</p>
  </div>

  <div class="container" style="display:none" id="appRoot">
    <div class="tabs">
      <button class="tab active" data-tab="manufacturing">è£½é€ å…¥åŠ›</button>
      <button class="tab" data-tab="technical">æŠ€è¡“å…¥åŠ›</button>
      <button class="tab" data-tab="quality">å“è³ªå…¥åŠ›</button><!-- â˜… æ–°è¦ã‚¿ãƒ– -->
      <button class="tab" data-tab="history">å±¥æ­´</button>
      <button class="tab" data-tab="master">âš™ï¸ ç®¡ç†</button>
    </div>

    <!-- è£½é€ å…¥åŠ› -->
    <div id="manufacturing" class="tab-content active">
      <h2 style="margin-bottom:16px;color:#667eea;">è£½é€ éƒ¨é–€ - ç•°å¸¸å ±å‘Š</h2>
      <form id="manufacturingForm">
        <div style="background:#f0f7ff;padding:15px;border-radius:6px;margin-bottom:14px;">
          <h3 style="color:#667eea;margin-bottom:12px;font-size:1.05rem;">ğŸ“… ã„ã¤</h3>
          <div class="form-group">
            <label>ç™ºç”Ÿæ—¥ *</label>
            <div style="display:flex;gap:10px;">
              <input type="date" id="occurrenceDate" required style="flex:1;">
              <button type="button" class="btn btn-secondary" style="width:auto;padding:10px 16px;margin:0;background:#17a2b8;" id="btnNowDate">ğŸ“… NOW</button>
            </div>
          </div>
          <div class="form-group">
            <label>æ™‚åˆ»</label>
            <div class="time-group">
              <div>
                <label style="font-weight:normal;font-size:.9rem;">ç™ºç”Ÿæ™‚åˆ»</label>
                <div style="display:flex;gap:5px;">
                  <input type="time" id="occurrenceTime" style="flex:1;">
                  <button type="button" class="btn btn-secondary" style="width:auto;padding:6px 10px;margin:0;font-size:.85rem;background:#17a2b8;" data-now="occurrenceTime">NOW</button>
                </div>
              </div>
              <div>
                <label style="font-weight:normal;font-size:.9rem;">å†é–‹æ™‚åˆ»</label>
                <div style="display:flex;gap:5px;">
                  <input type="time" id="restartTime" style="flex:1;">
                  <button type="button" class="btn btn-secondary" style="width:auto;padding:6px 10px;margin:0;font-size:.85rem;background:#17a2b8;" data-now="restartTime">NOW</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="background:#fff4e6;padding:15px;border-radius:6px;margin-bottom:14px;">
          <h3 style="color:#f57c00;margin-bottom:12px;font-size:1.05rem;">ğŸ“ ã©ã“ã§</h3>
          <div class="form-group"><label>éƒ¨ç½² *</label><select id="department" required></select></div>
          <div class="form-group"><label>ãƒ©ã‚¤ãƒ³å *</label><select id="lineName" required><option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option></select></div>
          <div class="form-group"><label>å‡¦ç½®è€… *</label><select id="handler" required><option value="">éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„</option></select></div>
        </div>

        <div style="background:#f3e5f5;padding:15px;border-radius:6px;margin-bottom:14px;">
          <h3 style="color:#8e24aa;margin-bottom:12px;font-size:1.05rem;">ğŸ”¢ æ•´ç†No</h3>
          <div class="form-group word-suggestions">
            <label>æ•´ç†No *</label>
            <input type="text" id="serialNo" required placeholder="ä¾‹:6769" list="serialNoList">
            <datalist id="serialNoList"></datalist>
            <div id="serialNoInfo" style="margin-top:8px;padding:8px;background:#f3e5f5;border-radius:4px;font-size:.85rem;color:#8e24aa;display:none;">
              <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ:</strong> ã“ã®æ•´ç†Noã®éå»ãƒ‡ãƒ¼ã‚¿: <span id="serialNoCount">0</span>ä»¶
            </div>
          </div>
        </div>

        <div style="background:#e8f5e9;padding:15px;border-radius:6px;margin-bottom:14px;">
          <h3 style="color:#2e7d32;margin-bottom:12px;font-size:1.05rem;">ğŸ“ ä½•ãŒã‚ã£ãŸ</h3>
          <div class="form-group word-suggestions">
            <label>ç•°å¸¸å†…å®¹ *</label>
            <textarea id="anomalyContent" required></textarea>
            <div id="anomalyWordSuggestions" class="word-suggestion-box">
              <div class="word-suggestion-header">ğŸ’¡ ã‚ˆãä½¿ã‚ã‚Œã‚‹è¡¨ç¾ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ï¼‰</div>
              <div id="anomalyWords"></div>
            </div>
          </div>
          <div class="form-group word-suggestions">
            <label>å¯¾å¿œå†…å®¹ *</label>
            <textarea id="actionTaken" required></textarea>
            <div id="actionWordSuggestions" class="word-suggestion-box">
              <div class="word-suggestion-header">ğŸ’¡ ã‚ˆãä½¿ã‚ã‚Œã‚‹è¡¨ç¾ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ï¼‰</div>
              <div id="actionWords"></div>
            </div>
          </div>
          <div class="form-group"><label>é¡ã‚Š *</label>
            <select id="traceback" required><option value="">é¸æŠ</option><option value="æœ‰">æœ‰</option><option value="ç„¡">ç„¡</option></select>
          </div>

          <div class="form-group"><label>æŠ€è¡“è¦è«‹ *</label>
            <select id="techRequest" required>
              <option value="">é¸æŠ</option><option value="è¦è«‹">æŠ€è¡“è¦è«‹ã‚ã‚Š</option><option value="å®Œçµ">è£½é€ ã§å®Œçµ</option>
            </select>
          </div>

          <!-- â˜… è¿½åŠ ï¼šå“è³ªè¦è«‹ -->
          <div class="form-group"><label>å“è³ªè¦è«‹ *</label>
            <select id="qaRequest" required>
              <option value="">é¸æŠ</option>
              <option value="è¦è«‹">å“è³ªè¦è«‹ã‚ã‚Š</option>
              <option value="ç„¡">ä¸è¦</option>
            </select>
          </div>

          <button type="button" id="btnShowPastOnMfg" class="btn btn-secondary" style="background:#1976d2;">éå»ã®ç•°å¸¸å±¥æ­´</button>

          <div class="form-group">
            <label>å†™çœŸ</label>
            <div class="photo-upload" onclick="document.getElementById('mfgPhotos').click()">
              <div style="font-size:2rem;">ğŸ“¸</div><p>å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</p>
              <input type="file" id="mfgPhotos" accept="image/*" multiple>
            </div>
            <div id="mfgPhotoPreview" class="photo-preview"></div>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
      </form>

      <div id="mfgSimilarBox" class="similar-cases-box" style="margin-top:14px;">
        <div class="similar-cases-header">ğŸ” éå»ã®ç•°å¸¸å±¥æ­´</div>
        <div id="mfgSimilarContent"></div>
        <button type="button" id="mfgShowMore" class="show-more-btn" style="display:none;">ã‚‚ã£ã¨è¡¨ç¤º</button>
      </div>
    </div>

    <!-- æŠ€è¡“å…¥åŠ› -->
    <div id="technical" class="tab-content">
      <h2 style="margin-bottom:16px;color:#667eea;">æŠ€è¡“éƒ¨é–€ - è¿½åŠ å…¥åŠ›</h2>
      <div class="form-group">
        <label>å¯¾è±¡ã®æ¡ˆä»¶é¸æŠ *</label>
        <select id="selectSerialNo"><option value="">æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„</option></select>
      </div>

      <button type="button" id="btnShowPastOnTech" class="btn btn-secondary" style="background:#1976d2;margin-bottom:10px;">éå»ã®ç•°å¸¸å±¥æ­´</button>

      <div id="similarCasesBox" class="similar-cases-box">
        <div class="similar-cases-header">ğŸ” åŒã˜æ•´ç†Noã®éå»å¯¾å¿œäº‹ä¾‹</div>
        <div id="similarCasesContent"></div>
        <button type="button" id="showMoreCases" class="show-more-btn" style="display:none;">ä»–ã®é¡ä¼¼æ¡ˆä»¶ã‚’è¡¨ç¤º</button>
      </div>

      <div id="selectedDataDisplay" style="background:#f8f9ff;padding:15px;border-radius:6px;margin-bottom:14px;display:none;">
        <h3 style="color:#667eea;margin-bottom:8px;">è£½é€ éƒ¨é–€å…¥åŠ›å†…å®¹</h3>
        <div id="displayContent"></div>
      </div>

      <form id="technicalForm">
        <div class="form-group"><label>æŠ€è¡“å‡¦ç½®è€… *</label><input type="text" id="techHandler"></div>
        <div class="form-group">
          <label>ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚° *</label>
          <select id="discoveryTiming" required>
            <option value="">é¸æŠ</option>
            <option value="é‹è»¢ä¸­">é‹è»¢ä¸­</option>
            <option value="é ­å‡ºã—">é ­å‡ºã—</option>
            <option value="åˆç‰©">åˆç‰©</option>
            <option value="çµ‚ç‰©">çµ‚ç‰©</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>
        <div class="form-group" id="previousCheckGroup" style="display:none;">
          <label>å‰å›çµ‚ç‰©ç¢ºèªï¼ˆç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒåˆç‰©ã®å ´åˆï¼‰</label>
          <select id="previousCheck">
            <option value="">é¸æŠ</option>
            <option value="ä¸è¦">ä¸è¦</option>
            <option value="æœª">æœª</option>
            <option value="ç¢ºèªæ¸ˆ">ç¢ºèªæ¸ˆ</option>
          </select>
        </div>
        <div class="form-group"><label>å‘½æ•°æœ‰ç„¡ *</label><select id="lifespan"><option value="">é¸æŠ</option><option value="æœ‰">æœ‰</option><option value="ç„¡">ç„¡</option></select></div>
        <div class="form-group">
          <label>å‘½æ•°åˆ°é” *</label>
          <select id="lifespanReached" required>
            <option value="">é¸æŠ</option>
            <option value="è‡³">è‡³</option>
            <option value="ä¸é”">ä¸é”</option>
          </select>
        </div>
        <div class="form-group"><label>ä¿å…¨å˜ä½</label><input type="text" id="maintenanceUnit"></div>
        <div class="form-group"><label>ä½•ãŒæ‚ªãã©ã†ã—ãŸ</label><textarea id="rootCauseAction"></textarea></div>
        <div class="form-group"><label>å†ç™ºã‹æ–°è¦ã‹ *</label><select id="recurrenceType"><option value="">é¸æŠ</option><option value="å†ç™º">å†ç™º</option><option value="æ–°è¦">æ–°è¦</option></select></div>
        <div class="form-group">
          <label>æš«å®š *</label>
          <select id="affirmation" required>
            <option value="">é¸æŠ</option>
            <option value="æœ‰">æœ‰</option>
            <option value="ç„¡">ç„¡</option>
          </select>
        </div>
        <div class="form-group">
          <label>å†™çœŸ</label>
          <div class="photo-upload" onclick="document.getElementById('techPhotos').click()">
            <div style="font-size:2rem;">ğŸ“¸</div><p>å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</p>
            <input type="file" id="techPhotos" accept="image/*" multiple>
          </div>
          <div id="techPhotoPreview" class="photo-preview"></div>
        </div>
        <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
      </form>
    </div>

    <!-- â˜… å“è³ªå…¥åŠ› -->
    <div id="quality" class="tab-content">
      <h2 style="margin-bottom:16px;color:#667eea;">å“è³ªéƒ¨é–€ - è¿½åŠ å…¥åŠ›</h2>

      <div class="form-group">
        <label>å¯¾è±¡ã®æ¡ˆä»¶é¸æŠ *</label>
        <select id="selectSerialNoQA">
          <option value="">æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>

      <form id="qualityForm" style="margin-top:10px;">
        <div class="form-group">
          <label>åˆ¤æ–­ *</label>
          <select id="qaJudge" required>
            <option value="">é¸æŠ</option>
            <option value="ä¿ç•™">ä¿ç•™</option>
            <option value="å»ƒæ£„">å»ƒæ£„</option>
            <option value="æµå‹•">æµå‹•</option>
            <option value="é¸åˆ¥">é¸åˆ¥</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>
        <div class="form-group">
          <label>åˆ¤å®šè€… *</label>
          <input type="text" id="qaJudgeBy" required>
        </div>
        <div class="form-group">
          <label>å‚™è€ƒ</label>
          <textarea id="qaNote" placeholder="å¿…è¦ã«å¿œã˜ã¦è¨˜è¼‰"></textarea>
        </div>

        <div class="form-group">
          <label>å†™çœŸï¼ˆå“è³ªï¼‰</label>
          <div class="photo-upload" onclick="document.getElementById('qaPhotos').click()">
            <div style="font-size:2rem;">ğŸ“¸</div><p>å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</p>
            <input type="file" id="qaPhotos" accept="image/*" multiple>
          </div>
          <div id="qaPhotoPreview" class="photo-preview"></div>
        </div>

        <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
      </form>
    </div>

    <!-- å±¥æ­´ -->
    <div id="history" class="tab-content">
      <h2 style="margin-bottom:16px;color:#667eea;">ç•°å¸¸å±¥æ­´</h2>

      <div class="filter-panel">
        <div class="filter-header">
          <div class="filter-title">ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¤œç´¢</div>
        </div>
        <div class="filter-grid">
          <div class="form-group" style="margin-bottom:0;">
            <label style="font-size:.9rem;margin-bottom:6px;">éƒ¨ç½²</label>
            <select id="filterDepartment">
              <option value="">ã™ã¹ã¦</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom:0;">
            <label style="font-size:.9rem;margin-bottom:6px;">æ•´ç†No</label>
            <input type="text" id="filterSerialNo" placeholder="éƒ¨åˆ†ä¸€è‡´æ¤œç´¢">
          </div>
          <div class="form-group" style="margin-bottom:0;">
            <label style="font-size:.9rem;margin-bottom:6px;">ãƒ©ã‚¤ãƒ³å</label>
            <select id="filterLine">
              <option value="">ã™ã¹ã¦</option>
            </select>
          </div>
        </div>
        <div class="form-group" style="margin-bottom:0;margin-top:12px;">
          <label style="font-size:.9rem;margin-bottom:6px;">ç™ºç”Ÿæ—¥</label>
          <div class="filter-date-group">
            <button type="button" class="date-btn" id="btnFilterYesterday">æ˜¨æ—¥</button>
            <button type="button" class="date-btn" id="btnFilterToday">ä»Šæ—¥</button>
            <input type="date" id="filterDateFrom" placeholder="é–‹å§‹æ—¥">
            <span style="color:#666;">ã€œ</span>
            <input type="date" id="filterDateTo" placeholder="çµ‚äº†æ—¥">
          </div>
        </div>
        <div class="filter-actions">
          <button type="button" class="btn-filter-apply" id="btnApplyFilter">æ¤œç´¢</button>
          <button type="button" class="btn-filter-clear" id="btnClearFilter">ã‚¯ãƒªã‚¢</button>
        </div>
        <div class="filter-result-count" id="filterResultCount" style="display:none;">
          <strong>0</strong> ä»¶ã®å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ
        </div>
      </div>

      <div class="history-controls">
        <div class="view-toggle"><button class="active" data-view="card">ã‚«ãƒ¼ãƒ‰</button><button data-view="table">ãƒ†ãƒ¼ãƒ–ãƒ«</button></div>
        <button class="btn btn-secondary" style="flex:1;" id="btnImport">ğŸ“¤ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        <button class="btn btn-export" style="flex:1;" id="btnExport">ğŸ“¥ CSVå‡ºåŠ›</button>
      </div>
      <div id="cardView" class="card-view"></div>
      <div id="tableView" class="table-view"></div>
    </div>

    <!-- ç®¡ç† -->
    <div id="master" class="tab-content">
      <h2 style="margin-bottom:16px;color:#667eea;">âš™ï¸ ãƒã‚¹ã‚¿ç®¡ç†</h2>
      <div style="background:#fff;padding:18px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:16px;">
        <h3 style="color:#667eea;margin-bottom:10px;">éƒ¨ç½²ç®¡ç†</h3>
        <div style="display:flex;gap:10px;margin-bottom:12px;">
          <input type="text" id="newDepartment" placeholder="æ–°ã—ã„éƒ¨ç½²å" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button class="btn btn-primary" style="width:auto;padding:10px 20px;margin:0;" id="btnAddDept">è¿½åŠ </button>
        </div>
        <div id="departmentList" style="display:grid;gap:8px;"></div>
      </div>

      <div style="background:#fff;padding:18px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:16px;">
        <h3 style="color:#f57c00;margin-bottom:10px;">ãƒ©ã‚¤ãƒ³åç®¡ç†</h3>
        <div class="form-group"><label>å¯¾è±¡éƒ¨ç½²</label><select id="lineManageDept"><option value="">éƒ¨ç½²ã‚’é¸æŠ</option></select></div>
        <div style="display:flex;gap:10px;margin-bottom:12px;">
          <input type="text" id="newLine" placeholder="æ–°ã—ã„ãƒ©ã‚¤ãƒ³å" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button class="btn btn-primary" style="width:auto;padding:10px 20px;margin:0;background:#f57c00;" id="btnAddLine">è¿½åŠ </button>
        </div>
        <div id="lineList" style="display:grid;gap:8px;"></div>
      </div>

      <div style="background:#fff;padding:18px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);">
        <h3 style="color:#2e7d32;margin-bottom:10px;">å‡¦ç½®è€…ç®¡ç†</h3>
        <div class="form-group"><label>å¯¾è±¡éƒ¨ç½²</label><select id="handlerManageDept"><option value="">éƒ¨ç½²ã‚’é¸æŠ</option></select></div>
        <div style="display:flex;gap:10px;margin-bottom:12px;">
          <input type="text" id="newHandler" placeholder="æ–°ã—ã„å‡¦ç½®è€…å" style="flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:6px;">
          <button class="btn btn-primary" style="width:auto;padding:10px 20px;margin:0;background:#2e7d32;" id="btnAddHandler">è¿½åŠ </button>
        </div>
        <div id="handlerList" style="display:grid;gap:8px;"></div>
      </div>
    </div>
  </div>

  <!-- å†™çœŸãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="photoModal" class="modal" aria-hidden="true">
    <div class="modal-content" style="max-width:800px;">
      <h3 class="modal-title">ğŸ“· å†™çœŸä¸€è¦§</h3>
      <div id="photoModalContent" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0;"></div>
      <button class="btn btn-cancel" id="btnPhotoClose">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ—¢å­˜ï¼‰ -->
  <div id="importModal" class="modal" aria-hidden="true">
    <div class="modal-content" style="max-width:920px;">
      <h3 class="modal-title">ğŸ“¤ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
      <div id="importModalInner"><!-- JSãŒä¸­èº«ã‚’æç”» --></div>
      <div class="modal-actions" style="margin-top:12px;">
        <button class="btn btn-cancel" id="btnImportCancel" style="flex:1;">é–‰ã˜ã‚‹</button>
        <button class="btn btn-primary" id="btnImportStart" style="flex:1;">ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹</button>
      </div>
    </div>
  </div>

  <!-- é¡ä¼¼æ¡ˆä»¶è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="similarCaseDetailModal" class="modal" aria-hidden="true">
    <div class="modal-content" style="max-width:900px;">
      <h3 class="modal-title">ğŸ“‹ é¡ä¼¼æ¡ˆä»¶ã®è©³ç´°</h3>
      <div id="similarCaseDetailContent" style="margin:20px 0;"></div>
      <button class="btn btn-cancel" id="btnSimilarCaseDetailClose">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆâ˜…å“è³ªã‚¿ãƒ–è¿½åŠ æ¸ˆã¿ï¼‰ -->
  <div id="editModal" class="modal" aria-hidden="true">
    <div class="modal-content" style="max-width:920px;">
      <div class="modal-title">âœï¸ å±¥æ­´ãƒ¬ã‚³ãƒ¼ãƒ‰ç·¨é›†</div>
      <div class="edit-tabs">
        <button class="edit-tab active" data-edit-tab="mfg">è£½é€ </button>
        <button class="edit-tab" data-edit-tab="tech">æŠ€è¡“</button>
        <button class="edit-tab" data-edit-tab="qa">å“è³ª</button><!-- â˜… æ–°è¦ -->
      </div>

      <!-- è£½é€ ç·¨é›† -->
      <div id="editMfg" class="edit-pane">
        <div class="form-group"><label>ç™ºç”Ÿæ—¥ *</label><input type="date" id="edit_occurrenceDate"></div>
        <div class="form-group"><label>ç™ºç”Ÿæ™‚åˆ» / å†é–‹æ™‚åˆ»</label><div class="time-group"><input type="time" id="edit_occurrenceTime"><input type="time" id="edit_restartTime"></div></div>
        <div class="form-group"><label>éƒ¨ç½² *</label><select id="edit_department"></select></div>
        <div class="form-group"><label>ãƒ©ã‚¤ãƒ³å *</label><select id="edit_lineName"></select></div>
        <div class="form-group"><label>å‡¦ç½®è€… *</label><select id="edit_handler"></select></div>
        <div class="form-group"><label>æ•´ç†No *</label><input type="text" id="edit_serialNo"></div>
        <div class="form-group"><label>ç•°å¸¸å†…å®¹ *</label><textarea id="edit_anomalyContent"></textarea></div>
        <div class="form-group"><label>å¯¾å¿œå†…å®¹ *</label><textarea id="edit_actionTaken"></textarea></div>
        <div class="form-group"><label>é¡ã‚Š *</label><select id="edit_traceback"><option value="">é¸æŠ</option><option value="æœ‰">æœ‰</option><option value="ç„¡">ç„¡</option></select></div>
        <div class="form-group"><label>æŠ€è¡“è¦è«‹ *</label><select id="edit_techRequest"><option value="">é¸æŠ</option><option value="è¦è«‹">æŠ€è¡“è¦è«‹ã‚ã‚Š</option><option value="å®Œçµ">è£½é€ ã§å®Œçµ</option></select></div>
        <!-- â˜… è¿½åŠ ï¼šå“è³ªè¦è«‹ -->
        <div class="form-group"><label>å“è³ªè¦è«‹ *</label>
          <select id="edit_qaRequest">
            <option value="">é¸æŠ</option>
            <option value="è¦è«‹">å“è³ªè¦è«‹ã‚ã‚Š</option>
            <option value="ç„¡">ä¸è¦</option>
          </select>
        </div>
      </div>

      <!-- æŠ€è¡“ç·¨é›† -->
      <div id="editTech" class="edit-pane" style="display:none;">
        <div class="form-group"><label>æŠ€è¡“å‡¦ç½®è€…</label><input type="text" id="edit_techHandler"></div>
        <div class="form-group"><label>ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°</label>
          <select id="edit_discoveryTiming">
            <option value="">é¸æŠ</option>
            <option value="é‹è»¢ä¸­">é‹è»¢ä¸­</option>
            <option value="é ­å‡ºã—">é ­å‡ºã—</option>
            <option value="åˆç‰©">åˆç‰©</option>
            <option value="çµ‚ç‰©">çµ‚ç‰©</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>
        <div class="form-group"><label>å‰å›çµ‚ç‰©ç¢ºèª</label>
          <select id="edit_previousCheck">
            <option value="">é¸æŠ</option>
            <option value="ä¸è¦">ä¸è¦</option>
            <option value="æœª">æœª</option>
            <option value="ç¢ºèªæ¸ˆ">ç¢ºèªæ¸ˆ</option>
          </select>
        </div>
        <div class="form-group"><label>å‘½æ•°æœ‰ç„¡</label><select id="edit_lifespan"><option value="">é¸æŠ</option><option value="æœ‰">æœ‰</option><option value="ç„¡">ç„¡</option></select></div>
        <div class="form-group"><label>å‘½æ•°åˆ°é”</label>
          <select id="edit_lifespanReached">
            <option value="">é¸æŠ</option>
            <option value="è‡³">è‡³</option>
            <option value="ä¸é”">ä¸é”</option>
          </select>
        </div>
        <div class="form-group"><label>ä¿å…¨å˜ä½</label><input type="text" id="edit_maintenanceUnit"></div>
        <div class="form-group"><label>ä½•ãŒæ‚ªãã©ã†ã—ãŸ</label><textarea id="edit_rootCauseAction"></textarea></div>
        <div class="form-group"><label>å†ç™ºã‹æ–°è¦ã‹</label><select id="edit_recurrenceType"><option value="">é¸æŠ</option><option value="å†ç™º">å†ç™º</option><option value="æ–°è¦">æ–°è¦</option></select></div>
        <div class="form-group"><label>æš«å®š</label>
          <select id="edit_affirmation">
            <option value="">é¸æŠ</option>
            <option value="æœ‰">æœ‰</option>
            <option value="ç„¡">ç„¡</option>
          </select>
        </div>
      </div>

      <!-- â˜… å“è³ªç·¨é›† -->
      <div id="editQA" class="edit-pane" style="display:none;">
        <div class="form-group">
          <label>åˆ¤æ–­</label>
          <select id="edit_qaJudge">
            <option value="">é¸æŠ</option>
            <option value="ä¿ç•™">ä¿ç•™</option>
            <option value="å»ƒæ£„">å»ƒæ£„</option>
            <option value="æµå‹•">æµå‹•</option>
            <option value="é¸åˆ¥">é¸åˆ¥</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>
        <div class="form-group">
          <label>åˆ¤å®šè€…</label>
          <input type="text" id="edit_qaJudgeBy">
        </div>
        <div class="form-group">
          <label>å‚™è€ƒ</label>
          <textarea id="edit_qaNote" placeholder="å¿…è¦ã«å¿œã˜ã¦è¨˜è¼‰"></textarea>
        </div>
        <div class="form-group">
          <label>ï¼ˆå‚è€ƒï¼‰å“è³ªå†™çœŸæšæ•°</label>
          <input type="text" id="edit_qaPhotoCount" disabled placeholder="ä¿å­˜æ¸ˆã¿ã®å†™çœŸæšæ•°ã‚’è¡¨ç¤º">
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-cancel" id="btnEditCancel" style="flex:1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" id="btnEditSave" style="flex:1;">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆPart 2/3ãƒ»Part 3/3ã§æŒ¿å…¥ï¼‰ -->
  <script type="module">
/* =========================
   Part 2/3  JavaScript
   ========================= */

/* ==== Firebase CDN Imports (v10+) ==== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import {
  getFirestore, collection, doc, addDoc, getDoc, getDocs, setDoc,
  updateDoc, query, where, orderBy, serverTimestamp, limit
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
import {
  getStorage, ref as storageRef, uploadBytes, getDownloadURL, listAll, deleteObject
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

/* ==== Firebase Configï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æä¾›ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰==== */
const firebaseConfig = {
  apiKey: "AIzaSyA0YUIpIDh4WB4p1ewiNB0XfwHve0ByljU",
  authDomain: "abnreport-fd733.firebaseapp.com",
  databaseURL: "https://abnreport-fd733-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "abnreport-fd733",
  storageBucket: "abnreport-fd733.appspot.com",
  appId: "1:349748947315:web:010cb671d2a95bcf1f7d06"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const st = getStorage(app);

/* ==== State ==== */
const state = {
  user: null,
  masters: {
    departments: [],        // [{id, name}]
    linesByDept: {},        // { deptName: [lineName,...] }
    handlersByDept: {},     // { deptName: [handlerName,...] }
    serialNos: []           // for datalist
  },
  cache: {
    history: [],            // last fetched anomalies records
  },
  ui: {
    historyView: "card",    // or "table"
    filter: {
      department: "",
      line: "",
      serialLike: "",
      dateFrom: "",
      dateTo: ""
    },
    editTargetId: null,
    editTargetData: null
  }
};

/* ==== Helpers ==== */
const $ = (sel, root = document) => root.querySelector(sel);
const $$ = (sel, root = document) => [...root.querySelectorAll(sel)];
const show = el => el && (el.style.display = "");
const hide = el => el && (el.style.display = "none");

function ymd(date = new Date()) {
  const z = n => String(n).padStart(2, "0");
  return `${date.getFullYear()}-${z(date.getMonth()+1)}-${z(date.getDate())}`;
}

function stopMinutesStr(occ, re) {
  if (!occ || !re) return null;
  const [ho, mo] = occ.split(":").map(Number);
  const [hr, mr] = re.split(":").map(Number);
  let start = ho * 60 + mo;
  let end = hr * 60 + mr;
  if (end < start) end += 24 * 60; // æ—¥è·¨ãã¯ç¾çŠ¶ç¶­æŒ
  const mins = end - start;
  return mins;
}

function esc(s) {
  return (s ?? "").toString().replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

/** å®Œäº†æ¡ä»¶ï¼ˆå“è³ªç‰ˆå«ã‚€ï¼‰
 *  - å“è³ªè¦è«‹=è¦è«‹ ã®å ´åˆï¼šqaJudgeï¼ˆåˆ¤æ–­ï¼‰ã¨qaJudgeByï¼ˆåˆ¤å®šè€…ï¼‰ãŒå…¥ã£ã¦ã„ã‚Œã°å®Œäº†
 *  - æŠ€è¡“è¦è«‹=è¦è«‹ ã®å ´åˆï¼štechå´ã®å¿…è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆtechHandler, discoveryTiming, affirmationï¼‰ãŒå…¥ã£ã¦ã„ã‚Œã°å®Œäº†
 *  - ä¸Šè¨˜ã„ãšã‚Œã‚‚è¦è«‹ã§ãªã„ï¼šè£½é€ å´å…¥åŠ›æ¸ˆã¿ãªã‚‰å®Œäº†
 */
function isCompleted(rec) {
  const techReq = rec.techRequest || "";
  const qaReq = rec.qaRequest || "";
  if (qaReq === "è¦è«‹") {
    return !!(rec.qaJudge && rec.qaJudgeBy);
  }
  if (techReq === "è¦è«‹") {
    return !!(rec.techHandler && rec.discoveryTiming && rec.affirmation);
  }
  // ä¸¡æ–¹ã¨ã‚‚è¦è«‹ã§ãªã„ â†’ è£½é€ å…¥åŠ›ãŒæƒã£ã¦ã„ã‚Œã°å®Œäº†
  return !!(rec.department && rec.lineName && rec.handler && rec.serialNo && rec.anomalyContent && rec.actionTaken);
}

function computeStatus(rec) {
  return isCompleted(rec) ? "complete" : "pending";
}

/* ==== Auth ==== */
const authGate = $("#authGate");
const appRoot = $("#appRoot");
const authMsg = $("#authMsg");
$("#authLoginBtn")?.addEventListener("click", async () => {
  authMsg.textContent = "";
  const email = $("#authEmail").value.trim();
  const pass = $("#authPassword").value;
  try {
    await signInWithEmailAndPassword(auth, email, pass);
  } catch (e) {
    authMsg.textContent = "ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ï¼š" + (e?.message ?? e);
  }
});
$("#signOutBtn")?.addEventListener("click", async () => {
  await signOut(auth);
});

onAuthStateChanged(auth, async (user) => {
  state.user = user;
  if (user) {
    hide(authGate);
    show(appRoot);
    show($("#signOutBtn"));
    await initMasters();
    wireTabs();
    wireHistoryViewToggle();
    wireFilters();
    wireNowButtons();
    wireFilePreviews();
    wireModals();
    wireForms();
    await refreshSerialNoHints();
    await fetchAndRenderHistory();
  } else {
    show(authGate);
    hide(appRoot);
    hide($("#signOutBtn"));
  }
});

/* ==== Masters ==== */
// Firestoreæ§‹æˆï¼ˆç°¡æ˜“æƒ³å®šï¼‰
// - masters/departments {list: ["è£½é€ 1","è£½é€ 2",...]}
// - masters/lines_{dept} {list: ["LO1","LO2",...]}
// - masters/handlers_{dept} {list: ["å±±ç”°","ä½è—¤",...]}
// â€» Part3ã§ç®¡ç†ç”»é¢ã‹ã‚‰ä¿å­˜ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
async function initMasters() {
  // éƒ¨ç½²
  const depDoc = await getDoc(doc(db, "masters", "departments"));
  if (depDoc.exists()) {
    state.masters.departments = (depDoc.data().list || []).map((name, idx) => ({ id: String(idx), name }));
  } else {
    state.masters.departments = [];
  }
  // ãƒ©ã‚¤ãƒ³/å‡¦ç½®è€…ã¯éƒ¨ç½²ã”ã¨ã«å–å¾—
  state.masters.linesByDept = {};
  state.masters.handlersByDept = {};
  for (const d of state.masters.departments) {
    const li = await getDoc(doc(db, "masters", `lines_${d.name}`));
    state.masters.linesByDept[d.name] = (li.exists() ? (li.data().list || []) : []);
    const hd = await getDoc(doc(db, "masters", `handlers_${d.name}`));
    state.masters.handlersByDept[d.name] = (hd.exists() ? (hd.data().list || []) : []);
  }
  renderMasterOptions();
}

function renderMasterOptions() {
  const depSelects = ["#department", "#edit_department", "#filterDepartment", "#lineManageDept", "#handlerManageDept"]
    .map(id => $(id)).filter(Boolean);
  depSelects.forEach(sel => {
    const keep = sel.value;
    sel.innerHTML = "";
    const isFilter = sel.id === "filterDepartment";
    if (isFilter) {
      sel.insertAdjacentHTML("beforeend", `<option value="">ã™ã¹ã¦</option>`);
    } else {
      sel.insertAdjacentHTML("beforeend", `<option value="">é¸æŠ</option>`);
    }
    state.masters.departments.forEach(d => {
      sel.insertAdjacentHTML("beforeend", `<option value="${esc(d.name)}">${esc(d.name)}</option>`);
    });
    if (keep) sel.value = keep;
  });

  // åˆæœŸãƒ©ã‚¤ãƒ³ãƒ»å‡¦ç½®è€…ã¯éƒ¨ç½²é¸æŠã«é€£å‹•
  bindDeptCascades();
}

function bindDeptCascades() {
  function setup(deptSelId, lineSelId, handlerSelId) {
    const deptSel = $(deptSelId);
    const lineSel = $(lineSelId);
    const handlerSel = $(handlerSelId);
    if (!deptSel) return;
    deptSel.addEventListener("change", () => {
      const dept = deptSel.value;
      // line
      if (lineSel) {
        lineSel.innerHTML = "";
        lineSel.insertAdjacentHTML("beforeend", `<option value="">${dept ? "é¸æŠ" : "éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„"}</option>`);
        (state.masters.linesByDept[dept] || []).forEach(l =>
          lineSel.insertAdjacentHTML("beforeend", `<option>${esc(l)}</option>`));
      }
      // handler
      if (handlerSel) {
        handlerSel.innerHTML = "";
        handlerSel.insertAdjacentHTML("beforeend", `<option value="">${dept ? "é¸æŠ" : "éƒ¨ç½²ã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„"}</option>`);
        (state.masters.handlersByDept[dept] || []).forEach(h =>
          handlerSel.insertAdjacentHTML("beforeend", `<option>${esc(h)}</option>`));
      }
    });
  }
  setup("#department", "#lineName", "#handler");
  setup("#edit_department", "#edit_lineName", "#edit_handler");
  // å±¥æ­´ãƒ•ã‚£ãƒ«ã‚¿ç”¨ãƒ©ã‚¤ãƒ³
  const filterDept = $("#filterDepartment");
  const filterLine = $("#filterLine");
  filterDept?.addEventListener("change", () => {
    const dept = filterDept.value;
    filterLine.innerHTML = `<option value="">ã™ã¹ã¦</option>`;
    (state.masters.linesByDept[dept] || []).forEach(l =>
      filterLine.insertAdjacentHTML("beforeend", `<option>${esc(l)}</option>`));
  });
}

/* ==== Tabs ==== */
function wireTabs() {
  $$(".tabs .tab").forEach(btn => {
    btn.addEventListener("click", () => {
      $$(".tabs .tab").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const id = btn.dataset.tab;
      $$(".tab-content").forEach(tc => tc.classList.remove("active"));
      $(`#${id}`).classList.add("active");
    });
  });

  // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã‚¿ãƒ–
  $$(".edit-tabs .edit-tab").forEach(btn => {
    btn.addEventListener("click", () => {
      $$(".edit-tabs .edit-tab").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const id = btn.dataset.editTab;
      $("#editMfg").style.display = (id === "mfg") ? "" : "none";
      $("#editTech").style.display = (id === "tech") ? "" : "none";
      $("#editQA").style.display = (id === "qa") ? "" : "none";
    });
  });
}

/* ==== Filters & View Toggle ==== */
function wireHistoryViewToggle() {
  const wrap = $(".view-toggle");
  wrap?.addEventListener("click", (e) => {
    const b = e.target.closest("button");
    if (!b) return;
    $$(".view-toggle button").forEach(x => x.classList.remove("active"));
    b.classList.add("active");
    state.ui.historyView = b.dataset.view;
    $("#cardView").classList.toggle("active", state.ui.historyView === "card");
    $("#tableView").classList.toggle("active", state.ui.historyView === "table");
    renderHistory(state.cache.history); // å†æç”»
  });
  // åˆæœŸ
  $("#cardView").classList.add("active");
}

function wireFilters() {
  $("#btnFilterYesterday")?.addEventListener("click", () => {
    const d = new Date(); d.setDate(d.getDate() - 1);
    $("#filterDateFrom").value = ymd(d);
    $("#filterDateTo").value = ymd(d);
  });
  $("#btnFilterToday")?.addEventListener("click", () => {
    const d = ymd(new Date());
    $("#filterDateFrom").value = d;
    $("#filterDateTo").value = d;
  });
  $("#btnApplyFilter")?.addEventListener("click", async () => {
    await fetchAndRenderHistory();
  });
  $("#btnClearFilter")?.addEventListener("click", async () => {
    $("#filterDepartment").value = "";
    $("#filterLine").value = "";
    $("#filterSerialNo").value = "";
    $("#filterDateFrom").value = "";
    $("#filterDateTo").value = "";
    await fetchAndRenderHistory();
  });

  // ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã¯ Part3 ã§å®Ÿè£…ã€‚ã“ã“ã§ã¯å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã—ã¦å®‰å…¨ã«ç„¡åŠ¹åŒ–ã€‚
  $("#btnExport")?.addEventListener("click", () => {
    if (typeof window.exportCSV === "function") return window.exportCSV();
    alert("CSVå‡ºåŠ›ã¯å¾Œç¶šãƒ‘ãƒ¼ãƒˆï¼ˆPart 3/3ï¼‰ã§æœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚");
  });
  $("#btnImport")?.addEventListener("click", () => {
    if (typeof window.openImportModal === "function") return window.openImportModal();
    alert("CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯å¾Œç¶šãƒ‘ãƒ¼ãƒˆï¼ˆPart 3/3ï¼‰ã§æœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚");
  });
}

function wireNowButtons() {
  $("#btnNowDate")?.addEventListener("click", () => { $("#occurrenceDate").value = ymd(); });
  $$("button[data-now]").forEach(b => {
    b.addEventListener("click", () => {
      const id = b.dataset.now;
      const d = new Date();
      const z = n => String(n).padStart(2, "0");
      $(`#${id}`).value = `${z(d.getHours())}:${z(d.getMinutes())}`;
    });
  });
}

/* ==== File Previews ==== */
function wireFilePreviews() {
  // è£½é€ 
  $("#mfgPhotos")?.addEventListener("change", (e) => {
    drawPreview(e.target.files, $("#mfgPhotoPreview"));
  });
  // æŠ€è¡“
  $("#techPhotos")?.addEventListener("change", (e) => {
    drawPreview(e.target.files, $("#techPhotoPreview"));
  });
  // å“è³ª
  $("#qaPhotos")?.addEventListener("change", (e) => {
    drawPreview(e.target.files, $("#qaPhotoPreview"));
  });
}

function drawPreview(fileList, wrap) {
  wrap.innerHTML = "";
  [...fileList].forEach((f, i) => {
    const url = URL.createObjectURL(f);
    wrap.insertAdjacentHTML("beforeend", `
      <div class="photo-item" data-idx="${i}">
        <img src="${url}" alt="preview">
        <button type="button" class="remove-btn" aria-label="remove">Ã—</button>
      </div>
    `);
  });
  wrap.addEventListener("click", (e) => {
    const btn = e.target.closest(".remove-btn");
    if (!btn) return;
    const item = btn.closest(".photo-item");
    const idx = Number(item.dataset.idx);
    // FileListã¯ç›´æ¥å‰Šé™¤ä¸å¯ã€‚æ®‹ã—ãŸã„ã‚‚ã®ã ã‘ã§æ–°DataTransferã‚’ä½œã‚‹
    const input = wrap.previousElementSibling?.querySelector("input[type=file]") || wrap.parentElement.querySelector("input[type=file]");
    const dt = new DataTransfer();
    [...input.files].forEach((f, i) => { if (i !== idx) dt.items.add(f); });
    input.files = dt.files;
    drawPreview(input.files, wrap);
  }, { once: true });
}

/* ==== Modals ==== */
function wireModals() {
  $("#btnPhotoClose")?.addEventListener("click", () => $("#photoModal").classList.remove("active"));
  $("#btnSimilarCaseDetailClose")?.addEventListener("click", () => $("#similarCaseDetailModal").classList.remove("active"));

  $("#btnEditCancel")?.addEventListener("click", () => {
    $("#editModal").classList.remove("active");
    state.ui.editTargetId = null; state.ui.editTargetData = null;
  });
  $("#btnEditSave")?.addEventListener("click", async () => {
    if (!state.ui.editTargetId) return;
    try {
      await saveEditModal();
      $("#editModal").classList.remove("active");
      await fetchAndRenderHistory();
    } catch (e) {
      alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + (e?.message ?? e));
    }
  });
}

/* ==== Forms ==== */
function wireForms() {
  // è£½é€ ãƒ•ã‚©ãƒ¼ãƒ 
  $("#manufacturingForm")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const data = {
      occurrenceDate: $("#occurrenceDate").value || null,
      occurrenceTime: $("#occurrenceTime").value || null,
      restartTime: $("#restartTime").value || null,
      department: $("#department").value || "",
      lineName: $("#lineName").value || "",
      handler: $("#handler").value || "",
      serialNo: $("#serialNo").value || "",
      anomalyContent: $("#anomalyContent").value || "",
      actionTaken: $("#actionTaken").value || "",
      traceback: $("#traceback").value || "",
      techRequest: $("#techRequest").value || "",
      qaRequest: $("#qaRequest").value || "",          // â˜… è£½é€ ã«ã‚‚å“è³ªè¦è«‹
      createdBy: state.user?.uid || null,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
    };
    // ç°¡æ˜“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!data.occurrenceDate || !data.department || !data.lineName || !data.handler || !data.serialNo || !data.anomalyContent || !data.actionTaken || !data.techRequest || !data.qaRequest) {
      alert("å¿…é ˆé …ç›®ãŒæœªå…¥åŠ›ã§ã™ã€‚");
      return;
    }
    // å…ˆã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ â†’ IDã‚’ä½¿ã£ã¦å†™çœŸä¿å­˜
    const docRef = await addDoc(collection(db, "anomalies"), data);
    // å†™çœŸï¼ˆè£½é€ ï¼‰
    const mfgFiles = $("#mfgPhotos").files;
    const mfgUrls = await uploadPhotoFiles(docRef.id, "mfg", mfgFiles);
    if (mfgUrls.length) {
      await updateDoc(docRef, { mfgPhotoUrls: mfgUrls, updatedAt: serverTimestamp() });
    }
    // å®Œäº†
    alert("ç™»éŒ²ã—ã¾ã—ãŸã€‚");
    e.target.reset();
    $("#mfgPhotoPreview").innerHTML = "";
    await refreshSerialNoHints();
    await fetchAndRenderHistory();
  });

  // æŠ€è¡“ãƒ•ã‚©ãƒ¼ãƒ 
  $("#technicalForm")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = $("#selectSerialNo")?.value || "";
    if (!id) return alert("å¯¾è±¡ä»¶åã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    const payload = {
      techHandler: $("#techHandler").value || "",
      discoveryTiming: $("#discoveryTiming").value || "",
      previousCheck: $("#previousCheck").value || "",
      lifespan: $("#lifespan").value || "",
      lifespanReached: $("#lifespanReached").value || "",
      maintenanceUnit: $("#maintenanceUnit").value || "",
      rootCauseAction: $("#rootCauseAction").value || "",
      recurrenceType: $("#recurrenceType").value || "",
      affirmation: $("#affirmation").value || "",
      updatedAt: serverTimestamp(),
    };
    const refDoc = doc(db, "anomalies", id);
    await updateDoc(refDoc, payload);

    // å†™çœŸï¼ˆæŠ€è¡“ï¼‰
    const techFiles = $("#techPhotos").files;
    const techUrls = await uploadPhotoFiles(id, "tech", techFiles);
    if (techUrls.length) {
      const curr = await getDoc(refDoc);
      const exist = curr.exists() ? (curr.data().techPhotoUrls || []) : [];
      await updateDoc(refDoc, { techPhotoUrls: [...exist, ...techUrls], updatedAt: serverTimestamp() });
    }
    alert("æŠ€è¡“å…¥åŠ›ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
    e.target.reset();
    $("#techPhotoPreview").innerHTML = "";
    await fetchAndRenderHistory();
  });

  // å“è³ªãƒ•ã‚©ãƒ¼ãƒ 
  $("#qualityForm")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = $("#selectSerialNoQA").value || "";
    if (!id) return alert("å¯¾è±¡ä»¶åã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    const payload = {
      qaJudge: $("#qaJudge").value || "",
      qaJudgeBy: $("#qaJudgeBy").value || "",
      qaNote: $("#qaNote").value || "",
      updatedAt: serverTimestamp(),
    };
    const refDoc = doc(db, "anomalies", id);
    await updateDoc(refDoc, payload);
    // å†™çœŸï¼ˆå“è³ªï¼‰
    const qaFiles = $("#qaPhotos").files;
    const qaUrls = await uploadPhotoFiles(id, "qa", qaFiles);
    if (qaUrls.length) {
      const curr = await getDoc(refDoc);
      const exist = curr.exists() ? (curr.data().qaPhotoUrls || []) : [];
      await updateDoc(refDoc, { qaPhotoUrls: [...exist, ...qaUrls], updatedAt: serverTimestamp() });
    }
    alert("å“è³ªå…¥åŠ›ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
    e.target.reset();
    $("#qaPhotoPreview").innerHTML = "";
    await fetchAndRenderHistory();
  });

  // ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼åˆç‰© â†’ å‰å›çµ‚ç‰©ç¢ºèªã®è¡¨ç¤ºåˆ‡æ›¿
  $("#discoveryTiming")?.addEventListener("change", () => {
    $("#previousCheckGroup").style.display = ($("#discoveryTiming").value === "åˆç‰©") ? "" : "none";
  });
}

/* ==== Upload Helpers ==== */
async function uploadPhotoFiles(docId, folder, fileList) {
  if (!fileList || !fileList.length) return [];
  const urls = [];
  for (const f of fileList) {
    const path = `anomalies/${docId}/${folder}/${Date.now()}_${f.name}`;
    const ref = storageRef(st, path);
    await uploadBytes(ref, f);
    const url = await getDownloadURL(ref);
    urls.push(url);
  }
  return urls;
}

/* ==== SerialNo ãƒ’ãƒ³ãƒˆ ==== */
async function refreshSerialNoHints() {
  // ç›´è¿‘ã®serialNoã‚’åé›†
  const qy = query(collection(db, "anomalies"), orderBy("createdAt", "desc"), limit(200));
  const ss = await getDocs(qy);
  const set = new Set();
  ss.forEach(d => {
    const sn = d.data().serialNo || "";
    if (sn) set.add(sn);
  });
  state.masters.serialNos = [...set];
  const dl = $("#serialNoList");
  if (dl) {
    dl.innerHTML = "";
    state.masters.serialNos.forEach(sn => dl.insertAdjacentHTML("beforeend", `<option value="${esc(sn)}"></option>`));
  }
}

/* ==== History Fetch & Render ==== */
async function fetchAndRenderHistory() {
  // ãƒ™ãƒ¼ã‚¹ã¯æœ€è¿‘é †
  let qy = query(collection(db, "anomalies"), orderBy("createdAt", "desc"));
  // å–å¾— â†’ ãƒ•ãƒ­ãƒ³ãƒˆã§ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆFirestoreè¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å›é¿ï¼‰
  const ss = await getDocs(qy);
  let rows = ss.docs.map(d => ({ id: d.id, ...d.data() }));

  // ãƒ•ãƒ­ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿
  const fDept = $("#filterDepartment").value || "";
  const fLine = $("#filterLine").value || "";
  const fSerial = $("#filterSerialNo").value?.trim() || "";
  const df = $("#filterDateFrom").value || "";
  const dt = $("#filterDateTo").value || "";

  if (fDept) rows = rows.filter(r => (r.department || "") === fDept);
  if (fLine) rows = rows.filter(r => (r.lineName || "") === fLine);
  if (fSerial) rows = rows.filter(r => (r.serialNo || "").includes(fSerial));
  if (df) rows = rows.filter(r => (r.occurrenceDate || "") >= df);
  if (dt) rows = rows.filter(r => (r.occurrenceDate || "") <= dt);

  state.cache.history = rows;
  $("#filterResultCount").style.display = "";
  $("#filterResultCount").innerHTML = `<strong>${rows.length}</strong> ä»¶ã®å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;
  // ã‚»ãƒ¬ã‚¯ãƒˆç”¨ï¼ˆæŠ€è¡“ãƒ»å“è³ªï¼‰
  fillSerialSelectors(rows);
  renderHistory(rows);
}

function fillSerialSelectors(rows) {
  const selTech = $("#selectSerialNo");
  const selQA = $("#selectSerialNoQA");
  if (selTech) {
    const keep = selTech.value;
    selTech.innerHTML = `<option value="">æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„</option>`;
    rows.forEach(r => selTech.insertAdjacentHTML("beforeend",
      `<option value="${r.id}">${esc(r.serialNo)}ï½œ${esc(r.department)}ï½œ${esc(r.lineName)}ï½œ${esc(r.occurrenceDate || "")}</option>`));
    selTech.value = keep;
    selTech.onchange = async () => {
      const id = selTech.value;
      if (!id) { $("#selectedDataDisplay").style.display = "none"; $("#displayContent").innerHTML = ""; return; }
      const r = rows.find(x => x.id === id);
      $("#selectedDataDisplay").style.display = "";
      $("#displayContent").innerHTML = `
        <div class="card-meta">
          <div class="card-meta-item"><div class="card-meta-label">æ•´ç†No</div><div class="card-meta-value">${esc(r.serialNo || "")}</div></div>
          <div class="card-meta-item"><div class="card-meta-label">ç•°å¸¸å†…å®¹</div><div class="card-meta-value">${esc(r.anomalyContent || "")}</div></div>
          <div class="card-meta-item"><div class="card-meta-label">å¯¾å¿œå†…å®¹</div><div class="card-meta-value">${esc(r.actionTaken || "")}</div></div>
        </div>`;
    };
  }
  if (selQA) {
    const keep = selQA.value;
    selQA.innerHTML = `<option value="">æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„</option>`;
    rows.forEach(r => selQA.insertAdjacentHTML("beforeend",
      `<option value="${r.id}">${esc(r.serialNo)}ï½œ${esc(r.department)}ï½œ${esc(r.lineName)}ï½œ${esc(r.occurrenceDate || "")}</option>`));
    selQA.value = keep;
  }
}

function renderHistory(rows) {
  if (state.ui.historyView === "card") {
    renderCardView(rows);
  } else {
    renderTableView(rows);
  }
}

function renderCardView(rows) {
  const wrap = $("#cardView");
  wrap.innerHTML = "";
  if (!rows.length) {
    wrap.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸˆ³</div>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }
  rows.forEach(r => {
    const status = computeStatus(r);
    const stop = stopMinutesStr(r.occurrenceTime, r.restartTime);
    let stopClass = "stop-badge";
    if (stop != null) {
      if (stop >= 60) stopClass += " danger";
      else if (stop >= 30) stopClass += " warn";
    }
    const mfgPhotos = (r.mfgPhotoUrls || []).slice(0, 4).map(u =>
      `<div class="photo-thumb-compact"><img src="${esc(u)}" alt=""></div>`).join("");
    const techInfo = `
      <div class="tech-info-item"><div class="tech-info-label">æŠ€è¡“è¦è«‹</div><div class="tech-info-value">${esc(r.techRequest || "")}</div></div>
      <div class="tech-info-item"><div class="tech-info-label">å“è³ªè¦è«‹</div><div class="tech-info-value">${esc(r.qaRequest || "")}</div></div>
      <div class="tech-info-item"><div class="tech-info-label">ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°</div><div class="tech-info-value">${esc(r.discoveryTiming || "-")}</div></div>
      <div class="tech-info-item"><div class="tech-info-label">æš«å®š</div><div class="tech-info-value">${esc(r.affirmation || "-")}</div></div>
    `;
    wrap.insertAdjacentHTML("beforeend", `
      <div class="anomaly-card ${status === "complete" ? "complete" : ""}">
        <div class="card-left">
          <div class="card-id">#${esc(r.serialNo || "")}</div>
          <div class="card-status ${status === "complete" ? "status-complete" : "status-pending"}">
            ${status === "complete" ? "å®Œäº†" : "æœªå®Œäº†"}
          </div>
          <div class="card-meta">
            <div class="card-meta-item">
              <div class="card-meta-label">ç™ºç”Ÿæ—¥</div>
              <div class="card-meta-value">${esc(r.occurrenceDate || "-")} ${esc(r.occurrenceTime || "")}</div>
            </div>
            <div class="card-meta-item">
              <div class="card-meta-label">éƒ¨ç½²/ãƒ©ã‚¤ãƒ³</div>
              <div class="card-meta-value">${esc(r.department || "-")} / ${esc(r.lineName || "-")}</div>
            </div>
            <div class="card-meta-item">
              <div class="card-meta-label">å‡¦ç½®è€…</div>
              <div class="card-meta-value">${esc(r.handler || "-")}</div>
            </div>
          </div>
        </div>

        <div class="card-center">
          <div class="card-content-section">
            <div class="card-content-label">ç•°å¸¸å†…å®¹</div>
            <div class="card-content-text">${esc(r.anomalyContent || "-")}</div>
          </div>
          <div class="card-content-section">
            <div class="card-content-label">å¯¾å¿œå†…å®¹</div>
            <div class="card-content-text">${esc(r.actionTaken || "-")}</div>
          </div>
          <div class="card-tech-info">${techInfo}</div>
          <div class="card-content-section">
            <div class="card-content-label">å“è³ªåˆ¤æ–­</div>
            <div class="card-content-text">${esc(r.qaJudge || "-")}ï¼ˆ${esc(r.qaJudgeBy || "-")}ï¼‰ ${esc(r.qaNote || "")}</div>
          </div>
        </div>

        <div class="card-right">
          <div class="card-photos-compact">
            ${mfgPhotos || ""}
          </div>
          <div class="photo-count-badge">
            è£½é€ :${(r.mfgPhotoUrls||[]).length} / æŠ€è¡“:${(r.techPhotoUrls||[]).length} / å“è³ª:${(r.qaPhotoUrls||[]).length}
          </div>
          <div class="action-btns">
            <button class="btn-small btn-edit" data-id="${r.id}">ç·¨é›†</button>
            <button class="btn-small btn-delete" data-id="${r.id}">å‰Šé™¤</button>
            ${(r.mfgPhotoUrls?.length || r.techPhotoUrls?.length || r.qaPhotoUrls?.length) ? `<button class="btn-small" data-photos="${r.id}">å†™çœŸ</button>` : ""}
          </div>
        </div>

        ${stop != null ? `<div class="${stopClass}">åœæ­¢æ™‚é–“ ${stop} åˆ†</div>` : ""}
      </div>
    `);
  });

  // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆæŸã­
  wrap.addEventListener("click", async (e) => {
    const btnEdit = e.target.closest(".btn-edit");
    const btnDel = e.target.closest(".btn-delete");
    const btnPhoto = e.target.closest("button[data-photos]");
    if (btnEdit) {
      const id = btnEdit.dataset.id;
      const row = state.cache.history.find(x => x.id === id);
      if (!row) return;
      openEditModal(row);
    } else if (btnDel) {
      const id = btnDel.dataset.id;
      if (!confirm("ã“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
      try {
        await deleteAnomaly(id);
        await fetchAndRenderHistory();
      } catch (err) {
        alert("å‰Šé™¤ã«å¤±æ•—ï¼š" + (err?.message ?? err));
      }
    } else if (btnPhoto) {
      const id = btnPhoto.dataset.photos;
      const r = state.cache.history.find(x => x.id === id);
      openPhotoModal(r);
    }
  }, { once: true });
}

function renderTableView(rows) {
  const tv = $("#tableView");
  tv.innerHTML = "";
  if (!rows.length) {
    tv.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸˆ³</div>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }
  const ths = [
    "ç™ºç”Ÿæ—¥","ç™ºç”Ÿæ™‚åˆ»","å†é–‹æ™‚åˆ»","åœæ­¢æ™‚é–“(åˆ†)","éƒ¨ç½²","ãƒ©ã‚¤ãƒ³å","æ•´ç†No",
    "ç•°å¸¸å†…å®¹","å¯¾å¿œå†…å®¹","å‡¦ç½®è€…","é¡ã‚Š","æŠ€è¡“è¦è«‹","å“è³ªè¦è«‹","æŠ€è¡“å‡¦ç½®è€…","ç™ºè¦‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°","æš«å®š",
    "å“è³ªåˆ¤æ–­","å“è³ªåˆ¤å®šè€…","å“è³ªå‚™è€ƒ","ä½œæˆæ—¥"
  ];
  tv.insertAdjacentHTML("beforeend", `<table><thead><tr>${ths.map(h=>`<th>${h}</th>`).join("")}</tr></thead><tbody></tbody></table>`);
  const tb = $("#tableView tbody");
  rows.forEach(r => {
    const stop = stopMinutesStr(r.occurrenceTime, r.restartTime);
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${esc(r.occurrenceDate || "")}</td>
        <td>${esc(r.occurrenceTime || "")}</td>
        <td>${esc(r.restartTime || "")}</td>
        <td>${stop != null ? stop : ""}</td>
        <td>${esc(r.department || "")}</td>
        <td>${esc(r.lineName || "")}</td>
        <td>${esc(r.serialNo || "")}</td>
        <td>${esc(r.anomalyContent || "")}</td>
        <td>${esc(r.actionTaken || "")}</td>
        <td>${esc(r.handler || "")}</td>
        <td>${esc(r.traceback || "")}</td>
        <td>${esc(r.techRequest || "")}</td>
        <td>${esc(r.qaRequest || "")}</td>
        <td>${esc(r.techHandler || "")}</td>
        <td>${esc(r.discoveryTiming || "")}</td>
        <td>${esc(r.affirmation || "")}</td>
        <td>${esc(r.qaJudge || "")}</td>
        <td>${esc(r.qaJudgeBy || "")}</td>
        <td>${esc(r.qaNote || "")}</td>
        <td>${r.createdAt?.toDate ? ymd(r.createdAt.toDate()) : ""}</td>
      </tr>
    `);
  });
}

/* ==== Edit Modal ==== */
function openEditModal(row) {
  state.ui.editTargetId = row.id;
  state.ui.editTargetData = row;

  // è£½é€ 
  $("#edit_occurrenceDate").value = row.occurrenceDate || "";
  $("#edit_occurrenceTime").value = row.occurrenceTime || "";
  $("#edit_restartTime").value = row.restartTime || "";

  $("#edit_department").value = row.department || "";
  // éƒ¨ç½²ã«åˆã‚ã›ã¦é¸æŠè‚¢å†ç”Ÿæˆ
  $("#edit_department").dispatchEvent(new Event("change"));
  $("#edit_lineName").value = row.lineName || "";
  $("#edit_handler").value = row.handler || "";

  $("#edit_serialNo").value = row.serialNo || "";
  $("#edit_anomalyContent").value = row.anomalyContent || "";
  $("#edit_actionTaken").value = row.actionTaken || "";
  $("#edit_traceback").value = row.traceback || "";
  $("#edit_techRequest").value = row.techRequest || "";
  $("#edit_qaRequest").value = row.qaRequest || "";

  // æŠ€è¡“
  $("#edit_techHandler").value = row.techHandler || "";
  $("#edit_discoveryTiming").value = row.discoveryTiming || "";
  $("#edit_previousCheck").value = row.previousCheck || "";
  $("#edit_lifespan").value = row.lifespan || "";
  $("#edit_lifespanReached").value = row.lifespanReached || "";
  $("#edit_maintenanceUnit").value = row.maintenanceUnit || "";
  $("#edit_rootCauseAction").value = row.rootCauseAction || "";
  $("#edit_recurrenceType").value = row.recurrenceType || "";
  $("#edit_affirmation").value = row.affirmation || "";

  // å“è³ª
  $("#edit_qaJudge").value = row.qaJudge || "";
  $("#edit_qaJudgeBy").value = row.qaJudgeBy || "";
  $("#edit_qaNote").value = row.qaNote || "";
  $("#edit_qaPhotoCount").value = (row.qaPhotoUrls || []).length;

  // ã‚¿ãƒ–åˆæœŸã¯è£½é€ 
  $$(".edit-tabs .edit-tab").forEach(b => b.classList.remove("active"));
  $(`.edit-tabs .edit-tab[data-edit-tab="mfg"]`).classList.add("active");
  $("#editMfg").style.display = "";
  $("#editTech").style.display = "none";
  $("#editQA").style.display = "none";

  $("#editModal").classList.add("active");
}

async function saveEditModal() {
  const id = state.ui.editTargetId;
  if (!id) return;
  const payload = {
    // è£½é€ 
    occurrenceDate: $("#edit_occurrenceDate").value || null,
    occurrenceTime: $("#edit_occurrenceTime").value || null,
    restartTime: $("#edit_restartTime").value || null,
    department: $("#edit_department").value || "",
    lineName: $("#edit_lineName").value || "",
    handler: $("#edit_handler").value || "",
    serialNo: $("#edit_serialNo").value || "",
    anomalyContent: $("#edit_anomalyContent").value || "",
    actionTaken: $("#edit_actionTaken").value || "",
    traceback: $("#edit_traceback").value || "",
    techRequest: $("#edit_techRequest").value || "",
    qaRequest: $("#edit_qaRequest").value || "",

    // æŠ€è¡“
    techHandler: $("#edit_techHandler").value || "",
    discoveryTiming: $("#edit_discoveryTiming").value || "",
    previousCheck: $("#edit_previousCheck").value || "",
    lifespan: $("#edit_lifespan").value || "",
    lifespanReached: $("#edit_lifespanReached").value || "",
    maintenanceUnit: $("#edit_maintenanceUnit").value || "",
    rootCauseAction: $("#edit_rootCauseAction").value || "",
    recurrenceType: $("#edit_recurrenceType").value || "",
    affirmation: $("#edit_affirmation").value || "",

    // å“è³ª
    qaJudge: $("#edit_qaJudge").value || "",
    qaJudgeBy: $("#edit_qaJudgeBy").value || "",
    qaNote: $("#edit_qaNote").value || "",

    updatedAt: serverTimestamp(),
  };
  await updateDoc(doc(db, "anomalies", id), payload);
}

/* ==== Delete ==== */
async function deleteAnomaly(id) {
  // å†™çœŸ(ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€)å‰Šé™¤
  for (const folder of ["mfg","tech","qa"]) {
    try {
      const dir = storageRef(st, `anomalies/${id}/${folder}`);
      const listed = await listAll(dir);
      await Promise.all(listed.items.map(it => deleteObject(it)));
    } catch (e) {
      // ãƒ•ã‚©ãƒ«ãƒ€ãŒç„¡ã„ãªã©ã¯ç„¡è¦–
    }
  }
  // æœ¬ä½“
  await updateDoc(doc(db, "anomalies", id), { __deleted: true, updatedAt: serverTimestamp() });
  // ç‰©ç†å‰Šé™¤ã«ã—ãŸã„å ´åˆã¯ setDoc/deleteDoc ã«ç½®æ›ï¼ˆé‹ç”¨æ–¹é‡ã«åˆã‚ã›ã¦ Part3 ã§åˆ‡æ›¿å¯ï¼‰
}

/* ==== Photo Modal ==== */
function openPhotoModal(r) {
  const wrap = $("#photoModalContent");
  wrap.innerHTML = "";
  const all = [
    ...(r.mfgPhotoUrls || []).map(u => ({u, tag:"è£½é€ "})),
    ...(r.techPhotoUrls || []).map(u => ({u, tag:"æŠ€è¡“"})),
    ...(r.qaPhotoUrls || []).map(u => ({u, tag:"å“è³ª"})),
  ];
  if (!all.length) {
    wrap.innerHTML = `<div style="color:#777;">å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
  } else {
    all.forEach(p => {
      wrap.insertAdjacentHTML("beforeend", `
        <div>
          <div style="font-weight:600;color:#667eea;margin-bottom:6px;">${p.tag}</div>
          <img src="${esc(p.u)}" style="width:100%;height:auto;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.15);" />
        </div>
      `);
    });
  }
  $("#photoModal").classList.add("active");
}
/* =========================
   Part 3/3  CSVãƒ»ãƒã‚¹ã‚¿ä¿å­˜ãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   ========================= */

/* ---- CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ----
 * ãƒ»ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿çµæœï¼ˆstate.cache.historyï¼‰ã‚’ãã®ã¾ã¾å‡ºåŠ›
 * ãƒ»é…åˆ—ï¼ˆå†™çœŸURLãªã©ï¼‰ã¯ '|' ã§é€£çµ
 */
window.exportCSV = function exportCSV() {
  const rows = state.cache.history || [];
  const headers = [
    "id","occurrenceDate","occurrenceTime","restartTime","department","lineName","handler",
    "serialNo","anomalyContent","actionTaken","traceback",
    "techRequest","qaRequest",
    "techHandler","discoveryTiming","previousCheck","lifespan","lifespanReached",
    "maintenanceUnit","rootCauseAction","recurrenceType","affirmation",
    "qaJudge","qaJudgeBy","qaNote",
    "mfgPhotoUrls","techPhotoUrls","qaPhotoUrls",
    "createdAt","updatedAt","__deleted"
  ];
  const csv = [
    headers.join(","),
    ...rows.map(r => headers.map(h => {
      let v = r[h];
      if (Array.isArray(v)) v = v.join("|");
      if (h === "createdAt" || h === "updatedAt") {
        v = (r[h]?.toDate ? r[h].toDate().toISOString() : (r[h] ?? ""));
      }
      const s = (v ?? "").toString().replace(/"/g, '""');
      return `"${s}"`;
    }).join(","))
  ].join("\r\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `anomalies_${new Date().toISOString().slice(0,19).replace(/[:T]/g,"-")}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  alert("CSVã‚’å‡ºåŠ›ã—ã¾ã—ãŸã€‚");
};

/* ---- CSV ã‚¤ãƒ³ãƒãƒ¼ãƒˆ ----
 * UIãƒ¢ãƒ¼ãƒ€ãƒ«ãªã—ã®è»½é‡ç‰ˆï¼šãƒ•ã‚¡ã‚¤ãƒ«é¸æŠâ†’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼â†’å–ã‚Šè¾¼ã¿
 * ãƒ»æ—¢å­˜idåˆ—ãŒã‚ã‚Œã°ä¸Šæ›¸ãã€ç„¡ã‘ã‚Œã°æ–°è¦ addDoc
 * ãƒ»URLæ¬„ã¯ãã®ã¾ã¾ä¿å­˜ï¼ˆå†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯å¯¾è±¡å¤–ï¼‰
 */
window.openImportModal = function openImportModal() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = ".csv,text/csv";
  input.addEventListener("change", async () => {
    const file = input.files?.[0];
    if (!file) return;
    const text = await file.text();
    const { headers, rows } = parseCSV(text);
    if (!rows.length) { alert("å–ã‚Šè¾¼ã‚€ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }

    // å…ˆé ­æ•°ä»¶ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    const preview = rows.slice(0, 5).map(r => JSON.stringify(r)).join("\n");
    const ok = confirm(`ä»¥ä¸‹ã®å½¢å¼ã§å–ã‚Šè¾¼ã¿ã¾ã™ï¼ˆå…ˆé ­5ä»¶ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰\n\n${preview}\n\nã“ã®ã¾ã¾å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`);
    if (!ok) return;

    // å–ã‚Šè¾¼ã¿
    let addCount = 0, updCount = 0, errCount = 0;
    for (const obj of rows) {
      try {
        // é…åˆ—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¾©å…ƒï¼ˆ|åŒºåˆ‡ã‚Šï¼‰
        for (const k of ["mfgPhotoUrls","techPhotoUrls","qaPhotoUrls"]) {
          if (obj[k] && typeof obj[k] === "string") {
            obj[k] = obj[k].split("|").filter(Boolean);
          }
        }
        // createdAt / updatedAt ã¯æ–‡å­—åˆ—ã®ã¾ã¾ä¿æŒï¼ˆISO ã®å ´åˆã¯å¾Œå·¥ç¨‹ã§æ´»ç”¨å¯ï¼‰
        const id = obj.id?.trim();
        // ä¿å­˜ç¦æ­¢ã‚­ãƒ¼ã‚’æ•´ç†
        const payload = { ...obj };
        delete payload.id;

        // Firestoreå–è¾¼ï¼šidæœ‰â†’æ›´æ–° / ç„¡â†’è¿½åŠ 
        if (id) {
          await updateDoc(doc(db, "anomalies", id), payload);
          updCount++;
        } else {
          await addDoc(collection(db, "anomalies"), payload);
          addCount++;
        }
      } catch (e) {
        console.error("import error:", e);
        errCount++;
      }
    }
    alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼šè¿½åŠ  ${addCount} / æ›´æ–° ${updCount} / ã‚¨ãƒ©ãƒ¼ ${errCount}`);
    await refreshSerialNoHints();
    await fetchAndRenderHistory();
  });
  input.click();
};

/* ---- ç°¡æ˜“ CSV ãƒ‘ãƒ¼ã‚µï¼ˆãƒ˜ãƒƒãƒ€å¿…é ˆ, RFCå³å¯†ã§ãªãOKï¼‰ ---- */
function parseCSV(text) {
  // è¡Œã«åˆ†å‰²ï¼ˆCRLF/CR/LFå¯¾å¿œï¼‰
  const lines = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n").filter(l => l.length);
  if (!lines.length) return { headers: [], rows: [] };

  const headers = splitCSVLine(lines[0]);
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const cols = splitCSVLine(lines[i]);
    const obj = {};
    headers.forEach((h, idx) => { obj[h] = cols[idx] ?? ""; });
    rows.push(obj);
  }
  return { headers, rows };
}

function splitCSVLine(line) {
  const out = [];
  let cur = "";
  let quoted = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (quoted) {
      if (ch === '"') {
        if (line[i+1] === '"') { cur += '"'; i++; } // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        else { quoted = false; }
      } else {
        cur += ch;
      }
    } else {
      if (ch === '"') { quoted = true; }
      else if (ch === ",") { out.push(cur); cur = ""; }
      else { cur += ch; }
    }
  }
  out.push(cur);
  return out;
}

/* ---- ãƒã‚¹ã‚¿ä¿å­˜ï¼ˆéƒ¨ç½²ãƒ»ãƒ©ã‚¤ãƒ³ãƒ»å‡¦ç½®è€…ï¼‰ ----
 * æƒ³å®šUIï¼š
 *  - éƒ¨ç½²ã‚¿ãƒ–:  textarea#deptList ï¼ˆ1è¡Œ1éƒ¨ç½²ï¼‰ / ä¿å­˜ãƒœã‚¿ãƒ³ #btnSaveDepartments
 *  - ãƒ©ã‚¤ãƒ³ã‚¿ãƒ–: select#lineManageDept + textarea#lineList / ä¿å­˜ #btnSaveLines
 *  - å‡¦ç½®è€…ã‚¿ãƒ–: select#handlerManageDept + textarea#handlerList / ä¿å­˜ #btnSaveHandlers
 */
$("#btnSaveDepartments")?.addEventListener("click", async () => {
  const ta = $("#deptList");
  if (!ta) return alert("éƒ¨ç½²ãƒªã‚¹ãƒˆã®UIãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
  const list = ta.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  try {
    await setDoc(doc(db, "masters", "departments"), { list, updatedAt: serverTimestamp() });
    alert("éƒ¨ç½²ãƒã‚¹ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
    await initMasters();
  } catch (e) {
    alert("éƒ¨ç½²ãƒã‚¹ã‚¿ã®ä¿å­˜ã«å¤±æ•—: " + (e?.message ?? e));
  }
});

$("#btnSaveLines")?.addEventListener("click", async () => {
  const dept = $("#lineManageDept")?.value || "";
  const ta = $("#lineList");
  if (!dept) return alert("éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
  if (!ta) return alert("ãƒ©ã‚¤ãƒ³ãƒªã‚¹ãƒˆã®UIãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
  const list = ta.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  try {
    await setDoc(doc(db, "masters", `lines_${dept}`), { list, updatedAt: serverTimestamp() });
    alert(`ãƒ©ã‚¤ãƒ³ãƒã‚¹ã‚¿ï¼ˆ${dept}ï¼‰ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`);
    await initMasters();
  } catch (e) {
    alert("ãƒ©ã‚¤ãƒ³ãƒã‚¹ã‚¿ã®ä¿å­˜ã«å¤±æ•—: " + (e?.message ?? e));
  }
});

$("#btnSaveHandlers")?.addEventListener("click", async () => {
  const dept = $("#handlerManageDept")?.value || "";
  const ta = $("#handlerList");
  if (!dept) return alert("éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
  if (!ta) return alert("å‡¦ç½®è€…ãƒªã‚¹ãƒˆã®UIãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
  const list = ta.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  try {
    await setDoc(doc(db, "masters", `handlers_${dept}`), { list, updatedAt: serverTimestamp() });
    alert(`å‡¦ç½®è€…ãƒã‚¹ã‚¿ï¼ˆ${dept}ï¼‰ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`);
    await initMasters();
  } catch (e) {
    alert("å‡¦ç½®è€…ãƒã‚¹ã‚¿ã®ä¿å­˜ã«å¤±æ•—: " + (e?.message ?? e));
  }
});

/* ---- ä¾¿åˆ©ãƒœã‚¿ãƒ³ï¼ˆæ˜¨æ—¥/ä»Šæ—¥ã®å…¥åŠ›ï¼‰ã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ã‚‚æä¾›ã™ã‚‹å ´åˆã®è£œåŠ© ---- */
$$("button[data-now-edit]").forEach(b => {
  b.addEventListener("click", () => {
    const id = b.dataset.nowEdit;
    const d = new Date();
    const z = n => String(n).padStart(2, "0");
    $(`#${id}`).value = `${z(d.getHours())}:${z(d.getMinutes())}`;
  });
});
$("#btnNowDateEdit")?.addEventListener("click", () => { $("#edit_occurrenceDate").value = ymd(); });

/* ---- ä¿è­·: ç”»é¢å†…ã®æ¬ è½UIã«å¯¾ã™ã‚‹ãƒ¯ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆé–‹ç™ºæ™‚ã®è¦‹è½ã¨ã—æ¤œçŸ¥ï¼‰ ---- */
(function devGuard() {
  const missing = [];
  [
    ["#btnExport","CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³"],
    ["#btnImport","CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³"],
    ["#deptList","#btnSaveDepartmentsï¼ˆéƒ¨ç½²ä¿å­˜UIï¼‰"],
    ["#lineManageDept","#btnSaveLinesï¼ˆãƒ©ã‚¤ãƒ³ä¿å­˜UIï¼‰"],
    ["#handlerManageDept","#btnSaveHandlersï¼ˆå‡¦ç½®è€…ä¿å­˜UIï¼‰"]
  ].forEach(([sel, label]) => { if (!document.querySelector(sel)) missing.push(label); });
  if (missing.length) {
    console.warn("UIæœªé…ç½®ã®å¯èƒ½æ€§:", missing);
  }
})();

  </script>
</body>
</html>
