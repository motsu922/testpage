<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>QRç…§åˆã‚·ã‚¹ãƒ†ãƒ </title>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <style>
    * { box-sizing:border-box; margin:0; padding:0; }

    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:#0a0a0a !important;
      min-height:100vh;
      color:#e0e0e0;
    }
    html{ background:#0a0a0a !important; }

    /* ã‚¿ãƒ–ãƒŠãƒ“ */
    .tab-nav{
      display:flex;
      background:#1a1a1a;
      position:sticky;
      top:0;
      z-index:100;
      border-bottom:1px solid #333;
    }
    .tab-btn{
      flex:1;
      padding:16px;
      background:transparent;
      border:none;
      color:rgba(255,255,255,0.5);
      font-size:15px;
      font-weight:600;
      cursor:pointer;
      transition:all .2s;
      border-bottom:3px solid transparent;
    }
    .tab-btn.active{
      color:#4fc3f7;
      background:rgba(79,195,247,0.1);
      border-bottom-color:#4fc3f7;
    }
    .tab-content{ display:none; background:#0a0a0a; }
    .tab-content.active{ display:block; background:#0a0a0a; }

    /* FirebaseçŠ¶æ…‹ */
    .firebase-status{
      padding:8px 16px;
      font-size:12px;
      text-align:center;
    }
    .firebase-status.connected{ background:#1b3d1b; color:#4caf50; }
    .firebase-status.disconnected{ background:#3d2e1b; color:#ff9800; }
    .firebase-status.error{ background:#3d1b1b; color:#f44336; }

    /* ========== ç…§åˆ ========== */
    .scan-screen{
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:calc(100vh - 100px);
      padding:20px;
      background:#0a0a0a;
      position:relative; /* æš—è»¢ãƒ¬ã‚¤ãƒ¤ç”¨ */
    }

    /* STEP2 æš—è»¢ãƒ¬ã‚¤ãƒ¤ */
    .dim-layer{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,0.55);
      display:none;
      z-index:1;
      pointer-events:none; /* è¦‹ãŸç›®ã ã‘ã€‚stopãƒœã‚¿ãƒ³ç­‰ã¯ãã®ã¾ã¾æŠ¼ã›ã‚‹ */
    }
    .dim-layer.show{ display:block; }

    .scan-box{
      width:100%;
      max-width:400px;
      background:#1a1a1a;
      border-radius:20px;
      padding:30px;
      box-shadow:0 4px 20px rgba(0,0,0,0.5);
      text-align:center;
      border:1px solid #333;
      position:relative;
      z-index:2; /* æš—è»¢ã‚ˆã‚Šå‰ */
    }
    .scan-step{
      font-size:16px;
      color:#888;
      margin-bottom:8px;
    }
    .scan-message{
      font-size:26px;
      font-weight:700;
      color:#4fc3f7;
      margin-bottom:24px;
    }
    .scan-message.step2{ color:#ffb74d; }

    .scan-input-area{ position:relative; margin-bottom:20px; }
    .scan-input{
      width:100%;
      padding:20px;
      font-size:24px;
      text-align:center;
      border:3px solid #4fc3f7;
      border-radius:12px;
      outline:none;
      font-family:monospace;
      ime-mode:disabled;
      -webkit-ime-mode:disabled;
      background:#0a0a0a;
      color:#fff;
    }
    .scan-input:focus{
      border-color:#00c853;
      box-shadow:0 0 0 4px rgba(0,200,83,0.3);
    }
    .scan-input.step2{ border-color:#ffb74d; }
    .scan-input.step2:focus{
      border-color:#ffb74d;
      box-shadow:0 0 0 4px rgba(255,183,77,0.3);
    }
    .input-hint{ font-size:14px; color:#666; margin-top:10px; }
    .scanner-icon{ font-size:64px; margin-bottom:20px; }

    .stop-btn{
      margin-top:20px;
      padding:14px 40px;
      background:#d32f2f;
      color:white;
      border:none;
      border-radius:12px;
      font-size:16px;
      font-weight:700;
      cursor:pointer;
      position:relative;
      z-index:2; /* æš—è»¢ã‚ˆã‚Šå‰ */
    }

    /* ãƒ­ã‚° */
    .log-card{
      background:#1a1a1a;
      border-radius:12px;
      padding:16px;
      margin-top:20px;
      box-shadow:0 2px 8px rgba(0,0,0,0.3);
      border:1px solid #333;
      width:100%;
      max-width:400px;
    }
    .log-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .log-title{ font-size:14px; font-weight:600; color:#e0e0e0; }
    .log-count{
      font-size:11px;
      color:#888;
      background:#2a2a2a;
      padding:3px 8px;
      border-radius:8px;
    }
    .log-list{ max-height:200px; overflow-y:auto; }
    .log-item{
      padding:8px 10px;
      border-radius:6px;
      margin-bottom:4px;
      font-size:11px;
    }
    .log-item.ok{ background:#1b3d1b; border-left:3px solid #4caf50; }
    .log-item.ng{ background:#3d1b1b; border-left:3px solid #f44336; }
    .log-time{ color:#888; font-size:10px; }
    .log-result{ font-weight:600; margin:2px 0; }
    .log-item.ok .log-result{ color:#4caf50; }
    .log-item.ng .log-result{ color:#f44336; }
    .log-values{ font-family:monospace; font-size:10px; color:#aaa; }
    .no-log{ text-align:center; color:#666; padding:16px; font-size:12px; }

    .log-actions{ display:flex; gap:8px; margin-top:10px; }
    .log-btn{
      flex:1;
      padding:8px;
      background:#2a2a2a;
      border:1px solid #444;
      border-radius:6px;
      font-size:12px;
      color:#aaa;
      cursor:pointer;
    }
    .log-btn:hover{ background:#333; }

    /* ========== è¨­å®š ========== */
    .container{ padding:16px; max-width:500px; margin:0 auto; background:#0a0a0a; }
    .settings-locked{ text-align:center; padding:40px 20px; }
    .lock-icon{ font-size:64px; margin-bottom:16px; }
    .lock-text{ font-size:16px; color:#888; margin-bottom:20px; }
    .password-input-group{ display:flex; gap:8px; max-width:300px; margin:0 auto; }
    .password-input-group input{
      flex:1; padding:12px; border:2px solid #444; border-radius:8px;
      font-size:16px; background:#1a1a1a; color:#fff;
    }
    .password-input-group button{
      padding:12px 20px; background:#4fc3f7; color:#000; border:none;
      border-radius:8px; font-size:14px; font-weight:600; cursor:pointer;
    }
    .settings-unlocked{ display:none; }
    .settings-card{
      background:#1a1a1a;
      border-radius:12px;
      padding:16px;
      margin-bottom:16px;
      box-shadow:0 2px 8px rgba(0,0,0,0.3);
      border:1px solid #333;
    }
    .settings-card-title{
      font-size:15px; font-weight:700; color:#4fc3f7;
      margin-bottom:14px; padding-bottom:10px; border-bottom:2px solid #333;
    }
    .setting-row{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 0; border-bottom:1px solid #333;
    }
    .setting-row:last-child{ border-bottom:none; }
    .setting-label{ font-size:14px; color:#e0e0e0; }

    .setting-input{
      width:100%; padding:8px; border:2px solid #444; border-radius:6px;
      font-size:14px; margin-top:8px; background:#0a0a0a; color:#fff;
    }
    .setting-input-wide{
      width:100%; padding:10px; border:2px solid #444; border-radius:6px;
      font-size:12px; font-family:monospace; margin-top:8px;
      background:#0a0a0a; color:#fff;
    }

    .toggle-switch{
      width:50px; height:28px; background:#444; border-radius:14px;
      position:relative; cursor:pointer; transition:background .3s;
    }
    .toggle-switch.on{ background:#00c853; }
    .toggle-switch::after{
      content:''; position:absolute; width:24px; height:24px; background:#fff;
      border-radius:50%; top:2px; left:2px; transition:left .3s;
      box-shadow:0 2px 4px rgba(0,0,0,0.3);
    }
    .toggle-switch.on::after{ left:24px; }

    .save-btn{
      width:100%; padding:16px; background:#00c853; color:#000; border:none;
      border-radius:12px; font-size:18px; font-weight:700; cursor:pointer;
      margin-top:8px;
    }
    .lock-settings-btn{
      width:100%; padding:12px; background:#2a2a2a; color:#888;
      border:2px solid #444; border-radius:10px; font-size:14px;
      cursor:pointer; margin-top:12px;
    }

    /* ========== çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ========== */
    .result-overlay{
      position:fixed; top:0; left:0; width:100%; height:100%;
      display:none; flex-direction:column; justify-content:center; align-items:center;
      z-index:1000;
    }
    .result-overlay.show{ display:flex; animation:fadeIn .15s ease; }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
    .result-overlay.ok{ background:rgba(0,100,0,0.97); }
    .result-overlay.ng{ background:rgba(139,0,0,0.97); }

    .result-symbol{
      font-size:min(50vw,50vh);
      font-weight:900;
      color:#fff;
      text-shadow:0 4px 20px rgba(0,0,0,0.5);
      line-height:1;
    }
    .result-text{ font-size:32px; color:#fff; margin-top:10px; font-weight:700; }
    .result-detail{
      margin-top:20px; padding:16px 24px; background:rgba(255,255,255,0.1);
      border-radius:12px; text-align:center;
    }
    .result-detail p{ color:#fff; font-size:14px; margin:4px 0; font-family:monospace; }
    .result-detail .label{ font-size:11px; opacity:0.8; font-family:inherit; }
    .result-btn{
      margin-top:24px; padding:16px 50px; background:#fff; border:none;
      border-radius:10px; font-size:18px; font-weight:700; cursor:pointer;
    }
    .result-overlay.ok .result-btn{ color:#006400; }
    .result-overlay.ng .result-btn{ color:#8b0000; }

    .ng-locked .result-symbol{ animation:shake .4s ease infinite; }
    @keyframes shake{
      0%,100%{transform:translateX(0)}
      25%{transform:translateX(-8px)}
      75%{transform:translateX(8px)}
    }

    .admin-area{
      margin-top:20px; padding:16px; background:rgba(255,255,255,0.1);
      border-radius:12px; text-align:center;
    }
    .admin-area p{ color:#fff; font-size:13px; margin-bottom:10px; }
    .admin-input{
      padding:12px; border:none; border-radius:8px; font-size:16px; width:200px;
      text-align:center; background:rgba(255,255,255,0.9); color:#000;
    }

    /* scroll */
    ::-webkit-scrollbar{ width:6px; }
    ::-webkit-scrollbar-track{ background:#1a1a1a; }
    ::-webkit-scrollbar-thumb{ background:#444; border-radius:3px; }
    ::-webkit-scrollbar-thumb:hover{ background:#555; }
  </style>
</head>

<body>
  <!-- ã‚¿ãƒ–ãƒŠãƒ“ -->
  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('scan')">ğŸ“· ç…§åˆ</button>
    <button class="tab-btn" onclick="switchTab('settings')">âš™ï¸ è¨­å®š</button>
  </div>

  <!-- Firebaseæ¥ç¶šçŠ¶æ…‹ -->
  <div class="firebase-status disconnected" id="firebaseStatus">ğŸ”Œ Firebaseæœªæ¥ç¶š</div>

  <!-- ========== ç…§åˆã‚¿ãƒ– ========== -->
  <div class="tab-content active" id="tab-scan">
    <!-- ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ç„¡ã—ï¼šèµ·å‹•ï¼å³ã‚¹ã‚­ãƒ£ãƒ³ï¼‰ -->
    <div class="scan-screen" id="scanScreen" onclick="focusScanInput()">
      <div class="dim-layer" id="dimLayer"></div>

      <div class="scan-box">
        <div class="scanner-icon">ğŸ“Ÿ</div>
        <div class="scan-step" id="scanStep">STEP 1 / 2</div>
        <div class="scan-message" id="scanMessage">1å›ç›®ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„</div>

        <div class="scan-input-area">
          <input type="text" class="scan-input" id="scanInput"
                 placeholder="QRãƒªãƒ¼ãƒ€ãƒ¼ã§èª­ã¿å–ã‚Š"
                 autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
                 inputmode="latin"
                 style="ime-mode: disabled;">
          <div class="input-hint">QRãƒªãƒ¼ãƒ€ãƒ¼ã§ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„</div>
        </div>
      </div>

      <button class="stop-btn" onclick="stopAndReset()">â¹ï¸ ãƒªã‚»ãƒƒãƒˆ</button>

      <!-- ãƒ­ã‚°ï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰ -->
      <div class="log-card">
        <div class="log-header">
          <div class="log-title">ğŸ“ ç…§åˆå±¥æ­´</div>
          <div class="log-count" id="logCount">0ä»¶</div>
        </div>
        <div class="log-list" id="logList">
          <div class="no-log">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>
        </div>
        <div class="log-actions">
          <button class="log-btn" onclick="clearLog()">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
          <button class="log-btn" onclick="exportLog()">ğŸ“¥ å‡ºåŠ›</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== è¨­å®šã‚¿ãƒ– ========== -->
  <div class="tab-content" id="tab-settings">
    <div class="container">
      <!-- ãƒ­ãƒƒã‚¯ç”»é¢ -->
      <div class="settings-locked" id="settingsLocked">
        <div class="lock-icon">ğŸ”’</div>
        <div class="lock-text">è¨­å®šã‚’å¤‰æ›´ã™ã‚‹ã«ã¯<br>ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
        <div class="password-input-group">
          <input type="password" id="unlockPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
          <button onclick="unlockSettings()">è§£é™¤</button>
        </div>
      </div>

      <!-- è¨­å®šç”»é¢ -->
      <div class="settings-unlocked" id="settingsUnlocked">
        <!-- Firebaseè¨­å®š -->
        <div class="settings-card">
          <div class="settings-card-title">ğŸ”¥ Firebaseè¨­å®š</div>

          <div class="setting-row" style="flex-direction: column; align-items: flex-start;">
            <span class="setting-label">API Key</span>
            <input type="text" class="setting-input-wide" id="fbApiKey" placeholder="AIza...">
          </div>

          <div class="setting-row" style="flex-direction: column; align-items: flex-start;">
            <span class="setting-label">Auth Domain</span>
            <input type="text" class="setting-input-wide" id="fbAuthDomain" placeholder="your-app.firebaseapp.com">
          </div>

          <div class="setting-row" style="flex-direction: column; align-items: flex-start;">
            <span class="setting-label">Database URL</span>
            <input type="text" class="setting-input-wide" id="fbDatabaseURL" placeholder="https://your-app-default-rtdb.firebaseio.com">
          </div>

          <div class="setting-row" style="flex-direction: column; align-items: flex-start;">
            <span class="setting-label">Project ID</span>
            <input type="text" class="setting-input-wide" id="fbProjectId" placeholder="your-project-id">
          </div>

          <button class="log-btn" style="width: 100%; margin-top: 12px;" onclick="testFirebaseConnection()">ğŸ”Œ æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
        </div>

        <!-- å“ç•ªæŠ½å‡ºãƒ«ãƒ¼ãƒ« -->
        <div class="settings-card">
          <div class="settings-card-title">ğŸ“ å“ç•ªæŠ½å‡ºãƒ«ãƒ¼ãƒ«è¨­å®š</div>
          <p style="font-size:12px;color:#666;margin-bottom:12px;">
            2å›ç›®QRã®å…¨ä½“æ–‡å­—æ•°ã«å¿œã˜ã¦ã€å“ç•ªã®é–‹å§‹ä½ç½®ã¨æ–‡å­—æ•°ã‚’è¨­å®šã—ã¾ã™ã€‚<br>
            1å›ç›®QRã®ä¸­ã«ã“ã®å“ç•ªãŒå«ã¾ã‚Œã¦ã„ã‚Œã°ä¸€è‡´(â—‹)ã¨ãªã‚Šã¾ã™ã€‚
          </p>

          <div id="extractRulesContainer"></div>
          <button class="log-btn" style="width: 100%; margin-top: 12px;" onclick="addExtractRule()">â• ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ </button>
        </div>

        <!-- ç®¡ç†è€…è¨­å®š -->
        <div class="settings-card">
          <div class="settings-card-title">ğŸ” ç®¡ç†è€…è¨­å®š</div>

          <div class="setting-row" style="flex-direction: column; align-items: flex-start;">
            <span class="setting-label">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</span>
            <input type="password" class="setting-input" id="adminPassword" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width: 100%;">
          </div>

          <div class="setting-row" style="flex-direction: column; align-items: flex-start;">
            <span class="setting-label">ç®¡ç†è€…QRï¼ˆã‚¨ãƒ©ãƒ¼è§£é™¤ç”¨ï¼‰</span>
            <input type="text" class="setting-input" id="adminQR" placeholder="QRã®å€¤" style="width: 100%;">
          </div>
        </div>

        <!-- ãã®ä»– -->
        <div class="settings-card">
          <div class="settings-card-title">ğŸ”Š ãã®ä»–</div>

          <div class="setting-row">
            <span class="setting-label">ç…§åˆéŸ³ã‚’é³´ã‚‰ã™</span>
            <div class="toggle-switch on" id="soundToggle" onclick="toggleSound()"></div>
          </div>

          <div class="setting-row">
            <span class="setting-label">ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</span>
            <div class="toggle-switch on" id="vibrationToggle" onclick="toggleVibration()"></div>
          </div>

          <div class="setting-row">
            <span class="setting-label">å…¨è§’â†’åŠè§’å¤‰æ›</span>
            <div class="toggle-switch on" id="normalizeToggle" onclick="toggleNormalize()"></div>
          </div>
        </div>

        <button class="save-btn" onclick="saveAllSettings()">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
        <button class="lock-settings-btn" onclick="lockSettings()">ğŸ”’ è¨­å®šã‚’ãƒ­ãƒƒã‚¯</button>
      </div>
    </div>
  </div>

  <!-- çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div class="result-overlay" id="resultOverlay">
    <div class="result-symbol" id="resultSymbol">â—‹</div>
    <div class="result-text" id="resultText">ä¸€è‡´</div>
    <div class="result-detail" id="resultDetail"></div>
    <button class="result-btn" id="okBtn" onclick="closeAndContinue()">æ¬¡ã®ç…§åˆã¸</button>

    <div class="admin-area" id="adminArea" style="display:none;">
      <p>âš ï¸ ç®¡ç†è€…QRã§è§£é™¤ã—ã¦ãã ã•ã„</p>
      <input type="text" class="admin-input" id="adminInput"
             placeholder="ç®¡ç†è€…QRã‚’èª­ã¿å–ã‚Š"
             autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
             inputmode="latin"
             style="ime-mode: disabled;">
    </div>
  </div>

  <script>
    // ========== çŠ¶æ…‹ ==========
    let currentStep = 0; // 0:åœæ­¢ 1:STEP1å¾…ã¡ 2:STEP2å¾…ã¡
    let value1 = '';
    let value2 = '';
    let isNGLocked = false;

    let scanLog = [];
    let audioCtx = null;

    let firebaseApp = null;
    let database = null;
    let logsRef = null;

    let scanFocusTimer = null;

    // è¨­å®š
    let settings = {
      adminPassword: 'admin',
      adminQR: 'ADMIN123',
      soundEnabled: true,
      vibrationEnabled: true,
      normalizeToHalfWidth: true,
      firebase: { apiKey:'', authDomain:'', databaseURL:'', projectId:'' },
      extractRules: [
        { totalLength: 10, startPos: 1, charCount: 5 },
        { totalLength: 15, startPos: 3, charCount: 6 },
        { totalLength: 20, startPos: 5, charCount: 8 }
      ]
    };

    // ========== å…¨è§’â†’åŠè§’ ==========
    function toHalfWidth(str){
      if (!str) return '';
      return str
        .replace(/[\uFF01-\uFF5E]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0))
        .replace(/\u3000/g, ' ');
    }
    function normalizeInput(str){
      if (!str) return '';
      return settings.normalizeToHalfWidth ? toHalfWidth(str) : str;
    }

    // ========== åˆæœŸåŒ– ==========
    document.addEventListener('DOMContentLoaded', () => {
      loadSettings();
      loadLog();
      setupInputListeners();
      initFirebase();

      // â­ èµ·å‹•ï¼å³ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ç„¡ã—ï¼‰
      startScanning();

      // iPhoneå¯¾ç­–ï¼šè¡¨ç¤ºãŒè½ã¡ç€ã„ãŸå¾Œã«å†ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      setTimeout(() => focusScanInput(), 200);
    });

    // ========== ãƒ•ã‚©ãƒ¼ã‚«ã‚¹åˆ¶å¾¡ ==========
    function focusScanInput(){
      const input = document.getElementById('scanInput');
      if (input) input.focus();
    }
    function startScanFocusGuard(){
      stopScanFocusGuard();
      scanFocusTimer = setInterval(() => {
        const overlayShown = document.getElementById('resultOverlay').classList.contains('show');
        if (currentStep > 0 && !overlayShown){
          const input = document.getElementById('scanInput');
          if (input && document.activeElement !== input){
            input.focus();
          }
        }
      }, 1000);
    }
    function stopScanFocusGuard(){
      if (scanFocusTimer){
        clearInterval(scanFocusTimer);
        scanFocusTimer = null;
      }
    }

    // ========== Firebase ==========
    function initFirebase(){
      if (!settings.firebase.apiKey || !settings.firebase.databaseURL){
        updateFirebaseStatus('disconnected','ğŸ”Œ Firebaseæœªè¨­å®š');
        return;
      }
      try{
        const firebaseConfig = {
          apiKey: settings.firebase.apiKey,
          authDomain: settings.firebase.authDomain,
          databaseURL: settings.firebase.databaseURL,
          projectId: settings.firebase.projectId
        };

        if (firebaseApp){
          firebaseApp.delete();
        }

        firebaseApp = firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        logsRef = database.ref('qr_match_logs');

        database.ref('.info/connected').on('value', (snapshot) => {
          if (snapshot.val() === true){
            updateFirebaseStatus('connected','ğŸŸ¢ Firebaseæ¥ç¶šä¸­');
            setupRealtimeSync();
          }else{
            updateFirebaseStatus('disconnected','ğŸ”Œ Firebaseæœªæ¥ç¶š');
          }
        });
      }catch(err){
        console.error('FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', err);
        updateFirebaseStatus('error','âŒ Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼');
      }
    }

    function setupRealtimeSync(){
      if (!logsRef) return;
      logsRef.orderByChild('timestamp').limitToLast(100).on('value', (snapshot) => {
        const data = snapshot.val();
        if (data){
          scanLog = Object.entries(data)
            .map(([key,val]) => ({...val, firebaseKey:key}))
            .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
          renderLog();
        }
      });
    }

    function updateFirebaseStatus(status, message){
      const el = document.getElementById('firebaseStatus');
      el.className = 'firebase-status ' + status;
      el.textContent = message;
    }

    function testFirebaseConnection(){
      settings.firebase.apiKey = document.getElementById('fbApiKey').value.trim();
      settings.firebase.authDomain = document.getElementById('fbAuthDomain').value.trim();
      settings.firebase.databaseURL = document.getElementById('fbDatabaseURL').value.trim();
      settings.firebase.projectId = document.getElementById('fbProjectId').value.trim();
      initFirebase();
      alert('æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚ä¸Šéƒ¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }

    function saveLogToFirebase(logEntry){
      if (!logsRef) return;
      logsRef.push(logEntry).catch(err => console.error('Firebaseä¿å­˜ã‚¨ãƒ©ãƒ¼:', err));
    }

    function clearFirebaseLogs(){
      if (!logsRef) return;
      logsRef.remove().catch(err => console.error('Firebaseã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', err));
    }

    // ========== å…¥åŠ›ãƒªã‚¹ãƒŠãƒ¼ï¼ˆEnterç„¡ã—ã§ã‚‚ç¢ºå®šï¼‰ ==========
    function setupQRLikeInput(el, onCommit){
      if (!el) return;
      let timer = null;
      const DELAY = 120;

      el.addEventListener('input', () => {
        if (timer) clearTimeout(timer);
        if (!el.value) return;

        timer = setTimeout(() => {
          let v = normalizeInput(el.value.trim());
          if (v) onCommit(v);
          el.value = '';
        }, DELAY);
      });

      el.addEventListener('keypress', (e) => {
        if (e.key === 'Enter'){
          e.preventDefault();
          let v = normalizeInput(el.value.trim());
          if (v) onCommit(v);
          el.value = '';
        }
      });
    }

    function setupInputListeners(){
      const scanInput  = document.getElementById('scanInput');
      const adminInput = document.getElementById('adminInput');
      setupQRLikeInput(scanInput, handleScan);
      setupQRLikeInput(adminInput, handleAdminScan);
    }

    // ========== éŸ³ãƒ»ãƒã‚¤ãƒ– ==========
    function initAudio(){
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }

    /**
     * éŸ³ã®ç¨®é¡:
     *  - step1: 1å›ç›®èª­ã¿å–ã‚Šå®Œäº†
     *  - step2: 2å›ç›®èª­ã¿å–ã‚Šå®Œäº†
     *  - ok: ä¸€è‡´
     *  - ng: ä¸ä¸€è‡´ï¼ˆã“ã®æ™‚ã ã‘é•·ãƒã‚¤ãƒ–ï¼‰
     */
    function playSound(type){
      if (!settings.soundEnabled) return;
      initAudio();

      if (audioCtx.state === 'suspended'){
        audioCtx.resume();
      }

      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
      gain.gain.value = 0.45;

      if (type === 'step1'){
        osc.type = 'sine';
        osc.frequency.value = 1050;
        osc.start();
        setTimeout(() => osc.stop(), 90);
        // ãƒã‚¤ãƒ–ç„¡ã—ï¼ˆè¦æœ›ï¼‰
      }
      else if (type === 'step2'){
        osc.type = 'sine';
        osc.frequency.value = 1450;
        osc.start();
        setTimeout(() => osc.stop(), 110);
        // ãƒã‚¤ãƒ–ç„¡ã—ï¼ˆè¦æœ›ï¼‰
      }
      else if (type === 'ok'){
        osc.type = 'sine';
        osc.frequency.value = 1200;
        osc.start();
        setTimeout(() => osc.frequency.value = 1550, 90);
        setTimeout(() => osc.stop(), 200);
        // ãƒã‚¤ãƒ–ç„¡ã—ï¼ˆè¦æœ›ï¼šNGã®ã¿é•·ãƒã‚¤ãƒ–ï¼‰
      }
      else if (type === 'ng'){
        osc.type = 'square';
        osc.frequency.value = 260;
        gain.gain.value = 0.38;
        osc.start();
        setTimeout(() => osc.stop(), 450);

        // âœ… NGæ™‚ã ã‘é•·ãƒã‚¤ãƒ–
        vibrateLongOnly();
      }
    }

    function vibrateLongOnly(){
      if (!settings.vibrationEnabled) return;
      if (navigator.vibrate){
        navigator.vibrate([800]); // é•·ã‚
      }
    }

    function toggleSound(){
      settings.soundEnabled = !settings.soundEnabled;
      document.getElementById('soundToggle').className =
        settings.soundEnabled ? 'toggle-switch on' : 'toggle-switch';
    }
    function toggleVibration(){
      settings.vibrationEnabled = !settings.vibrationEnabled;
      document.getElementById('vibrationToggle').className =
        settings.vibrationEnabled ? 'toggle-switch on' : 'toggle-switch';
    }
    function toggleNormalize(){
      const el = document.getElementById('normalizeToggle');
      el.classList.toggle('on');
      settings.normalizeToHalfWidth = el.classList.contains('on');
    }

    // ========== ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç† ==========
    function handleScan(decoded){
      if (currentStep === 1){
        value1 = decoded;
        playSound('step1');    // âœ… STEP1éŸ³
        currentStep = 2;
        updateScanUI();
        focusScanInput();
      }
      else if (currentStep === 2){
        value2 = decoded;
        playSound('step2');    // âœ… STEP2éŸ³
        doMatch();
      }
    }

    function handleAdminScan(value){
      if (value === settings.adminQR){
        isNGLocked = false;
        playSound('ok');
        document.getElementById('resultOverlay').classList.remove('show');
        // è§£é™¤å¾Œã¯å³å†é–‹
        startScanning();
        alert('âœ… ã‚¨ãƒ©ãƒ¼è§£é™¤ã—ã¾ã—ãŸ');
      }else{
        playSound('ng');
        alert('âŒ ç®¡ç†è€…QRãŒä¸€è‡´ã—ã¾ã›ã‚“');
        document.getElementById('adminInput').focus();
      }
    }

    // ========== å“ç•ªæŠ½å‡º ==========
    function extractPartNumber(qr2){
      const totalLen = qr2.length;
      const rule = settings.extractRules.find(r => r.totalLength === totalLen);
      if (rule){
        const start = rule.startPos - 1;
        return qr2.substring(start, start + rule.charCount);
      }
      return qr2;
    }

    // ========== ç…§åˆ ==========
    function doMatch(){
      const partNumber = extractPartNumber(value2);
      const isOK = value1.includes(partNumber);

      const logEntry = {
        timestamp: new Date().toISOString(),
        qr1: value1,
        qr2: value2,
        partNumber,
        qr2Length: value2.length,
        result: isOK ? 'OK' : 'NG'
      };

      scanLog.unshift(logEntry);
      if (scanLog.length > 100) scanLog.pop();
      saveLog();
      renderLog();
      saveLogToFirebase(logEntry);

      showResult(isOK, partNumber);
    }

    // ========== çµæœè¡¨ç¤º ==========
    function showResult(isOK, partNumber){
      const overlay = document.getElementById('resultOverlay');
      const symbol  = document.getElementById('resultSymbol');
      const text    = document.getElementById('resultText');
      const detail  = document.getElementById('resultDetail');
      const okBtn   = document.getElementById('okBtn');
      const adminArea = document.getElementById('adminArea');

      overlay.classList.add('show');

      if (isOK){
        overlay.className = 'result-overlay show ok';
        symbol.textContent = 'â—‹';
        text.textContent = 'ä¸€è‡´';
        detail.innerHTML = `<p class="label">å“ç•ª</p><p>${partNumber}</p>`;
        okBtn.style.display = 'block';
        adminArea.style.display = 'none';
        playSound('ok');

        // â˜…å®Œå…¨ãƒãƒ¼ã‚¿ãƒƒãƒé‹ç”¨ã«ã—ãŸã„å ´åˆï¼šè‡ªå‹•ã§æ¬¡ã¸
        // setTimeout(() => closeAndContinue(), 450);

      }else{
        overlay.className = 'result-overlay show ng ng-locked';
        symbol.textContent = 'Ã—';
        text.textContent = 'ä¸ä¸€è‡´';
        detail.innerHTML = `
          <p class="label">æŠ½å‡ºã—ãŸå“ç•ª</p><p>${partNumber}</p>
          <p class="label" style="margin-top:8px;">1å›ç›®QRã«å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“</p>
        `;
        okBtn.style.display = 'none';
        adminArea.style.display = 'block';
        isNGLocked = true;
        playSound('ng');
        stopScanFocusGuard(); // NGæ™‚ã¯ç®¡ç†è€…å…¥åŠ›å„ªå…ˆ
        setTimeout(() => document.getElementById('adminInput').focus(), 120);
      }
    }

    function closeAndContinue(){
      document.getElementById('resultOverlay').classList.remove('show');
      setTimeout(() => startScanning(), 120);
    }

    // ========== UI ==========
    function setDimLayer(on){
      const dim = document.getElementById('dimLayer');
      if (!dim) return;
      dim.classList.toggle('show', !!on);
    }

    function updateScanUI(){
      const step = document.getElementById('scanStep');
      const message = document.getElementById('scanMessage');
      const input = document.getElementById('scanInput');

      if (currentStep === 1){
        step.textContent = 'STEP 1 / 2';
        message.textContent = '1å›ç›®ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„';
        message.className = 'scan-message';
        input.className = 'scan-input';
        input.placeholder = 'QRãƒªãƒ¼ãƒ€ãƒ¼ã§èª­ã¿å–ã‚Š';
        setDimLayer(false); // âœ… æš—è»¢OFF
      }
      else if (currentStep === 2){
        step.textContent = 'STEP 2 / 2';
        message.textContent = '2å›ç›®ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„';
        message.className = 'scan-message step2';
        input.className = 'scan-input step2';
        input.placeholder = 'QRãƒªãƒ¼ãƒ€ãƒ¼ã§èª­ã¿å–ã‚Š';
        setDimLayer(true); // âœ… STEP2å¾…ã¡ä¸­ã¯æš—è»¢
      }
    }

    // ========== ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ãƒ»åœæ­¢ ==========
    function startScanning(){
      if (isNGLocked){
        showNGOverlay();
        return;
      }

      value1 = '';
      value2 = '';
      currentStep = 1;

      updateScanUI();
      focusScanInput();
      startScanFocusGuard();
    }

    function stopAndReset(){
      // ç¾å ´å‘ã‘ï¼šåœæ­¢ã§ã¯ãªãã€ŒSTEP1ã¸æˆ»ã™ã€
      isNGLocked = false;
      document.getElementById('resultOverlay').classList.remove('show');

      value1 = '';
      value2 = '';
      currentStep = 1;

      updateScanUI();
      focusScanInput();
      startScanFocusGuard();
    }

    function showNGOverlay(){
      const overlay = document.getElementById('resultOverlay');
      overlay.className = 'result-overlay show ng ng-locked';
      document.getElementById('resultSymbol').textContent = 'Ã—';
      document.getElementById('resultText').textContent = 'ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹';
      document.getElementById('resultDetail').innerHTML = '<p>ç®¡ç†è€…QRã§è§£é™¤ãŒå¿…è¦</p>';
      document.getElementById('okBtn').style.display = 'none';
      document.getElementById('adminArea').style.display = 'block';
      stopScanFocusGuard();
      setTimeout(() => document.getElementById('adminInput').focus(), 120);
    }

    // ========== è¨­å®šãƒ­ãƒƒã‚¯ ==========
    function unlockSettings(){
      const input = document.getElementById('unlockPassword').value;
      if (input === settings.adminPassword){
        document.getElementById('settingsLocked').style.display = 'none';
        document.getElementById('settingsUnlocked').style.display = 'block';
        document.getElementById('unlockPassword').value = '';
      }else{
        alert('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
      }
    }
    function lockSettings(){
      document.getElementById('settingsLocked').style.display = 'block';
      document.getElementById('settingsUnlocked').style.display = 'none';
    }

    // ========== ã‚¿ãƒ–åˆ‡æ›¿ ==========
    function switchTab(tab){
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      if (tab === 'scan'){
        document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
        document.getElementById('tab-scan').classList.add('active');
        setTimeout(() => focusScanInput(), 120);
      }else{
        document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
        document.getElementById('tab-settings').classList.add('active');
        stopScanFocusGuard();
      }
    }

    // ========== è¨­å®šä¿å­˜/è¡¨ç¤º ==========
    function loadSettings(){
      const saved = localStorage.getItem('qrMatchSettings_v6');
      if (saved){
        settings = { ...settings, ...JSON.parse(saved) };
      }
      applySettingsToForm();
    }

    function applySettingsToForm(){
      document.getElementById('adminQR').value = settings.adminQR;

      document.getElementById('soundToggle').className =
        settings.soundEnabled ? 'toggle-switch on' : 'toggle-switch';

      document.getElementById('vibrationToggle').className =
        settings.vibrationEnabled ? 'toggle-switch on' : 'toggle-switch';

      const norm = document.getElementById('normalizeToggle');
      norm.className = settings.normalizeToHalfWidth ? 'toggle-switch on' : 'toggle-switch';

      document.getElementById('fbApiKey').value = settings.firebase.apiKey || '';
      document.getElementById('fbAuthDomain').value = settings.firebase.authDomain || '';
      document.getElementById('fbDatabaseURL').value = settings.firebase.databaseURL || '';
      document.getElementById('fbProjectId').value = settings.firebase.projectId || '';

      renderExtractRules();
    }

    function renderExtractRules(){
      const container = document.getElementById('extractRulesContainer');
      container.innerHTML = settings.extractRules.map((rule, index) => `
        <div class="settings-card" style="background:#0a0a0a;border:1px solid #333;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <div style="font-weight:700;color:#ffb74d;">ãƒ«ãƒ¼ãƒ« ${index+1}</div>
            <button class="log-btn" style="flex:0 0 auto; padding:6px 10px; background:#f44336; color:#fff; border:none;"
                    onclick="removeExtractRule(${index})">å‰Šé™¤</button>
          </div>
          <div class="setting-row" style="border-bottom:none; flex-direction:column; align-items:flex-start;">
            <label class="setting-label" style="color:#888;">å…¨ä½“æ–‡å­—æ•°</label>
            <input type="number" class="setting-input-wide rule-totalLength" value="${rule.totalLength}" min="1">
          </div>
          <div class="setting-row" style="border-bottom:none; flex-direction:column; align-items:flex-start;">
            <label class="setting-label" style="color:#888;">é–‹å§‹ä½ç½®</label>
            <input type="number" class="setting-input-wide rule-startPos" value="${rule.startPos}" min="1">
          </div>
          <div class="setting-row" style="border-bottom:none; flex-direction:column; align-items:flex-start;">
            <label class="setting-label" style="color:#888;">æ–‡å­—æ•°</label>
            <input type="number" class="setting-input-wide rule-charCount" value="${rule.charCount}" min="1">
          </div>
          <div style="font-size:11px;color:#666;margin-top:6px;">
            ä¾‹: å…¨ä½“${rule.totalLength}æ–‡å­— â†’ ${rule.startPos}æ–‡å­—ç›®ã‹ã‚‰${rule.charCount}æ–‡å­—æŠ½å‡º
          </div>
        </div>
      `).join('');
    }

    function addExtractRule(){
      settings.extractRules.push({ totalLength: 10, startPos: 1, charCount: 5 });
      renderExtractRules();
    }

    function removeExtractRule(index){
      if (settings.extractRules.length <= 1){
        alert('æœ€ä½1ã¤ã®ãƒ«ãƒ¼ãƒ«ãŒå¿…è¦ã§ã™');
        return;
      }
      settings.extractRules.splice(index, 1);
      renderExtractRules();
    }

    function collectExtractRules(){
      const totals = document.querySelectorAll('.rule-totalLength');
      const starts = document.querySelectorAll('.rule-startPos');
      const counts = document.querySelectorAll('.rule-charCount');

      const rules = [];
      totals.forEach((el, i) => {
        rules.push({
          totalLength: parseInt(el.value) || 10,
          startPos: parseInt(starts[i].value) || 1,
          charCount: parseInt(counts[i].value) || 5
        });
      });
      return rules;
    }

    function saveAllSettings(){
      const newPassword = document.getElementById('adminPassword').value.trim();
      if (newPassword){
        settings.adminPassword = newPassword;
      }

      settings.adminQR = document.getElementById('adminQR').value.trim() || 'ADMIN123';

      settings.firebase.apiKey = document.getElementById('fbApiKey').value.trim();
      settings.firebase.authDomain = document.getElementById('fbAuthDomain').value.trim();
      settings.firebase.databaseURL = document.getElementById('fbDatabaseURL').value.trim();
      settings.firebase.projectId = document.getElementById('fbProjectId').value.trim();

      settings.extractRules = collectExtractRules();

      localStorage.setItem('qrMatchSettings_v6', JSON.stringify(settings));
      initFirebase();

      alert('âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      document.getElementById('adminPassword').value = '';
    }

    // ========== ãƒ­ã‚° ==========
    function loadLog(){
      const saved = localStorage.getItem('qrMatchLog_v6');
      if (saved){
        scanLog = JSON.parse(saved);
        renderLog();
      }
    }
    function saveLog(){
      localStorage.setItem('qrMatchLog_v6', JSON.stringify(scanLog));
    }
    function renderLog(){
      const container = document.getElementById('logList');
      document.getElementById('logCount').textContent = scanLog.length + 'ä»¶';

      if (scanLog.length === 0){
        container.innerHTML = '<div class="no-log">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      container.innerHTML = scanLog.slice(0, 50).map(l => {
        const t = new Date(l.timestamp).toLocaleString('ja-JP');
        return `
          <div class="log-item ${l.result.toLowerCase()}">
            <div class="log-time">${t}</div>
            <div class="log-result">${l.result === 'OK' ? 'âœ… OK' : 'âŒ NG'}</div>
            <div class="log-values">å“ç•ª: ${l.partNumber} (${l.qr2Length}æ–‡å­—ã‹ã‚‰æŠ½å‡º)</div>
          </div>
        `;
      }).join('');
    }

    function clearLog(){
      if (confirm('å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆFirebaseã®ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰')){
        scanLog = [];
        saveLog();
        renderLog();
        clearFirebaseLogs();
      }
    }

    function exportLog(){
      if (scanLog.length === 0) return alert('å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“');
      const headers = ['æ—¥æ™‚','çµæœ','1å›ç›®QR','2å›ç›®QR','æŠ½å‡ºå“ç•ª','2å›ç›®æ–‡å­—æ•°'];
      const rows = scanLog.map(l => [
        new Date(l.timestamp).toLocaleString('ja-JP'),
        l.result, l.qr1, l.qr2, l.partNumber, l.qr2Length
      ]);
      const csv = [headers, ...rows]
        .map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(','))
        .join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob(['\uFEFF' + csv], {type:'text/csv'}));
      a.download = `QRç…§åˆå±¥æ­´_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    }
  </script>
</body>
</html>
