<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Excel ヒストグラム生成ツール</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.11.7/umd/Recharts.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .histogram-bar {
      transition: all 0.3s ease;
    }
    .file-upload-label:hover {
      background-color: #f3f4f6;
    }
  </style>
</head>
<body class="bg-white">
  <div id="app" class="p-6 max-w-7xl mx-auto">
    <!-- コンテンツはJavaScriptで動的に挿入されます -->
  </div>

  <script>
    // Lucideアイコンを初期化
    lucide.createIcons();

    // アプリケーションの状態
    const state = {
      datasets: [],
      thresholds: [],
      newThreshold: '',
      binCount: 20,
      sigmaSettings: {},
      directInput: '',
      datasetName: '',
      showDirectInput: false,
      opacity: 0.6,
      rangeMode: '6sigma',
      customMin: '',
      customMax: '',
      customBinWidth: ''
    };

    // DOM要素の取得
    const app = document.getElementById('app');

    // レンダリング関数
    function render() {
      app.innerHTML = `
        <h1 class="text-3xl font-bold mb-6 text-gray-800">Excel ヒストグラム生成ツール</h1>

        <!-- ファイルアップロード -->
        <div class="mb-6 p-4 border-2 border-dashed border-gray-300 rounded-lg">
          <div class="flex items-center justify-center">
            <label class="flex flex-col items-center cursor-pointer file-upload-label">
              <i data-lucide="upload" class="w-8 h-8 text-gray-400 mb-2"></i>
              <span class="text-sm text-gray-600">Excelファイルをアップロード</span>
              <input
                type="file"
                accept=".xlsx,.xls"
                multiple
                class="hidden"
                id="fileInput"
              />
            </label>
          </div>
        </div>

        <!-- 直接入力セクション -->
        <div class="mb-6">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-xl font-semibold">直接データ入力</h2>
            <button
              onclick="toggleDirectInput()"
              class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 flex items-center gap-2"
            >
              <i data-lucide="edit-3" class="w-4 h-4"></i>
              ${state.showDirectInput ? '入力を閉じる' : '直接入力'}
            </button>
          </div>
          
          ${state.showDirectInput ? `
            <div class="border rounded-lg p-4 bg-gray-50">
              <div class="mb-4">
                <label class="block text-sm font-medium mb-2">データセット名</label>
                <input
                  type="text"
                  value="${state.datasetName}"
                  oninput="state.datasetName = this.value"
                  placeholder="例: サンプルデータ1"
                  class="w-full border rounded px-3 py-2"
                />
              </div>
              
              <div class="mb-4">
                <label class="block text-sm font-medium mb-2">
                  数値データ（カンマ、スペース、改行で区切って入力）
                </label>
                <textarea
                  value="${state.directInput}"
                  oninput="state.directInput = this.value"
                  placeholder="例: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10"
                  rows="6"
                  class="w-full border rounded px-3 py-2 font-mono text-sm"
                >${state.directInput}</textarea>
              </div>
              
              <div class="flex justify-end gap-2">
                <button
                  onclick="clearDirectInput()"
                  class="px-4 py-2 border rounded hover:bg-gray-100"
                >
                  クリア
                </button>
                <button
                  onclick="addDirectInputData()"
                  class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 flex items-center gap-2"
                  ${!state.directInput.trim() || !state.datasetName.trim() ? 'disabled' : ''}
                >
                  <i data-lucide="plus" class="w-4 h-4"></i>
                  データセット追加
                </button>
              </div>
            </div>
          ` : ''}
        </div>

        <!-- データセット管理 -->
        ${state.datasets.length > 0 ? `
          <div class="mb-6">
            <h2 class="text-xl font-semibold mb-3">データセット</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              ${state.datasets.map(dataset => `
                <div key="${dataset.id}" class="border rounded-lg p-4">
                  <div class="flex items-center justify-between mb-2">
                    <span class="font-medium" style="color: ${dataset.color}">
                      ${dataset.name}
                    </span>
                    <div class="flex gap-2">
                      <button
                        onclick="toggleDatasetVisibility('${dataset.id}')"
                        class="p-1 hover:bg-gray-100 rounded"
                      >
                        ${dataset.visible ? '<i data-lucide="eye" class="w-4 h-4"></i>' : '<i data-lucide="eye-off" class="w-4 h-4"></i>'}
                      </button>
                      <button
                        onclick="removeDataset('${dataset.id}')"
                        class="p-1 hover:bg-gray-100 rounded text-red-500"
                      >
                        <i data-lucide="minus" class="w-4 h-4"></i>
                      </button>
                    </div>
                  </div>
                  <div class="text-sm text-gray-600 mb-2">
                    データ数: ${dataset.data.length}
                  </div>
                  
                  <!-- シグマ設定 -->
                  <div class="space-y-1">
                    <div class="text-sm font-medium">シグマライン:</div>
                    ${[1, 2, 3].map(sigma => {
                      const stats = calculateStats(dataset.data);
                      const upperValue = stats.mean + sigma * stats.stdDev;
                      const lowerValue = stats.mean - sigma * stats.stdDev;
                      return `
                        <label class="flex items-center space-x-2">
                          <input
                            type="checkbox"
                            ${state.sigmaSettings[dataset.id]?.[`show${sigma}`] ? 'checked' : ''}
                            onchange="toggleSigma('${dataset.id}', ${sigma})"
                            class="rounded"
                          />
                          <span class="text-sm">
                            ${sigma}σ (${lowerValue.toFixed(2)} ～ ${upperValue.toFixed(2)})
                          </span>
                        </label>
                      `;
                    }).join('')}
                    <div class="text-xs text-gray-500 mt-1">
                      平均: ${calculateStats(dataset.data).mean.toFixed(2)}, 
                      標準偏差: ${calculateStats(dataset.data).stdDev.toFixed(2)}
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}

        <!-- ヒストグラム表示 -->
        ${histogramData.data.length > 0 ? `
          <div class="mb-6">
            <h2 class="text-xl font-semibold mb-3">重ね合わせヒストグラム</h2>
            <div id="chartContainer" class="h-96 w-full"></div>
          </div>
        ` : `
          <div class="text-center py-12 text-gray-500">
            <div class="mb-4">
              <i data-lucide="upload" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
              <i data-lucide="edit-3" class="w-16 h-16 mx-auto text-gray-300"></i>
            </div>
            <p>Excelファイルをアップロードするか、直接データを入力してヒストグラムを生成してください</p>
          </div>
        `}
      `;

      // ファイルアップロードのイベントリスナーを設定
      document.getElementById('fileInput')?.addEventListener('change', handleFileUpload);

      // ヒストグラムをレンダリング
      if (histogramData.data.length > 0) {
        renderChart();
      }

      // Lucideアイコンを更新
      lucide.createIcons();
    }

    // 初期レンダリング
    render();
  </script>
</body>
</html>
