<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QRç…§åˆã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }

        /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .tab-nav {
            display: flex;
            background: #1a73e8;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .tab-btn {
            flex: 1;
            padding: 16px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.7);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: white;
            background: rgba(255,255,255,0.1);
            border-bottom-color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .container {
            padding: 16px;
            max-width: 500px;
            margin: 0 auto;
        }

        /* ========== ç…§åˆã‚¿ãƒ– ========== */
        .main-status {
            background: white;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }

        .status-step {
            font-size: 13px;
            color: #666;
            margin-bottom: 6px;
        }

        .status-message {
            font-size: 22px;
            font-weight: 700;
            color: #1a73e8;
        }

        .status-message.step2 {
            color: #ff9800;
        }

        .value-cards {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .value-card {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            min-height: 100px;
            transition: all 0.3s;
            border: 3px solid transparent;
        }

        .value-card.active {
            border-color: #1a73e8;
            background: #e3f2fd;
        }

        .value-card.filled {
            border-color: #4caf50;
            background: #e8f5e9;
        }

        .value-card-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 6px;
            color: #333;
        }

        .value-card.active .value-card-title { color: #1a73e8; }
        .value-card.filled .value-card-title { color: #2e7d32; }

        .value-card-content {
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            color: #333;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .value-card-content.empty {
            color: #999;
            font-style: italic;
            font-family: inherit;
        }

        .value-card-range {
            font-size: 10px;
            color: #1a73e8;
            margin-top: 6px;
            background: #e3f2fd;
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .camera-area {
            background: white;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }

        #reader {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
        }

        .camera-placeholder {
            height: 280px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
        }

        .camera-placeholder .icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .camera-placeholder .text {
            font-size: 16px;
            font-weight: 600;
        }

        .btn-row {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .action-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn.start {
            background: #4caf50;
            color: white;
        }

        .action-btn.stop {
            background: #f44336;
            color: white;
        }

        .action-btn.reset {
            background: #f5f5f5;
            color: #666;
            border: 2px solid #ddd;
        }

        .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* ç¾åœ¨ã®è¨­å®šè¡¨ç¤º */
        .current-settings {
            background: #fff3e0;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 12px;
        }

        .current-settings-title {
            font-weight: 600;
            color: #e65100;
            margin-bottom: 6px;
        }

        .current-settings-row {
            display: flex;
            justify-content: space-between;
            color: #666;
            margin: 4px 0;
        }

        .current-settings-row span:last-child {
            font-weight: 600;
            color: #333;
        }

        /* ãƒ­ã‚° */
        .log-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .log-title {
            font-size: 14px;
            font-weight: 600;
        }

        .log-count {
            font-size: 11px;
            color: #666;
            background: #f0f0f0;
            padding: 3px 8px;
            border-radius: 8px;
        }

        .log-list {
            max-height: 180px;
            overflow-y: auto;
        }

        .log-item {
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 4px;
            font-size: 11px;
        }

        .log-item.ok { background: #e8f5e9; border-left: 3px solid #4caf50; }
        .log-item.ng { background: #ffebee; border-left: 3px solid #f44336; }

        .log-time { color: #666; font-size: 10px; }
        .log-result { font-weight: 600; margin: 2px 0; }
        .log-item.ok .log-result { color: #2e7d32; }
        .log-item.ng .log-result { color: #c62828; }
        .log-values { font-family: monospace; font-size: 10px; color: #555; }

        .no-log {
            text-align: center;
            color: #999;
            padding: 16px;
            font-size: 12px;
        }

        .log-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .log-btn {
            flex: 1;
            padding: 8px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
        }

        /* ========== è¨­å®šã‚¿ãƒ– ========== */
        .settings-locked {
            text-align: center;
            padding: 40px 20px;
        }

        .lock-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .lock-text {
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
        }

        .password-input-group {
            display: flex;
            gap: 8px;
            max-width: 300px;
            margin: 0 auto;
        }

        .password-input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .password-input-group button {
            padding: 12px 20px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .settings-unlocked {
            display: none;
        }

        .settings-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .settings-card-title {
            font-size: 15px;
            font-weight: 700;
            color: #333;
            margin-bottom: 14px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .range-group {
            margin-bottom: 16px;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .range-group-title {
            font-size: 14px;
            font-weight: 600;
            color: #1a73e8;
            margin-bottom: 10px;
        }

        .range-inputs {
            display: flex;
            gap: 16px;
        }

        .range-input-item {
            flex: 1;
        }

        .range-input-item label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .range-input-item input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            text-align: center;
        }

        .range-input-item input:focus {
            outline: none;
            border-color: #1a73e8;
        }

        .range-note {
            font-size: 11px;
            color: #999;
            margin-top: 8px;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 14px;
            color: #333;
        }

        .setting-input {
            width: 150px;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .toggle-switch {
            width: 50px;
            height: 28px;
            background: #ccc;
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.on {
            background: #4caf50;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.on::after {
            left: 24px;
        }

        .save-btn {
            width: 100%;
            padding: 16px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 8px;
        }

        .lock-settings-btn {
            width: 100%;
            padding: 12px;
            background: #f5f5f5;
            color: #666;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 12px;
        }

        /* ========== çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ========== */
        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .result-overlay.show {
            display: flex;
            animation: fadeIn 0.15s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .result-overlay.ok { background: rgba(76, 175, 80, 0.97); }
        .result-overlay.ng { background: rgba(244, 67, 54, 0.97); }

        .result-symbol {
            font-size: min(50vw, 50vh);
            font-weight: 900;
            color: white;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
            line-height: 1;
        }

        .result-text {
            font-size: 32px;
            color: white;
            margin-top: 10px;
            font-weight: 700;
        }

        .result-detail {
            margin-top: 20px;
            padding: 16px 24px;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            text-align: center;
        }

        .result-detail p {
            color: white;
            font-size: 14px;
            margin: 4px 0;
            font-family: monospace;
        }

        .result-detail .label {
            font-size: 11px;
            opacity: 0.8;
            font-family: inherit;
        }

        .result-btn {
            margin-top: 24px;
            padding: 16px 50px;
            background: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
        }

        .result-overlay.ok .result-btn { color: #4caf50; }
        .result-overlay.ng .result-btn { color: #f44336; }

        .ng-locked .result-symbol {
            animation: shake 0.4s ease infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        .admin-area {
            margin-top: 20px;
            padding: 16px;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            text-align: center;
        }

        .admin-area p {
            color: white;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .admin-btn {
            padding: 12px 24px;
            background: white;
            color: #f44336;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        #admin-reader {
            margin-top: 10px;
            border-radius: 8px;
            overflow: hidden;
            max-width: 220px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body>
    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('scan')">ğŸ“· ç…§åˆ</button>
        <button class="tab-btn" onclick="switchTab('settings')">âš™ï¸ è¨­å®š</button>
    </div>

    <!-- ========== ç…§åˆã‚¿ãƒ– ========== -->
    <div class="tab-content active" id="tab-scan">
        <div class="container">
            <div class="main-status">
                <div class="status-step" id="statusStep">STEP 1 / 2</div>
                <div class="status-message" id="statusMessage">ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
            </div>

            <div class="value-cards">
                <div class="value-card" id="card1">
                    <div class="value-card-title">1å›ç›®</div>
                    <div class="value-card-content empty" id="display1">æœªèª­å–</div>
                    <div class="value-card-range" id="range1" style="display:none;"></div>
                </div>
                <div class="value-card" id="card2">
                    <div class="value-card-title">2å›ç›®</div>
                    <div class="value-card-content empty" id="display2">æœªèª­å–</div>
                    <div class="value-card-range" id="range2" style="display:none;"></div>
                </div>
            </div>

            <div class="current-settings">
                <div class="current-settings-title">ğŸ“ ç¾åœ¨ã®ç…§åˆç¯„å›²</div>
                <div class="current-settings-row">
                    <span>1å›ç›®:</span>
                    <span id="currentRange1">1æ–‡å­—ç›® ï½ æœ«å°¾</span>
                </div>
                <div class="current-settings-row">
                    <span>2å›ç›®:</span>
                    <span id="currentRange2">1æ–‡å­—ç›® ï½ æœ«å°¾</span>
                </div>
            </div>

            <div class="camera-area">
                <div id="reader">
                    <div class="camera-placeholder" id="placeholder">
                        <div class="icon">ğŸ“·</div>
                        <div class="text">ã‚«ãƒ¡ãƒ©å¾…æ©Ÿä¸­</div>
                    </div>
                </div>
                <div class="btn-row">
                    <button class="action-btn start" id="startBtn" onclick="startScanning()">â–¶ï¸ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                    <button class="action-btn reset" id="resetBtn" onclick="resetAll()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>

            <div class="log-card">
                <div class="log-header">
                    <div class="log-title">ğŸ“ ç…§åˆå±¥æ­´</div>
                    <div class="log-count" id="logCount">0ä»¶</div>
                </div>
                <div class="log-list" id="logList">
                    <div class="no-log">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                </div>
                <div class="log-actions">
                    <button class="log-btn" onclick="clearLog()">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                    <button class="log-btn" onclick="exportLog()">ğŸ“¥ å‡ºåŠ›</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== è¨­å®šã‚¿ãƒ– ========== -->
    <div class="tab-content" id="tab-settings">
        <div class="container">
            <!-- ãƒ­ãƒƒã‚¯ç”»é¢ -->
            <div class="settings-locked" id="settingsLocked">
                <div class="lock-icon">ğŸ”’</div>
                <div class="lock-text">è¨­å®šã‚’å¤‰æ›´ã™ã‚‹ã«ã¯<br>ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                <div class="password-input-group">
                    <input type="password" id="unlockPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                    <button onclick="unlockSettings()">è§£é™¤</button>
                </div>
            </div>

            <!-- è¨­å®šç”»é¢ -->
            <div class="settings-unlocked" id="settingsUnlocked">
                <div class="settings-card">
                    <div class="settings-card-title">ğŸ“ ç…§åˆç¯„å›²è¨­å®š</div>
                    
                    <div class="range-group">
                        <div class="range-group-title">1å›ç›®ã®èª­ã¿å–ã‚Š</div>
                        <div class="range-inputs">
                            <div class="range-input-item">
                                <label>é–‹å§‹ä½ç½®</label>
                                <input type="number" id="range1Start" value="1" min="1">
                            </div>
                            <div class="range-input-item">
                                <label>çµ‚äº†ä½ç½®</label>
                                <input type="number" id="range1End" value="0" min="0">
                            </div>
                        </div>
                    </div>

                    <div class="range-group">
                        <div class="range-group-title">2å›ç›®ã®èª­ã¿å–ã‚Š</div>
                        <div class="range-inputs">
                            <div class="range-input-item">
                                <label>é–‹å§‹ä½ç½®</label>
                                <input type="number" id="range2Start" value="1" min="1">
                            </div>
                            <div class="range-input-item">
                                <label>çµ‚äº†ä½ç½®</label>
                                <input type="number" id="range2End" value="0" min="0">
                            </div>
                        </div>
                    </div>

                    <div class="range-note">â€» çµ‚äº†ä½ç½®ã‚’ 0 ã«ã™ã‚‹ã¨æœ«å°¾ã¾ã§ç…§åˆã—ã¾ã™</div>
                </div>

                <div class="settings-card">
                    <div class="settings-card-title">ğŸ” ç®¡ç†è€…è¨­å®š</div>
                    
                    <div class="setting-row">
                        <span class="setting-label">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</span>
                        <input type="password" class="setting-input" id="adminPassword" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                    </div>

                    <div class="setting-row">
                        <span class="setting-label">ç®¡ç†è€…QRï¼ˆã‚¨ãƒ©ãƒ¼è§£é™¤ç”¨ï¼‰</span>
                        <input type="text" class="setting-input" id="adminQR" placeholder="QRã®å€¤">
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-card-title">ğŸ”Š ãã®ä»–</div>
                    
                    <div class="setting-row">
                        <span class="setting-label">ç…§åˆéŸ³ã‚’é³´ã‚‰ã™</span>
                        <div class="toggle-switch on" id="soundToggle" onclick="toggleSound()"></div>
                    </div>
                </div>

                <button class="save-btn" onclick="saveAllSettings()">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
                <button class="lock-settings-btn" onclick="lockSettings()">ğŸ”’ è¨­å®šã‚’ãƒ­ãƒƒã‚¯</button>
            </div>
        </div>
    </div>

    <!-- çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="result-overlay" id="resultOverlay">
        <div class="result-symbol" id="resultSymbol">â—‹</div>
        <div class="result-text" id="resultText">ä¸€è‡´</div>
        <div class="result-detail" id="resultDetail"></div>
        <button class="result-btn" id="okBtn" onclick="closeAndContinue()">æ¬¡ã®ç…§åˆã¸</button>
        <div class="admin-area" id="adminArea" style="display:none;">
            <p>âš ï¸ ç®¡ç†è€…QRã§è§£é™¤ã—ã¦ãã ã•ã„</p>
            <button class="admin-btn" onclick="startAdminScan()">ğŸ” ç®¡ç†è€…QRèª­å–</button>
            <div id="admin-reader"></div>
        </div>
    </div>

    <script>
        // ========== çŠ¶æ…‹ç®¡ç† ==========
        let currentStep = 0; // 0:å¾…æ©Ÿ, 1:1å›ç›®èª­å–ä¸­, 2:2å›ç›®èª­å–ä¸­
        let value1 = '';
        let value2 = '';
        let isScanning = false;
        let isNGLocked = false;
        let scanLog = [];
        let html5QrCode = null;
        let adminScanner = null;
        let audioCtx = null;

        // è¨­å®š
        let settings = {
            range1Start: 1,
            range1End: 0,
            range2Start: 1,
            range2End: 0,
            adminPassword: 'admin',
            adminQR: 'ADMIN123',
            soundEnabled: true
        };

        let settingsUnlocked = false;

        // ========== åˆæœŸåŒ– ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadLog();
            updateUI();
            updateCurrentSettingsDisplay();
        });

        // ========== è¨­å®š ==========
        function loadSettings() {
            const saved = localStorage.getItem('qrMatchSettings_v2');
            if (saved) {
                settings = { ...settings, ...JSON.parse(saved) };
            }
            applySettingsToForm();
        }

        function applySettingsToForm() {
            document.getElementById('range1Start').value = settings.range1Start;
            document.getElementById('range1End').value = settings.range1End;
            document.getElementById('range2Start').value = settings.range2Start;
            document.getElementById('range2End').value = settings.range2End;
            document.getElementById('adminQR').value = settings.adminQR;
            document.getElementById('soundToggle').className = settings.soundEnabled ? 'toggle-switch on' : 'toggle-switch';
        }

        function saveAllSettings() {
            settings.range1Start = parseInt(document.getElementById('range1Start').value) || 1;
            settings.range1End = parseInt(document.getElementById('range1End').value) || 0;
            settings.range2Start = parseInt(document.getElementById('range2Start').value) || 1;
            settings.range2End = parseInt(document.getElementById('range2End').value) || 0;
            
            const newPassword = document.getElementById('adminPassword').value.trim();
            if (newPassword) {
                settings.adminPassword = newPassword;
            }
            
            settings.adminQR = document.getElementById('adminQR').value.trim() || 'ADMIN123';

            localStorage.setItem('qrMatchSettings_v2', JSON.stringify(settings));
            updateCurrentSettingsDisplay();
            alert('âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            document.getElementById('adminPassword').value = '';
        }

        function updateCurrentSettingsDisplay() {
            const fmt = (s, e) => {
                const start = s + 'æ–‡å­—ç›®';
                const end = e === 0 ? 'æœ«å°¾' : e + 'æ–‡å­—ç›®';
                return `${start} ï½ ${end}`;
            };
            document.getElementById('currentRange1').textContent = fmt(settings.range1Start, settings.range1End);
            document.getElementById('currentRange2').textContent = fmt(settings.range2Start, settings.range2End);
        }

        function toggleSound() {
            settings.soundEnabled = !settings.soundEnabled;
            document.getElementById('soundToggle').className = settings.soundEnabled ? 'toggle-switch on' : 'toggle-switch';
        }

        // ========== è¨­å®šãƒ­ãƒƒã‚¯ ==========
        function unlockSettings() {
            const input = document.getElementById('unlockPassword').value;
            if (input === settings.adminPassword) {
                settingsUnlocked = true;
                document.getElementById('settingsLocked').style.display = 'none';
                document.getElementById('settingsUnlocked').style.display = 'block';
                document.getElementById('unlockPassword').value = '';
            } else {
                alert('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
            }
        }

        function lockSettings() {
            settingsUnlocked = false;
            document.getElementById('settingsLocked').style.display = 'block';
            document.getElementById('settingsUnlocked').style.display = 'none';
        }

        // ========== ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ==========
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'scan') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('tab-scan').classList.add('active');
            } else {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('tab-settings').classList.add('active');
            }
        }

        // ========== ãƒ­ã‚° ==========
        function loadLog() {
            const saved = localStorage.getItem('qrMatchLog_v2');
            if (saved) {
                scanLog = JSON.parse(saved);
                renderLog();
            }
        }

        function saveLog() {
            localStorage.setItem('qrMatchLog_v2', JSON.stringify(scanLog));
        }

        // ========== éŸ³ ==========
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playSound(type) {
            if (!settings.soundEnabled) return;
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            gain.gain.value = 0.25;

            if (type === 'beep') {
                osc.frequency.value = 880;
                osc.start();
                setTimeout(() => osc.stop(), 80);
            } else if (type === 'ok') {
                osc.frequency.value = 1000;
                osc.start();
                setTimeout(() => osc.frequency.value = 1300, 100);
                setTimeout(() => osc.stop(), 200);
            } else if (type === 'ng') {
                osc.frequency.value = 280;
                osc.type = 'square';
                osc.start();
                setTimeout(() => osc.stop(), 400);
            }
        }

        // ========== ç¯„å›²æŠ½å‡º ==========
        function extractRange(str, start, end) {
            const s = start - 1;
            const e = end === 0 ? str.length : end;
            return str.substring(s, e);
        }

        // ========== UIæ›´æ–° ==========
        function updateUI() {
            const card1 = document.getElementById('card1');
            const card2 = document.getElementById('card2');
            const display1 = document.getElementById('display1');
            const display2 = document.getElementById('display2');
            const range1El = document.getElementById('range1');
            const range2El = document.getElementById('range2');
            const statusStep = document.getElementById('statusStep');
            const statusMessage = document.getElementById('statusMessage');
            const startBtn = document.getElementById('startBtn');

            // ã‚«ãƒ¼ãƒ‰1
            if (value1) {
                card1.className = 'value-card filled';
                display1.textContent = value1;
                display1.className = 'value-card-content';
                range1El.textContent = 'ç…§åˆ: ' + extractRange(value1, settings.range1Start, settings.range1End);
                range1El.style.display = 'block';
            } else {
                card1.className = currentStep === 1 ? 'value-card active' : 'value-card';
                display1.textContent = 'æœªèª­å–';
                display1.className = 'value-card-content empty';
                range1El.style.display = 'none';
            }

            // ã‚«ãƒ¼ãƒ‰2
            if (value2) {
                card2.className = 'value-card filled';
                display2.textContent = value2;
                display2.className = 'value-card-content';
                range2El.textContent = 'ç…§åˆ: ' + extractRange(value2, settings.range2Start, settings.range2End);
                range2El.style.display = 'block';
            } else {
                card2.className = currentStep === 2 ? 'value-card active' : 'value-card';
                display2.textContent = 'æœªèª­å–';
                display2.className = 'value-card-content empty';
                range2El.style.display = 'none';
            }

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
            if (currentStep === 0) {
                statusStep.textContent = '';
                statusMessage.textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„';
                statusMessage.className = 'status-message';
                startBtn.textContent = 'â–¶ï¸ ã‚¹ã‚¿ãƒ¼ãƒˆ';
                startBtn.className = 'action-btn start';
                startBtn.disabled = false;
            } else if (currentStep === 1) {
                statusStep.textContent = 'STEP 1 / 2';
                statusMessage.textContent = '1å›ç›®ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„';
                statusMessage.className = 'status-message';
                startBtn.textContent = 'â¹ï¸ åœæ­¢';
                startBtn.className = 'action-btn stop';
                startBtn.disabled = false;
            } else if (currentStep === 2) {
                statusStep.textContent = 'STEP 2 / 2';
                statusMessage.textContent = '2å›ç›®ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„';
                statusMessage.className = 'status-message step2';
                startBtn.textContent = 'â¹ï¸ åœæ­¢';
                startBtn.className = 'action-btn stop';
                startBtn.disabled = false;
            }
        }

        // ========== ã‚¹ã‚­ãƒ£ãƒ³ ==========
        function startScanning() {
            if (isNGLocked) {
                showNGOverlay();
                return;
            }

            if (isScanning) {
                stopScanning();
                return;
            }

            document.getElementById('placeholder').style.display = 'none';
            html5QrCode = new Html5Qrcode('reader');

            html5QrCode.start(
                { facingMode: 'environment' },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess,
                () => {}
            ).then(() => {
                isScanning = true;
                currentStep = 1;
                updateUI();
            }).catch(err => {
                alert('ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: ' + err);
                document.getElementById('placeholder').style.display = 'flex';
            });
        }

        function stopScanning() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode = null;
                    isScanning = false;
                    currentStep = 0;
                    document.getElementById('placeholder').style.display = 'flex';
                    updateUI();
                }).catch(() => {});
            }
        }

        function onScanSuccess(decoded) {
            if (currentStep === 1) {
                value1 = decoded;
                currentStep = 2;
                playSound('beep');
                updateUI();
                // è‡ªå‹•çš„ã«2å›ç›®å¾…ã¡ã¸ï¼ˆã‚«ãƒ¡ãƒ©ã¯ç¶™ç¶šï¼‰
            } else if (currentStep === 2) {
                value2 = decoded;
                playSound('beep');
                
                // ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢ã—ã¦ç…§åˆ
                if (html5QrCode) {
                    html5QrCode.stop().then(() => {
                        html5QrCode = null;
                        isScanning = false;
                        document.getElementById('placeholder').style.display = 'flex';
                        doMatch();
                    }).catch(() => doMatch());
                } else {
                    doMatch();
                }
            }
        }

        // ========== ç…§åˆ ==========
        function doMatch() {
            const ext1 = extractRange(value1, settings.range1Start, settings.range1End);
            const ext2 = extractRange(value2, settings.range2Start, settings.range2End);
            const isOK = ext1 === ext2;

            scanLog.unshift({
                timestamp: new Date().toISOString(),
                qr1: value1,
                qr2: value2,
                compared1: ext1,
                compared2: ext2,
                range1: `${settings.range1Start}-${settings.range1End}`,
                range2: `${settings.range2Start}-${settings.range2End}`,
                result: isOK ? 'OK' : 'NG'
            });
            if (scanLog.length > 100) scanLog.pop();
            saveLog();
            renderLog();

            showResult(isOK, ext1, ext2);
        }

        // ========== çµæœè¡¨ç¤º ==========
        function showResult(isOK, ext1, ext2) {
            const overlay = document.getElementById('resultOverlay');
            const symbol = document.getElementById('resultSymbol');
            const text = document.getElementById('resultText');
            const detail = document.getElementById('resultDetail');
            const okBtn = document.getElementById('okBtn');
            const adminArea = document.getElementById('adminArea');

            overlay.classList.add('show');

            if (isOK) {
                overlay.className = 'result-overlay show ok';
                symbol.textContent = 'â—‹';
                text.textContent = 'ä¸€è‡´';
                detail.innerHTML = `<p class="label">ç…§åˆå€¤</p><p>${ext1}</p>`;
                okBtn.style.display = 'block';
                adminArea.style.display = 'none';
                playSound('ok');
            } else {
                overlay.className = 'result-overlay show ng ng-locked';
                symbol.textContent = 'Ã—';
                text.textContent = 'ä¸ä¸€è‡´';
                detail.innerHTML = `
                    <p class="label">1å›ç›®</p><p>${ext1}</p>
                    <p class="label" style="margin-top:8px;">2å›ç›®</p><p>${ext2}</p>
                `;
                okBtn.style.display = 'none';
                adminArea.style.display = 'block';
                isNGLocked = true;
                playSound('ng');
            }
        }

        function showNGOverlay() {
            const overlay = document.getElementById('resultOverlay');
            overlay.className = 'result-overlay show ng ng-locked';
            document.getElementById('resultSymbol').textContent = 'Ã—';
            document.getElementById('resultText').textContent = 'ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹';
            document.getElementById('resultDetail').innerHTML = '<p>ç®¡ç†è€…QRã§è§£é™¤ãŒå¿…è¦</p>';
            document.getElementById('okBtn').style.display = 'none';
            document.getElementById('adminArea').style.display = 'block';
        }

        function closeAndContinue() {
            document.getElementById('resultOverlay').classList.remove('show');
            resetAll();
            // è‡ªå‹•çš„ã«æ¬¡ã®ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹
            setTimeout(() => startScanning(), 300);
        }

        function resetAll() {
            stopScanning();
            value1 = '';
            value2 = '';
            currentStep = 0;
            updateUI();
        }

        // ========== ç®¡ç†è€…è§£é™¤ ==========
        function startAdminScan() {
            adminScanner = new Html5Qrcode('admin-reader');
            adminScanner.start(
                { facingMode: 'environment' },
                { fps: 10, qrbox: { width: 160, height: 160 } },
                (decoded) => {
                    adminScanner.stop().catch(() => {});
                    adminScanner = null;
                    if (decoded === settings.adminQR) {
                        isNGLocked = false;
                        playSound('ok');
                        document.getElementById('resultOverlay').classList.remove('show');
                        resetAll();
                        alert('âœ… ã‚¨ãƒ©ãƒ¼è§£é™¤ã—ã¾ã—ãŸ');
                    } else {
                        playSound('ng');
                        alert('âŒ ç®¡ç†è€…QRãŒä¸€è‡´ã—ã¾ã›ã‚“');
                    }
                },
                () => {}
            ).catch(err => alert('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ' + err));
        }

        // ========== ãƒ­ã‚°è¡¨ç¤º ==========
        function renderLog() {
            const container = document.getElementById('logList');
            document.getElementById('logCount').textContent = scanLog.length + 'ä»¶';

            if (scanLog.length === 0) {
                container.innerHTML = '<div class="no-log">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            container.innerHTML = scanLog.slice(0, 50).map(l => {
                const t = new Date(l.timestamp).toLocaleString('ja-JP');
                return `
                    <div class="log-item ${l.result.toLowerCase()}">
                        <div class="log-time">${t}</div>
                        <div class="log-result">${l.result === 'OK' ? 'âœ… OK' : 'âŒ NG'}</div>
                        <div class="log-values">1: ${l.compared1} / 2: ${l.compared2}</div>
                    </div>
                `;
            }).join('');
        }

        function clearLog() {
            if (confirm('å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                scanLog = [];
                saveLog();
                renderLog();
            }
        }

        function exportLog() {
            if (scanLog.length === 0) return alert('å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“');
            const headers = ['æ—¥æ™‚','çµæœ','QR1(å…¨ä½“)','QR2(å…¨ä½“)','ç…§åˆ1','ç…§åˆ2','ç¯„å›²1','ç¯„å›²2'];
            const rows = scanLog.map(l => [
                new Date(l.timestamp).toLocaleString('ja-JP'),
                l.result, l.qr1, l.qr2, l.compared1, l.compared2, l.range1, l.range2
            ]);
            const csv = [headers,...rows].map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv'}));
            a.download = `QRç…§åˆå±¥æ­´_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
        }
    </script>
</body>
</html>
