<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QRÁÖßÂêà„Ç∑„Çπ„ÉÜ„É†</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }

        /* „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */
        .tab-nav {
            display: flex;
            background: #1a73e8;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .tab-btn {
            flex: 1;
            padding: 16px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.7);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: white;
            background: rgba(255,255,255,0.1);
            border-bottom-color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .container {
            padding: 16px;
            max-width: 500px;
            margin: 0 auto;
        }

        /* ========== ÁÖßÂêà„Çø„Éñ ========== */
        
        /* ÂæÖÊ©üÁîªÈù¢ */
        .standby-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 100px);
            padding: 20px;
        }

        .start-btn-large {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            border: none;
            color: white;
            font-size: 28px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 30px rgba(76, 175, 80, 0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .start-btn-large:active {
            transform: scale(0.95);
        }

        .start-btn-large .icon {
            font-size: 48px;
            margin-bottom: 8px;
        }

        /* „Çπ„Ç≠„É£„É≥ÁîªÈù¢ */
        .scan-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            min-height: calc(100vh - 60px);
            padding: 20px;
        }

        .scan-screen.active {
            display: flex;
        }

        .scan-box {
            width: 100%;
            max-width: 400px;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
        }

        .scan-step {
            font-size: 16px;
            color: #666;
            margin-bottom: 8px;
        }

        .scan-message {
            font-size: 26px;
            font-weight: 700;
            color: #1a73e8;
            margin-bottom: 24px;
        }

        .scan-message.step2 {
            color: #ff9800;
        }

        .scan-message.waiting {
            color: #9e9e9e;
        }

        .scan-input-area {
            position: relative;
            margin-bottom: 20px;
        }

        .scan-input {
            width: 100%;
            padding: 20px;
            font-size: 24px;
            text-align: center;
            border: 3px solid #1a73e8;
            border-radius: 12px;
            outline: none;
            font-family: monospace;
        }

        .scan-input:focus {
            border-color: #4caf50;
            box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.2);
        }

        .scan-input.step2 {
            border-color: #ff9800;
        }

        .scan-input.step2:focus {
            border-color: #ff9800;
            box-shadow: 0 0 0 4px rgba(255, 152, 0, 0.2);
        }

        .input-hint {
            font-size: 14px;
            color: #999;
            margin-top: 10px;
        }

        .scanner-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .stop-btn {
            margin-top: 20px;
            padding: 14px 40px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }

        /* „É≠„Ç∞ */
        .log-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .log-title {
            font-size: 14px;
            font-weight: 600;
        }

        .log-count {
            font-size: 11px;
            color: #666;
            background: #f0f0f0;
            padding: 3px 8px;
            border-radius: 8px;
        }

        .log-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .log-item {
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 4px;
            font-size: 11px;
        }

        .log-item.ok { background: #e8f5e9; border-left: 3px solid #4caf50; }
        .log-item.ng { background: #ffebee; border-left: 3px solid #f44336; }

        .log-time { color: #666; font-size: 10px; }
        .log-result { font-weight: 600; margin: 2px 0; }
        .log-item.ok .log-result { color: #2e7d32; }
        .log-item.ng .log-result { color: #c62828; }
        .log-values { font-family: monospace; font-size: 10px; color: #555; }

        .no-log {
            text-align: center;
            color: #999;
            padding: 16px;
            font-size: 12px;
        }

        .log-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .log-btn {
            flex: 1;
            padding: 8px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
        }

        /* ========== Ë®≠ÂÆö„Çø„Éñ ========== */
        .settings-locked {
            text-align: center;
            padding: 40px 20px;
        }

        .lock-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .lock-text {
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
        }

        .password-input-group {
            display: flex;
            gap: 8px;
            max-width: 300px;
            margin: 0 auto;
        }

        .password-input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .password-input-group button {
            padding: 12px 20px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .settings-unlocked {
            display: none;
        }

        .settings-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .settings-card-title {
            font-size: 15px;
            font-weight: 700;
            color: #333;
            margin-bottom: 14px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .range-group {
            margin-bottom: 16px;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .range-group-title {
            font-size: 14px;
            font-weight: 600;
            color: #1a73e8;
            margin-bottom: 10px;
        }

        .range-inputs {
            display: flex;
            gap: 16px;
        }

        .range-input-item {
            flex: 1;
        }

        .range-input-item label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .range-input-item input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            text-align: center;
        }

        .range-input-item input:focus {
            outline: none;
            border-color: #1a73e8;
        }

        .range-note {
            font-size: 11px;
            color: #999;
            margin-top: 8px;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 14px;
            color: #333;
        }

        .setting-input {
            width: 150px;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .toggle-switch {
            width: 50px;
            height: 28px;
            background: #ccc;
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.on {
            background: #4caf50;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.on::after {
            left: 24px;
        }

        .save-btn {
            width: 100%;
            padding: 16px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 8px;
        }

        .lock-settings-btn {
            width: 100%;
            padding: 12px;
            background: #f5f5f5;
            color: #666;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 12px;
        }

        /* ========== ÁµêÊûú„Ç™„Éº„Éê„Éº„É¨„Ç§ ========== */
        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .result-overlay.show {
            display: flex;
            animation: fadeIn 0.15s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .result-overlay.ok { background: rgba(76, 175, 80, 0.97); }
        .result-overlay.ng { background: rgba(244, 67, 54, 0.97); }

        .result-symbol {
            font-size: min(50vw, 50vh);
            font-weight: 900;
            color: white;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
            line-height: 1;
        }

        .result-text {
            font-size: 32px;
            color: white;
            margin-top: 10px;
            font-weight: 700;
        }

        .result-detail {
            margin-top: 20px;
            padding: 16px 24px;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            text-align: center;
        }

        .result-detail p {
            color: white;
            font-size: 14px;
            margin: 4px 0;
            font-family: monospace;
        }

        .result-detail .label {
            font-size: 11px;
            opacity: 0.8;
            font-family: inherit;
        }

        .result-btn {
            margin-top: 24px;
            padding: 16px 50px;
            background: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
        }

        .result-overlay.ok .result-btn { color: #4caf50; }
        .result-overlay.ng .result-btn { color: #f44336; }

        .ng-locked .result-symbol {
            animation: shake 0.4s ease infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        .admin-area {
            margin-top: 20px;
            padding: 16px;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            text-align: center;
        }

        .admin-area p {
            color: white;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .admin-input-group {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .admin-input {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            width: 200px;
            text-align: center;
        }

        .admin-btn {
            padding: 12px 24px;
            background: white;
            color: #f44336;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('scan')">üì∑ ÁÖßÂêà</button>
        <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è Ë®≠ÂÆö</button>
    </div>

    <!-- ========== ÁÖßÂêà„Çø„Éñ ========== -->
    <div class="tab-content active" id="tab-scan">
        
        <!-- ÂæÖÊ©üÁîªÈù¢ -->
        <div class="standby-screen" id="standbyScreen">
            <button class="start-btn-large" onclick="startScanning()">
                <span class="icon">‚ñ∂Ô∏è</span>
                „Çπ„Çø„Éº„Éà
            </button>
            
            <div class="log-card" style="width: 100%; max-width: 400px; margin-top: 40px;">
                <div class="log-header">
                    <div class="log-title">üìù ÁÖßÂêàÂ±•Ê≠¥</div>
                    <div class="log-count" id="logCount">0‰ª∂</div>
                </div>
                <div class="log-list" id="logList">
                    <div class="no-log">Â±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                </div>
                <div class="log-actions">
                    <button class="log-btn" onclick="clearLog()">üóëÔ∏è „ÇØ„É™„Ç¢</button>
                    <button class="log-btn" onclick="exportLog()">üì• Âá∫Âäõ</button>
                </div>
            </div>
        </div>

        <!-- „Çπ„Ç≠„É£„É≥ÁîªÈù¢ -->
        <div class="scan-screen" id="scanScreen">
            <div class="scan-box">
                <div class="scanner-icon">üìü</div>
                <div class="scan-step" id="scanStep">STEP 1 / 2</div>
                <div class="scan-message" id="scanMessage">1ÂõûÁõÆ„ÇíË™≠„ÅøÂèñ„Å£„Å¶„Åè„Å†„Åï„ÅÑ</div>
                
                <div class="scan-input-area">
                    <input type="text" class="scan-input" id="scanInput" 
                           placeholder="QR„É™„Éº„ÉÄ„Éº„ÅßË™≠„ÅøÂèñ„Çä" 
                           autocomplete="off" autofocus>
                    <div class="input-hint">QR„É™„Éº„ÉÄ„Éº„Åß„Çπ„Ç≠„É£„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                </div>
            </div>
            
            <button class="stop-btn" onclick="stopAndReset()">‚èπÔ∏è ÂÅúÊ≠¢</button>
        </div>
    </div>

    <!-- ========== Ë®≠ÂÆö„Çø„Éñ ========== -->
    <div class="tab-content" id="tab-settings">
        <div class="container">
            <!-- „É≠„ÉÉ„ÇØÁîªÈù¢ -->
            <div class="settings-locked" id="settingsLocked">
                <div class="lock-icon">üîí</div>
                <div class="lock-text">Ë®≠ÂÆö„ÇíÂ§âÊõ¥„Åô„Çã„Å´„ÅØ<br>ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                <div class="password-input-group">
                    <input type="password" id="unlockPassword" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ">
                    <button onclick="unlockSettings()">Ëß£Èô§</button>
                </div>
            </div>

            <!-- Ë®≠ÂÆöÁîªÈù¢ -->
            <div class="settings-unlocked" id="settingsUnlocked">
                <div class="settings-card">
                    <div class="settings-card-title">üìê ÁÖßÂêàÁØÑÂõ≤Ë®≠ÂÆö</div>
                    
                    <div class="range-group">
                        <div class="range-group-title">1ÂõûÁõÆ„ÅÆË™≠„ÅøÂèñ„Çä</div>
                        <div class="range-inputs">
                            <div class="range-input-item">
                                <label>ÈñãÂßã‰ΩçÁΩÆ</label>
                                <input type="number" id="range1Start" value="1" min="1">
                            </div>
                            <div class="range-input-item">
                                <label>ÁµÇ‰∫Ü‰ΩçÁΩÆ</label>
                                <input type="number" id="range1End" value="0" min="0">
                            </div>
                        </div>
                    </div>

                    <div class="range-group">
                        <div class="range-group-title">2ÂõûÁõÆ„ÅÆË™≠„ÅøÂèñ„Çä</div>
                        <div class="range-inputs">
                            <div class="range-input-item">
                                <label>ÈñãÂßã‰ΩçÁΩÆ</label>
                                <input type="number" id="range2Start" value="1" min="1">
                            </div>
                            <div class="range-input-item">
                                <label>ÁµÇ‰∫Ü‰ΩçÁΩÆ</label>
                                <input type="number" id="range2End" value="0" min="0">
                            </div>
                        </div>
                    </div>

                    <div class="range-note">‚Äª ÁµÇ‰∫Ü‰ΩçÁΩÆ„Çí 0 „Å´„Åô„Çã„Å®Êú´Â∞æ„Åæ„ÅßÁÖßÂêà„Åó„Åæ„Åô</div>
                </div>

                <div class="settings-card">
                    <div class="settings-card-title">üîê ÁÆ°ÁêÜËÄÖË®≠ÂÆö</div>
                    
                    <div class="setting-row">
                        <span class="setting-label">ÁÆ°ÁêÜËÄÖ„Éë„Çπ„ÉØ„Éº„Éâ</span>
                        <input type="password" class="setting-input" id="adminPassword" placeholder="Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ">
                    </div>

                    <div class="setting-row">
                        <span class="setting-label">ÁÆ°ÁêÜËÄÖQRÔºà„Ç®„É©„ÉºËß£Èô§Áî®Ôºâ</span>
                        <input type="text" class="setting-input" id="adminQR" placeholder="QR„ÅÆÂÄ§">
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-card-title">üîä „Åù„ÅÆ‰ªñ</div>
                    
                    <div class="setting-row">
                        <span class="setting-label">ÁÖßÂêàÈü≥„ÇíÈ≥¥„Çâ„Åô</span>
                        <div class="toggle-switch on" id="soundToggle" onclick="toggleSound()"></div>
                    </div>

                    <div class="setting-row">
                        <span class="setting-label">„Éê„Ç§„Éñ„É¨„Éº„Ç∑„Éß„É≥</span>
                        <div class="toggle-switch on" id="vibrationToggle" onclick="toggleVibration()"></div>
                    </div>
                </div>

                <button class="save-btn" onclick="saveAllSettings()">üíæ Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
                <button class="lock-settings-btn" onclick="lockSettings()">üîí Ë®≠ÂÆö„Çí„É≠„ÉÉ„ÇØ</button>
            </div>
        </div>
    </div>

    <!-- ÁµêÊûú„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div class="result-overlay" id="resultOverlay">
        <div class="result-symbol" id="resultSymbol">‚óã</div>
        <div class="result-text" id="resultText">‰∏ÄËá¥</div>
        <div class="result-detail" id="resultDetail"></div>
        <button class="result-btn" id="okBtn" onclick="closeAndContinue()">Ê¨°„ÅÆÁÖßÂêà„Å∏</button>
        <div class="admin-area" id="adminArea" style="display:none;">
            <p>‚ö†Ô∏è ÁÆ°ÁêÜËÄÖQR„ÅßËß£Èô§„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            <div class="admin-input-group">
                <input type="text" class="admin-input" id="adminInput" placeholder="ÁÆ°ÁêÜËÄÖQR„ÇíË™≠„ÅøÂèñ„Çä">
            </div>
        </div>
    </div>

    <script>
        // ========== Áä∂ÊÖãÁÆ°ÁêÜ ==========
        let currentStep = 0; // 0:ÂæÖÊ©ü, 1:1ÂõûÁõÆË™≠Âèñ‰∏≠, 2:2ÂõûÁõÆË™≠Âèñ‰∏≠
        let value1 = '';
        let value2 = '';
        let isNGLocked = false;
        let scanLog = [];
        let audioCtx = null;

        // Ë®≠ÂÆö
        let settings = {
            range1Start: 1,
            range1End: 0,
            range2Start: 1,
            range2End: 0,
            adminPassword: 'admin',
            adminQR: 'ADMIN123',
            soundEnabled: true,
            vibrationEnabled: true
        };

        // ========== ÂàùÊúüÂåñ ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadLog();
            setupInputListeners();
        });

        // ========== ÂÖ•Âäõ„É™„Çπ„Éä„ÉºË®≠ÂÆö ==========
        function setupInputListeners() {
            const scanInput = document.getElementById('scanInput');
            const adminInput = document.getElementById('adminInput');

            // QR„É™„Éº„ÉÄ„Éº„Åã„Çâ„ÅÆÂÖ•ÂäõÔºàEnter„Ç≠„Éº„ÅßÁ¢∫ÂÆöÔºâ
            scanInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const value = scanInput.value.trim();
                    if (value && !isWaiting) {
                        handleScan(value);
                        scanInput.value = '';
                    }
                }
            });

            // ÁÆ°ÁêÜËÄÖQRÂÖ•Âäõ
            adminInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const value = adminInput.value.trim();
                    if (value) {
                        handleAdminScan(value);
                        adminInput.value = '';
                    }
                }
            });
        }

        // ========== „Çπ„Ç≠„É£„É≥Âá¶ÁêÜ ==========
        function handleScan(decoded) {
            if (currentStep === 1) {
                value1 = decoded;
                playSound('beep');
                currentStep = 2;
                updateScanUI();
                document.getElementById('scanInput').focus();
                
            } else if (currentStep === 2) {
                value2 = decoded;
                playSound('beep');
                doMatch();
            }
        }

        function handleAdminScan(value) {
            if (value === settings.adminQR) {
                isNGLocked = false;
                playSound('ok');
                document.getElementById('resultOverlay').classList.remove('show');
                showStandby();
                alert('‚úÖ „Ç®„É©„ÉºËß£Èô§„Åó„Åæ„Åó„Åü');
            } else {
                playSound('ng');
                alert('‚ùå ÁÆ°ÁêÜËÄÖQR„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì');
                document.getElementById('adminInput').focus();
            }
        }

        // ========== Ë®≠ÂÆö ==========
        function loadSettings() {
            const saved = localStorage.getItem('qrMatchSettings_v4');
            if (saved) {
                settings = { ...settings, ...JSON.parse(saved) };
            }
            applySettingsToForm();
        }

        function applySettingsToForm() {
            document.getElementById('range1Start').value = settings.range1Start;
            document.getElementById('range1End').value = settings.range1End;
            document.getElementById('range2Start').value = settings.range2Start;
            document.getElementById('range2End').value = settings.range2End;
            document.getElementById('adminQR').value = settings.adminQR;
            document.getElementById('soundToggle').className = settings.soundEnabled ? 'toggle-switch on' : 'toggle-switch';
            document.getElementById('vibrationToggle').className = settings.vibrationEnabled ? 'toggle-switch on' : 'toggle-switch';
        }

        function saveAllSettings() {
            settings.range1Start = parseInt(document.getElementById('range1Start').value) || 1;
            settings.range1End = parseInt(document.getElementById('range1End').value) || 0;
            settings.range2Start = parseInt(document.getElementById('range2Start').value) || 1;
            settings.range2End = parseInt(document.getElementById('range2End').value) || 0;
            
            const newPassword = document.getElementById('adminPassword').value.trim();
            if (newPassword) {
                settings.adminPassword = newPassword;
            }
            
            settings.adminQR = document.getElementById('adminQR').value.trim() || 'ADMIN123';

            localStorage.setItem('qrMatchSettings_v4', JSON.stringify(settings));
            alert('‚úÖ Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            document.getElementById('adminPassword').value = '';
        }

        function toggleSound() {
            settings.soundEnabled = !settings.soundEnabled;
            document.getElementById('soundToggle').className = settings.soundEnabled ? 'toggle-switch on' : 'toggle-switch';
        }

        function toggleVibration() {
            settings.vibrationEnabled = !settings.vibrationEnabled;
            document.getElementById('vibrationToggle').className = settings.vibrationEnabled ? 'toggle-switch on' : 'toggle-switch';
        }

        // ========== Ë®≠ÂÆö„É≠„ÉÉ„ÇØ ==========
        function unlockSettings() {
            const input = document.getElementById('unlockPassword').value;
            if (input === settings.adminPassword) {
                document.getElementById('settingsLocked').style.display = 'none';
                document.getElementById('settingsUnlocked').style.display = 'block';
                document.getElementById('unlockPassword').value = '';
            } else {
                alert('‚ùå „Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô');
            }
        }

        function lockSettings() {
            document.getElementById('settingsLocked').style.display = 'block';
            document.getElementById('settingsUnlocked').style.display = 'none';
        }

        // ========== „Çø„ÉñÂàá„ÇäÊõø„Åà ==========
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'scan') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('tab-scan').classList.add('active');
            } else {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('tab-settings').classList.add('active');
            }
        }

        // ========== „É≠„Ç∞ ==========
        function loadLog() {
            const saved = localStorage.getItem('qrMatchLog_v4');
            if (saved) {
                scanLog = JSON.parse(saved);
                renderLog();
            }
        }

        function saveLog() {
            localStorage.setItem('qrMatchLog_v4', JSON.stringify(scanLog));
        }

        // ========== Èü≥„Éª„Éê„Ç§„Éñ ==========
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playSound(type) {
            if (!settings.soundEnabled) return;
            initAudio();
            
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'beep') {
                osc.frequency.value = 1400;
                osc.type = 'sine';
                gain.gain.value = 0.5;
                osc.start();
                setTimeout(() => osc.stop(), 300);
                vibrate([150]);
            } else if (type === 'ok') {
                osc.frequency.value = 1200;
                osc.type = 'sine';
                gain.gain.value = 0.5;
                osc.start();
                setTimeout(() => osc.frequency.value = 1500, 120);
                setTimeout(() => osc.stop(), 250);
                vibrate([100, 50, 100]);
            } else if (type === 'ng') {
                osc.frequency.value = 280;
                osc.type = 'square';
                gain.gain.value = 0.4;
                osc.start();
                setTimeout(() => osc.stop(), 500);
                vibrate([500]);
            }
        }

        function vibrate(pattern) {
            if (!settings.vibrationEnabled) return;
            if (navigator.vibrate) {
                navigator.vibrate(pattern);
            }
        }

        // ========== ÁØÑÂõ≤ÊäΩÂá∫ ==========
        function extractRange(str, start, end) {
            const s = start - 1;
            const e = end === 0 ? str.length : end;
            return str.substring(s, e);
        }

        // ========== ÁîªÈù¢Âàá„ÇäÊõø„Åà ==========
        function showStandby() {
            document.getElementById('standbyScreen').style.display = 'flex';
            document.getElementById('scanScreen').classList.remove('active');
        }

        function showScanScreen() {
            document.getElementById('standbyScreen').style.display = 'none';
            document.getElementById('scanScreen').classList.add('active');
            document.getElementById('scanInput').value = '';
            document.getElementById('scanInput').focus();
        }

        function updateScanUI() {
            const step = document.getElementById('scanStep');
            const message = document.getElementById('scanMessage');
            const input = document.getElementById('scanInput');

            if (currentStep === 1) {
                step.textContent = 'STEP 1 / 2';
                message.textContent = '1ÂõûÁõÆ„ÇíË™≠„ÅøÂèñ„Å£„Å¶„Åè„Å†„Åï„ÅÑ';
                message.className = 'scan-message';
                input.className = 'scan-input';
                input.placeholder = 'QR„É™„Éº„ÉÄ„Éº„ÅßË™≠„ÅøÂèñ„Çä';
            } else if (currentStep === 2) {
                step.textContent = 'STEP 2 / 2';
                message.textContent = '2ÂõûÁõÆ„ÇíË™≠„ÅøÂèñ„Å£„Å¶„Åè„Å†„Åï„ÅÑ';
                message.className = 'scan-message step2';
                input.className = 'scan-input step2';
                input.placeholder = 'QR„É™„Éº„ÉÄ„Éº„ÅßË™≠„ÅøÂèñ„Çä';
            }
        }

        // ========== „Çπ„Ç≠„É£„É≥ÈñãÂßã„ÉªÂÅúÊ≠¢ ==========
        function startScanning() {
            if (isNGLocked) {
                showNGOverlay();
                return;
            }

            value1 = '';
            value2 = '';
            currentStep = 1;

            showScanScreen();
            updateScanUI();
        }

        function stopAndReset() {
            currentStep = 0;
            value1 = '';
            value2 = '';
            showStandby();
        }

        // ========== ÁÖßÂêà ==========
        function doMatch() {
            const ext1 = extractRange(value1, settings.range1Start, settings.range1End);
            const ext2 = extractRange(value2, settings.range2Start, settings.range2End);
            const isOK = ext1 === ext2;

            scanLog.unshift({
                timestamp: new Date().toISOString(),
                qr1: value1,
                qr2: value2,
                compared1: ext1,
                compared2: ext2,
                range1: `${settings.range1Start}-${settings.range1End}`,
                range2: `${settings.range2Start}-${settings.range2End}`,
                result: isOK ? 'OK' : 'NG'
            });
            if (scanLog.length > 100) scanLog.pop();
            saveLog();
            renderLog();

            showResult(isOK, ext1, ext2);
        }

        // ========== ÁµêÊûúË°®Á§∫ ==========
        function showResult(isOK, ext1, ext2) {
            const overlay = document.getElementById('resultOverlay');
            const symbol = document.getElementById('resultSymbol');
            const text = document.getElementById('resultText');
            const detail = document.getElementById('resultDetail');
            const okBtn = document.getElementById('okBtn');
            const adminArea = document.getElementById('adminArea');

            overlay.classList.add('show');

            if (isOK) {
                overlay.className = 'result-overlay show ok';
                symbol.textContent = '‚óã';
                text.textContent = '‰∏ÄËá¥';
                detail.innerHTML = `<p class="label">ÁÖßÂêàÂÄ§</p><p>${ext1}</p>`;
                okBtn.style.display = 'block';
                adminArea.style.display = 'none';
                playSound('ok');
            } else {
                overlay.className = 'result-overlay show ng ng-locked';
                symbol.textContent = '√ó';
                text.textContent = '‰∏ç‰∏ÄËá¥';
                detail.innerHTML = `
                    <p class="label">1ÂõûÁõÆ</p><p>${ext1}</p>
                    <p class="label" style="margin-top:8px;">2ÂõûÁõÆ</p><p>${ext2}</p>
                `;
                okBtn.style.display = 'none';
                adminArea.style.display = 'block';
                isNGLocked = true;
                playSound('ng');
                setTimeout(() => document.getElementById('adminInput').focus(), 100);
            }
        }

        function showNGOverlay() {
            const overlay = document.getElementById('resultOverlay');
            overlay.className = 'result-overlay show ng ng-locked';
            document.getElementById('resultSymbol').textContent = '√ó';
            document.getElementById('resultText').textContent = '„Ç®„É©„ÉºÁä∂ÊÖã';
            document.getElementById('resultDetail').innerHTML = '<p>ÁÆ°ÁêÜËÄÖQR„ÅßËß£Èô§„ÅåÂøÖË¶Å</p>';
            document.getElementById('okBtn').style.display = 'none';
            document.getElementById('adminArea').style.display = 'block';
            setTimeout(() => document.getElementById('adminInput').focus(), 100);
        }

        function closeAndContinue() {
            document.getElementById('resultOverlay').classList.remove('show');
            // Ëá™ÂãïÁöÑ„Å´Ê¨°„ÅÆ„Çπ„Ç≠„É£„É≥„ÇíÈñãÂßã
            setTimeout(() => startScanning(), 300);
        }

        // ========== „É≠„Ç∞Ë°®Á§∫ ==========
        function renderLog() {
            const container = document.getElementById('logList');
            document.getElementById('logCount').textContent = scanLog.length + '‰ª∂';

            if (scanLog.length === 0) {
                container.innerHTML = '<div class="no-log">Â±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            container.innerHTML = scanLog.slice(0, 50).map(l => {
                const t = new Date(l.timestamp).toLocaleString('ja-JP');
                return `
                    <div class="log-item ${l.result.toLowerCase()}">
                        <div class="log-time">${t}</div>
                        <div class="log-result">${l.result === 'OK' ? '‚úÖ OK' : '‚ùå NG'}</div>
                        <div class="log-values">1: ${l.compared1} / 2: ${l.compared2}</div>
                    </div>
                `;
            }).join('');
        }

        function clearLog() {
            if (confirm('Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) {
                scanLog = [];
                saveLog();
                renderLog();
            }
        }

        function exportLog() {
            if (scanLog.length === 0) return alert('Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
            const headers = ['Êó•ÊôÇ','ÁµêÊûú','QR1(ÂÖ®‰Ωì)','QR2(ÂÖ®‰Ωì)','ÁÖßÂêà1','ÁÖßÂêà2','ÁØÑÂõ≤1','ÁØÑÂõ≤2'];
            const rows = scanLog.map(l => [
                new Date(l.timestamp).toLocaleString('ja-JP'),
                l.result, l.qr1, l.qr2, l.compared1, l.compared2, l.range1, l.range2
            ]);
            const csv = [headers,...rows].map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv'}));
            a.download = `QRÁÖßÂêàÂ±•Ê≠¥_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
        }
    </script>
</body>
</html>
