<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>プレス稼働ログ（タップ記録＆時間別稼働率）</title>
<style>
  :root{
    --ink:#0f172a; --muted:#6b7280; --card:#fff; --bg:#f6f8fb; --border:#e5e7eb;
    --run:#16a34a; --abn:#ef4444; --plan:#0ea5e9; --setup:#f59e0b;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI","Hiragino Sans",sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .row{display:grid;gap:12px}
  @media(min-width:960px){.row{grid-template-columns:1.1fr .9fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.04)}
  .card h2{font-size:1rem;margin:0 0 8px;padding:0 0 8px;border-bottom:1px solid var(--border)}
  header{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:6px 0 14px}
  header .title{font-weight:700;font-size:1.05rem}
  select,input[type="date"]{padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#fff}
  .btns{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .btn{padding:14px 10px;border:none;border-radius:12px;color:#fff;font-weight:700;font-size:1.05rem;cursor:pointer}
  .btn:active{transform:scale(.99)}
  .run{background:var(--run)} .abn{background:var(--abn)} .plan{background:var(--plan)} .setup{background:var(--setup)}
  .state{display:flex;align-items:center;gap:10px}
  .dot{width:12px;height:12px;border-radius:50%}
  .dot.run{background:var(--run)} .dot.abn{background:var(--abn)} .dot.plan{background:var(--plan)} .dot.setup{background:var(--setup)}
  .kv{display:flex;gap:18px;flex-wrap:wrap;color:var(--muted);font-size:.95rem}
  .tools{display:flex;gap:8px;flex-wrap:wrap}
  .ghost{background:#fff;border:1px solid var(--border);color:var(--ink);border-radius:10px;padding:8px 10px;cursor:pointer}
  .ghost:active{transform:scale(.99)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 8px;border-bottom:1px solid var(--border);text-align:left;font-size:.95rem}
  th{font-weight:700;background:#fafbff}
  .mono{font-variant-numeric:tabular-nums}
  .right{text-align:right}
  .bar{height:10px;background:#e5e7eb;border-radius:6px;overflow:hidden}
  .fill{height:100%}
  .fill.run{background:var(--run)} .fill.abn{background:var(--abn)} .fill.plan{background:var(--plan)} .fill.setup{background:var(--setup)}
  .hint{color:var(--muted);font-size:.9rem}
  .warn{color:var(--abn);font-weight:700}
  footer{margin:14px 0 6px;color:var(--muted);font-size:.85rem}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">プレス稼働ログ</div>
    <label>設備
      <select id="machine">
        <option value="PRESS-01">PRESS-01</option>
        <option value="PRESS-02">PRESS-02</option>
        <option value="PRESS-03">PRESS-03</option>
      </select>
    </label>
    <label>日付 <input type="date" id="workDate"></label>
    <button class="ghost" id="newDay">新規日付</button>
    <span class="hint">端末保存／CSV出力可</span>
  </header>

  <div class="row">
    <!-- 左：操作＆現況 -->
    <section class="card" style="padding:14px">
      <h2>状態切替（タップで記録）</h2>
      <div class="btns" style="margin:10px 0 12px">
        <button class="btn run"   data-state="run">稼働中</button>
        <button class="btn abn"   data-state="abn">異常停止中</button>
        <button class="btn plan"  data-state="plan">計画停止中</button>
        <button class="btn setup" data-state="setup">段取り中</button>
      </div>

      <div class="state" id="stateNow" style="margin:4px 0 8px">
        <div class="dot run" id="stateDot"></div>
        <div><b id="stateLabel">稼働中</b> <span class="hint">（<span id="since">--:--</span>から）</span></div>
      </div>
      <div class="kv">
        <div>経過：<span class="mono" id="elapsed">00:00:00</span></div>
        <div>本日稼働：<span class="mono" id="sumRun">0:00</span></div>
        <div>本日稼働率：<span class="mono" id="rateToday">0%</span> <span class="hint" id="denomHint">（計画停止含む）</span></div>
      </div>

      <div class="tools" style="margin-top:10px">
        <button class="ghost" id="undo">直前の区間を取り消し</button>
        <button class="ghost" id="split">現在時点で区切る</button>
        <button class="ghost" id="clearDay">本日の記録を全削除</button>
        <label class="ghost" style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="excludePlan"> 稼働率の分母から計画停止を除外
        </label>
        <button class="ghost" id="exportCsv">CSV出力</button>
      </div>
    </section>

    <!-- 右：時間別集計 -->
    <section class="card" style="padding:14px">
      <h2>時間別稼働率（1時間ごと）</h2>
      <table id="tblHour">
        <thead>
          <tr><th>時</th><th>稼働率</th><th>稼働分/分母</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="hint" style="margin-top:6px">※ 分母はその時間帯で記録のある合計分。オプションで計画停止を除外可能。</div>
    </section>
  </div>

  <!-- 下：ログ -->
  <section class="card" style="padding:14px;margin-top:12px">
    <h2>区間ログ</h2>
    <table id="tblLog">
      <thead>
        <tr>
          <th>#</th><th>状態</th><th>開始</th><th>終了</th><th class="right">分</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <footer>端末保存キー：<span id="keyHint" class="mono">-</span></footer>
</div>

<script>
/* ====== 基本ユーティリティ ====== */
const ST_LABEL = {run:'稼働中', abn:'異常停止中', plan:'計画停止中', setup:'段取り中'};
const ST_ORDER  = ['run','abn','plan','setup'];
const pad = (n)=> String(n).padStart(2,'0');
const fmtHMS = (sec)=>{
  const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60;
  return `${pad(h)}:${pad(m)}:${pad(s)}`;
};
const fmtHM = (min)=> `${Math.floor(min/60)}:${pad(Math.floor(min%60))}`;
const todayStr = ()=>{
  const d=new Date(); d.setHours(0,0,0,0);
  const y=d.getFullYear(), m=pad(d.getMonth()+1), da=pad(d.getDate());
  return `${y}-${m}-${da}`;
};
const toLocalISO = (d)=> {
  const z = d.getTimezoneOffset()*60000;
  return new Date(d - z).toISOString().slice(0,19);
};
const parseLocal = (iso)=> new Date(iso);

/* ====== ストレージ（端末保存） ====== */
const keyOf = (machine, date)=> `presslog_v1:${machine}:${date}`;
const loadDay = (machine, date)=>{
  const raw = localStorage.getItem(keyOf(machine,date));
  return raw ? JSON.parse(raw) : {current:null, logs:[]}; // logs: [{state,start,end}]
};
const saveDay = (machine, date, data)=>{
  localStorage.setItem(keyOf(machine,date), JSON.stringify(data));
  document.getElementById('keyHint').textContent = keyOf(machine,date);
};

/* ====== 状態 ====== */
const machineEl = document.getElementById('machine');
const dateEl = document.getElementById('workDate');
const stateDot = document.getElementById('stateDot');
const stateLabel = document.getElementById('stateLabel');
const sinceEl = document.getElementById('since');
const elapsedEl = document.getElementById('elapsed');
const sumRunEl = document.getElementById('sumRun');
const rateTodayEl = document.getElementById('rateToday');
const denomHintEl = document.getElementById('denomHint');
const tblLogBody = document.querySelector('#tblLog tbody');
const tblHourBody = document.querySelector('#tblHour tbody');
const excludePlanEl = document.getElementById('excludePlan');

let timer=null;
let state = {machine: 'PRESS-01', date: todayStr(), data: {current:null, logs:[] }};

function refreshFromStorage(){
  state.data = loadDay(state.machine, state.date);
  saveDay(state.machine, state.date, state.data);
  renderAll();
}
function setMachine(v){ state.machine=v; refreshFromStorage(); }
function setDate(v){ state.date=v; refreshFromStorage(); }

function startTimer(){
  if(timer) clearInterval(timer);
  timer = setInterval(()=> { renderHeader(); }, 1000);
}

/* ====== クリックで状態変更 ====== */
function changeState(newState){
  const now = new Date();
  let d = state.data;
  // 現在区間をクローズ
  if(d.current){
    d.current.end = toLocalISO(now);
    d.logs.push({...d.current});
  }
  // 新区間を開始
  d.current = {state:newState, start: toLocalISO(now), end: null};
  saveDay(state.machine, state.date, d);
  renderAll();
}

function splitNow(){
  const now = new Date();
  let d = state.data;
  if(!d.current) return;
  // 終了→同じ状態で即再開（区切り）
  d.current.end = toLocalISO(now);
  d.logs.push({...d.current});
  d.current = {state: d.current.state, start: toLocalISO(now), end: null};
  saveDay(state.machine, state.date, d);
  renderAll();
}

function undoLast(){
  let d = state.data;
  if(d.current && !d.logs.length){
    d.current = null;
  }else if(d.current && d.logs.length){
    // カレントを破棄して直前ログを復元
    d.current = d.logs.pop();
    d.current.end = null;
  }else if(!d.current && d.logs.length){
    // 直前ログを削除
    d.logs.pop();
  }
  saveDay(state.machine, state.date, d);
  renderAll();
}

function clearDay(){
  if(!confirm('本日の記録を全削除します。よろしいですか？')) return;
  state.data = {current:null, logs:[]};
  saveDay(state.machine, state.date, state.data);
  renderAll();
}

/* ====== 描画 ====== */
function renderHeader(){
  const d = state.data;
  const cur = d.current;
  let label='未記録', dotClass='run', since='--:--', elapsed='00:00:00';
  if(cur){
    label = ST_LABEL[cur.state];
    dotClass = cur.state;
    const sinceDate = parseLocal(cur.start);
    since = `${pad(sinceDate.getHours())}:${pad(sinceDate.getMinutes())}`;
    const sec = Math.floor((Date.now() - sinceDate.getTime())/1000);
    elapsed = fmtHMS(Math.max(0,sec));
  }
  stateDot.className = `dot ${dotClass}`;
  stateLabel.textContent = label;
  sinceEl.textContent = since;
  elapsedEl.textContent = elapsed;

  // 当日稼働合計＆稼働率
  const agg = aggregateAll(d.logs, d.current, excludePlanEl.checked);
  sumRunEl.textContent = fmtHM(agg.sumRunMin);
  rateTodayEl.textContent = `${(agg.rateToday*100).toFixed(0)}%`;
  denomHintEl.textContent = excludePlanEl.checked ? '（計画停止を分母から除外）' : '（計画停止含む）';
}

function renderLogs(){
  const d = state.data;
  const rows = [...d.logs];
  if(d.current) rows.push({...d.current, end: d.current.end}); // 表示用（進行中は分なし）
  tblLogBody.innerHTML = '';
  rows.forEach((r,i)=>{
    const st = r.state;
    const stName = ST_LABEL[st];
    const s = parseLocal(r.start);
    const e = r.end ? parseLocal(r.end) : null;
    const mins = e ? Math.max(0, Math.round((e - s)/60000)) : '';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${i+1}</td>
      <td><span class="dot ${st}"></span> ${stName}</td>
      <td class="mono">${toDisp(s)}</td>
      <td class="mono">${e?toDisp(e):'<span class="hint">進行中</span>'}</td>
      <td class="right mono">${mins!=='' ? mins : '-'}</td>
    `;
    tblLogBody.appendChild(tr);
  });
}
const toDisp = (d)=> `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}:${d.getSeconds().toString().padStart(2,'0')}`;

/* ====== 集計（時間別・終日） ====== */
function aggregateAll(logs, current, excludePlan){
  // 現在進行中は「今時点」で仮終了にして集計
  const closed = logs.map(x=>({...x}));
  if(current){
    closed.push({...current, end: toLocalISO(new Date())});
  }
  // 当日0:00〜24:00にクリップ＆時間別に分割
  const dayStart = new Date(state.date+'T00:00:00');
  const dayEnd   = new Date(state.date+'T24:00:00');

  // 区間を[dayStart,dayEnd]に収め、時間帯ごとにミニ区間へ分割
  const chunks = [];
  closed.forEach(r=>{
    if(!r.end) return; // 終了していないものは除外（上で仮終了済みだが念のため）
    let s = parseLocal(r.start), e = parseLocal(r.end);
    if(e<=dayStart || s>=dayEnd) return;
    if(s<dayStart) s = new Date(dayStart);
    if(e>dayEnd)   e = new Date(dayEnd);
    // 時間境界で分割
    let curS = s;
    while(curS < e){
      const boundary = new Date(curS); boundary.setMinutes(0,0,0); boundary.setHours(boundary.getHours()+1);
      const curE = e<boundary ? e : boundary;
      chunks.push({state:r.state, start:curS, end:curE});
      curS = curE;
    }
  });

  // 1時間ごと集計
  const hour = Array.from({length:24}, (_,h)=>({h, run:0, abn:0, plan:0, setup:0}));
  chunks.forEach(c=>{
    const minutes = Math.max(0, (c.end - c.start)/60000);
    const h = c.start.getHours(); // 分割してるのでstartの時間でOK
    hour[h][c.state] += minutes;
  });

  // 1日合算
  let sumRun=0, sumDen=0;
  const rows = hour.map(r=>{
    const den = excludePlan ? (r.run + r.abn + r.setup) : (r.run + r.abn + r.plan + r.setup);
    const rate = den>0 ? r.run/den : 0;
    sumRun += r.run; sumDen += den;
    return {h:r.h, rate, den, run:r.run, abn:r.abn, plan:r.plan, setup:r.setup};
  });
  const rateToday = sumDen>0 ? sumRun/sumDen : 0;

  return {rows, rateToday, sumRunMin: sumRun};
}

function renderHour(){
  const ex = excludePlanEl.checked;
  const agg = aggregateAll(state.data.logs, state.data.current, ex);
  tblHourBody.innerHTML='';
  agg.rows.forEach(r=>{
    const pct = Math.round(r.rate*100);
    const tr = document.createElement('tr');
    const denTxt = `${Math.round(r.run)} / ${Math.round(r.den)}`;
    tr.innerHTML = `
      <td class="mono">${pad(r.h)}:00</td>
      <td style="min-width:260px">
        <div class="bar"><div class="fill run" style="width:${pct}%;"></div></div>
        <div class="hint">${pct}%（稼働）</div>
      </td>
      <td class="right mono">${denTxt}</td>
    `;
    tblHourBody.appendChild(tr);
  });
}

/* ====== CSV ====== */
function exportCsv(){
  const d = state.data;
  // 出力：No,状態,開始,終了,分
  const rows = [['No','状態','開始','終了','分']];
  const closed = [...d.logs];
  if(d.current){
    closed.push({...d.current, end: toLocalISO(new Date())});
  }
  closed.forEach((r,i)=>{
    const s = parseLocal(r.start);
    const e = r.end ? parseLocal(r.end) : null;
    const mins = e ? Math.round((e - s)/60000) : '';
    rows.push([i+1, ST_LABEL[r.state], r.start, r.end||'', mins]);
  });

  // 時間別集計も末尾に追加
  rows.push([]);
  rows.push(['時間別集計（分母' + (excludePlanEl.checked?'計画停止除外':'計画停止含む') + '）']);
  rows.push(['時','稼働率%','稼働分','分母','異常停止分','計画停止分','段取り分']);
  const ex = excludePlanEl.checked;
  const agg = aggregateAll(state.data.logs, state.data.current, ex);
  agg.rows.forEach(r=>{
    rows.push([`${pad(r.h)}:00`, Math.round(r.rate*100), Math.round(r.run), Math.round(r.den), Math.round(r.abn), Math.round(r.plan), Math.round(r.setup)]);
  });

  const csv = rows.map(cols=> cols.map(v=>{
    const s = (v===null||v===undefined)?'':String(v);
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  }).join(',')).join('\n');

  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${state.machine}_${state.date}_presslog.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* ====== イベント配線 ====== */
document.querySelectorAll('.btn[data-state]').forEach(b=>{
  b.addEventListener('click', ()=> changeState(b.dataset.state));
});
document.getElementById('undo').addEventListener('click', undoLast);
document.getElementById('split').addEventListener('click', splitNow);
document.getElementById('clearDay').addEventListener('click', clearDay);
document.getElementById('exportCsv').addEventListener('click', exportCsv);
excludePlanEl.addEventListener('change', ()=> { renderHeader(); renderHour(); });

machineEl.addEventListener('change', e=> setMachine(e.target.value));
dateEl.addEventListener('change', e=> setDate(e.target.value));
document.getElementById('newDay').addEventListener('click', ()=>{
  const d = prompt('日付（YYYY-MM-DD）を入力', state.date);
  if(!d) return;
  if(!/^\d{4}-\d{2}-\d{2}$/.test(d)) return alert('形式が正しくありません');
  dateEl.value = d; setDate(d);
});

/* ====== 起動 ====== */
(function init(){
  // 既定：今日
  dateEl.value = todayStr();
  state.machine = machineEl.value;
  state.date = dateEl.value;
  refreshFromStorage();
  renderAll();
  startTimer();
})();

function renderAll(){
  renderHeader();
  renderLogs();
  renderHour();
}
</script>
</body>
</html>