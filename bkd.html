<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>プレス稼働ログ（停止時間色分けバー付）</title>
<style>
  :root{
    --ink:#0f172a; --muted:#6b7280; --card:#fff; --bg:#f6f8fb; --border:#e5e7eb;
    --run:#16a34a; --abn:#ef4444; --plan:#0ea5e9; --setup:#f59e0b;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI","Hiragino Sans",sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .row{display:grid;gap:12px}
  @media(min-width:960px){.row{grid-template-columns:1.1fr .9fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.04)}
  .card h2{font-size:1rem;margin:0 0 8px;padding:0 0 8px;border-bottom:1px solid var(--border)}
  header{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:6px 0 14px}
  header .title{font-weight:700;font-size:1.05rem}
  select,input[type="date"]{padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#fff}
  .btns{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .btn{padding:14px 10px;border:none;border-radius:12px;color:#fff;font-weight:700;font-size:1.05rem;cursor:pointer}
  .btn:active{transform:scale(.99)}
  .run{background:var(--run)} .abn{background:var(--abn)} .plan{background:var(--plan)} .setup{background:var(--setup)}
  .state{display:flex;align-items:center;gap:10px}
  .dot{width:12px;height:12px;border-radius:50%}
  .dot.run{background:var(--run)} .dot.abn{background:var(--abn)} .dot.plan{background:var(--plan)} .dot.setup{background:var(--setup)}
  .kv{display:flex;gap:18px;flex-wrap:wrap;color:var(--muted);font-size:.95rem}
  .tools{display:flex;gap:8px;flex-wrap:wrap}
  .ghost{background:#fff;border:1px solid var(--border);color:var(--ink);border-radius:10px;padding:8px 10px;cursor:pointer}
  .ghost:active{transform:scale(.99)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 8px;border-bottom:1px solid var(--border);text-align:left;font-size:.95rem}
  th{font-weight:700;background:#fafbff}
  .mono{font-variant-numeric:tabular-nums}
  .right{text-align:right}
  .bar{height:12px;background:#e5e7eb;border-radius:6px;overflow:hidden;display:flex}
  .seg{height:100%}
  .seg.run{background:var(--run)}
  .seg.abn{background:var(--abn);opacity:.4}
  .seg.plan{background:var(--plan);opacity:.4}
  .seg.setup{background:var(--setup);opacity:.4}
  .hint{color:var(--muted);font-size:.9rem}
  footer{margin:14px 0 6px;color:var(--muted);font-size:.85rem}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">プレス稼働ログ</div>
    <label>設備
      <select id="machine">
        <option value="PRESS-01">PRESS-01</option>
        <option value="PRESS-02">PRESS-02</option>
        <option value="PRESS-03">PRESS-03</option>
      </select>
    </label>
    <label>日付 <input type="date" id="workDate"></label>
    <button class="ghost" id="newDay">新規日付</button>
  </header>

  <div class="row">
    <section class="card" style="padding:14px">
      <h2>状態切替（タップで記録）</h2>
      <div class="btns" style="margin:10px 0 12px">
        <button class="btn run"   data-state="run">稼働中</button>
        <button class="btn abn"   data-state="abn">異常停止中</button>
        <button class="btn plan"  data-state="plan">計画停止中</button>
        <button class="btn setup" data-state="setup">段取り中</button>
      </div>
      <div class="state" id="stateNow">
        <div class="dot run" id="stateDot"></div>
        <div><b id="stateLabel">稼働中</b> <span class="hint">（<span id="since">--:--</span>から）</span></div>
      </div>
      <div class="kv">
        <div>経過：<span class="mono" id="elapsed">00:00:00</span></div>
        <div>本日稼働：<span class="mono" id="sumRun">0:00</span></div>
        <div>稼働率：<span class="mono" id="rateToday">0%</span></div>
      </div>
      <div class="tools" style="margin-top:10px">
        <button class="ghost" id="undo">直前取消</button>
        <button class="ghost" id="split">区切る</button>
        <button class="ghost" id="clearDay">全削除</button>
        <label class="ghost"><input type="checkbox" id="excludePlan"> 計画停止を除外</label>
        <button class="ghost" id="exportCsv">CSV</button>
      </div>
    </section>

    <section class="card" style="padding:14px">
      <h2>時間別稼働率（停止時間色分け）</h2>
      <table id="tblHour">
        <thead><tr><th>時</th><th>稼働率バー</th><th>稼働分/分母</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

  <section class="card" style="padding:14px;margin-top:12px">
    <h2>区間ログ</h2>
    <table id="tblLog">
      <thead><tr><th>#</th><th>状態</th><th>開始</th><th>終了</th><th class="right">分</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
  <footer>localStorage保存キー：<span id="keyHint"></span></footer>
</div>

<script>
const ST_LABEL={run:'稼働中',abn:'異常停止中',plan:'計画停止中',setup:'段取り中'};
const pad=n=>String(n).padStart(2,'0');
const fmtHM=m=>`${Math.floor(m/60)}:${pad(Math.floor(m%60))}`;
const todayStr=()=>{const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;}
const toLocalISO=d=>{const z=d.getTimezoneOffset()*60000;return new Date(d-z).toISOString().slice(0,19);}
const parseLocal=iso=>new Date(iso);
const keyOf=(m,d)=>`presslog_v2:${m}:${d}`;
const load=(m,d)=>JSON.parse(localStorage.getItem(keyOf(m,d))||'{"current":null,"logs":[]}');
const save=(m,d,v)=>localStorage.setItem(keyOf(m,d),JSON.stringify(v));

let state={machine:'PRESS-01',date:todayStr(),data:{current:null,logs:[]}};

function changeState(s){
  const now=new Date();
  const d=state.data;
  if(d.current){d.current.end=toLocalISO(now);d.logs.push({...d.current});}
  d.current={state:s,start:toLocalISO(now),end:null};
  save(state.machine,state.date,d);render();
}
function split(){const now=new Date();const d=state.data;if(!d.current)return;d.current.end=toLocalISO(now);d.logs.push({...d.current});d.current={state:d.current.state,start:toLocalISO(now),end:null};save(state.machine,state.date,d);render();}
function undo(){const d=state.data;if(d.logs.length)d.logs.pop();else d.current=null;save(state.machine,state.date,d);render();}
function clearDay(){if(!confirm('全削除？'))return;state.data={current:null,logs:[]};save(state.machine,state.date,state.data);render();}

function aggregate(excludePlan){
  const d=state.data;
  const closed=[...d.logs];if(d.current)closed.push({...d.current,end:toLocalISO(new Date())});
  const hRows=Array.from({length:24},(_,h)=>({h,run:0,abn:0,plan:0,setup:0}));
  closed.forEach(r=>{
    if(!r.end)return;let s=parseLocal(r.start),e=parseLocal(r.end);
    while(s<e){const next=new Date(s);next.setHours(s.getHours()+1,0,0,0);const stop=e<next?e:next;
      hRows[s.getHours()][r.state]+=Math.max(0,(stop-s)/60000);s=stop;}
  });
  let sumRun=0,sumDen=0;
  const rows=hRows.map(r=>{
    const den=excludePlan?(r.run+r.abn+r.setup):(r.run+r.abn+r.plan+r.setup);
    const rate=den? r.run/den:0;
    sumRun+=r.run;sumDen+=den;
    return {...r,den,rate};
  });
  return {rows,rate:sumDen?sumRun/sumDen:0,sumRun};
}

function render(){
  const ex=document.getElementById('excludePlan').checked;
  const a=aggregate(ex);
  document.getElementById('tblHour').querySelector('tbody').innerHTML=a.rows.map(r=>{
    const total=r.den||1;
    const wRun=r.run/total*100,wAbn=r.abn/total*100,wPlan=r.plan/total*100,wSetup=r.setup/total*100;
    return `<tr>
      <td class="mono">${pad(r.h)}:00</td>
      <td>
        <div class="bar">
          <div class="seg run" style="width:${wRun}%"></div>
          <div class="seg abn" style="width:${wAbn}%"></div>
          <div class="seg plan" style="width:${wPlan}%"></div>
          <div class="seg setup" style="width:${wSetup}%"></div>
        </div>
        <div class="hint">${Math.round(r.rate*100)}%</div>
      </td>
      <td class="right mono">${Math.round(r.run)} / ${Math.round(r.den)}</td>
    </tr>`;
  }).join('');
  document.getElementById('sumRun').textContent=fmtHM(a.sumRun);
  document.getElementById('rateToday').textContent=`${(a.rate*100).toFixed(0)}%`;
  document.getElementById('keyHint').textContent=keyOf(state.machine,state.date);
}

document.querySelectorAll('.btn[data-state]').forEach(b=>b.onclick=()=>changeState(b.dataset.state));
document.getElementById('split').onclick=split;
document.getElementById('undo').onclick=undo;
document.getElementById('clearDay').onclick=clearDay;
document.getElementById('excludePlan').onchange=render;
document.getElementById('machine').onchange=e=>{state.machine=e.target.value;state.data=load(state.machine,state.date);render();}
document.getElementById('workDate').onchange=e=>{state.date=e.target.value;state.data=load(state.machine,state.date);render();}
document.getElementById('newDay').onclick=()=>{const d=prompt('日付(YYYY-MM-DD)',state.date);if(d){state.date=d;document.getElementById('workDate').value=d;state.data=load(state.machine,d);render();}};

(function init(){const t=todayStr();document.getElementById('workDate').value=t;state.data=load(state.machine,t);render();})();
</script>
</body>
</html>