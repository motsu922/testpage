<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no">
<title>RACK WMS</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap');

:root {
  --bg: #0f1117;
  --surface: #181c25;
  --card: #1e2330;
  --border: #2a3040;
  --accent: #f5a623;
  --green: #2ecc71;
  --red: #e74c3c;
  --blue: #3498db;
  --orange: #e67e22;
  --text: #e8ecf0;
  --muted: #6b7a8d;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html { height: 100%; height: 100dvh; background: var(--bg) !important; overflow: hidden; }

button, input, select, textarea {
  font-family: 'Noto Sans JP', sans-serif;
  font-size: inherit;
}

body {
  height: 100%;
  height: 100dvh;
  background: var(--bg) !important;
  color: var(--text) !important;
  font-family: 'Noto Sans JP', sans-serif;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  -webkit-text-fill-color: var(--text);
}

/* ===== HEADER ===== */
.header {
  background: var(--surface) !important;
  border-bottom: 2px solid var(--accent) !important;
  padding: 10px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
  z-index: 100;
}
.header-title {
  font-family: 'Rajdhani', sans-serif;
  font-size: 22px;
  font-weight: 700;
  color: var(--accent) !important;
  letter-spacing: 2px;
  -webkit-text-fill-color: var(--accent);
}
.header-sub {
  font-size: 11px;
  color: var(--muted) !important;
  margin-left: auto;
  text-align: right;
  -webkit-text-fill-color: var(--muted);
}
#firebaseStatus { font-size: 11px; -webkit-text-fill-color: inherit; }

/* ===== TABS ===== */
.tabs {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
  background: var(--surface) !important;
  border-bottom: 1px solid var(--border) !important;
  flex-shrink: 0;
}
.tab {
  padding: 10px 2px;
  text-align: center;
  font-size: 10px;
  font-weight: 700;
  color: var(--muted) !important;
  cursor: pointer;
  border-bottom: 3px solid transparent !important;
  transition: all 0.2s;
  letter-spacing: 0.3px;
  -webkit-text-fill-color: var(--muted);
  user-select: none;
}
.tab.active {
  color: var(--accent) !important;
  border-bottom-color: var(--accent) !important;
  background: rgba(245,166,35,0.06) !important;
  -webkit-text-fill-color: var(--accent);
}
.tab.tab-hold.active {
  color: var(--red) !important;
  border-bottom-color: var(--red) !important;
  background: rgba(231,76,60,0.06) !important;
  -webkit-text-fill-color: var(--red);
}
.tab-icon { font-size: 15px; display: block; margin-bottom: 2px; }

/* ===== MAIN ===== */
.main {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  max-width: 600px;
  margin: 0 auto;
  width: 100%;
}
.section { display: none; }
.section.active {
  display: flex;
  flex-direction: column;
  flex: 1;
  overflow: hidden;
  padding: 10px 12px 0;
}

/* ===== STEPS ===== */
.steps {
  display: flex;
  gap: 6px;
  margin-bottom: 12px;
  align-items: center;
}
.step {
  flex: 1;
  padding: 7px 4px;
  text-align: center;
  font-size: 10px;
  font-weight: 700;
  border-radius: 6px;
  background: var(--card) !important;
  color: var(--muted) !important;
  border: 1px solid var(--border) !important;
  letter-spacing: 0.5px;
  -webkit-text-fill-color: var(--muted);
}
.step.done {
  background: rgba(46,204,113,0.12) !important;
  color: var(--green) !important;
  border-color: var(--green) !important;
  -webkit-text-fill-color: var(--green);
}
.step.active {
  background: rgba(245,166,35,0.15) !important;
  color: var(--accent) !important;
  border-color: var(--accent) !important;
  -webkit-text-fill-color: var(--accent);
}
.step.step-red.active {
  background: rgba(231,76,60,0.15) !important;
  color: var(--red) !important;
  border-color: var(--red) !important;
  -webkit-text-fill-color: var(--red);
}
.step-arrow { color: var(--muted) !important; font-size: 10px; flex: none; -webkit-text-fill-color: var(--muted); }

/* ===== SELECTED DISPLAY ===== */
.selected-display {
  background: var(--card) !important;
  border: 1px solid var(--border) !important;
  border-radius: 10px;
  padding: 12px 14px;
  margin-bottom: 12px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
.selected-display.single-col { grid-template-columns: 1fr; }
.sel-label {
  font-size: 10px;
  color: var(--muted) !important;
  letter-spacing: 1px;
  font-weight: 700;
  -webkit-text-fill-color: var(--muted);
}
.sel-value {
  font-size: 20px;
  font-weight: 700;
  color: var(--accent) !important;
  font-family: 'Rajdhani', sans-serif;
  letter-spacing: 1px;
  min-height: 30px;
  word-break: break-all;
  -webkit-text-fill-color: var(--accent);
}
.sel-value.red { color: var(--red) !important; -webkit-text-fill-color: var(--red); }

/* ===== SEC LABEL ===== */
.sec-label {
  font-size: 10px;
  font-weight: 700;
  color: var(--muted) !important;
  letter-spacing: 2px;
  margin-bottom: 8px;
  padding-left: 2px;
  display: flex;
  align-items: center;
  gap: 6px;
  -webkit-text-fill-color: var(--muted);
}

/* ===== INITIAL GRID ===== */
.initial-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
  gap: 7px;
  margin-bottom: 10px;
}
.initial-btn {
  background: var(--surface) !important;
  border: 2px solid var(--border) !important;
  border-radius: 8px;
  color: var(--text) !important;
  font-family: 'Rajdhani', sans-serif;
  font-size: 18px;
  font-weight: 700;
  padding: 10px 4px;
  cursor: pointer;
  transition: all 0.15s;
  text-align: center;
  letter-spacing: 1px;
  -webkit-text-fill-color: var(--text);
  user-select: none;
}
.initial-btn:active { transform: scale(0.93); }
.initial-btn.selected {
  background: rgba(245,166,35,0.2) !important;
  border-color: var(--accent) !important;
  color: var(--accent) !important;
  -webkit-text-fill-color: var(--accent);
}
.initial-btn.selected-red {
  background: rgba(231,76,60,0.2) !important;
  border-color: var(--red) !important;
  color: var(--red) !important;
  -webkit-text-fill-color: var(--red);
}
.initial-btn .count {
  display: block;
  font-size: 9px;
  font-family: 'Noto Sans JP', sans-serif;
  color: var(--muted) !important;
  font-weight: 400;
  margin-top: 1px;
  -webkit-text-fill-color: var(--muted);
}
.initial-btn.selected .count { color: var(--accent) !important; -webkit-text-fill-color: var(--accent); opacity: 0.7; }
.initial-btn.selected-red .count { color: var(--red) !important; -webkit-text-fill-color: var(--red); opacity: 0.7; }

/* ===== ITEM PANEL ===== */
.item-panel {
  background: var(--card) !important;
  border: 1px solid var(--border) !important;
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 12px;
  display: none;
}
.item-panel.visible { display: block; }
.item-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}
.item-panel-label {
  font-size: 11px;
  font-weight: 700;
  color: var(--muted) !important;
  letter-spacing: 2px;
  -webkit-text-fill-color: var(--muted);
}
.back-btn {
  background: var(--surface) !important;
  border: 1px solid var(--border) !important;
  border-radius: 6px;
  color: var(--muted) !important;
  font-size: 11px;
  font-weight: 700;
  padding: 4px 10px;
  cursor: pointer;
  letter-spacing: 1px;
  -webkit-text-fill-color: var(--muted);
}

/* ===== BUTTON GRID ===== */
.btn-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(88px, 1fr));
  gap: 8px;
  margin-bottom: 12px;
}
.item-btn {
  background: var(--card) !important;
  border: 2px solid var(--border) !important;
  border-radius: 10px;
  color: var(--text) !important;
  font-size: 13px;
  font-weight: 700;
  padding: 14px 6px;
  cursor: pointer;
  transition: all 0.15s;
  text-align: center;
  min-height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  word-break: break-all;
  line-height: 1.3;
  -webkit-text-fill-color: var(--text);
  user-select: none;
  position: relative;
}
.item-btn:active { transform: scale(0.95); }
.item-btn.selected {
  background: rgba(245,166,35,0.18) !important;
  border-color: var(--accent) !important;
  color: var(--accent) !important;
  -webkit-text-fill-color: var(--accent);
}
.item-btn.selected-red {
  background: rgba(231,76,60,0.18) !important;
  border-color: var(--red) !important;
  color: var(--red) !important;
  -webkit-text-fill-color: var(--red);
}
.item-btn.shelf-recommend {
  position: relative;
  background: rgba(52,152,219,0.12) !important;
  border-color: var(--blue) !important;
}
.item-btn.shelf-recommend::before {
  content: attr(data-rank);
  position: absolute;
  top: -8px; right: -8px;
  background: var(--blue) !important;
  color: white !important;
  font-size: 10px;
  font-weight: 700;
  width: 20px; height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  -webkit-text-fill-color: white;
}
.item-btn.shelf-recommend.selected {
  background: rgba(245,166,35,0.18) !important;
  border-color: var(--accent) !important;
  color: var(--accent) !important;
  -webkit-text-fill-color: var(--accent);
}
/* å‡ºè·åœæ­¢ä¸­ã®å“ç•ªãƒãƒƒã‚¸ */
.item-btn.hold-badge::after {
  content: 'åœæ­¢ä¸­';
  position: absolute;
  top: -8px; left: -8px;
  background: var(--red) !important;
  color: white !important;
  font-size: 9px;
  font-weight: 700;
  padding: 2px 5px;
  border-radius: 4px;
  -webkit-text-fill-color: white;
  letter-spacing: 0.5px;
}
.item-btn-sub {
  font-size: 10px;
  font-weight: 400;
  color: var(--muted) !important;
  display: block;
  margin-top: 2px;
  -webkit-text-fill-color: var(--muted);
}

/* ===== CONFIRM BUTTON ===== */
.confirm-wrap { margin-top: 6px; }
.confirm-btn {
  width: 100%;
  height: 68px;
  border-radius: 12px;
  border: 3px solid var(--border) !important;
  background: var(--card) !important;
  color: var(--muted) !important;
  font-family: 'Rajdhani', sans-serif;
  font-size: 20px;
  font-weight: 700;
  letter-spacing: 3px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: border-color 0.2s, color 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  -webkit-text-fill-color: var(--muted);
  user-select: none;
}
.confirm-btn.ready {
  border-color: var(--green) !important;
  color: var(--green) !important;
  -webkit-text-fill-color: var(--green);
  animation: pulse-border 2s ease infinite;
}
.confirm-btn.ready-red {
  border-color: var(--red) !important;
  color: var(--red) !important;
  -webkit-text-fill-color: var(--red);
  animation: pulse-border-red 2s ease infinite;
}
.confirm-btn.pressing {
  border-color: var(--green) !important;
  color: white !important;
  -webkit-text-fill-color: white;
}
.confirm-btn.pressing-red {
  border-color: var(--red) !important;
  color: white !important;
  -webkit-text-fill-color: white;
}
.confirm-btn.disabled { opacity: 0.4; cursor: not-allowed; }
.confirm-btn .progress-bar {
  position: absolute;
  bottom: 0; left: 0;
  height: 4px;
  background: var(--green) !important;
  width: 0%;
  transition: width linear;
}
.confirm-btn .progress-bar-red {
  position: absolute;
  bottom: 0; left: 0;
  height: 4px;
  background: var(--red) !important;
  width: 0%;
  transition: width linear;
}
.confirm-hint {
  text-align: center;
  font-size: 11px;
  color: var(--muted) !important;
  margin-top: 6px;
  -webkit-text-fill-color: var(--muted);
}
@keyframes pulse-border {
  0%, 100% { box-shadow: 0 0 0 0 rgba(46,204,113,0.4); }
  50% { box-shadow: 0 0 0 8px rgba(46,204,113,0); }
}
@keyframes pulse-border-red {
  0%, 100% { box-shadow: 0 0 0 0 rgba(231,76,60,0.4); }
  50% { box-shadow: 0 0 0 8px rgba(231,76,60,0); }
}

/* ===== FIFO BADGE ===== */
.fifo-badge {
  background: rgba(52,152,219,0.2) !important;
  border: 1px solid var(--blue) !important;
  color: var(--blue) !important;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 700;
  -webkit-text-fill-color: var(--blue);
}

/* ===== HOLD WARNING (å‡ºåº«ã‚¿ãƒ–) ===== */
.hold-warning {
  display: none;
  background: rgba(231,76,60,0.12) !important;
  border: 2px solid var(--red) !important;
  border-radius: 10px;
  padding: 12px 14px;
  margin-bottom: 12px;
  animation: flash-border 1.5s ease infinite;
}
.hold-warning.visible { display: block; }
.hold-warning-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--red) !important;
  -webkit-text-fill-color: var(--red);
  letter-spacing: 1px;
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.hold-warning-reason {
  font-size: 13px;
  color: var(--text) !important;
  -webkit-text-fill-color: var(--text);
  background: rgba(255,255,255,0.04) !important;
  border-radius: 6px;
  padding: 8px 10px;
  line-height: 1.5;
  word-break: break-all;
}
.hold-warning-meta {
  font-size: 11px;
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
  margin-top: 6px;
}
@keyframes flash-border {
  0%, 100% { border-color: var(--red) !important; }
  50% { border-color: rgba(231,76,60,0.3) !important; }
}

/* ===== REASON INPUT ===== */
.reason-wrap {
  background: var(--card) !important;
  border: 1px solid var(--border) !important;
  border-radius: 10px;
  padding: 12px 14px;
  margin-bottom: 12px;
  display: none;
}
.reason-wrap.visible { display: block; }
.reason-label {
  font-size: 10px;
  font-weight: 700;
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
  letter-spacing: 2px;
  margin-bottom: 8px;
}
textarea.reason-input {
  width: 100%;
  background: var(--surface) !important;
  border: 2px solid var(--border) !important;
  border-radius: 8px;
  color: var(--text) !important;
  -webkit-text-fill-color: var(--text);
  font-size: 14px;
  padding: 10px 12px;
  outline: none;
  resize: none;
  height: 80px;
  transition: border-color 0.2s;
  line-height: 1.5;
}
textarea.reason-input:focus { border-color: var(--red) !important; }
textarea.reason-input::placeholder { color: var(--muted) !important; -webkit-text-fill-color: var(--muted); }

/* ===== HOLD LIST ===== */
.hold-divider {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 16px 0 12px;
}
.hold-divider-line { flex: 1; height: 1px; background: var(--border) !important; }
.hold-divider-label {
  font-size: 10px;
  font-weight: 700;
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
  letter-spacing: 2px;
  white-space: nowrap;
}

.hold-list-item {
  background: var(--card) !important;
  border: 1px solid rgba(231,76,60,0.3) !important;
  border-left: 4px solid var(--red) !important;
  border-radius: 10px;
  padding: 12px 14px;
  margin-bottom: 8px;
  display: flex;
  align-items: flex-start;
  gap: 12px;
}
.hold-list-item-info { flex: 1; min-width: 0; }
.hold-list-item-id {
  font-size: 20px;
  font-weight: 700;
  color: var(--red) !important;
  -webkit-text-fill-color: var(--red);
  font-family: 'Rajdhani', sans-serif;
  letter-spacing: 1px;
}
.hold-list-item-reason {
  font-size: 12px;
  color: var(--text) !important;
  -webkit-text-fill-color: var(--text);
  margin-top: 4px;
  word-break: break-all;
  line-height: 1.4;
}
.hold-list-item-date {
  font-size: 11px;
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
  margin-top: 4px;
}
.release-btn {
  background: rgba(46,204,113,0.15) !important;
  border: 1px solid var(--green) !important;
  color: var(--green) !important;
  -webkit-text-fill-color: var(--green);
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 12px;
  font-weight: 700;
  cursor: pointer;
  white-space: nowrap;
  flex-shrink: 0;
  letter-spacing: 0.5px;
}

/* ===== TOAST ===== */
.toast {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(-20px);
  background: var(--green) !important;
  color: white !important;
  font-weight: 700;
  font-size: 14px;
  padding: 12px 24px;
  border-radius: 30px;
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s;
  z-index: 1000;
  white-space: nowrap;
  letter-spacing: 1px;
  -webkit-text-fill-color: white;
}
.toast.error { background: var(--red) !important; }
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ===== MASTER ===== */
.master-card {
  background: var(--card) !important;
  border: 1px solid var(--border) !important;
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 12px;
}
.master-title {
  font-size: 13px;
  font-weight: 700;
  color: var(--muted) !important;
  letter-spacing: 2px;
  margin-bottom: 10px;
  -webkit-text-fill-color: var(--muted);
}
.input-row { display: flex; gap: 8px; margin-bottom: 10px; }
input[type=text] {
  flex: 1;
  background: var(--surface) !important;
  border: 2px solid var(--border) !important;
  border-radius: 8px;
  color: var(--text) !important;
  font-size: 14px;
  padding: 10px 12px;
  outline: none;
  transition: border-color 0.2s;
  user-select: auto;
  -webkit-user-select: auto;
  -webkit-text-fill-color: var(--text);
}
input[type=text]:focus { border-color: var(--accent) !important; }
input[type=text]::placeholder { color: var(--muted) !important; -webkit-text-fill-color: var(--muted); }
.add-btn {
  background: var(--accent) !important;
  color: var(--bg) !important;
  border: none;
  border-radius: 8px;
  font-weight: 700;
  font-size: 13px;
  padding: 10px 16px;
  cursor: pointer;
  white-space: nowrap;
  -webkit-text-fill-color: var(--bg);
}
.list-chips { display: flex; flex-wrap: wrap; gap: 6px; }
.list-chip {
  background: var(--surface) !important;
  border: 1px solid var(--border) !important;
  border-radius: 6px;
  padding: 6px 10px;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
  color: var(--text) !important;
  -webkit-text-fill-color: var(--text);
}
.del-btn {
  background: none;
  border: none;
  color: var(--muted) !important;
  cursor: pointer;
  font-size: 14px;
  line-height: 1;
  padding: 0;
  -webkit-text-fill-color: var(--muted);
}

/* ===== STOCK TABLE ===== */
.stock-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.stock-table th {
  background: var(--surface) !important;
  color: var(--muted) !important;
  padding: 8px 10px;
  text-align: left;
  font-size: 10px;
  letter-spacing: 1px;
  border-bottom: 1px solid var(--border) !important;
  -webkit-text-fill-color: var(--muted);
}
.stock-table td {
  padding: 8px 10px;
  border-bottom: 1px solid var(--border) !important;
  vertical-align: middle;
  color: var(--text) !important;
  -webkit-text-fill-color: var(--text);
}
.stock-table td.muted { font-size: 11px; color: var(--muted) !important; -webkit-text-fill-color: var(--muted); }
.del-row-btn {
  background: rgba(231,76,60,0.15) !important;
  border: 1px solid var(--red) !important;
  color: var(--red) !important;
  border-radius: 5px;
  padding: 3px 8px;
  font-size: 11px;
  cursor: pointer;
  -webkit-text-fill-color: var(--red);
}
.scroll-list { max-height: 260px; overflow-y: auto; }

/* ===== EMPTY ===== */
.empty { text-align: center; color: var(--muted) !important; font-size: 13px; padding: 20px; -webkit-text-fill-color: var(--muted); }

/* ===== HISTORY ===== */
.history-item {
  background: var(--card) !important;
  border: 1px solid var(--border) !important;
  border-radius: 10px;
  padding: 12px 14px;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.history-icon { font-size: 20px; flex-shrink: 0; }
.history-info { flex: 1; min-width: 0; }
.history-product {
  font-size: 18px;
  font-weight: 700;
  color: var(--text) !important;
  font-family: 'Rajdhani', sans-serif;
  -webkit-text-fill-color: var(--text);
}
.history-shelf {
  font-size: 12px;
  color: var(--green) !important;
  font-weight: 700;
  -webkit-text-fill-color: var(--green);
  margin-top: 2px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.history-date {
  font-size: 11px;
  color: var(--muted) !important;
  text-align: right;
  flex-shrink: 0;
  line-height: 1.5;
  -webkit-text-fill-color: var(--muted);
}

/* ===== SCROLL AREA ===== */
.scroll-area {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  padding-bottom: 8px;
}
.steps { flex-shrink: 0; }
.selected-display { flex-shrink: 0; }
.confirm-wrap { flex-shrink: 0; padding: 8px 0 10px; }

/* ===== QR HINT ===== */
.qr-hint {
  font-size: 11px;
  color: var(--muted) !important;
  background: rgba(52,152,219,0.08) !important;
  border: 1px solid rgba(52,152,219,0.3) !important;
  border-radius: 8px;
  padding: 8px 12px;
  margin-bottom: 10px;
  -webkit-text-fill-color: var(--muted);
}

/* ===== SCAN INPUT (hidden) ===== */
#scanInput {
  position: absolute; left: -9999px; top: -9999px;
  width: 1px; height: 1px; opacity: 0; pointer-events: none;
}
</style>

</head>
<body>

<!-- scanInputï¼šiOSå¯¾ç­–ã®ãŸã‚ readonlyã‚’ä»˜ã‘ãªã„ -->
<input id="scanInput" type="text"
  inputmode="none"
  autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false"
  aria-hidden="true" />

<div class="header">
  <span style="font-size:22px">ğŸ­</span>
  <span class="header-title">RACK WMS</span>
  <div class="header-sub">
    <div id="clock"></div>
    <div id="firebaseStatus" style="color:var(--muted)">Firebase: æ¥ç¶šä¸­...</div>
  </div>
</div>

<div class="tabs">
  <div class="tab active" id="tab-in" onclick="switchTab('in',this)">
    <span class="tab-icon">ğŸ“¦</span>å…¥åº«
  </div>
  <div class="tab" id="tab-out" onclick="switchTab('out',this)">
    <span class="tab-icon">ğŸš›</span>å‡ºåº«
  </div>
  <div class="tab" id="tab-history" onclick="switchTab('history',this)">
    <span class="tab-icon">ğŸ“‹</span>å±¥æ­´
  </div>
  <div class="tab tab-hold" id="tab-hold" onclick="switchTab('hold',this)">
    <span class="tab-icon">ğŸš«</span>åœæ­¢
  </div>
  <div class="tab" id="tab-master" onclick="switchTab('master',this)">
    <span class="tab-icon">âš™ï¸</span>ãƒã‚¹ã‚¿ãƒ¼
  </div>
</div>

<div class="main">

  <!-- ===== å…¥åº« ===== -->
  <div class="section active" id="sec-in">
    <div class="steps">
      <div class="step active" id="in-step1">â‘  å“ç•ª</div>
      <div class="step-arrow">â–¶</div>
      <div class="step" id="in-step2">â‘¡ æ£šç•ª</div>
      <div class="step-arrow">â–¶</div>
      <div class="step" id="in-step3">â‘¢ ç¢ºå®š</div>
    </div>

    <div class="selected-display">
      <div>
        <div class="sel-label">å“ç•ª</div>
        <div class="sel-value" id="in-sel-item">â€”</div>
      </div>
      <div>
        <div class="sel-label">æ£šç•ª</div>
        <div class="sel-value" id="in-sel-shelf">â€”</div>
      </div>
    </div>

    <div class="scroll-area" id="sec-in-scroll">
      <div class="sec-label">å“ç•ª â€” é ­æ–‡å­—ã§çµã‚Šè¾¼ã¿</div>
      <div class="initial-grid" id="in-initial-grid"></div>

      <div class="item-panel" id="in-item-panel">
        <div class="item-panel-header">
          <div class="item-panel-label" id="in-panel-label">å“ç•ªé¸æŠ</div>
          <button class="back-btn" onclick="clearInInitial()">â—€ æˆ»ã‚‹</button>
        </div>
        <div class="btn-grid" id="in-items-grid"></div>
      </div>

      <div class="sec-label">æ£šç•ª <span style="font-size:10px;color:var(--blue);-webkit-text-fill-color:var(--blue)">QRã‚¹ã‚­ãƒ£ãƒ³å¯</span></div>
      <div class="qr-hint">ğŸ“· æ£šç•ªQRã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã¨è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™</div>
      <div class="initial-grid" id="in-shelf-prefix-grid"></div>

      <div class="item-panel" id="in-shelf-panel">
        <div class="item-panel-header">
          <div class="item-panel-label" id="in-shelf-panel-label">æ£šç•ªé¸æŠ</div>
          <button class="back-btn" onclick="clearInShelfPrefix()">â—€ æˆ»ã‚‹</button>
        </div>
        <div class="btn-grid" id="in-shelves-grid"></div>
      </div>
    </div>

    <div class="confirm-wrap">
      <button class="confirm-btn disabled" id="in-confirm"
        ontouchstart="startHold('in',event)" ontouchend="endHold('in')"
        onmousedown="startHold('in',event)" onmouseup="endHold('in')" onmouseleave="endHold('in')">
        <span>ğŸ”’ é•·æŠ¼ã—ã§ç¢ºå®š</span>
        <div class="progress-bar" id="in-progress"></div>
      </button>
      <div class="confirm-hint">1ç§’é–“æŠ¼ã—ç¶šã‘ã¦ãã ã•ã„</div>
    </div>
  </div>

  <!-- ===== å‡ºåº« ===== -->
  <div class="section" id="sec-out">
    <div class="steps">
      <div class="step active" id="out-step1">â‘  å“ç•ª</div>
      <div class="step-arrow">â–¶</div>
      <div class="step" id="out-step2">â‘¡ æ£šç•ª</div>
      <div class="step-arrow">â–¶</div>
      <div class="step" id="out-step3">â‘¢ ç¢ºå®š</div>
    </div>

    <div class="selected-display">
      <div>
        <div class="sel-label">å“ç•ª</div>
        <div class="sel-value" id="out-sel-item">â€”</div>
      </div>
      <div>
        <div class="sel-label">æ£šç•ª</div>
        <div class="sel-value" id="out-sel-shelf">â€”</div>
      </div>
    </div>

    <div class="scroll-area" id="sec-out-scroll">
      <div class="sec-label">å“ç•ª â€” é ­æ–‡å­—ã§çµã‚Šè¾¼ã¿</div>
      <div class="initial-grid" id="out-initial-grid"></div>

      <div class="item-panel" id="out-item-panel">
        <div class="item-panel-header">
          <div class="item-panel-label" id="out-panel-label">å“ç•ªé¸æŠ</div>
          <button class="back-btn" onclick="clearOutInitial()">â—€ æˆ»ã‚‹</button>
        </div>
        <div class="btn-grid" id="out-items-grid"></div>
      </div>

      <!-- å‡ºè·åœæ­¢è­¦å‘Š -->
      <div class="hold-warning" id="out-hold-warning">
        <div class="hold-warning-title">ğŸš« å‡ºè·åœæ­¢ä¸­ â€” å‡ºåº«ã§ãã¾ã›ã‚“</div>
        <div class="hold-warning-reason" id="out-hold-reason-text"></div>
        <div class="hold-warning-meta" id="out-hold-reason-meta"></div>
      </div>

      <div class="sec-label" id="out-shelf-label" style="display:none">
        å€™è£œæ£šï¼ˆå…ˆå…¥å…ˆå‡ºã—é †ï¼‰<span class="fifo-badge">FIFO</span>
      </div>
      <div class="btn-grid" id="out-shelves-grid"></div>
    </div>

    <div class="confirm-wrap">
      <button class="confirm-btn disabled" id="out-confirm"
        ontouchstart="startHold('out',event)" ontouchend="endHold('out')"
        onmousedown="startHold('out',event)" onmouseup="endHold('out')" onmouseleave="endHold('out')">
        <span>ğŸ”’ é•·æŠ¼ã—ã§ç¢ºå®š</span>
        <div class="progress-bar" id="out-progress"></div>
      </button>
      <div class="confirm-hint">1ç§’é–“æŠ¼ã—ç¶šã‘ã¦ãã ã•ã„</div>
    </div>
  </div>

  <!-- ===== å±¥æ­´ ===== -->
  <div class="section" id="sec-history">
    <div class="scroll-area" id="history-list"><div class="empty">èª­ã¿è¾¼ã¿ä¸­...</div></div>
  </div>

  <!-- ===== å‡ºè·åœæ­¢ ===== -->
  <div class="section" id="sec-hold">
    <div class="steps">
      <div class="step step-red active" id="hold-step1">â‘  å“ç•ª</div>
      <div class="step-arrow">â–¶</div>
      <div class="step step-red" id="hold-step2">â‘¡ ç†ç”±</div>
      <div class="step-arrow">â–¶</div>
      <div class="step step-red" id="hold-step3">â‘¢ åœæ­¢</div>
    </div>

    <div class="selected-display single-col">
      <div>
        <div class="sel-label">å¯¾è±¡å“ç•ª</div>
        <div class="sel-value red" id="hold-sel-item">â€”</div>
      </div>
    </div>

    <div class="scroll-area" id="sec-hold-scroll">
      <div class="sec-label">å“ç•ª â€” é ­æ–‡å­—ã§çµã‚Šè¾¼ã¿</div>
      <div class="initial-grid" id="hold-initial-grid"></div>

      <div class="item-panel" id="hold-item-panel">
        <div class="item-panel-header">
          <div class="item-panel-label" id="hold-panel-label">å“ç•ªé¸æŠ</div>
          <button class="back-btn" onclick="clearHoldInitial()">â—€ æˆ»ã‚‹</button>
        </div>
        <div class="btn-grid" id="hold-items-grid"></div>
      </div>

      <!-- ç†ç”±å…¥åŠ› -->
      <div class="reason-wrap" id="hold-reason-wrap">
        <div class="reason-label">åœæ­¢ç†ç”±ã‚’å…¥åŠ›</div>
        <textarea class="reason-input" id="hold-reason-input"
          placeholder="ä¾‹ï¼šå¤–è¦³ä¸å…·åˆã€€é¡§å®¢ã‚¯ãƒ¬ãƒ¼ãƒ å¯¾å¿œä¸­ã€€å“è³ªç¢ºèªä¸­â€¦"></textarea>
      </div>

      <!-- åœæ­¢ä¸­ãƒªã‚¹ãƒˆ -->
      <div class="hold-divider">
        <div class="hold-divider-line"></div>
        <div class="hold-divider-label">ğŸš« ç¾åœ¨ã®å‡ºè·åœæ­¢ãƒªã‚¹ãƒˆ</div>
        <div class="hold-divider-line"></div>
      </div>
      <div id="hold-list-area"><div class="empty">å‡ºè·åœæ­¢ä¸­ã®å“ç•ªã¯ã‚ã‚Šã¾ã›ã‚“</div></div>
    </div>

    <div class="confirm-wrap">
      <button class="confirm-btn disabled" id="hold-confirm"
        ontouchstart="startHold('hold',event)" ontouchend="endHold('hold')"
        onmousedown="startHold('hold',event)" onmouseup="endHold('hold')" onmouseleave="endHold('hold')">
        <span>ğŸš« é•·æŠ¼ã—ã§å‡ºè·åœæ­¢</span>
        <div class="progress-bar-red" id="hold-progress"></div>
      </button>
      <div class="confirm-hint">1ç§’é–“æŠ¼ã—ç¶šã‘ã¦ãã ã•ã„</div>
    </div>
  </div>

  <!-- ===== ãƒã‚¹ã‚¿ãƒ¼ ===== -->
  <div class="section" id="sec-master">
    <div class="scroll-area">
      <div class="master-card">
        <div class="master-title">ğŸ“‹ å“ç•ªãƒã‚¹ã‚¿ãƒ¼</div>
        <div class="input-row">
          <input type="text" id="new-item" placeholder="å“ç•ªã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šSK012ï¼‰" autocapitalize="characters">
          <button class="add-btn" onclick="addItem()">è¿½åŠ </button>
        </div>
        <div class="list-chips" id="item-list"></div>
      </div>

      <div class="master-card">
        <div class="master-title">ğŸ—„ï¸ æ£šç•ªãƒã‚¹ã‚¿ãƒ¼</div>
        <div class="qr-hint">ğŸ“· æ£šç•ªQRã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã¨è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™</div>
        <div class="input-row">
          <input type="text" id="new-shelf" placeholder="æ£šç•ªã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šA-01ï¼‰">
          <button class="add-btn" onclick="addShelf()">è¿½åŠ </button>
        </div>
        <div class="list-chips" id="shelf-list"></div>
      </div>

      <div class="master-card">
        <div class="master-title">ğŸ“Š åœ¨åº«ãƒ‡ãƒ¼ã‚¿ä¸€è¦§</div>
        <div class="scroll-list">
          <table class="stock-table">
            <thead>
              <tr><th>æ£šç•ª</th><th>å“ç•ª</th><th>å…¥åº«æ—¥æ™‚</th><th></th></tr>
            </thead>
            <tbody id="stock-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</div><!-- /main -->

<div class="toast" id="toast"></div>

<script>
/* ===================== çŠ¶æ…‹ ===================== */
let inState   = { initial: null, item: null, shelfPrefix: null, shelf: null };
let outState  = { initial: null, item: null, shelfPrefix: null, shelf: null };
let holdState = { initial: null, item: null };
let holdTimer = null;
let currentTab = 'in';

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥
let cachedItems   = [];
let cachedShelves = [];
let cachedStock   = [];
let cachedHolds   = []; // {itemId, reason, stoppedAt, stoppedAtMs}

/* ===================== iOS/QRå…¥åŠ›å¯¾ç­–ï¼šscanInputãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç¶­æŒ ===================== */
function focusScanInput(){
  const el = document.getElementById('scanInput');
  if(!el) return;
  try { el.focus({ preventScroll:true }); } catch(e){ try{ el.focus(); }catch(_){ } }
}
// åˆæœŸï¼ˆåŠ¹ãç’°å¢ƒã®ã¿ï¼‰
setTimeout(focusScanInput, 200);
// ç”»é¢ã‚¿ãƒƒãƒ—ã§å¾©å¸°ï¼ˆtextareaç­‰ã®å…¥åŠ›ä¸­ã¯é‚ªé­”ã—ãªã„ï¼‰
document.addEventListener('touchstart', () => {
  const a = document.activeElement;
  if(a && (a.tagName === 'TEXTAREA' || (a.tagName === 'INPUT' && a.id !== 'scanInput'))) return;
  focusScanInput();
}, { passive:true });

/* ===================== QR ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ãƒãƒƒãƒ•ã‚¡ï¼‰ ===================== */
let qrBuffer = '';
let qrTimer = null;
const IDLE_MS = 150;

document.addEventListener('keydown', e => {
  const active = document.activeElement;
  const isInput = active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA');
  // master/holdã®å…¥åŠ›ä¸­ã¯é‚ªé­”ã—ãªã„ï¼ˆscanInputä»¥å¤–ï¼‰
  if(isInput && active.id !== 'scanInput') return;

  if(e.key === 'Enter' || e.key === 'Tab'){ flushQRBuffer(); return; }
  if(e.key && e.key.length === 1){
    qrBuffer += e.key;
    clearTimeout(qrTimer);
    qrTimer = setTimeout(flushQRBuffer, IDLE_MS);
  }
});

function flushQRBuffer(){
  clearTimeout(qrTimer);
  const raw = (qrBuffer || '').trim();
  qrBuffer = '';
  if(!raw) return;
  processQR(raw);
}

function processQR(raw){
  if(currentTab === 'in'){
    selectInShelf(raw);
    showToast(`æ£šç•ª QR: ${raw}`, '');
  } else if(currentTab === 'master'){
    const el = document.getElementById('new-shelf');
    if(el) el.value = raw;
    showToast(`æ£šç•ª QR: ${raw}`, '');
  }
}

/* ===================== æ™‚è¨ˆ ===================== */
function updateClock(){
  const n = new Date();
  const clock = document.getElementById('clock');
  if(!clock) return;
  clock.textContent =
    n.toLocaleDateString('ja-JP') + ' ' +
    n.toLocaleTimeString('ja-JP', { hour:'2-digit', minute:'2-digit' });
}
setInterval(updateClock, 1000);
updateClock();

/* ===================== ã‚¿ãƒ– ===================== */
function switchTab(tab, el){
  currentTab = tab;
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('sec-' + tab).classList.add('active');
  el.classList.add('active');

  if(tab === 'in')      { loadCache().then(renderIn); }
  if(tab === 'out')     { loadCache().then(renderOut); }
  if(tab === 'history') { renderHistory(); }
  if(tab === 'hold')    { loadCache().then(renderHold); }
  if(tab === 'master')  { loadCache().then(renderMaster); }

  // ã‚¿ãƒ–åˆ‡æ›¿ã§ã‚‚scanå¾…æ©Ÿã«æˆ»ã™ï¼ˆé‚ªé­”ã—ãªã„ç¯„å›²ã§ï¼‰
  setTimeout(focusScanInput, 50);
}

/* ===================== ã‚­ãƒ£ãƒƒã‚·ãƒ¥èª­ã¿è¾¼ã¿ ===================== */
/* Firebase moduleå´ãŒ window.__xxx ã‚’ã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰å®Ÿä½“ãŒå‹•ãæƒ³å®š */
async function loadCache(){
  try{
    const [items, shelves, stock, holds] = await Promise.all([
      window.__getAllItemMasters  ? window.__getAllItemMasters()  : Promise.resolve([]),
      window.__getAllShelfMasters ? window.__getAllShelfMasters() : Promise.resolve([]),
      window.__getAllShelves      ? window.__getAllShelves()      : Promise.resolve([]),
      window.__getAllHolds        ? window.__getAllHolds()        : Promise.resolve([])
    ]);
    cachedItems   = (items || []).map(i => i.itemId).filter(Boolean).sort();
    cachedShelves = (shelves || []).map(s => s.shelfId).filter(Boolean).sort();
    cachedStock   = (stock || []).filter(s => s && s.status === 'occupied');
    cachedHolds   = (holds || []);
  }catch(e){ console.error(e); }
}

/* ===================== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===================== */
function escHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}
function escJsSingle(s){
  return String(s ?? "")
    .replace(/\\/g, "\\\\")
    .replace(/'/g, "\\'")
    .replace(/\n/g, "\\n")
    .replace(/\r/g, "");
}
function formatTime(ts){
  const d = ts ? new Date(ts) : null;
  if(!d) return '-';
  const pad = n => String(n).padStart(2,'0');
  return `${d.getMonth()+1}/${d.getDate()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function scrollToEl(targetId, areaId){
  setTimeout(()=>{
    const target = document.getElementById(targetId);
    const area   = document.getElementById(areaId);
    if(!target || !area) return;
    const areaTop   = area.getBoundingClientRect().top;
    const targetTop = target.getBoundingClientRect().top;
    area.scrollTop += (targetTop - areaTop) - 8;
  }, 50);
}
function getShelfPrefix(shelfId){
  const m = String(shelfId).match(/^(.+?)-/);
  return m ? m[1] : String(shelfId).charAt(0);
}
function getShelfPrefixes(shelves){
  const map = {};
  for(const s of shelves){ const p = getShelfPrefix(s); map[p] = (map[p]||0) + 1; }
  return Object.entries(map).sort((a,b) => a[0].localeCompare(b[0]));
}
function getInitials(items){
  const map = {};
  for(const item of items){ const ch = String(item).charAt(0).toUpperCase(); map[ch] = (map[ch]||0) + 1; }
  return Object.entries(map).sort((a,b) => a[0].localeCompare(b[0]));
}
function isOnHold(itemId){
  return cachedHolds.find(h => h.itemId === itemId) || null;
}

/* ===================== STEP æ›´æ–° ===================== */
function updateInSteps(){
  const s = inState;
  document.getElementById('in-step1').className = 'step ' + (s.item ? 'done' : 'active');
  document.getElementById('in-step2').className = 'step ' + (!s.item ? '' : s.shelf ? 'done' : 'active');
  document.getElementById('in-step3').className = 'step ' + (s.item && s.shelf ? 'active' : '');
  const btn = document.getElementById('in-confirm');
  if(s.item && s.shelf){ btn.classList.remove('disabled'); btn.classList.add('ready'); }
  else { btn.classList.add('disabled'); btn.classList.remove('ready'); }
}
function updateOutSteps(){
  const s = outState;
  const hold = s.item ? isOnHold(s.item) : null;
  document.getElementById('out-step1').className = 'step ' + (s.item ? 'done' : 'active');
  document.getElementById('out-step2').className = 'step ' + (!s.item ? '' : s.shelf ? 'done' : 'active');
  document.getElementById('out-step3').className = 'step ' + (s.item && s.shelf && !hold ? 'active' : '');
  const btn = document.getElementById('out-confirm');
  if(s.item && s.shelf && !hold){ btn.classList.remove('disabled'); btn.classList.add('ready'); }
  else { btn.classList.add('disabled'); btn.classList.remove('ready'); }
}
function updateHoldSteps(){
  const s = holdState;
  const hasReason = (document.getElementById('hold-reason-input')?.value.trim() || '').length > 0;
  document.getElementById('hold-step1').className = 'step step-red ' + (s.item ? 'done' : 'active');
  document.getElementById('hold-step2').className = 'step step-red ' + (!s.item ? '' : hasReason ? 'done' : 'active');
  document.getElementById('hold-step3').className = 'step step-red ' + (s.item && hasReason ? 'active' : '');
  const btn = document.getElementById('hold-confirm');
  if(s.item && hasReason){ btn.classList.remove('disabled'); btn.classList.add('ready-red'); }
  else { btn.classList.add('disabled'); btn.classList.remove('ready-red'); }
}

/* ===================== å…¥åº« RENDER ===================== */
function renderIn(){
  const ig = document.getElementById('in-initial-grid');
  const panel = document.getElementById('in-item-panel');

  if(!cachedItems.length){
    ig.innerHTML = '<div class="empty">å“ç•ªãŒæœªç™»éŒ²ã§ã™ï¼ˆãƒã‚¹ã‚¿ãƒ¼ã§è¿½åŠ ï¼‰</div>';
    panel.classList.remove('visible');
  } else {
    const initials = getInitials(cachedItems);
    ig.innerHTML = initials.map(([ch, cnt]) =>
      `<button class="initial-btn ${inState.initial===ch?'selected':''}" onclick="selectInInitial('${escJsSingle(ch)}')">
        ${escHtml(ch)}<span class="count">${cnt}ä»¶</span>
      </button>`
    ).join('');
    if(inState.initial){
      panel.classList.add('visible');
      document.getElementById('in-panel-label').textContent = `ã€Œ${inState.initial}ã€ã®å“ç•ª`;
      const filtered = cachedItems.filter(i => i.charAt(0).toUpperCase() === inState.initial);
      document.getElementById('in-items-grid').innerHTML = filtered.map(item =>
        `<button class="item-btn ${inState.item===item?'selected':''}" onclick="selectInItem('${escJsSingle(item)}')">${escHtml(item)}</button>`
      ).join('');
    } else {
      panel.classList.remove('visible');
    }
  }

  const spg = document.getElementById('in-shelf-prefix-grid');
  const shelfPanel = document.getElementById('in-shelf-panel');
  const sg = document.getElementById('in-shelves-grid');

  if(!cachedShelves.length){
    spg.innerHTML = '<div class="empty">æ£šç•ªãŒæœªç™»éŒ²ã§ã™ï¼ˆãƒã‚¹ã‚¿ãƒ¼ã§è¿½åŠ ï¼‰</div>';
    shelfPanel.classList.remove('visible');
  } else {
    const prefixes = getShelfPrefixes(cachedShelves);
    spg.innerHTML = prefixes.map(([p, cnt]) =>
      `<button class="initial-btn ${inState.shelfPrefix===p?'selected':''}" onclick="selectInShelfPrefix('${escJsSingle(p)}')">
        ${escHtml(p)}<span class="count">${cnt}æ£š</span>
      </button>`
    ).join('');
    if(inState.shelfPrefix){
      shelfPanel.classList.add('visible');
      document.getElementById('in-shelf-panel-label').textContent = `ã€Œ${inState.shelfPrefix}-ã€ã®æ£šç•ª`;
      const filtered = cachedShelves.filter(s => getShelfPrefix(s) === inState.shelfPrefix);
      sg.innerHTML = filtered.map(shelf =>
        `<button class="item-btn ${inState.shelf===shelf?'selected':''}" onclick="selectInShelf('${escJsSingle(shelf)}')">${escHtml(shelf)}</button>`
      ).join('');
    } else {
      shelfPanel.classList.remove('visible');
      sg.innerHTML = '';
    }
  }

  document.getElementById('in-sel-item').textContent  = inState.item  || 'â€”';
  document.getElementById('in-sel-shelf').textContent = inState.shelf || 'â€”';
  updateInSteps();
}
function selectInInitial(ch){
  inState.initial = ch;
  if(inState.item && inState.item.charAt(0).toUpperCase() !== ch) inState.item = null;
  renderIn();
  scrollToEl('in-item-panel', 'sec-in-scroll');
}
function clearInInitial(){ inState.initial = null; inState.item = null; renderIn(); }
function selectInItem(item){
  inState.item = item;
  renderIn();
  scrollToEl('in-shelf-prefix-grid', 'sec-in-scroll');
}
function selectInShelfPrefix(p){
  inState.shelfPrefix = p;
  if(inState.shelf && getShelfPrefix(inState.shelf) !== p) inState.shelf = null;
  renderIn();
  scrollToEl('in-shelf-panel', 'sec-in-scroll');
}
function clearInShelfPrefix(){ inState.shelfPrefix = null; inState.shelf = null; renderIn(); }
function selectInShelf(shelf){
  inState.shelf = shelf;
  document.querySelectorAll('#in-shelves-grid .item-btn').forEach(b => {
    b.classList.toggle('selected', b.textContent.trim() === shelf);
  });
  document.getElementById('in-sel-shelf').textContent = shelf;
  updateInSteps();
}

/* ===================== å‡ºåº« RENDER ===================== */
function renderOut(){
  const ig = document.getElementById('out-initial-grid');
  const panel = document.getElementById('out-item-panel');

  if(!cachedItems.length){
    ig.innerHTML = '<div class="empty">å“ç•ªãŒæœªç™»éŒ²ã§ã™ï¼ˆãƒã‚¹ã‚¿ãƒ¼ã§è¿½åŠ ï¼‰</div>';
    panel.classList.remove('visible');
  } else {
    const initials = getInitials(cachedItems);
    ig.innerHTML = initials.map(([ch, cnt]) =>
      `<button class="initial-btn ${outState.initial===ch?'selected':''}" onclick="selectOutInitial('${escJsSingle(ch)}')">
        ${escHtml(ch)}<span class="count">${cnt}ä»¶</span>
      </button>`
    ).join('');

    if(outState.initial){
      panel.classList.add('visible');
      document.getElementById('out-panel-label').textContent = `ã€Œ${outState.initial}ã€ã®å“ç•ª`;
      const filtered = cachedItems.filter(i => i.charAt(0).toUpperCase() === outState.initial);
      document.getElementById('out-items-grid').innerHTML = filtered.map(item => {
        const hold = isOnHold(item);
        return `<button class="item-btn ${outState.item===item?'selected':''} ${hold?'hold-badge':''}"
          onclick="selectOutItem('${escJsSingle(item)}')">${escHtml(item)}</button>`;
      }).join('');
    } else {
      panel.classList.remove('visible');
    }
  }

  // å‡ºè·åœæ­¢ãƒã‚§ãƒƒã‚¯
  const warning = document.getElementById('out-hold-warning');
  const hold = outState.item ? isOnHold(outState.item) : null;
  if(hold){
    warning.classList.add('visible');
    document.getElementById('out-hold-reason-text').textContent = `ç†ç”±ï¼š${hold.reason || 'ï¼ˆç†ç”±æœªè¨˜å…¥ï¼‰'}`;
    document.getElementById('out-hold-reason-meta').textContent = `åœæ­¢ç™»éŒ²ï¼š${formatTime(hold.stoppedAtMs)}`;
  } else {
    warning.classList.remove('visible');
  }

  const sgrid = document.getElementById('out-shelves-grid');
  const label = document.getElementById('out-shelf-label');

  if(outState.item && !hold){
    label.style.display = 'flex';
    const candidates = cachedStock
      .filter(s => s.productId === outState.item)
      .sort((a,b) => (a.inboundAtMs||0) - (b.inboundAtMs||0));
    if(!candidates.length){
      sgrid.innerHTML = '<div class="empty">ã“ã®å“ç•ªã®åœ¨åº«ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    } else {
      sgrid.innerHTML = candidates.map((c, i) =>
        `<button class="item-btn shelf-recommend ${outState.shelf===c.shelfId?'selected':''}"
          data-rank="${i+1}"
          onclick="selectOutShelf('${escJsSingle(c.shelfId)}')">
          ${escHtml(c.shelfId)}<span class="item-btn-sub">${escHtml(formatTime(c.inboundAt))}</span>
        </button>`
      ).join('');
    }
  } else {
    label.style.display = 'none';
    sgrid.innerHTML = '';
  }

  document.getElementById('out-sel-item').textContent  = outState.item  || 'â€”';
  document.getElementById('out-sel-shelf').textContent = outState.shelf || 'â€”';
  updateOutSteps();
}
function selectOutInitial(ch){
  outState.initial = ch;
  if(outState.item && outState.item.charAt(0).toUpperCase() !== ch){
    outState.item = null;
    outState.shelf = null;
  }
  renderOut();
}
function clearOutInitial(){ outState.initial = null; outState.item = null; outState.shelf = null; renderOut(); }
function selectOutItem(item){
  outState.item = item;
  outState.shelf = null;
  renderOut();
  const hold = isOnHold(item);
  if(hold) scrollToEl('out-hold-warning', 'sec-out-scroll');
  else scrollToEl('out-shelf-label', 'sec-out-scroll');
}
function selectOutShelf(shelf){ outState.shelf = shelf; renderOut(); }

/* ===================== å‡ºè·åœæ­¢ RENDER ===================== */
function renderHold(){
  const ig = document.getElementById('hold-initial-grid');
  const panel = document.getElementById('hold-item-panel');
  const reasonWrap = document.getElementById('hold-reason-wrap');

  if(!cachedItems.length){
    ig.innerHTML = '<div class="empty">å“ç•ªãŒæœªç™»éŒ²ã§ã™ï¼ˆãƒã‚¹ã‚¿ãƒ¼ã§è¿½åŠ ï¼‰</div>';
    panel.classList.remove('visible');
  } else {
    const initials = getInitials(cachedItems);
    ig.innerHTML = initials.map(([ch, cnt]) =>
      `<button class="initial-btn ${holdState.initial===ch?'selected-red':''}" onclick="selectHoldInitial('${escJsSingle(ch)}')">
        ${escHtml(ch)}<span class="count">${cnt}ä»¶</span>
      </button>`
    ).join('');

    if(holdState.initial){
      panel.classList.add('visible');
      document.getElementById('hold-panel-label').textContent = `ã€Œ${holdState.initial}ã€ã®å“ç•ª`;
      const filtered = cachedItems.filter(i => i.charAt(0).toUpperCase() === holdState.initial);
      document.getElementById('hold-items-grid').innerHTML = filtered.map(item => {
        const hold = isOnHold(item);
        return `<button class="item-btn ${holdState.item===item?'selected-red':''} ${hold?'hold-badge':''}"
          onclick="selectHoldItem('${escJsSingle(item)}')">${escHtml(item)}</button>`;
      }).join('');
    } else {
      panel.classList.remove('visible');
    }
  }

  document.getElementById('hold-sel-item').textContent = holdState.item || 'â€”';

  if(holdState.item) reasonWrap.classList.add('visible');
  else reasonWrap.classList.remove('visible');

  renderHoldList();
  updateHoldSteps();
}
function renderHoldList(){
  const area = document.getElementById('hold-list-area');
  if(!cachedHolds.length){
    area.innerHTML = '<div class="empty">å‡ºè·åœæ­¢ä¸­ã®å“ç•ªã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  const sorted = [...cachedHolds].sort((a,b) => (b.stoppedAtMs||0) - (a.stoppedAtMs||0));
  area.innerHTML = sorted.map(h =>
    `<div class="hold-list-item">
      <div class="hold-list-item-info">
        <div class="hold-list-item-id">${escHtml(h.itemId)}</div>
        <div class="hold-list-item-reason">ğŸ“ ${escHtml(h.reason || 'ç†ç”±æœªè¨˜å…¥')}</div>
        <div class="hold-list-item-date">ğŸ• ${escHtml(formatTime(h.stoppedAtMs))}</div>
      </div>
      <button class="release-btn" onclick="releaseHold('${escJsSingle(h.itemId)}')">âœ… è§£é™¤</button>
    </div>`
  ).join('');
}
function selectHoldInitial(ch){
  holdState.initial = ch;
  if(holdState.item && holdState.item.charAt(0).toUpperCase() !== ch) holdState.item = null;
  renderHold();
  scrollToEl('hold-item-panel', 'sec-hold-scroll');
}
function clearHoldInitial(){ holdState.initial = null; holdState.item = null; renderHold(); }
function selectHoldItem(item){
  holdState.item = item;
  renderHold();
  scrollToEl('hold-reason-wrap', 'sec-hold-scroll');
  setTimeout(() => document.getElementById('hold-reason-input')?.focus(), 100);
}
// ç†ç”±å…¥åŠ›ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  step æ›´æ–°
document.getElementById('hold-reason-input').addEventListener('input', updateHoldSteps);

/* ===================== é•·æŠ¼ã—ç¢ºå®š ===================== */
function startHold(mode, e){
  e.preventDefault();
  const btn = document.getElementById(mode + '-confirm');
  if(btn.classList.contains('disabled')) return;

  const prog = document.getElementById(mode + '-progress');
  btn.classList.add(mode === 'hold' ? 'pressing-red' : 'pressing');

  prog.style.transition = 'width 1000ms linear';
  prog.style.width = '100%';

  holdTimer = setTimeout(() => {
    endHold(mode);
    doConfirm(mode);
  }, 1000);
}
function endHold(mode){
  clearTimeout(holdTimer);
  const btn = document.getElementById(mode + '-confirm');
  const prog = document.getElementById(mode + '-progress');
  btn.classList.remove('pressing');
  btn.classList.remove('pressing-red');
  prog.style.transition = 'width 0.2s ease';
  prog.style.width = '0%';
}

/* ===================== ç¢ºå®šå‡¦ç† ===================== */
async function doConfirm(mode){
  // Firebaseæœªæ¥ç¶šã§ã‚‚è½ã¡ãªã„ã‚ˆã†ã‚¬ãƒ¼ãƒ‰
  if(!window.__saveShelfItem && (mode === 'in' || mode === 'out')){
    showToast('Firebaseæœªæ¥ç¶šï¼ˆä¿å­˜ã§ãã¾ã›ã‚“ï¼‰', 'error');
    return;
  }
  if(!window.__saveHold && mode === 'hold'){
    showToast('Firebaseæœªæ¥ç¶šï¼ˆä¿å­˜ã§ãã¾ã›ã‚“ï¼‰', 'error');
    return;
  }

  if(mode === 'in'){
    const { item, shelf } = inState;
    if(!item || !shelf) return;
    const now = new Date().toISOString();
    try{
      await window.__saveShelfItem(shelf, {
        shelfId: shelf, productId: item, productQRRaw: item,
        inboundAt: now, inboundAtMs: Date.now(),
        status: 'occupied', updatedAt: now
      });
      if(window.__addHistory){
        window.__addHistory({ type:'inbound', shelfId: shelf, productId: item, at: now, atMs: Date.now() }).catch(()=>{});
      }
      showToast(`âœ… å…¥åº«ï¼š${item} â†’ æ£š ${shelf}`);
      inState = { initial: null, item: null, shelfPrefix: null, shelf: null };
      await loadCache(); renderIn();
    }catch(e){ console.error(e); showToast('ä¿å­˜ã‚¨ãƒ©ãƒ¼', 'error'); }

  } else if(mode === 'out'){
    const { item, shelf } = outState;
    if(!item || !shelf) return;
    if(isOnHold(item)){ showToast('å‡ºè·åœæ­¢ä¸­ã®ãŸã‚å‡ºåº«ã§ãã¾ã›ã‚“', 'error'); return; }
    const now = new Date().toISOString();
    try{
      await window.__saveShelfItem(shelf, {
        shelfId: shelf, productId: null, productQRRaw: null,
        inboundAt: null, inboundAtMs: null,
        status: 'empty', updatedAt: now
      });
      if(window.__addHistory){
        window.__addHistory({ type:'empty', shelfId: shelf, productId: item, at: now, atMs: Date.now() }).catch(()=>{});
      }
      showToast(`âœ… å‡ºåº«ï¼šæ£š ${shelf} â†’ ${item}`);
      outState = { initial: null, item: null, shelfPrefix: null, shelf: null };
      await loadCache(); renderOut();
    }catch(e){ console.error(e); showToast('ä¿å­˜ã‚¨ãƒ©ãƒ¼', 'error'); }

  } else if(mode === 'hold'){
    const { item } = holdState;
    const reason = document.getElementById('hold-reason-input').value.trim();
    if(!item || !reason) return;
    if(isOnHold(item)){ showToast(`${item} ã¯æ—¢ã«åœæ­¢ä¸­ã§ã™`, 'error'); return; }
    const now = new Date().toISOString();
    try{
      await window.__saveHold(item, {
        itemId: item, reason,
        stoppedAt: now, stoppedAtMs: Date.now()
      });
      showToast(`ğŸš« ${item} ã‚’å‡ºè·åœæ­¢ã—ã¾ã—ãŸ`);
      holdState = { initial: null, item: null };
      document.getElementById('hold-reason-input').value = '';
      await loadCache(); renderHold();
      // å‡ºåº«ã‚¿ãƒ–è¡¨ç¤ºä¸­ãªã‚‰è¡¨ç¤ºæ›´æ–°ã—ãŸã„ãŒã€ä»Šã¯holdã‚¿ãƒ–ãªã®ã§å¿…è¦ãªã‚‰ã“ã“ã§ä½•ã‚‚ã—ãªã„
    }catch(e){ console.error(e); showToast('ä¿å­˜ã‚¨ãƒ©ãƒ¼', 'error'); }
  }
}

/* ===================== åœæ­¢è§£é™¤ ===================== */
async function releaseHold(itemId){
  if(!confirm(`ã€Œ${itemId}ã€ã®å‡ºè·åœæ­¢ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  try{
    await window.__deleteHold(itemId);
    showToast(`âœ… ${itemId} ã®å‡ºè·åœæ­¢ã‚’è§£é™¤ã—ã¾ã—ãŸ`);
    await loadCache();
    renderHoldList();
    // å‡ºåº«ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆãŸã¨ãç”¨ã«çŠ¶æ…‹ã‚‚æ›´æ–°
    if(currentTab === 'out') renderOut();
  }catch(e){ console.error(e); showToast('è§£é™¤ã‚¨ãƒ©ãƒ¼', 'error'); }
}

/* ===================== å±¥æ­´ ===================== */
async function renderHistory(){
  const list = document.getElementById('history-list');
  list.innerHTML = '<div class="empty">èª­ã¿è¾¼ã¿ä¸­...</div>';
  try{
    let items = [];
    if(window.__getHistory) items = await window.__getHistory();
    items.sort((a,b) => (b.atMs||0) - (a.atMs||0));
    if(!items.length){ list.innerHTML = '<div class="empty">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
    list.innerHTML = items.map(item => {
      const icon = item.type === 'inbound' ? 'ğŸ“¦' : 'ğŸš›';
      const product = item.type === 'inbound'
        ? `<div class="history-product">${escHtml(item.productId||'-')}</div>
           <div class="history-shelf">â†’ æ£š: ${escHtml(item.shelfId||'-')}</div>`
        : `<div class="history-product" style="color:var(--red);-webkit-text-fill-color:var(--red)">${escHtml(item.productId||'ç©ºãç™»éŒ²')}</div>
           <div class="history-shelf">æ£š: ${escHtml(item.shelfId||'-')} ã‚’å‡ºåº«</div>`;
      return `<div class="history-item">
        <div class="history-icon">${icon}</div>
        <div class="history-info">${product}</div>
        <div class="history-date">${escHtml(formatTime(item.atMs))}</div>
      </div>`;
    }).join('');
  }catch(e){ console.error(e); list.innerHTML = '<div class="empty">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>'; }
}

/* ===================== ãƒã‚¹ã‚¿ãƒ¼ ===================== */
function renderMaster(){
  const il = document.getElementById('item-list');
  if(!cachedItems.length){
    il.innerHTML = '<span style="color:var(--muted);font-size:12px">æœªç™»éŒ²</span>';
  } else {
    il.innerHTML = cachedItems.map(item =>
      `<div class="list-chip">${escHtml(item)}<button class="del-btn" onclick="removeItem('${escJsSingle(item)}')">âœ•</button></div>`
    ).join('');
  }

  const sl = document.getElementById('shelf-list');
  if(!cachedShelves.length){
    sl.innerHTML = '<span style="color:var(--muted);font-size:12px">æœªç™»éŒ²</span>';
  } else {
    sl.innerHTML = cachedShelves.map(shelf =>
      `<div class="list-chip">${escHtml(shelf)}<button class="del-btn" onclick="removeShelf('${escJsSingle(shelf)}')">âœ•</button></div>`
    ).join('');
  }

  const tb = document.getElementById('stock-tbody');
  const occupied = cachedStock.sort((a,b) => (b.inboundAtMs||0) - (a.inboundAtMs||0));
  if(!occupied.length){
    tb.innerHTML = '<tr><td colspan="4" class="empty">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';
  } else {
    tb.innerHTML = occupied.map(s =>
      `<tr>
        <td><strong>${escHtml(s.shelfId)}</strong></td>
        <td>${escHtml(s.productId||'-')}</td>
        <td class="muted">${escHtml(formatTime(s.inboundAt))}</td>
        <td><button class="del-row-btn" onclick="removeStock('${escJsSingle(s.shelfId)}')">å‰Šé™¤</button></td>
      </tr>`
    ).join('');
  }
}

async function addItem(){
  const el = document.getElementById('new-item');
  const val = (el.value || '').trim().toUpperCase();
  if(!val){ showToast('å“ç•ªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
  if(cachedItems.includes(val)){ showToast('æ—¢ã«ç™»éŒ²æ¸ˆã¿ã§ã™', 'error'); return; }
  try{
    await window.__saveItemMaster(val);
    el.value = '';
    showToast(`âœ… å“ç•ª ${val} ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`);
    await loadCache(); renderMaster();
  }catch(e){ console.error(e); showToast('ç™»éŒ²ã‚¨ãƒ©ãƒ¼', 'error'); }
}
async function removeItem(item){
  if(!confirm(`ã€Œ${item}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  try{
    await window.__deleteItemMaster(item);
    showToast(`ğŸ—‘ å“ç•ª ${item} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
    await loadCache(); renderMaster();
  }catch(e){ console.error(e); showToast('å‰Šé™¤ã‚¨ãƒ©ãƒ¼', 'error'); }
}
async function addShelf(){
  const el = document.getElementById('new-shelf');
  const val = (el.value || '').trim();
  if(!val){ showToast('æ£šç•ªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
  if(cachedShelves.includes(val)){ showToast('æ—¢ã«ç™»éŒ²æ¸ˆã¿ã§ã™', 'error'); return; }
  try{
    await window.__saveShelfMaster(val);
    el.value = '';
    showToast(`âœ… æ£šç•ª ${val} ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`);
    await loadCache(); renderMaster();
  }catch(e){ console.error(e); showToast('ç™»éŒ²ã‚¨ãƒ©ãƒ¼', 'error'); }
}
async function removeShelf(shelf){
  if(!confirm(`ã€Œ${shelf}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  try{
    await window.__deleteShelfMaster(shelf);
    showToast(`ğŸ—‘ æ£šç•ª ${shelf} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
    await loadCache(); renderMaster();
  }catch(e){ console.error(e); showToast('å‰Šé™¤ã‚¨ãƒ©ãƒ¼', 'error'); }
}
async function removeStock(shelfId){
  if(!confirm(`æ£šã€Œ${shelfId}ã€ã®åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  try{
    await window.__deleteShelfItem(shelfId);
    showToast(`ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ`);
    await loadCache(); renderMaster();
  }catch(e){ console.error(e); showToast('å‰Šé™¤ã‚¨ãƒ©ãƒ¼', 'error'); }
}

/* ===================== TOAST ===================== */
function showToast(msg, type){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + (type||'') + ' show';
  setTimeout(() => t.className = 'toast ' + (type||''), 2200);
}

/* ===================== ã‚­ãƒ¼å…¥åŠ›ï¼ˆEnterã§è¿½åŠ ï¼‰ ===================== */
document.getElementById('new-item').addEventListener('keydown', e => { if(e.key==='Enter') addItem(); });
document.getElementById('new-shelf').addEventListener('keydown', e => { if(e.key==='Enter') addShelf(); });

/* ===================== åˆæœŸãƒ­ãƒ¼ãƒ‰ï¼ˆFirebaseå‰ã§ã‚‚è¡¨ç¤ºã ã‘ã¯ã™ã‚‹ï¼‰ ===================== */
loadCache().then(() => { renderIn(); });

</script>

<!-- ===== Firebase SDK ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, deleteDoc, collection,
    getDocs, query, serverTimestamp, orderBy, limit, addDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAOMRoojKv9Hnh3OjVGwYV_k1LBTGOKepY",
    authDomain: "miyamaunitec-fb87a.firebaseapp.com",
    projectId: "miyamaunitec-fb87a",
    storageBucket: "miyamaunitec-fb87a.firebasestorage.app",
    messagingSenderId: "495316649507",
    appId: "1:495316649507:web:1f98ee3dd851474fa39396"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  const setStatus = (t,c) => {
    const el = document.getElementById('firebaseStatus');
    el.textContent = `Firebase: ${t}`;
    el.style.color = c;
    el.style.webkitTextFillColor = c;
  };

  try{
    await signInAnonymously(auth);
    setStatus('æ¥ç¶šæ¸ˆã¿', '#2ecc71');
  }catch(e){
    console.warn(e);
    setStatus('æœªæ¥ç¶š', '#e74c3c');
  }

  const INV  = 'shelfInventory';
  const SHM  = 'shelfMaster';
  const ITM  = 'itemMaster';
  const HIST = 'shelfHistory';
  const HLD  = 'shipmentHold';

  /* åœ¨åº« */
  window.__saveShelfItem = async (shelfId, data) => {
    await setDoc(doc(db, INV, String(shelfId)), { ...data, savedAt: serverTimestamp() }, { merge: false });
  };
  window.__getShelfItem = async (shelfId) => {
    const snap = await getDoc(doc(db, INV, String(shelfId)));
    return snap.exists() ? snap.data() : null;
  };
  window.__getAllShelves = async () => {
    const snap = await getDocs(collection(db, INV));
    return snap.docs.map(d => d.data());
  };
  window.__deleteShelfItem = async (shelfId) => {
    await deleteDoc(doc(db, INV, String(shelfId)));
  };

  /* æ£šç•ªãƒã‚¹ã‚¿ãƒ¼ */
  window.__getAllShelfMasters = async () => {
    const snap = await getDocs(collection(db, SHM));
    return snap.docs.map(d => d.data());
  };
  window.__saveShelfMaster = async (shelfId) => {
    await setDoc(doc(db, SHM, String(shelfId)), { shelfId: String(shelfId), createdAt: serverTimestamp() });
  };
  window.__deleteShelfMaster = async (shelfId) => {
    await deleteDoc(doc(db, SHM, String(shelfId)));
  };

  /* å“ç•ªãƒã‚¹ã‚¿ãƒ¼ */
  window.__getAllItemMasters = async () => {
    const snap = await getDocs(collection(db, ITM));
    return snap.docs.map(d => d.data());
  };
  window.__saveItemMaster = async (itemId) => {
    await setDoc(doc(db, ITM, String(itemId)), { itemId: String(itemId), createdAt: serverTimestamp() });
  };
  window.__deleteItemMaster = async (itemId) => {
    await deleteDoc(doc(db, ITM, String(itemId)));
  };

  /* å±¥æ­´ */
  window.__addHistory = async (data) => {
    await addDoc(collection(db, HIST), { ...data, createdAt: serverTimestamp() });
  };
  window.__getHistory = async () => {
    const q = query(collection(db, HIST), orderBy('atMs','desc'), limit(100));
    const snap = await getDocs(q);
    return snap.docs.map(d => d.data());
  };

  /* å‡ºè·åœæ­¢ */
  window.__saveHold = async (itemId, data) => {
    await setDoc(doc(db, HLD, String(itemId)), { ...data, savedAt: serverTimestamp() });
  };
  window.__deleteHold = async (itemId) => {
    await deleteDoc(doc(db, HLD, String(itemId)));
  };
  window.__getAllHolds = async () => {
    const snap = await getDocs(collection(db, HLD));
    return snap.docs.map(d => d.data());
  };

  // Firebaseæº–å‚™å®Œäº†å¾Œã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥â†’å†æç”»
  await loadCache();
  // ç¾åœ¨ã‚¿ãƒ–ã«å¿œã˜ã¦æç”»ï¼ˆåˆæœŸã¯inï¼‰
  renderIn();
</script>

</body>
</html>
