<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no">
<title>RACK WMS</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap');

:root {
  --bg: #0f1117;
  --surface: #181c25;
  --card: #1e2330;
  --border: #2a3040;
  --accent: #f5a623;
  --green: #2ecc71;
  --red: #e74c3c;
  --blue: #3498db;
  --orange: #e67e22;
  --text: #e8ecf0;
  --muted: #6b7a8d;
  --sidebar-w: 220px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html { height: 100%; height: 100dvh; background: var(--bg) !important; }

button, input, select, textarea {
  font-family: 'Noto Sans JP', sans-serif;
  font-size: inherit;
}

body {
  height: 100%;
  height: 100dvh;
  background: var(--bg) !important;
  color: var(--text) !important;
  font-family: 'Noto Sans JP', sans-serif;
  display: flex;
  flex-direction: column;
  -webkit-text-fill-color: var(--text);
}

/* ===== LAYOUT WRAPPER ===== */
.app-wrapper {
  display: flex;
  flex-direction: column;
  height: 100%;
  height: 100dvh;
  overflow: hidden;
}

/* ===== HEADER ===== */
.header {
  background: var(--surface) !important;
  border-bottom: 2px solid var(--accent) !important;
  padding: 10px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
  z-index: 100;
}
.header-logo { font-size: 22px; }
.header-title {
  font-family: 'Rajdhani', sans-serif;
  font-size: 22px;
  font-weight: 700;
  color: var(--accent) !important;
  letter-spacing: 2px;
  -webkit-text-fill-color: var(--accent);
}
.header-sub {
  font-size: 11px;
  color: var(--muted) !important;
  margin-left: auto;
  text-align: right;
  -webkit-text-fill-color: var(--muted);
}
#firebaseStatus { font-size: 11px; -webkit-text-fill-color: inherit; }

/* ===== BODY AREA (sidebar + content) ===== */
.body-area {
  display: flex;
  flex: 1;
  overflow: hidden;
}

/* ===== SIDEBAR NAV (PC only) ===== */
.sidebar {
  display: none;
  width: var(--sidebar-w);
  background: var(--surface) !important;
  border-right: 1px solid var(--border) !important;
  flex-direction: column;
  flex-shrink: 0;
  padding: 16px 10px;
  gap: 4px;
  overflow-y: auto;
}
.sidebar-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 14px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 700;
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
  border: 1px solid transparent !important;
  transition: all 0.18s;
  user-select: none;
  letter-spacing: 0.5px;
}
.sidebar-item:hover {
  background: rgba(255,255,255,0.04) !important;
  color: var(--text) !important;
  -webkit-text-fill-color: var(--text);
}
.sidebar-item.active {
  background: rgba(245,166,35,0.12) !important;
  color: var(--accent) !important;
  border-color: rgba(245,166,35,0.3) !important;
  -webkit-text-fill-color: var(--accent);
}
.sidebar-item.tab-hold.active {
  background: rgba(231,76,60,0.12) !important;
  color: var(--red) !important;
  border-color: rgba(231,76,60,0.3) !important;
  -webkit-text-fill-color: var(--red);
}
.sidebar-icon { font-size: 18px; flex-shrink: 0; }
.sidebar-divider {
  height: 1px;
  background: var(--border) !important;
  margin: 10px 4px;
}

/* ===== TAB BAR (mobile / tablet) ===== */
.tabs {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  background: var(--surface) !important;
  border-bottom: 1px solid var(--border) !important;
  flex-shrink: 0;
}
.tab {
  padding: 10px 2px;
  text-align: center;
  font-size: 10px;
  font-weight: 700;
  color: var(--muted) !important;
  cursor: pointer;
  border-bottom: 3px solid transparent !important;
  transition: all 0.2s;
  letter-spacing: 0.3px;
  -webkit-text-fill-color: var(--muted);
  user-select: none;
}
.tab.active {
  color: var(--accent) !important;
  border-bottom-color: var(--accent) !important;
  background: rgba(245,166,35,0.06) !important;
  -webkit-text-fill-color: var(--accent);
}
.tab.tab-hold.active {
  color: var(--red) !important;
  border-bottom-color: var(--red) !important;
  background: rgba(231,76,60,0.06) !important;
  -webkit-text-fill-color: var(--red);
}
.tab-icon { font-size: 15px; display: block; margin-bottom: 2px; }

/* ===== MAIN CONTENT ===== */
.main {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
.section { display: none; }
.section.active {
  display: flex;
  flex-direction: column;
  flex: 1;
  overflow: hidden;
  padding: 12px 14px 0;
}

/* ===== TWO COLUMN LAYOUT for tablet/PC ===== */
.two-col-layout {
  display: flex;
  flex: 1;
  gap: 14px;
  overflow: hidden;
  min-height: 0;
}
.two-col-left {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-width: 0;
  overflow: hidden;
}
.two-col-right {
  display: none; /* hidden on mobile */
  flex-direction: column;
  width: 300px;
  flex-shrink: 0;
  gap: 12px;
}

/* ===== STEPS ===== */
.steps {
  display: flex;
  gap: 6px;
  margin-bottom: 12px;
  align-items: center;
  flex-shrink: 0;
}
.step {
  flex: 1;
  padding: 7px 4px;
  text-align: center;
  font-size: 10px;
  font-weight: 700;
  border-radius: 6px;
  background: var(--card) !important;
  color: var(--muted) !important;
  border: 1px solid var(--border) !important;
  letter-spacing: 0.5px;
  -webkit-text-fill-color: var(--muted);
}
.step.done {
  background: rgba(46,204,113,0.12) !important;
  color: var(--green) !important;
  border-color: var(--green) !important;
  -webkit-text-fill-color: var(--green);
}
.step.active {
  background: rgba(245,166,35,0.15) !important;
  color: var(--accent) !important;
  border-color: var(--accent) !important;
  -webkit-text-fill-color: var(--accent);
}
.step.step-red.active {
  background: rgba(231,76,60,0.15) !important;
  color: var(--red) !important;
  border-color: var(--red) !important;
  -webkit-text-fill-color: var(--red);
}
.step-arrow { color: var(--muted) !important; font-size: 10px; flex: none; -webkit-text-fill-color: var(--muted); }

/* ===== SELECTED DISPLAY ===== */
.selected-display {
  background: var(--card) !important;
  border: 1px solid var(--border) !important;
  border-radius: 10px;
  padding: 12px 14px;
  margin-bottom: 12px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  flex-shrink: 0;
}
.selected-display.single-col { grid-template-columns: 1fr; }
.sel-label {
  font-size: 10px;
  color: var(--muted) !important;
  letter-spacing: 1px;
  font-weight: 700;
  -webkit-text-fill-color: var(--muted);
}
.sel-value {
  font-size: 20px;
  font-weight: 700;
  color: var(--accent) !important;
  font-family: 'Rajdhani', sans-serif;
  letter-spacing: 1px;
  min-height: 30px;
  word-break: break-all;
  -webkit-text-fill-color: var(--accent);
}
.sel-value.red { color: var(--red) !important; -webkit-text-fill-color: var(--red); }

/* ===== SEC LABEL ===== */
.sec-label {
  font-size: 10px;
  font-weight: 700;
  color: var(--muted) !important;
  letter-spacing: 2px;
  margin-bottom: 8px;
  padding-left: 2px;
  display: flex;
  align-items: center;
  gap: 6px;
  -webkit-text-fill-color: var(--muted);
}

/* ===== INITIAL GRID ===== */
.initial-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
  gap: 7px;
  margin-bottom: 10px;
}
.initial-btn {
  background: var(--surface) !important;
  border: 2px solid var(--border) !important;
  border-radius: 8px;
  color: var(--text) !important;
  font-family: 'Rajdhani', sans-serif;
  font-size: 18px;
  font-weight: 700;
  padding: 10px 4px;
  cursor: pointer;
  transition: all 0.15s;
  text-align: center;
  letter-spacing: 1px;
  -webkit-text-fill-color: var(--text);
  user-select: none;
}
.initial-btn:active { transform: scale(0.93); }
.initial-btn.selected {
  background: rgba(245,166,35,0.2) !important;
  border-color: var(--accent) !important;
  color: var(--accent) !important;
  -webkit-text-fill-color: var(--accent);
}
.initial-btn.selected-red {
  background: rgba(231,76,60,0.2) !important;
  border-color: var(--red) !important;
  color: var(--red) !important;
  -webkit-text-fill-color: var(--red);
}
.initial-btn .count {
  display: block;
  font-size: 9px;
  font-family: 'Noto Sans JP', sans-serif;
  color: var(--muted) !important;
  font-weight: 400;
  margin-top: 1px;
  -webkit-text-fill-color: var(--muted);
}
.initial-btn.selected .count { color: var(--accent) !important; -webkit-text-fill-color: var(--accent); opacity: 0.7; }
.initial-btn.selected-red .count { color: var(--red) !important; -webkit-text-fill-color: var(--red); opacity: 0.7; }

/* ===== ITEM PANEL ===== */
.item-panel {
  background: var(--card) !important;
  border: 1px solid var(--border) !important;
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 12px;
  display: none;
}
.item-panel.visible { display: block; }
.item-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}
.item-panel-label {
  font-size: 11px;
  font-weight: 700;
  color: var(--muted) !important;
  letter-spacing: 2px;
  -webkit-text-fill-color: var(--muted);
}
.back-btn {
  background: var(--surface) !important;
  border: 1px solid var(--border) !important;
  border-radius: 6px;
  color: var(--muted) !important;
  font-size: 11px;
  font-weight: 700;
  padding: 4px 10px;
  cursor: pointer;
  letter-spacing: 1px;
  -webkit-text-fill-color: var(--muted);
}

/* ===== BUTTON GRID ===== */
.btn-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(88px, 1fr));
  gap: 8px;
  margin-bottom: 12px;
}
.item-btn {
  background: var(--card) !important;
  border: 2px solid var(--border) !important;
  border-radius: 10px;
  color: var(--text) !important;
  font-size: 13px;
  font-weight: 700;
  padding: 14px 6px;
  cursor: pointer;
  transition: all 0.15s;
  text-align: center;
  min-height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  word-break: break-all;
  line-height: 1.3;
  -webkit-text-fill-color: var(--text);
  user-select: none;
  position: relative;
}
.item-btn:active { transform: scale(0.95); }
.item-btn.selected {
  background: rgba(245,166,35,0.18) !important;
  border-color: var(--accent) !important;
  color: var(--accent) !important;
  -webkit-text-fill-color: var(--accent);
}
.item-btn.selected-red {
  background: rgba(231,76,60,0.18) !important;
  border-color: var(--red) !important;
  color: var(--red) !important;
  -webkit-text-fill-color: var(--red);
}
.item-btn.shelf-recommend {
  position: relative;
  background: rgba(52,152,219,0.12) !important;
  border-color: var(--blue) !important;
}
.item-btn.shelf-recommend::before {
  content: attr(data-rank);
  position: absolute;
  top: -8px; right: -8px;
  background: var(--blue) !important;
  color: white !important;
  font-size: 10px;
  font-weight: 700;
  width: 20px; height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  -webkit-text-fill-color: white;
}
.item-btn.shelf-recommend.selected {
  background: rgba(245,166,35,0.18) !important;
  border-color: var(--accent) !important;
  color: var(--accent) !important;
  -webkit-text-fill-color: var(--accent);
}
.item-btn.hold-badge::after {
  content: 'ÂÅúÊ≠¢‰∏≠';
  position: absolute;
  top: -8px; left: -8px;
  background: var(--red) !important;
  color: white !important;
  font-size: 9px;
  font-weight: 700;
  padding: 2px 5px;
  border-radius: 4px;
  -webkit-text-fill-color: white;
  letter-spacing: 0.5px;
}
.item-btn-sub {
  font-size: 10px;
  font-weight: 400;
  color: var(--muted) !important;
  display: block;
  margin-top: 2px;
  -webkit-text-fill-color: var(--muted);
}

/* ===== CONFIRM BUTTON ===== */
.confirm-wrap { flex-shrink: 0; padding: 8px 0 10px; }
.confirm-btn {
  width: 100%;
  height: 68px;
  border-radius: 12px;
  border: 3px solid var(--border) !important;
  background: var(--card) !important;
  color: var(--muted) !important;
  font-family: 'Rajdhani', sans-serif;
  font-size: 20px;
  font-weight: 700;
  letter-spacing: 3px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: border-color 0.2s, color 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  -webkit-text-fill-color: var(--muted);
  user-select: none;
}
.confirm-btn.ready {
  border-color: var(--green) !important;
  color: var(--green) !important;
  -webkit-text-fill-color: var(--green);
  animation: pulse-border 2s ease infinite;
}
.confirm-btn.ready-red {
  border-color: var(--red) !important;
  color: var(--red) !important;
  -webkit-text-fill-color: var(--red);
  animation: pulse-border-red 2s ease infinite;
}
.confirm-btn.pressing {
  border-color: var(--green) !important;
  color: white !important;
  -webkit-text-fill-color: white;
}
.confirm-btn.pressing-red {
  border-color: var(--red) !important;
  color: white !important;
  -webkit-text-fill-color: white;
}
.confirm-btn.disabled { opacity: 0.4; cursor: not-allowed; }
.confirm-btn .progress-bar {
  position: absolute;
  bottom: 0; left: 0;
  height: 4px;
  background: var(--green) !important;
  width: 0%;
  transition: width linear;
}
.confirm-btn .progress-bar-red {
  position: absolute;
  bottom: 0; left: 0;
  height: 4px;
  background: var(--red) !important;
  width: 0%;
  transition: width linear;
}
.confirm-hint {
  text-align: center;
  font-size: 11px;
  color: var(--muted) !important;
  margin-top: 6px;
  -webkit-text-fill-color: var(--muted);
}
@keyframes pulse-border {
  0%, 100% { box-shadow: 0 0 0 0 rgba(46,204,113,0.4); }
  50% { box-shadow: 0 0 0 8px rgba(46,204,113,0); }
}
@keyframes pulse-border-red {
  0%, 100% { box-shadow: 0 0 0 0 rgba(231,76,60,0.4); }
  50% { box-shadow: 0 0 0 8px rgba(231,76,60,0); }
}

/* ===== FIFO BADGE ===== */
.fifo-badge {
  background: rgba(52,152,219,0.2) !important;
  border: 1px solid var(--blue) !important;
  color: var(--blue) !important;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 700;
  -webkit-text-fill-color: var(--blue);
}

/* ===== HOLD WARNING ===== */
.hold-warning {
  display: none;
  background: rgba(231,76,60,0.12) !important;
  border: 2px solid var(--red) !important;
  border-radius: 10px;
  padding: 12px 14px;
  margin-bottom: 12px;
  animation: flash-border 1.5s ease infinite;
}
.hold-warning.visible { display: block; }
.hold-warning-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--red) !important;
  -webkit-text-fill-color: var(--red);
  letter-spacing: 1px;
  margin-bottom: 6px;
}
.hold-warning-reason {
  font-size: 13px;
  color: var(--text) !important;
  -webkit-text-fill-color: var(--text);
  background: rgba(255,255,255,0.04) !important;
  border-radius: 6px;
  padding: 8px 10px;
  line-height: 1.5;
  word-break: break-all;
}
.hold-warning-meta {
  font-size: 11px;
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
  margin-top: 6px;
}
@keyframes flash-border {
  0%, 100% { border-color: var(--red) !important; }
  50% { border-color: rgba(231,76,60,0.3) !important; }
}

/* ===== REASON INPUT ===== */
.reason-wrap {
  background: var(--card) !important;
  border: 1px solid var(--border) !important;
  border-radius: 10px;
  padding: 12px 14px;
  margin-bottom: 12px;
  display: none;
}
.reason-wrap.visible { display: block; }
.reason-label {
  font-size: 10px;
  font-weight: 700;
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
  letter-spacing: 2px;
  margin-bottom: 8px;
}
textarea.reason-input {
  width: 100%;
  background: var(--surface) !important;
  border: 2px solid var(--border) !important;
  border-radius: 8px;
  color: var(--text) !important;
  -webkit-text-fill-color: var(--text);
  font-size: 14px;
  padding: 10px 12px;
  outline: none;
  resize: none;
  height: 80px;
  transition: border-color 0.2s;
  line-height: 1.5;
}
textarea.reason-input:focus { border-color: var(--red) !important; }
textarea.reason-input::placeholder { color: var(--muted) !important; -webkit-text-fill-color: var(--muted); }

/* ===== HOLD LIST ===== */
.hold-divider {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 16px 0 12px;
}
.hold-divider-line { flex: 1; height: 1px; background: var(--border) !important; }
.hold-divider-label {
  font-size: 10px;
  font-weight: 700;
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
  letter-spacing: 2px;
  white-space: nowrap;
}
.hold-list-item {
  background: var(--card) !important;
  border: 1px solid rgba(231,76,60,0.3) !important;
  border-left: 4px solid var(--red) !important;
  border-radius: 10px;
  padding: 12px 14px;
  margin-bottom: 8px;
  display: flex;
  align-items: flex-start;
  gap: 12px;
}
.hold-list-item-info { flex: 1; min-width: 0; }
.hold-list-item-id {
  font-size: 20px;
  font-weight: 700;
  color: var(--red) !important;
  -webkit-text-fill-color: var(--red);
  font-family: 'Rajdhani', sans-serif;
  letter-spacing: 1px;
}
.hold-list-item-reason {
  font-size: 12px;
  color: var(--text) !important;
  -webkit-text-fill-color: var(--text);
  margin-top: 4px;
  word-break: break-all;
  line-height: 1.4;
}
.hold-list-item-date {
  font-size: 11px;
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
  margin-top: 4px;
}
.release-btn {
  background: rgba(46,204,113,0.15) !important;
  border: 1px solid var(--green) !important;
  color: var(--green) !important;
  -webkit-text-fill-color: var(--green);
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 12px;
  font-weight: 700;
  cursor: pointer;
  white-space: nowrap;
  flex-shrink: 0;
  letter-spacing: 0.5px;
}

/* ===== TOAST ===== */
.toast {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(-20px);
  background: var(--green) !important;
  color: white !important;
  font-weight: 700;
  font-size: 14px;
  padding: 12px 24px;
  border-radius: 30px;
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s;
  z-index: 1000;
  white-space: nowrap;
  letter-spacing: 1px;
  -webkit-text-fill-color: white;
}
.toast.error { background: var(--red) !important; }
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ===== MASTER ===== */
.master-card {
  background: var(--card) !important;
  border: 1px solid var(--border) !important;
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 12px;
}
.master-title {
  font-size: 13px;
  font-weight: 700;
  color: var(--muted) !important;
  letter-spacing: 2px;
  margin-bottom: 10px;
  -webkit-text-fill-color: var(--muted);
}
.input-row { display: flex; gap: 8px; margin-bottom: 10px; }
input[type=text] {
  flex: 1;
  background: var(--surface) !important;
  border: 2px solid var(--border) !important;
  border-radius: 8px;
  color: var(--text) !important;
  font-size: 14px;
  padding: 10px 12px;
  outline: none;
  transition: border-color 0.2s;
  user-select: auto;
  -webkit-user-select: auto;
  -webkit-text-fill-color: var(--text);
}
input[type=text]:focus { border-color: var(--accent) !important; }
input[type=text]::placeholder { color: var(--muted) !important; -webkit-text-fill-color: var(--muted); }
.add-btn {
  background: var(--accent) !important;
  color: var(--bg) !important;
  border: none;
  border-radius: 8px;
  font-weight: 700;
  font-size: 13px;
  padding: 10px 16px;
  cursor: pointer;
  white-space: nowrap;
  -webkit-text-fill-color: var(--bg);
}
.list-chips { display: flex; flex-wrap: wrap; gap: 6px; }
.list-chip {
  background: var(--surface) !important;
  border: 1px solid var(--border) !important;
  border-radius: 6px;
  padding: 6px 10px;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
  color: var(--text) !important;
  -webkit-text-fill-color: var(--text);
}
.del-btn {
  background: none;
  border: none;
  color: var(--muted) !important;
  cursor: pointer;
  font-size: 14px;
  line-height: 1;
  padding: 0;
  -webkit-text-fill-color: var(--muted);
}

/* ===== STOCK TABLE ===== */
.stock-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.stock-table th {
  background: var(--surface) !important;
  color: var(--muted) !important;
  padding: 8px 10px;
  text-align: left;
  font-size: 10px;
  letter-spacing: 1px;
  border-bottom: 1px solid var(--border) !important;
  -webkit-text-fill-color: var(--muted);
}
.stock-table td {
  padding: 8px 10px;
  border-bottom: 1px solid var(--border) !important;
  vertical-align: middle;
  color: var(--text) !important;
  -webkit-text-fill-color: var(--text);
}
.stock-table td.muted { font-size: 11px; color: var(--muted) !important; -webkit-text-fill-color: var(--muted); }
.del-row-btn {
  background: rgba(231,76,60,0.15) !important;
  border: 1px solid var(--red) !important;
  color: var(--red) !important;
  border-radius: 5px;
  padding: 3px 8px;
  font-size: 11px;
  cursor: pointer;
  -webkit-text-fill-color: var(--red);
}
.scroll-list { max-height: 260px; overflow-y: auto; }

/* ===== EMPTY ===== */
.empty { text-align: center; color: var(--muted) !important; font-size: 13px; padding: 20px; -webkit-text-fill-color: var(--muted); }

/* ===== HISTORY ===== */
.history-item {
  background: var(--card) !important;
  border: 1px solid var(--border) !important;
  border-radius: 10px;
  padding: 12px 14px;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.history-icon { font-size: 20px; flex-shrink: 0; }
.history-info { flex: 1; min-width: 0; }
.history-product {
  font-size: 18px;
  font-weight: 700;
  color: var(--text) !important;
  font-family: 'Rajdhani', sans-serif;
  -webkit-text-fill-color: var(--text);
}
.history-shelf {
  font-size: 12px;
  color: var(--green) !important;
  font-weight: 700;
  -webkit-text-fill-color: var(--green);
  margin-top: 2px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.history-date {
  font-size: 11px;
  color: var(--muted) !important;
  text-align: right;
  flex-shrink: 0;
  line-height: 1.5;
  -webkit-text-fill-color: var(--muted);
}

/* ===== SCROLL AREA ===== */
.scroll-area {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  padding-bottom: 8px;
}

/* ===== QR HINT ===== */
.qr-hint {
  font-size: 11px;
  color: var(--muted) !important;
  background: rgba(52,152,219,0.08) !important;
  border: 1px solid rgba(52,152,219,0.3) !important;
  border-radius: 8px;
  padding: 8px 12px;
  margin-bottom: 10px;
  -webkit-text-fill-color: var(--muted);
}

/* ===== STATUS PANEL (PC right column) ===== */
.status-panel {
  background: var(--card) !important;
  border: 1px solid var(--border) !important;
  border-radius: 12px;
  padding: 14px;
  flex-shrink: 0;
}
.status-panel-title {
  font-size: 11px;
  font-weight: 700;
  color: var(--muted) !important;
  letter-spacing: 2px;
  margin-bottom: 10px;
  -webkit-text-fill-color: var(--muted);
}
.status-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid var(--border) !important;
}
.status-row:last-child { border-bottom: none !important; }
.status-key { font-size: 11px; color: var(--muted) !important; -webkit-text-fill-color: var(--muted); }
.status-val {
  font-size: 16px;
  font-weight: 700;
  color: var(--accent) !important;
  font-family: 'Rajdhani', sans-serif;
  -webkit-text-fill-color: var(--accent);
}
.status-val.green { color: var(--green) !important; -webkit-text-fill-color: var(--green); }
.status-val.red { color: var(--red) !important; -webkit-text-fill-color: var(--red); }

/* ===== SCAN INPUT (hidden) ===== */
#scanInput {
  position: absolute; left: -9999px; top: -9999px;
  width: 1px; height: 1px; opacity: 0; pointer-events: none;
}

/* ===== SHELF PREFIX BUTTON (ÂÖ•Â∫´Áî®„ÉªÁ©∫„ÅçÁä∂Ê≥ÅË°®Á§∫) ===== */
.shelf-prefix-btn {
  background: var(--surface) !important;
  border: 2px solid var(--border) !important;
  border-radius: 10px;
  color: var(--text) !important;
  -webkit-text-fill-color: var(--text);
  font-family: 'Rajdhani', sans-serif;
  font-size: 20px;
  font-weight: 700;
  padding: 10px 8px 8px;
  cursor: pointer;
  transition: all 0.15s;
  text-align: center;
  letter-spacing: 1px;
  user-select: none;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
  position: relative;
  overflow: hidden;
}
.shelf-prefix-btn:active { transform: scale(0.93); }
.shelf-prefix-btn.has-empty {
  border-color: rgba(46,204,113,0.5) !important;
}
.shelf-prefix-btn.is-full {
  opacity: 0.45;
}
.shelf-prefix-btn.selected {
  background: rgba(245,166,35,0.2) !important;
  border-color: var(--accent) !important;
  color: var(--accent) !important;
  -webkit-text-fill-color: var(--accent);
  opacity: 1;
}
.shelf-prefix-btn .spb-label {
  font-size: 8px;
  font-family: 'Noto Sans JP', sans-serif;
  font-weight: 700;
  letter-spacing: 0.5px;
  white-space: nowrap;
}
.shelf-prefix-btn.has-empty .spb-label {
  color: var(--green) !important;
  -webkit-text-fill-color: var(--green);
}
.shelf-prefix-btn.is-full .spb-label {
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
}
.shelf-prefix-btn.selected .spb-label {
  color: var(--accent) !important;
  -webkit-text-fill-color: var(--accent);
  opacity: 0.8;
}
/* Á©∫„ÅçÊ£í„Ç∞„É©„Éï */
.spb-bar-wrap {
  width: 100%;
  height: 4px;
  background: rgba(255,255,255,0.08) !important;
  border-radius: 3px;
  overflow: hidden;
}
.spb-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.3s ease;
}
.shelf-prefix-btn.has-empty .spb-bar-fill {
  background: var(--green) !important;
}
.shelf-prefix-btn.is-full .spb-bar-fill {
  background: var(--muted) !important;
}
.shelf-prefix-btn.selected .spb-bar-fill {
  background: var(--accent) !important;
}

/* ===== EMPTY / OCCUPIED SHELF (ÂÖ•Â∫´Áî®) ===== */
.item-btn.shelf-empty {
  background: rgba(46,204,113,0.08) !important;
  border-color: rgba(46,204,113,0.6) !important;
}
.item-btn.shelf-empty::after {
  content: 'Á©∫';
  position: absolute;
  top: -8px; right: -8px;
  background: var(--green) !important;
  color: white !important;
  -webkit-text-fill-color: white;
  font-size: 10px;
  font-weight: 700;
  width: 20px; height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}
.item-btn.shelf-empty.selected {
  background: rgba(245,166,35,0.18) !important;
  border-color: var(--accent) !important;
}
.item-btn.shelf-empty.selected::after {
  background: var(--accent) !important;
}
.item-btn.shelf-occupied-in {
  opacity: 0.4;
  border-color: var(--border) !important;
  background: var(--surface) !important;
}
.item-btn.shelf-occupied-in.selected {
  opacity: 1;
  background: rgba(245,166,35,0.18) !important;
  border-color: var(--accent) !important;
}

/* ===================== TABLET (640px+) ===================== */
@media (min-width: 640px) {
  .header { padding: 12px 24px; }
  .header-title { font-size: 26px; letter-spacing: 3px; }
  .header-logo { font-size: 26px; }
  .header-sub { font-size: 12px; }

  .tab { font-size: 12px; padding: 12px 4px; }
  .tab-icon { font-size: 17px; }

  .section.active { padding: 16px 20px 0; }

  .initial-grid { grid-template-columns: repeat(auto-fill, minmax(72px, 1fr)); gap: 9px; }
  .initial-btn { font-size: 20px; padding: 12px 4px; }
  .shelf-prefix-btn { font-size: 22px; }

  .btn-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
  .item-btn { font-size: 14px; padding: 16px 8px; min-height: 68px; }

  .sel-value { font-size: 24px; }

  .confirm-btn { height: 76px; font-size: 22px; }

  .step { font-size: 11px; padding: 8px 6px; }

  /* Two-col layout on tablet */
  .two-col-layout { gap: 16px; }
  .two-col-right { display: flex; width: 260px; }

  textarea.reason-input { height: 100px; font-size: 15px; }

  .master-card { padding: 18px; }
  .input-row input[type=text] { font-size: 15px; padding: 11px 14px; }
  .add-btn { padding: 11px 20px; font-size: 14px; }
}

/* ===================== PC (1024px+) ===================== */
@media (min-width: 1024px) {
  /* Sidebar replaces tab bar */
  .tabs { display: none; }
  .sidebar { display: flex; }

  .header { padding: 14px 28px; }
  .header-title { font-size: 28px; }
  .header-logo { font-size: 28px; }

  .section.active { padding: 20px 24px 0; }

  .initial-grid { grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; }
  .initial-btn { font-size: 22px; padding: 14px 4px; }
  .initial-btn .count { font-size: 10px; }
  .shelf-prefix-btn { font-size: 24px; }
  .shelf-prefix-btn .spb-label { font-size: 9px; }

  .btn-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; }
  .item-btn { font-size: 15px; padding: 18px 10px; min-height: 72px; }

  .sel-value { font-size: 28px; }
  .sel-label { font-size: 11px; }

  .step { font-size: 12px; padding: 9px 8px; }

  .confirm-btn { height: 80px; font-size: 24px; letter-spacing: 4px; }
  .confirm-hint { font-size: 12px; }

  .two-col-right { width: 300px; }

  .history-item { padding: 14px 18px; }
  .history-product { font-size: 20px; }
  .history-shelf { font-size: 13px; }
  .history-date { font-size: 12px; }

  .master-card { padding: 20px; }
  .master-title { font-size: 14px; }
  .stock-table th { font-size: 11px; padding: 10px 12px; }
  .stock-table td { padding: 10px 12px; font-size: 13px; }

  .hold-list-item { padding: 14px 18px; }
  .hold-list-item-id { font-size: 22px; }
  .hold-list-item-reason { font-size: 13px; }
}

/* ===================== WIDE PC (1440px+) ===================== */
@media (min-width: 1440px) {
  :root { --sidebar-w: 240px; }

  .section.active { padding: 24px 32px 0; }
  .two-col-right { width: 340px; }

  .initial-grid { grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 12px; }
  .initial-btn { font-size: 24px; }

  .btn-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; }
  .item-btn { min-height: 80px; font-size: 16px; }

  .confirm-btn { height: 88px; font-size: 26px; }
}

/* ===== Ê£öÂç∏„Åó ===== */
.inv-session-banner {
  background: var(--card) !important;
  border: 1px solid var(--border) !important;
  border-radius: 10px;
  padding: 10px 14px;
  margin-bottom: 10px;
  flex-shrink: 0;
}
.inv-session-banner.active-session {
  border-color: var(--blue) !important;
  background: rgba(52,152,219,0.06) !important;
  padding: 8px 14px;
}
.inv-session-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}
.inv-session-title {
  font-size: 13px;
  font-weight: 700;
  color: var(--text) !important;
  -webkit-text-fill-color: var(--text);
  letter-spacing: 0.5px;
}
.inv-session-meta {
  font-size: 11px;
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
  margin-top: 3px;
}
.inv-btn-start {
  background: var(--blue) !important;
  color: white !important;
  -webkit-text-fill-color: white;
  border: none;
  border-radius: 8px;
  font-weight: 700;
  font-size: 13px;
  padding: 10px 18px;
  cursor: pointer;
  white-space: nowrap;
  letter-spacing: 0.5px;
}
.inv-btn-end {
  background: rgba(231,76,60,0.15) !important;
  color: var(--red) !important;
  -webkit-text-fill-color: var(--red);
  border: 1px solid var(--red) !important;
  border-radius: 8px;
  font-weight: 700;
  font-size: 12px;
  padding: 8px 14px;
  cursor: pointer;
  white-space: nowrap;
}
.inv-progress-wrap {
  margin-top: 10px;
}
.inv-progress-track {
  width: 100%;
  height: 8px;
  background: rgba(255,255,255,0.06) !important;
  border-radius: 6px;
  overflow: hidden;
  margin: 6px 0 4px;
}
.inv-progress-fill {
  height: 100%;
  background: var(--blue) !important;
  border-radius: 6px;
  transition: width 0.5s ease;
}
.inv-progress-label {
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
}
.inv-progress-pct {
  font-family: 'Rajdhani', sans-serif;
  font-weight: 700;
  color: var(--blue) !important;
  -webkit-text-fill-color: var(--blue);
  font-size: 13px;
}
/* Shelf grid for inventory */
.inv-shelf-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(84px, 1fr));
  gap: 8px;
  margin-bottom: 12px;
}
.inv-shelf-btn {
  background: var(--card) !important;
  border: 2px solid var(--border) !important;
  border-radius: 10px;
  padding: 10px 6px 8px;
  cursor: pointer;
  text-align: center;
  transition: all 0.15s;
  user-select: none;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  position: relative;
}
.inv-shelf-btn:active { transform: scale(0.95); }
.inv-shelf-btn.st-unchecked { border-color: var(--border) !important; }
.inv-shelf-btn.st-ok {
  background: rgba(46,204,113,0.08) !important;
  border-color: var(--green) !important;
}
.inv-shelf-btn.st-discrepancy {
  background: rgba(231,76,60,0.08) !important;
  border-color: var(--red) !important;
  animation: flash-border 2s ease infinite;
}
.inv-shelf-btn.st-empty-ok {
  background: rgba(107,122,141,0.08) !important;
  border-color: rgba(107,122,141,0.4) !important;
}
.inv-shelf-btn.st-active {
  background: rgba(245,166,35,0.15) !important;
  border-color: var(--accent) !important;
}
.inv-shelf-id {
  font-family: 'Rajdhani', sans-serif;
  font-size: 15px;
  font-weight: 700;
  color: var(--text) !important;
  -webkit-text-fill-color: var(--text);
  line-height: 1;
}
.inv-shelf-status-icon {
  font-size: 13px;
  line-height: 1;
}
.inv-shelf-product {
  font-size: 9px;
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
  word-break: break-all;
  line-height: 1.2;
}
.inv-shelf-btn.st-ok .inv-shelf-id,
.inv-shelf-btn.st-ok .inv-shelf-product { color: var(--green) !important; -webkit-text-fill-color: var(--green); }
.inv-shelf-btn.st-discrepancy .inv-shelf-id { color: var(--red) !important; -webkit-text-fill-color: var(--red); }
.inv-shelf-btn.st-active .inv-shelf-id { color: var(--accent) !important; -webkit-text-fill-color: var(--accent); }

/* Entry panel */
.inv-entry-panel {
  background: var(--card) !important;
  border: 1px solid var(--border) !important;
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 12px;
  display: none;
  flex-shrink: 0;
}
.inv-entry-panel.visible { display: block; }
.inv-entry-title {
  font-size: 11px;
  font-weight: 700;
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
  letter-spacing: 2px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.inv-entry-shelf-id {
  font-family: 'Rajdhani', sans-serif;
  font-size: 28px;
  font-weight: 700;
  color: var(--accent) !important;
  -webkit-text-fill-color: var(--accent);
  letter-spacing: 2px;
  margin-bottom: 10px;
}

.inv-field-row {
  display: grid;
  grid-template-columns: 1fr 100px;
  gap: 8px;
  margin-bottom: 10px;
}
.inv-field-label {
  font-size: 10px;
  font-weight: 700;
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
  letter-spacing: 1px;
  margin-bottom: 4px;
}
select.inv-select {
  width: 100%;
  background: var(--surface) !important;
  border: 2px solid var(--border) !important;
  border-radius: 8px;
  color: var(--text) !important;
  -webkit-text-fill-color: var(--text);
  font-size: 14px;
  font-weight: 700;
  padding: 10px 12px;
  outline: none;
  transition: border-color 0.2s;
  -webkit-appearance: none;
  appearance: none;
  cursor: pointer;
}
select.inv-select:focus { border-color: var(--accent) !important; }
input.inv-qty {
  width: 100%;
  background: var(--surface) !important;
  border: 2px solid var(--border) !important;
  border-radius: 8px;
  color: var(--text) !important;
  -webkit-text-fill-color: var(--text);
  font-size: 22px;
  font-weight: 700;
  font-family: 'Rajdhani', sans-serif;
  padding: 8px 12px;
  outline: none;
  text-align: center;
  transition: border-color 0.2s;
}
input.inv-qty:focus { border-color: var(--accent) !important; }
.inv-qty-btns {
  display: flex;
  gap: 6px;
  margin-bottom: 10px;
}
.inv-qty-btn {
  flex: 1;
  background: var(--surface) !important;
  border: 1px solid var(--border) !important;
  border-radius: 6px;
  color: var(--text) !important;
  -webkit-text-fill-color: var(--text);
  font-size: 18px;
  font-weight: 700;
  padding: 8px;
  cursor: pointer;
  text-align: center;
  font-family: 'Rajdhani', sans-serif;
}
.inv-confirm-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
.inv-btn-ok {
  background: rgba(46,204,113,0.15) !important;
  border: 2px solid var(--green) !important;
  color: var(--green) !important;
  -webkit-text-fill-color: var(--green);
  border-radius: 10px;
  font-weight: 700;
  font-size: 14px;
  padding: 12px;
  cursor: pointer;
  letter-spacing: 1px;
}
.inv-btn-skip {
  background: var(--surface) !important;
  border: 1px solid var(--border) !important;
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
  border-radius: 10px;
  font-weight: 700;
  font-size: 13px;
  padding: 12px;
  cursor: pointer;
}

/* Report */
.inv-report-card {
  background: var(--card) !important;
  border: 1px solid var(--border) !important;
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 12px;
}
.inv-report-title {
  font-size: 11px;
  font-weight: 700;
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
  letter-spacing: 2px;
  margin-bottom: 10px;
}
.inv-report-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid var(--border) !important;
}
.inv-report-row:last-child { border-bottom: none !important; }
.inv-report-item {
  font-family: 'Rajdhani', sans-serif;
  font-size: 16px;
  font-weight: 700;
  color: var(--text) !important;
  -webkit-text-fill-color: var(--text);
}
.inv-report-qty {
  font-family: 'Rajdhani', sans-serif;
  font-size: 22px;
  font-weight: 700;
  color: var(--accent) !important;
  -webkit-text-fill-color: var(--accent);
}
.inv-report-unit {
  font-size: 11px;
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
  margin-left: 4px;
}
.inv-discrepancy-row {
  padding: 8px 10px;
  border-radius: 6px;
  background: rgba(231,76,60,0.08) !important;
  border: 1px solid rgba(231,76,60,0.3) !important;
  margin-bottom: 6px;
  font-size: 12px;
}
.inv-tab-btns {
  display: flex;
  gap: 6px;
  margin-bottom: 12px;
  flex-shrink: 0;
}
.inv-tab-btn {
  flex: 1;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid var(--border) !important;
  background: var(--card) !important;
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
  font-size: 12px;
  font-weight: 700;
  cursor: pointer;
  text-align: center;
  letter-spacing: 0.5px;
  transition: all 0.15s;
}
.inv-tab-btn.active {
  background: rgba(52,152,219,0.15) !important;
  border-color: var(--blue) !important;
  color: var(--blue) !important;
  -webkit-text-fill-color: var(--blue);
}
.inv-sync-indicator {
  font-size: 10px;
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
  display: flex;
  align-items: center;
  gap: 4px;
}
.inv-sync-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--green) !important;
  animation: pulse-dot 2s ease infinite;
}
@keyframes pulse-dot {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}


/* ===== Ê£öÂç∏„Åó Ë§áÊï∞ÂìÅÁï™Ë°å ===== */
.inv-multi-row {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 8px;
  background: var(--surface) !important;
  border: 1px solid var(--border) !important;
  border-radius: 8px;
  padding: 8px 8px;
}
.inv-multi-row .inv-select {
  flex: 1;
  padding: 7px 8px;
  font-size: 13px;
}
.inv-multi-qty-group {
  display: flex;
  align-items: center;
  gap: 3px;
  flex-shrink: 0;
}
.inv-multi-qty-group .inv-qty {
  width: 52px;
  font-size: 16px;
  padding: 5px 4px;
}
.inv-multi-adj {
  background: var(--card) !important;
  border: 1px solid var(--border) !important;
  border-radius: 5px;
  color: var(--text) !important;
  -webkit-text-fill-color: var(--text);
  font-size: 14px;
  font-weight: 700;
  font-family: 'Rajdhani', sans-serif;
  width: 28px; height: 34px;
  cursor: pointer;
  text-align: center;
}
.inv-del-row-btn {
  background: none;
  border: none;
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
  font-size: 16px;
  cursor: pointer;
  padding: 4px;
  flex-shrink: 0;
  line-height: 1;
}
.inv-add-row-btn {
  width: 100%;
  background: rgba(52,152,219,0.08) !important;
  border: 1px dashed rgba(52,152,219,0.5) !important;
  border-radius: 8px;
  color: var(--blue) !important;
  -webkit-text-fill-color: var(--blue);
  font-size: 13px;
  font-weight: 700;
  padding: 9px;
  cursor: pointer;
  margin-bottom: 10px;
  letter-spacing: 0.5px;
}
.inv-empty-confirm-btn {
  width: 100%;
  background: rgba(107,122,141,0.1) !important;
  border: 1px solid rgba(107,122,141,0.4) !important;
  border-radius: 8px;
  color: var(--muted) !important;
  -webkit-text-fill-color: var(--muted);
  font-size: 12px;
  font-weight: 700;
  padding: 8px;
  cursor: pointer;
  margin-bottom: 8px;
  letter-spacing: 0.5px;
}

</style>

</head>
<body>

<input id="scanInput" type="text"
inputmode="none"
autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false"
aria-hidden="true" />

<div class="app-wrapper">

  <!-- ===== HEADER ===== -->

  <div class="header">
    <span class="header-logo">üè≠</span>
    <span class="header-title">RACK WMS</span>
    <div class="header-sub">
      <div id="clock"></div>
      <div id="firebaseStatus" style="color:var(--muted)">Firebase: Êé•Á∂ö‰∏≠...</div>
    </div>
  </div>

  <!-- ===== TAB BAR (mobile/tablet) ===== -->

  <div class="tabs">
    <div class="tab active" id="tab-in" onclick="switchTab('in',this)">
      <span class="tab-icon">üì¶</span>ÂÖ•Â∫´
    </div>
    <div class="tab" id="tab-out" onclick="switchTab('out',this)">
      <span class="tab-icon">üöõ</span>Âá∫Â∫´
    </div>
    <div class="tab" id="tab-history" onclick="switchTab('history',this)">
      <span class="tab-icon">üìã</span>Â±•Ê≠¥
    </div>
    <div class="tab tab-hold" id="tab-hold" onclick="switchTab('hold',this)">
      <span class="tab-icon">üö´</span>ÂÅúÊ≠¢
    </div>
    <div class="tab" id="tab-master" onclick="switchTab('master',this)">
      <span class="tab-icon">‚öôÔ∏è</span>„Éû„Çπ„Çø„Éº
    </div>
    <div class="tab" id="tab-inv" onclick="switchTab('inv',this)">
      <span class="tab-icon">üî¢</span>Ê£öÂç∏„Åó
    </div>
  </div>

  <!-- ===== BODY AREA ===== -->

  <div class="body-area">

```
<!-- SIDEBAR (PC only) -->
<nav class="sidebar">
  <div class="sidebar-item active" id="sidebar-in" onclick="switchTab('in', document.getElementById('tab-in'))">
    <span class="sidebar-icon">üì¶</span> ÂÖ•Â∫´
  </div>
  <div class="sidebar-item" id="sidebar-out" onclick="switchTab('out', document.getElementById('tab-out'))">
    <span class="sidebar-icon">üöõ</span> Âá∫Â∫´
  </div>
  <div class="sidebar-divider"></div>
  <div class="sidebar-item" id="sidebar-history" onclick="switchTab('history', document.getElementById('tab-history'))">
    <span class="sidebar-icon">üìã</span> Â±•Ê≠¥
  </div>
  <div class="sidebar-item tab-hold" id="sidebar-hold" onclick="switchTab('hold', document.getElementById('tab-hold'))">
    <span class="sidebar-icon">üö´</span> Âá∫Ëç∑ÂÅúÊ≠¢
  </div>
  <div class="sidebar-divider"></div>
  <div class="sidebar-item" id="sidebar-master" onclick="switchTab('master', document.getElementById('tab-master'))">
    <span class="sidebar-icon">‚öôÔ∏è</span> „Éû„Çπ„Çø„Éº
  </div>
  <div class="sidebar-divider"></div>
  <div class="sidebar-item" id="sidebar-inv" onclick="switchTab('inv', document.getElementById('tab-inv'))">
    <span class="sidebar-icon">üî¢</span> Ê£öÂç∏„Åó
  </div>
</nav>

<!-- MAIN CONTENT -->
<div class="main">

  <!-- ===== ÂÖ•Â∫´ ===== -->
  <div class="section active" id="sec-in">
    <div class="steps">
      <div class="step active" id="in-step1">‚ë† ÂìÅÁï™</div>
      <div class="step-arrow">‚ñ∂</div>
      <div class="step" id="in-step2">‚ë° Ê£öÁï™</div>
      <div class="step-arrow">‚ñ∂</div>
      <div class="step" id="in-step3">‚ë¢ Á¢∫ÂÆö</div>
    </div>

    <div class="selected-display">
      <div>
        <div class="sel-label">ÂìÅÁï™</div>
        <div class="sel-value" id="in-sel-item">‚Äî</div>
      </div>
      <div>
        <div class="sel-label">Ê£öÁï™</div>
        <div class="sel-value" id="in-sel-shelf">‚Äî</div>
      </div>
    </div>

    <div class="two-col-layout">
      <div class="two-col-left">
        <div class="scroll-area" id="sec-in-scroll">
          <div class="sec-label">ÂìÅÁï™ ‚Äî È†≠ÊñáÂ≠ó„ÅßÁµû„ÇäËæº„Åø</div>
          <div class="initial-grid" id="in-initial-grid"></div>

          <div class="item-panel" id="in-item-panel">
            <div class="item-panel-header">
              <div class="item-panel-label" id="in-panel-label">ÂìÅÁï™ÈÅ∏Êäû</div>
              <button class="back-btn" onclick="clearInInitial()">‚óÄ Êàª„Çã</button>
            </div>
            <div class="btn-grid" id="in-items-grid"></div>
          </div>

          <div class="sec-label">Ê£öÁï™ <span style="font-size:10px;color:var(--blue);-webkit-text-fill-color:var(--blue)">QR„Çπ„Ç≠„É£„É≥ÂèØ</span></div>
          <div class="qr-hint">üì∑ Ê£öÁï™QR„Çí„Çπ„Ç≠„É£„É≥„Åô„Çã„Å®Ëá™ÂãïÂÖ•Âäõ„Åï„Çå„Åæ„Åô</div>
          <div class="initial-grid" id="in-shelf-prefix-grid"></div>

          <div class="item-panel" id="in-shelf-panel">
            <div class="item-panel-header">
              <div class="item-panel-label" id="in-shelf-panel-label">Ê£öÁï™ÈÅ∏Êäû</div>
              <button class="back-btn" onclick="clearInShelfPrefix()">‚óÄ Êàª„Çã</button>
            </div>
            <div class="btn-grid" id="in-shelves-grid"></div>
          </div>
        </div>
      </div>

      <div class="two-col-right">
        <div class="status-panel">
          <div class="status-panel-title">üìä ÁèæÂú®„ÅÆÈÅ∏Êäû</div>
          <div class="status-row">
            <span class="status-key">ÂìÅÁï™</span>
            <span class="status-val" id="in-panel-item-val">‚Äî</span>
          </div>
          <div class="status-row">
            <span class="status-key">Ê£öÁï™</span>
            <span class="status-val green" id="in-panel-shelf-val">‚Äî</span>
          </div>
        </div>
        <div class="status-panel" id="in-stock-summary" style="flex:1;overflow-y:auto;">
          <div class="status-panel-title">üóÑÔ∏è Âú®Â∫´Ê¶ÇË¶Å</div>
          <div id="in-stock-mini"><div class="empty">Ë™≠„ÅøËæº„Åø‰∏≠...</div></div>
        </div>
      </div>
    </div>

    <div class="confirm-wrap">
      <button class="confirm-btn disabled" id="in-confirm"
        ontouchstart="startHold('in',event)" ontouchend="endHold('in')"
        onmousedown="startHold('in',event)" onmouseup="endHold('in')" onmouseleave="endHold('in')">
        <span>üîí Èï∑Êäº„Åó„ÅßÁ¢∫ÂÆö</span>
        <div class="progress-bar" id="in-progress"></div>
      </button>
      <div class="confirm-hint">1ÁßíÈñìÊäº„ÅóÁ∂ö„Åë„Å¶„Åè„Å†„Åï„ÅÑ</div>
    </div>
  </div>

  <!-- ===== Âá∫Â∫´ ===== -->
  <div class="section" id="sec-out">
    <div class="steps">
      <div class="step active" id="out-step1">‚ë† ÂìÅÁï™</div>
      <div class="step-arrow">‚ñ∂</div>
      <div class="step" id="out-step2">‚ë° Ê£öÁï™</div>
      <div class="step-arrow">‚ñ∂</div>
      <div class="step" id="out-step3">‚ë¢ Á¢∫ÂÆö</div>
    </div>

    <div class="selected-display">
      <div>
        <div class="sel-label">ÂìÅÁï™</div>
        <div class="sel-value" id="out-sel-item">‚Äî</div>
      </div>
      <div>
        <div class="sel-label">Ê£öÁï™</div>
        <div class="sel-value" id="out-sel-shelf">‚Äî</div>
      </div>
    </div>

    <div class="two-col-layout">
      <div class="two-col-left">
        <div class="scroll-area" id="sec-out-scroll">
          <div class="sec-label">ÂìÅÁï™ ‚Äî È†≠ÊñáÂ≠ó„ÅßÁµû„ÇäËæº„Åø</div>
          <div class="initial-grid" id="out-initial-grid"></div>

          <div class="item-panel" id="out-item-panel">
            <div class="item-panel-header">
              <div class="item-panel-label" id="out-panel-label">ÂìÅÁï™ÈÅ∏Êäû</div>
              <button class="back-btn" onclick="clearOutInitial()">‚óÄ Êàª„Çã</button>
            </div>
            <div class="btn-grid" id="out-items-grid"></div>
          </div>

          <div class="hold-warning" id="out-hold-warning">
            <div class="hold-warning-title">üö´ Âá∫Ëç∑ÂÅúÊ≠¢‰∏≠ ‚Äî Âá∫Â∫´„Åß„Åç„Åæ„Åõ„Çì</div>
            <div class="hold-warning-reason" id="out-hold-reason-text"></div>
            <div class="hold-warning-meta" id="out-hold-reason-meta"></div>
          </div>

          <div class="sec-label" id="out-shelf-label" style="display:none">
            ÂÄôË£úÊ£öÔºàÂÖàÂÖ•ÂÖàÂá∫„ÅóÈ†ÜÔºâ<span class="fifo-badge">FIFO</span>
          </div>
          <div class="btn-grid" id="out-shelves-grid"></div>
        </div>
      </div>

      <div class="two-col-right">
        <div class="status-panel">
          <div class="status-panel-title">üìä ÁèæÂú®„ÅÆÈÅ∏Êäû</div>
          <div class="status-row">
            <span class="status-key">ÂìÅÁï™</span>
            <span class="status-val" id="out-panel-item-val">‚Äî</span>
          </div>
          <div class="status-row">
            <span class="status-key">Ê£öÁï™</span>
            <span class="status-val green" id="out-panel-shelf-val">‚Äî</span>
          </div>
        </div>
        <div class="status-panel" id="out-hold-panel" style="display:none;">
          <div class="status-panel-title" style="color:var(--red);-webkit-text-fill-color:var(--red)">üö´ Âá∫Ëç∑ÂÅúÊ≠¢ÊÉÖÂ†±</div>
          <div id="out-hold-panel-content"></div>
        </div>
      </div>
    </div>

    <div class="confirm-wrap">
      <button class="confirm-btn disabled" id="out-confirm"
        ontouchstart="startHold('out',event)" ontouchend="endHold('out')"
        onmousedown="startHold('out',event)" onmouseup="endHold('out')" onmouseleave="endHold('out')">
        <span>üîí Èï∑Êäº„Åó„ÅßÁ¢∫ÂÆö</span>
        <div class="progress-bar" id="out-progress"></div>
      </button>
      <div class="confirm-hint">1ÁßíÈñìÊäº„ÅóÁ∂ö„Åë„Å¶„Åè„Å†„Åï„ÅÑ</div>
    </div>
  </div>

  <!-- ===== Â±•Ê≠¥ ===== -->
  <div class="section" id="sec-history">
    <div class="scroll-area" id="history-list"><div class="empty">Ë™≠„ÅøËæº„Åø‰∏≠...</div></div>
  </div>

  <!-- ===== Âá∫Ëç∑ÂÅúÊ≠¢ ===== -->
  <div class="section" id="sec-hold">
    <div class="steps">
      <div class="step step-red active" id="hold-step1">‚ë† ÂìÅÁï™</div>
      <div class="step-arrow">‚ñ∂</div>
      <div class="step step-red" id="hold-step2">‚ë° ÁêÜÁî±</div>
      <div class="step-arrow">‚ñ∂</div>
      <div class="step step-red" id="hold-step3">‚ë¢ ÂÅúÊ≠¢</div>
    </div>

    <div class="selected-display single-col">
      <div>
        <div class="sel-label">ÂØæË±°ÂìÅÁï™</div>
        <div class="sel-value red" id="hold-sel-item">‚Äî</div>
      </div>
    </div>

    <div class="two-col-layout">
      <div class="two-col-left">
        <div class="scroll-area" id="sec-hold-scroll">
          <div class="sec-label">ÂìÅÁï™ ‚Äî È†≠ÊñáÂ≠ó„ÅßÁµû„ÇäËæº„Åø</div>
          <div class="initial-grid" id="hold-initial-grid"></div>

          <div class="item-panel" id="hold-item-panel">
            <div class="item-panel-header">
              <div class="item-panel-label" id="hold-panel-label">ÂìÅÁï™ÈÅ∏Êäû</div>
              <button class="back-btn" onclick="clearHoldInitial()">‚óÄ Êàª„Çã</button>
            </div>
            <div class="btn-grid" id="hold-items-grid"></div>
          </div>

          <div class="reason-wrap" id="hold-reason-wrap">
            <div class="reason-label">ÂÅúÊ≠¢ÁêÜÁî±„ÇíÂÖ•Âäõ</div>
            <textarea class="reason-input" id="hold-reason-input"
              placeholder="‰æãÔºöÂ§ñË¶≥‰∏çÂÖ∑Âêà„ÄÄÈ°ßÂÆ¢„ÇØ„É¨„Éº„É†ÂØæÂøú‰∏≠„ÄÄÂìÅË≥™Á¢∫Ë™ç‰∏≠‚Ä¶"></textarea>
          </div>

          <div class="hold-divider">
            <div class="hold-divider-line"></div>
            <div class="hold-divider-label">üö´ ÁèæÂú®„ÅÆÂá∫Ëç∑ÂÅúÊ≠¢„É™„Çπ„Éà</div>
            <div class="hold-divider-line"></div>
          </div>
          <div id="hold-list-area"><div class="empty">Âá∫Ëç∑ÂÅúÊ≠¢‰∏≠„ÅÆÂìÅÁï™„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div></div>
        </div>
      </div>

      <div class="two-col-right">
        <div class="status-panel">
          <div class="status-panel-title">üö´ ÂÅúÊ≠¢ÂØæË±°</div>
          <div class="status-row">
            <span class="status-key">ÂìÅÁï™</span>
            <span class="status-val red" id="hold-panel-item-val">‚Äî</span>
          </div>
        </div>
      </div>
    </div>

    <div class="confirm-wrap">
      <button class="confirm-btn disabled" id="hold-confirm"
        ontouchstart="startHold('hold',event)" ontouchend="endHold('hold')"
        onmousedown="startHold('hold',event)" onmouseup="endHold('hold')" onmouseleave="endHold('hold')">
        <span>üö´ Èï∑Êäº„Åó„ÅßÂá∫Ëç∑ÂÅúÊ≠¢</span>
        <div class="progress-bar-red" id="hold-progress"></div>
      </button>
      <div class="confirm-hint">1ÁßíÈñìÊäº„ÅóÁ∂ö„Åë„Å¶„Åè„Å†„Åï„ÅÑ</div>
    </div>
  </div>

  <!-- ===== „Éû„Çπ„Çø„Éº ===== -->
  <div class="section" id="sec-master">
    <div class="scroll-area">
      <div class="master-card">
        <div class="master-title">üìã ÂìÅÁï™„Éû„Çπ„Çø„Éº</div>
        <div class="input-row">
          <input type="text" id="new-item" placeholder="ÂìÅÁï™„ÇíÂÖ•ÂäõÔºà‰æãÔºöSK012Ôºâ" autocapitalize="characters">
          <button class="add-btn" onclick="addItem()">ËøΩÂä†</button>
        </div>
        <div class="list-chips" id="item-list"></div>
      </div>

      <div class="master-card">
        <div class="master-title">üóÑÔ∏è Ê£öÁï™„Éû„Çπ„Çø„Éº</div>
        <div class="qr-hint">üì∑ Ê£öÁï™QR„Çí„Çπ„Ç≠„É£„É≥„Åô„Çã„Å®Ëá™ÂãïÂÖ•Âäõ„Åï„Çå„Åæ„Åô</div>
        <div class="input-row">
          <input type="text" id="new-shelf" placeholder="Ê£öÁï™„ÇíÂÖ•ÂäõÔºà‰æãÔºöA-01Ôºâ">
          <button class="add-btn" onclick="addShelf()">ËøΩÂä†</button>
        </div>
        <div class="list-chips" id="shelf-list"></div>
      </div>

      <div class="master-card">
        <div class="master-title">üìä Âú®Â∫´„Éá„Éº„Çø‰∏ÄË¶ß</div>
        <div class="scroll-list">
          <table class="stock-table">
            <thead>
              <tr><th>Ê£öÁï™</th><th>ÂìÅÁï™</th><th>ÂÖ•Â∫´Êó•ÊôÇ</th><th></th></tr>
            </thead>
            <tbody id="stock-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>


  <!-- ===== Ê£öÂç∏„Åó ===== -->
  <div class="section" id="sec-inv">
    <!-- „Çª„ÉÉ„Ç∑„Éß„É≥„Éê„Éä„Éº -->
    <div id="inv-session-banner" class="inv-session-banner">
      <!-- Êú™ÈñãÂßã / ÂÆå‰∫ÜÊôÇ: ÈÄöÂ∏∏„Éê„Éä„Éº -->
      <div id="inv-banner-idle">
        <div class="inv-session-header">
          <div>
            <div class="inv-session-title" id="inv-banner-title">üìã Ê£öÂç∏„Åó„Çª„ÉÉ„Ç∑„Éß„É≥</div>
            <div class="inv-session-meta" id="inv-banner-meta">„Çª„ÉÉ„Ç∑„Éß„É≥„Å™„Åó</div>
          </div>
          <button class="inv-btn-start" id="inv-btn-start" onclick="invStartSession()">‚ñ∂ ÈñãÂßã</button>
        </div>
      </div>
      <!-- ÈÄ≤Ë°å‰∏≠: „É°„Éº„Çø„Éº + ÁµÇ‰∫Ü„Éú„Çø„É≥„ÅÆ„Åø -->
      <div id="inv-banner-active" style="display:none">
        <div style="display:flex;align-items:center;gap:10px">
          <div class="inv-sync-indicator" id="inv-sync-indicator">
            <div class="inv-sync-dot"></div>ÂêåÊúü‰∏≠
          </div>
          <div style="flex:1;min-width:0">
            <div class="inv-progress-label">
              <span id="inv-progress-text">0 / 0 Ê£ö ÂÆå‰∫Ü</span>
              <span class="inv-progress-pct" id="inv-progress-pct">0%</span>
            </div>
            <div class="inv-progress-track" style="margin:4px 0 0">
              <div class="inv-progress-fill" id="inv-progress-fill" style="width:0%"></div>
            </div>
          </div>
          <button class="inv-btn-end" id="inv-btn-end" onclick="invEndSession()">ÁµÇ‰∫Ü</button>
        </div>
      </div>
    </div>

    <div class="two-col-layout">
      <div class="two-col-left">
        <div class="scroll-area" id="sec-inv-scroll">
          <!-- View switch tabs -->
          <div class="inv-tab-btns" id="inv-view-tabs">
            <button class="inv-tab-btn active" id="inv-vtab-shelves" onclick="invSwitchView('shelves')">üóÑÔ∏è Ê£ö‰∏ÄË¶ß</button>
            <button class="inv-tab-btn" id="inv-vtab-report" onclick="invSwitchView('report')">üìä „É¨„Éù„Éº„Éà</button>
          </div>

          <!-- Ê£ö„Ç∞„É™„ÉÉ„Éâ„Éì„É•„Éº -->
          <div id="inv-shelves-view">
            <div class="sec-label">Ê£öÁï™„Çí„Çø„ÉÉ„Éó „Åæ„Åü„ÅØ QR„Çπ„Ç≠„É£„É≥„ÅßÂÖ•Âäõ <span style="font-size:10px;color:var(--blue);-webkit-text-fill-color:var(--blue)">QR„Çπ„Ç≠„É£„É≥ÂèØ</span></div>
            <div id="inv-shelf-grid" class="inv-shelf-grid"></div>
          </div>

          <!-- „É¨„Éù„Éº„Éà„Éì„É•„Éº -->
          <div id="inv-report-view" style="display:none">
            <div class="inv-report-card">
              <div class="inv-report-title">üì¶ ÂìÅÁï™Âà• Á∑èÊï∞</div>
              <div id="inv-report-products"><div class="empty">„Éá„Éº„Çø„Å™„Åó</div></div>
            </div>
            <div class="inv-report-card" id="inv-discrepancy-card" style="display:none">
              <div class="inv-report-title" style="color:var(--red);-webkit-text-fill-color:var(--red)">‚ö†Ô∏è Â∑ÆÁï∞‰∏ÄË¶ß</div>
              <div id="inv-report-discrepancies"></div>
            </div>
            <div class="inv-report-card">
              <div class="inv-report-title">üìã „Çµ„Éû„É™„Éº</div>
              <div id="inv-report-summary"></div>
            </div>
          </div>

        </div>
      </div>

      <!-- Âè≥„Éë„Éç„É´ÔºöÂÖ•Âäõ„Éï„Ç©„Éº„É† -->
      <div class="two-col-right" id="inv-right-panel">
        <div class="inv-entry-panel visible" id="inv-entry-panel-right">
          <div class="inv-entry-title">
            <span>üî¢ ÂÖ•Âäõ„Éë„Éç„É´</span>
          </div>
          <div id="inv-entry-inner-right"><div class="empty" style="padding:30px 0">Ê£ö„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div></div>
        </div>
      </div>
    </div>

    <!-- „É¢„Éê„Ç§„É´Áî®ÂÖ•Âäõ„Éë„Éç„É´Ôºà‰∏ãÈÉ®Ôºâ -->
    <div class="inv-entry-panel" id="inv-entry-panel-mobile">
      <div class="inv-entry-title">
        <span id="inv-mobile-panel-title">üî¢ Ê£ö„ÅÆÁ¢∫Ë™ç</span>
        <button class="back-btn" onclick="invCloseEntry()">‚úï Èñâ„Åò„Çã</button>
      </div>
      <div id="inv-entry-inner-mobile"></div>
    </div>
  </div>

</div><!-- /main -->
```

  </div><!-- /body-area -->

</div><!-- /app-wrapper -->

<div class="toast" id="toast"></div>

<script>
/* ===================== Áä∂ÊÖã ===================== */
let inState   = { initial: null, item: null, shelfPrefix: null, shelf: null };
let outState  = { initial: null, item: null, shelfPrefix: null, shelf: null };
let holdState = { initial: null, item: null };
let holdTimer = null;
let currentTab = 'in';

let cachedItems   = [];
let cachedShelves = [];
let cachedStock   = [];
let cachedHolds   = [];

/* ===================== iOS/QRÂÖ•ÂäõÂØæÁ≠ñ ===================== */
function focusScanInput(){
  const el = document.getElementById('scanInput');
  if(!el) return;
  try { el.focus({ preventScroll:true }); } catch(e){ try{ el.focus(); }catch(_){ } }
}
setTimeout(focusScanInput, 200);
document.addEventListener('touchstart', () => {
  const a = document.activeElement;
  if(a && (a.tagName === 'TEXTAREA' || (a.tagName === 'INPUT' && a.id !== 'scanInput'))) return;
  focusScanInput();
}, { passive:true });

/* ===================== QR „Çπ„Ç≠„É£„É≥ ===================== */
let qrBuffer = '';
let qrTimer = null;
const IDLE_MS = 150;

document.addEventListener('keydown', e => {
  const active = document.activeElement;
  const isInput = active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA');
  if(isInput && active.id !== 'scanInput') return;
  if(e.key === 'Enter' || e.key === 'Tab'){ flushQRBuffer(); return; }
  if(e.key && e.key.length === 1){
    qrBuffer += e.key;
    clearTimeout(qrTimer);
    qrTimer = setTimeout(flushQRBuffer, IDLE_MS);
  }
});

function flushQRBuffer(){
  clearTimeout(qrTimer);
  const raw = (qrBuffer || '').trim();
  qrBuffer = '';
  if(!raw) return;
  processQR(raw);
}

function processQR(raw){
  if(currentTab === 'in'){
    selectInShelf(raw);
    showToast(`Ê£öÁï™ QR: ${raw}`, '');
  } else if(currentTab === 'inv'){
    if(cachedShelves.includes(raw)){
      invSelectShelf(raw);
      showToast(`Ê£öÁï™ QR: ${raw}`, '');
    } else {
      showToast(`Ê£öÁï™Êú™ÁôªÈå≤: ${raw}`, 'error');
    }
  } else if(currentTab === 'master'){
    const el = document.getElementById('new-shelf');
    if(el) el.value = raw;
    showToast(`Ê£öÁï™ QR: ${raw}`, '');
  }
}

/* ===================== ÊôÇË®à ===================== */
function updateClock(){
  const n = new Date();
  const clock = document.getElementById('clock');
  if(!clock) return;
  clock.textContent =
    n.toLocaleDateString('ja-JP') + ' ' +
    n.toLocaleTimeString('ja-JP', { hour:'2-digit', minute:'2-digit' });
}
setInterval(updateClock, 1000);
updateClock();

/* ===================== „Çø„ÉñÂàáÊõø ===================== */
function switchTab(tab, el){
  currentTab = tab;
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.sidebar-item').forEach(s => s.classList.remove('active'));

  document.getElementById('sec-' + tab).classList.add('active');
  if(el) el.classList.add('active');

  // sync sidebar
  const sidebarEl = document.getElementById('sidebar-' + tab);
  if(sidebarEl) sidebarEl.classList.add('active');

  if(tab === 'in')      { loadCache().then(() => { renderIn(); renderInStockMini(); }); }
  if(tab === 'out')     { loadCache().then(renderOut); }
  if(tab === 'history') { renderHistory(); }
  if(tab === 'hold')    { loadCache().then(renderHold); }
  if(tab === 'master')  { loadCache().then(renderMaster); }
  if(tab !== 'inv') { invStopPolling(); }
  if(tab === 'inv')     { loadCache().then(renderInv); }

  setTimeout(focusScanInput, 50);
}

/* ===================== „Ç≠„É£„ÉÉ„Ç∑„É• ===================== */
async function loadCache(){
  try{
    const [items, shelves, stock, holds] = await Promise.all([
      window.__getAllItemMasters  ? window.__getAllItemMasters()  : Promise.resolve([]),
      window.__getAllShelfMasters ? window.__getAllShelfMasters() : Promise.resolve([]),
      window.__getAllShelves      ? window.__getAllShelves()      : Promise.resolve([]),
      window.__getAllHolds        ? window.__getAllHolds()        : Promise.resolve([])
    ]);
    cachedItems   = (items || []).map(i => i.itemId).filter(Boolean).sort();
    cachedShelves = (shelves || []).map(s => s.shelfId).filter(Boolean).sort();
    cachedStock   = (stock || []).filter(s => s && s.status === 'occupied');
    cachedHolds   = (holds || []);
  }catch(e){ console.error(e); }
}

/* ===================== „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ===================== */
function escHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}
function escJsSingle(s){
  return String(s ?? "")
    .replace(/\\/g, "\\\\")
    .replace(/'/g, "\\'")
    .replace(/\n/g, "\\n")
    .replace(/\r/g, "");
}
function formatTime(ts){
  const d = ts ? new Date(ts) : null;
  if(!d) return '-';
  const pad = n => String(n).padStart(2,'0');
  return `${d.getMonth()+1}/${d.getDate()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function scrollToEl(targetId, areaId){
  setTimeout(()=>{
    const target = document.getElementById(targetId);
    const area   = document.getElementById(areaId);
    if(!target || !area) return;
    const areaTop   = area.getBoundingClientRect().top;
    const targetTop = target.getBoundingClientRect().top;
    area.scrollTop += (targetTop - areaTop) - 8;
  }, 50);
}
function getShelfPrefix(shelfId){
  const m = String(shelfId).match(/^(.+?)-/);
  return m ? m[1] : String(shelfId).charAt(0);
}
function getShelfPrefixes(shelves){
  const map = {};
  for(const s of shelves){ const p = getShelfPrefix(s); map[p] = (map[p]||0) + 1; }
  return Object.entries(map).sort((a,b) => a[0].localeCompare(b[0]));
}
function getInitials(items){
  const map = {};
  for(const item of items){ const ch = String(item).charAt(0).toUpperCase(); map[ch] = (map[ch]||0) + 1; }
  return Object.entries(map).sort((a,b) => a[0].localeCompare(b[0]));
}
function isOnHold(itemId){
  return cachedHolds.find(h => h.itemId === itemId) || null;
}

/* ===================== STEP Êõ¥Êñ∞ ===================== */
function updateInSteps(){
  const s = inState;
  document.getElementById('in-step1').className = 'step ' + (s.item ? 'done' : 'active');
  document.getElementById('in-step2').className = 'step ' + (!s.item ? '' : s.shelf ? 'done' : 'active');
  document.getElementById('in-step3').className = 'step ' + (s.item && s.shelf ? 'active' : '');
  const btn = document.getElementById('in-confirm');
  if(s.item && s.shelf){ btn.classList.remove('disabled'); btn.classList.add('ready'); }
  else { btn.classList.add('disabled'); btn.classList.remove('ready'); }
  // Âè≥„Éë„Éç„É´Êõ¥Êñ∞
  const ip = document.getElementById('in-panel-item-val');
  const sp = document.getElementById('in-panel-shelf-val');
  if(ip) ip.textContent = s.item || '‚Äî';
  if(sp) sp.textContent = s.shelf || '‚Äî';
}
function updateOutSteps(){
  const s = outState;
  const hold = s.item ? isOnHold(s.item) : null;
  document.getElementById('out-step1').className = 'step ' + (s.item ? 'done' : 'active');
  document.getElementById('out-step2').className = 'step ' + (!s.item ? '' : s.shelf ? 'done' : 'active');
  document.getElementById('out-step3').className = 'step ' + (s.item && s.shelf && !hold ? 'active' : '');
  const btn = document.getElementById('out-confirm');
  if(s.item && s.shelf && !hold){ btn.classList.remove('disabled'); btn.classList.add('ready'); }
  else { btn.classList.add('disabled'); btn.classList.remove('ready'); }
  // Âè≥„Éë„Éç„É´
  const ip = document.getElementById('out-panel-item-val');
  const sp = document.getElementById('out-panel-shelf-val');
  if(ip) ip.textContent = s.item || '‚Äî';
  if(sp) sp.textContent = s.shelf || '‚Äî';
  // hold panel
  const hp = document.getElementById('out-hold-panel');
  const hc = document.getElementById('out-hold-panel-content');
  if(hold && hp){
    hp.style.display = 'block';
    if(hc) hc.innerHTML = `<div style="font-size:12px;color:var(--text);-webkit-text-fill-color:var(--text);margin-top:6px;">${escHtml(hold.reason||'ÁêÜÁî±Êú™Ë®òÂÖ•')}</div>`;
  } else if(hp){
    hp.style.display = 'none';
  }
}
function updateHoldSteps(){
  const s = holdState;
  const hasReason = (document.getElementById('hold-reason-input')?.value.trim() || '').length > 0;
  document.getElementById('hold-step1').className = 'step step-red ' + (s.item ? 'done' : 'active');
  document.getElementById('hold-step2').className = 'step step-red ' + (!s.item ? '' : hasReason ? 'done' : 'active');
  document.getElementById('hold-step3').className = 'step step-red ' + (s.item && hasReason ? 'active' : '');
  const btn = document.getElementById('hold-confirm');
  if(s.item && hasReason){ btn.classList.remove('disabled'); btn.classList.add('ready-red'); }
  else { btn.classList.add('disabled'); btn.classList.remove('ready-red'); }
  // Âè≥„Éë„Éç„É´
  const ip = document.getElementById('hold-panel-item-val');
  if(ip) ip.textContent = s.item || '‚Äî';
}

/* ===================== Âú®Â∫´„Éü„ÉãË°®Á§∫ÔºàÂÖ•Â∫´Âè≥„Éë„Éç„É´Ôºâ ===================== */
function renderInStockMini(){
  const el = document.getElementById('in-stock-mini');
  if(!el) return;
  // Ê£ö„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ„Åó„Å¶Ë°®Á§∫
  const shelfMap = {};
  for(const s of cachedStock){
    if(!shelfMap[s.shelfId]) shelfMap[s.shelfId] = [];
    shelfMap[s.shelfId].push(s.productId);
  }
  const shelfEntries = Object.entries(shelfMap).sort((a,b) => a[0].localeCompare(b[0])).slice(0,8);
  if(!shelfEntries.length){ el.innerHTML = '<div class="empty">Âú®Â∫´„Å™„Åó</div>'; return; }
  el.innerHTML = shelfEntries.map(([shelfId, products]) =>
    `<div class="status-row">
      <span class="status-key" style="font-family:'Rajdhani',sans-serif;font-size:14px;">${escHtml(shelfId)}</span>
      <span style="font-size:11px;font-weight:700;color:var(--accent);-webkit-text-fill-color:var(--accent);text-align:right;max-width:120px;overflow:hidden;text-overflow:ellipsis;">${escHtml(products.join(' / '))}</span>
    </div>`
  ).join('') + (Object.keys(shelfMap).length > 8 ? `<div style="font-size:11px;color:var(--muted);text-align:center;padding:6px 0">‰ªñ${Object.keys(shelfMap).length-8}Ê£ö</div>` : '');
}

/* ===================== ÂÖ•Â∫´ RENDER ===================== */
function renderIn(){
  const ig = document.getElementById('in-initial-grid');
  const panel = document.getElementById('in-item-panel');

  if(!cachedItems.length){
    ig.innerHTML = '<div class="empty">ÂìÅÁï™„ÅåÊú™ÁôªÈå≤„Åß„ÅôÔºà„Éû„Çπ„Çø„Éº„ÅßËøΩÂä†Ôºâ</div>';
    panel.classList.remove('visible');
  } else {
    const initials = getInitials(cachedItems);
    ig.innerHTML = initials.map(([ch, cnt]) =>
      `<button class="initial-btn ${inState.initial===ch?'selected':''}" onclick="selectInInitial('${escJsSingle(ch)}')">
        ${escHtml(ch)}<span class="count">${cnt}‰ª∂</span>
      </button>`
    ).join('');
    if(inState.initial){
      panel.classList.add('visible');
      document.getElementById('in-panel-label').textContent = `„Äå${inState.initial}„Äç„ÅÆÂìÅÁï™`;
      const filtered = cachedItems.filter(i => i.charAt(0).toUpperCase() === inState.initial);
      document.getElementById('in-items-grid').innerHTML = filtered.map(item =>
        `<button class="item-btn ${inState.item===item?'selected':''}" onclick="selectInItem('${escJsSingle(item)}')">${escHtml(item)}</button>`
      ).join('');
    } else {
      panel.classList.remove('visible');
    }
  }

  const spg = document.getElementById('in-shelf-prefix-grid');
  const shelfPanel = document.getElementById('in-shelf-panel');
  const sg = document.getElementById('in-shelves-grid');

  if(!cachedShelves.length){
    spg.innerHTML = '<div class="empty">Ê£öÁï™„ÅåÊú™ÁôªÈå≤„Åß„ÅôÔºà„Éû„Çπ„Çø„Éº„ÅßËøΩÂä†Ôºâ</div>';
    shelfPanel.classList.remove('visible');
  } else {
    const prefixes = getShelfPrefixes(cachedShelves);
    const occupiedSetPfx = new Set(cachedStock.map(s => s.shelfId));
    spg.innerHTML = prefixes.map(([p, cnt]) => {
      const emptyCnt = cachedShelves.filter(s => getShelfPrefix(s) === p && !occupiedSetPfx.has(s)).length;
      const isFull = emptyCnt === 0;
      const isSelected = inState.shelfPrefix === p;
      const emptyPct = Math.round((emptyCnt / cnt) * 100);
      const stateClass = isSelected ? 'selected' : (isFull ? 'is-full' : 'has-empty');
      const label = isFull ? `ÂÖ®${cnt}Ê£ö Ê∫Ä` : `Á©∫„Åç ${emptyCnt}/${cnt}Ê£ö`;
      return `<button class="shelf-prefix-btn ${stateClass}" onclick="selectInShelfPrefix('${escJsSingle(p)}')">
        <span>${escHtml(p)}</span>
        <span class="spb-label">${label}</span>
        <div class="spb-bar-wrap"><div class="spb-bar-fill" style="width:${emptyPct}%"></div></div>
      </button>`;
    }).join('');
    if(inState.shelfPrefix){
      shelfPanel.classList.add('visible');
      document.getElementById('in-shelf-panel-label').textContent = `„Äå${inState.shelfPrefix}-„Äç„ÅÆÊ£öÁï™`;
      const filtered = cachedShelves.filter(s => getShelfPrefix(s) === inState.shelfPrefix);
      const occupiedSet = new Set(cachedStock.map(s => s.shelfId));
      // Á©∫„ÅçÊ£ö„ÇíÂÖàÈ†≠„Å´‰∏¶„Åπ„Çã
      const sortedShelves = [...filtered].sort((a,b) => {
        const aOcc = occupiedSet.has(a) ? 1 : 0;
        const bOcc = occupiedSet.has(b) ? 1 : 0;
        return aOcc - bOcc || a.localeCompare(b);
      });
      sg.innerHTML = sortedShelves.map(shelf => {
        const isOccupied = occupiedSet.has(shelf);
        const stockItems = isOccupied ? cachedStock.filter(s => s.shelfId === shelf) : [];
        const stateClass = inState.shelf===shelf ? 'selected' : (isOccupied ? 'shelf-occupied-in' : 'shelf-empty');
        const prodLabel = stockItems.map(s => s.productId).filter(Boolean).join(' / ');
        const sub = isOccupied && prodLabel
          ? `<span class="item-btn-sub">${escHtml(prodLabel)}</span>`
          : (!isOccupied ? `<span class="item-btn-sub" style="color:var(--green);-webkit-text-fill-color:var(--green)">Á©∫„Åç</span>` : '');
        return `<button class="item-btn ${stateClass}" onclick="selectInShelf('${escJsSingle(shelf)}')">${escHtml(shelf)}${sub}</button>`;
      }).join('');
    } else {
      shelfPanel.classList.remove('visible');
      sg.innerHTML = '';
    }
  }

  document.getElementById('in-sel-item').textContent  = inState.item  || '‚Äî';
  document.getElementById('in-sel-shelf').textContent = inState.shelf || '‚Äî';
  updateInSteps();
}
function selectInInitial(ch){
  inState.initial = ch;
  if(inState.item && inState.item.charAt(0).toUpperCase() !== ch) inState.item = null;
  renderIn();
  scrollToEl('in-item-panel', 'sec-in-scroll');
}
function clearInInitial(){ inState.initial = null; inState.item = null; renderIn(); }
function selectInItem(item){
  inState.item = item;
  renderIn();
  scrollToEl('in-shelf-prefix-grid', 'sec-in-scroll');
}
function selectInShelfPrefix(p){
  inState.shelfPrefix = p;
  if(inState.shelf && getShelfPrefix(inState.shelf) !== p) inState.shelf = null;
  renderIn();
  scrollToEl('in-shelf-panel', 'sec-in-scroll');
}
function clearInShelfPrefix(){ inState.shelfPrefix = null; inState.shelf = null; renderIn(); }
function selectInShelf(shelf){
  inState.shelf = shelf;
  document.querySelectorAll('#in-shelves-grid .item-btn').forEach(b => {
    b.classList.toggle('selected', b.textContent.trim().startsWith(shelf));
  });
  document.getElementById('in-sel-shelf').textContent = shelf;
  updateInSteps();
}

/* ===================== Âá∫Â∫´ RENDER ===================== */
function renderOut(){
  const ig = document.getElementById('out-initial-grid');
  const panel = document.getElementById('out-item-panel');

  if(!cachedItems.length){
    ig.innerHTML = '<div class="empty">ÂìÅÁï™„ÅåÊú™ÁôªÈå≤„Åß„ÅôÔºà„Éû„Çπ„Çø„Éº„ÅßËøΩÂä†Ôºâ</div>';
    panel.classList.remove('visible');
  } else {
    const initials = getInitials(cachedItems);
    ig.innerHTML = initials.map(([ch, cnt]) =>
      `<button class="initial-btn ${outState.initial===ch?'selected':''}" onclick="selectOutInitial('${escJsSingle(ch)}')">
        ${escHtml(ch)}<span class="count">${cnt}‰ª∂</span>
      </button>`
    ).join('');

    if(outState.initial){
      panel.classList.add('visible');
      document.getElementById('out-panel-label').textContent = `„Äå${outState.initial}„Äç„ÅÆÂìÅÁï™`;
      const filtered = cachedItems.filter(i => i.charAt(0).toUpperCase() === outState.initial);
      document.getElementById('out-items-grid').innerHTML = filtered.map(item => {
        const hold = isOnHold(item);
        return `<button class="item-btn ${outState.item===item?'selected':''} ${hold?'hold-badge':''}"
          onclick="selectOutItem('${escJsSingle(item)}')">${escHtml(item)}</button>`;
      }).join('');
    } else {
      panel.classList.remove('visible');
    }
  }

  const warning = document.getElementById('out-hold-warning');
  const hold = outState.item ? isOnHold(outState.item) : null;
  if(hold){
    warning.classList.add('visible');
    document.getElementById('out-hold-reason-text').textContent = `ÁêÜÁî±Ôºö${hold.reason || 'ÔºàÁêÜÁî±Êú™Ë®òÂÖ•Ôºâ'}`;
    document.getElementById('out-hold-reason-meta').textContent = `ÂÅúÊ≠¢ÁôªÈå≤Ôºö${formatTime(hold.stoppedAtMs)}`;
  } else {
    warning.classList.remove('visible');
  }

  const sgrid = document.getElementById('out-shelves-grid');
  const label = document.getElementById('out-shelf-label');

  if(outState.item && !hold){
    label.style.display = 'flex';
    // Âêå‰∏ÄÊ£ö„Å´Âêå„ÅòÂìÅÁï™„ÅåË§áÊï∞„ÅÇ„ÇãÂ†¥Âêà„ÅØÊúÄÂè§„Çí‰ª£Ë°®„Å´ÔºàFIFOÔºâ
    const candidateMap = {};
    for(const s of cachedStock.filter(s => s.productId === outState.item)){
      if(!candidateMap[s.shelfId] || (s.inboundAtMs||0) < (candidateMap[s.shelfId].inboundAtMs||0)){
        candidateMap[s.shelfId] = s;
      }
    }
    const candidates = Object.values(candidateMap).sort((a,b) => (a.inboundAtMs||0) - (b.inboundAtMs||0));
    if(!candidates.length){
      sgrid.innerHTML = '<div class="empty">„Åì„ÅÆÂìÅÁï™„ÅÆÂú®Â∫´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
    } else {
      sgrid.innerHTML = candidates.map((c, i) =>
        `<button class="item-btn shelf-recommend ${outState.shelf===c.shelfId?'selected':''}"
          data-rank="${i+1}"
          onclick="selectOutShelf('${escJsSingle(c.shelfId)}')">
          ${escHtml(c.shelfId)}<span class="item-btn-sub">${escHtml(formatTime(c.inboundAt))}</span>
        </button>`
      ).join('');
    }
  } else {
    label.style.display = 'none';
    sgrid.innerHTML = '';
  }

  document.getElementById('out-sel-item').textContent  = outState.item  || '‚Äî';
  document.getElementById('out-sel-shelf').textContent = outState.shelf || '‚Äî';
  updateOutSteps();
}
function selectOutInitial(ch){
  outState.initial = ch;
  if(outState.item && outState.item.charAt(0).toUpperCase() !== ch){ outState.item = null; outState.shelf = null; }
  renderOut();
}
function clearOutInitial(){ outState.initial = null; outState.item = null; outState.shelf = null; renderOut(); }
function selectOutItem(item){
  outState.item = item;
  outState.shelf = null;
  renderOut();
  const hold = isOnHold(item);
  if(hold) scrollToEl('out-hold-warning', 'sec-out-scroll');
  else scrollToEl('out-shelf-label', 'sec-out-scroll');
}
function selectOutShelf(shelf){ outState.shelf = shelf; renderOut(); }

/* ===================== Âá∫Ëç∑ÂÅúÊ≠¢ RENDER ===================== */
function renderHold(){
  const ig = document.getElementById('hold-initial-grid');
  const panel = document.getElementById('hold-item-panel');
  const reasonWrap = document.getElementById('hold-reason-wrap');

  if(!cachedItems.length){
    ig.innerHTML = '<div class="empty">ÂìÅÁï™„ÅåÊú™ÁôªÈå≤„Åß„ÅôÔºà„Éû„Çπ„Çø„Éº„ÅßËøΩÂä†Ôºâ</div>';
    panel.classList.remove('visible');
  } else {
    const initials = getInitials(cachedItems);
    ig.innerHTML = initials.map(([ch, cnt]) =>
      `<button class="initial-btn ${holdState.initial===ch?'selected-red':''}" onclick="selectHoldInitial('${escJsSingle(ch)}')">
        ${escHtml(ch)}<span class="count">${cnt}‰ª∂</span>
      </button>`
    ).join('');

    if(holdState.initial){
      panel.classList.add('visible');
      document.getElementById('hold-panel-label').textContent = `„Äå${holdState.initial}„Äç„ÅÆÂìÅÁï™`;
      const filtered = cachedItems.filter(i => i.charAt(0).toUpperCase() === holdState.initial);
      document.getElementById('hold-items-grid').innerHTML = filtered.map(item => {
        const hold = isOnHold(item);
        return `<button class="item-btn ${holdState.item===item?'selected-red':''} ${hold?'hold-badge':''}"
          onclick="selectHoldItem('${escJsSingle(item)}')">${escHtml(item)}</button>`;
      }).join('');
    } else {
      panel.classList.remove('visible');
    }
  }

  document.getElementById('hold-sel-item').textContent = holdState.item || '‚Äî';
  if(holdState.item) reasonWrap.classList.add('visible');
  else reasonWrap.classList.remove('visible');

  renderHoldList();
  updateHoldSteps();
}
function renderHoldList(){
  const area = document.getElementById('hold-list-area');
  if(!cachedHolds.length){
    area.innerHTML = '<div class="empty">Âá∫Ëç∑ÂÅúÊ≠¢‰∏≠„ÅÆÂìÅÁï™„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
    return;
  }
  const sorted = [...cachedHolds].sort((a,b) => (b.stoppedAtMs||0) - (a.stoppedAtMs||0));
  area.innerHTML = sorted.map(h =>
    `<div class="hold-list-item">
      <div class="hold-list-item-info">
        <div class="hold-list-item-id">${escHtml(h.itemId)}</div>
        <div class="hold-list-item-reason">üìù ${escHtml(h.reason || 'ÁêÜÁî±Êú™Ë®òÂÖ•')}</div>
        <div class="hold-list-item-date">üïê ${escHtml(formatTime(h.stoppedAtMs))}</div>
      </div>
      <button class="release-btn" onclick="releaseHold('${escJsSingle(h.itemId)}')">‚úÖ Ëß£Èô§</button>
    </div>`
  ).join('');
}
function selectHoldInitial(ch){
  holdState.initial = ch;
  if(holdState.item && holdState.item.charAt(0).toUpperCase() !== ch) holdState.item = null;
  renderHold();
  scrollToEl('hold-item-panel', 'sec-hold-scroll');
}
function clearHoldInitial(){ holdState.initial = null; holdState.item = null; renderHold(); }
function selectHoldItem(item){
  holdState.item = item;
  renderHold();
  scrollToEl('hold-reason-wrap', 'sec-hold-scroll');
  setTimeout(() => document.getElementById('hold-reason-input')?.focus(), 100);
}
document.getElementById('hold-reason-input').addEventListener('input', updateHoldSteps);

/* ===================== Èï∑Êäº„ÅóÁ¢∫ÂÆö ===================== */
function startHold(mode, e){
  e.preventDefault();
  const btn = document.getElementById(mode + '-confirm');
  if(btn.classList.contains('disabled')) return;
  const prog = document.getElementById(mode + '-progress');
  btn.classList.add(mode === 'hold' ? 'pressing-red' : 'pressing');
  prog.style.transition = 'width 1000ms linear';
  prog.style.width = '100%';
  holdTimer = setTimeout(() => { endHold(mode); doConfirm(mode); }, 1000);
}
function endHold(mode){
  clearTimeout(holdTimer);
  const btn = document.getElementById(mode + '-confirm');
  const prog = document.getElementById(mode + '-progress');
  btn.classList.remove('pressing');
  btn.classList.remove('pressing-red');
  prog.style.transition = 'width 0.2s ease';
  prog.style.width = '0%';
}

/* ===================== Á¢∫ÂÆöÂá¶ÁêÜ ===================== */
async function doConfirm(mode){
  if(!window.__saveShelfItem && (mode === 'in' || mode === 'out')){
    showToast('FirebaseÊú™Êé•Á∂öÔºà‰øùÂ≠ò„Åß„Åç„Åæ„Åõ„ÇìÔºâ', 'error'); return;
  }
  if(!window.__saveHold && mode === 'hold'){
    showToast('FirebaseÊú™Êé•Á∂öÔºà‰øùÂ≠ò„Åß„Åç„Åæ„Åõ„ÇìÔºâ', 'error'); return;
  }

  if(mode === 'in'){
    const { item, shelf } = inState;
    if(!item || !shelf) return;
    const now = new Date().toISOString();
    try{
      await window.__addShelfItem(shelf, {
        shelfId: shelf, productId: item, productQRRaw: item,
        inboundAt: now, inboundAtMs: Date.now(), status: 'occupied', updatedAt: now
      });
      if(window.__addHistory){
        window.__addHistory({ type:'inbound', shelfId: shelf, productId: item, at: now, atMs: Date.now() }).catch(()=>{});
      }
      showToast(`‚úÖ ÂÖ•Â∫´Ôºö${item} ‚Üí Ê£ö ${shelf}`);
      inState = { initial: null, item: null, shelfPrefix: null, shelf: null };
      await loadCache(); renderIn(); renderInStockMini();
    }catch(e){ console.error(e); showToast('‰øùÂ≠ò„Ç®„É©„Éº', 'error'); }

  } else if(mode === 'out'){
    const { item, shelf } = outState;
    if(!item || !shelf) return;
    if(isOnHold(item)){ showToast('Âá∫Ëç∑ÂÅúÊ≠¢‰∏≠„ÅÆ„Åü„ÇÅÂá∫Â∫´„Åß„Åç„Åæ„Åõ„Çì', 'error'); return; }
    const now = new Date().toISOString();
    try{
      await window.__deleteShelfItemByProduct(shelf, item);
      if(window.__addHistory){
        window.__addHistory({ type:'empty', shelfId: shelf, productId: item, at: now, atMs: Date.now() }).catch(()=>{});
      }
      showToast(`‚úÖ Âá∫Â∫´ÔºöÊ£ö ${shelf} ‚Üí ${item}`);
      outState = { initial: null, item: null, shelfPrefix: null, shelf: null };
      await loadCache(); renderOut();
    }catch(e){ console.error(e); showToast('‰øùÂ≠ò„Ç®„É©„Éº', 'error'); }

  } else if(mode === 'hold'){
    const { item } = holdState;
    const reason = document.getElementById('hold-reason-input').value.trim();
    if(!item || !reason) return;
    if(isOnHold(item)){ showToast(`${item} „ÅØÊó¢„Å´ÂÅúÊ≠¢‰∏≠„Åß„Åô`, 'error'); return; }
    const now = new Date().toISOString();
    try{
      await window.__saveHold(item, { itemId: item, reason, stoppedAt: now, stoppedAtMs: Date.now() });
      showToast(`üö´ ${item} „ÇíÂá∫Ëç∑ÂÅúÊ≠¢„Åó„Åæ„Åó„Åü`);
      holdState = { initial: null, item: null };
      document.getElementById('hold-reason-input').value = '';
      await loadCache(); renderHold();
    }catch(e){ console.error(e); showToast('‰øùÂ≠ò„Ç®„É©„Éº', 'error'); }
  }
}

/* ===================== ÂÅúÊ≠¢Ëß£Èô§ ===================== */
async function releaseHold(itemId){
  if(!confirm(`„Äå${itemId}„Äç„ÅÆÂá∫Ëç∑ÂÅúÊ≠¢„ÇíËß£Èô§„Åó„Åæ„Åô„ÅãÔºü`)) return;
  try{
    await window.__deleteHold(itemId);
    showToast(`‚úÖ ${itemId} „ÅÆÂá∫Ëç∑ÂÅúÊ≠¢„ÇíËß£Èô§„Åó„Åæ„Åó„Åü`);
    await loadCache();
    renderHoldList();
    if(currentTab === 'out') renderOut();
  }catch(e){ console.error(e); showToast('Ëß£Èô§„Ç®„É©„Éº', 'error'); }
}

/* ===================== Â±•Ê≠¥ ===================== */
async function renderHistory(){
  const list = document.getElementById('history-list');
  list.innerHTML = '<div class="empty">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';
  try{
    let items = [];
    if(window.__getHistory) items = await window.__getHistory();
    items.sort((a,b) => (b.atMs||0) - (a.atMs||0));
    if(!items.length){ list.innerHTML = '<div class="empty">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>'; return; }
    list.innerHTML = items.map(item => {
      const icon = item.type === 'inbound' ? 'üì¶' : 'üöõ';
      const product = item.type === 'inbound'
        ? `<div class="history-product">${escHtml(item.productId||'-')}</div>
           <div class="history-shelf">‚Üí Ê£ö: ${escHtml(item.shelfId||'-')}</div>`
        : `<div class="history-product" style="color:var(--red);-webkit-text-fill-color:var(--red)">${escHtml(item.productId||'Á©∫„ÅçÁôªÈå≤')}</div>
           <div class="history-shelf">Ê£ö: ${escHtml(item.shelfId||'-')} „ÇíÂá∫Â∫´</div>`;
      return `<div class="history-item">
        <div class="history-icon">${icon}</div>
        <div class="history-info">${product}</div>
        <div class="history-date">${escHtml(formatTime(item.atMs))}</div>
      </div>`;
    }).join('');
  }catch(e){ console.error(e); list.innerHTML = '<div class="empty">Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº</div>'; }
}

/* ===================== „Éû„Çπ„Çø„Éº ===================== */
function renderMaster(){
  const il = document.getElementById('item-list');
  if(!cachedItems.length){
    il.innerHTML = '<span style="color:var(--muted);font-size:12px">Êú™ÁôªÈå≤</span>';
  } else {
    il.innerHTML = cachedItems.map(item =>
      `<div class="list-chip">${escHtml(item)}<button class="del-btn" onclick="removeItem('${escJsSingle(item)}')">‚úï</button></div>`
    ).join('');
  }
  const sl = document.getElementById('shelf-list');
  if(!cachedShelves.length){
    sl.innerHTML = '<span style="color:var(--muted);font-size:12px">Êú™ÁôªÈå≤</span>';
  } else {
    sl.innerHTML = cachedShelves.map(shelf =>
      `<div class="list-chip">${escHtml(shelf)}<button class="del-btn" onclick="removeShelf('${escJsSingle(shelf)}')">‚úï</button></div>`
    ).join('');
  }
  const tb = document.getElementById('stock-tbody');
  const occupied = cachedStock.sort((a,b) => (b.inboundAtMs||0) - (a.inboundAtMs||0));
  if(!occupied.length){
    tb.innerHTML = '<tr><td colspan="4" class="empty">„Éá„Éº„Çø„Å™„Åó</td></tr>';
  } else {
    tb.innerHTML = occupied.map(s =>
      `<tr>
        <td><strong>${escHtml(s.shelfId)}</strong></td>
        <td>${escHtml(s.productId||'-')}</td>
        <td class="muted">${escHtml(formatTime(s.inboundAt))}</td>
        <td><button class="del-row-btn" onclick="removeStock('${escJsSingle(s.shelfId)}')">ÂâäÈô§</button></td>
      </tr>`
    ).join('');
  }
}

async function addItem(){
  const el = document.getElementById('new-item');
  const val = (el.value || '').trim().toUpperCase();
  if(!val){ showToast('ÂìÅÁï™„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error'); return; }
  if(cachedItems.includes(val)){ showToast('Êó¢„Å´ÁôªÈå≤Ê∏à„Åø„Åß„Åô', 'error'); return; }
  try{
    await window.__saveItemMaster(val);
    el.value = '';
    showToast(`‚úÖ ÂìÅÁï™ ${val} „ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü`);
    await loadCache(); renderMaster();
  }catch(e){ console.error(e); showToast('ÁôªÈå≤„Ç®„É©„Éº', 'error'); }
}
async function removeItem(item){
  if(!confirm(`„Äå${item}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;
  try{
    await window.__deleteItemMaster(item);
    showToast(`üóë ÂìÅÁï™ ${item} „ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`);
    await loadCache(); renderMaster();
  }catch(e){ console.error(e); showToast('ÂâäÈô§„Ç®„É©„Éº', 'error'); }
}
async function addShelf(){
  const el = document.getElementById('new-shelf');
  const val = (el.value || '').trim();
  if(!val){ showToast('Ê£öÁï™„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error'); return; }
  if(cachedShelves.includes(val)){ showToast('Êó¢„Å´ÁôªÈå≤Ê∏à„Åø„Åß„Åô', 'error'); return; }
  try{
    await window.__saveShelfMaster(val);
    el.value = '';
    showToast(`‚úÖ Ê£öÁï™ ${val} „ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü`);
    await loadCache(); renderMaster();
  }catch(e){ console.error(e); showToast('ÁôªÈå≤„Ç®„É©„Éº', 'error'); }
}
async function removeShelf(shelf){
  if(!confirm(`„Äå${shelf}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;
  try{
    await window.__deleteShelfMaster(shelf);
    showToast(`üóë Ê£öÁï™ ${shelf} „ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`);
    await loadCache(); renderMaster();
  }catch(e){ console.error(e); showToast('ÂâäÈô§„Ç®„É©„Éº', 'error'); }
}
async function removeStock(shelfId){
  if(!confirm(`Ê£ö„Äå${shelfId}„Äç„ÅÆÂú®Â∫´„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;
  try{
    await window.__deleteShelfItem(shelfId);
    showToast(`üóë ÂâäÈô§„Åó„Åæ„Åó„Åü`);
    await loadCache(); renderMaster();
  }catch(e){ console.error(e); showToast('ÂâäÈô§„Ç®„É©„Éº', 'error'); }
}


/* ===================== Ê£öÂç∏„Åó ===================== */
let invSession = null;        // { sessionId, startedAt, startedAtMs, status }
let invResults = {};          // { shelfId: resultObj }
let invCurrentShelf = null;   // currently selected shelf
let invView = 'shelves';      // 'shelves' | 'report'
let invPollTimer = null;

function invGenerateSessionId(){
  return 'INV-' + Date.now().toString(36).toUpperCase();
}

/* ------- session start/end ------- */
async function invStartSession(){
  if(invSession && invSession.status === 'active'){
    if(!confirm('ÈÄ≤Ë°å‰∏≠„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÊñ∞„Åó„ÅÑ„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÈñãÂßã„Åó„Åæ„Åô„ÅãÔºüÔºàÁèæÂú®„ÅÆ„Éá„Éº„Çø„ÅØ‰øùÊåÅ„Åï„Çå„Åæ„ÅôÔºâ')) return;
  }
  const sessionId = invGenerateSessionId();
  const now = new Date().toISOString();
  const data = { sessionId, startedAt: now, startedAtMs: Date.now(), status: 'active', totalShelves: cachedShelves.length };
  try{
    await window.__invSaveSession(sessionId, data);
    invSession = data;
    invResults = {};
    invCurrentShelf = null;
    showToast(`‚úÖ Ê£öÂç∏„ÅóÈñãÂßãÔºö${sessionId}`);
    await invLoadResults();
    renderInv();
    invStartPolling();
  }catch(e){ console.error(e); showToast('ÈñãÂßã„Ç®„É©„Éº', 'error'); }
}

async function invEndSession(){
  if(!invSession) return;
  if(!confirm('Ê£öÂç∏„Åó„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åô„ÅãÔºü')) return;
  try{
    await window.__invSaveSession(invSession.sessionId, { ...invSession, status: 'completed', completedAt: new Date().toISOString() });
    invSession.status = 'completed';
    invStopPolling();
    showToast('üèÅ Ê£öÂç∏„ÅóÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü');
    invSwitchView('report');
    renderInv();
  }catch(e){ console.error(e); showToast('ÁµÇ‰∫Ü„Ç®„É©„Éº', 'error'); }
}

/* ------- load data ------- */
async function invLoadLatestSession(){
  try{
    const sessions = await window.__invGetSessions();
    if(!sessions.length){ invSession = null; return; }
    const active = sessions.find(s => s.status === 'active');
    invSession = active || sessions.sort((a,b)=>(b.startedAtMs||0)-(a.startedAtMs||0))[0];
  }catch(e){ console.error(e); }
}

async function invLoadResults(){
  if(!invSession) return;
  try{
    const results = await window.__invGetResults(invSession.sessionId);
    invResults = {};
    for(const r of results) invResults[r.shelfId] = r;
  }catch(e){ console.error(e); }
}

/* ------- polling for real-time share ------- */
function invStartPolling(){
  invStopPolling();
  invPollTimer = setInterval(async () => {
    if(currentTab !== 'inv') { invStopPolling(); return; }
    await invLoadResults();
    invUpdateProgress();
    invRenderShelfGrid();
    if(invView === 'report') invRenderReport();
    const dot = document.getElementById('inv-sync-indicator');
    if(dot) dot.style.display = 'flex';
  }, 5000);
}
function invStopPolling(){
  if(invPollTimer){ clearInterval(invPollTimer); invPollTimer = null; }
}

/* ------- main render ------- */
async function renderInv(){
  await invLoadLatestSession();
  await invLoadResults();
  invUpdateBanner();
  invUpdateProgress();
  invRenderShelfGrid();
  if(invView === 'report') invRenderReport();
  if(invSession && invSession.status === 'active') invStartPolling();
}

function invUpdateBanner(){
  const banner   = document.getElementById('inv-session-banner');
  const idleEl   = document.getElementById('inv-banner-idle');
  const activeEl = document.getElementById('inv-banner-active');
  const title    = document.getElementById('inv-banner-title');
  const meta     = document.getElementById('inv-banner-meta');
  const btnStart = document.getElementById('inv-btn-start');

  const isActive = invSession && invSession.status === 'active';

  banner.classList.toggle('active-session', isActive);

  if(isActive){
    if(idleEl)   idleEl.style.display   = 'none';
    if(activeEl) activeEl.style.display = '';
  } else {
    if(idleEl)   idleEl.style.display   = '';
    if(activeEl) activeEl.style.display = 'none';
    // idleÁä∂ÊÖã„ÅÆË°®Á§∫Êõ¥Êñ∞
    if(!invSession){
      if(title)    title.textContent = 'üìã Ê£öÂç∏„Åó„Çª„ÉÉ„Ç∑„Éß„É≥';
      if(meta)     meta.textContent  = '„Çª„ÉÉ„Ç∑„Éß„É≥„Å™„Åó ‚Äî ÈñãÂßã„Éú„Çø„É≥„ÅßÊ£öÂç∏„Åó„ÇíÂßã„ÇÅ„Åæ„Åô';
      if(btnStart) btnStart.textContent = '‚ñ∂ ÈñãÂßã';
    } else {
      // ÂÆå‰∫Ü„Çª„ÉÉ„Ç∑„Éß„É≥
      if(title)    title.textContent = `üìã ${invSession.sessionId}`;
      if(meta)     meta.textContent  = `ÂÆå‰∫ÜÔºö${formatTime(invSession.startedAtMs)}„ÄÄÂÖ®${cachedShelves.length}Ê£ö`;
      if(btnStart) btnStart.textContent = '‚ñ∂ Êñ∞Ë¶èÈñãÂßã';
    }
  }
}

function invUpdateProgress(){
  const fill = document.getElementById('inv-progress-fill');
  const text = document.getElementById('inv-progress-text');
  const pct  = document.getElementById('inv-progress-pct');
  if(!invSession) return;
  const total = cachedShelves.length;
  const done  = Object.keys(invResults).length;
  const pctVal = total > 0 ? Math.round((done/total)*100) : 0;
  if(fill) fill.style.width = pctVal + '%';
  if(text) text.textContent = `${done} / ${total} Ê£ö ÂÆå‰∫Ü`;
  if(pct)  pct.textContent  = pctVal + '%';
}

function invRenderShelfGrid(){
  const grid = document.getElementById('inv-shelf-grid');
  if(!grid) return;
  if(!cachedShelves.length){
    grid.innerHTML = '<div class="empty">Ê£öÁï™„ÅåÊú™ÁôªÈå≤„Åß„Åô</div>'; return;
  }
  grid.innerHTML = cachedShelves.map(shelf => {
    const r = invResults[shelf];
    let stClass = 'st-unchecked';
    let icon = '‚¨ú';
    let sub = '';
    if(r){
      const itemLabels = r.items && r.items.length
        ? r.items.map(i => i.productId + (i.quantity > 1 ? `√ó${i.quantity}` : '')).join(' / ')
        : (r.actualProduct || '');
      if(r.status === 'discrepancy'){ stClass = 'st-discrepancy'; icon = '‚ö†Ô∏è'; sub = itemLabels || 'Á©∫„Åç'; }
      else if(r.status === 'empty-ok'){ stClass = 'st-empty-ok'; icon = '‚úÖ'; sub = 'Á©∫„ÅçÁ¢∫Ë™ç'; }
      else { stClass = 'st-ok'; icon = '‚úÖ'; sub = itemLabels || '-'; }
    } else {
      const sysItem = cachedStock.find(s => s.shelfId === shelf);
      sub = sysItem ? sysItem.productId : 'Á©∫„Åç';
    }
    const activeClass = invCurrentShelf === shelf ? 'st-active' : '';
    return `<button class="inv-shelf-btn ${stClass} ${activeClass}" onclick="invSelectShelf('${escJsSingle(shelf)}')">
      <span class="inv-shelf-status-icon">${icon}</span>
      <span class="inv-shelf-id">${escHtml(shelf)}</span>
      <span class="inv-shelf-product">${escHtml(sub)}</span>
    </button>`;
  }).join('');
}

/* ------- select shelf & build entry form ------- */
function invSelectShelf(shelfId){
  if(!invSession || invSession.status !== 'active'){
    showToast('„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error'); return;
  }
  invCurrentShelf = shelfId;
  invRenderShelfGrid();

  const sysStockItems = cachedStock.filter(s => s.shelfId === shelfId);
  const sysProduct = sysStockItems.length ? sysStockItems[0].productId : null;
  const existingResult = invResults[shelfId];

  // ÂàùÊúüË°å„Éá„Éº„Çø„ÇíÂÖà„Å´Á¢∫ÂÆöÔºàË§áÊï∞ÂìÅÁï™ÂØæÂøúÔºâ
  if(existingResult && existingResult.items && existingResult.items.length){
    invEntryRows[shelfId] = existingResult.items.map(i => ({ productId: i.productId || '', quantity: i.quantity || 1 }));
  } else if(existingResult && existingResult.actualProduct){
    invEntryRows[shelfId] = [{ productId: existingResult.actualProduct, quantity: existingResult.quantity || 1 }];
  } else if(sysStockItems.length > 0){
    invEntryRows[shelfId] = sysStockItems.map(s => ({ productId: s.productId, quantity: 1 }));
  } else {
    invEntryRows[shelfId] = [];
  }

  // „Éë„Éç„É´ID„Å´„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„Çí„Å§„Åë„Å¶IDÈáçË§á„ÇíÂõûÈÅø
  const buildPanel = (prefix) => `
    <div class="inv-entry-shelf-id">${escHtml(shelfId)}</div>
    <div id="ivc-rows-${prefix}-${escHtml(shelfId)}"></div>
    <button class="inv-add-row-btn" onclick="invAddRow('${escJsSingle(shelfId)}','${prefix}')">Ôºã ÂìÅÁï™„ÇíËøΩÂä†</button>
    <button class="inv-empty-confirm-btn" onclick="invSaveResult('${escJsSingle(shelfId)}','${escJsSingle(sysProduct||'')}',true)">üì≠ Á©∫„ÅçÊ£ö„Å®„Åó„Å¶Á¢∫ÂÆö</button>
    <div class="inv-confirm-row">
      <button class="inv-btn-ok" onclick="invSaveResult('${escJsSingle(shelfId)}','${escJsSingle(sysProduct||'')}',false)">‚úÖ Á¢∫ÂÆö</button>
      <button class="inv-btn-skip" onclick="invCloseEntry()">„Çπ„Ç≠„ÉÉ„Éó</button>
    </div>
  `;

  // Desktop: right panel
  const rightInner = document.getElementById('inv-entry-inner-right');
  if(rightInner){
    rightInner.innerHTML = buildPanel('r');
    invRenderRows(shelfId, 'r');
  }

  // Mobile: bottom panel
  const mobileTitle = document.getElementById('inv-mobile-panel-title');
  const mobileInner = document.getElementById('inv-entry-inner-mobile');
  const mobilePanel = document.getElementById('inv-entry-panel-mobile');
  if(mobileTitle) mobileTitle.textContent = `üî¢ Ê£ö ${shelfId}`;
  if(mobileInner){
    mobileInner.innerHTML = buildPanel('m');
    invRenderRows(shelfId, 'm');
  }
  if(mobilePanel){ mobilePanel.classList.add('visible'); scrollToEl('inv-entry-panel-mobile', 'sec-inv-scroll'); }
}

/* ------- Ë§áÊï∞ÂìÅÁï™Ë°å„Çπ„ÉÜ„Éº„Éà ------- */
let invEntryRows = {}; // { shelfId: [{productId, quantity}] }

/* invBuildEntryForm: invSelectShelfÂÜÖ„ÅÆbuildPanel„Å´Áµ±ÂêàÊ∏à„Åø */

function invRenderRows(shelfId, prefix){
  // prefix: 'r'=right panel, 'm'=mobile panel
  // ‰∏°„Éë„Éç„É´Êõ¥Êñ∞Ôºàprefix„Å™„ÅóÔºâ„ÅãÊåáÂÆö„Éë„Éç„É´„ÅÆ„Åø
  const prefixes = prefix ? [prefix] : ['r', 'm'];
  const rows = invEntryRows[shelfId] || [];
  const itemOptions = (selected) => ['', ...cachedItems].map(item =>
    `<option value="${escHtml(item)}" ${selected === item ? 'selected' : ''}>${item ? escHtml(item) : '‚Äî ÂìÅÁï™ÈÅ∏Êäû ‚Äî'}</option>`
  ).join('');

  for(const pfx of prefixes){
    const container = document.getElementById(`ivc-rows-${pfx}-${shelfId}`);
    if(!container) continue;
    container.innerHTML = rows.map((row, idx) => {
      const hasProduct = row.productId !== '';
      return `<div class="inv-multi-row">
        <select class="inv-select" onchange="invRowProductChange('${escJsSingle(shelfId)}',${idx},this.value,'${pfx}')">
          ${itemOptions(row.productId)}
        </select>
        <div class="inv-multi-qty-group" style="${hasProduct ? '' : 'display:none'}" id="ivc-qg-${pfx}-${escHtml(shelfId)}-${idx}">
          <button class="inv-multi-adj" onclick="invRowAdjQty('${escJsSingle(shelfId)}',${idx},-1)">Ôºç</button>
          <input class="inv-qty" type="number" value="${row.quantity}" min="1" inputmode="numeric"
            id="ivc-qinput-${pfx}-${escHtml(shelfId)}-${idx}"
            onchange="invRowSetQty('${escJsSingle(shelfId)}',${idx},this.value)">
          <button class="inv-multi-adj" onclick="invRowAdjQty('${escJsSingle(shelfId)}',${idx},1)">Ôºã</button>
        </div>
        <button class="inv-del-row-btn" onclick="invRemoveRow('${escJsSingle(shelfId)}',${idx})" title="ÂâäÈô§">‚úï</button>
      </div>`;
    }).join('');
  }
}

function invAddRow(shelfId, prefix){
  if(!invEntryRows[shelfId]) invEntryRows[shelfId] = [];
  invEntryRows[shelfId].push({ productId: '', quantity: 1 });
  invRenderRows(shelfId); // ‰∏°„Éë„Éç„É´Êõ¥Êñ∞
}

function invRemoveRow(shelfId, idx){
  // ‰∏°„Éë„Éç„É´ÂÜçÊèèÁîª
  if(!invEntryRows[shelfId]) return;
  invEntryRows[shelfId].splice(idx, 1);
  invRenderRows(shelfId); // ‰∏°„Éë„Éç„É´Êõ¥Êñ∞
}

function invRowProductChange(shelfId, idx, val, prefix){
  if(!invEntryRows[shelfId]) return;
  invEntryRows[shelfId][idx].productId = val;
  // ‰∏°„Éë„Éç„É´„ÅÆqty-group„ÇíÊõ¥Êñ∞
  for(const pfx of ['r','m']){
    const qg = document.getElementById(`ivc-qg-${pfx}-${shelfId}-${idx}`);
    if(qg) qg.style.display = val ? '' : 'none';
  }
}

function invRowAdjQty(shelfId, idx, delta){
  if(!invEntryRows[shelfId]) return;
  const cur = invEntryRows[shelfId][idx].quantity || 1;
  const next = Math.max(1, cur + delta);
  invEntryRows[shelfId][idx].quantity = next;
  for(const pfx of ['r','m']){
    const el = document.getElementById(`ivc-qinput-${pfx}-${shelfId}-${idx}`);
    if(el) el.value = next;
  }
}

function invRowSetQty(shelfId, idx, val){
  if(!invEntryRows[shelfId]) return;
  const next = Math.max(1, parseInt(val) || 1);
  invEntryRows[shelfId][idx].quantity = next;
  // ‰∏°„Éë„Éç„É´ÂêåÊúü
  for(const pfx of ['r','m']){
    const el = document.getElementById(`ivc-qinput-${pfx}-${shelfId}-${idx}`);
    if(el && parseInt(el.value) !== next) el.value = next;
  }
}

function invOnProductChange(shelfId, sysProduct){ /* no-op */ }
function invUpdateCompare(shelfId, sysProduct){ /* no-op */ }
function invToggleQty(shelfId){ /* no-op */ }
function invAdjQty(shelfId, delta){ /* no-op */ }

function invCloseEntry(){
  invCurrentShelf = null;
  const mobilePanel = document.getElementById('inv-entry-panel-mobile');
  if(mobilePanel) mobilePanel.classList.remove('visible');
  const rightInner = document.getElementById('inv-entry-inner-right');
  if(rightInner) rightInner.innerHTML = '<div class="empty" style="padding:30px 0">Ê£ö„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
  invRenderShelfGrid();
}

async function invSaveResult(shelfId, sysProduct, forceEmpty){
  const rows = invEntryRows[shelfId] || [];
  // ÊúâÂäπË°å„ÅÆ„ÅøÔºàÂìÅÁï™„ÅÇ„ÇäÔºâ
  const validRows = forceEmpty ? [] : rows.filter(r => r.productId);
  const now = new Date().toISOString();

  // Â∑ÆÁï∞Âà§ÂÆö: „Ç∑„Çπ„ÉÜ„É†„ÅÆÂÖ®ÂìÅÁï™„Çª„ÉÉ„Éà„Å®ÂÆüÁâ©„ÅÆÂÖ®ÂìÅÁï™„Çª„ÉÉ„Éà„ÇíÊØîËºÉ
  const sysStockItems = cachedStock.filter(s => s.shelfId === shelfId);
  const sysProductIds = new Set(sysStockItems.map(s => s.productId).filter(Boolean));
  const actualProductIds = new Set(validRows.map(r => r.productId).filter(Boolean));
  const actualHasStock = actualProductIds.size > 0;

  // „Çª„ÉÉ„ÉàÊØîËºÉ: ‰∏°ÊñπÂêë„Åß‰∏ÄËá¥„Åô„Çã„ÅãÁ¢∫Ë™ç
  const setsMatch = sysProductIds.size === actualProductIds.size
    && [...sysProductIds].every(p => actualProductIds.has(p));
  const isDiff = (sysProductIds.size > 0) !== actualHasStock || !setsMatch;

  const status = !actualHasStock ? 'empty-ok' : (isDiff ? 'discrepancy' : 'ok');

  const resultData = {
    sessionId: invSession.sessionId,
    shelfId,
    systemProduct: [...sysProductIds].join(',') || null,
    items: validRows,
    // backward compat
    actualProduct: validRows.length === 1 ? validRows[0].productId : (validRows.length > 1 ? validRows.map(r=>r.productId).join(',') : null),
    quantity: validRows.reduce((s,r) => s + (r.quantity||0), 0),
    status,
    checkedAt: now,
    checkedAtMs: Date.now()
  };

  try{
    // Ê£öÂç∏„Åó„ÅØË®òÈå≤„ÅÆ„Åø ‚Äî Âú®Â∫´„Éá„Éº„ÇøÔºàshelfInventoryÔºâ„ÅØ‰∏äÊõ∏„Åç„Åó„Å™„ÅÑ
    const toastMsg = forceEmpty ? `üì≠ ${shelfId}ÔºöÁ©∫„ÅçÁ¢∫Ë™ç` : (isDiff ? `‚ö†Ô∏è ${shelfId}ÔºöÂ∑ÆÁï∞„ÇíË®òÈå≤„Åó„Åæ„Åó„Åü` : `‚úÖ ${shelfId}ÔºöÁ¢∫Ë™çÂÆå‰∫Ü`);
    showToast(toastMsg);
    await window.__invSaveResult(invSession.sessionId, shelfId, resultData);
    invResults[shelfId] = resultData;
    invUpdateProgress();
    invCloseEntry();
    await loadCache();
    invRenderShelfGrid();

    // auto-select next unchecked shelf
    const nextShelf = cachedShelves.find(s => !invResults[s]);
    if(nextShelf) setTimeout(() => invSelectShelf(nextShelf), 300);
  }catch(e){ console.error(e); showToast('‰øùÂ≠ò„Ç®„É©„Éº', 'error'); }
}

/* ------- view switch ------- */
function invSwitchView(view){
  invView = view;
  document.getElementById('inv-vtab-shelves').classList.toggle('active', view === 'shelves');
  document.getElementById('inv-vtab-report').classList.toggle('active', view === 'report');
  document.getElementById('inv-shelves-view').style.display = view === 'shelves' ? '' : 'none';
  document.getElementById('inv-report-view').style.display  = view === 'report'  ? '' : 'none';
  if(view === 'report') invRenderReport();
}

function invRenderReport(){
  // Product totals (itemsÈÖçÂàóÂØæÂøú)
  const totals = {}; // { productId: quantity }
  const discrepancies = [];
  for(const r of Object.values(invResults)){
    const items = r.items && r.items.length ? r.items : (r.actualProduct ? [{productId: r.actualProduct, quantity: r.quantity || 1}] : []);
    for(const item of items){
      if(item.productId) totals[item.productId] = (totals[item.productId] || 0) + (item.quantity || 0);
    }
    if(r.status === 'discrepancy') discrepancies.push(r);
  }

  const prodEl = document.getElementById('inv-report-products');
  if(prodEl){
    const sorted = Object.entries(totals).sort((a,b) => b[1]-a[1]);
    prodEl.innerHTML = sorted.length
      ? sorted.map(([prod, qty]) =>
          `<div class="inv-report-row">
            <span class="inv-report-item">${escHtml(prod)}</span>
            <span><span class="inv-report-qty">${qty}</span><span class="inv-report-unit">ÂÄã</span></span>
          </div>`
        ).join('')
      : '<div class="empty">„Åæ„Å†„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
  }

  const discCard = document.getElementById('inv-discrepancy-card');
  const discEl   = document.getElementById('inv-report-discrepancies');
  if(discrepancies.length && discCard){
    discCard.style.display = '';
    discEl.innerHTML = discrepancies.map(r =>
      `<div class="inv-discrepancy-row">
        <strong style="color:var(--red);-webkit-text-fill-color:var(--red)">${escHtml(r.shelfId)}</strong>„ÄÄ
        SYS: ${escHtml(r.systemProduct || 'Á©∫„Åç')} ‚Üí ÂÆüÁâ©: ${escHtml(r.actualProduct || 'Á©∫„Åç')}„ÄÄ
        <span style="color:var(--muted);-webkit-text-fill-color:var(--muted)">${r.quantity}ÂÄã</span>
      </div>`
    ).join('');
  } else if(discCard){
    discCard.style.display = 'none';
  }

  const total = cachedShelves.length;
  const done  = Object.keys(invResults).length;
  const okCount   = Object.values(invResults).filter(r => r.status === 'ok').length;
  const diffCount = discrepancies.length;
  const emptyOk   = Object.values(invResults).filter(r => r.status === 'empty-ok').length;
  const sumEl = document.getElementById('inv-report-summary');
  if(sumEl){
    sumEl.innerHTML = `
      <div class="inv-report-row"><span class="status-key">Á¢∫Ë™çÊ∏à„ÅøÊ£ö</span><span class="inv-report-qty" style="font-size:18px">${done} / ${total}</span></div>
      <div class="inv-report-row"><span class="status-key">‚úÖ ‰∏ÄËá¥</span><span style="color:var(--green);-webkit-text-fill-color:var(--green);font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700">${okCount}</span></div>
      <div class="inv-report-row"><span class="status-key">‚ö†Ô∏è Â∑ÆÁï∞‰øÆÊ≠£</span><span style="color:var(--red);-webkit-text-fill-color:var(--red);font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700">${diffCount}</span></div>
      <div class="inv-report-row"><span class="status-key">üì≠ Á©∫„ÅçÁ¢∫Ë™çÊ∏à„Åø</span><span style="color:var(--muted);-webkit-text-fill-color:var(--muted);font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700">${emptyOk}</span></div>
    `;
  }
}

/* ------- QR scan for inventory tab: handled in processQR ------- */

/* ===================== TOAST ===================== */
function showToast(msg, type){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + (type||'') + ' show';
  setTimeout(() => t.className = 'toast ' + (type||''), 2200);
}

/* ===================== „Ç≠„ÉºÂÖ•Âäõ ===================== */
document.getElementById('new-item').addEventListener('keydown', e => { if(e.key==='Enter') addItem(); });
document.getElementById('new-shelf').addEventListener('keydown', e => { if(e.key==='Enter') addShelf(); });

/* ===================== ÂàùÊúü„É≠„Éº„Éâ ===================== */
loadCache().then(() => { renderIn(); renderInStockMini(); });
</script>

<!-- ===== Firebase SDK ===== -->

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, deleteDoc, collection,
    getDocs, query, serverTimestamp, orderBy, limit, addDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAOMRoojKv9Hnh3OjVGwYV_k1LBTGOKepY",
    authDomain: "miyamaunitec-fb87a.firebaseapp.com",
    projectId: "miyamaunitec-fb87a",
    storageBucket: "miyamaunitec-fb87a.firebasestorage.app",
    messagingSenderId: "495316649507",
    appId: "1:495316649507:web:1f98ee3dd851474fa39396"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  const setStatus = (t,c) => {
    const el = document.getElementById('firebaseStatus');
    el.textContent = `Firebase: ${t}`;
    el.style.color = c;
    el.style.webkitTextFillColor = c;
  };

  try{
    await signInAnonymously(auth);
    setStatus('Êé•Á∂öÊ∏à„Åø', '#2ecc71');
  }catch(e){
    console.warn(e);
    setStatus('Êú™Êé•Á∂ö', '#e74c3c');
  }

  const INV  = 'shelfInventory';
  const SHM  = 'shelfMaster';
  const ITM  = 'itemMaster';
  const HIST = 'shelfHistory';
  const HLD  = 'shipmentHold';

  // ÂÖ•Â∫´: Ë§áÂêà„Ç≠„Éº shelfId_timestamp „ÅßËøΩË®òÔºà‰∏äÊõ∏„Åç„Åó„Å™„ÅÑÔºâ
  window.__addShelfItem = async (shelfId, data) => {
    const key = String(shelfId) + '_' + Date.now();
    await setDoc(doc(db, INV, key), { ...data, docId: key, savedAt: serverTimestamp() });
  };
  // ÂæåÊñπ‰∫íÊèõÁî®ÔºàÂá∫Â∫´„Å™„Å©„ÅÆÁ©∫„ÅçÁôªÈå≤„ÅØ‰Ωø„Çè„Å™„ÅÑÔºâ
  window.__saveShelfItem = async (shelfId, data) => {
    await window.__addShelfItem(shelfId, data);
  };
  window.__getShelfItem = async (shelfId) => {
    const snap = await getDocs(collection(db, INV));
    const docs = snap.docs.map(d => d.data()).filter(d => d.shelfId === shelfId && d.status === 'occupied');
    return docs.length ? docs[0] : null;
  };
  window.__getAllShelves = async () => {
    const snap = await getDocs(collection(db, INV));
    return snap.docs.map(d => ({ ...d.data(), docId: d.id }));
  };
  // Ê£ö„ÅÆÁâπÂÆöÂìÅÁï™1‰ª∂„ÇíÂâäÈô§ÔºàÂá∫Â∫´Áî®: shelfId + productId + ÊúÄÂè§„ÅÆdoc„ÇíÂâäÈô§Ôºâ
  window.__deleteShelfItemByProduct = async (shelfId, productId) => {
    const snap = await getDocs(collection(db, INV));
    const matched = snap.docs
      .filter(d => d.data().shelfId === shelfId && d.data().productId === productId && d.data().status === 'occupied')
      .sort((a,b) => (a.data().inboundAtMs||0) - (b.data().inboundAtMs||0));
    if(matched.length) await deleteDoc(matched[0].ref);
  };
  // Ê£öÂÖ®‰ª∂ÂâäÈô§Ôºà„Éû„Çπ„Çø„ÉºÁÆ°ÁêÜÁî®Ôºâ
  window.__deleteShelfItem = async (shelfId) => {
    const snap = await getDocs(collection(db, INV));
    const targets = snap.docs.filter(d => d.data().shelfId === shelfId);
    await Promise.all(targets.map(d => deleteDoc(d.ref)));
  };

  window.__getAllShelfMasters = async () => {
    const snap = await getDocs(collection(db, SHM));
    return snap.docs.map(d => d.data());
  };
  window.__saveShelfMaster = async (shelfId) => {
    await setDoc(doc(db, SHM, String(shelfId)), { shelfId: String(shelfId), createdAt: serverTimestamp() });
  };
  window.__deleteShelfMaster = async (shelfId) => {
    await deleteDoc(doc(db, SHM, String(shelfId)));
  };

  window.__getAllItemMasters = async () => {
    const snap = await getDocs(collection(db, ITM));
    return snap.docs.map(d => d.data());
  };
  window.__saveItemMaster = async (itemId) => {
    await setDoc(doc(db, ITM, String(itemId)), { itemId: String(itemId), createdAt: serverTimestamp() });
  };
  window.__deleteItemMaster = async (itemId) => {
    await deleteDoc(doc(db, ITM, String(itemId)));
  };

  window.__addHistory = async (data) => {
    await addDoc(collection(db, HIST), { ...data, createdAt: serverTimestamp() });
  };
  window.__getHistory = async () => {
    const q = query(collection(db, HIST), orderBy('atMs','desc'), limit(100));
    const snap = await getDocs(q);
    return snap.docs.map(d => d.data());
  };

  window.__saveHold = async (itemId, data) => {
    await setDoc(doc(db, HLD, String(itemId)), { ...data, savedAt: serverTimestamp() });
  };
  window.__deleteHold = async (itemId) => {
    await deleteDoc(doc(db, HLD, String(itemId)));
  };
  window.__getAllHolds = async () => {
    const snap = await getDocs(collection(db, HLD));
    return snap.docs.map(d => d.data());
  };

  const INVS = 'inventorySessions';
  const INVR = 'inventoryResults';

  window.__invSaveSession = async (sessionId, data) => {
    await setDoc(doc(db, INVS, String(sessionId)), { ...data, updatedAt: serverTimestamp() });
  };
  window.__invGetSessions = async () => {
    const snap = await getDocs(collection(db, INVS));
    return snap.docs.map(d => d.data());
  };
  window.__invSaveResult = async (sessionId, shelfId, data) => {
    const key = String(sessionId) + '_' + String(shelfId);
    await setDoc(doc(db, INVR, key), { ...data, updatedAt: serverTimestamp() });
  };
  window.__invGetResults = async (sessionId) => {
    const snap = await getDocs(collection(db, INVR));
    return snap.docs.map(d => d.data()).filter(d => d.sessionId === sessionId);
  };

  await loadCache();
  renderIn();
  renderInStockMini();
</script>

</body>
</html>