<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å“è³ªå‘¼ã³å‡ºã—ãƒ¢ãƒ‹ã‚¿ãƒ¼</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', 'Hiragino Sans', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 12px;
    }
    
    /* å¤§ç”»é¢ã§ã¯å°‘ã—ä½™ç™½ã‚’å¢—ã‚„ã™ */
    @media (min-width: 1600px){
      body{
        padding: 16px;
      }
    }


    /* ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’ç”»é¢ã„ã£ã±ã„ã«åºƒã’ã‚‹ */
.page{
  max-width: 100%;
  width: 100%;
  margin: 0 auto;
  padding: 0;
}

/* è¶…å¤§ç”»é¢ã§ã¯æœ€å¤§å¹…ã‚’åˆ¶é™ */
@media (min-width: 3000px){
  .page{
    max-width: 2800px;
  }
}



    .header {
      background: rgba(255, 255, 255, 0.95);
      padding: 20px 30px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* --- QC Quick Toggle Bar (Header) --- */
    .qc-quick-bar{
      margin-top: 12px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .qc-quick-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.06);
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.45);
    }
    .qc-quick-item.off{
      opacity:.6;
      filter: grayscale(.2);
    }
    .qc-quick-item .qc-name{
      font-weight: 1000;
      letter-spacing: .2px;
      max-width: 160px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .qc-mini-toggle{
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
      font-weight: 900;
      white-space: nowrap;
    }
    .qc-mini-toggle input{
      transform: scale(1.1);
    }
    .qc-mini-toggle span{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.7);
      border: 1px solid rgba(0,0,0,.12);
    }

    @media (max-width: 768px){
      .qc-quick-item{ padding: 8px 10px; gap:8px; }
      .qc-quick-item .qc-name{ max-width: 110px; }
      .qc-mini-toggle span{ padding: 5px 8px; }
    }

    .header h1 {
      font-size: 2rem;
      color: #333;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .sound-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #fff3e0;
      padding: 12px 16px;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
      border: 1px solid rgba(0,0,0,.06);
    }
    .sound-toggle input {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .btn{
      border: none;
      border-radius: 10px;
      padding: 12px 14px;
      font-weight: 800;
      cursor: pointer;
      transition: .15s;
      box-shadow: 0 3px 10px rgba(0,0,0,.12);
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0); }
    .btn-secondary{ background: #eceff1; color:#263238; }
    .btn-secondary:hover{ background:#e3e7ea; }
    .btn-logout{ background:#ef5350; color:#fff; }
    .btn-logout:hover{ background:#e53935; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      text-align: center;
      transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-label {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 15px;
      color: #666;
    }
    .stat-value {
      font-size: 3.5rem;
      font-weight: bold;
      color: #333;
    }
    .stat-card.urgent .stat-value { color: #ef5350; }
    .stat-card.normal .stat-value { color: #ffa726; }
    .stat-card.inprogress .stat-value { color: #42a5f5; }
    .stat-card.completed .stat-value { color: #66bb6a; }

    .filter-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .filter-btn {
      flex: 1;
      min-width: 120px;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      background: rgba(255, 255, 255, 0.8);
      color: #333;
    }
    .filter-btn.active {
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      transform: translateY(-2px);
    }

    /* âœ… ã‚«ãƒ¼ãƒ‰ä¸€è¦§ï¼šç”»é¢ã„ã£ã±ã„ã«åºƒã’ã¦æœ€å¤§5åˆ—è¡¨ç¤º */
.cases-container{
  width: 100%;
  display: grid;
  gap: 16px;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  align-items: start;
}

.case-card{ 
  width: 100%;
  min-width: 0;
}

/* ===== è¦–èªæ€§æ”¹å–„ï¼šã‚«ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã«æ˜ã‚‹ã„ä¸‹åœ°ï¼ˆé’ãƒ™ã‚¿é˜²æ­¢ï¼‰ ===== */
@media (min-width: 1200px){
  .cases-container{
    background: rgba(255,255,255,0.92);
    padding: 18px;
    border-radius: 18px;
    box-shadow: 0 10px 26px rgba(0,0,0,0.14);
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  }
}

/* å¤§ç”»é¢ï¼šã‚ˆã‚Šå¤šãã®åˆ—ã‚’è¡¨ç¤º */
@media (min-width: 1600px){
  .cases-container{
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 18px;
  }
}

/* è¶…å¤§ç”»é¢ï¼š5åˆ—ç¢ºä¿ */
@media (min-width: 2000px){
  .cases-container{
    grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
    gap: 20px;
  }
}

/* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ */
@media (max-width: 1199px){
  .cases-container{ 
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  }
}

/* ãƒ¢ãƒã‚¤ãƒ«ï¼š1åˆ— */
@media (max-width: 640px){
  .cases-container{ 
    grid-template-columns: 1fr;
  }
}

/* âœ… å¤§ç”»é¢TVå‘ã‘ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ */
@media (min-width: 1600px){
  body{ font-size: 18px; }
  .header{ padding: 22px 26px; }
  .case-card{ padding: 22px; border-radius: 18px; }
  .case-title{ font-size: 22px; }
  .case-meta{ font-size: 16px; }
  .case-actions button{ font-size: 16px; padding: 12px 14px; }
}

    }

    .case-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: transform 0.2s;
      position: relative;
      overflow: hidden;

      height: 100%;
      display: flex;
      flex-direction: column;
    }
    .case-card:hover { transform: translateY(-3px); }
    .case-card.completed{
      opacity: 1;
      background: rgba(245,247,250,0.98);
      border: 1px solid rgba(0,0,0,0.06);
      filter: grayscale(.12) saturate(.9);
    }

    .priority-bar {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 6px;
    }
    .priority-bar.urgent { background: #ef5350; }
    .priority-bar.normal { background: #ffa726; }

    .case-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      gap: 12px;
    }
    .case-title {
      font-size: 1.2rem;
      font-weight: 900;
      color: #333;
      line-height: 1.2;
    }
    .case-time {
      color: #666;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .case-info {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }
    .info-item {
      display: flex;
      gap: 8px;
      align-items: baseline;
    }
    .info-label {
      font-weight: 900;
      color: #555;
      white-space: nowrap;
    }
    .info-value {
      color: #333;
      word-break: break-word;
    }

    .message-box {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 15px;
      white-space: pre-wrap;
    }

    .status-badge {
      display: inline-block;
      padding: 10px 24px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 10px;
      width: fit-content;
      max-width: fit-content;
      flex-shrink: 0;
      white-space: nowrap;
      border: 2px solid transparent;
    }
    .status-badge.pending { 
      background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
      color: #c62828;
      border-color: #ef5350;
    }
    .status-badge.inprogress { 
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      color: #0d47a1;
      border-color: #64b5f6;
    }
    .status-badge.completed { 
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      color: #1b5e20;
      border-color: #81c784;
    }
    
    /* çµŒéæ™‚é–“ãƒãƒƒã‚¸ */
    .elapsed-time-badge {
      display: inline-block;
      padding: 1px 1px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      white-space: nowrap;
      width: fit-content;
      flex-shrink: 0;
      background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
      color: #424242;
      border: 2px solid #bdbdbd;
line-height: 1.1;
    }
    
    .elapsed-time-badge.warning {
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      color: #e65100;
      border-color: #ffb74d;
    }
    
    .elapsed-time-badge.urgent {
      background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
      color: #c62828;
      border-color: #ef5350;
    }
    
    /* ãƒãƒƒã‚¸ã‚³ãƒ³ãƒ†ãƒŠ */
    .case-badges {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }


    /* âœ… å¯¾å¿œä¸­ æ‹…å½“è€… å¼·èª¿è¡¨ç¤º + é ­æ–‡å­—ãƒãƒƒã‚¸ */
    .responder-highlight{
      margin: 6px 0 14px;
      padding: 12px 14px;
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      border-left: 6px solid #1e88e5;
      border-radius: 10px;
      font-size: 1.25rem;
      font-weight: 1000;
      color: #0d47a1;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .initial-badge{
      width: 44px;
      height: 44px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 1000;
      font-size: 1.05rem;
      letter-spacing: .5px;
      color: #ffffff;
      background: radial-gradient(circle at 30% 30%, #6a5cff, #2a1b8f);
      box-shadow: 0 6px 14px rgba(13,71,161,.25);
      flex: 0 0 auto;
      user-select: none;
    }
    .responder-name{
      line-height: 1.15;
      min-width: 0;
    }
    .responder-name .sub{
      display:block;
      margin-top: 2px;
      font-size: .92rem;
      font-weight: 900;
      color: rgba(13,71,161,.85);
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: auto; /* âœ… ãƒœã‚¿ãƒ³ã‚’ä¸‹ã«å¯„ã›ã‚‹ */
    }
    /* âœ… æœªå¯¾å¿œã®ã€ŒæŒ‡ç¤ºå…ˆï¼ˆè‡ªå‹•å‰²å½“ï¼‰ã€è¡¨ç¤º */
    .assignee-highlight{
      margin: 6px 0 14px;
      padding: 12px 14px;
      background: linear-gradient(135deg, #fff8e1, #ffecb3);
      border-left: 6px solid #ffb300;
      border-radius: 10px;
      font-size: 1.15rem;
      font-weight: 1000;
      color: #6d4c41;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .assignee-highlight .badge{
      width: 44px;
      height: 44px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 1000;
      font-size: 1.05rem;
      color: #ffffff;
      background: radial-gradient(circle at 30% 30%, #ffb74d, #fb8c00);
      box-shadow: 0 6px 14px rgba(251,140,0,.25);
      flex: 0 0 auto;
      user-select: none;
    }

    .actions .btn {
      flex: 1;
      min-width: 110px;
      padding: 12px;
      border-radius: 10px;
      font-weight: 900;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      box-shadow: none;
    }
    .btn-inprogress { background: #42a5f5; color: #fff; }
    .btn-inprogress:hover { background: #1e88e5; }
    .btn-complete { background: #66bb6a; color: #fff; }
    .btn-complete:hover { background: #43a047; }
    .btn-open-anomaly { background: #7e57c2; color: #    .btn-decline { background: #b0bec5; color: #263238; }
    .btn-decline:hover { background: #90a4ae; }
fff; }
    .btn-open-anomaly:hover { background: #5e35b1; }

    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 20px;
      color: rgba(255, 255, 255, 0.95);
      font-size: 1.2rem;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 16px;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: #fff;
      padding: 24px;
      border-radius: 15px;
      width: 100%;
      max-width: 520px;
      max-height: 85vh;
      overflow: auto;
    }
    .modal-content h3 {
      margin-bottom: 15px;
      color: #333;
      font-size: 1.4rem;
      font-weight: 1000;
    }
    .modal-content textarea {
      width: 100%;
      min-height: 110px;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 10px;
      resize: vertical;
      font-family: inherit;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .modal-actions .btn {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      border: none;
      font-weight: 900;
      cursor: pointer;
      box-shadow:none;
    }
    .btn-cancel { background: #e0e0e0; }
    .btn-save { background: #667eea; color: #fff; }

    /* QCãƒ¡ãƒ³ãƒãƒ¼ç®¡ç† */
    .panel{
      background:#f8f9fa;
      border:1px solid rgba(0,0,0,.06);
      border-radius: 12px;
      padding: 14px;
      margin: 12px 0;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
    }
    .row > *{
      flex: 1;
      min-width: 160px;
    }
    .input, .select{
      width:100%;
      padding: 12px;
      border:2px solid #ddd;
      border-radius: 10px;
      font-size: 1rem;
    }
    .list{
      display:flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }
    .item{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px;
      background:#fff;
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }
    .item small{ color:#666; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:#eef2ff;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight:1000;
      color:#3949ab;
      font-size: .85rem;
      white-space: nowrap;
    }
    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      white-space: nowrap;
      user-select:none;
      font-weight: 900;
    }

    @media (max-width: 768px) {
  body{
    padding: clamp(10px, 1.8vw, 22px);
  }
}
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Segoe UI', 'Yu Gothic', 'Hiragino Sans', sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 24px;
  line-height: 1.6;
}

.page {
  max-width: 1600px;
  margin: 0 auto;
}

/* ========== ãƒ˜ãƒƒãƒ€ãƒ¼ ========== */
.header {
  background: #ffffff;
  padding: 24px 32px;
  border-radius: 20px;
  margin-bottom: 24px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
}

.header h1 {
  font-size: 2rem;
  font-weight: 700;
  color: #1a1a2e;
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  justify-content: flex-end;
  margin-top: 16px;
}

/* QCã‚¯ã‚¤ãƒƒã‚¯ãƒãƒ¼ */
.qc-quick-bar {
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid #e8e8e8;
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
}

.qc-quick-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border-radius: 12px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border: 1px solid #dee2e6;
  transition: all 0.3s ease;
}

.qc-quick-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.qc-quick-item.off {
  opacity: 0.5;
  filter: grayscale(0.8);
}

.qc-quick-item .qc-name {
  font-weight: 700;
  color: #212529;
  max-width: 160px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.qc-mini-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  user-select: none;
  font-weight: 600;
}

.qc-mini-toggle input {
  transform: scale(1.2);
  cursor: pointer;
}

.qc-mini-toggle span {
  font-size: 13px;
  padding: 6px 12px;
  border-radius: 8px;
  background: #ffffff;
  border: 1px solid #dee2e6;
  color: #495057;
  font-weight: 600;
}

/* ã‚µã‚¦ãƒ³ãƒ‰ãƒˆã‚°ãƒ« */
.sound-toggle {
  display: flex;
  align-items: center;
  gap: 10px;
  background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
  padding: 12px 18px;
  border-radius: 12px;
  cursor: pointer;
  user-select: none;
  border: 1px solid #ffcc80;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(255, 152, 0, 0.15);
}

.sound-toggle:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(255, 152, 0, 0.25);
}

.sound-toggle input {
  width: 20px;
  height: 20px;
  cursor: pointer;
}

/* ãƒœã‚¿ãƒ³ */
.btn {
  border: none;
  border-radius: 12px;
  padding: 12px 20px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  white-space: nowrap;
  font-size: 14px;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
}

.btn:active {
  transform: translateY(0);
}

.btn-secondary {
  background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
  color: #212529;
}

.btn-logout {
  background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
  color: #ffffff;
}

/* ========== çµ±è¨ˆã‚«ãƒ¼ãƒ‰ ========== */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-bottom: 32px;
}

.stat-card {
  background: #ffffff;
  padding: 32px;
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
  text-align: center;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.stat-card:hover {
  transform: translateY(-8px);
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.18);
}

.stat-label {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 16px;
  color: #6c757d;
  letter-spacing: 0.5px;
}

.stat-value {
  font-size: 4rem;
  font-weight: 800;
  color: #333;
  line-height: 1;
}

.stat-card.urgent {
  border-color: #ef5350;
  background: linear-gradient(135deg, #ffffff 0%, #ffebee 100%);
}
.stat-card.urgent .stat-value { color: #ef5350; }

.stat-card.normal {
  border-color: #ffa726;
  background: linear-gradient(135deg, #ffffff 0%, #fff3e0 100%);
}
.stat-card.normal .stat-value { color: #ffa726; }

.stat-card.inprogress {
  border-color: #42a5f5;
  background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%);
}
.stat-card.inprogress .stat-value { color: #42a5f5; }

.stat-card.completed {
  border-color: #66bb6a;
  background: linear-gradient(135deg, #ffffff 0%, #e8f5e9 100%);
}
.stat-card.completed .stat-value { color: #66bb6a; }

/* ========== ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ¼ ========== */
.filter-bar {
  display: flex;
  gap: 12px;
  margin-bottom: 24px;
  flex-wrap: wrap;
  background: rgba(255, 255, 255, 0.2);
  padding: 12px;
  border-radius: 16px;
}

.filter-btn {
  flex: 1;
  min-width: 120px;
  padding: 14px 20px;
  border: 2px solid rgba(255, 255, 255, 0.5);
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  background: rgba(255, 255, 255, 0.8);
  color: #495057;
  font-size: 15px;
}

.filter-btn:hover {
  background: rgba(255, 255, 255, 0.95);
  transform: translateY(-2px);
}

.filter-btn.active {
  background: #ffffff;
  border-color: #667eea;
  color: #667eea;
  box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
  transform: translateY(-3px);
}

/* ========== ã‚±ãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠ ========== */
.cases-container {
  display: grid;
  gap: 20px;
  grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
  align-items: start;
}

@media (max-width: 980px) {
  .cases-container {
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  }
}

@media (max-width: 560px) {
  .cases-container {
    grid-template-columns: 1fr;
  }
}

/* ========== ã‚±ãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰ ========== */
.case-card {
  background: #ffffff;
  border-radius: 20px;
  padding: 24px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  border: 2px solid transparent;
}

.case-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.18);
}

.case-card.completed {
  opacity: 0.7;
  filter: saturate(0.8);
}

/* å„ªå…ˆåº¦ãƒãƒ¼ */
.priority-bar {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 8px;
  border-radius: 20px 0 0 20px;
}

.priority-bar.urgent {
  background: linear-gradient(180deg, #ef5350 0%, #e53935 100%);
}

.priority-bar.normal {
  background: linear-gradient(180deg, #ffa726 0%, #fb8c00 100%);
}

/* ã‚±ãƒ¼ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ */
.case-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 16px;
  gap: 12px;
}

.case-title {
  font-size: 1.3rem;
  font-weight: 700;
  color: #1a1a2e;
  flex: 1;
  line-height: 1.4;
}

.case-badge {
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 700;
  white-space: nowrap;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.case-badge.pending {
  background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
  color: #e65100;
  border: 2px solid #ffb74d;
}

.case-badge.inprogress {
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  color: #0d47a1;
  border: 2px solid #64b5f6;
}

.case-badge.completed {
  background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
  color: #1b5e20;
  border: 2px solid #81c784;
}

/* ã‚±ãƒ¼ã‚¹æƒ…å ± */
.case-meta {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 16px;
  padding: 16px;
  background: #f8f9fa;
  border-radius: 12px;
  border-left: 4px solid #667eea;
}

.case-meta-row {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  color: #495057;
}

.case-meta-label {
  font-weight: 700;
  color: #212529;
  min-width: 80px;
}

.case-meta-value {
  color: #495057;
  font-weight: 500;
}

/* ã‚±ãƒ¼ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
.case-message {
  background: #ffffff;
  border: 2px solid #e9ecef;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  color: #212529;
  font-size: 15px;
  line-height: 1.6;
  white-space: pre-wrap;
  word-break: break-word;
}

/* æ‹…å½“è€…è¡¨ç¤º */
.case-assigned {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border-radius: 12px;
  margin-bottom: 16px;
  border: 2px solid #64b5f6;
}

.case-assigned-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);
  color: #ffffff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 16px;
  box-shadow: 0 4px 12px rgba(66, 165, 245, 0.4);
}

.case-assigned-info {
  flex: 1;
}

.case-assigned-label {
  font-size: 12px;
  color: #0d47a1;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.case-assigned-name {
  font-size: 16px;
  font-weight: 700;
  color: #1565c0;
}

/* ã‚±ãƒ¼ã‚¹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
.case-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: auto;
}

.case-actions .btn {
  flex: 1;
  min-width: 120px;
  font-size: 13px;
  padding: 12px 16px;
}

.btn-respond {
  background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);
  color: #ffffff;
}

.btn-complete {
  background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
  color: #ffffff;
}

.btn-decline {
  background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
  color: #ffffff;
}

.btn-open-anomaly {
  background: linear-gradient(135deg, #ab47bc 0%, #8e24aa 100%);
  color: #ffffff;
}

/* ========== ãƒ¢ãƒ¼ãƒ€ãƒ« ========== */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(4px);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: #ffffff;
  border-radius: 24px;
  padding: 32px;
  max-width: 600px;
  width: 100%;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.modal-header {
  font-size: 1.8rem;
  font-weight: 700;
  color: #1a1a2e;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 3px solid #667eea;
}

.modal-body {
  margin-bottom: 24px;
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  font-weight: 700;
  color: #212529;
  margin-bottom: 8px;
  font-size: 15px;
}

.form-control {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid #dee2e6;
  border-radius: 12px;
  font-size: 15px;
  font-family: inherit;
  transition: all 0.3s ease;
}

.form-control:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
}

textarea.form-control {
  min-height: 120px;
  resize: vertical;
}

.modal-footer {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.btn-modal-cancel {
  background: #e9ecef;
  color: #495057;
}

.btn-modal-confirm {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #ffffff;
}

/* ========== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–(å¤§ç”»é¢TVå‘ã‘) ========== */
@media (min-width: 1600px) {
  body {
    font-size: 18px;
    padding: 32px;
  }

  .header {
    padding: 32px 40px;
  }

  .header h1 {
    font-size: 2.5rem;
  }

  .cases-container {
    gap: 24px;
    grid-template-columns: repeat(auto-fill, minmax(460px, 1fr));
  }

  .case-card {
    padding: 28px;
    border-radius: 24px;
  }

  .case-title {
    font-size: 1.5rem;
  }

  .case-meta {
    font-size: 16px;
  }

  .case-actions button {
    font-size: 16px;
    padding: 14px 20px;
  }

  .stat-value {
    font-size: 5rem;
  }
}

/* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
@media (max-width: 768px) {
  body {
    padding: 16px;
  }

  .header {
    padding: 20px;
  }

  .header h1 {
    font-size: 1.5rem;
  }

  .qc-quick-item {
    padding: 10px 12px;
    gap: 8px;
  }

  .qc-quick-item .qc-name {
    max-width: 110px;
  }

  .stat-value {
    font-size: 3rem;
  }

  .case-title {
    font-size: 1.1rem;
  }

  .modal-content {
    padding: 24px;
  }
}

/* ========== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ========== */
.loading {
  text-align: center;
  padding: 60px 20px;
  color: #ffffff;
  font-size: 1.2rem;
  font-weight: 600;
}

.loading::after {
  content: '...';
  animation: dots 1.5s infinite;
}

@keyframes dots {
  0%, 20% { content: '.'; }
  40% { content: '..'; }
  60%, 100% { content: '...'; }
}
.case-badge {
  padding: 10px 24px;  /* 1.5å€ã«æ‹¡å¤§ */
  border-radius: 25px;  /* è§’ä¸¸ã‚‚å¤§ãã */
  font-size: 16px;  /* 1.5å€ã«æ‹¡å¤§ */
  font-weight: 700;
  white-space: nowrap;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: inline-block;  /* â˜…ãƒ–ãƒ­ãƒƒã‚¯è¦ç´ ã«ã—ãªã„ */
  width: fit-content;  /* â˜…ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«åˆã‚ã›ãŸå¹… */
  flex-shrink: 0;  /* â˜…flexboxã§ç¸®ã¾ãªã„ã‚ˆã†ã« */
}

.case-badge.pending {
  background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
  color: #c62828;
  border: 2px solid #ef5350;
}

.case-badge.inprogress {
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  color: #0d47a1;
  border: 2px solid #64b5f6;
}

.case-badge.completed {
  background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
  color: #1b5e20;
  border: 2px solid #81c784;
}
.case-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 16px;
  gap: 12px;
  flex-wrap: nowrap;  /* â˜…æŠ˜ã‚Šè¿”ã•ãªã„ */
}
/* ========== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ï¼ˆæœªå¯¾å¿œ/å¯¾å¿œä¸­/å®Œäº†ï¼‰ ========== */
.status-badge,
.case-badge {
  display: inline-block;
  padding: 10px 24px;
  border-radius: 25px;
  font-size: 16px;
  font-weight: 700;
  white-space: nowrap;
  text-transform: none;
  letter-spacing: 0.3px;
  width: fit-content;
  max-width: fit-content;
  flex-shrink: 0;
  margin-bottom: 10px;
}

.status-badge.pending,
.case-badge.pending {
  background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
  color: #c62828;
  border: 2px solid #ef5350;
}

.status-badge.inprogress,
.case-badge.inprogress {
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  color: #0d47a1;
  border: 2px solid #64b5f6;
}

.status-badge.completed,
.case-badge.completed {
  background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
  color: #1b5e20;
  border: 2px solid #81c784;
}

/* ã‚±ãƒ¼ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šãƒãƒƒã‚¸ãŒä¼¸ã³ãªã„ã‚ˆã†ã« */
.case-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 16px;
  gap: 12px;
  flex-wrap: nowrap;
}

.case-title {
  font-size: 1.3rem;
  font-weight: 700;
  color: #1a1a2e;
  flex: 1;
  line-height: 1.4;
  min-width: 0;
}
/* ========== çµŒéæ™‚é–“ãƒãƒƒã‚¸ ========== */
.elapsed-time-badge {
  display: inline-block;
  padding: 10px 20px;
  border-radius: 25px;
  font-size: 15px;
  font-weight: 700;
  white-space: nowrap;
  width: fit-content;
  flex-shrink: 0;
  background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
  color: #424242;
  border: 2px solid #bdbdbd;
}

/* çµŒéæ™‚é–“ãŒé•·ã„å ´åˆã®è­¦å‘Šè‰² */
.elapsed-time-badge.warning {
  background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
  color: #e65100;
  border: 2px solid #ffb74d;
}

.elapsed-time-badge.urgent {
  background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
  color: #c62828;
  border: 2px solid #ef5350;
}

/* ãƒãƒƒã‚¸ã‚’æ¨ªã«ä¸¦ã¹ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ */
.case-badges {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}
  /* =========================================================
   è¡¨ç¤ºä»¶æ•°UPï¼šé«˜å¯†åº¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆã‚«ãƒ¼ãƒ‰ã‚’å°ã•ããƒ»åˆ—æ•°ã‚’å¢—ã‚„ã™ï¼‰
   - ç›®çš„ï¼šä¸€ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹ä»¶æ•°ã‚’å¢—ã‚„ã™ï¼ˆTV/PCå‘ã‘ï¼‰
   - æ—¢å­˜CSSã®â€œæœ€å¾Œâ€ã§ä¸Šæ›¸ãã—ã¾ã™
   ========================================================= */
.cases-container{
  gap: 12px !important;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)) !important;
}
.case-card{
  padding: 18px !important;
  border-radius: 16px !important;
}
.priority-bar{ width: 6px !important; }

.case-header{ margin-bottom: 12px !important; }
.case-title{ font-size: 1.12rem !important; line-height: 1.25 !important; }
.case-time{ font-size: .82rem !important; }

.case-meta{
  padding: 12px !important;
  margin-bottom: 12px !important;
}
.case-message{
  padding: 12px !important;
  margin-bottom: 12px !important;
  font-size: 14px !important;
}

.case-assigned{
  padding: 10px 12px !important;
  margin-bottom: 12px !important;
}
.case-assigned-avatar{
  width: 34px !important;
  height: 34px !important;
  font-size: 14px !important;
}
.case-assigned-name{ font-size: 15px !important; }

.case-actions{ gap: 8px !important; }
.case-actions .btn{
  min-width: 104px !important;
  padding: 10px 12px !important;
  font-size: 12px !important;
}

/* ä¸Šéƒ¨ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼/çµ±è¨ˆ/ãƒ•ã‚£ãƒ«ã‚¿ï¼‰ã‚‚å°‘ã—åœ§ç¸® */
.header{
  padding: 16px 22px !important;
  margin-bottom: 14px !important;
}
.header h1{ font-size: 1.85rem !important; }
.header-actions .btn{ padding: 10px 14px !important; }

.qc-quick-bar{ gap: 8px !important; }
.qc-quick-item{ padding: 8px 10px !important; gap: 8px !important; }
.qc-mini-toggle span{ padding: 5px 8px !important; }

.stats-grid{
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)) !important;
  gap: 14px !important;
  margin-bottom: 18px !important;
}
.stat-card{ padding: 20px !important; border-radius: 16px !important; }
.stat-label{ font-size: 1.05rem !important; margin-bottom: 10px !important; }
.stat-value{ font-size: 3.2rem !important; }

.filter-bar{ margin-bottom: 14px !important; padding: 10px !important; }
.filter-btn{ padding: 10px 12px !important; font-size: 14px !important; }

/* å¤§ç”»é¢TVã¯â€œæ‹¡å¤§â€ã‚ˆã‚Šâ€œé«˜å¯†åº¦â€å„ªå…ˆ */
@media (min-width: 1600px){
  body{ font-size: 16px !important; padding: 16px !important; }
  .cases-container{
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)) !important;
    gap: 12px !important;
  }
  .stat-value{ font-size: 3.4rem !important; }
}
/* ===== ã‚«ãƒ¼ãƒ‰ä¸€è¦§ï¼šæœ€å¤§4åˆ— ===== */
.cases-container{
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr)); /* MAX4åˆ— */
  gap: 14px;
  width: 100%;
}

/* ç”»é¢ãŒç‹­ã„å ´åˆã¯è‡ªå‹•ã§åˆ—ã‚’æ¸›ã‚‰ã™ */
@media (max-width: 1400px){
  .cases-container{
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
}
@media (max-width: 1050px){
  .cases-container{
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}
@media (max-width: 700px){
  .cases-container{
    grid-template-columns: 1fr;
  }
}
.case-card{
  max-width: 380px;
}
.case-card{
  font-size: 0.95rem;   /* â† ç´„5%ãƒ€ã‚¦ãƒ³ */
}
.badge,
.status-badge{
  font-size: 0.75rem;
  padding: 4px 8px;
  border-radius: 10px;
}
/* çµŒéæ™‚é–“ãƒãƒƒã‚¸ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
.elapsed-badge{
  padding: 2px 6px;      /* â† ã“ã“ãŒè‚ */
  font-size: 0.72rem;    /* æ–‡å­—ã¯æ°—æŒã¡ã ã‘ */
  line-height: 1.1;     /* ç¸¦æ–¹å‘ã®ãƒ ãƒ€ã‚’å‰Šã‚‹ */
  border-radius: 8px;
}

</style>
</head>

<body>
  <div class="page">
    <div class="header">
      <h1>ğŸ“¢ å“è³ªå‘¼ã³å‡ºã—ãƒ¢ãƒ‹ã‚¿ãƒ¼</h1>

      <div class="header-actions">
        <label class="sound-toggle" title="ONã«ã™ã‚‹ã¨éŸ³å£°ãŒé³´ã‚Šã¾ã™ï¼ˆåˆå›ã¯éŸ³ã®è§£éŒ ãŒå¿…è¦ã§ã™ï¼‰">
          <input type="checkbox" id="soundNotification">
          <span>ğŸ”Š éŸ³å£°é€šçŸ¥</span>
        </label>

        <button class="btn btn-secondary" id="qcMembersBtn">ğŸ‘¥ QCãƒ¡ãƒ³ãƒãƒ¼</button>
        <button class="btn btn-logout" id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>

      <div id="qcQuickBar" class="qc-quick-bar" aria-label="QCå¯¾å¿œå¯å¦ãƒˆã‚°ãƒ«"></div>
    </div>

    <div class="stats-grid">
      <div class="stat-card urgent">
        <div class="stat-label">ç·Šæ€¥ãƒ»æœªå¯¾å¿œ</div>
        <div class="stat-value" id="statUrgentPending">0</div>
      </div>
      <div class="stat-card normal">
        <div class="stat-label">é€šå¸¸ãƒ»æœªå¯¾å¿œ</div>
        <div class="stat-value" id="statNormalPending">0</div>
      </div>
      <div class="stat-card inprogress">
        <div class="stat-label">å¯¾å¿œä¸­</div>
        <div class="stat-value" id="statInProgress">0</div>
      </div>
      <div class="stat-card completed">
        <div class="stat-label">æœ¬æ—¥å®Œäº†</div>
        <div class="stat-value" id="statCompletedToday">0</div>
      </div>
    </div>

    <div class="filter-bar">
      <button class="filter-btn active" data-filter="all">ã™ã¹ã¦</button>
      <button class="filter-btn" data-filter="pending">æœªå¯¾å¿œ</button>
      <button class="filter-btn" data-filter="inprogress">å¯¾å¿œä¸­</button>
      <button class="filter-btn" data-filter="completed">å®Œäº†</button>
    </div>

    <div id="casesContainer" class="cases-container"></div>

    <!-- å¯¾å¿œï¼ˆé–‹å§‹/å®Œäº†ï¼‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="completeModal" class="modal">
      <div class="modal-content">
        <h3 id="completeModalTitle">å¯¾å¿œå®Œäº†</h3>

        <div style="margin-bottom:15px;">
          <label style="display:block;font-weight:1000;margin-bottom:8px;">æ‹…å½“è€… *</label>
          <select id="completeBySelect" class="select">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
          <div style="margin-top:8px;color:#666;font-size:.85rem;">
            â€» å€™è£œã¯ <b>qc_members</b>ï¼ˆenabled=trueï¼‰ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã™
          </div>
        </div>

        <div>
          <label style="display:block;font-weight:1000;margin-bottom:8px;">å¯¾å¿œå†…å®¹ï¼ˆä»»æ„ï¼‰</label>
          <textarea id="completeMessage" placeholder="å®Ÿæ–½ã—ãŸå¯¾å¿œå†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„."></textarea>
        </div>

        <div class="modal-actions">
          <button class="btn btn-save" id="confirmComplete">ä¿å­˜</button>
          <button class="btn btn-cancel" id="cancelComplete">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
    </div>

    <!-- QCãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="qcMembersModal" class="modal">
      <div class="modal-content">
        <h3>ğŸ‘¥ QCãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</h3>

        <div class="panel">
          <div style="font-weight:1000;color:#3949ab;margin-bottom:10px;">æ–°è¦è¿½åŠ </div>
          <div class="row">
            <input id="qcNewName" class="input" placeholder="æ°åï¼ˆä¾‹ï¼šæ‰æœ¬ï¼‰">
            <input id="qcNewEmail" class="input" placeholder="ãƒ¡ãƒ¼ãƒ«ï¼ˆä¾‹ï¼šxxx@miyama...ï¼‰">
            <input id="qcNewPriority" class="input" type="number" min="1" step="1" placeholder="å„ªå…ˆåº¦ï¼ˆå°ã•ã„ã»ã©å„ªå…ˆï¼‰" value="50">
          </div>
          <div style="display:flex; gap:10px; margin-top:10px; align-items:center; flex-wrap:wrap;">
            <label class="toggle" style="background:#fff;border:2px solid #ddd;border-radius:10px;padding:10px 12px;">
              <input type="checkbox" id="qcNewAvailable" checked>
              <span>å¯¾å¿œå¯ï¼ˆå‰²å½“å¯¾è±¡ï¼‰</span>
            </label>
          </div>
          <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-secondary" id="qcCloseBtn" style="flex:1;">é–‰ã˜ã‚‹</button>
            <button class="btn btn-save" id="qcAddBtn" style="flex:1;">è¿½åŠ </button>
          </div>
          <div style="margin-top:10px;color:#666;font-size:.85rem;">
            â€» enabled=true ã®ãƒ¡ãƒ³ãƒãƒ¼ã ã‘ãŒã€Œæ‹…å½“è€…é¸æŠã€ã«å‡ºã¾ã™
          </div>
        </div>

        <div class="panel">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <div style="font-weight:1000;color:#3949ab;">ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§</div>
            <span class="pill">ä»¶æ•°: <span id="qcCount">0</span></span>
          </div>
          <div id="qcList" class="list"></div>
        </div>
      </div>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
    import {
      getFirestore,
      collection, onSnapshot, query, orderBy,
      addDoc, updateDoc, setDoc, deleteDoc, doc, serverTimestamp, getDoc, runTransaction, arrayUnion
    } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyA0YUIpIDh4WB4p1ewiNB0XfwHve0ByljU",
      authDomain: "abnreport-fd733.firebaseapp.com",
      projectId: "abnreport-fd733",
      storageBucket: "abnreport-fd733.firebasestorage.app",
      messagingSenderId: "349748947315",
      appId: "1:349748947315:web:010cb671d2a95bcf1f7d06"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    // ===== è‡ªå‹•å‰²å½“ãƒ»é€£ç¶šå¯¾å¿œãƒšãƒŠãƒ«ãƒ†ã‚£è¨­å®š =====
    const ASSIGN_STATE_REF = doc(db,'system','assignment_state');
    const PENALTY_MS = 2 * 60 * 60 * 1000; // 2æ™‚é–“


    // ç•°å¸¸å±¥æ­´ã‚¢ãƒ—ãƒªURLï¼ˆåŒéšå±¤ï¼‰
    const ANOMALY_APP_URL = './abnormality_history.html';

    let casesCache = [];
    let currentCompleteCase = null;
    let modalMode = 'complete'; // 'inprogress' or 'complete'

    // ===== sound =====
    let soundEnabled = localStorage.getItem('sound_enabled') === 'true';
    const soundCheckbox = document.getElementById('soundNotification');
    soundCheckbox.checked = soundEnabled;

    // æ–°è¦æ¤œçŸ¥ç”¨
    let previousCaseIds = new Set();

    // ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒ åˆ¶å¾¡
    let urgentAlarmTimer = null;
    let hasUrgentPending = false;
    let prevHasUrgentPending = false;
    const URGENT_ALARM_INTERVAL_MS = 8000; // 8ç§’ã”ã¨ï¼ˆå¥½ã¿ã§å¤‰æ›´OKï¼‰

    // Audio
    let audioCtx = null;

    async function unlockAudio() {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if (!AudioCtx) return false;
      try {
        audioCtx = audioCtx || new AudioCtx();
        if (audioCtx.state === 'suspended') await audioCtx.resume();

        // ç„¡éŸ³ãƒãƒƒãƒ•ã‚¡ã§è§£éŒ 
        const buffer = audioCtx.createBuffer(1, 1, audioCtx.sampleRate);
        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(audioCtx.destination);
        source.start(0);
        return true;
      } catch (e) {
        console.warn(e);
        return false;
      }
    }

    // âœ… 2ç¨®é¡ãƒãƒ£ã‚¤ãƒ ï¼ˆé€šå¸¸ / ç·Šæ€¥ï¼‰
// âœ… èããªã˜ã¿ã®ã‚ã‚‹ãƒ¡ãƒ­ãƒ‡ã‚£ã«å¤‰æ›´
// é€šå¸¸ï¼šã‚¦ã‚§ã‚¹ãƒˆãƒŸãƒ³ã‚¹ã‚¿ãƒ¼ãƒãƒ£ã‚¤ãƒ ï¼ˆE5â†’C5â†’D5â†’G4ï¼‰
// ç·Šæ€¥ï¼šãƒ”ãƒãƒ”ãƒã‚¢ãƒ©ãƒ¼ãƒ ï¼ˆæ•‘æ€¥è»Šãƒ»å·¥å ´ã‚µã‚¤ãƒ¬ãƒ³é¢¨ï¼‰
function playChime(type = 'normal') {
  if (!soundEnabled) return;
  if (!audioCtx) return;

  const ctx = audioCtx;
  const t0 = ctx.currentTime;

  // â”€â”€ ãƒ™ãƒ«éŸ³ç¬¦ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆã‚µã‚¤ãƒ³æ³¢ + è‡ªç„¶ãªæ¸›è¡°ï¼‰ â”€â”€
  function bellNote(freq, startSec, durSec, vol = 0.45) {
    const osc  = ctx.createOscillator();
    const gain = ctx.createGain();

    osc.type = 'sine';
    osc.frequency.setValueAtTime(freq, t0 + startSec);

    // å€éŸ³ï¼ˆã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸Šã‚’è–„ãé‡ã­ã¦é‡‘å±ã£ã½ã•ã‚’è¿½åŠ ï¼‰
    const osc2  = ctx.createOscillator();
    const gain2 = ctx.createGain();
    osc2.type = 'sine';
    osc2.frequency.setValueAtTime(freq * 2, t0 + startSec);

    gain.gain.setValueAtTime(0.0001, t0 + startSec);
    gain.gain.linearRampToValueAtTime(vol, t0 + startSec + 0.012);
    gain.gain.exponentialRampToValueAtTime(0.0001, t0 + startSec + durSec);

    gain2.gain.setValueAtTime(0.0001, t0 + startSec);
    gain2.gain.linearRampToValueAtTime(vol * 0.22, t0 + startSec + 0.012);
    gain2.gain.exponentialRampToValueAtTime(0.0001, t0 + startSec + durSec * 0.6);

    osc.connect(gain);   gain.connect(ctx.destination);
    osc2.connect(gain2); gain2.connect(ctx.destination);

    osc.start(t0 + startSec);  osc.stop(t0 + startSec + durSec);
    osc2.start(t0 + startSec); osc2.stop(t0 + startSec + durSec);
  }

  // â”€â”€ ãƒ”ãƒéŸ³ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆçŸ©å½¢æ³¢ + ãƒ­ãƒ¼ãƒ‘ã‚¹ã§è€³ã«å„ªã—ãï¼‰ â”€â”€
  function pipoNote(freq, startSec, durSec, vol = 0.22) {
    const osc    = ctx.createOscillator();
    const filter = ctx.createBiquadFilter();
    const gain   = ctx.createGain();

    osc.type = 'square';
    osc.frequency.setValueAtTime(freq, t0 + startSec);

    filter.type            = 'lowpass';
    filter.frequency.value = 1800;   // é«˜åŸŸã‚’ä¸¸ã‚ã‚‹

    gain.gain.setValueAtTime(0.0001, t0 + startSec);
    gain.gain.linearRampToValueAtTime(vol, t0 + startSec + 0.01);
    gain.gain.setValueAtTime(vol,         t0 + startSec + durSec - 0.03);
    gain.gain.linearRampToValueAtTime(0.0001, t0 + startSec + durSec);

    osc.connect(filter);
    filter.connect(gain);
    gain.connect(ctx.destination);

    osc.start(t0 + startSec);
    osc.stop(t0 + startSec + durSec);
  }

  if (type === 'normal') {
    // â”â” ã‚¦ã‚§ã‚¹ãƒˆãƒŸãƒ³ã‚¹ã‚¿ãƒ¼ãƒãƒ£ã‚¤ãƒ ï¼ˆç¬¬1å››åŠï¼‰ â”â”
    // E5 â†’ C5 â†’ D5 â†’ G4
    bellNote(659.3, 0.00, 0.55);   // E5
    bellNote(523.3, 0.55, 0.55);   // C5
    bellNote(587.3, 1.10, 0.55);   // D5
    bellNote(392.0, 1.65, 1.10);   // G4ï¼ˆé•·ã‚ï¼‰

  } else {
    // â”â” ãƒ”ãƒãƒ”ãƒã‚¢ãƒ©ãƒ¼ãƒ ï¼ˆ880Hz/660Hz ã‚’äº¤äº’ã«6å›ï¼‰ â”â”
    const HI  = 880.0;  // A5
    const LO  = 660.0;  // E5
    const LEN = 0.22;   // 1éŸ³ã®é•·ã•
    const GAP = 0.26;   // é–“éš”

    for (let i = 0; i < 6; i++) {
      pipoNote(i % 2 === 0 ? HI : LO, i * GAP, LEN);
    }
  }
}

    function stopUrgentAlarm(){
      if (urgentAlarmTimer) {
        clearInterval(urgentAlarmTimer);
        urgentAlarmTimer = null;
      }
    }

    function startUrgentAlarm(){
      if (urgentAlarmTimer) return;
      playChime('urgent');
      urgentAlarmTimer = setInterval(() => {
        if (!soundEnabled || !hasUrgentPending) {
          stopUrgentAlarm();
          return;
        }
        playChime('urgent');
      }, URGENT_ALARM_INTERVAL_MS);
    }

    function updateUrgentAlarmState(){
      if (!soundEnabled) { stopUrgentAlarm(); return; }
      if (!audioCtx) return;
      if (hasUrgentPending) startUrgentAlarm();
      else stopUrgentAlarm();
    }

    soundCheckbox.addEventListener('change', async (e) => {
      soundEnabled = e.target.checked;
      localStorage.setItem('sound_enabled', soundEnabled);

      if (soundEnabled) {
        const ok = await unlockAudio();
        if (!ok) {
          alert('ã“ã®ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŸ³å£°å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚åˆ¥ãƒ–ãƒ©ã‚¦ã‚¶ã‹è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
          return;
        }
        updateUrgentAlarmState();
        if (!hasUrgentPending) playChime('normal'); // ONç¢ºèª
      } else {
        stopUrgentAlarm();
      }
    });

    // ===== QC members =====
    let qcMembers = []; // {id,name,email,enabled,updatedAt}


    async function checkAndRevertPenalties(){
      const now = Date.now();
      // qcMembers é…åˆ—ã‚’è¦‹ã¦æœŸé™åˆ‡ã‚Œã®ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’æˆ»ã™ï¼ˆæ‰‹å‹•å¤‰æ›´ã¯å°Šé‡ï¼‰
      for(const m of qcMembers){
        const until = Number(m.penaltyUntilMs || 0);
        const orig = (m.penaltyOriginalPriority === 0) ? 0 : Number(m.penaltyOriginalPriority || NaN);
        const delta = Number(m.penaltyDelta || 1);

        if(!until || !isFinite(orig)) continue;
        if(until > now) continue;

        const curPr = Number(m.priority || 0);
        const expected = orig + delta;

        const ref = doc(db,'qc_members', m.id);
        const payload = { penaltyUntilMs: null, penaltyOriginalPriority: null, penaltyDelta: null, penaltyAppliedAtMs: null };

        // ãã®ã¾ã¾ã®å€¤ãªã‚‰æˆ»ã™ï¼é•ã£ã¦ã„ã‚Œã°å„ªå…ˆåº¦ã¯è§¦ã‚‰ãšã«ãƒšãƒŠãƒ«ãƒ†ã‚£æƒ…å ±ã ã‘ã‚¯ãƒªã‚¢
        if(curPr === expected){
          payload.priority = orig;
        }
        try{ await updateDoc(ref, payload); }catch(e){ /* noop */ }
      }
    }

    function openQcMembersModal(){
      document.getElementById('qcMembersModal').classList.add('active');
    }
    function closeQcMembersModal(){
      document.getElementById('qcMembersModal').classList.remove('active');
    }

    document.getElementById('qcMembersBtn').addEventListener('click', (e)=>{
      e.preventDefault();
      openQcMembersModal();
    });
    document.getElementById('qcCloseBtn').addEventListener('click', closeQcMembersModal);

    function setupQcMembersListener(){
      const q = query(collection(db,'qc_members'), orderBy('name','asc'));
      onSnapshot(q, (snap)=>{
        qcMembers = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        checkAndRevertPenalties();
        renderQcMembers();
        renderQcQuickBar();
        renderResponderSelect();
      });
    }

    function renderQcMembers(){
      const list = document.getElementById('qcList');
      const count = document.getElementById('qcCount');
      count.textContent = String(qcMembers.length);

      if(qcMembers.length === 0){
        list.innerHTML = `<div style="color:#777;text-align:center;padding:14px;">ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“</div>`;
        return;
      }

      list.innerHTML = qcMembers.map(m=>{
        const name = escapeHtml(m.name || '');
        const email = escapeHtml(m.email || '');
        const enabled = !!m.enabled;
        return `
          <div class="item">
            <div style="min-width:0;">
              <div style="font-weight:1000;color:#263238;">${name}</div>
              <small>${email}</small>
            </div>
            <div style="display:flex;align-items:center;gap:10px; flex-wrap:wrap; justify-content:flex-end;">
              <label class="toggle">
                <input type="checkbox" data-qc-toggle="${m.id}" ${enabled ? 'checked':''}>
                <span>æœ‰åŠ¹</span>
              </label>
              <label class="toggle" title="OFFã«ã™ã‚‹ã¨è‡ªå‹•å‰²å½“ã®å¯¾è±¡å¤–ã«ãªã‚Šã¾ã™">
                <input type="checkbox" data-qc-available="${m.id}" ${((m.available ?? true) ? 'checked':'')}>
                <span>å¯¾å¿œå¯</span>
              </label>
              <label class="toggle" title="å°ã•ã„ã»ã©å„ªå…ˆã—ã¦å‰²å½“ã•ã‚Œã¾ã™" style="gap:6px;">
                <span>å„ªå…ˆåº¦</span>
                <input class="input" style="width:92px;padding:10px 10px;border-radius:10px;" type="number" min="1" step="1"
                       data-qc-priority="${m.id}" value="${Number(m.priority ?? 50)}">
              </label>
              <button class="btn btn-secondary" data-qc-del="${m.id}" style="padding:10px 12px;">å‰Šé™¤</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderQcQuickBar(){
      const bar = document.getElementById('qcQuickBar');
      if(!bar) return;

      if(!qcMembers || qcMembers.length === 0){
        bar.innerHTML = '';
        return;
      }

      const list = [...qcMembers]
        .sort((a,b)=>{
          const pa = Number(a.priority ?? 50);
          const pb = Number(b.priority ?? 50);
          if(pa !== pb) return pa - pb;
          return String(a.name||'').localeCompare(String(b.name||''), 'ja');
        });

      bar.innerHTML = list.map(m=>{
        const name = escapeHtml(m.name || '');
        const enabled = !!m.enabled;
        const avail = (m.available ?? true);

        // ç„¡åŠ¹ãƒ¡ãƒ³ãƒãƒ¼ã¯è¡¨ç¤ºã‚’è–„ãã—ã¤ã¤ã€ãƒˆã‚°ãƒ«ã¯è§¦ã‚Œã‚‹ï¼ˆé‹ç”¨ã§ä½¿ã†å ´åˆãŒã‚ã‚‹ãŸã‚ï¼‰
        const cls = `qc-quick-item ${avail ? '' : 'off'}` + (enabled ? '' : ' off');

        return `
          <div class="${cls}" title="å„ªå…ˆåº¦: ${Number(m.priority ?? 50)} / ${enabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}">
            <span class="qc-name">${name}</span>
            <label class="qc-mini-toggle" title="å¯¾å¿œå¯/ä¸å¯">
              <input type="checkbox" data-qc-available="${m.id}" ${avail ? 'checked' : ''}>
              <span>${avail ? 'å¯¾å¿œå¯' : 'å¯¾å¿œä¸å¯'}</span>
            </label>
          </div>
        `;
      }).join('');
    }


    document.getElementById('qcAddBtn').addEventListener('click', async ()=>{
      const name = document.getElementById('qcNewName').value.trim();
      const email = document.getElementById('qcNewEmail').value.trim();

      if(!name){
        alert('æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      if(email && !email.includes('@')){
        alert('ãƒ¡ãƒ¼ãƒ«ãŒä¸æ­£ã§ã™ï¼ˆç©ºã§ã‚‚OKï¼‰');
        return;
      }

      try{
        await addDoc(collection(db,'qc_members'),{
          name,
          email: email || '',
          enabled: true,
          priority: Number(document.getElementById('qcNewPriority')?.value || 50),
          available: !!document.getElementById('qcNewAvailable')?.checked,
          updatedAt: serverTimestamp()
        });
        document.getElementById('qcNewName').value = '';
        document.getElementById('qcNewEmail').value = '';
        if(document.getElementById('qcNewPriority')) document.getElementById('qcNewPriority').value = 50;
        if(document.getElementById('qcNewAvailable')) document.getElementById('qcNewAvailable').checked = true;
      }catch(e){
        console.error(e);
        alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e.message || e));
      }
    });

    document.addEventListener('change', async (e)=>{
      const el = e.target;

      const idEnabled = el?.getAttribute?.('data-qc-toggle');
      const idAvail   = el?.getAttribute?.('data-qc-available');
      const idPrio    = el?.getAttribute?.('data-qc-priority');

      const id = idEnabled || idAvail || idPrio;
      if(!id) return;

      const patch = { updatedAt: serverTimestamp() };

      if(idEnabled) patch.enabled = !!el.checked;
      if(idAvail)   patch.available = !!el.checked;
      if(idPrio)    patch.priority = Math.max(1, Number(el.value || 50));

      try{
        await updateDoc(doc(db,'qc_members',id), patch);
      }catch(err){
        console.error(err);
        alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });

    document.addEventListener('click', async (e)=>{
      const delBtn = e.target.closest('[data-qc-del]');
      if(!delBtn) return;

      const id = delBtn.getAttribute('data-qc-del');
      const m = qcMembers.find(x=>x.id===id);
      if(!id) return;

      const name = m?.name || '';
      if(!confirm(`å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n${name}`)) return;

      try{
        await deleteDoc(doc(db,'qc_members',id));
      }catch(err){
        console.error(err);
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });

    document.getElementById('qcMembersModal').addEventListener('click', (e)=>{
      if(e.target.id === 'qcMembersModal') closeQcMembersModal();
    });

    function renderResponderSelect(){
      const sel = document.getElementById('completeBySelect');
      if(!sel) return;

      const prev = sel.value || '';
      const responders = qcMembers
        .filter(m=>!!m.enabled)
        .map(m=>String(m.name||'').trim())
        .filter(Boolean);

      sel.innerHTML = [
        `<option value="">é¸æŠã—ã¦ãã ã•ã„</option>`,
        ...responders.map(n=>`<option value="${escapeAttr(n)}">${escapeHtml(n)}</option>`)
      ].join('');

      if(prev && responders.includes(prev)) sel.value = prev;
    }

    // ===== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ =====
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        stopUrgentAlarm();
        await signOut(auth);
        window.location.href = './quality_andon.html';
      }
    });

    // ===== èªè¨¼ãƒã‚§ãƒƒã‚¯ =====
    onAuthStateChanged(auth, (user) => {
      if (user) {
        setupQcMembersListener();
        setupRealtimeListener();
      } else {
        alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
        window.location.href = './quality_andon.html';
      }
    });

    // ===== ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ï¼ˆquality_casesï¼‰ =====
    let currentFilter = 'all';

    function setupRealtimeListener() {
      const q = query(collection(db, 'quality_cases'), orderBy('createdAt', 'desc'));

      onSnapshot(q, async (snapshot) => {
        const newCases = [];
        const newlyDetectedNormalPending = [];

        snapshot.forEach(docSnap => {
          const data = { _id: docSnap.id, ...docSnap.data() };
          newCases.push(data);

          // æ–°è¦æ¤œçŸ¥ï¼ˆpendingã®ã¿ï¼‰
          if ((data.status || 'pending') === 'pending' && !previousCaseIds.has(docSnap.id)) {
            if ((data.priority || 'normal') !== 'urgent') {
              newlyDetectedNormalPending.push(docSnap.id);
            }
          }
          previousCaseIds.add(docSnap.id);
        });

        casesCache = newCases;

        // ===== è‡ªå‹•å‰²å½“ï¼ˆæœªå¯¾å¿œã®æ¡ˆä»¶ã«ã€Œâ—¯â—¯ã•ã‚“å¯¾å¿œã—ã¦ãã ã•ã„ã€ã‚’ä»˜ä¸ï¼‰ =====
        try{ await autoAssignForPendingCases(); }catch(e){ console.warn('autoAssign failed', e); }

        renderCases();
        updateStats();

        // ç·Šæ€¥pendingã®æœ‰ç„¡ï¼ˆå¯¾å¿œé–‹å§‹=inprogressã«ãªã‚‹ã¾ã§é³´ã‚‹ï¼‰
        prevHasUrgentPending = hasUrgentPending;
        hasUrgentPending = casesCache.some(c => (c.priority || 'normal') === 'urgent' && (c.status || 'pending') === 'pending');

        // é€šå¸¸ã®æ–°è¦pendingï¼šç·Šæ€¥ãŒç„¡ã„æ™‚ã ã‘é€šå¸¸ãƒãƒ£ã‚¤ãƒ 
        if (soundEnabled && audioCtx && newlyDetectedNormalPending.length > 0 && !hasUrgentPending) {
          playChime('normal');
        }

        // ç·Šæ€¥pendingã®é–‹å§‹/åœæ­¢
        if (soundEnabled && audioCtx) {
          if (!prevHasUrgentPending && hasUrgentPending) startUrgentAlarm();
          if (prevHasUrgentPending && !hasUrgentPending) stopUrgentAlarm();
        }
      });
    }

    
    // ===== è‡ªå‹•å‰²å½“ãƒ­ã‚¸ãƒƒã‚¯ =====
    // ãƒ«ãƒ¼ãƒ«ï¼š
    // - qc_members.enabled=true ã‹ã¤ available=true ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’ã€Œå„ªå…ˆåº¦ï¼ˆpriorityï¼šå°ã•ã„ã»ã©å„ªå…ˆï¼‰ã€ã§ã‚½ãƒ¼ãƒˆ
    // - ã™ã§ã«åˆ¥ä»¶ãŒã€Œå¯¾å¿œä¸­(inprogress)ã€ã®äººã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå¿™ã—ã„æ‰±ã„ï¼‰
    // - æ¡ˆä»¶ã§ã€Œå¯¾å¿œä¸å¯ã€ã‚’æŠ¼ã•ã‚ŒãŸäººï¼ˆdeclinedByï¼‰ã‚‚ã‚¹ã‚­ãƒƒãƒ—
    // - quality_cases ãŒ pending ã§ assignedTo ãŒç©ºã®ã¨ãã ã‘è‡ªå‹•å‰²å½“ï¼ˆç«¶åˆã¯ transaction ã§é˜²æ­¢ï¼‰
    function getBusyResponderNameSet(){
      const busy = new Set();
      casesCache.forEach(c=>{
        if((c.status||'pending') === 'inprogress' && c.respondedBy){
          busy.add(String(c.respondedBy).trim());
        }
      });
      return busy;
    }

    function getEligibleMembersSorted(){
      return qcMembers
        .filter(m=>!!m.enabled)
        .filter(m=> (m.available ?? true) === true)
        .map(m=>({
          id: m.id,
          name: String(m.name||'').trim(),
          priority: Number(m.priority ?? 50),
        }))
        .filter(m=>!!m.name)
        .sort((a,b)=>{
          if(a.priority !== b.priority) return a.priority - b.priority;
          return a.name.localeCompare(b.name,'ja');
        });
    }

    function pickAssigneeForCase(caseData){
      const busy = getBusyResponderNameSet();
      const declined = new Set((caseData.declinedBy || []).map(x=>String(x||'').trim()).filter(Boolean));
      const members = getEligibleMembersSorted();

      for(const m of members){
        if(busy.has(m.name)) continue;
        if(declined.has(m.name)) continue;
        return m.name;
      }
      return '';
    }

    async function assignCaseIfEmpty(caseId, assignee, reason='auto'){
      if(!caseId || !assignee) return;

      const ref = doc(db,'quality_cases',caseId);

      // è¤‡æ•°ç«¯æœ«ã§ãƒ¢ãƒ‹ã‚¿ãƒ¼ã‚’é–‹ã„ã¦ã„ã¦ã‚‚äºŒé‡å‰²å½“ã«ãªã‚‰ãªã„ã‚ˆã† transaction
      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        if(!snap.exists()) return;

        const d = snap.data() || {};
        const status = d.status || 'pending';

        // pending ä»¥å¤– / æ—¢ã«å‰²å½“æ¸ˆã¿ ã¯è§¦ã‚‰ãªã„
        if(status !== 'pending') return;
        if((d.assignedTo || '').trim()) return;

        
        // ===== é€£ç¶šå¯¾å¿œãƒšãƒŠãƒ«ãƒ†ã‚£ï¼ˆåŒä¸€ãƒ¡ãƒ³ãƒãƒ¼ãŒ2å›é€£ç¶šã§å‰²å½“ã•ã‚ŒãŸã‚‰ priority +1ï¼‰ =====
        const stateSnap = await tx.get(ASSIGN_STATE_REF);
        const state = stateSnap.exists() ? (stateSnap.data() || {}) : {};
        const lastUid = String(state.lastUid || '');
        const streak = Number(state.streak || 0);

        let nextStreak = 1;
        if(lastUid && lastUid === assignee){
          nextStreak = streak + 1;
        }

        const shouldPenalty = (lastUid && lastUid === assignee && nextStreak >= 2);
        const nowMs = Date.now();

        // stateæ›´æ–°ï¼ˆãƒšãƒŠãƒ«ãƒ†ã‚£ç™ºå‹•ã—ãŸã‚‰ streak ã‚’0ã«æˆ»ã—ã¦é€£æ‰“åŠ ç®—ã‚’é˜²æ­¢ï¼‰
        tx.set(ASSIGN_STATE_REF, {
          lastUid: assignee,
          streak: shouldPenalty ? 0 : nextStreak,
          updatedAt: serverTimestamp()
        }, { merge: true });

        if(shouldPenalty){
          const mRef = doc(db,'qc_members', assignee);
          const mSnap = await tx.get(mRef);
          if(mSnap.exists()){
            const md = mSnap.data() || {};
            const curPriority = Number(md.priority || 0);

            // ã™ã§ã«ãƒšãƒŠãƒ«ãƒ†ã‚£ä¸­ãªã‚‰é‡ã­æ›ã‘ã—ãªã„
            const until = Number(md.penaltyUntilMs || 0);
            if(!until || until <= nowMs){
              tx.update(mRef, {
                priority: curPriority + 1,
                penaltyOriginalPriority: curPriority,
                penaltyDelta: 1,
                penaltyAppliedAtMs: nowMs,
                penaltyUntilMs: nowMs + PENALTY_MS
              });
            }
          }
        }

tx.update(ref,{
          assignedTo: assignee,
          assignedAt: serverTimestamp(),
          assignedReason: reason,
          assignmentHistory: arrayUnion({
            at: new Date().toISOString(),
            to: assignee,
            reason
          })
        });
      });
    }

    async function reassignToNext(caseData){
      if(!caseData?._id) return;

      const current = String(caseData.assignedTo || '').trim();
      const next = pickAssigneeForCase({
        ...caseData,
        declinedBy: Array.from(new Set([...(caseData.declinedBy||[]), current].filter(Boolean)))
      });

      const ref = doc(db,'quality_cases',caseData._id);

      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        if(!snap.exists()) return;
        const d = snap.data() || {};
        const status = d.status || 'pending';
        if(status !== 'pending') return;

        const declined = Array.isArray(d.declinedBy) ? d.declinedBy.slice() : [];
        if(current) declined.push(current);

        // æ¬¡ãŒã„ãªã„å ´åˆï¼šassignedTo ã‚’ç©ºã«ã—ã€declinedByã ã‘æ›´æ–°
        if(!next){
          tx.update(ref,{
            assignedTo: '',
            declinedBy: Array.from(new Set(declined.map(x=>String(x||'').trim()).filter(Boolean))),
            assignedAt: serverTimestamp(),
            assignedReason: 'no_candidate',
            assignmentHistory: arrayUnion({
              at: new Date().toISOString(),
              to: '',
              reason: 'no_candidate'
            })
          });
          return;
        }

        tx.update(ref,{
          assignedTo: next,
          declinedBy: Array.from(new Set(declined.map(x=>String(x||'').trim()).filter(Boolean))),
          assignedAt: serverTimestamp(),
          assignedReason: 'declined',
          assignmentHistory: arrayUnion({
            at: new Date().toISOString(),
            to: next,
            reason: 'declined'
          })
        });
      });
    }

    async function autoAssignForPendingCases(){
      // qcMembers ãŒã¾ã æ¥ã¦ãªã„ / å‰²å½“å€™è£œãŒã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
      const members = getEligibleMembersSorted();
      if(members.length === 0) return;

      // pending ã§ assignedTo ãŒç©ºã®æ¡ˆä»¶ã ã‘å¯¾è±¡ï¼ˆç·Šæ€¥å„ªå…ˆï¼šurgentã‹ã‚‰å‰²å½“ï¼‰
      const pending = casesCache
        .filter(c => (c.status || 'pending') === 'pending')
        .filter(c => !String(c.assignedTo || '').trim())
        .slice()
        .sort((a,b)=>{
          const pa = (a.priority||'normal') === 'urgent' ? 0 : 1;
          const pb = (b.priority||'normal') === 'urgent' ? 0 : 1;
          if(pa !== pb) return pa - pb;
          const ta = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
          const tb = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
          return ta - tb; // å¤ã„é †ã«å‰²å½“ï¼ˆå…ˆç€ï¼‰
        });

      for(const c of pending){
        const assignee = pickAssigneeForCase(c);
        if(!assignee) continue;
        await assignCaseIfEmpty(c._id, assignee, 'auto');
      }
    }


    // ===== æ¡ˆä»¶è¡¨ç¤º =====
    function renderCases() {
      const container = document.getElementById('casesContainer');

      // è¡¨ç¤ºé †ï¼šæœªå¯¾å¿œ â†’ å¯¾å¿œä¸­ â†’ å®Œäº†
      const statusOrder = { pending: 1, inprogress: 2, completed: 3 };

      let list = casesCache.slice();
      list.sort((a,b)=>{
        const oa = statusOrder[a.status] ?? 9;
        const ob = statusOrder[b.status] ?? 9;
        if (oa !== ob) return oa - ob;
        const ta = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
        const tb = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
        return tb - ta;
      });

    // çµŒéæ™‚é–“ã‚’è¨ˆç®—ã—ã¦ãƒãƒƒã‚¸HTMLã‚’ç”Ÿæˆ
    function getElapsedTimeBadge(createdAt) {
      if (!createdAt) return '';
      
      const now = new Date();
      const created = createdAt.toDate ? createdAt.toDate() : new Date(createdAt);
      const diffMs = now - created;
      const diffMins = Math.floor(diffMs / (1000 * 60));
      
      let timeText = '';
      let badgeClass = '';
      
      if (diffMins < 60) {
        timeText = `${diffMins}åˆ†`;
        badgeClass = diffMins > 30 ? 'warning' : '';
      } else if (diffMins < 1440) { // 24æ™‚é–“æœªæº€
        const hours = Math.floor(diffMins / 60);
        const mins = diffMins % 60;
        timeText = `${hours}æ™‚é–“${mins > 0 ? mins + 'åˆ†' : ''}`;
        badgeClass = hours >= 2 ? 'urgent' : (hours >= 1 ? 'warning' : '');
      } else {
        const days = Math.floor(diffMins / 1440);
        timeText = `${days}æ—¥`;
        badgeClass = 'urgent';
      }
      
      return `<span class="elapsed-time-badge ${badgeClass}">â±ï¸ ${timeText}çµŒé</span>`;
    }

      if(currentFilter !== 'all'){
        list = list.filter(c => (c.status || 'pending') === currentFilter);
      }

      if (list.length === 0) {
        container.innerHTML = '<div class="empty-state">ç¾åœ¨ã€è©²å½“ã™ã‚‹å‘¼ã³å‡ºã—ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      container.innerHTML = list.map(c => renderCallCard(c)).join('');

      list.forEach(c => {
        const card = document.querySelector(`[data-id="${c._id}"]`);
        if (!card) return;

        const inprogressBtn = card.querySelector('.btn-inprogress');
        const completeBtn = card.querySelector('.btn-complete');
        const openBtn = card.querySelector('.btn-open-anomaly');
        const declineBtn = card.querySelector('.btn-decline');

        if (inprogressBtn) {
          inprogressBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            showCompleteModal(c, 'inprogress');
          });
        }

        if (completeBtn) {
          completeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            showCompleteModal(c, 'complete');
          });
        }

        if (declineBtn) {
          declineBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            if(!confirm('å¯¾å¿œä¸å¯ã¨ã—ã¦ã€æ¬¡ã®æ‹…å½“è€…ã¸æŒ‡ç¤ºã‚’å›ã—ã¾ã™ã‹ï¼Ÿ')) return;
            try{
              await reassignToNext(c);
            }catch(err){
              console.error(err);
              alert('å‰²å½“å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
          });
        }

        if (openBtn) {
          openBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openAnomalyAppFromCase(c);
          });
        }

        card.addEventListener('click', () => openAnomalyAppFromCase(c));
      });
    }

    function renderCallCard(c){
      const priority = c.priority || 'normal';
      const status = c.status || 'pending';

      const createdAt = c.createdAt?.toDate ? c.createdAt.toDate() : null;
      const timeStr = createdAt ? formatDateTime(createdAt) : '---';

      const statusLabel = status === 'pending' ? 'æœªå¯¾å¿œ' : (status === 'inprogress' ? 'å¯¾å¿œä¸­' : 'å®Œäº†');

      const message = (c.message || '').trim();
      const showMessage = message ? `<div class="message-box">${escapeHtml(message)}</div>` : '';

      // âœ… å¯¾å¿œä¸­ã®æ‹…å½“è€…ã‚’ã€Œé ­æ–‡å­—ãƒãƒƒã‚¸ã€ã§å¼·èª¿
      const responderHighlight =
        (status === 'inprogress' && c.respondedBy)
          ? `
            <div class="responder-highlight">
              <span class="initial-badge" title="${escapeAttr(c.respondedBy)}">${escapeHtml(makeInitials(c.respondedBy))}</span>
              <div class="responder-name">
                å¯¾å¿œä¸­ï¼š${escapeHtml(c.respondedBy)}
             
              </div>
            </div>
          `
          : '';

      
      // âœ… æœªå¯¾å¿œã®ã€ŒæŒ‡ç¤ºå…ˆï¼ˆè‡ªå‹•å‰²å½“ï¼‰ã€ã‚’è¡¨ç¤º
      const assigneeHighlight =
        (status === 'pending' && c.assignedTo)
          ? `
            <div class="assignee-highlight">
              <span class="badge" title="${escapeAttr(c.assignedTo)}">${escapeHtml(makeInitials(c.assignedTo))}</span>
              <div style="line-height:1.15;min-width:0;">
               <b>${escapeHtml(c.assignedTo)}</b> ã•ã‚“å¯¾å¿œã—ã¦ãã ã•ã„
                <div style="margin-top:2px;font-size:.92rem;font-weight:900;color:rgba(109,76,65,.9);">
                 
                </div>
              </div>
            </div>
          `
          : '';
      
      // âœ… çµŒéæ™‚é–“ãƒãƒƒã‚¸
      const elapsedBadge = getElapsedTimeBadge(c.createdAt);
          
return `
        <div class="case-card ${status === 'completed' ? 'completed':''}" data-id="${c._id}">
          <div class="priority-bar ${priority}"></div>

          <div class="case-header">
            <div class="case-title">
              ${priority === 'urgent' ? 'ğŸš¨ ç·Šæ€¥' : 'âš ï¸ é€šå¸¸'}
              / ${escapeHtml(c.department || '---')}
            </div>
            <div class="case-time">${escapeHtml(timeStr)}</div>
          </div>

          <div class="case-badges">
            <div class="status-badge ${status}">
              ${escapeHtml(statusLabel)}
            </div>
            ${elapsedBadge}
          </div>

          ${responderHighlight}

          ${assigneeHighlight}

          <div class="case-info">
            <div class="info-item"><div class="info-label">ãƒ©ã‚¤ãƒ³:</div><div class="info-value">${escapeHtml(c.lineName || '---')}</div></div>
            <div class="info-item"><div class="info-label">æ•´ç†No:</div><div class="info-value">${escapeHtml(c.serialNo || '---')}</div></div>
            <div class="info-item"><div class="info-label">ç™ºä¿¡è€…:</div><div class="info-value">${escapeHtml(c.callerName || '---')}</div></div>
          </div>

          ${showMessage}

          <div class="actions">
            ${status !== 'completed'
              ? `<button class="btn btn-inprogress">å¯¾å¿œé–‹å§‹</button>`
              : `<button class="btn btn-inprogress" disabled style="opacity:.5;cursor:not-allowed;">å¯¾å¿œé–‹å§‹</button>`}
            ${status !== 'completed'
              ? `<button class="btn btn-complete">å®Œäº†</button>`
              : `<button class="btn btn-complete" disabled style="opacity:.5;cursor:not-allowed;">å®Œäº†</button>`}
            ${status === 'pending' && c.assignedTo
              ? `<button class="btn btn-decline">å¯¾å¿œä¸å¯ï¼ˆæ¬¡ã¸ï¼‰</button>`
              : ``}
            <button class="btn btn-open-anomaly">ç•°å¸¸å±¥æ­´ã‚’é–‹ã</button>
          </div>
        </div>
      `;
    }

    function openAnomalyAppFromCase(c){
      const anomalyPreFillData = {
        fromAndon: true,
        andonCaseId: c._id,
        department: c.department || '',
        lineName: c.lineName || '',
        serialNo: c.serialNo || `QA-${String(c._id).slice(-6)}`,
        handler: c.callerName || '',
        anomalyContent: c.message || '',
        priority: c.priority || 'normal',
        timestamp: Date.now()
      };

      try{
        localStorage.setItem('anomaly_prefill_data', JSON.stringify(anomalyPreFillData));
      }catch(e){}

      window.open(ANOMALY_APP_URL, '_blank');
    }

    // ===== å¯¾å¿œãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆé–‹å§‹/å®Œäº†ï¼‰ =====
function showCompleteModal(caseData, mode){
  currentCompleteCase = caseData || {};

  // mode ãŒç„¡ã„å ´åˆã®æ—¢å®šå€¤
  const effectiveMode = (mode === 'completed' || mode === 'complete') ? 'completed' : 'inprogress';
  modalMode = (effectiveMode === 'inprogress') ? 'inprogress' : 'complete';

  // ã‚¿ã‚¤ãƒˆãƒ«
  const titleEl = document.getElementById('completeModalTitle');
  if (titleEl) titleEl.textContent = (effectiveMode === 'inprogress') ? 'å¯¾å¿œé–‹å§‹' : 'å¯¾å¿œå®Œäº†';

  // ç¢ºå®šãƒœã‚¿ãƒ³ï¼ˆconfirmComplete / btnCompleteConfirm ã©ã¡ã‚‰ã§ã‚‚OKï¼‰
  const btn =
    document.getElementById('confirmComplete') ||
    document.getElementById('btnCompleteConfirm');
  if (btn) btn.textContent = (effectiveMode === 'inprogress') ? 'é–‹å§‹ã™ã‚‹' : 'å®Œäº†ã™ã‚‹';

  // å¯¾å¿œè€…ï¼ˆselectç‰ˆ / inputç‰ˆ ã©ã¡ã‚‰ã§ã‚‚æ‹¾ã†ï¼‰
  const byEl =
    document.getElementById('completeBySelect') ||
    document.getElementById('completeBy') ||
    document.getElementById('completeByInput');

  if (byEl) {
    // caseDataå´ã®å€™è£œã‚‚è¤‡æ•°ã‚’è¦‹ã¦å…¥ã‚Œã‚‹
    byEl.value = (caseData.assignedTo || caseData.completedBy || caseData.handler || '') || '';
  } else {
    console.warn('[showCompleteModal] å¯¾å¿œè€…å…¥åŠ›æ¬„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆcompleteBySelect / completeBy / completeByInputï¼‰');
  }

  // å¯¾å¿œå†…å®¹ï¼ˆtextareaç‰ˆ / inputç‰ˆ ã©ã¡ã‚‰ã§ã‚‚æ‹¾ã†ï¼‰
  const msgEl =
    document.getElementById('completeMessage') ||
    document.getElementById('completeMessageInput') ||
    document.getElementById('completeMessageText');

  if (msgEl) {
    msgEl.value = (caseData.completedMessage || '') || '';
  } else {
    console.warn('[showCompleteModal] å¯¾å¿œå†…å®¹å…¥åŠ›æ¬„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆcompleteMessage / completeMessageInput / completeMessageTextï¼‰');
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  const modal = document.getElementById('completeModal');
  if (modal){ modal.style.display = 'flex'; modal.classList.add('active'); }
  else console.warn('[showCompleteModal] completeModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
// ===== ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ç¢ºå®Ÿã«é–‰ã˜ã‚‹ï¼ˆdisplay/classä¸¡å¯¾å¿œï¼‰ =====
function closeCompleteModal(){
  const modal = document.getElementById('completeModal');
  if(!modal) return;
  modal.classList.remove('active');
  modal.style.display = 'none';
  currentCompleteCase = null;
}
// expose for non-module handlers
window.closeCompleteModal = closeCompleteModal;

// ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§é–‰ã˜ã‚‹
document.getElementById('cancelComplete')?.addEventListener('click', () => {
  closeCompleteModal();
});

// èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.getElementById('completeModal')?.addEventListener('click', (e) => {
  if(e.target && e.target.id === 'completeModal'){
    closeCompleteModal();
  }
});


}


    document.getElementById('confirmComplete').addEventListener('click', async () => {
      const by = (document.getElementById('completeBySelect')?.value || '').trim();
      const content = (document.getElementById('completeMessage')?.value || '').trim();

      // âœ… ä½¿ã„å‹æ‰‹æ”¹å–„ï¼šé–‹å§‹ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚å®Œäº†å†…å®¹ãŒå…¥ã£ã¦ã„ã‚Œã°ã€Œå®Œäº†ã€ã¨ã—ã¦æ‰±ã†
      const effectiveMode = (modalMode === 'inprogress' && content.trim()) ? 'completed' : modalMode;

      if (!currentCompleteCase) return;

      if (!by) {
        alert('æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      try {
        if(effectiveMode === 'inprogress'){
          await updateDoc(doc(db, 'quality_cases', currentCompleteCase._id), {
            status: 'inprogress',
            respondedBy: by,
            respondedAt: serverTimestamp()
          });
        }else{
          await updateDoc(doc(db, 'quality_cases', currentCompleteCase._id), {
            status: 'completed',
            completedBy: by,
            completedContent: content,
            completedAt: serverTimestamp()
          });

          // ç•°å¸¸å±¥æ­´ã‚¢ãƒ—ãƒªå´ã¸ã®é€†æµï¼ˆåŒä¸€ç«¯æœ«å‘ã‘ï¼‰
          try {
            const completionPayload = {
              timestamp: Date.now(),
              caseId: currentCompleteCase._id,
              tempLinkId: currentCompleteCase.tempLinkId || '',
              launchId: currentCompleteCase.launchId || '',
              department: currentCompleteCase.department || '',
              lineName: currentCompleteCase.lineName || '',
              serialNo: currentCompleteCase.serialNo || '',
              completedBy: by,
              completedContent: content,
              completedAt: new Date().toISOString()
            };
            localStorage.setItem('andon_completion_data', JSON.stringify(completionPayload));
          } catch (e) {}
          // ===== DB(anomalies) ã® qualityResponse ã‚’æ›´æ–°ï¼ˆquality_cases ã¨åŒã˜IDé‹ç”¨ï¼‰ =====
          try{
            const anomalyId = currentCompleteCase._id; // â˜…åŒIDé‹ç”¨ï¼šquality_cases ã®ID = anomalies ã®ID
            const aRef = doc(db, 'anomalies', anomalyId);
            const snap = await getDoc(aRef);
            const prev = (snap.exists() ? (snap.data().qualityResponse || '') : '');

            const stampJp = new Date().toLocaleString('ja-JP');
            const addText =
              `ã€ã‚¢ãƒ³ãƒ‰ãƒ³å®Œäº†ã€‘${stampJp}\n` +
              `å¯¾å¿œè€…: ${by}\n` +
              `å¯¾å¿œå†…å®¹: ${content || 'ï¼ˆãªã—ï¼‰'}\n` +
              `æ¡ˆä»¶ID: ${anomalyId}\n`;

            const next = [String(prev || '').trim(), addText.trim()].filter(Boolean).join('\n\n');

            await setDoc(aRef, {
              qualityResponse: next,
              updatedAt: serverTimestamp(),
              lastAndonComplete: {
                by,
                content: content || '',
                caseId: anomalyId,
                at: serverTimestamp()
              }
            }, { merge: true });
          }catch(e){
            console.warn('failed to sync anomalies.qualityResponse', e);
            alert('ç•°å¸¸å±¥æ­´ï¼ˆanomaliesï¼‰ã®qualityResponseæ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          }
        }

        closeCompleteModal();
      } catch (error) {
        console.error('Error:', error);
        alert((effectiveMode === 'inprogress' ? 'å¯¾å¿œé–‹å§‹' : 'å¯¾å¿œå®Œäº†') + 'ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });

    // ===== çµ±è¨ˆ =====
    function updateStats() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const urgentPending = casesCache.filter(c => (c.priority || 'normal') === 'urgent' && (c.status || 'pending') === 'pending').length;
      const normalPending = casesCache.filter(c => (c.priority || 'normal') === 'normal' && (c.status || 'pending') === 'pending').length;
      const inProgress = casesCache.filter(c => (c.status || 'pending') === 'inprogress').length;

      const completedToday = casesCache.filter(c => {
        if ((c.status || 'pending') !== 'completed' || !c.completedAt) return false;
        const completedDate = c.completedAt.toDate();
        return completedDate >= today;
      }).length;

      document.getElementById('statUrgentPending').textContent = urgentPending;
      document.getElementById('statNormalPending').textContent = normalPending;
      document.getElementById('statInProgress').textContent = inProgress;
      document.getElementById('statCompletedToday').textContent = completedToday;
    }

    // ===== ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ =====
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.getAttribute('data-filter');
        renderCases();
      });
    });

    // ===== util =====
    function formatDateTime(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      const h = String(date.getHours()).padStart(2, '0');
      const min = String(date.getMinutes()).padStart(2, '0');
      return `${y}/${m}/${d} ${h}:${min}`;
    }

    // âœ… QCãƒ¡ãƒ³ãƒãƒ¼ã®é ­æ–‡å­—ï¼ˆæ—¥æœ¬èªã¯å…ˆé ­1æ–‡å­—ã€è‹±å­—ã¯æœ€å¤§2æ–‡å­—ï¼‰
    function makeInitials(name){
      const s = String(name || '').trim();
      if (!s) return '?';

      // è‹±å­—ãŒå«ã¾ã‚Œã‚‹å ´åˆï¼šå˜èªã®å…ˆé ­ã‚’æœ€å¤§2ã¤
      const hasLatin = /[A-Za-z]/.test(s);
      if (hasLatin) {
        const parts = s.replace(/\s+/g,' ').split(' ').filter(Boolean);
        const a = (parts[0] || '').charAt(0).toUpperCase();
        const b = (parts[1] || '').charAt(0).toUpperCase();
        const ab = (a + b).trim();
        return ab || a || '?';
      }

      // æ—¥æœ¬èªãªã©ï¼šå…ˆé ­1æ–‡å­—ï¼ˆå¿…è¦ãªã‚‰2æ–‡å­—ã«ã—ã¦ã‚‚OKï¼‰
      return s.charAt(0);
    }

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s){
      return escapeHtml(String(s ?? '')).replaceAll('\n',' ').replaceAll('\r',' ');
    }
// çµŒéæ™‚é–“ã‚’è¨ˆç®—ã—ã¦ãƒãƒƒã‚¸HTMLã‚’ç”Ÿæˆ
function getElapsedTimeBadge(createdAt) {
  if (!createdAt) return '';
  
  const now = new Date();
  const created = createdAt.toDate ? createdAt.toDate() : new Date(createdAt);
  const diffMs = now - created;
  const diffMins = Math.floor(diffMs / (1000 * 60));
  
  let timeText = '';
  let badgeClass = '';
  
  if (diffMins < 60) {
    timeText = `${diffMins}åˆ†`;
    badgeClass = diffMins > 30 ? 'warning' : '';
  } else if (diffMins < 1440) { // 24æ™‚é–“æœªæº€
    const hours = Math.floor(diffMins / 60);
    const mins = diffMins % 60;
    timeText = `${hours}æ™‚é–“${mins > 0 ? mins + 'åˆ†' : ''}`;
    badgeClass = hours >= 2 ? 'urgent' : (hours >= 1 ? 'warning' : '');
  } else {
    const days = Math.floor(diffMins / 1440);
    timeText = `${days}æ—¥`;
    badgeClass = 'urgent';
  }
  
  return `<span class="elapsed-time-badge ${badgeClass}">â±ï¸ ${timeText}çµŒé</span>`;
}
  </script>
</body>
</html>
