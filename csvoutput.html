<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>æ¤œæŸ»ãƒ‡ãƒ¼ã‚¿CSVå‡ºåŠ›ãƒ„ãƒ¼ãƒ«</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#667eea;min-height:100vh;padding:20px}
.container{max-width:800px;margin:0 auto;background:#fff;border-radius:12px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
.header{text-align:center;margin-bottom:30px;padding:20px;background:#007bff;color:#fff;border-radius:8px}
.section{margin-bottom:25px;padding:20px;border:1px solid #ddd;border-radius:8px;background:#f9f9f9}
.file-area{border:2px dashed #007bff;padding:30px;text-align:center;border-radius:8px;margin-bottom:15px;transition:all 0.3s ease}
.file-area:hover{background:#f0f8ff}
.file-list{margin-top:15px}
.file-item{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#fff;margin:5px 0;border-radius:6px;border-left:4px solid #007bff}
.btn{padding:10px 20px;background:#007bff;color:#fff;border:none;border-radius:6px;cursor:pointer;margin:5px;font-size:14px;transition:all 0.3s ease}
.btn:hover{background:#0056b3;transform:translateY(-1px)}
.btn:disabled{background:#ccc;cursor:not-allowed;transform:none}
.btn-danger{background:#dc3545}
.btn-danger:hover{background:#c82333}
.btn-success{background:#28a745}
.btn-success:hover{background:#218838}
.btn-warning{background:#ffc107;color:#212529}
.btn-warning:hover{background:#e0a800}
.progress-bar{width:100%;height:20px;background:#e9ecef;border-radius:10px;overflow:hidden;margin:15px 0}
.progress-fill{height:100%;background:linear-gradient(90deg,#007bff,#0056b3);transition:width 0.3s ease;border-radius:10px}
.status{padding:15px;margin:10px 0;border-radius:6px;font-weight:bold}
.status.processing{background:#fff3cd;color:#856404;border-left:4px solid #ffc107}
.status.success{background:#d4edda;color:#155724;border-left:4px solid #28a745}
.status.error{background:#f8d7da;color:#721c24;border-left:4px solid #dc3545}
.hidden{display:none}
.summary{background:#e7f3ff;padding:20px;margin:15px 0;border-radius:8px;text-align:center}
.summary-value{font-size:24px;font-weight:bold;color:#007bff;margin:5px 0}
.summary-label{font-size:14px;color:#666}
.export-section{background:#f8f9fa;padding:20px;border-radius:8px;margin-top:20px}
.export-buttons{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>ğŸ“Š æ¤œæŸ»ãƒ‡ãƒ¼ã‚¿CSVå‡ºåŠ›ãƒ„ãƒ¼ãƒ«</h1>
<p>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€å“ç•ªåˆ¥ãƒ»æ¤œæŸ»ç¨®é¡åˆ¥ã®çµ±åˆãƒ‡ãƒ¼ã‚¿ã‚’CSVå½¢å¼ã§å‡ºåŠ›</p>
</div>

<div class="section">
<h3>ğŸ“ CSVãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿</h3>
<div class="file-area" ondrop="dropHandler(event)" ondragover="dragOverHandler(event)">
<p>ğŸ“¥ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
<input type="file" id="fileInput" accept=".csv" multiple style="margin-top:15px">
</div>
<div id="fileList" class="file-list"></div>
<div id="status" class="status hidden"></div>
<div class="progress-bar hidden" id="progressContainer">
<div class="progress-fill" id="progressBar" style="width:0%"></div>
</div>
<button id="processBtn" class="btn btn-success" onclick="processFiles()" disabled>âš¡ ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã¦CSVå‡ºåŠ›</button>
</div>

<div id="resultsSection" class="section hidden">
<h3>ğŸ“ˆ å‡¦ç†çµæœ</h3>
<div class="summary">
<div class="summary-value" id="totalParts">0</div>
<div class="summary-label">å‡¦ç†ã•ã‚ŒãŸå“ç•ªæ•°</div>
</div>
<div class="summary">
<div class="summary-value" id="totalInspections">0</div>
<div class="summary-label">ç·æ¤œæŸ»æ•°</div>
</div>
<div class="summary">
<div class="summary-value" id="overallRate">0.00%</div>
<div class="summary-label">ç·åˆä¸è‰¯ç‡</div>
</div>

<div class="export-section">
<h4>ğŸ“¤ CSVå‡ºåŠ›</h4>
<div class="export-buttons">
<button class="btn" onclick="exportCSV('partRate')">ğŸ“‹ å“ç•ªåˆ¥ä¸è‰¯ç‡ãƒ»NGå†…è¨³</button>
<button class="btn btn-warning" onclick="exportCSV('typeAnalysis')">ğŸ” æ¤œæŸ»ç¨®é¡åˆ¥è©³ç´°åˆ†æ</button>
<button class="btn btn-success" onclick="exportCSV('summary')">ğŸ“Š çµ±åˆã‚µãƒãƒªãƒ¼</button>
</div>
</div>

<div style="margin-top:20px;text-align:center">
<button class="btn btn-danger" onclick="reset()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
</div>
</div>
</div>

<script>
let files = [];
let allData = [];
let partRateResults = [];
let typeAnalysisResults = [];
let allNGColumns = new Set();
let summaryData = {};

// ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
function dragOverHandler(ev) {
    ev.preventDefault();
}

function dropHandler(ev) {
    ev.preventDefault();
    handleFiles(ev.dataTransfer.files);
}

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
function showStatus(message, type = 'processing') {
    const status = document.getElementById('status');
    status.className = `status ${type}`;
    status.textContent = message;
    status.classList.remove('hidden');
}

function hideStatus() {
    document.getElementById('status').classList.add('hidden');
}

// ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
function showProgress() {
    document.getElementById('progressContainer').classList.remove('hidden');
}

function updateProgress(percent) {
    document.getElementById('progressBar').style.width = percent + '%';
}

function hideProgress() {
    document.getElementById('progressContainer').classList.add('hidden');
    updateProgress(0);
}

// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
document.getElementById('fileInput').addEventListener('change', function(e) {
    handleFiles(e.target.files);
});

function handleFiles(selectedFiles) {
    showStatus(`${selectedFiles.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªä¸­...`);
    
    for (let file of selectedFiles) {
        if (file.name.toLowerCase().endsWith('.csv')) {
            if (!files.find(f => f.name === file.name && f.size === file.size)) {
                files.push(file);
            }
        }
    }
    
    updateFileList();
    showStatus(`${files.length}å€‹ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒæº–å‚™å®Œäº†`, 'success');
}

function updateFileList() {
    const fileList = document.getElementById('fileList');
    fileList.innerHTML = '';
    
    files.forEach((file, index) => {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.innerHTML = `
            <span>ğŸ“„ ${file.name} (${(file.size/1024).toFixed(1)}KB)</span>
            <button class="btn btn-danger" onclick="removeFile(${index})">âŒ å‰Šé™¤</button>
        `;
        fileList.appendChild(div);
    });
    
    document.getElementById('processBtn').disabled = files.length === 0;
}

function removeFile(index) {
    files.splice(index, 1);
    updateFileList();
    if (files.length === 0) {
        hideStatus();
    }
}

async function processFiles() {
    if (files.length === 0) return;
    
    showStatus('ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...', 'processing');
    showProgress();
    
    allData = [];
    allNGColumns.clear();
    
    try {
        for (let i = 0; i < files.length; i++) {
            updateProgress((i / files.length) * 50);
            showStatus(`å‡¦ç†ä¸­: ${files[i].name} (${i+1}/${files.length})`);
            
            const data = await readCSV(files[i]);
            if (data && data.length > 0) {
                const ngColumns = detectNGColumns(data[0]);
                ngColumns.forEach(col => allNGColumns.add(col));
                
                allData.push({
                    fileName: files[i].name,
                    data: data,
                    headers: Object.keys(data[0]),
                    ngColumns: ngColumns
                });
            }
        }
        
        updateProgress(75);
        showStatus('ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­...');
        
        if (allData.length > 0) {
            await new Promise(resolve => setTimeout(resolve, 500)); // UIæ›´æ–°ã®ãŸã‚ã®çŸ­ã„å¾…æ©Ÿ
            
            analyzeData();
            updateProgress(100);
            
            showStatus('å‡¦ç†å®Œäº†ï¼CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å‡ºåŠ›ãŒå¯èƒ½ã§ã™', 'success');
            document.getElementById('resultsSection').classList.remove('hidden');
            
            setTimeout(() => {
                hideProgress();
            }, 1000);
        } else {
            throw new Error('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        }
        
    } catch (error) {
        hideProgress();
        showStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
    }
}

function readCSV(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                let text = e.target.result;
                
                // BOMé™¤å»
                if (text.charCodeAt(0) === 0xFEFF) {
                    text = text.substring(1);
                }
                
                // è¡Œåˆ†å‰²
                const lines = text.split(/\r?\n/).filter(line => line.trim());
                
                if (lines.length < 2) {
                    resolve([]);
                    return;
                }
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
                const headers = lines[0].split(',').map(h => h.replace(/^"|"$/g, '').trim());
                
                // ãƒ‡ãƒ¼ã‚¿è¡Œ
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const values = lines[i].split(',').map(v => v.replace(/^"|"$/g, '').trim());
                    if (values.length >= headers.length) {
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        data.push(row);
                    }
                }
                
                resolve(data);
                
            } catch (error) {
                reject(error);
            }
        };
        
        reader.onerror = () => reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'));
        reader.readAsText(file, 'UTF-8');
    });
}

function detectNGColumns(sampleRow) {
    const ngColumns = [];
    const excludeColumns = ['æ¤œæŸ»æ•°', 'æ¤œæŸ»æ™‚é–“', 'ç”Ÿç”£æ—¥ä»˜', 'æ•´ç†No', 'å“ç•ª', 'è£½å“ç•ªå·', 'æ¤œæŸ»ç¨®é¡', 
                           'type', 'æ¤œæŸ»æ—¥', 'æ—¥ä»˜', 'count', 'æ¤œæŸ»å“¡å', 'å‚™è€ƒ', 'ãƒ­ãƒƒãƒˆNo', 
                           'æ¤œæŸ»é–‹å§‹æ™‚é–“', 'æ¤œæŸ»çµ‚äº†æ™‚é–“'];
    
    Object.entries(sampleRow).forEach(([key, value]) => {
        if (!excludeColumns.includes(key) && 
            !key.includes('æ™‚é–“') && 
            !key.includes('æ—¥ä»˜') && 
            !key.includes('å“¡') &&
            !isNaN(parseFloat(value))) {
            ngColumns.push(key);
        }
    });
    
    return ngColumns.sort();
}

function analyzeData() {
    const partMap = new Map();
    const typeMap = new Map();
    const inspectionTypes = new Set();
    
    allData.forEach(fileData => {
        fileData.data.forEach(row => {
            const partNumber = row['æ•´ç†No'] || row['å“ç•ª'] || row['è£½å“ç•ªå·'] || '';
            const inspectionType = row['æ¤œæŸ»ç¨®é¡'] || row['type'] || 'Unknown';
            const inspectionDate = row['ç”Ÿç”£æ—¥ä»˜'] || row['æ¤œæŸ»æ—¥'] || row['æ—¥ä»˜'] || '';
            const inspectionCount = parseInt(row['æ¤œæŸ»æ•°'] || row['count'] || '0') || 0;
            
            if (!partNumber) return;
            
            inspectionTypes.add(inspectionType);
            
            // NGé …ç›®åˆ¥ã®é›†è¨ˆ
            const ngBreakdown = {};
            let totalNG = 0;
            
            Array.from(allNGColumns).forEach(ngCol => {
                const ngValue = parseFloat(row[ngCol]) || 0;
                ngBreakdown[ngCol] = ngValue;
                totalNG += ngValue;
            });
            
            // å“ç•ªåˆ¥é›†è¨ˆ
            if (!partMap.has(partNumber)) {
                partMap.set(partNumber, {
                    å“ç•ª: partNumber,
                    æ¤œæŸ»ç¨®é¡æ•°: new Set(),
                    ãƒ•ã‚¡ã‚¤ãƒ«æ•°: 0,
                    æœ€æ–°æ¤œæŸ»æ—¥: '',
                    ç·æ¤œæŸ»æ•°: 0,
                    ç·NGæ•°: 0,
                    ä¸è‰¯ç‡: 0,
                    ãƒ•ã‚¡ã‚¤ãƒ«å: [],
                    ngBreakdown: {}
                });
                
                Array.from(allNGColumns).forEach(col => {
                    partMap.get(partNumber).ngBreakdown[col] = 0;
                });
            }
            
            const partData = partMap.get(partNumber);
            partData.æ¤œæŸ»ç¨®é¡æ•°.add(inspectionType);
            partData.ç·æ¤œæŸ»æ•° += inspectionCount;
            partData.ç·NGæ•° += totalNG;
            
            Array.from(allNGColumns).forEach(col => {
                partData.ngBreakdown[col] += ngBreakdown[col];
            });
            
            if (!partData.ãƒ•ã‚¡ã‚¤ãƒ«å.includes(fileData.fileName)) {
                partData.ãƒ•ã‚¡ã‚¤ãƒ«å.push(fileData.fileName);
                partData.ãƒ•ã‚¡ã‚¤ãƒ«æ•°++;
            }
            
            if (inspectionDate && (!partData.æœ€æ–°æ¤œæŸ»æ—¥ || inspectionDate > partData.æœ€æ–°æ¤œæŸ»æ—¥)) {
                partData.æœ€æ–°æ¤œæŸ»æ—¥ = inspectionDate;
            }
            
            // æ¤œæŸ»ç¨®é¡åˆ¥åˆ†æ
            const typeKey = `${partNumber}_${inspectionType}`;
            if (!typeMap.has(typeKey)) {
                typeMap.set(typeKey, {
                    å“ç•ª: partNumber,
                    æ¤œæŸ»ç¨®é¡: inspectionType,
                    æ¤œæŸ»å›æ•°: 0,
                    ç·æ¤œæŸ»æ•°: 0,
                    ç·NGæ•°: 0,
                    ä¸è‰¯ç‡: 0,
                    æœ€æ–°æ¤œæŸ»æ—¥: '',
                    ngBreakdown: {}
                });
                
                Array.from(allNGColumns).forEach(col => {
                    typeMap.get(typeKey).ngBreakdown[col] = 0;
                });
            }
            
            const typeData = typeMap.get(typeKey);
            typeData.æ¤œæŸ»å›æ•°++;
            typeData.ç·æ¤œæŸ»æ•° += inspectionCount;
            typeData.ç·NGæ•° += totalNG;
            
            Array.from(allNGColumns).forEach(col => {
                typeData.ngBreakdown[col] += ngBreakdown[col];
            });
            
            if (inspectionDate && (!typeData.æœ€æ–°æ¤œæŸ»æ—¥ || inspectionDate > typeData.æœ€æ–°æ¤œæŸ»æ—¥)) {
                typeData.æœ€æ–°æ¤œæŸ»æ—¥ = inspectionDate;
            }
        });
    });
    
    // çµæœè¨ˆç®—
    partRateResults = Array.from(partMap.values()).map(item => {
        item.ä¸è‰¯ç‡ = item.ç·æ¤œæŸ»æ•° > 0 ? (item.ç·NGæ•° / item.ç·æ¤œæŸ»æ•° * 100).toFixed(2) : '0.00';
        item.æ¤œæŸ»ç¨®é¡æ•° = item.æ¤œæŸ»ç¨®é¡æ•°.size;
        item.ä¸»è¦NGé …ç›® = Object.entries(item.ngBreakdown)
            .filter(([k, v]) => v > 0)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3)
            .map(([k, v]) => `${k}:${v}`)
            .join(', ');
        return item;
    }).sort((a, b) => parseFloat(b.ä¸è‰¯ç‡) - parseFloat(a.ä¸è‰¯ç‡));
    
    typeAnalysisResults = Array.from(typeMap.values()).map(item => {
        item.ä¸è‰¯ç‡ = item.ç·æ¤œæŸ»æ•° > 0 ? (item.ç·NGæ•° / item.ç·æ¤œæŸ»æ•° * 100).toFixed(2) : '0.00';
        item.ä¸»è¦NGé …ç›® = Object.entries(item.ngBreakdown)
            .filter(([k, v]) => v > 0)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3)
            .map(([k, v]) => `${k}:${v}`)
            .join(', ');
        return item;
    }).sort((a, b) => parseFloat(b.ä¸è‰¯ç‡) - parseFloat(a.ä¸è‰¯ç‡));
    
    // ã‚µãƒãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ä½œæˆ
    const totalInspections = partRateResults.reduce((sum, item) => sum + item.ç·æ¤œæŸ»æ•°, 0);
    const totalNG = partRateResults.reduce((sum, item) => sum + item.ç·NGæ•°, 0);
    const overallRate = totalInspections > 0 ? (totalNG / totalInspections * 100).toFixed(2) : '0.00';
    
    summaryData = {
        å‡¦ç†æ—¥æ™‚: new Date().toLocaleString('ja-JP'),
        å‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ«æ•°: files.length,
        å“ç•ªæ•°: partRateResults.length,
        æ¤œæŸ»ç¨®é¡æ•°: inspectionTypes.size,
        ç·æ¤œæŸ»æ•°: totalInspections,
        ç·NGæ•°: totalNG,
        ç·åˆä¸è‰¯ç‡: overallRate + '%'
    };
    
    // ç”»é¢æ›´æ–°
    document.getElementById('totalParts').textContent = partRateResults.length;
    document.getElementById('totalInspections').textContent = totalInspections.toLocaleString();
    document.getElementById('overallRate').textContent = overallRate + '%';
}

function exportCSV(type) {
    let data, filename, headers;
    
    switch(type) {
        case 'partRate':
            data = partRateResults;
            filename = 'å“ç•ªåˆ¥ä¸è‰¯ç‡_NGå†…è¨³';
            headers = ['å“ç•ª', 'ä¸è‰¯ç‡', 'ç·æ¤œæŸ»æ•°', 'ç·NGæ•°', 'æ¤œæŸ»ç¨®é¡æ•°', 'ãƒ•ã‚¡ã‚¤ãƒ«æ•°', 'æœ€æ–°æ¤œæŸ»æ—¥', 'ä¸»è¦NGé …ç›®', ...Array.from(allNGColumns).sort()];
            break;
        case 'typeAnalysis':
            data = typeAnalysisResults;
            filename = 'æ¤œæŸ»ç¨®é¡åˆ¥è©³ç´°åˆ†æ';
            headers = ['å“ç•ª', 'æ¤œæŸ»ç¨®é¡', 'ä¸è‰¯ç‡', 'æ¤œæŸ»å›æ•°', 'ç·æ¤œæŸ»æ•°', 'ç·NGæ•°', 'æœ€æ–°æ¤œæŸ»æ—¥', 'ä¸»è¦NGé …ç›®', ...Array.from(allNGColumns).sort()];
            break;
        case 'summary':
            data = [summaryData];
            filename = 'çµ±åˆã‚µãƒãƒªãƒ¼';
            headers = Object.keys(summaryData);
            break;
        default:
            return;
    }
    
    if (data.length === 0) {
        showStatus('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
    }
    
    showStatus('CSVå‡ºåŠ›ä¸­...', 'processing');
    
    let csvContent;
    
    if (type === 'summary') {
        csvContent = [
            headers.join(','),
            headers.map(h => `"${data[0][h] || ''}"`).join(',')
        ].join('\n');
    } else {
        const baseHeaders = headers.filter(h => !allNGColumns.has(h));
        const ngHeaders = Array.from(allNGColumns).sort();
        
        csvContent = [
            headers.join(','),
            ...data.map(row => {
                const baseValues = baseHeaders.map(h => `"${row[h] || ''}"`);
                const ngValues = ngHeaders.map(col => `"${row.ngBreakdown ? row.ngBreakdown[col] || 0 : 0}"`);
                return [...baseValues, ...ngValues].join(',');
            })
        ].join('\n');
    }
    
    const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], {
        type: 'text/csv;charset=utf-8'
    });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${filename}_${new Date().toISOString().slice(0, 10)}.csv`;
    link.click();
    
    showStatus(`CSVå‡ºåŠ›å®Œäº†: ${filename}`, 'success');
    
    setTimeout(() => {
        hideStatus();
    }, 3000);
}

function reset() {
    if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        files = [];
        allData = [];
        partRateResults = [];
        typeAnalysisResults = [];
        allNGColumns.clear();
        summaryData = {};
        document.getElementById('fileInput').value = '';
        document.getElementById('resultsSection').classList.add('hidden');
        hideStatus();
        hideProgress();
        updateFileList();
        showStatus('ãƒªã‚»ãƒƒãƒˆå®Œäº†', 'success');
        setTimeout(() => {
            hideStatus();
        }, 2000);
    }
}
</script>

</body>
</html>
