<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒƒã‚«ãƒ¼</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f0f2f5; min-height: 100vh; font-size: 16px; }
        .container { max-width: 100%; margin: 0; padding: 0; }
        .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 14px 24px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 24px; }
        .header .date { font-size: 14px; opacity: 0.9; }
        .tabs { display: flex; gap: 0; background: #fff; border-bottom: 2px solid #e0e0e0; padding: 0 15px; }
        .tab { padding: 14px 28px; border: none; background: transparent; cursor: pointer; font-weight: 600; border-radius: 0; color: #666; font-size: 16px; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab:hover { background: #f8f9fa; }
        .tab.active { background: transparent; color: #667eea; border-bottom-color: #667eea; }
        .tab-content { display: none; padding: 20px; min-height: calc(100vh - 110px); }
        .tab-content.active { display: block; }
        .tracker-layout { display: grid; grid-template-columns: 300px 1fr 360px; gap: 20px; height: calc(100vh - 150px); }
        .tracker-sidebar { background: #fff; border-radius: 10px; padding: 18px; overflow-y: auto; }
        .tracker-sidebar h4 { font-size: 16px; color: #888; margin-bottom: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        .tracker-center { display: flex; flex-direction: column; gap: 16px; overflow-y: auto; }
        .tracker-right { background: #fff; border-radius: 10px; padding: 18px; overflow-y: auto; }
        .tracker-right h4 { font-size: 16px; color: #333; margin-bottom: 14px; font-weight: 700; }
        .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
        .card h3 { font-size: 18px; margin-bottom: 16px; color: #333; }
        .member-list-item { padding: 14px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; transition: all 0.15s; border: 2px solid #e9ecef; }
        .member-list-item:hover { background: #f0f2f5; border-color: #667eea; }
        .member-list-item.active { background: #667eea; color: white; border-color: #667eea; }
        .member-list-item .member-info { flex: 1; min-width: 0; }
        .member-list-item .member-name { display: block; font-size: 24px; font-weight: 700; }
        .member-list-item .member-task { font-size: 18px; margin-top: 6px; color: #10b981; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .member-list-item .member-task.idle { color: #999; }
        .member-list-item.active .member-task { color: rgba(255,255,255,0.9); }
        .member-list-item.active .member-task.idle { color: rgba(255,255,255,0.6); }
        .member-list-item .status { width: 18px; height: 18px; border-radius: 50%; flex-shrink: 0; margin-left: 12px; }
        .member-list-item .status.running { background: #10b981; animation: pulse 1.5s infinite; box-shadow: 0 0 12px #10b981; }
        .member-list-item .status.idle { background: #d1d5db; }
        .member-list-item.active .status.idle { background: rgba(255,255,255,0.5); }
        @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.4;} }
        .timer-bar { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 16px 24px; border-radius: 10px; display: none; align-items: center; justify-content: space-between; }
        .timer-bar.show { display: flex; }
        .timer-bar .task-name { font-weight: 700; font-size: 22px; }
        .timer-bar .time { font-size: 36px; font-weight: 700; font-family: monospace; margin-left: 20px; }
        .timer-bar .stop-btn { padding: 12px 28px; background: rgba(255,255,255,0.2); border: 2px solid white; color: white; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; }
        .timer-bar .stop-btn:hover { background: white; color: #10b981; }
        .task-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .task-btn { padding: 24px 12px; border: 2px solid #e0e0e0; background: white; border-radius: 10px; cursor: pointer; text-align: center; font-weight: 600; font-size: 24px; transition: all 0.15s; }
        .task-btn:hover { border-color: #667eea; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .task-btn.active { background: #10b981; border-color: #10b981; color: white; }
        .task-btn .icon { font-size: 42px; margin-bottom: 10px; }
        .task-btn .elapsed { font-size: 16px; margin-top: 8px; opacity: 0.8; font-family: monospace; }
        .add-task-btn { padding: 24px 12px; border: 2px dashed #667eea; background: #f8f9ff; border-radius: 10px; cursor: pointer; text-align: center; font-weight: 600; font-size: 24px; color: #667eea; }
        .add-task-btn:hover { background: #667eea; color: white; }
        .record-item { display: flex; align-items: center; padding: 14px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; cursor: pointer; }
        .record-item:hover { background: #e9ecef; }
        .record-item .color-bar { width: 4px; height: 40px; border-radius: 2px; margin-right: 14px; }
        .record-item .info { flex: 1; }
        .record-item .task-name { font-weight: 600; font-size: 16px; }
        .record-item .time-range { font-size: 14px; color: #666; margin-top: 4px; }
        .record-item .duration { font-weight: 700; font-size: 18px; }
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px; }
        .summary-item { background: #f8f9fa; padding: 14px; border-radius: 8px; text-align: center; }
        .summary-item .label { font-size: 13px; color: #666; }
        .summary-item .value { font-size: 24px; font-weight: 700; margin-top: 4px; }
        .summary-item.total { background: #667eea; }
        .summary-item.total .label, .summary-item.total .value { color: white; }
        .date-nav { display: flex; align-items: center; gap: 12px; margin-bottom: 18px; flex-wrap: wrap; }
        .date-nav button { padding: 10px 16px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px; }
        .date-nav button:hover { background: #667eea; color: white; }
        .date-nav input { padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px; }
        .setting-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; font-size: 16px; }
        .form-row { display: flex; gap: 12px; margin-top: 12px; }
        .form-row input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px; }
        .btn-primary { background: #667eea; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-success { background: #10b981; color: white; }
        .btn-sm { padding: 8px 14px; font-size: 13px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 28px; border-radius: 14px; width: 90%; max-width: 450px; }
        .modal-content h3 { margin-bottom: 22px; font-size: 20px; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 15px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px; }
        .modal-footer { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }
        .sync-status { font-size: 14px; padding: 6px 14px; border-radius: 6px; }
        .sync-status.connected { background: #d1fae5; color: #059669; }
        .sync-status.disconnected { background: #fee2e2; color: #dc2626; }
        .toast { position: fixed; bottom: 24px; right: 24px; background: #333; color: white; padding: 14px 24px; border-radius: 10px; font-weight: 500; font-size: 15px; z-index: 2000; }
        /* ã‚¿ã‚¹ã‚¯ç®¡ç† */
        .task-manager-item { display:grid; grid-template-columns:2fr 160px 120px 1fr auto; gap:12px; padding:16px; background:#f8f9fa; border-radius:10px; margin-bottom:10px; align-items:center; font-size:16px; }
        .task-manager-item.completed { opacity:0.5; }
        .task-manager-item.completed .tm-name { text-decoration:line-through; }
        .task-manager-item.overdue { border-left:4px solid #ef4444; background:#fef2f2; }
        .task-manager-item.warning { border-left:4px solid #f59e0b; background:#fffbeb; }
        .tm-name { font-weight:600; font-size:16px; }
        .tm-badge { display:inline-block; padding:3px 8px; border-radius:4px; font-size:12px; font-weight:600; margin-left:6px; }
        .tm-badge.overdue { background:#ef4444; color:white; }
        .tm-badge.warning { background:#f59e0b; color:white; }
        .tm-badge.ok { background:#10b981; color:white; }
        .tm-progress-container { display:flex; align-items:center; gap:8px; }
        .tm-progress { width:60px; padding:8px; border:2px solid #ddd; border-radius:6px; text-align:center; font-size:15px; }
        .tm-gauge { flex:1; height:22px; background:#e9ecef; border-radius:11px; overflow:hidden; position:relative; min-width:70px; }
        .tm-gauge-fill { height:100%; border-radius:11px; transition:width 0.3s, background 0.3s; }
        .tm-gauge-fill.low { background: linear-gradient(90deg, #ef4444, #f87171); }
        .tm-gauge-fill.mid { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .tm-gauge-fill.high { background: linear-gradient(90deg, #10b981, #34d399); }
        .tm-gauge-text { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:12px; font-weight:700; color:#333; text-shadow: 0 0 2px white, 0 0 2px white; }
        .tm-deadline { width:130px; padding:8px; border:2px solid #ddd; border-radius:6px; font-size:15px; }
        .task-alert { padding:16px; border-radius:10px; margin-bottom:14px; }
        .task-alert.danger { background:#fef2f2; border-left:5px solid #ef4444; }
        .task-alert.warning { background:#fffbeb; border-left:5px solid #f59e0b; }
        .task-alert h4 { font-size:16px; margin-bottom:8px; }
        .task-alert.danger h4 { color:#dc2626; }
        .task-alert.warning h4 { color:#d97706; }
        .task-alert-item { font-size:14px; padding:4px 0; }
        /* å±¥æ­´ã‚°ãƒ©ãƒ• */
        .chart-container { margin-bottom:24px; }
        .chart-member { margin-bottom:24px; padding:18px; background:#f8f9fa; border-radius:10px; }
        .chart-member-name { font-weight:700; font-size:18px; margin-bottom:14px; color:#333; display:flex; align-items:center; gap:10px; }
        .chart-member-total { font-size:15px; color:#666; font-weight:500; }
        .chart-bar-row { display:flex; align-items:center; margin-bottom:10px; }
        .chart-bar-label { width:120px; font-size:15px; font-weight:600; color:#555; flex-shrink:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .chart-bar-container { flex:1; height:28px; background:#e9ecef; border-radius:6px; overflow:hidden; position:relative; }
        .chart-bar { height:100%; border-radius:6px; display:flex; align-items:center; justify-content:flex-end; padding-right:10px; color:white; font-size:14px; font-weight:600; min-width:35px; transition:width 0.3s; }
        .chart-bar-value { margin-left:12px; font-size:15px; font-weight:600; color:#333; width:60px; text-align:right; }
        .chart-legend { display:flex; flex-wrap:wrap; gap:14px; margin-bottom:18px; padding:12px; background:#fff; border-radius:8px; border:1px solid #e9ecef; }
        .chart-legend-item { display:flex; align-items:center; gap:8px; font-size:15px; cursor:pointer; padding:6px 10px; border-radius:6px; transition:background 0.2s; }
        .chart-legend-item:hover { background:#f0f0f0; }
        .chart-legend-item.disabled { opacity:0.4; }
        .chart-legend-color { width:16px; height:16px; border-radius:4px; }
        /* ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ */
        .gantt-card { margin-top: 0; }
        .gantt-container { overflow-x:auto; border:1px solid #e9ecef; border-radius:6px; background:#fff; max-height: 500px; overflow-y: auto; }
        .gantt-header { display:flex; border-bottom:1px solid #e9ecef; background:#f8f9fa; position:sticky; top:0; z-index:10; }
        .gantt-time-label { width:50px; flex-shrink:0; padding:8px 2px; text-align:center; font-size:11px; font-weight:600; color:#666; border-right:1px solid #e9ecef; }
        .gantt-time-label.current { background:#667eea; color:white; }
        .gantt-member-col { width:90px; flex-shrink:0; padding:10px 6px; font-weight:600; font-size:11px; background:#f8f9fa; border-right:1px solid #e9ecef; position:sticky; left:0; z-index:5; }
        .gantt-body { min-height:80px; }
        .gantt-row { display:flex; border-bottom:1px solid #f0f0f0; min-height:120px; }
        .gantt-row:hover { background:#f8f9ff; }
        .gantt-row .gantt-member-col { display:flex; align-items:center; gap:4px; }
        .gantt-row .gantt-member-col .status-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
        .gantt-row .gantt-member-col .status-dot.active { background:#10b981; animation:pulse 1.5s infinite; }
        .gantt-row .gantt-member-col .status-dot.idle { background:#d1d5db; }
        .gantt-row .gantt-member-col .member-name-text { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .gantt-cell { width:50px; flex-shrink:0; border-right:1px solid #f0f0f0; position:relative; }
        .gantt-cell.current { background:rgba(102,126,234,0.08); }
        .gantt-bar { position:absolute; top:8px; bottom:8px; border-radius:0; display:flex; align-items:center; padding:0 8px; font-size:13px; font-weight:600; color:white; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; box-shadow:0 2px 4px rgba(0,0,0,0.2); z-index:2; cursor:pointer; transition: opacity 0.2s, filter 0.2s; }
        .gantt-bar:hover { filter: brightness(1.1); }
        .gantt-bar.active { animation:ganttPulse 2s infinite; }
        .gantt-bar.filtered-out { opacity: 0.15; }
        .gantt-bar .bar-icon { margin-right:4px; font-size:14px; }
        .gantt-filter-badge { display:inline-flex; align-items:center; gap:6px; background:#667eea; color:white; padding:6px 12px; border-radius:6px; font-size:12px; font-weight:600; margin-bottom:10px; }
        .gantt-filter-badge .clear-btn { background:rgba(255,255,255,0.3); border:none; color:white; width:18px; height:18px; border-radius:50%; cursor:pointer; font-size:14px; line-height:1; }
        .gantt-filter-badge .clear-btn:hover { background:rgba(255,255,255,0.5); }
        @keyframes ganttPulse { 0%,100%{box-shadow:0 1px 2px rgba(0,0,0,0.2);} 50%{box-shadow:0 0 8px rgba(102,126,234,0.6);} }
        .gantt-now-line { position:absolute; top:0; bottom:0; width:2px; background:#ef4444; z-index:3; }
        /* å††ã‚°ãƒ©ãƒ• */
        .pie-chart-container { display:flex; justify-content:center; }
        .pie-chart { width:280px; height:280px; border-radius:50%; position:relative; }
        .pie-chart-center { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:120px; height:120px; background:white; border-radius:50%; display:flex; flex-direction:column; align-items:center; justify-content:center; box-shadow:0 0 10px rgba(0,0,0,0.1); }
        .pie-chart-center .total-hours { font-size:32px; font-weight:700; color:#333; }
        .pie-chart-center .total-label { font-size:14px; color:#888; }
        .pie-label { position:absolute; font-size:11px; font-weight:700; color:#333; text-shadow: 0 0 3px white, 0 0 3px white, 0 0 3px white; pointer-events:none; white-space:nowrap; }
        /* ã‚¢ã‚¤ã‚³ãƒ³é¸æŠ */
        .icon-option { width:36px; height:36px; border:2px solid #e0e0e0; border-radius:8px; cursor:pointer; font-size:18px; display:flex; align-items:center; justify-content:center; transition:all 0.15s; }
        .icon-option:hover { border-color:#667eea; transform:scale(1.1); }
        .icon-option.selected { border-color:#667eea; background:#667eea; }
        /* å‰æ—¥æœªå®Œäº†ã‚¢ãƒ©ãƒ¼ãƒˆ */
        .pending-alert { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .pending-alert h4 { font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .pending-item { background: rgba(255,255,255,0.2); padding: 10px 12px; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .pending-item:last-child { margin-bottom: 0; }
        .pending-item-info { flex: 1; }
        .pending-item-info .name { font-weight: 700; font-size: 13px; }
        .pending-item-info .detail { font-size: 11px; opacity: 0.9; margin-top: 2px; }
        .pending-actions { display: flex; gap: 6px; }
        .pending-actions button { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; }
        .pending-actions .btn-complete { background: white; color: #d97706; }
        .pending-actions .btn-discard { background: rgba(0,0,0,0.2); color: white; }
        /* ã‚¹ãƒãƒ›å¯¾å¿œ */
        @media (max-width: 768px) {
            .container { padding: 0; }
            .header { padding: 10px 15px; }
            .header h1 { font-size: 16px; }
            .tabs .tab:not([data-tab="tracker"]) { display: none; }
            .tabs .tab { padding: 10px 16px; font-size: 13px; }
            .tracker-layout { display: block; height: auto; padding: 10px; }
            .tracker-sidebar { display: none; }
            .tracker-center { gap: 10px; }
            .tracker-right { margin-top: 15px; }
            .task-buttons { grid-template-columns: repeat(3, 1fr); gap: 8px; }
            .task-btn { padding: 14px 8px; font-size: 11px; }
            .task-btn .icon { font-size: 20px; margin-bottom: 4px; }
            .timer-bar { flex-direction: column; gap: 10px; text-align: center; padding: 12px; }
            .timer-bar .time { font-size: 24px; margin-left: 0; }
            .summary-grid { grid-template-columns: repeat(2, 1fr); }
            .card { padding: 12px; }
            .gantt-card { display: none; }
            /* ã‚¹ãƒãƒ›ç”¨æ‹…å½“è€…ã‚»ãƒ¬ã‚¯ãƒˆè¡¨ç¤º */
            .mobile-member-select { display: block; margin-bottom: 10px; }
            .mobile-member-select select { width: 100%; padding: 10px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; font-weight: 600; }
        }
        @media (min-width: 769px) {
            .mobile-member-select { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>â±ï¸ ã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒƒã‚«ãƒ¼</h1>
                <div id="todayDate" style="font-size:13px;opacity:0.9;margin-top:4px;"></div>
            </div>
            <div class="sync-status disconnected" id="syncStatus">æœªæ¥ç¶š</div>
        </div>
        <div class="tabs">
            <button class="tab active" data-tab="tracker">ãƒˆãƒ©ãƒƒã‚«ãƒ¼</button>
            <button class="tab" data-tab="taskmanager">ã‚¿ã‚¹ã‚¯ç®¡ç†</button>
            <button class="tab" data-tab="history">å±¥æ­´</button>
            <button class="tab" data-tab="settings">è¨­å®š</button>
        </div>
        <div id="tracker" class="tab-content active">
            <div class="tracker-layout">
                <div class="tracker-sidebar">
                    <h4>ğŸ‘¥ æ‹…å½“è€…</h4>
                    <div id="memberList2"></div>
                </div>
                <div class="tracker-center">
                    <div class="mobile-member-select">
                        <select id="mobileMemberSelect" onchange="currentMember=this.value;render();"></select>
                    </div>
                    <div id="pendingTasksAlert"></div>
                    <div class="timer-bar" id="timerBar">
                        <div style="display:flex;align-items:center;">
                            <span class="task-name" id="timerTaskName">-</span>
                            <span class="time" id="timerTime">00:00</span>
                        </div>
                        <button class="stop-btn" onclick="stopTimer()">â¹ åœæ­¢</button>
                    </div>
                    <div class="card">
                        <h3>ğŸ“‹ ã‚¿ã‚¹ã‚¯ <span id="currentMemberName" style="color:#667eea;"></span></h3>
                        <div class="task-buttons" id="taskButtons"></div>
                    </div>
                    <div class="card gantt-card">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <h3 style="margin:0;">ğŸ“Š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çŠ¶æ³</h3>
                            <span id="ganttCurrentTime" style="font-size:14px;font-weight:700;color:#667eea;"></span>
                        </div>
                        <div id="ganttFilterBadge"></div>
                        <div id="ganttLegend" class="chart-legend" style="margin-bottom:10px;"></div>
                        <div class="gantt-container" id="ganttContainer">
                            <div class="gantt-header" id="ganttHeader"></div>
                            <div class="gantt-body" id="ganttBody"></div>
                        </div>
                    </div>
                </div>
                <div class="tracker-right">
                    <h4>ğŸ“Š æœ¬æ—¥ã®è¨˜éŒ²</h4>
                    <div id="todayPieChart" style="margin-bottom:15px;"></div>
                    <div class="summary-grid" id="todaySummary"></div>
                    <div id="todayRecords" style="max-height:calc(100vh - 450px);overflow-y:auto;"></div>
                </div>
            </div>
        </div>
        <div id="history" class="tab-content">
            <div class="card">
                <h3>ğŸ“Š å±¥æ­´ãƒ»é›†è¨ˆ</h3>
                <div class="date-nav" style="margin-bottom:15px;">
                    <button onclick="changeDate(-1)">â† å‰æ—¥</button>
                    <input type="date" id="historyDate" onchange="renderHistory()">
                    <button onclick="changeDate(1)">ç¿Œæ—¥ â†’</button>
                    <button onclick="goToday()">ä»Šæ—¥</button>
                </div>
                <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;align-items:center;">
                    <label style="font-size:13px;font-weight:600;">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</label>
                    <select id="filterMember" onchange="renderHistory()" style="padding:8px;border:2px solid #ddd;border-radius:6px;">
                        <option value="">å…¨å“¡</option>
                    </select>
                    <select id="filterTask" onchange="renderHistory()" style="padding:8px;border:2px solid #ddd;border-radius:6px;">
                        <option value="">å…¨ã‚¿ã‚¹ã‚¯</option>
                    </select>
                </div>
                <div id="historyChart"></div>
                <div class="summary-grid" id="historySummary" style="margin-top:20px;"></div>
                <div id="historyRecords" style="margin-top:15px;"></div>
            </div>
        </div>
        <div id="taskmanager" class="tab-content">
            <div class="card">
                <h3>ğŸ“‹ ã‚¿ã‚¹ã‚¯ç®¡ç†</h3>
                <div id="taskAlerts"></div>
                <div style="display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:8px;margin-bottom:15px;">
                    <input type="text" id="newTaskName" placeholder="ã‚¿ã‚¹ã‚¯å">
                    <input type="date" id="newTaskDeadline">
                    <select id="newTaskAssignee"></select>
                    <button class="btn btn-primary" onclick="addTaskItem()">è¿½åŠ </button>
                </div>
                <div style="margin-bottom:10px;">
                    <label style="font-size:12px;color:#666;">
                        <input type="checkbox" id="hideCompletedTasks" onchange="renderTaskManager()"> å®Œäº†æ¸ˆã¿ã‚’éè¡¨ç¤º
                    </label>
                </div>
                <div id="taskManagerList"></div>
            </div>
        </div>
        <div id="settings" class="tab-content">
            <div class="card">
                <h3>ğŸ‘¥ æ‹…å½“è€…</h3>
                <div id="memberList"></div>
                <div class="form-row">
                    <input type="text" id="newMember" placeholder="æ‹…å½“è€…å">
                    <button class="btn btn-primary" onclick="addMember()">è¿½åŠ </button>
                </div>
            </div>
            <div class="card">
                <h3>ğŸ·ï¸ ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¹ã‚¯</h3>
                <p style="font-size:12px;color:#666;margin-bottom:10px;">æ‹…å½“è€…ã”ã¨ã«è¿½åŠ ãƒœã‚¿ãƒ³ã‚’è¨­å®š</p>
                <div class="form-group">
                    <label>æ‹…å½“è€…</label>
                    <select id="customTaskMember" onchange="renderCustomTasks()"></select>
                </div>
                <div id="customTaskList"></div>
                <div class="form-row">
                    <input type="text" id="newCustomTask" placeholder="ã‚¿ã‚¹ã‚¯å">
                    <button class="btn btn-primary" onclick="addCustomTask()">è¿½åŠ </button>
                </div>
            </div>
            <div class="card">
                <h3>â˜ï¸ Firebase</h3>
                <textarea id="firebaseConfig" style="width:100%;height:70px;font-family:monospace;font-size:10px;padding:8px;border:2px solid #ddd;border-radius:8px;margin-bottom:10px;">{"apiKey":"AIzaSyAwZQMhF5qIv1XSADce2JiN_qAV88TxEQ8","databaseURL":"https://qcnippo-default-rtdb.asia-southeast1.firebasedatabase.app","projectId":"qcnippo"}</textarea>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="connectFB()">æ¥ç¶š</button>
                    <button class="btn btn-secondary" onclick="disconnectFB()">åˆ‡æ–­</button>
                    <button class="btn btn-secondary" onclick="uploadFB()">â†‘é€ä¿¡</button>
                    <button class="btn btn-secondary" onclick="downloadFB()">â†“å—ä¿¡</button>
                </div>
            </div>
            <div class="card">
                <h3>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿</h3>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="exportData()">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button class="btn btn-secondary" onclick="importData()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                    <button class="btn btn-danger" onclick="clearData()">å…¨å‰Šé™¤</button>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3>è¨˜éŒ²ã‚’ç·¨é›†</h3>
            <div class="form-group">
                <label>ã‚¿ã‚¹ã‚¯å</label>
                <input type="text" id="editTaskName">
            </div>
            <div class="form-group">
                <label>é–‹å§‹</label>
                <input type="time" id="editStart">
            </div>
            <div class="form-group">
                <label>çµ‚äº†</label>
                <input type="time" id="editEnd">
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteRecord()">å‰Šé™¤</button>
                <button class="btn btn-secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="saveRecord()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <h3>è¨˜éŒ²ã‚’è¿½åŠ </h3>
            <div class="form-group">
                <label>ã‚¿ã‚¹ã‚¯</label>
                <select id="addTaskName"></select>
            </div>
            <div class="form-group">
                <label>é–‹å§‹</label>
                <input type="time" id="addStart">
            </div>
            <div class="form-group">
                <label>çµ‚äº†</label>
                <input type="time" id="addEnd">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="addRecord()">è¿½åŠ </button>
            </div>
        </div>
    </div>

    <div id="taskModal" class="modal">
        <div class="modal-content">
            <h3>ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </h3>
            <div class="form-group">
                <label>ã‚¿ã‚¹ã‚¯å</label>
                <input type="text" id="modalTaskName">
            </div>
            <div class="form-group">
                <label>ã‚¢ã‚¤ã‚³ãƒ³</label>
                <div id="iconSelector" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTaskModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="saveNewTask()">è¿½åŠ </button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
    const DEFAULT_TASKS = ['æœç¤¼','æ‰“åˆã›','ä¸å…·åˆå¯¾å¿œ','ç•°å¸¸å‡¦ç½®','ä¿ç•™å“å¯¾å¿œ','è³‡æ–™ä½œæˆ','ãƒ¡ãƒ¼ãƒ«','å¤–å‡º','æ¥å®¢å¯¾å¿œ','ãã®ä»–'];
    const ICONS = {'æœç¤¼':'ğŸŒ…','æ‰“åˆã›':'ğŸ‘¥','ä¸å…·åˆå¯¾å¿œ':'ğŸ”§','ç•°å¸¸å‡¦ç½®':'âš ï¸','ä¿ç•™å“å¯¾å¿œ':'ğŸ“¦','è³‡æ–™ä½œæˆ':'ğŸ“','ãƒ¡ãƒ¼ãƒ«':'âœ‰ï¸','å¤–å‡º':'ğŸš—','æ¥å®¢å¯¾å¿œ':'ğŸ¤','ãã®ä»–':'ğŸ“Œ'};
    const COLORS = {'æœç¤¼':'#f59e0b','æ‰“åˆã›':'#3b82f6','ä¸å…·åˆå¯¾å¿œ':'#ef4444','ç•°å¸¸å‡¦ç½®':'#dc2626','ä¿ç•™å“å¯¾å¿œ':'#8b5cf6','è³‡æ–™ä½œæˆ':'#10b981','ãƒ¡ãƒ¼ãƒ«':'#06b6d4','å¤–å‡º':'#14b8a6','æ¥å®¢å¯¾å¿œ':'#ec4899','ãã®ä»–':'#6b7280'};
    const CUSTOM_COLORS = ['#f43f5e','#a855f7','#6366f1','#0ea5e9','#22c55e','#eab308','#f97316','#64748b','#78716c','#84cc16'];
    let members=['æ‹…å½“è€…1'], customTasks={}, customIcons={}, records=[], activeTimers={}, currentMember=null, editingId=null, db=null, fbConnected=false;
    
    // ã‚¿ã‚¹ã‚¯ç®¡ç†ç”¨ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒƒã‚«ãƒ¼ã¨ã¯ç‹¬ç«‹ï¼‰
    let taskList = []; // {id, name, plannedHours, progress, assignee, deadline, completed, completedDate}

    // ã‚¿ã‚¹ã‚¯ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
    function getTaskIcon(task) {
        return ICONS[task] || customIcons[task] || 'ğŸ“‹';
    }
    
    // ã‚¿ã‚¹ã‚¯ã®è‰²ã‚’å–å¾—
    function getTaskColor(task) {
        if (COLORS[task]) return COLORS[task];
        // ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¹ã‚¯ã«ã¯è‡ªå‹•ã§è‰²ã‚’å‰²ã‚Šå½“ã¦
        const allCustom = Object.values(customTasks).flat();
        const idx = allCustom.indexOf(task);
        if (idx >= 0) return CUSTOM_COLORS[idx % CUSTOM_COLORS.length];
        return '#667eea';
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        document.querySelectorAll('.tab').forEach(t => t.onclick = () => {
            document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
            t.classList.add('active');
            document.getElementById(t.dataset.tab).classList.add('active');
            render();
        });
        currentMember = members[0] || null;
        document.getElementById('todayDate').textContent = new Date().toLocaleDateString('ja-JP',{year:'numeric',month:'long',day:'numeric',weekday:'short'});
        document.getElementById('historyDate').value = formatDate(new Date());
        render();

        // 1ç§’ã”ã¨ã®æ›´æ–°ï¼ˆã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºãƒ»ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ã‚¹ã‚¯ã®çµŒéæ™‚é–“ï¼‰
        setInterval(() => {
            updateTimerBar();
            const trackerTab = document.getElementById('tracker');
            if (trackerTab && trackerTab.classList.contains('active')) {
                renderTaskButtons();
            }
        }, 1000);

        // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã¯5ç§’ã”ã¨ã«æ›´æ–°ï¼ˆè² è·è»½æ¸›ï¼‰
        setInterval(() => {
            const trackerTab = document.getElementById('tracker');
            if (trackerTab && trackerTab.classList.contains('active')) {
                renderGantt();
            }
        }, 5000);

        autoConnectFB();
    });

    function loadData() {
        try {
            members=JSON.parse(localStorage.getItem('tt_members')||'["æ‹…å½“è€…1"]');
            customTasks=JSON.parse(localStorage.getItem('tt_customTasks')||'{}');
            customIcons=JSON.parse(localStorage.getItem('tt_customIcons')||'{}');
            records=JSON.parse(localStorage.getItem('tt_records')||'[]');
            activeTimers=JSON.parse(localStorage.getItem('tt_activeTimers')||'{}');
            taskList=JSON.parse(localStorage.getItem('tt_taskList')||'[]');
        } catch(e){}
    }

    function saveData() {
        localStorage.setItem('tt_members',JSON.stringify(members));
        localStorage.setItem('tt_customTasks',JSON.stringify(customTasks));
        localStorage.setItem('tt_customIcons',JSON.stringify(customIcons));
        localStorage.setItem('tt_records',JSON.stringify(records));
        localStorage.setItem('tt_activeTimers',JSON.stringify(activeTimers));
        localStorage.setItem('tt_taskList',JSON.stringify(taskList));
    }

    function render() {
        renderMemberTabs();
        renderTaskButtons();
        renderTodayRecords();
        renderHistory();
        renderSettings();
        updateTimerBar();
        renderTaskManager();
        renderGantt();
        checkPendingTasks();
    }

    function renderMemberTabs() {
        const el = document.getElementById('memberList2');
        if (el) {
            el.innerHTML = members.map(m => {
                const isActive = currentMember === m;
                const timer = activeTimers[m];
                const isRunning = !!timer;
                const taskInfo = isRunning
                    ? `<div class="member-task">${ICONS[timer.task]||'ğŸ“‹'} ${timer.task}</div>`
                    : '<div class="member-task idle">å¾…æ©Ÿä¸­</div>';
                return `<div class="member-list-item ${isActive ? 'active' : ''}" onclick="currentMember='${m}';render();">
                    <div class="member-info">
                        <span class="member-name">${m}</span>
                        ${taskInfo}
                    </div>
                    <span class="status ${isRunning ? 'running' : 'idle'}"></span>
                </div>`;
            }).join('');
        }
        
        // ã‚¹ãƒãƒ›ç”¨ã‚»ãƒ¬ã‚¯ãƒˆ
        const mobileSelect = document.getElementById('mobileMemberSelect');
        if (mobileSelect) {
            mobileSelect.innerHTML = members.map(m => {
                const timer = activeTimers[m];
                const taskInfo = timer ? ` (${timer.task})` : '';
                return `<option value="${m}" ${m===currentMember?'selected':''}>${m}${taskInfo}</option>`;
            }).join('');
        }
        
        // ç¾åœ¨ã®æ‹…å½“è€…åã‚’è¡¨ç¤º
        const nameEl = document.getElementById('currentMemberName');
        if (nameEl && currentMember) nameEl.textContent = `- ${currentMember}`;
    }

    function renderTaskButtons() {
        const el = document.getElementById('taskButtons');
        if (!el) return;
        if (!currentMember) {
            el.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#888;padding:20px;">æ‹…å½“è€…ã‚’é¸æŠ</div>';
            return;
        }
        const timer = activeTimers[currentMember];
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¹ã‚¯ã¯å¸¸ã«è¡¨ç¤ºã€ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¹ã‚¯ã¯æ‹…å½“è€…ã”ã¨
        const memberCustomTasks = customTasks[currentMember] || [];
        const allTasks = [...DEFAULT_TASKS, ...memberCustomTasks];
        el.innerHTML = allTasks.map(t => {
            const active = timer && timer.task === t;
            return `<button class="task-btn ${active?'active':''}" onclick="toggleTask('${t}')">
                <div class="icon">${getTaskIcon(t)}</div>
                <div>${t}</div>
                ${active?`<div class="elapsed">${getElapsed(timer.startTime)}</div>`:''}
            </button>`;
        }).join('') + `<button class="add-task-btn" onclick="openTaskModal()">ï¼‹ è¿½åŠ </button>`;
    }

    function renderTodayRecords() {
        const today = formatDate(new Date());
        const recs = records.filter(r => r.date === today && r.member === currentMember);
        renderPieChart(recs);
        renderRecordList('todayRecords', 'todaySummary', recs, true);
    }

    function renderPieChart(recs) {
        const pieEl = document.getElementById('todayPieChart');
        if (!pieEl) return;
        
        if (!recs.length) {
            pieEl.innerHTML = '<div style="text-align:center;color:#888;font-size:12px;padding:10px;">è¨˜éŒ²ãªã—</div>';
            return;
        }
        
        // ã‚¿ã‚¹ã‚¯åˆ¥ã«é›†è¨ˆ
        const totals = {};
        let total = 0;
        recs.forEach(r => {
            const h = calcHours(r.startTime, r.endTime);
            totals[r.task] = (totals[r.task] || 0) + h;
            total += h;
        });
        
        // ã‚½ãƒ¼ãƒˆã—ã¦ä¸Šä½ã‚’å–å¾—
        const sorted = Object.entries(totals).sort((a, b) => b[1] - a[1]);
        
        // å††ã‚°ãƒ©ãƒ•ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆ
        let gradientStops = [];
        let currentAngle = 0;
        const labelPositions = [];
        const radius = 140; // ã‚°ãƒ©ãƒ•ã®åŠå¾„
        const labelRadius = 100; // ãƒ©ãƒ™ãƒ«é…ç½®ã®åŠå¾„
        
        sorted.forEach(([task, hours]) => {
            const percent = (hours / total) * 100;
            const color = getTaskColor(task);
            const startAngle = currentAngle;
            const endAngle = currentAngle + (percent * 3.6);
            gradientStops.push(`${color} ${startAngle}deg ${endAngle}deg`);
            
            // ãƒ©ãƒ™ãƒ«ä½ç½®ã‚’è¨ˆç®—ï¼ˆæ‰‡ã®ä¸­å¤®ï¼‰
            const midAngle = (startAngle + endAngle) / 2;
            const radians = (midAngle - 90) * (Math.PI / 180);
            labelPositions.push({
                task,
                hours,
                percent,
                x: radius + labelRadius * Math.cos(radians),
                y: radius + labelRadius * Math.sin(radians)
            });
            
            currentAngle = endAngle;
        });
        
        const gradient = `conic-gradient(${gradientStops.join(', ')})`;
        
        // ãƒ©ãƒ™ãƒ«HTMLç”Ÿæˆ
        const labelsHtml = labelPositions.map(p => {
            if (p.percent < 5) return ''; // 5%æœªæº€ã¯éè¡¨ç¤º
            return `<div class="pie-label" style="left:${p.x}px;top:${p.y}px;transform:translate(-50%,-50%);">
                ${getTaskIcon(p.task)} ${p.task}<br>${p.hours.toFixed(1)}h
            </div>`;
        }).join('');
        
        pieEl.innerHTML = `<div class="pie-chart-container">
            <div class="pie-chart" style="background:${gradient}">
                ${labelsHtml}
                <div class="pie-chart-center">
                    <div class="total-hours">${total.toFixed(1)}h</div>
                    <div class="total-label">åˆè¨ˆ</div>
                </div>
            </div>
        </div>`;
    }

    function renderHistory() {
        const date = document.getElementById('historyDate')?.value || formatDate(new Date());
        const filterMember = document.getElementById('filterMember')?.value || '';
        const filterTask = document.getElementById('filterTask')?.value || '';
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ›´æ–°
        updateHistoryFilters(date);
        
        // å¯¾è±¡æ—¥ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        let recs = records.filter(r => r.date === date);
        if (filterMember) recs = recs.filter(r => r.member === filterMember);
        if (filterTask) recs = recs.filter(r => r.task === filterTask);
        
        // ã‚°ãƒ©ãƒ•æç”»
        renderHistoryChart(recs, date);
        
        // ã‚µãƒãƒªãƒ¼ï¼ˆå…¨ä½“é›†è¨ˆï¼‰
        renderHistorySummary(recs);
        
        // è©³ç´°ãƒªã‚¹ãƒˆ
        renderHistoryRecords(recs);
    }

    function updateHistoryFilters(date) {
        const memberSelect = document.getElementById('filterMember');
        const taskSelect = document.getElementById('filterTask');
        if (!memberSelect || !taskSelect) return;
        
        const currentMemberVal = memberSelect.value;
        const currentTask = taskSelect.value;
        
        // æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        memberSelect.innerHTML = '<option value="">å…¨å“¡</option>' + members.map(m => 
            `<option value="${m}" ${m===currentMemberVal?'selected':''}>${m}</option>`
        ).join('');
        
        // ã‚¿ã‚¹ã‚¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆãã®æ—¥ã«ä½¿ã‚ã‚ŒãŸã‚¿ã‚¹ã‚¯ã®ã¿ï¼‰
        const dayRecs = records.filter(r => r.date === date);
        const usedTasks = [...new Set(dayRecs.map(r => r.task))];
        taskSelect.innerHTML = '<option value="">å…¨ã‚¿ã‚¹ã‚¯</option>' + usedTasks.map(t => 
            `<option value="${t}" ${t===currentTask?'selected':''}>${t}</option>`
        ).join('');
    }

    function renderHistoryChart(recs, date) {
        const chartEl = document.getElementById('historyChart');
        if (!chartEl) return;
        
        if (!recs.length) {
            chartEl.innerHTML = '<div style="text-align:center;color:#888;padding:30px;">ã“ã®æ—¥ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
            return;
        }
        
        // æ‹…å½“è€…åˆ¥ãƒ»ã‚¿ã‚¹ã‚¯åˆ¥ã«é›†è¨ˆ
        const memberData = {};
        recs.forEach(r => {
            if (!memberData[r.member]) memberData[r.member] = {};
            const hours = calcHours(r.startTime, r.endTime);
            memberData[r.member][r.task] = (memberData[r.member][r.task] || 0) + hours;
        });
        
        // å…¨ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆï¼ˆå‡¡ä¾‹ç”¨ï¼‰
        const allTasks = [...new Set(recs.map(r => r.task))];
        
        // æœ€å¤§å€¤ï¼ˆãƒãƒ¼ã®ã‚¹ã‚±ãƒ¼ãƒ«ç”¨ï¼‰
        let maxHours = 0;
        Object.values(memberData).forEach(tasks => {
            const total = Object.values(tasks).reduce((a,b) => a+b, 0);
            if (total > maxHours) maxHours = total;
        });
        if (maxHours === 0) maxHours = 8;
        
        // å‡¡ä¾‹
        let html = '<div class="chart-legend">';
        allTasks.forEach(task => {
            const color = COLORS[task] || '#667eea';
            html += `<div class="chart-legend-item" onclick="toggleTaskFilter('${task}')">
                <div class="chart-legend-color" style="background:${color}"></div>
                <span>${task}</span>
            </div>`;
        });
        html += '</div>';
        
        // æ‹…å½“è€…åˆ¥ã‚°ãƒ©ãƒ•
        html += '<div class="chart-container">';
        Object.entries(memberData).forEach(([member, tasks]) => {
            const memberTotal = Object.values(tasks).reduce((a,b) => a+b, 0);
            html += `<div class="chart-member">
                <div class="chart-member-name">ğŸ‘¤ ${member} <span class="chart-member-total">åˆè¨ˆ: ${memberTotal.toFixed(1)}h</span></div>`;
            
            // ã‚¿ã‚¹ã‚¯åˆ¥ãƒãƒ¼
            Object.entries(tasks).sort((a,b) => b[1] - a[1]).forEach(([task, hours]) => {
                const color = COLORS[task] || '#667eea';
                const width = Math.max(5, (hours / maxHours) * 100);
                const icon = ICONS[task] || 'ğŸ“‹';
                html += `<div class="chart-bar-row">
                    <div class="chart-bar-label" title="${task}">${icon} ${task}</div>
                    <div class="chart-bar-container">
                        <div class="chart-bar" style="width:${width}%;background:${color};">${hours.toFixed(1)}h</div>
                    </div>
                    <div class="chart-bar-value">${hours.toFixed(1)}h</div>
                </div>`;
            });
            
            html += '</div>';
        });
        html += '</div>';
        
        chartEl.innerHTML = html;
    }

    function toggleTaskFilter(task) {
        const filterTask = document.getElementById('filterTask');
        if (filterTask) {
            filterTask.value = filterTask.value === task ? '' : task;
            renderHistory();
        }
    }

    function renderHistorySummary(recs) {
        const summaryEl = document.getElementById('historySummary');
        if (!summaryEl) return;
        
        const totals = {}; let total = 0;
        recs.forEach(r => { const h = calcHours(r.startTime, r.endTime); totals[r.task] = (totals[r.task]||0) + h; total += h; });
        
        summaryEl.innerHTML = `<div class="summary-item total"><div class="label">åˆè¨ˆ</div><div class="value">${total.toFixed(1)}h</div></div>` +
            Object.entries(totals).sort((a,b)=>b[1]-a[1]).map(([t,h])=>`<div class="summary-item"><div class="label">${t}</div><div class="value">${h.toFixed(1)}h</div></div>`).join('');
    }

    function renderHistoryRecords(recs) {
        const listEl = document.getElementById('historyRecords');
        if (!listEl) return;
        
        if (!recs.length) {
            listEl.innerHTML = '';
            return;
        }
        
        recs.sort((a,b) => a.startTime.localeCompare(b.startTime));
        listEl.innerHTML = '<h4 style="margin-bottom:10px;font-size:13px;color:#555;">ğŸ“ è©³ç´°è¨˜éŒ²</h4>' +
            recs.map(r => `<div class="record-item" onclick="openEditModal(${r.id})">
                <div class="color-bar" style="background:${COLORS[r.task]||'#667eea'}"></div>
                <div class="info">
                    <div class="task-name">${ICONS[r.task]||'ğŸ“‹'} ${r.task}</div>
                    <div class="time-range">${r.startTime} - ${r.endTime} (${r.member})</div>
                </div>
                <div class="duration">${calcHours(r.startTime,r.endTime).toFixed(1)}h</div>
            </div>`).join('');
    }

    // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ
    function renderGantt() {
        const container = document.getElementById('ganttContainer');
        const header = document.getElementById('ganttHeader');
        const body = document.getElementById('ganttBody');
        const legend = document.getElementById('ganttLegend');
        const timeDisplay = document.getElementById('ganttCurrentTime');
        if (!container || !header || !body) return;
        
        const now = new Date();
        const today = formatDate(now);
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        
        // ç¾åœ¨æ™‚åˆ»è¡¨ç¤º
        if (timeDisplay) {
            timeDisplay.textContent = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${String(currentHour).padStart(2,'0')}:${String(currentMinute).padStart(2,'0')}`;
        }
        
        // æ™‚é–“ç¯„å›²ï¼ˆ6æ™‚ã€œ22æ™‚ï¼‰
        const startHour = 6;
        const endHour = 22;
        const hours = [];
        for (let h = startHour; h <= endHour; h++) hours.push(h);
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæ™‚é–“è»¸ï¼‰
        let headerHtml = '<div class="gantt-member-col">æ‹…å½“è€…</div>';
        hours.forEach(h => {
            const isCurrent = h === currentHour;
            headerHtml += `<div class="gantt-time-label ${isCurrent?'current':''}">${h}:00</div>`;
        });
        header.innerHTML = headerHtml;
        
        // ä»Šæ—¥ã®è¨˜éŒ²ã‚’å–å¾—
        const todayRecs = records.filter(r => r.date === today);
        
        // ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ï¼ˆå‡¡ä¾‹ç”¨ï¼‰
        const usedTasks = [...new Set([...todayRecs.map(r => r.task), ...Object.values(activeTimers).map(t => t.task)])];
        
        // å‡¡ä¾‹
        if (legend) {
            legend.innerHTML = usedTasks.map(task => {
                const color = getTaskColor(task);
                const isFiltered = ganttFilterTask === task;
                return `<div class="chart-legend-item ${isFiltered?'active':''}" onclick="toggleGanttFilter('${task}')" style="cursor:pointer;${isFiltered?'background:'+color+';color:white;border-radius:4px;':''}">
                    <div class="chart-legend-color" style="background:${color}"></div>
                    <span>${getTaskIcon(task)} ${task}</span>
                </div>`;
            }).join('');
        }
        
        // æ‹…å½“è€…ã”ã¨ã®è¡Œ
        let bodyHtml = '';
        members.forEach(member => {
            const timer = activeTimers[member];
            const isActive = !!timer;
            const memberRecs = todayRecs.filter(r => r.member === member);
            
            bodyHtml += `<div class="gantt-row">
                <div class="gantt-member-col">
                    <span class="status-dot ${isActive?'active':'idle'}"></span>
                    <span>${member}</span>
                </div>`;
            
            // æ™‚é–“ã‚»ãƒ«
            hours.forEach(h => {
                const isCurrent = h === currentHour;
                bodyHtml += `<div class="gantt-cell ${isCurrent?'current':''}" data-hour="${h}" data-member="${member}">`;
                
                // ç¾åœ¨æ™‚åˆ»ãƒ©ã‚¤ãƒ³
                if (isCurrent) {
                    const minutePercent = (currentMinute / 60) * 100;
                    bodyHtml += `<div class="gantt-now-line" style="left:${minutePercent}%"></div>`;
                }
                
                bodyHtml += '</div>';
            });
            
            bodyHtml += '</div>';
        });
        body.innerHTML = bodyHtml;
        
        // ãƒãƒ¼ã‚’é…ç½®
        members.forEach(member => {
            const timer = activeTimers[member];
            const memberRecs = todayRecs.filter(r => r.member === member);
            
            // å®Œäº†ã—ãŸè¨˜éŒ²ã®ãƒãƒ¼
            memberRecs.forEach(r => {
                const [sh, sm] = r.startTime.split(':').map(Number);
                const [eh, em] = r.endTime.split(':').map(Number);
                placeGanttBar(member, r.task, sh, sm, eh, em, false);
            });
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ã‚¤ãƒãƒ¼ã®ãƒãƒ¼
            if (timer) {
                const start = new Date(timer.startTime);
                const sh = start.getHours();
                const sm = start.getMinutes();
                placeGanttBar(member, timer.task, sh, sm, currentHour, currentMinute, true);
            }
        });

        // ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ï¼ˆå†æç”»å¾Œï¼‰
        updateGanttFilter();
    }

    let ganttFilterTask = null; // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨

    function placeGanttBar(member, task, startH, startM, endH, endM, isActive) {
        const startHour = 6;
        const endHour = 22;
        
        // ç¯„å›²å¤–ãƒã‚§ãƒƒã‚¯
        if (endH < startHour || startH > endHour) return;
        
        // é–‹å§‹ã‚»ãƒ«ã‚’è¦‹ã¤ã‘ã‚‹
        const startCellHour = Math.max(startHour, startH);
        const cell = document.querySelector(`.gantt-cell[data-hour="${startCellHour}"][data-member="${member}"]`);
        if (!cell) return;
        
        // ä½ç½®è¨ˆç®—
        const cellWidth = 50;
        const totalHours = endHour - startHour + 1;
        
        let leftOffset = 0;
        if (startH >= startHour) {
            leftOffset = (startM / 60) * cellWidth;
        }
        
        // å¹…è¨ˆç®—
        const startPos = Math.max(startHour, startH) + (startH >= startHour ? startM/60 : 0);
        const endPos = Math.min(endHour + 1, endH + endM/60);
        const duration = endPos - startPos;
        const width = duration * cellWidth;
        
        if (width <= 0) return;
        
        const color = getTaskColor(task);
        const icon = getTaskIcon(task);
        
        const bar = document.createElement('div');
        bar.className = `gantt-bar ${isActive ? 'active' : ''}`;
        bar.dataset.task = task;
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        if (ganttFilterTask && ganttFilterTask !== task) {
            bar.classList.add('filtered-out');
        }
        
        bar.style.cssText = `left:${leftOffset}px; width:${width}px; background:${color};`;
        bar.innerHTML = `<span class="bar-icon">${icon}</span>${task}`;
        bar.title = `${task}\n${String(startH).padStart(2,'0')}:${String(startM).padStart(2,'0')} - ${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}\nã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼`;
        
        // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        bar.addEventListener('click', (e) => {
            e.stopPropagation();
            if (ganttFilterTask === task) {
                clearGanttFilter();
            } else {
                setGanttFilter(task);
            }
        });
        
        cell.appendChild(bar);
    }

    function setGanttFilter(task) {
        ganttFilterTask = task;
        updateGanttFilter();
        renderGantt(); // å‡¡ä¾‹ã‚‚æ›´æ–°
    }

    function clearGanttFilter() {
        ganttFilterTask = null;
        updateGanttFilter();
        renderGantt(); // å‡¡ä¾‹ã‚‚æ›´æ–°
    }

    function toggleGanttFilter(task) {
        if (ganttFilterTask === task) {
            clearGanttFilter();
        } else {
            setGanttFilter(task);
        }
    }

    function updateGanttFilter() {
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒƒã‚¸æ›´æ–°
        const badgeEl = document.getElementById('ganttFilterBadge');
        if (badgeEl) {
            if (ganttFilterTask) {
                const icon = getTaskIcon(ganttFilterTask);
                const color = getTaskColor(ganttFilterTask);
                badgeEl.innerHTML = `<div class="gantt-filter-badge" style="background:${color};">
                    ${icon} ${ganttFilterTask} ã‚’è¡¨ç¤ºä¸­
                    <button class="clear-btn" onclick="clearGanttFilter()">Ã—</button>
                </div>`;
            } else {
                badgeEl.innerHTML = '';
            }
        }
        
        // ãƒãƒ¼ã®è¡¨ç¤ºåˆ‡æ›¿
        document.querySelectorAll('.gantt-bar').forEach(bar => {
            if (ganttFilterTask && bar.dataset.task !== ganttFilterTask) {
                bar.classList.add('filtered-out');
            } else {
                bar.classList.remove('filtered-out');
            }
        });
    }

    function renderRecordList(listId, summaryId, recs, showAdd) {
        const listEl = document.getElementById(listId), summaryEl = document.getElementById(summaryId);
        if (!listEl || !summaryEl) return;
        const totals = {}; let total = 0;
        recs.forEach(r => { const h = calcHours(r.startTime, r.endTime); totals[r.task] = (totals[r.task]||0) + h; total += h; });
        summaryEl.innerHTML = `<div class="summary-item total"><div class="label">åˆè¨ˆ</div><div class="value">${total.toFixed(1)}h</div></div>` +
            Object.entries(totals).sort((a,b)=>b[1]-a[1]).map(([t,h])=>{
                const color = getTaskColor(t);
                return `<div class="summary-item" style="border-left:4px solid ${color};">
                    <div class="label">${getTaskIcon(t)} ${t}</div>
                    <div class="value">${h.toFixed(1)}h</div>
                </div>`;
            }).join('');
        if (!recs.length) {
            listEl.innerHTML = `<div style="text-align:center;color:#888;padding:20px;">è¨˜éŒ²ãªã—</div>${showAdd?`<button class="btn btn-secondary" style="width:100%;margin-top:10px;" onclick="openAddModal()">ï¼‹ æ‰‹å…¥åŠ›</button>`:''}`;
            return;
        }
        recs.sort((a,b) => a.startTime.localeCompare(b.startTime));
        listEl.innerHTML = recs.map(r => `<div class="record-item" onclick="openEditModal(${r.id})">
            <div class="color-bar" style="background:${getTaskColor(r.task)}"></div>
            <div class="info">
                <div class="task-name">${getTaskIcon(r.task)} ${r.task}</div>
                <div class="time-range">${r.startTime} - ${r.endTime}</div>
            </div>
            <div class="duration">${calcHours(r.startTime,r.endTime).toFixed(1)}h</div>
        </div>`).join('') + (showAdd?`<button class="btn btn-secondary" style="width:100%;margin-top:10px;" onclick="openAddModal()">ï¼‹ æ‰‹å…¥åŠ›</button>`:'');
    }

    function renderSettings() {
        document.getElementById('memberList').innerHTML = members.map(m => `<div class="setting-item">
            <span>${m}</span>
            <button class="btn btn-danger btn-sm" onclick="deleteMember('${m}')">å‰Šé™¤</button>
        </div>`).join('');
        const sel = document.getElementById('customTaskMember');
        if (sel) {
            const v = sel.value;
            sel.innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join('');
            sel.value = v || members[0];
            renderCustomTasks();
        }
    }

    function renderCustomTasks() {
        const m = document.getElementById('customTaskMember')?.value, el = document.getElementById('customTaskList');
        if (!el || !m) return;
        const tasks = customTasks[m] || [];
        el.innerHTML = tasks.length
            ? tasks.map(t => `<div class="setting-item">
                    <span>${t}</span>
                    <button class="btn btn-danger btn-sm" onclick="deleteCustomTask('${m}','${t}')">å‰Šé™¤</button>
                </div>`).join('')
            : '<div style="color:#888;font-size:12px;">ãªã—</div>';
    }

    function updateTimerBar() {
        const bar = document.getElementById('timerBar');
        if (!currentMember || !activeTimers[currentMember]) {
            bar.classList.remove('show');
            return;
        }
        const t = activeTimers[currentMember];
        bar.classList.add('show');
        document.getElementById('timerTaskName').textContent = `${ICONS[t.task]||'ğŸ“‹'} ${t.task}`;
        document.getElementById('timerTime').textContent = getElapsed(t.startTime);
    }

    // èª¤æ“ä½œã‚¬ãƒ¼ãƒ‰ä»˜ãã®ã‚¿ã‚¹ã‚¯åˆ‡æ›¿
    function toggleTask(task) {
        if (!currentMember) return;
        const timer = activeTimers[currentMember];
        const now = Date.now();

        if (timer && timer.task === task) {
            // åŒã˜ã‚¿ã‚¹ã‚¯ â†’ åœæ­¢ç¢ºèª
            if (confirm(`ã€Œ${task}ã€ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ`)) {
                stopTimer();
            }
            return;
        }

        // ç›´å‰3ç§’ä»¥å†…ã®åˆ‡æ›¿ã¯ã€Œä¸Šæ›¸ãã€æ‰±ã„ï¼ˆå‰ã‚¿ã‚¹ã‚¯ã‚’è¨˜éŒ²ã—ãªã„ï¼‰
        if (timer && timer.task !== task) {
            const lastSwitch = timer.lastSwitch || new Date(timer.startTime).getTime();
            if (now - lastSwitch < 3000) {
                activeTimers[currentMember] = {
                    task,
                    startTime: new Date().toISOString(),
                    lastSwitch: now
                };
                saveData();
                render();
                toast(`â–¶ ${task}ï¼ˆç›´å‰åˆ‡æ›¿ã§ä¸Šæ›¸ãï¼‰`);
                return;
            }
        }

        // é€šå¸¸ã®åˆ‡æ›¿ï¼šå‰ã‚¿ã‚¹ã‚¯ã‚’è¨˜éŒ²
        if (timer) {
            saveTimerAsRecord(currentMember, timer);
        }
        activeTimers[currentMember] = {
            task,
            startTime: new Date().toISOString(),
            lastSwitch: now
        };
        saveData();
        render();
        toast(`â–¶ ${task}`);
    }

    function stopTimer() {
        if (!currentMember || !activeTimers[currentMember]) return;
        const saved = saveTimerAsRecord(currentMember, activeTimers[currentMember]);
        delete activeTimers[currentMember];
        saveData();
        render(); 
        toast(saved ? 'â¹ åœæ­¢' : 'â¹ åœæ­¢ (1åˆ†æœªæº€ã¯è¨˜éŒ²ãªã—)');
    }

    function saveTimerAsRecord(member, timer) {
        const start = new Date(timer.startTime), end = new Date();
        const durationMs = end - start;
        // 1åˆ†æœªæº€ã¯è¨˜éŒ²ã—ãªã„
        if (durationMs < 60000) return false;
        records.push({
            id: Date.now(),
            member,
            task: timer.task,
            date: formatDate(start),
            startTime: formatTime(start),
            endTime: formatTime(end)
        });
        return true;
    }

    function getElapsed(st) {
        const ms = Date.now() - new Date(st).getTime();
        const s = Math.floor(ms/1000);
        const m = Math.floor(s/60);
        const h = Math.floor(m/60);
        return `${String(h).padStart(2,'0')}:${String(m%60).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
    }

    function calcHours(s, e) {
        const [sh,sm] = s.split(':').map(Number), [eh,em] = e.split(':').map(Number);
        return (eh*60+em-sh*60-sm)/60;
    }

    function formatDate(d) {
        return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
    }

    function formatTime(d) {
        return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
    }

    // é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
    function timeToMin(t) {
        const [h, m] = t.split(':').map(Number);
        return h * 60 + m;
    }

    function hasOverlap(member, date, start, end, excludeId = null) {
        const s = timeToMin(start);
        const e = timeToMin(end);
        return records.some(r => {
            if (r.member !== member || r.date !== date) return false;
            if (excludeId && r.id === excludeId) return false;
            const rs = timeToMin(r.startTime);
            const re = timeToMin(r.endTime);
            return Math.max(s, rs) < Math.min(e, re); // æ™‚é–“å¸¯ãŒé‡ãªã£ã¦ã„ã‚‹
        });
    }

    function openEditModal(id) {
        const r = records.find(x=>x.id===id);
        if(!r) return;
        editingId=id;
        document.getElementById('editTaskName').value=r.task;
        document.getElementById('editStart').value=r.startTime;
        document.getElementById('editEnd').value=r.endTime;
        document.getElementById('editModal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('editModal').classList.remove('show');
        editingId=null;
    }

    function saveRecord() {
        const r = records.find(x=>x.id===editingId);
        if(!r) return;
        const s=document.getElementById('editStart').value;
        const e=document.getElementById('editEnd').value;
        if(e<=s){
            alert('çµ‚äº†ã¯é–‹å§‹ã‚ˆã‚Šå¾Œã«ã—ã¦ãã ã•ã„');
            return;
        }

        // é‡è¤‡ãƒã‚§ãƒƒã‚¯
        if (hasOverlap(r.member, r.date, s, e, editingId)) {
            if (!confirm('ä»–ã®è¨˜éŒ²ã¨æ™‚é–“ãŒé‡ãªã£ã¦ã„ã¾ã™ã€‚ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
        }

        r.task=document.getElementById('editTaskName').value;
        r.startTime=s;
        r.endTime=e;
        saveData();
        closeModal();
        render();
        toast('âœ“ ä¿å­˜');
    }

    function deleteRecord() {
        if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
        records=records.filter(r=>r.id!==editingId);
        saveData();
        closeModal();
        render();
        toast('ğŸ—‘ å‰Šé™¤');
    }

    function openAddModal() {
        if(!currentMember){
            alert('æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }
        const tasks=[...DEFAULT_TASKS,...(customTasks[currentMember]||[])];
        document.getElementById('addTaskName').innerHTML=tasks.map(t=>`<option value="${t}">${t}</option>`).join('');
        const now=new Date();
        document.getElementById('addStart').value=formatTime(new Date(now-3600000));
        document.getElementById('addEnd').value=formatTime(now);
        document.getElementById('addModal').classList.add('show');
    }

    function closeAddModal() {
        document.getElementById('addModal').classList.remove('show');
    }

    function addRecord() {
        if (!currentMember) {
            alert('æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }
        const t=document.getElementById('addTaskName').value;
        const s=document.getElementById('addStart').value;
        const e=document.getElementById('addEnd').value;
        if(e<=s){
            alert('çµ‚äº†ã¯é–‹å§‹ã‚ˆã‚Šå¾Œã«ã—ã¦ãã ã•ã„');
            return;
        }
        const date = formatDate(new Date());

        // é‡è¤‡ãƒã‚§ãƒƒã‚¯
        if (hasOverlap(currentMember, date, s, e, null)) {
            if (!confirm('ä»–ã®è¨˜éŒ²ã¨æ™‚é–“ãŒé‡ãªã£ã¦ã„ã¾ã™ã€‚è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
        }

        records.push({
            id:Date.now(),
            member:currentMember,
            task:t,
            date,
            startTime:s,
            endTime:e
        });
        saveData();
        closeAddModal();
        render();
        toast('âœ“ è¿½åŠ ');
    }

    const AVAILABLE_ICONS = ['ğŸ“‹','ğŸ“','ğŸ’¼','ğŸ¯','ğŸ””','â­','ğŸ’¡','ğŸ”','ğŸ“Š','ğŸ“ˆ','ğŸ› ï¸','âš™ï¸','ğŸ”§','ğŸ”¨','ğŸ“±','ğŸ’»','ğŸ–¥ï¸','ğŸ“','ğŸ“§','ğŸ“¬','ğŸ“','âœï¸','ğŸ“Œ','ğŸ—‚ï¸','ğŸ“‚','ğŸ—ƒï¸','ğŸ“…','â°','ğŸ•','â±ï¸','ğŸš€','âœˆï¸','ğŸš—','ğŸšŒ','ğŸ­','ğŸ¢','ğŸ ','ğŸ‘¤','ğŸ‘¥','ğŸ¤','ğŸ’¬','ğŸ“¢','ğŸ”Š','ğŸ¤','ğŸ§','ğŸ“·','ğŸ¬','ğŸ¨','âœ…','âŒ','âš ï¸','â—','â“','ğŸ’°','ğŸ’µ','ğŸ§¾','ğŸ“¦','ğŸ','ğŸ›’','ğŸ”','ğŸ”‘','ğŸŒŸ','ğŸ‰'];
    let selectedIcon = 'ğŸ“‹';

    function openTaskModal() { 
        if(!currentMember){
            alert('æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }
        document.getElementById('modalTaskName').value=''; 
        selectedIcon = 'ğŸ“‹';
        renderIconSelector();
        document.getElementById('taskModal').classList.add('show'); 
    }

    function renderIconSelector() {
        const el = document.getElementById('iconSelector');
        if (!el) return;
        el.innerHTML = AVAILABLE_ICONS.map(icon => 
            `<div class="icon-option ${icon===selectedIcon?'selected':''}" onclick="selectIcon('${icon}')">${icon}</div>`
        ).join('');
    }

    function selectIcon(icon) {
        selectedIcon = icon;
        renderIconSelector();
    }

    function closeTaskModal() {
        document.getElementById('taskModal').classList.remove('show');
    }

    function saveNewTask() {
        const n=document.getElementById('modalTaskName').value.trim();
        if(!n){
            alert('ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        if(!customTasks[currentMember])customTasks[currentMember]=[];
        if(customTasks[currentMember].includes(n)||DEFAULT_TASKS.includes(n)){
            alert('æ—¢ã«å­˜åœ¨ã™ã‚‹ã‚¿ã‚¹ã‚¯ã§ã™');
            return;
        }
        customTasks[currentMember].push(n);
        customIcons[n]=selectedIcon;
        saveData();
        closeTaskModal();
        render();
        toast('âœ“ è¿½åŠ ');
    }

    function addMember() {
        const n=document.getElementById('newMember').value.trim();
        if(!n)return;
        if(members.includes(n)){
            alert('æ—¢ã«å­˜åœ¨ã—ã¾ã™');
            return;
        }
        members.push(n);
        document.getElementById('newMember').value='';
        saveData();
        render();
        toast('âœ“ è¿½åŠ ');
    }

    function deleteMember(m) {
        if(!confirm(`${m}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return;
        members=members.filter(x=>x!==m);
        delete customTasks[m];
        delete activeTimers[m];
        records=records.filter(r=>r.member!==m);
        if(currentMember===m)currentMember=members[0]||null;
        saveData();
        render();
        toast('ğŸ—‘ å‰Šé™¤');
    }

    function addCustomTask() {
        const m=document.getElementById('customTaskMember').value;
        const n=document.getElementById('newCustomTask').value.trim();
        if(!n)return;
        if(!customTasks[m])customTasks[m]=[];
        if(customTasks[m].includes(n)){
            alert('æ—¢ã«å­˜åœ¨ã—ã¾ã™');
            return;
        }
        customTasks[m].push(n);
        document.getElementById('newCustomTask').value='';
        saveData();
        renderCustomTasks();
        if(m===currentMember)renderTaskButtons();
        toast('âœ“ è¿½åŠ ');
    }

    function deleteCustomTask(m,t) {
        if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
        customTasks[m]=(customTasks[m]||[]).filter(x=>x!==t);
        saveData();
        renderCustomTasks();
        if(m===currentMember)renderTaskButtons();
    }

    function changeDate(d) {
        const el=document.getElementById('historyDate');
        const dt=new Date(el.value);
        dt.setDate(dt.getDate()+d);
        el.value=formatDate(dt);
        renderHistory();
    }

    function goToday() {
        document.getElementById('historyDate').value=formatDate(new Date());
        renderHistory();
    }

    function autoConnectFB() {
        const cfg=localStorage.getItem('tt_firebaseConfig');
        if(!cfg)return;
        document.getElementById('firebaseConfig').value=cfg;
        try {
            const c=JSON.parse(cfg);
            firebase.initializeApp(c);
            db=firebase.database();
            fbConnected=true;
            updateSyncStatus(true);
            setupFBListener();
        } catch(e){}
    }

    function connectFB() {
        try {
            const cfg=document.getElementById('firebaseConfig').value;
            const c=JSON.parse(cfg);
            if(db)firebase.app().delete();
            firebase.initializeApp(c);
            db=firebase.database();
            fbConnected=true;
            localStorage.setItem('tt_firebaseConfig',cfg);
            updateSyncStatus(true);
            setupFBListener();
            toast('âœ“ æ¥ç¶š');
        } catch(e){
            alert('ã‚¨ãƒ©ãƒ¼: '+e.message);
        }
    }

    function disconnectFB() {
        if(db)db.ref('timeTracker').off();
        fbConnected=false;
        updateSyncStatus(false);
        toast('åˆ‡æ–­');
    }

    function updateSyncStatus(c) {
        const el=document.getElementById('syncStatus');
        el.textContent=c?'âœ“ åŒæœŸä¸­':'æœªæ¥ç¶š';
        el.className='sync-status '+(c?'connected':'disconnected');
    }

    let fbUpdating=false;

    function setupFBListener() {
        db.ref('timeTracker').on('value', snap => {
            if(fbUpdating)return;
            const data=snap.val();
            if(!data)return;
            const local=localStorage.getItem('tt_lastUpdated');
            if(!local||data.lastUpdated>local){
                fbUpdating=true;
                members=data.members||members;
                customTasks=data.customTasks||{};
                customIcons=data.customIcons||{};
                records=data.records||[];
                activeTimers=data.activeTimers||{};
                taskList=data.taskList||[];
                localStorage.setItem('tt_lastUpdated',data.lastUpdated);
                saveData();
                render();
                fbUpdating=false;
            }
        });
    }

    function uploadFB() {
        if(!fbConnected){
            alert('æœªæ¥ç¶šã§ã™');
            return;
        }
        const now=new Date().toISOString();
        db.ref('timeTracker').set({members,customTasks,customIcons,records,activeTimers,taskList,lastUpdated:now});
        localStorage.setItem('tt_lastUpdated',now);
        toast('âœ“ é€ä¿¡');
    }

    function downloadFB() {
        if(!fbConnected){
            alert('æœªæ¥ç¶šã§ã™');
            return;
        }
        db.ref('timeTracker').once('value').then(snap => {
            const data=snap.val();
            if(data){
                members=data.members||members;
                customTasks=data.customTasks||{};
                customIcons=data.customIcons||{};
                records=data.records||[];
                activeTimers=data.activeTimers||{};
                taskList=data.taskList||[];
                saveData();
                render();
                toast('âœ“ å—ä¿¡');
            }
        });
    }

    function exportData() {
        const data={members,customTasks,customIcons,records,activeTimers,taskList,exported:new Date().toISOString()};
        const a=document.createElement('a');
        a.href=URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'}));
        a.download=`ã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒƒã‚«ãƒ¼_${formatDate(new Date())}.json`;
        a.click();
        toast('âœ“ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ');
    }

    function importData() {
        const input=document.createElement('input');
        input.type='file';
        input.accept='.json';
        input.onchange=e=>{
            const reader=new FileReader();
            reader.onload=ev=>{
                try {
                    const data=JSON.parse(ev.target.result);
                    if(!confirm('ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ'))return;
                    members=data.members||members;
                    customTasks=data.customTasks||{};
                    customIcons=data.customIcons||{};
                    records=data.records||[];
                    activeTimers=data.activeTimers||{};
                    taskList=data.taskList||[];
                    saveData();
                    render();
                    toast('âœ“ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ');
                } catch(e){
                    alert('ã‚¨ãƒ©ãƒ¼: '+e.message);
                }
            };
            reader.readAsText(e.target.files[0]);
        };
        input.click();
    }

    function clearData() {
        if(!confirm('å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
        if(!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
        members=['æ‹…å½“è€…1'];
        customTasks={};
        customIcons={};
        records=[];
        activeTimers={};
        taskList=[];
        currentMember=members[0];
        saveData();
        render();
        toast('ğŸ—‘ å‰Šé™¤');
    }

    function toast(msg) {
        const el=document.createElement('div');
        el.className='toast';
        el.textContent=msg;
        document.body.appendChild(el);
        setTimeout(()=>el.remove(),2000);
    }

    // å‰æ—¥ã®æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’ãƒã‚§ãƒƒã‚¯
    function checkPendingTasks() {
        const alertEl = document.getElementById('pendingTasksAlert');
        if (!alertEl) return;
        
        const today = formatDate(new Date());
        const pendingTasks = [];
        
        // å…¨ãƒ¡ãƒ³ãƒãƒ¼ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
        Object.entries(activeTimers).forEach(([member, timer]) => {
            const timerDate = formatDate(new Date(timer.startTime));
            // ä»Šæ—¥ã‚ˆã‚Šå‰ã®ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚‹å ´åˆ
            if (timerDate < today) {
                pendingTasks.push({
                    member,
                    task: timer.task,
                    startTime: timer.startTime,
                    date: timerDate
                });
            }
        });
        
        if (pendingTasks.length === 0) {
            alertEl.innerHTML = '';
            return;
        }
        
        let html = `<div class="pending-alert">
            <h4>âš ï¸ å‰æ—¥ã‹ã‚‰ç¶™ç¶šä¸­ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™</h4>`;
        
        pendingTasks.forEach(p => {
            const start = new Date(p.startTime);
            const startTimeStr = formatTime(start);
            html += `<div class="pending-item">
                <div class="pending-item-info">
                    <div class="name">${ICONS[p.task]||'ğŸ“‹'} ${p.task}</div>
                    <div class="detail">${p.member} | ${p.date} ${startTimeStr}ã€œ</div>
                </div>
                <div class="pending-actions">
                    <button class="btn-complete" onclick="completePendingTask('${p.member}')">çµ‚äº†æ™‚åˆ»ã‚’å…¥åŠ›</button>
                    <button class="btn-discard" onclick="discardPendingTask('${p.member}')">ç ´æ£„</button>
                </div>
            </div>`;
        });
        
        html += '</div>';
        alertEl.innerHTML = html;
    }

    function completePendingTask(member) {
        const timer = activeTimers[member];
        if (!timer) return;
        
        const start = new Date(timer.startTime);
        const startDate = formatDate(start);
        const startTimeStr = formatTime(start);
        
        // çµ‚äº†æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ã‚‚ã‚‰ã†
        const endTimeInput = prompt(
            `${member}ã®ã€Œ${timer.task}ã€ã®çµ‚äº†æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\n` +
            `é–‹å§‹: ${startDate} ${startTimeStr}\n` +
            `(ä¾‹: 18:00, 23:30)`,
            '18:00'
        );
        
        if (!endTimeInput) return;
        
        // æ™‚åˆ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯
        const timeMatch = endTimeInput.match(/^(\d{1,2}):(\d{2})$/);
        if (!timeMatch) {
            alert('æ­£ã—ã„æ™‚åˆ»å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 18:00ï¼‰');
            return;
        }
        
        const [_, hours, minutes] = timeMatch;
        const endTime = `${String(parseInt(hours)).padStart(2,'0')}:${minutes}`;
        
        // é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã‹ãƒã‚§ãƒƒã‚¯
        if (endTime <= startTimeStr) {
            alert('çµ‚äº†æ™‚åˆ»ã¯é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã«ã—ã¦ãã ã•ã„');
            return;
        }
        
        // ãƒ¬ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ä¿å­˜
        records.push({
            id: Date.now(),
            member: member,
            task: timer.task,
            date: startDate,
            startTime: startTimeStr,
            endTime: endTime
        });
        
        // ã‚¿ã‚¤ãƒãƒ¼ã‚’å‰Šé™¤
        delete activeTimers[member];
        
        saveData();
        render();
        toast(`âœ“ ${startDate}ã®è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
    }

    function discardPendingTask(member) {
        if (!confirm(`${member}ã®å‰æ—¥ã®ã‚¿ã‚¹ã‚¯ã‚’ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ\nè¨˜éŒ²ã•ã‚Œãšã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) return;
        
        delete activeTimers[member];
        saveData();
        render();
        toast('ğŸ—‘ ç ´æ£„ã—ã¾ã—ãŸ');
    }

    window.onclick = e => {
        if(e.target.classList.contains('modal')){
            closeModal();
            closeAddModal();
            closeTaskModal();
        }
    };

    // ã‚¿ã‚¹ã‚¯ç®¡ç†æ©Ÿèƒ½
    function renderTaskManager() {
        const alertsEl = document.getElementById('taskAlerts');
        const listEl = document.getElementById('taskManagerList');
        const assigneeEl = document.getElementById('newTaskAssignee');
        if (!alertsEl || !listEl) return;
        
        // æ‹…å½“è€…ã‚»ãƒ¬ã‚¯ãƒˆæ›´æ–°
        if (assigneeEl) {
            const cv = assigneeEl.value;
            assigneeEl.innerHTML = '<option value="">æ‹…å½“è€…</option>' + members.map(m => `<option value="${m}">${m}</option>`).join('');
            if (cv) assigneeEl.value = cv;
        }
        
        const hideCompleted = document.getElementById('hideCompletedTasks')?.checked;
        const today = new Date(); today.setHours(0,0,0,0);
        
        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        const overdue = [], warning = [];
        taskList.filter(t => !t.completed && t.deadline).forEach(t => {
            const dl = new Date(t.deadline); dl.setHours(0,0,0,0);
            const diff = Math.ceil((dl - today) / 86400000);
            if (diff < 0) overdue.push({...t, days: Math.abs(diff)});
            else if (diff <= 3) warning.push({...t, days: diff});
        });
        
        let alertHtml = '';
        if (overdue.length) {
            alertHtml += '<div class="task-alert danger"><h4>ğŸš¨ æœŸé™è¶…é</h4>';
            overdue.forEach(t => alertHtml += `<div class="task-alert-item">${t.name} (${t.assignee||'æœªè¨­å®š'}) - ${t.days}æ—¥è¶…é</div>`);
            alertHtml += '</div>';
        }
        if (warning.length) {
            alertHtml += '<div class="task-alert warning"><h4>âš ï¸ æœŸé™é–“è¿‘</h4>';
            warning.forEach(t => alertHtml += `<div class="task-alert-item">${t.name} (${t.assignee||'æœªè¨­å®š'}) - ${t.days===0?'ä»Šæ—¥':'ã‚ã¨'+t.days+'æ—¥'}</div>`);
            alertHtml += '</div>';
        }
        alertsEl.innerHTML = alertHtml;
        
        // ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ
        let list = hideCompleted ? taskList.filter(t => !t.completed) : [...taskList];
        list.sort((a,b) => {
            if (a.completed !== b.completed) return a.completed ? 1 : -1;
            if (!a.deadline) return 1;
            if (!b.deadline) return -1;
            return new Date(a.deadline) - new Date(b.deadline);
        });
        
        if (!list.length) {
            listEl.innerHTML = '<div style="text-align:center;color:#888;padding:20px;">ã‚¿ã‚¹ã‚¯ãªã—</div>';
            return;
        }
        
        listEl.innerHTML = list.map(t => {
            let statusClass = '';
            if (t.deadline && !t.completed) {
                const dl = new Date(t.deadline); dl.setHours(0,0,0,0);
                const diff = Math.ceil((dl - today) / 86400000);
                if (diff < 0) statusClass = 'overdue';
                else if (diff <= 3) statusClass = 'warning';
            }
            const progress = t.progress || 0;
            const gaugeClass = progress < 30 ? 'low' : progress < 70 ? 'mid' : 'high';
            return `<div class="task-manager-item ${statusClass} ${t.completed?'completed':''}">
                <div class="tm-name">${t.name}</div>
                <div class="tm-progress-container">
                    <input type="number" class="tm-progress" value="${progress}" min="0" max="100" onchange="updateTaskProgress(${t.id}, this.value)" ${t.completed?'disabled':''}>
                    <div class="tm-gauge">
                        <div class="tm-gauge-fill ${gaugeClass}" style="width:${progress}%"></div>
                        <span class="tm-gauge-text">${progress}%</span>
                    </div>
                </div>
                <div><input type="date" class="tm-deadline" value="${t.deadline||''}" onchange="updateTaskDeadline(${t.id}, this.value)" ${t.completed?'disabled':''}></div>
                <div>${t.assignee||'-'}${t.completed?'<br><small style="color:#10b981;">å®Œäº†</small>':''}</div>
                <div style="display:flex;gap:4px;">
                    ${!t.completed
                        ? `<button class="btn btn-success btn-sm" onclick="completeTaskItem(${t.id})">âœ“</button>`
                        : `<button class="btn btn-secondary btn-sm" onclick="uncompleteTaskItem(${t.id})">æˆ»</button>`}
                    <button class="btn btn-danger btn-sm" onclick="deleteTaskItem(${t.id})">Ã—</button>
                </div>
            </div>`;
        }).join('');
    }

    function addTaskItem() {
        const name = document.getElementById('newTaskName').value.trim();
        if (!name) {
            alert('ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        taskList.push({
            id: Date.now(),
            name: name,
            progress: 0,
            assignee: document.getElementById('newTaskAssignee').value || null,
            deadline: document.getElementById('newTaskDeadline').value || null,
            completed: false
        });
        document.getElementById('newTaskName').value = '';
        document.getElementById('newTaskDeadline').value = '';
        saveData();
        renderTaskManager();
        toast('âœ“ è¿½åŠ ');
    }

    function updateTaskProgress(id, value) {
        const t = taskList.find(x => x.id === id);
        if (t) {
            t.progress = Math.min(100, Math.max(0, parseInt(value) || 0));
        }
        saveData();
        renderTaskManager();
    }

    function updateTaskDeadline(id, value) {
        const t = taskList.find(x => x.id === id);
        if (t) { t.deadline = value || null; }
        saveData();
        renderTaskManager();
        toast('âœ“ ç´æœŸæ›´æ–°');
    }

    function completeTaskItem(id) {
        const t = taskList.find(x => x.id === id);
        if (t) {
            t.completed = true;
            t.completedDate = formatDate(new Date());
            t.progress = 100;
        }
        saveData();
        renderTaskManager();
        toast('âœ“ å®Œäº†');
    }

    function uncompleteTaskItem(id) {
        const t = taskList.find(x => x.id === id);
        if (t) {
            t.completed = false;
            t.completedDate = null;
        }
        saveData();
        renderTaskManager();
    }

    function deleteTaskItem(id) {
        if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        taskList = taskList.filter(t => t.id !== id);
        saveData();
        renderTaskManager();
        toast('ğŸ—‘ å‰Šé™¤');
    }
    </script>
</body>
</html>
