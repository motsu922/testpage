<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å ±å…¥åŠ›</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f0f2f5; min-height: 100vh; font-size: 16px; }
        .container { max-width: 100%; margin: 0; padding: 0; }
        .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 14px 24px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 24px; }
        .header .date { font-size: 14px; opacity: 0.9; }
        .tabs { display: flex; gap: 0; background: #fff; border-bottom: 2px solid #e0e0e0; padding: 0 15px; overflow-x: auto; }
        .tab { padding: 14px 28px; border: none; background: transparent; cursor: pointer; font-weight: 600; border-radius: 0; color: #666; font-size: 16px; border-bottom: 3px solid transparent; margin-bottom: -2px; white-space: nowrap; }
        .tab:hover { background: #f8f9fa; }
        .tab.active { background: transparent; color: #667eea; border-bottom-color: #667eea; }
        .tab-content { display: none; padding: 20px; min-height: calc(100vh - 110px); }
        .tab-content.active { display: block; }
        .tracker-layout { display: grid; grid-template-columns: 300px 1fr 360px; gap: 20px; height: calc(100vh - 150px); }
        .tracker-sidebar { background: #fff; padding: 18px; overflow-y: auto; }
        .tracker-sidebar h4 { font-size: 16px; color: #888; margin-bottom: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        .tracker-center { display: flex; flex-direction: column; gap: 16px; overflow-y: auto; }
        .tracker-right { background: #fff; padding: 18px; overflow-y: auto; }
        .tracker-right h4 { font-size: 16px; color: #333; margin-bottom: 14px; font-weight: 700; }
        .card { background: white; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .card h3 { font-size: 18px; margin-bottom: 16px; color: #333; }

        .member-list-item { padding: 14px 16px; cursor: pointer; font-weight: 600; font-size: 13px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; transition: all 0.15s; border: 2px solid #e9ecef; }
        .member-list-item:hover { background: #f0f2f5; border-color: #667eea; }
        .member-list-item.active { background: #667eea; color: white; border-color: #667eea; }
        .member-list-item .member-info { flex: 1; min-width: 0; }
        .member-list-item .member-name { display: block; font-size: 24px; font-weight: 700; }
        .member-list-item .member-task { font-size: 18px; margin-top: 6px; color: #10b981; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .member-list-item .member-task.idle { color: #999; }
        .member-list-item.active .member-task { color: rgba(255,255,255,0.9); }
        .member-list-item.active .member-task.idle { color: rgba(255,255,255,0.6); }
        .member-list-item .status { width: 24px; height: 24px; border-radius: 50%; flex-shrink: 0; margin-left: 12px; }
        .member-list-item .status.running { background: #10b981; animation: pulse 1.5s infinite; box-shadow: 0 0 16px #10b981; }
        .member-list-item .status.idle { background: #d1d5db; }
        .member-list-item.active .status.idle { background: rgba(255,255,255,0.5); }
        .member-list-item .status.alarm { background: #dc2626; box-shadow: 0 0 16px #dc2626; animation: alarm-blink 0.8s infinite; }
        
        @keyframes alarm-blink { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(0.9); } }
        @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.4;} }

        .timer-bar { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 16px 24px; display: none; align-items: center; justify-content: space-between; }
        .timer-bar.show { display: flex; }
        .timer-bar .task-name { font-weight: 700; font-size: 22px; }
        .timer-bar .time { font-size: 36px; font-weight: 700; font-family: monospace; margin-left: 20px; }
        .timer-bar .stop-btn { padding: 12px 28px; background: rgba(255,255,255,0.2); border: 2px solid white; color: white; cursor: pointer; font-weight: 600; font-size: 16px; }
        .timer-bar .stop-btn:hover { background: white; color: #10b981; }

        .task-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .task-btn { padding: 16px 8px; border: 2px solid #e0e0e0; background: white; cursor: pointer; text-align: center; font-weight: 600; font-size: 18px; transition: all 0.15s; }
        .task-btn:hover { border-color: #667eea; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .task-btn.active { background: #10b981; border-color: #10b981; color: white; }
        .task-btn .icon { font-size: 30px; margin-bottom: 6px; }
        .task-btn .elapsed { font-size: 13px; margin-top: 4px; opacity: 0.8; font-family: monospace; }
        .add-task-btn { padding: 16px 8px; border: 2px dashed #667eea; background: #f8f9ff; cursor: pointer; text-align: center; font-weight: 600; font-size: 18px; color: #667eea; }
        .add-task-btn:hover { background: #667eea; color: white; }

        .record-item { display: flex; align-items: center; padding: 14px; background: #f8f9fa; margin-bottom: 8px; cursor: pointer; }
        .record-item:hover { background: #e9ecef; }
        .record-item .color-bar { width: 4px; height: 40px; margin-right: 14px; }
        .record-item .info { flex: 1; }
        .record-item .task-name { font-weight: 600; font-size: 16px; }
        .record-item .time-range { font-size: 14px; color: #666; margin-top: 4px; }
        .record-item .duration { font-weight: 700; font-size: 18px; }

        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px; }
        .summary-item { background: #f8f9fa; padding: 14px; text-align: center; }
        .summary-item .label { font-size: 13px; color: #666; }
        .summary-item .value { font-size: 24px; font-weight: 700; margin-top: 4px; }
        .summary-item.total { background: #667eea; }
        .summary-item.total .label, .summary-item.total .value { color: white; }

        .date-nav { display: flex; align-items: center; gap: 12px; margin-bottom: 18px; flex-wrap: wrap; }
        .date-nav button { padding: 10px 16px; border: 2px solid #667eea; background: white; color: #667eea; cursor: pointer; font-weight: 600; font-size: 15px; }
        .date-nav button:hover { background: #667eea; color: white; }
        .date-nav input { padding: 10px; border: 2px solid #ddd; font-size: 15px; }

        .setting-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: #f8f9fa; margin-bottom: 8px; font-size: 16px; }
        .form-row { display: flex; gap: 12px; margin-top: 12px; }
        .form-row input { flex: 1; padding: 12px; border: 2px solid #ddd; font-size: 15px; }
        .btn { padding: 12px 20px; border: none; cursor: pointer; font-weight: 600; font-size: 15px; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a6fd6; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-success { background: #10b981; color: white; }
        .btn-sm { padding: 8px 14px; font-size: 13px; }
        .btn-xs { padding: 4px 8px; font-size: 12px; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; overflow-y: auto; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 28px; max-width: 450px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-content.wide { max-width: 1200px; }
        .modal-content h3 { margin-bottom: 22px; font-size: 20px; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 15px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #ddd; font-size: 15px; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #667eea; outline: none; }
        .modal-footer { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }

        .sync-status { font-size: 14px; padding: 6px 14px; }
        .sync-status.connected { background: #d1fae5; color: #059669; }
        .sync-status.disconnected { background: #fee2e2; color: #dc2626; }
        .sync-status.syncing { background: #fef3c7; color: #d97706; }

        .toast { position: fixed; bottom: 24px; right: 24px; background: #333; color: white; padding: 14px 24px; font-weight: 500; font-size: 15px; z-index: 2000; }

        /* ã‚¿ã‚¹ã‚¯ç®¡ç† */
        .task-manager-item { display:grid; grid-template-columns:2fr 160px 120px 1fr auto; gap:12px; padding:16px; background:#f8f9fa; margin-bottom:10px; align-items:center; font-size:16px; }
        .task-manager-item.completed { opacity:0.5; }
        .task-manager-item.completed .tm-name { text-decoration:line-through; }
        .task-manager-item.overdue { border-left:4px solid #ef4444; background:#fef2f2; }
        .task-manager-item.warning { border-left:4px solid #f59e0b; background:#fffbeb; }
        .tm-name { font-weight:600; font-size:16px; }
        .tm-progress-container { display:flex; align-items:center; gap:8px; }
        .tm-progress { width:60px; padding:8px; border:2px solid #ddd; text-align:center; font-size:15px; }
        .tm-gauge { flex:1; height:22px; background:#e9ecef; overflow:hidden; position:relative; min-width:70px; }
        .tm-gauge-fill { height:100%; transition:width 0.3s, background 0.3s; }
        .tm-gauge-fill.low { background: linear-gradient(90deg, #ef4444, #f87171); }
        .tm-gauge-fill.mid { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .tm-gauge-fill.high { background: linear-gradient(90deg, #10b981, #34d399); }
        .tm-gauge-text { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:12px; font-weight:700; color:#333; text-shadow: 0 0 2px white, 0 0 2px white; }
        .tm-deadline { width:130px; padding:8px; border:2px solid #ddd; font-size:15px; }

        .task-alert { padding:16px; margin-bottom:14px; }
        .task-alert.danger { background:#fef2f2; border-left:5px solid #ef4444; }
        .task-alert.warning { background:#fffbeb; border-left:5px solid #f59e0b; }
        .task-alert h4 { font-size:16px; margin-bottom:8px; }
        .task-alert.danger h4 { color:#dc2626; }
        .task-alert.warning h4 { color:#d97706; }
        .task-alert-item { font-size:14px; padding:4px 0; }

        /* å±¥æ­´ã‚°ãƒ©ãƒ• */
        .chart-container { margin-bottom:24px; }
        .chart-member { margin-bottom:24px; padding:18px; background:#f8f9fa; }
        .chart-member-name { font-weight:700; font-size:18px; margin-bottom:14px; color:#333; display:flex; align-items:center; gap:10px; }
        .chart-member-total { font-size:15px; color:#666; font-weight:500; }
        .chart-bar-row { display:flex; align-items:center; margin-bottom:10px; }
        .chart-bar-label { width:120px; font-size:15px; font-weight:600; color:#555; flex-shrink:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .chart-bar-container { flex:1; height:28px; background:#e9ecef; overflow:hidden; position:relative; }
        .chart-bar { height:100%; display:flex; align-items:center; justify-content:flex-end; padding-right:10px; color:white; font-size:14px; font-weight:600; min-width:35px; transition:width 0.3s; }
        .chart-bar-value { margin-left:12px; font-size:15px; font-weight:600; color:#333; width:60px; text-align:right; }
        .chart-legend { display:flex; flex-wrap:wrap; gap:14px; margin-bottom:18px; padding:12px; background:#fff; }
        .chart-legend-item { display:flex; align-items:center; gap:8px; font-size:15px; cursor:pointer; padding:6px 10px; transition:background 0.2s; }
        .chart-legend-item:hover { background:#f0f0f0; }
        .chart-legend-color { width:16px; height:16px; }

        /* ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ */
        .gantt-card { margin-top: 0; }
        .gantt-container { overflow-x:auto; border:1px solid #e9ecef; background:#fff; max-height: 500px; overflow-y: auto; }
        .gantt-header { display:flex; border-bottom:1px solid #e9ecef; background:#f8f9fa; position:sticky; top:0; z-index:10; }
        .gantt-time-label { width:50px; flex-shrink:0; padding:8px 2px; text-align:center; font-size:11px; font-weight:600; color:#666; border-right:1px solid #e9ecef; }
        .gantt-time-label.current { background:#667eea; color:white; }
        .gantt-member-col { width:90px; flex-shrink:0; padding:10px 6px; font-weight:600; font-size:16px; background:#f8f9fa; border-right:1px solid #e9ecef; position:sticky; left:0; z-index:5; }
        .gantt-body { min-height:80px; }
        .gantt-row { display:flex; border-bottom:1px solid #f0f0f0; min-height:120px; }
        .gantt-row:hover { background:#f8f9ff; }
        .gantt-row .gantt-member-col { display:flex; align-items:center; gap:4px; }
        .gantt-row .gantt-member-col .status-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
        .gantt-row .gantt-member-col .status-dot.active { background:#10b981; animation:pulse 1.5s infinite; }
        .gantt-row .gantt-member-col .status-dot.idle { background:#d1d5db; }
        .gantt-row .gantt-member-col .member-name-text { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .gantt-cell { width:50px; flex-shrink:0; border-right:1px solid #f0f0f0; position:relative; }
        .gantt-cell.current { background:rgba(102,126,234,0.08); }
        .gantt-bar { position:absolute; top:8px; bottom:8px; display:flex; align-items:center; padding:0 8px; font-size:20px; font-weight:700; color:white; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; box-shadow:0 2px 4px rgba(0,0,0,0.2); z-index:2; cursor:pointer; transition: opacity 0.2s, filter 0.2s; }
        .gantt-bar:hover { filter: brightness(1.1); }
        .gantt-bar.active { animation:ganttPulse 2s infinite; }
        .gantt-bar.filtered-out { opacity: 0.15; }
        .gantt-bar .bar-icon { margin-right:4px; font-size:14px; }
        @keyframes ganttPulse { 0%,100%{box-shadow:0 1px 2px rgba(0,0,0,0.2);} 50%{box-shadow:0 0 8px rgba(102,126,234,0.6);} }
        .gantt-now-line { position:absolute; top:0; bottom:0; width:2px; background:#ef4444; z-index:3; }

        /* å††ã‚°ãƒ©ãƒ• */
        .pie-chart-container { display:flex; justify-content:center; }
        .pie-chart { width:280px; height:280px; border-radius:50%; position:relative; }
        .pie-chart-center { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:120px; height:120px; background:white; border-radius:50%; display:flex; flex-direction:column; align-items:center; justify-content:center; box-shadow:0 0 10px rgba(0,0,0,0.1); }
        .pie-chart-center .total-hours { font-size:32px; font-weight:700; color:#333; }
        .pie-chart-center .total-label { font-size:14px; color:#888; }
        .pie-label { position:absolute; font-size:11px; font-weight:700; color:#333; pointer-events:none; white-space:nowrap; background: rgba(255,255,255,0.95); border: 1px solid #777; padding: 4px 6px; box-shadow: 0 0 2px rgba(0,0,0,0.3); }

        /* ã‚¢ã‚¤ã‚³ãƒ³é¸æŠ */
        .icon-option { width:36px; height:36px; border:2px solid #e0e0e0; cursor:pointer; font-size:18px; display:flex; align-items:center; justify-content:center; transition:all 0.15s; }
        .icon-option:hover { border-color:#667eea; transform:scale(1.1); }
        .icon-option.selected { border-color:#667eea; background:#667eea; }

        /* å‰æ—¥æœªå®Œäº†ã‚¢ãƒ©ãƒ¼ãƒˆ */
        .pending-alert { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 15px; margin-bottom: 15px; }
        .pending-alert h4 { font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .pending-item { background: rgba(255,255,255,0.2); padding: 10px 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .pending-item:last-child { margin-bottom: 0; }
        .pending-item-info { flex: 1; }
        .pending-item-info .name { font-weight: 700; font-size: 13px; }
        .pending-item-info .detail { font-size: 11px; opacity: 0.9; margin-top: 2px; }
        .pending-actions { display: flex; gap: 6px; }
        .pending-actions button { padding: 6px 12px; border: none; cursor: pointer; font-weight: 600; font-size: 11px; }
        .pending-actions .btn-complete { background: white; color: #d97706; }
        .pending-actions .btn-discard { background: rgba(0,0,0,0.2); color: white; }

        /* åŒæœŸç«¶åˆè­¦å‘Š */
        .conflict-banner { background: #fef3c7; border-bottom: 2px solid #f59e0b; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; }
        .conflict-banner.hidden { display: none; }
        .conflict-banner .message { color: #92400e; font-weight: 600; }
        .conflict-banner button { padding: 8px 16px; background: #f59e0b; color: white; border: none; cursor: pointer; font-weight: 600; }

        /* ===== ä¸å…·åˆå¯¾å¿œã‚¹ã‚¿ã‚¤ãƒ« ===== */
        .case-list { display: flex; flex-direction: column; gap: 12px; }
        .case-item { display: flex; align-items: center; padding: 16px; background: #f8f9fa; border-left: 4px solid #ddd; cursor: pointer; transition: all 0.15s; }
        .case-item:hover { background: #e9ecef; transform: translateX(4px); }
        .case-item.status-planning { border-left-color: #f59e0b; }
        .case-item.status-in-progress { border-left-color: #3b82f6; }
        .case-item.status-completed { border-left-color: #10b981; }
        .case-item .case-status-icon { font-size: 24px; margin-right: 16px; }
        .case-item .case-info { flex: 1; }
        .case-item .case-id { font-size: 13px; color: #666; }
        .case-item .case-title { font-size: 16px; font-weight: 600; margin-top: 4px; }
        .case-item .case-meta { font-size: 13px; color: #888; margin-top: 4px; }
        .case-item .case-progress { text-align: right; }
        .case-item .case-progress .progress-text { font-size: 14px; font-weight: 600; }
        .case-item .case-progress .progress-bar { width: 100px; height: 6px; background: #e0e0e0; margin-top: 6px; }
        .case-item .case-progress .progress-bar-fill { height: 100%; background: #10b981; }

        .case-filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .case-filters .filter-btn { padding: 8px 16px; border: 2px solid #ddd; background: white; cursor: pointer; font-weight: 600; font-size: 14px; }
        .case-filters .filter-btn:hover { border-color: #667eea; }
        .case-filters .filter-btn.active { background: #667eea; color: white; border-color: #667eea; }

        .case-detail-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #e0e0e0; flex-wrap: wrap; gap: 10px; }
        .case-detail-header .case-title-area h2 { font-size: 22px; margin-bottom: 8px; }
        .case-detail-header .case-title-area .case-meta { color: #666; font-size: 14px; }

        .case-info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px; }
        .case-info-item { padding: 12px; background: #f8f9fa; }
        .case-info-item .label { font-size: 12px; color: #666; margin-bottom: 4px; }
        .case-info-item .value { font-size: 15px; font-weight: 600; }

        .photo-gallery { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .photo-item { width: 120px; height: 120px; position: relative; border: 2px solid #ddd; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; }
        .photo-item .delete-photo { position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: #ef4444; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 14px; line-height: 1; }
        .photo-upload-btn { width: 120px; height: 120px; border: 2px dashed #667eea; background: #f8f9ff; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: #667eea; font-size: 13px; font-weight: 600; }
        .photo-upload-btn:hover { background: #667eea; color: white; }

        /* é¸åˆ¥å®Ÿç¸¾ãƒ†ãƒ¼ãƒ–ãƒ« */
        .selection-table-container { overflow-x: auto; margin-top: 20px; }
        .selection-table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 1200px; }
        .selection-table th, .selection-table td { padding: 10px 8px; border: 1px solid #ddd; text-align: left; }
        .selection-table th { background: #f8f9fa; font-weight: 600; white-space: nowrap; }
        .selection-table td input, .selection-table td select { width: 100%; padding: 6px; border: 1px solid #ddd; font-size: 13px; }
        .selection-table td input:focus, .selection-table td select:focus { border-color: #667eea; outline: none; }
        .selection-table td.num-cell input { text-align: right; }
        .selection-table .action-cell { white-space: nowrap; }
        .selection-table tfoot td { background: #f8f9fa; font-weight: 600; }

        /* å®Ÿç¸¾å…¥åŠ›æ¬„ï¼ˆå¤§ãããƒ»å…¥åŠ›ã—ã‚„ã™ãï¼‰ */
        .result-input { width: 65px !important; padding: 10px 4px !important; font-size: 18px !important; font-weight: 700 !important; text-align: center !important; border: 2px solid #ddd !important; }
        .result-input:focus { border-color: #667eea !important; background: #f8f9ff; }
        .result-input.ok-input { background: #ecfdf5; color: #059669; }
        .result-input.ng-input { background: #fef2f2; color: #dc2626; }
        .result-input.ng-input:focus { border-color: #dc2626 !important; }
        .result-input.remaining-input { background: #fffbeb; color: #d97706; }
        .result-input:disabled { background: #f3f4f6 !important; color: #6b7280 !important; cursor: not-allowed; }
        .quick-complete-btn { padding: 8px 6px; background: #10b981; color: white; border: none; cursor: pointer; font-size: 11px; font-weight: 600; white-space: nowrap; margin-top: 4px; width: 100%; }
        .quick-complete-btn:hover { background: #059669; }
        .quick-complete-btn.done { background: #6b7280; }
        .result-cell { text-align: center; }
        .result-hint { font-size: 10px; color: #888; margin-top: 2px; }

        .add-row-btn { margin-top: 10px; padding: 10px 20px; border: 2px dashed #667eea; background: #f8f9ff; color: #667eea; cursor: pointer; font-weight: 600; width: 100%; }
        .add-row-btn:hover { background: #667eea; color: white; }

        .location-input-group { display: flex; gap: 4px; }
        .location-input-group select { flex: 1; }
        .location-input-group input { flex: 1; display: none; }
        .location-input-group.other input { display: block; }
        .location-input-group.other select { width: 80px; flex: none; }

        /* å†™çœŸãƒ¢ãƒ¼ãƒ€ãƒ« */
        .photo-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; }
        .photo-modal.show { display: flex; }
        .photo-modal img { max-width: 90%; max-height: 90%; object-fit: contain; }
        .photo-modal .close-btn { position: absolute; top: 20px; right: 20px; color: white; font-size: 40px; cursor: pointer; background: none; border: none; }

        /* ã‚¹ãƒãƒ›å¯¾å¿œ */
        @media (max-width: 768px) {
            .container { padding: 0; }
            .header { padding: 10px 15px; }
            .header h1 { font-size: 16px; }
            .tabs { padding: 0 10px; }
            .tab { padding: 10px 16px; font-size: 13px; }
            .tracker-layout { display: block; height: auto; padding: 10px; }
            .tracker-sidebar { display: none; }
            .tracker-center { gap: 10px; }
            .tracker-right { margin-top: 15px; }
            .task-buttons { grid-template-columns: repeat(3, 1fr); gap: 8px; }
            .task-btn { padding: 14px 8px; font-size: 11px; }
            .task-btn .icon { font-size: 20px; margin-bottom: 4px; }
            .timer-bar { flex-direction: column; gap: 10px; text-align: center; padding: 12px; }
            .timer-bar .time { font-size: 24px; margin-left: 0; }
            .summary-grid { grid-template-columns: repeat(2, 1fr); }
            .card { padding: 12px; }
            .gantt-card { display: none; }
            .mobile-member-select { display: block; margin-bottom: 10px; }
            .mobile-member-select select { width: 100%; padding: 10px; border: 2px solid #667eea; font-size: 14px; font-weight: 600; }
            .case-item { flex-direction: column; align-items: flex-start; }
            .case-item .case-progress { margin-top: 10px; text-align: left; }
            .task-manager-item { grid-template-columns: 1fr; gap: 8px; }
            .modal-content { padding: 16px; }
            .modal-content.wide { width: 98%; }
            .case-detail-header { flex-direction: column; }
        }
        @media (min-width: 769px) {
            .mobile-member-select { display: none; }
        }
    </style>
</head>
<body>
<div class="container">
    <div id="conflictBanner" class="conflict-banner hidden">
        <span class="message">âš ï¸ ä»–ã®ç«¯æœ«ã§æ›´æ–°ãŒã‚ã‚Šã¾ã—ãŸã€‚æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚</span>
        <button onclick="forceReload()">æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—</button>
    </div>

    <div class="header">
        <div>
            <h1>â±ï¸ æ—¥å ±å…¥åŠ›</h1>
            <div id="todayDate" style="font-size:13px;opacity:0.9;margin-top:4px;"></div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;">
            <span id="versionDisplay" style="font-size:11px;opacity:0.7;"></span>
            <div class="sync-status disconnected" id="syncStatus">æœªæ¥ç¶š</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" data-tab="tracker">ãƒˆãƒ©ãƒƒã‚«ãƒ¼</button>
        <button class="tab" data-tab="defects">ä¸å…·åˆå¯¾å¿œ</button>
        <button class="tab" data-tab="taskmanager">ã‚¿ã‚¹ã‚¯ç®¡ç†</button>
        <button class="tab" data-tab="history">å±¥æ­´</button>
        <button class="tab" data-tab="settings">è¨­å®š</button>
    </div>

    <!-- ãƒˆãƒ©ãƒƒã‚«ãƒ¼ -->
    <div id="tracker" class="tab-content active">
        <div class="tracker-layout">
            <div class="tracker-sidebar">
                <h4>ğŸ‘¥ æ‹…å½“è€…</h4>
                <div id="memberList2"></div>
            </div>
            <div class="tracker-center">
                <div class="mobile-member-select">
                    <select id="mobileMemberSelect" onchange="setCurrentMember(this.value)"></select>
                </div>
                <div id="pendingTasksAlert"></div>
                <div class="timer-bar" id="timerBar">
                    <div style="display:flex;align-items:center;">
                        <span class="task-name" id="timerTaskName">-</span>
                        <span class="time" id="timerTime">00:00</span>
                    </div>
                    <button class="stop-btn" onclick="stopTimer()">â¹ åœæ­¢</button>
                </div>
                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <h3 style="margin:0;">ğŸ“‹ ã‚¿ã‚¹ã‚¯ <span id="currentMemberName" style="color:#667eea;"></span></h3>
                        <div style="display:flex;gap:6px;">
                            <button class="btn btn-secondary btn-sm" onclick="manualSave()">ğŸ’¾ ä¿å­˜</button>
                            <button class="btn btn-danger btn-sm" onclick="endWorkToday()">æ¥­å‹™çµ‚äº†</button>
                        </div>
                    </div>
                    <div class="task-buttons" id="taskButtons"></div>
                </div>
                <div class="card gantt-card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:8px;">
                        <h3 style="margin:0;">ğŸ“Š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çŠ¶æ³</h3>
                        <div style="display:flex;align-items:center;gap:6px;font-size:12px;">
                            <button class="btn btn-secondary btn-sm" onclick="changeGanttDate(-1)">â† å‰æ—¥</button>
                            <input type="date" id="ganttDate" onchange="onGanttDateChange(this.value)" style="padding:4px 6px;border:1px solid #ddd;font-size:12px;">
                            <button class="btn btn-secondary btn-sm" onclick="changeGanttDate(1)">ç¿Œæ—¥ â†’</button>
                            <button class="btn btn-primary btn-sm" onclick="goGanttToday()">ä»Šæ—¥</button>
                            <span id="ganttCurrentTime" style="font-size:12px;font-weight:700;color:#667eea;"></span>
                        </div>
                    </div>
                    <div id="ganttFilterBadge"></div>
                    <div id="ganttLegend" class="chart-legend" style="margin-bottom:10px;"></div>
                    <div class="gantt-container" id="ganttContainer">
                        <div class="gantt-header" id="ganttHeader"></div>
                        <div class="gantt-body" id="ganttBody"></div>
                    </div>
                </div>
            </div>
            <div class="tracker-right">
                <h4>ğŸ“Š æœ¬æ—¥ã®è¨˜éŒ²</h4>
                <div id="todayPieChart" style="margin-bottom:15px;"></div>
                <div class="summary-grid" id="todaySummary"></div>
                <div id="todayRecords" style="max-height:calc(100vh - 450px);overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <!-- ä¸å…·åˆå¯¾å¿œ -->
    <div id="defects" class="tab-content">
        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h3 style="margin:0;">ğŸ”§ ä¸å…·åˆå¯¾å¿œ</h3>
                <button class="btn btn-primary" onclick="openNewCaseModal()">ï¼‹ æ–°è¦ç™»éŒ²</button>
            </div>
            <div class="case-filters">
                <button class="filter-btn active" data-filter="all" onclick="filterCases('all')">ã™ã¹ã¦</button>
                <button class="filter-btn" data-filter="planning" onclick="filterCases('planning')">ğŸŸ¡ è¨ˆç”»ä¸­</button>
                <button class="filter-btn" data-filter="in-progress" onclick="filterCases('in-progress')">ğŸ”µ é¸åˆ¥ä¸­</button>
                <button class="filter-btn" data-filter="completed" onclick="filterCases('completed')">ğŸŸ¢ å®Œäº†</button>
            </div>
            <div class="case-list" id="caseList"></div>
        </div>
    </div>

    <!-- å±¥æ­´ -->
    <div id="history" class="tab-content">
        <div class="card">
            <h3>ğŸ“Š å±¥æ­´ãƒ»é›†è¨ˆ</h3>
            <div class="date-nav" style="margin-bottom:15px;">
                <button onclick="changeDate(-1)">â† å‰æ—¥</button>
                <input type="date" id="historyDate" onchange="renderHistory()">
                <button onclick="changeDate(1)">ç¿Œæ—¥ â†’</button>
                <button onclick="goToday()">ä»Šæ—¥</button>
            </div>
            <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;align-items:center;">
                <label style="font-size:13px;font-weight:600;">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</label>
                <select id="filterMember" onchange="renderHistory()" style="padding:8px;border:2px solid #ddd;"></select>
                <select id="filterTask" onchange="renderHistory()" style="padding:8px;border:2px solid #ddd;"></select>
            </div>
            <div id="historyChart"></div>
            <div class="summary-grid" id="historySummary" style="margin-top:20px;"></div>
            <div id="historyRecords" style="margin-top:15px;"></div>
        </div>
    </div>

    <!-- ã‚¿ã‚¹ã‚¯ç®¡ç† -->
    <div id="taskmanager" class="tab-content">
        <div class="card">
            <h3>ğŸ“‹ ã‚¿ã‚¹ã‚¯ç®¡ç†</h3>
            <div id="taskAlerts"></div>
            <div style="display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:8px;margin-bottom:15px;">
                <input type="text" id="newTaskName" placeholder="ã‚¿ã‚¹ã‚¯å">
                <input type="date" id="newTaskDeadline">
                <select id="newTaskAssignee"></select>
                <button class="btn btn-primary" onclick="addTaskItem()">è¿½åŠ </button>
            </div>
            <div style="margin-bottom:10px;">
                <label style="font-size:12px;color:#666;">
                    <input type="checkbox" id="hideCompletedTasks" onchange="renderTaskManager()"> å®Œäº†æ¸ˆã¿ã‚’éè¡¨ç¤º
                </label>
            </div>
            <div id="taskManagerList"></div>
        </div>
    </div>

    <!-- è¨­å®š -->
    <div id="settings" class="tab-content">
        <div class="card">
            <h3>ğŸ‘¥ æ‹…å½“è€…</h3>
            <div id="memberList"></div>
            <div class="form-row">
                <input type="text" id="newMember" placeholder="æ‹…å½“è€…å">
                <button class="btn btn-primary" onclick="addMember()">è¿½åŠ </button>
            </div>
        </div>
        <div class="card">
            <h3>ğŸ·ï¸ ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¹ã‚¯</h3>
            <p style="font-size:12px;color:#666;margin-bottom:10px;">æ‹…å½“è€…ã”ã¨ã«è¿½åŠ ãƒœã‚¿ãƒ³ã‚’è¨­å®š</p>
            <div class="form-group">
                <label>æ‹…å½“è€…</label>
                <select id="customTaskMember" onchange="renderCustomTasks()"></select>
            </div>
            <div id="customTaskList"></div>
            <div class="form-row">
                <input type="text" id="newCustomTask" placeholder="ã‚¿ã‚¹ã‚¯å">
                <button class="btn btn-primary" onclick="addCustomTask()">è¿½åŠ </button>
            </div>
        </div>
        <div class="card">
            <h3>â¸ï¸ ä¼‘æ†©è¨­å®š</h3>
            <p style="font-size:12px;color:#666;margin-bottom:10px;">ã“ã“ã§è¨­å®šã—ãŸæ™‚é–“å¸¯ã¯ã€Œä¼‘æ†©ã€ã¨ã—ã¦æ‰±ã„ã€æœªå…¥åŠ›åˆ¤å®šã®å¯¾è±¡ã‹ã‚‰é™¤å¤–ã—ã¾ã™ã€‚</p>
            <div id="breakList"></div>
            <div class="form-row">
                <input type="time" id="newBreakStart" value="12:00">
                <input type="time" id="newBreakEnd" value="13:00">
                <button class="btn btn-primary" onclick="addBreak()">è¿½åŠ </button>
            </div>
        </div>
        <div class="card">
            <h3>â˜ï¸ Firebase</h3>
            <textarea id="firebaseConfig" style="width:100%;height:70px;font-family:monospace;font-size:10px;padding:8px;border:2px solid #ddd;margin-bottom:10px;">{"apiKey":"AIzaSyAwZQMhF5qIv1XSADce2JiN_qAV88TxEQ8","projectId":"qcnippo"}</textarea>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn btn-primary" onclick="connectFB()">æ¥ç¶š / å†æ¥ç¶š</button>
                <button class="btn btn-secondary" onclick="forcePushToServer()">å¼·åˆ¶ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
            </div>
        </div>
        <div class="card">
            <h3>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn btn-primary" onclick="exportData()">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                <button class="btn btn-secondary" onclick="importData()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                <button class="btn btn-danger" onclick="clearData()">å…¨å‰Šé™¤</button>
            </div>
        </div>
    </div>
</div>

<!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <h3>è¨˜éŒ²ã‚’ç·¨é›†</h3>
        <div class="form-group"><label>ã‚¿ã‚¹ã‚¯å</label><input type="text" id="editTaskName"></div>
        <div class="form-group"><label>é–‹å§‹</label><input type="time" id="editStart"></div>
        <div class="form-group"><label>çµ‚äº†</label><input type="time" id="editEnd"></div>
        <div class="modal-footer">
            <button class="btn btn-danger" onclick="deleteRecord()">å‰Šé™¤</button>
            <button class="btn btn-secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn btn-primary" onclick="saveRecord()">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="addModal" class="modal">
    <div class="modal-content">
        <h3>è¨˜éŒ²ã‚’è¿½åŠ </h3>
        <div class="form-group"><label>ã‚¿ã‚¹ã‚¯</label><select id="addTaskName"></select></div>
        <div class="form-group"><label>é–‹å§‹</label><input type="time" id="addStart"></div>
        <div class="form-group"><label>çµ‚äº†</label><input type="time" id="addEnd"></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAddModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn btn-primary" onclick="addRecord()">è¿½åŠ </button>
        </div>
    </div>
</div>

<!-- ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="taskModal" class="modal">
    <div class="modal-content">
        <h3>ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </h3>
        <div class="form-group"><label>ã‚¿ã‚¹ã‚¯å</label><input type="text" id="modalTaskName"></div>
        <div class="form-group"><label>ã‚¢ã‚¤ã‚³ãƒ³</label><div id="iconSelector" style="display:flex;flex-wrap:wrap;gap:8px;"></div></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeTaskModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn btn-primary" onclick="saveNewTask()">è¿½åŠ </button>
        </div>
    </div>
</div>

<!-- æ–°è¦æ¡ˆä»¶ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="newCaseModal" class="modal">
    <div class="modal-content">
        <h3>ğŸ”§ æ–°è¦ä¸å…·åˆç™»éŒ²</h3>
        <div class="form-group"><label>ç™ºç”Ÿæ—¥ *</label><input type="date" id="caseDate"></div>
        <div class="form-group"><label>ã‚¿ã‚¤ãƒˆãƒ« *</label><input type="text" id="caseTitle" placeholder="ä¾‹: â—‹â—‹éƒ¨å“ å¯¸æ³•ä¸è‰¯"></div>
        <div class="form-group"><label>å†…å®¹è©³ç´°</label><textarea id="caseDescription" rows="4" placeholder="ä¸å…·åˆã®è©³ç´°å†…å®¹ã‚’å…¥åŠ›..."></textarea></div>
        <div class="form-group">
            <label>ä¸å…·åˆå†™çœŸ</label>
            <div class="photo-gallery" id="newCasePhotos"></div>
            <input type="file" id="photoInput" accept="image/*" multiple style="display:none;" onchange="handlePhotoUpload(event)">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeNewCaseModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn btn-primary" onclick="saveNewCase()">ç™»éŒ²</button>
        </div>
    </div>
</div>

<!-- æ¡ˆä»¶è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="caseDetailModal" class="modal">
    <div class="modal-content wide" id="caseDetailContent"></div>
</div>

<!-- å†™çœŸæ‹¡å¤§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="photoModal" class="photo-modal" onclick="closePhotoModal()">
    <button class="close-btn" onclick="closePhotoModal()">&times;</button>
    <img id="photoModalImg" src="" alt="">
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
const DEFAULT_TASKS = ['æœç¤¼','æ‰“åˆã›','ä¸å…·åˆå¯¾å¿œ','ç•°å¸¸å‡¦ç½®','ä¿ç•™å“å¯¾å¿œ','è³‡æ–™ä½œæˆ','ãƒ¡ãƒ¼ãƒ«','å¤–å‡º','æ¥å®¢å¯¾å¿œ','ãã®ä»–'];
const ICONS = {'æœç¤¼':'ğŸŒ…','æ‰“åˆã›':'ğŸ‘¥','ä¸å…·åˆå¯¾å¿œ':'ğŸ”§','ç•°å¸¸å‡¦ç½®':'âš ï¸','ä¿ç•™å“å¯¾å¿œ':'ğŸ“¦','è³‡æ–™ä½œæˆ':'ğŸ“','ãƒ¡ãƒ¼ãƒ«':'âœ‰ï¸','å¤–å‡º':'ğŸš—','æ¥å®¢å¯¾å¿œ':'ğŸ¤','ãã®ä»–':'ğŸ“Œ'};
const COLORS = {'æœç¤¼':'#f59e0b','æ‰“åˆã›':'#3b82f6','ä¸å…·åˆå¯¾å¿œ':'#ef4444','ç•°å¸¸å‡¦ç½®':'#dc2626','ä¿ç•™å“å¯¾å¿œ':'#8b5cf6','è³‡æ–™ä½œæˆ':'#10b981','ãƒ¡ãƒ¼ãƒ«':'#06b6d4','å¤–å‡º':'#14b8a6','æ¥å®¢å¯¾å¿œ':'#ec4899','ãã®ä»–':'#6b7280'};
const CUSTOM_COLORS = ['#f43f5e','#a855f7','#6366f1','#0ea5e9','#22c55e','#eab308','#f97316','#64748b','#78716c','#84cc16'];
const WORK_START_MIN = 8*60, WORK_END_MIN = 17*60;
const LOCATION_OPTIONS = ['ç¤¾å†…', 'å®¢å…ˆ', 'ç‰©æµå€‰åº«', 'ãã®ä»–'];

let members=['æ‹…å½“è€…1'], customTasks={}, customIcons={}, records=[], activeTimers={}, currentMember=null, editingId=null;
let breakList = [], addRecordDateStr = null;
let cases = [], newCasePhotos = [], currentCaseFilter = 'all';
let fs = null, docRef = null, fbUnsubscribe = null, fbConnected = false, fbUpdating = false;
let localVersion = 0, pendingLocalChanges = false, lastSyncTime = 0, taskList = [];
let ganttFilterTask = null, ganttDate = null;

function isAbnormalTask(task){ return task === 'ç•°å¸¸å‡¦ç½®' || task === 'ä¸å…·åˆå¯¾å¿œ'; }
function getTaskIcon(task){ return ICONS[task] || customIcons[task] || 'ğŸ“‹'; }
function getTaskColor(task){
    if (COLORS[task]) return COLORS[task];
    const allCustom = Object.values(customTasks).flat();
    const idx = allCustom.indexOf(task);
    return idx >= 0 ? CUSTOM_COLORS[idx % CUSTOM_COLORS.length] : '#667eea';
}

document.addEventListener('DOMContentLoaded', () => {
    loadData();
    document.querySelectorAll('.tab').forEach(t => t.onclick = () => {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        document.getElementById(t.dataset.tab).classList.add('active');
        render();
    });
    if (!currentMember) currentMember = members[0] || null;
    document.getElementById('todayDate').textContent = new Date().toLocaleDateString('ja-JP',{year:'numeric',month:'long',day:'numeric',weekday:'short'});
    document.getElementById('historyDate').value = formatDate(new Date());
    document.getElementById('caseDate').value = formatDate(new Date());
    ganttDate = formatDate(new Date());
    const gd = document.getElementById('ganttDate'); if (gd) gd.value = ganttDate;
    render(); updateVersionDisplay();
    setInterval(() => { updateTimerBar(); renderTaskButtons(); renderMemberTabs(); renderGantt(); }, 1000);
    autoConnectFB();
});

function loadData(){
    try{
        members = JSON.parse(localStorage.getItem('tt_members') || '["æ‹…å½“è€…1"]');
        customTasks = JSON.parse(localStorage.getItem('tt_customTasks') || '{}');
        customIcons = JSON.parse(localStorage.getItem('tt_customIcons') || '{}');
        records = JSON.parse(localStorage.getItem('tt_records') || '[]');
        activeTimers = JSON.parse(localStorage.getItem('tt_activeTimers') || '{}');
        taskList = JSON.parse(localStorage.getItem('tt_taskList') || '[]');
        breakList = JSON.parse(localStorage.getItem('tt_breakList') || '[]');
        cases = JSON.parse(localStorage.getItem('tt_cases') || '[]');
        currentMember = JSON.parse(localStorage.getItem('tt_currentMember')) || members[0] || null;
        localVersion = parseInt(localStorage.getItem('tt_version') || '0', 10) || 0;
        lastSyncTime = parseInt(localStorage.getItem('tt_lastSyncTime') || '0', 10) || 0;
    }catch(e){ console.error('loadData error:', e); }
}

function saveDataLocal(){
    localStorage.setItem('tt_members', JSON.stringify(members));
    localStorage.setItem('tt_customTasks', JSON.stringify(customTasks));
    localStorage.setItem('tt_customIcons', JSON.stringify(customIcons));
    localStorage.setItem('tt_records', JSON.stringify(records));
    localStorage.setItem('tt_activeTimers', JSON.stringify(activeTimers));
    localStorage.setItem('tt_taskList', JSON.stringify(taskList));
    localStorage.setItem('tt_breakList', JSON.stringify(breakList));
    localStorage.setItem('tt_cases', JSON.stringify(cases));
    localStorage.setItem('tt_currentMember', JSON.stringify(currentMember));
    localStorage.setItem('tt_version', String(localVersion));
    localStorage.setItem('tt_lastSyncTime', String(lastSyncTime));
}

function saveData(){
    saveDataLocal(); pendingLocalChanges = true;
    if (!fbUpdating && fbConnected) syncPushToServer();
    updateVersionDisplay();
}

function updateVersionDisplay(){ const el = document.getElementById('versionDisplay'); if (el) el.textContent = `v${localVersion}`; }

function render(){
    renderMemberTabs(); renderTaskButtons(); renderTodayRecords(); renderHistory(); renderSettings();
    updateTimerBar(); renderTaskManager(); renderGantt(); checkPendingTasks(); renderCaseList();
}

function renderMemberTabs(){
    const el = document.getElementById('memberList2');
    if (el){
        el.innerHTML = members.map(m => {
            const isActive = (currentMember === m), timer = activeTimers[m], isRunning = !!timer;
            const currentTask = timer ? timer.task : null;
            const taskInfo = isRunning ? `<div class="member-task">${getTaskIcon(currentTask)} ${currentTask}</div>` : '<div class="member-task idle">å¾…æ©Ÿä¸­</div>';
            let statusClass = 'idle';
            if (isRunning) statusClass = isAbnormalTask(currentTask) ? 'alarm' : 'running';
            return `<div class="member-list-item ${isActive?'active':''}" onclick="setCurrentMember('${m}')"><div class="member-info"><span class="member-name">${m}</span>${taskInfo}</div><span class="status ${statusClass}"></span></div>`;
        }).join('');
    }
    const mobileSelect = document.getElementById('mobileMemberSelect');
    if (mobileSelect){
        mobileSelect.innerHTML = members.map(m => {
            const timer = activeTimers[m], taskInfo = timer ? ` (${timer.task})` : '';
            return `<option value="${m}" ${m===currentMember?'selected':''}>${m}${taskInfo}</option>`;
        }).join('');
    }
    const nameEl = document.getElementById('currentMemberName');
    if (nameEl && currentMember) nameEl.textContent = `- ${currentMember}`;
}

function setCurrentMember(m){ currentMember = m; localStorage.setItem('tt_currentMember', JSON.stringify(currentMember)); render(); }

function renderTaskButtons(){
    const el = document.getElementById('taskButtons'); if (!el) return;
    if (!currentMember){ el.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#888;padding:20px;">æ‹…å½“è€…ã‚’é¸æŠ</div>'; return; }
    const timer = activeTimers[currentMember];
    const allTasks = [...DEFAULT_TASKS, ...(customTasks[currentMember] || [])];
    el.innerHTML = allTasks.map(t => {
        const active = timer && timer.task === t;
        return `<button class="task-btn ${active?'active':''}" onclick="toggleTask('${t}')"><div class="icon">${getTaskIcon(t)}</div><div>${t}</div>${active?`<div class="elapsed">${getElapsed(timer.startTime)}</div>`:''}</button>`;
    }).join('') + `<button class="add-task-btn" onclick="openTaskModal()">ï¼‹ è¿½åŠ </button>`;
}

function renderTodayRecords(){
    const today = formatDate(new Date());
    const recs = records.filter(r => r.date === today && r.member === currentMember);
    renderPieChart(recs); renderRecordList('todayRecords','todaySummary',recs,true);
}

function renderPieChart(recs){
    const pieEl = document.getElementById('todayPieChart'); if (!pieEl) return;
    if (!recs.length){ pieEl.innerHTML = '<div style="text-align:center;color:#888;font-size:12px;padding:10px;">è¨˜éŒ²ãªã—</div>'; return; }
    const totals = {}; let total = 0;
    recs.forEach(r=>{ const h = calcHours(r.startTime,r.endTime); totals[r.task] = (totals[r.task]||0)+h; total += h; });
    const sorted = Object.entries(totals).sort((a,b)=>b[1]-a[1]);
    let gradientStops = [], currentAngle = 0; const labelPositions = [], radius = 140, labelRadius = 100;
    sorted.forEach(([task,hours])=>{
        const percent = (hours/total)*100, color = getTaskColor(task);
        const startAngle = currentAngle, endAngle = currentAngle + (percent*3.6);
        gradientStops.push(`${color} ${startAngle}deg ${endAngle}deg`);
        const midAngle = (startAngle+endAngle)/2, radians = (midAngle-90)*(Math.PI/180);
        labelPositions.push({ task, hours, percent, x: radius + labelRadius*Math.cos(radians), y: radius + labelRadius*Math.sin(radians) });
        currentAngle = endAngle;
    });
    const labelsHtml = labelPositions.map(p=> p.percent<5 ? '' : `<div class="pie-label" style="left:${p.x}px;top:${p.y}px;transform:translate(-50%,-50%);">${getTaskIcon(p.task)} ${p.task}<br>${p.hours.toFixed(1)}h</div>`).join('');
    pieEl.innerHTML = `<div class="pie-chart-container"><div class="pie-chart" style="background:conic-gradient(${gradientStops.join(', ')})">${labelsHtml}<div class="pie-chart-center"><div class="total-hours">${total.toFixed(1)}h</div><div class="total-label">åˆè¨ˆ</div></div></div></div>`;
}

// ===== ä¸å…·åˆå¯¾å¿œ =====
function renderCaseList(){
    const el = document.getElementById('caseList'); if (!el) return;
    let filtered = currentCaseFilter === 'all' ? cases : cases.filter(c => c.status === currentCaseFilter);
    filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    if (!filtered.length){ el.innerHTML = '<div style="text-align:center;color:#888;padding:40px;">ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
    el.innerHTML = filtered.map(c => {
        const totalPlans = c.selectionPlans?.length || 0;
        const completedPlans = c.selectionPlans?.filter(p => p.status === 'done').length || 0;
        const progress = totalPlans > 0 ? Math.round((completedPlans / totalPlans) * 100) : 0;
        let statusIcon = 'ğŸŸ¡', statusClass = 'status-planning';
        if (c.status === 'in-progress') { statusIcon = 'ğŸ”µ'; statusClass = 'status-in-progress'; }
        else if (c.status === 'completed') { statusIcon = 'ğŸŸ¢'; statusClass = 'status-completed'; }
        return `<div class="case-item ${statusClass}" onclick="openCaseDetail(${c.id})">
            <div class="case-status-icon">${statusIcon}</div>
            <div class="case-info"><div class="case-id">#${String(c.id).slice(-4)}</div><div class="case-title">${c.title}</div><div class="case-meta">ğŸ“… ${c.date} | é¸åˆ¥å®Ÿç¸¾: ${totalPlans}ä»¶</div></div>
            <div class="case-progress"><div class="progress-text">${completedPlans}/${totalPlans}ä»¶å®Œäº†</div><div class="progress-bar"><div class="progress-bar-fill" style="width:${progress}%"></div></div></div>
        </div>`;
    }).join('');
}

function filterCases(filter){
    currentCaseFilter = filter;
    document.querySelectorAll('.case-filters .filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === filter));
    renderCaseList();
}

function openNewCaseModal(){
    newCasePhotos = [];
    document.getElementById('caseDate').value = formatDate(new Date());
    document.getElementById('caseTitle').value = '';
    document.getElementById('caseDescription').value = '';
    renderNewCasePhotos();
    document.getElementById('newCaseModal').classList.add('show');
}

function closeNewCaseModal(){ document.getElementById('newCaseModal').classList.remove('show'); }

function renderNewCasePhotos(){
    const el = document.getElementById('newCasePhotos');
    el.innerHTML = newCasePhotos.map((p, i) => `<div class="photo-item"><img src="${p}" onclick="openPhotoModal('${p}')"><button class="delete-photo" onclick="removeNewCasePhoto(${i})">&times;</button></div>`).join('') + `<div class="photo-upload-btn" onclick="document.getElementById('photoInput').click()">ğŸ“·<br>è¿½åŠ </div>`;
}

function handlePhotoUpload(e){
    Array.from(e.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (ev) => { newCasePhotos.push(ev.target.result); renderNewCasePhotos(); };
        reader.readAsDataURL(file);
    });
    e.target.value = '';
}

function removeNewCasePhoto(index){ newCasePhotos.splice(index, 1); renderNewCasePhotos(); }

function saveNewCase(){
    const date = document.getElementById('caseDate').value;
    const title = document.getElementById('caseTitle').value.trim();
    const description = document.getElementById('caseDescription').value.trim();
    if (!date || !title){ alert('ç™ºç”Ÿæ—¥ã¨ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™'); return; }
    const newCase = { id: Date.now(), date, title, description, photos: [...newCasePhotos], status: 'planning', selectionPlans: [], createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() };
    cases.push(newCase); saveData(); closeNewCaseModal(); render(); toast('âœ“ ç™»éŒ²ã—ã¾ã—ãŸ');
    setTimeout(() => openCaseDetail(newCase.id), 100);
}

function openCaseDetail(caseId){
    const c = cases.find(x => x.id === caseId); if (!c) return;
    const totalPlans = c.selectionPlans?.length || 0;
    const completedPlans = c.selectionPlans?.filter(p => p.status === 'done').length || 0;
    const totalTarget = c.selectionPlans?.reduce((sum, p) => sum + (parseInt(p.targetCount) || 0), 0) || 0;
    const totalOk = c.selectionPlans?.reduce((sum, p) => sum + (parseInt(p.okCount) || 0), 0) || 0;
    const totalNg = c.selectionPlans?.reduce((sum, p) => sum + (parseInt(p.ngCount) || 0), 0) || 0;
    const totalRemaining = c.selectionPlans?.reduce((sum, p) => sum + (parseInt(p.remainingCount) || 0), 0) || 0;

    let html = `
        <div class="case-detail-header">
            <div class="case-title-area"><h2>#${String(c.id).slice(-4)} ${c.title}</h2><div class="case-meta">ç™»éŒ²æ—¥: ${c.date} | é€²æ—: ${completedPlans}/${totalPlans}ä»¶å®Œäº†</div></div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                <select onchange="updateCaseStatus(${c.id}, this.value)" style="padding:8px 12px;border:2px solid #ddd;font-size:14px;">
                    <option value="planning" ${c.status==='planning'?'selected':''}>ğŸŸ¡ è¨ˆç”»ä¸­</option>
                    <option value="in-progress" ${c.status==='in-progress'?'selected':''}>ğŸ”µ é¸åˆ¥ä¸­</option>
                    <option value="completed" ${c.status==='completed'?'selected':''}>ğŸŸ¢ å®Œäº†</option>
                </select>
                <button class="btn btn-danger btn-sm" onclick="deleteCase(${c.id})">å‰Šé™¤</button>
                <button class="btn btn-secondary" onclick="closeCaseDetailModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
        <div class="case-info-grid">
            <div class="case-info-item"><div class="label">ç™ºç”Ÿæ—¥</div><div class="value">${c.date}</div></div>
            <div class="case-info-item"><div class="label">é¸åˆ¥å®Ÿç¸¾æ•°</div><div class="value">${totalPlans}ä»¶</div></div>
            <div class="case-info-item"><div class="label">å¯¾è±¡ç·æ•°</div><div class="value">${totalTarget.toLocaleString()}å€‹</div></div>
            <div class="case-info-item"><div class="label">å®Œäº†</div><div class="value">${completedPlans}/${totalPlans}ä»¶</div></div>
        </div>
        <div style="margin-bottom:20px;"><div style="font-weight:600;margin-bottom:8px;">ğŸ“ å†…å®¹è©³ç´°</div><div style="background:#f8f9fa;padding:12px;white-space:pre-wrap;">${c.description || 'ï¼ˆæœªå…¥åŠ›ï¼‰'}</div></div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:20px;margin-bottom:20px;">
            <div>
                <div style="font-weight:600;margin-bottom:8px;">ğŸ“· ä¸å…·åˆå†™çœŸ</div>
                <div class="photo-gallery">
                    ${(c.photos || []).map((p, i) => `<div class="photo-item"><img src="${p}" onclick="openPhotoModal('${p}')"><button class="delete-photo" onclick="removeCasePhoto(${c.id}, ${i})">&times;</button></div>`).join('')}
                    <div class="photo-upload-btn" onclick="triggerCasePhotoUpload(${c.id})">ğŸ“·<br>è¿½åŠ </div>
                </div>
                <input type="file" id="casePhotoInput_${c.id}" accept="image/*" multiple style="display:none;" onchange="handleCasePhotoUpload(event, ${c.id})">
            </div>
            <div>
                <div style="font-weight:600;margin-bottom:8px;">ğŸ“¢ é€£çµ¡äº‹é …</div>
                <textarea id="caseNotes_${c.id}" style="width:100%;height:150px;padding:12px;border:2px solid #ddd;font-size:14px;resize:vertical;" placeholder="é–¢ä¿‚è€…ã¸ã®é€£çµ¡äº‹é …ã‚’å…¥åŠ›..." onchange="updateCaseNotes(${c.id}, this.value)">${c.notes || ''}</textarea>
            </div>
        </div>
        <div>
            <div style="font-weight:600;margin-bottom:8px;">ğŸ“Š é¸åˆ¥å®Ÿç¸¾</div>
            <div class="selection-table-container">
                <table class="selection-table">
                    <thead><tr><th style="width:40px;">#</th><th style="width:100px;">å“ç•ª</th><th style="width:100px;">å ´æ‰€</th><th style="width:120px;">è©³ç´°</th><th style="width:120px;">å¯¾è±¡ä¾¿</th><th style="width:70px;">å¯¾è±¡æ•°</th><th style="width:90px;">æ‹…å½“</th><th style="width:65px;">OK</th><th style="width:65px;">NG</th><th style="width:65px;">æ®‹</th><th style="width:120px;">å‚™è€ƒ</th><th style="width:85px;">çŠ¶æ…‹</th><th style="width:50px;"></th></tr></thead>
                    <tbody>${renderSelectionPlans(c)}</tbody>
                    <tfoot><tr><td colspan="5" style="text-align:right;">åˆè¨ˆ</td><td class="num-cell">${totalTarget.toLocaleString()}</td><td></td><td class="num-cell">${totalOk.toLocaleString()}</td><td class="num-cell">${totalNg.toLocaleString()}</td><td class="num-cell">${totalRemaining.toLocaleString()}</td><td colspan="3"></td></tr></tfoot>
                </table>
            </div>
            <button class="add-row-btn" onclick="addSelectionPlan(${c.id})">ï¼‹ è¡Œã‚’è¿½åŠ </button>
        </div>`;
    document.getElementById('caseDetailContent').innerHTML = html;
    document.getElementById('caseDetailModal').classList.add('show');
}

function renderSelectionPlans(c){
    if (!c.selectionPlans || !c.selectionPlans.length) return '<tr><td colspan="13" style="text-align:center;color:#888;padding:20px;">é¸åˆ¥å®Ÿç¸¾ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œè¡Œã‚’è¿½åŠ ã€ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</td></tr>';
    return c.selectionPlans.map((p, i) => {
        const targetNum = parseInt(p.targetCount) || 0;
        const okNum = parseInt(p.okCount) || 0;
        const ngNum = parseInt(p.ngCount) || 0;
        const remainNum = parseInt(p.remainingCount) || 0;
        const isComplete = (p.status === 'done');
        const hasTarget = targetNum > 0;
        return `<tr>
            <td>${i + 1}</td>
            <td><input type="text" value="${p.partNumber || ''}" onchange="updatePlan(${c.id}, ${i}, 'partNumber', this.value)" placeholder="å“ç•ª"></td>
            <td>
                <select onchange="updatePlan(${c.id}, ${i}, 'location', this.value)" style="width:100%;">
                    <option value="">é¸æŠ</option>
                    ${LOCATION_OPTIONS.map(loc => `<option value="${loc}" ${p.location === loc ? 'selected' : ''}>${loc}</option>`).join('')}
                </select>
            </td>
            <td><input type="text" value="${p.locationDetail || ''}" onchange="updatePlan(${c.id}, ${i}, 'locationDetail', this.value)" placeholder="æ£šç•ªç­‰"></td>
            <td><div style="display:flex;gap:4px;"><input type="date" value="${p.targetDate || ''}" style="width:100px;" onchange="updatePlan(${c.id}, ${i}, 'targetDate', this.value)"><select style="width:60px;" onchange="updatePlan(${c.id}, ${i}, 'targetBin', this.value)"><option value="">ä¾¿</option>${[1,2,3,4,5].map(n => `<option value="${n}" ${p.targetBin == n ? 'selected' : ''}>${n}ä¾¿</option>`).join('')}</select></div></td>
            <td class="num-cell"><input type="number" value="${p.targetCount || ''}" onchange="updatePlan(${c.id}, ${i}, 'targetCount', this.value)" style="font-weight:700;"></td>
            <td><select onchange="updatePlan(${c.id}, ${i}, 'assignee', this.value)"><option value="">æœªå®š</option>${members.map(m => `<option value="${m}" ${p.assignee === m ? 'selected' : ''}>${m}</option>`).join('')}</select></td>
            <td class="result-cell">
                <input type="number" class="result-input ok-input" value="${p.okCount || ''}" onchange="updatePlan(${c.id}, ${i}, 'okCount', this.value)" ${isComplete ? '' : 'readonly'} title="NGæ•°å…¥åŠ›ã§è‡ªå‹•è¨ˆç®—">
                ${hasTarget ? `<div class="result-hint">è‡ªå‹•</div>` : ''}
            </td>
            <td class="result-cell">
                <input type="number" class="result-input ng-input" value="${p.ngCount || ''}" onchange="onNgInput(${c.id}, ${i}, this.value)" placeholder="0">
            </td>
            <td class="result-cell">
                <input type="number" class="result-input remaining-input" value="${p.remainingCount || ''}" onchange="onRemainingInput(${c.id}, ${i}, this.value)" placeholder="0">
                ${hasTarget ? `<button class="quick-complete-btn ${isComplete ? 'done' : ''}" onclick="quickComplete(${c.id}, ${i})" ${isComplete ? 'disabled' : ''}>${isComplete ? 'âœ“å®Œäº†' : 'å…¨å®Œ'}</button>` : ''}
            </td>
            <td><input type="text" value="${p.note || ''}" onchange="updatePlan(${c.id}, ${i}, 'note', this.value)"></td>
            <td><select onchange="updatePlan(${c.id}, ${i}, 'status', this.value)" style="font-size:12px;"><option value="pending" ${p.status === 'pending' ? 'selected' : ''}>âšªæœªç€æ‰‹</option><option value="working" ${p.status === 'working' ? 'selected' : ''}>ğŸ”µä½œæ¥­ä¸­</option><option value="done" ${p.status === 'done' ? 'selected' : ''}>âœ…å®Œäº†</option></select></td>
            <td class="action-cell"><button class="btn btn-danger btn-xs" onclick="removePlan(${c.id}, ${i})">å‰Šé™¤</button></td>
        </tr>`;
    }).join('');
}

// é€£çµ¡äº‹é …ã‚’æ›´æ–°
function updateCaseNotes(caseId, value){
    const c = cases.find(x => x.id === caseId);
    if (!c) return;
    c.notes = value;
    c.updatedAt = new Date().toISOString();
    saveData();
}

function addSelectionPlan(caseId){
    const c = cases.find(x => x.id === caseId); if (!c) return;
    if (!c.selectionPlans) c.selectionPlans = [];
    c.selectionPlans.push({ partNumber: '', location: '', locationDetail: '', targetDate: '', targetBin: '', targetCount: '', assignee: '', okCount: '', ngCount: '', remainingCount: '', note: '', status: 'pending' });
    c.updatedAt = new Date().toISOString(); saveData(); openCaseDetail(caseId);
}

function updatePlan(caseId, planIndex, field, value){
    const c = cases.find(x => x.id === caseId);
    if (!c || !c.selectionPlans || !c.selectionPlans[planIndex]) return;
    c.selectionPlans[planIndex][field] = value;
    c.updatedAt = new Date().toISOString();
    updateCaseStatusAuto(c); saveData();
}

// NGæ•°å…¥åŠ›æ™‚ï¼šOKæ•°ã‚’è‡ªå‹•è¨ˆç®—ï¼ˆç›®æ¨™æ•° - NGæ•° - æ®‹æ•°ï¼‰
function onNgInput(caseId, planIndex, value){
    const c = cases.find(x => x.id === caseId);
    if (!c || !c.selectionPlans || !c.selectionPlans[planIndex]) return;
    const p = c.selectionPlans[planIndex];
    const ngNum = parseInt(value) || 0;
    p.ngCount = ngNum;
    
    // ç›®æ¨™æ•°ãŒã‚ã‚‹å ´åˆã€OKæ•°ã‚’è‡ªå‹•è¨ˆç®—
    const targetNum = parseInt(p.targetCount) || 0;
    const remainNum = parseInt(p.remainingCount) || 0;
    if (targetNum > 0) {
        const okNum = Math.max(0, targetNum - ngNum - remainNum);
        p.okCount = okNum;
    }
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‡ªå‹•æ›´æ–°ï¼ˆæ®‹æ•°0ã§ä½œæ¥­é–‹å§‹ or å®Œäº†ï¼‰
    if (remainNum === 0 && (ngNum > 0 || (parseInt(p.okCount) || 0) > 0)) {
        p.status = 'done';
    } else if (ngNum > 0 || (parseInt(p.okCount) || 0) > 0) {
        p.status = 'working';
    }
    
    c.updatedAt = new Date().toISOString();
    updateCaseStatusAuto(c); saveData(); openCaseDetail(caseId);
}

// æ®‹æ•°å…¥åŠ›æ™‚ï¼šOKæ•°ã‚’è‡ªå‹•è¨ˆç®—
function onRemainingInput(caseId, planIndex, value){
    const c = cases.find(x => x.id === caseId);
    if (!c || !c.selectionPlans || !c.selectionPlans[planIndex]) return;
    const p = c.selectionPlans[planIndex];
    const remainNum = parseInt(value) || 0;
    p.remainingCount = remainNum;
    
    // ç›®æ¨™æ•°ãŒã‚ã‚‹å ´åˆã€OKæ•°ã‚’è‡ªå‹•è¨ˆç®—
    const targetNum = parseInt(p.targetCount) || 0;
    const ngNum = parseInt(p.ngCount) || 0;
    if (targetNum > 0) {
        const okNum = Math.max(0, targetNum - ngNum - remainNum);
        p.okCount = okNum;
    }
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‡ªå‹•æ›´æ–°
    if (remainNum === 0 && ((parseInt(p.okCount) || 0) > 0 || ngNum > 0)) {
        p.status = 'done';
    } else if ((parseInt(p.okCount) || 0) > 0 || ngNum > 0) {
        p.status = 'working';
    }
    
    c.updatedAt = new Date().toISOString();
    updateCaseStatusAuto(c); saveData(); openCaseDetail(caseId);
}

// å…¨æ•°å®Œäº†ãƒœã‚¿ãƒ³ï¼šNG=0, æ®‹æ•°=0, OK=ç›®æ¨™æ•°
function quickComplete(caseId, planIndex){
    const c = cases.find(x => x.id === caseId);
    if (!c || !c.selectionPlans || !c.selectionPlans[planIndex]) return;
    const p = c.selectionPlans[planIndex];
    const targetNum = parseInt(p.targetCount) || 0;
    if (targetNum <= 0) { alert('ç›®æ¨™æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    
    p.okCount = targetNum;
    p.ngCount = 0;
    p.remainingCount = 0;
    p.status = 'done';
    
    c.updatedAt = new Date().toISOString();
    updateCaseStatusAuto(c); saveData(); openCaseDetail(caseId);
    toast('âœ“ å…¨æ•°å®Œäº†');
}

function removePlan(caseId, planIndex){
    if (!confirm('ã“ã®è¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    const c = cases.find(x => x.id === caseId); if (!c || !c.selectionPlans) return;
    c.selectionPlans.splice(planIndex, 1);
    c.updatedAt = new Date().toISOString(); updateCaseStatusAuto(c); saveData(); openCaseDetail(caseId);
}

function updateCaseStatusAuto(c){
    if (!c.selectionPlans || c.selectionPlans.length === 0){ c.status = 'planning'; return; }
    const allDone = c.selectionPlans.every(p => p.status === 'done');
    const anyWorking = c.selectionPlans.some(p => p.status === 'working' || p.status === 'done');
    if (allDone) c.status = 'completed';
    else if (anyWorking) c.status = 'in-progress';
    else c.status = 'planning';
}

function updateCaseStatus(caseId, status){
    const c = cases.find(x => x.id === caseId); if (!c) return;
    c.status = status; c.updatedAt = new Date().toISOString(); saveData(); renderCaseList();
}

function deleteCase(caseId){
    if (!confirm('ã“ã®ä¸å…·åˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    cases = cases.filter(c => c.id !== caseId); saveData(); closeCaseDetailModal(); render(); toast('ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ');
}

function closeCaseDetailModal(){ document.getElementById('caseDetailModal').classList.remove('show'); renderCaseList(); }

function triggerCasePhotoUpload(caseId){ document.getElementById(`casePhotoInput_${caseId}`).click(); }

function handleCasePhotoUpload(e, caseId){
    const c = cases.find(x => x.id === caseId); if (!c) return;
    if (!c.photos) c.photos = [];
    Array.from(e.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (ev) => { c.photos.push(ev.target.result); c.updatedAt = new Date().toISOString(); saveData(); openCaseDetail(caseId); };
        reader.readAsDataURL(file);
    });
    e.target.value = '';
}

function removeCasePhoto(caseId, index){
    const c = cases.find(x => x.id === caseId); if (!c || !c.photos) return;
    c.photos.splice(index, 1); c.updatedAt = new Date().toISOString(); saveData(); openCaseDetail(caseId);
}

function openPhotoModal(src){ document.getElementById('photoModalImg').src = src; document.getElementById('photoModal').classList.add('show'); }
function closePhotoModal(){ document.getElementById('photoModal').classList.remove('show'); }

// ===== å±¥æ­´ =====
function renderHistory(){
    const date = document.getElementById('historyDate')?.value || formatDate(new Date());
    const filterMember = document.getElementById('filterMember')?.value || '';
    const filterTask = document.getElementById('filterTask')?.value || '';
    updateHistoryFilters(date);
    let recs = records.filter(r => r.date === date);
    if (filterMember) recs = recs.filter(r => r.member === filterMember);
    if (filterTask) recs = recs.filter(r => r.task === filterTask);
    renderHistoryChart(recs,date); renderHistorySummary(recs); renderHistoryRecords(recs,date);
}

function updateHistoryFilters(date){
    const memberSelect = document.getElementById('filterMember'), taskSelect = document.getElementById('filterTask');
    if (!memberSelect || !taskSelect) return;
    const currentMemberVal = memberSelect.value, currentTaskVal = taskSelect.value;
    memberSelect.innerHTML = '<option value="">å…¨å“¡</option>' + members.map(m=>`<option value="${m}" ${m===currentMemberVal?'selected':''}>${m}</option>`).join('');
    const dayRecs = records.filter(r=>r.date===date);
    const usedTasks = [...new Set(dayRecs.map(r=>r.task))];
    taskSelect.innerHTML = '<option value="">å…¨ã‚¿ã‚¹ã‚¯</option>' + usedTasks.map(t=>`<option value="${t}" ${t===currentTaskVal?'selected':''}>${t}</option>`).join('');
}

function renderHistoryChart(recs,date){
    const chartEl = document.getElementById('historyChart'); if (!chartEl) return;
    if (!recs.length){ chartEl.innerHTML = '<div style="text-align:center;color:#888;padding:30px;">ã“ã®æ—¥ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</div>'; return; }
    const memberData = {};
    recs.forEach(r=>{ if (!memberData[r.member]) memberData[r.member] = {}; const h = calcHours(r.startTime,r.endTime); memberData[r.member][r.task] = (memberData[r.member][r.task]||0)+h; });
    const allTasks = [...new Set(recs.map(r=>r.task))];
    let maxHours = 0; Object.values(memberData).forEach(tasks=>{ const total = Object.values(tasks).reduce((a,b)=>a+b,0); if (total>maxHours) maxHours=total; }); if (maxHours===0) maxHours=8;
    let html = '<div class="chart-legend">' + allTasks.map(task=>`<div class="chart-legend-item" onclick="toggleTaskFilter('${task}')"><div class="chart-legend-color" style="background:${getTaskColor(task)}"></div><span>${task}</span></div>`).join('') + '</div><div class="chart-container">';
    Object.entries(memberData).forEach(([member,tasks])=>{
        const memberTotal = Object.values(tasks).reduce((a,b)=>a+b,0);
        html += `<div class="chart-member"><div class="chart-member-name">ğŸ‘¤ ${member} <span class="chart-member-total">åˆè¨ˆ: ${memberTotal.toFixed(1)}h</span></div>`;
        Object.entries(tasks).sort((a,b)=>b[1]-a[1]).forEach(([task,hours])=>{
            const color = getTaskColor(task), width = Math.max(5,(hours/maxHours)*100);
            html += `<div class="chart-bar-row"><div class="chart-bar-label" title="${task}">${getTaskIcon(task)} ${task}</div><div class="chart-bar-container"><div class="chart-bar" style="width:${width}%;background:${color};">${hours.toFixed(1)}h</div></div><div class="chart-bar-value">${hours.toFixed(1)}h</div></div>`;
        });
        html += '</div>';
    });
    chartEl.innerHTML = html + '</div>';
}

function toggleTaskFilter(task){ const filterTask = document.getElementById('filterTask'); if (!filterTask) return; filterTask.value = (filterTask.value===task)?'':task; renderHistory(); }

function renderHistorySummary(recs){
    const summaryEl = document.getElementById('historySummary'); if (!summaryEl) return;
    const totals = {}; let total=0;
    recs.forEach(r=>{ const h = calcHours(r.startTime,r.endTime); totals[r.task]=(totals[r.task]||0)+h; total+=h; });
    summaryEl.innerHTML = `<div class="summary-item total"><div class="label">åˆè¨ˆ</div><div class="value">${total.toFixed(1)}h</div></div>` + Object.entries(totals).sort((a,b)=>b[1]-a[1]).map(([t,h])=>`<div class="summary-item" style="border-left:4px solid ${getTaskColor(t)};"><div class="label">${getTaskIcon(t)} ${t}</div><div class="value">${h.toFixed(1)}h</div></div>`).join('');
}

function renderHistoryRecords(recs,date){
    const listEl = document.getElementById('historyRecords'); if (!listEl) return;
    if (!recs.length){ listEl.innerHTML = ''; return; }
    recs.sort((a,b)=>a.startTime.localeCompare(b.startTime));
    listEl.innerHTML = '<h4 style="margin-bottom:10px;font-size:13px;color:#555;">ğŸ“ è©³ç´°è¨˜éŒ²</h4>' + recs.map(r=>`<div class="record-item" onclick="openEditModal(${r.id})"><div class="color-bar" style="background:${getTaskColor(r.task)}"></div><div class="info"><div class="task-name">${getTaskIcon(r.task)} ${r.task}</div><div class="time-range">${r.startTime} - ${r.endTime} (${r.member})</div></div><div class="duration">${calcHours(r.startTime,r.endTime).toFixed(1)}h</div></div>`).join('');
}

// ===== ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ =====
function renderGantt(){
    const container = document.getElementById('ganttContainer'), header = document.getElementById('ganttHeader'), body = document.getElementById('ganttBody'), legend = document.getElementById('ganttLegend'), timeDisplay = document.getElementById('ganttCurrentTime'), dateInput = document.getElementById('ganttDate');
    if (!container || !header || !body) return;
    const now = new Date(), todayStr = formatDate(now), target = ganttDate || todayStr;
    if (dateInput && dateInput.value !== target) dateInput.value = target;
    const currentHour = now.getHours(), currentMinute = now.getMinutes();
    if (timeDisplay) timeDisplay.textContent = target===todayStr ? `ä»Š: ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}` : target.replace(/-/g,'/');
    const startHour = 6, endHour = 22, hours = []; for(let h=startHour;h<=endHour;h++) hours.push(h);
    let headerHtml = '<div class="gantt-member-col">æ‹…å½“è€…</div>'; hours.forEach(h=>{ headerHtml += `<div class="gantt-time-label ${target===todayStr && h===currentHour?'current':''}">${h}:00</div>`; }); header.innerHTML = headerHtml;
    const dayRecs = records.filter(r=>r.date===target);
    const usedTasks = [...new Set([...dayRecs.map(r=>r.task), ...(target===todayStr?Object.values(activeTimers).map(t=>t.task):[])])];
    if (legend) legend.innerHTML = usedTasks.map(task=>`<div class="chart-legend-item ${ganttFilterTask===task?'active':''}" onclick="toggleGanttFilter('${task}')" style="cursor:pointer;${ganttFilterTask===task?'background:'+getTaskColor(task)+';color:white;':''}"><div class="chart-legend-color" style="background:${getTaskColor(task)}"></div><span>${getTaskIcon(task)} ${task}</span></div>`).join('');
    let bodyHtml = ''; members.forEach(member=>{
        const timer = activeTimers[member], isToday = (target===todayStr), isActiveToday = (isToday && !!timer);
        bodyHtml += `<div class="gantt-row"><div class="gantt-member-col"><span class="status-dot ${isActiveToday?'active':'idle'}"></span><span class="member-name-text">${member}</span></div>`;
        hours.forEach(h=>{ const isCurrent = (isToday && h===currentHour); bodyHtml += `<div class="gantt-cell ${isCurrent?'current':''}" data-hour="${h}" data-member="${member}">${isCurrent?`<div class="gantt-now-line" style="left:${(currentMinute/60)*100}%"></div>`:''}</div>`; });
        bodyHtml += '</div>';
    }); body.innerHTML = bodyHtml;
    members.forEach(member=>{
        const timer = activeTimers[member], isToday = (target===todayStr);
        dayRecs.filter(r=>r.member===member).forEach(r=>{ const [sh,sm] = r.startTime.split(':').map(Number), [eh,em] = r.endTime.split(':').map(Number); placeGanttBar(member,r.task,sh,sm,eh,em,false); });
        if (isToday && timer){ const start = new Date(timer.startTime); placeGanttBar(member,timer.task,start.getHours(),start.getMinutes(),currentHour,currentMinute,true); }
    });
    updateGanttFilter();
}

function changeGanttDate(delta){ const input = document.getElementById('ganttDate'); const d = new Date(input?.value || formatDate(new Date())); d.setDate(d.getDate()+delta); ganttDate = formatDate(d); if (input) input.value=ganttDate; renderGantt(); }
function goGanttToday(){ ganttDate = formatDate(new Date()); const input = document.getElementById('ganttDate'); if (input) input.value=ganttDate; renderGantt(); }
function onGanttDateChange(val){ ganttDate = val || formatDate(new Date()); renderGantt(); }

function placeGanttBar(member,task,startH,startM,endH,endM,isActive){
    const startHour = 6, endHour = 22; if (endH<startHour || startH>endHour) return;
    const startCellHour = Math.max(startHour,startH);
    const cell = document.querySelector(`.gantt-cell[data-hour="${startCellHour}"][data-member="${member}"]`); if (!cell) return;
    const cellWidth = 50;
    let leftOffset = startH>=startHour ? (startM/60)*cellWidth : 0;
    const startPos = Math.max(startHour,startH)+(startH>=startHour?startM/60:0);
    const endPos = Math.min(endHour+1,endH+endM/60);
    const width = (endPos-startPos)*cellWidth; if (width<=0) return;
    const bar = document.createElement('div');
    bar.className = `gantt-bar ${isActive?'active':''}`; bar.dataset.task = task;
    if (ganttFilterTask && ganttFilterTask!==task) bar.classList.add('filtered-out');
    bar.style.cssText = `left:${leftOffset}px;width:${width}px;background:${getTaskColor(task)};`;
    bar.innerHTML = `<span class="bar-icon">${getTaskIcon(task)}</span>${task}`;
    bar.onclick = e => { e.stopPropagation(); ganttFilterTask===task ? clearGanttFilter() : setGanttFilter(task); };
    cell.appendChild(bar);
}

function setGanttFilter(task){ ganttFilterTask = task; updateGanttFilter(); renderGantt(); }
function clearGanttFilter(){ ganttFilterTask=null; updateGanttFilter(); renderGantt(); }
function toggleGanttFilter(task){ ganttFilterTask===task ? clearGanttFilter() : setGanttFilter(task); }
function updateGanttFilter(){ document.querySelectorAll('.gantt-bar').forEach(bar=>{ bar.classList.toggle('filtered-out', ganttFilterTask && bar.dataset.task!==ganttFilterTask); }); }

// ===== è¨˜éŒ²ãƒªã‚¹ãƒˆ =====
function timeToMinutes(t){ const [h,m] = t.split(':').map(Number); return h*60+m; }
function minutesToTime(min){ return String(Math.floor(min/60)).padStart(2,'0')+':'+String(min%60).padStart(2,'0'); }

function renderRecordList(listId,summaryId,recs,showAdd){
    const listEl = document.getElementById(listId), summaryEl = document.getElementById(summaryId); if (!listEl || !summaryEl) return;
    const todayStr = formatDate(new Date()), dateStr = recs.length ? recs[0].date : todayStr, isToday = (dateStr===todayStr);
    let nowMinutes = 24*60; if (isToday){ const now = new Date(); nowMinutes = now.getHours()*60+now.getMinutes(); }
    const maxPastMin = isToday ? Math.min(nowMinutes,WORK_END_MIN) : WORK_END_MIN;
    recs.sort((a,b)=>a.startTime.localeCompare(b.startTime));
    const gaps = [];
    if (recs.length>0){
        let gapStart = WORK_START_MIN, gapEnd = Math.min(timeToMinutes(recs[0].startTime),maxPastMin);
        if (gapEnd>gapStart && gapEnd-gapStart>=15) gaps.push({start:gapStart,end:gapEnd});
        for(let i=0;i<recs.length-1;i++){
            gapStart = Math.max(timeToMinutes(recs[i].endTime),WORK_START_MIN);
            gapEnd = Math.min(timeToMinutes(recs[i+1].startTime),maxPastMin);
            if (gapEnd>gapStart && gapEnd-gapStart>=15 && gapStart>=WORK_START_MIN && gapEnd<=WORK_END_MIN) gaps.push({start:gapStart,end:gapEnd});
        }
        gapStart = Math.max(timeToMinutes(recs[recs.length-1].endTime),WORK_START_MIN); gapEnd = maxPastMin;
        if (gapEnd>gapStart && gapEnd-gapStart>=15 && gapStart>=WORK_START_MIN && gapEnd<=WORK_END_MIN) gaps.push({start:gapStart,end:gapEnd});
    } else { if (maxPastMin>WORK_START_MIN && maxPastMin-WORK_START_MIN>=15) gaps.push({start:WORK_START_MIN,end:maxPastMin}); }
    const totals = {}; let total=0; recs.forEach(r=>{ const h = calcHours(r.startTime,r.endTime); totals[r.task]=(totals[r.task]||0)+h; total+=h; });
    summaryEl.innerHTML = `<div class="summary-item total"><div class="label">åˆè¨ˆ</div><div class="value">${total.toFixed(1)}h</div></div>` + Object.entries(totals).sort((a,b)=>b[1]-a[1]).map(([t,h])=>`<div class="summary-item" style="border-left:4px solid ${getTaskColor(t)};"><div class="label">${getTaskIcon(t)} ${t}</div><div class="value">${h.toFixed(1)}h</div></div>`).join('');
    const items = [...recs.map(r=>({type:'record',startMin:timeToMinutes(r.startTime),endMin:timeToMinutes(r.endTime),rec:r})), ...gaps.map(g=>({type:'gap',startMin:g.start,endMin:g.end}))];
    if (!items.length){ listEl.innerHTML = `<div style="text-align:center;color:#888;padding:20px;">è¨˜éŒ²ãªã—</div>` + (showAdd?`<button class="btn btn-secondary" style="width:100%;margin-top:10px;" onclick="openAddModal()">ï¼‹ æ‰‹å…¥åŠ›</button>`:''); return; }
    items.sort((a,b)=>a.startMin-b.startMin);
    listEl.innerHTML = items.map(item=>{
        if (item.type==='record'){ const r = item.rec; return `<div class="record-item" onclick="openEditModal(${r.id})"><div class="color-bar" style="background:${getTaskColor(r.task)}"></div><div class="info"><div class="task-name">${getTaskIcon(r.task)} ${r.task}</div><div class="time-range">${r.startTime} - ${r.endTime}</div></div><div class="duration">${calcHours(r.startTime,r.endTime).toFixed(1)}h</div></div>`; }
        else { return `<div class="record-item" style="opacity:0.9;background:#fff7ed;border:1px dashed #f97316;" onclick="openAddModal('${minutesToTime(item.startMin)}','${minutesToTime(item.endMin)}')"><div class="color-bar" style="background:#f97316"></div><div class="info"><div class="task-name">âš ï¸ æœªå…¥åŠ›</div><div class="time-range">${minutesToTime(item.startMin)} - ${minutesToTime(item.endMin)}</div></div><div class="duration">${((item.endMin-item.startMin)/60).toFixed(1)}h</div></div>`; }
    }).join('') + (showAdd?`<button class="btn btn-secondary" style="width:100%;margin-top:10px;" onclick="openAddModal()">ï¼‹ æ‰‹å…¥åŠ›</button>`:'');
}

// ===== è¨­å®š =====
function renderSettings(){
    const ml = document.getElementById('memberList'); if (ml) ml.innerHTML = members.map(m=>`<div class="setting-item"><span>${m}</span><button class="btn btn-danger btn-sm" onclick="deleteMember('${m}')">å‰Šé™¤</button></div>`).join('');
    const sel = document.getElementById('customTaskMember'); if (sel){ const v = sel.value; sel.innerHTML = members.map(m=>`<option value="${m}">${m}</option>`).join(''); sel.value = v || members[0]; renderCustomTasks(); }
    renderBreaks();
}

function renderCustomTasks(){
    const m = document.getElementById('customTaskMember')?.value, el = document.getElementById('customTaskList'); if (!el || !m) return;
    const tasks = customTasks[m] || [];
    el.innerHTML = tasks.length ? tasks.map(t=>`<div class="setting-item"><span>${t}</span><button class="btn btn-danger btn-sm" onclick="deleteCustomTask('${m}','${t}')">å‰Šé™¤</button></div>`).join('') : '<div style="color:#888;font-size:12px;">ãªã—</div>';
}

function renderBreaks(){
    const el = document.getElementById('breakList'); if (!el) return;
    el.innerHTML = breakList.length ? breakList.map((b,idx)=>`<div class="setting-item"><span>${b.start} ã€œ ${b.end}</span><button class="btn btn-danger btn-sm" onclick="deleteBreak(${idx})">å‰Šé™¤</button></div>`).join('') : '<div style="color:#888;font-size:12px;">ç™»éŒ²ãªã—</div>';
}

function addBreak(){
    const s = document.getElementById('newBreakStart').value, e = document.getElementById('newBreakEnd').value;
    if (!s || !e || e<=s){ alert('é–‹å§‹ãƒ»çµ‚äº†æ™‚åˆ»ã‚’æ­£ã—ãè¨­å®šã—ã¦ãã ã•ã„'); return; }
    breakList.push({start:s,end:e}); saveData(); renderBreaks(); toast('âœ“ ä¼‘æ†©ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
}

function deleteBreak(idx){ if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; breakList.splice(idx, 1); saveData(); renderBreaks(); toast('ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ'); }

function manualSave(){ saveData(); toast('âœ“ æ‰‹å‹•ä¿å­˜ã—ã¾ã—ãŸ'); }

function endWorkToday(){
    if (!currentMember){ alert('æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    const now = new Date(), todayStr = formatDate(now), nowMin = now.getHours()*60+now.getMinutes();
    if (nowMin<=WORK_START_MIN){ alert('ã¾ã å‹¤å‹™æ™‚é–“å¸¯ã«å…¥ã£ã¦ã„ã¾ã›ã‚“'); return; }
    records = records.filter(r=>!(r.member===currentMember && r.date===todayStr && r.task==='ãã®ä»–' && (r.autoFilled===true || r.autoFilledTag==='endWork')));
    const memberRecs = records.filter(r=>r.member===currentMember && r.date===todayStr);
    let covered = [];
    memberRecs.forEach(r=>{ let s = Math.max(timeToMinutes(r.startTime),WORK_START_MIN), e = Math.min(timeToMinutes(r.endTime),nowMin); if (e>s) covered.push({start:s,end:e}); });
    breakList.forEach(b=>{ let s = Math.max(timeToMinutes(b.start),WORK_START_MIN), e = Math.min(timeToMinutes(b.end),nowMin); if (e>s) covered.push({start:s,end:e}); });
    covered.sort((a,b)=>a.start-b.start);
    const merged=[]; covered.forEach(int=>{ if (!merged.length || merged[merged.length-1].end<int.start) merged.push({...int}); else merged[merged.length-1].end=Math.max(merged[merged.length-1].end,int.end); });
    const gaps=[]; let cursor = WORK_START_MIN;
    merged.forEach(int=>{ if (int.start>cursor) gaps.push({start:cursor,end:int.start}); cursor=Math.max(cursor,int.end); });
    if (cursor<nowMin) gaps.push({start:cursor,end:nowMin});
    gaps.forEach(g=>{ if (g.end<=g.start) return; records.push({ id:Date.now()+Math.floor(Math.random()*1000), member:currentMember, task:'ãã®ä»–', date:todayStr, startTime:minutesToTime(g.start), endTime:minutesToTime(g.end), autoFilled:true, autoFilledTag:'endWork' }); });
    saveData(); render(); toast('âœ“ æ¥­å‹™çµ‚äº†ï¼šç©ºç™½æ™‚é–“ã‚’ã€Œãã®ä»–ã€ã§ç™»éŒ²ã—ã¾ã—ãŸ');
}

// ===== ã‚¿ã‚¤ãƒãƒ¼ =====
function updateTimerBar(){
    const bar = document.getElementById('timerBar'); if (!currentMember || !activeTimers[currentMember]){ bar.classList.remove('show'); return; }
    const t = activeTimers[currentMember]; bar.classList.add('show');
    document.getElementById('timerTaskName').textContent = `${getTaskIcon(t.task)} ${t.task}`;
    document.getElementById('timerTime').textContent = getElapsed(t.startTime);
}

function toggleTask(task){
    if (!currentMember) return;
    const timer = activeTimers[currentMember];
    if (timer && timer.task===task){ stopTimer(); return; }
    if (timer) saveTimerAsRecord(currentMember,timer);
    activeTimers[currentMember] = {task, startTime:new Date().toISOString()};
    saveData(); render(); toast(`â–¶ ${task}`);
}

function stopTimer(){
    if (!currentMember || !activeTimers[currentMember]) return;
    const saved = saveTimerAsRecord(currentMember,activeTimers[currentMember]);
    delete activeTimers[currentMember]; saveData(); render();
    toast(saved?'â¹ åœæ­¢':'â¹ åœæ­¢ (1åˆ†æœªæº€ã¯è¨˜éŒ²ãªã—)');
}

function saveTimerAsRecord(member,timer){
    const start = new Date(timer.startTime), end=new Date();
    if (end-start<60000) return false;
    records.push({ id:Date.now(), member, task:timer.task, date:formatDate(start), startTime:formatTime(start), endTime:formatTime(end) });
    return true;
}

function getElapsed(st){
    const ms = Date.now()-new Date(st).getTime(), s = Math.floor(ms/1000), m = Math.floor(s/60), h = Math.floor(m/60);
    return `${String(h).padStart(2,'0')}:${String(m%60).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
}

// ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
function calcHours(s,e){ const [sh,sm]=s.split(':').map(Number), [eh,em]=e.split(':').map(Number); return (eh*60+em - sh*60-sm)/60; }
function formatDate(d){ return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); }
function formatTime(d){ return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); }

// ===== ãƒ¢ãƒ¼ãƒ€ãƒ« =====
function openEditModal(id){
    const r = records.find(x=>x.id===id); if (!r) return; editingId=id;
    document.getElementById('editTaskName').value=r.task; document.getElementById('editStart').value=r.startTime; document.getElementById('editEnd').value=r.endTime;
    document.getElementById('editModal').classList.add('show');
}
function closeModal(){ document.getElementById('editModal').classList.remove('show'); editingId=null; }
function saveRecord(){
    const r = records.find(x=>x.id===editingId); if (!r) return;
    const s=document.getElementById('editStart').value, e=document.getElementById('editEnd').value;
    if (e<=s){ alert('çµ‚äº†ã¯é–‹å§‹ã‚ˆã‚Šå¾Œã«'); return; }
    r.task=document.getElementById('editTaskName').value; r.startTime=s; r.endTime=e;
    saveData(); closeModal(); render(); toast('âœ“ ä¿å­˜');
}
function deleteRecord(){ if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; records=records.filter(r=>r.id!==editingId); saveData(); closeModal(); render(); toast('ğŸ—‘ å‰Šé™¤'); }

function openAddModal(startOverride,endOverride){
    if (!currentMember){ alert('æ‹…å½“è€…ã‚’é¸æŠ'); return; }
    const tasks=[...DEFAULT_TASKS,...(customTasks[currentMember]||[])];
    document.getElementById('addTaskName').innerHTML = tasks.map(t=>`<option value="${t}">${t}</option>`).join('');
    const now=new Date();
    document.getElementById('addStart').value = startOverride || formatTime(new Date(now-3600000));
    document.getElementById('addEnd').value = endOverride || formatTime(now);
    addRecordDateStr = formatDate(new Date());
    document.getElementById('addModal').classList.add('show');
}
function closeAddModal(){ document.getElementById('addModal').classList.remove('show'); }
function addRecord(){
    const t=document.getElementById('addTaskName').value, s=document.getElementById('addStart').value, e=document.getElementById('addEnd').value;
    if (e<=s){ alert('çµ‚äº†ã¯é–‹å§‹ã‚ˆã‚Šå¾Œã«'); return; }
    records.push({ id:Date.now(), member:currentMember, task:t, date:addRecordDateStr||formatDate(new Date()), startTime:s, endTime:e });
    saveData(); closeAddModal(); render(); toast('âœ“ è¿½åŠ ');
}

const AVAILABLE_ICONS = ['ğŸ“‹','ğŸ“','ğŸ’¼','ğŸ¯','ğŸ””','â­','ğŸ’¡','ğŸ”','ğŸ“Š','ğŸ“ˆ','ğŸ› ï¸','âš™ï¸','ğŸ”§','ğŸ”¨','ğŸ“±','ğŸ’»','ğŸ–¥ï¸','ğŸ“','ğŸ“§','ğŸ“¬','ğŸ“','âœï¸','ğŸ“Œ','ğŸ—‚ï¸','ğŸ“‚','ğŸ—ƒï¸','ğŸ“…','â°','ğŸ•','â±ï¸','ğŸš€','âœˆï¸','ğŸš—','ğŸšŒ','ğŸ­','ğŸ¢','ğŸ ','ğŸ‘¤','ğŸ‘¥','ğŸ¤','ğŸ’¬','ğŸ“¢','ğŸ”Š','ğŸ¤','ğŸ§','ğŸ“·','ğŸ¬','ğŸ¨','âœ…','âŒ','âš ï¸','â—','â“','ğŸ’°','ğŸ’µ','ğŸ§¾','ğŸ“¦','ğŸ','ğŸ›’','ğŸ”','ğŸ”‘','ğŸŒŸ','ğŸ‰'];
let selectedIcon='ğŸ“‹';
function openTaskModal(){
    if (!currentMember){ alert('æ‹…å½“è€…ã‚’é¸æŠ'); return; }
    document.getElementById('modalTaskName').value=''; selectedIcon='ğŸ“‹'; renderIconSelector();
    document.getElementById('taskModal').classList.add('show');
}
function renderIconSelector(){ const el=document.getElementById('iconSelector'); if (!el) return; el.innerHTML = AVAILABLE_ICONS.map(icon=>`<div class="icon-option ${icon===selectedIcon?'selected':''}" onclick="selectIcon('${icon}')">${icon}</div>`).join(''); }
function selectIcon(icon){ selectedIcon=icon; renderIconSelector(); }
function closeTaskModal(){ document.getElementById('taskModal').classList.remove('show'); }
function saveNewTask(){
    const n=document.getElementById('modalTaskName').value.trim();
    if (!n){ alert('ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›'); return; }
    if (!customTasks[currentMember]) customTasks[currentMember]=[];
    if (customTasks[currentMember].includes(n)||DEFAULT_TASKS.includes(n)){ alert('æ—¢ã«å­˜åœ¨'); return; }
    customTasks[currentMember].push(n); customIcons[n]=selectedIcon;
    saveData(); closeTaskModal(); render(); toast('âœ“ è¿½åŠ ');
}

// ===== æ‹…å½“è€… =====
function addMember(){
    const n=document.getElementById('newMember').value.trim(); if (!n) return;
    if (members.includes(n)){ alert('æ—¢ã«å­˜åœ¨'); return; }
    members.push(n); document.getElementById('newMember').value=''; saveData(); render(); toast('âœ“ è¿½åŠ ');
}
function deleteMember(m){
    if (!confirm(`${m}ã‚’å‰Šé™¤ï¼Ÿ`)) return;
    members=members.filter(x=>x!==m); delete customTasks[m]; delete activeTimers[m]; records=records.filter(r=>r.member!==m);
    if (currentMember===m) currentMember=members[0]||null; saveData(); render(); toast('ğŸ—‘ å‰Šé™¤');
}
function addCustomTask(){
    const m=document.getElementById('customTaskMember').value, n=document.getElementById('newCustomTask').value.trim(); if (!n) return;
    if (!customTasks[m]) customTasks[m]=[]; if (customTasks[m].includes(n)){ alert('æ—¢ã«å­˜åœ¨'); return; }
    customTasks[m].push(n); document.getElementById('newCustomTask').value=''; saveData(); renderCustomTasks(); if (m===currentMember) renderTaskButtons(); toast('âœ“ è¿½åŠ ');
}
function deleteCustomTask(m,t){ if (!confirm('å‰Šé™¤ï¼Ÿ')) return; customTasks[m]=(customTasks[m]||[]).filter(x=>x!==t); saveData(); renderCustomTasks(); if (m===currentMember) renderTaskButtons(); }

// ===== æ—¥ä»˜æ“ä½œ =====
function changeDate(d){ const el=document.getElementById('historyDate'); const dt=new Date(el.value); dt.setDate(dt.getDate()+d); el.value=formatDate(dt); renderHistory(); }
function goToday(){ document.getElementById('historyDate').value=formatDate(new Date()); renderHistory(); }

// ===== Firebase =====
function initFirebase(){
    if (fs) return;
    const cfg = JSON.parse(document.getElementById('firebaseConfig').value);
    if (!firebase.apps.length) firebase.initializeApp(cfg);
    fs = firebase.firestore(); docRef = fs.doc('timeTracker/state');
}

function autoConnectFB(){
    const cfg = localStorage.getItem('tt_firebaseConfig'); if (!cfg) return;
    document.getElementById('firebaseConfig').value = cfg;
    try{ initFirebase(); fbConnected=true; updateSyncStatus('syncing'); setupFBListener(); }catch(e){ console.error(e); updateSyncStatus('disconnected'); }
}

function connectFB(){
    try{
        const cfg=document.getElementById('firebaseConfig').value; JSON.parse(cfg);
        localStorage.setItem('tt_firebaseConfig',cfg);
        if (fbUnsubscribe){ fbUnsubscribe(); fbUnsubscribe = null; }
        fs = null; initFirebase(); fbConnected=true; updateSyncStatus('syncing'); setupFBListener(); toast('âœ“ æ¥ç¶š / å†æ¥ç¶š');
    }catch(e){ alert('ã‚¨ãƒ©ãƒ¼: '+e.message); }
}

function updateSyncStatus(status){
    const el=document.getElementById('syncStatus');
    if (status === 'connected') { el.textContent = 'âœ“ åŒæœŸä¸­'; el.className = 'sync-status connected'; }
    else if (status === 'syncing') { el.textContent = 'âŸ³ åŒæœŸä¸­...'; el.className = 'sync-status syncing'; }
    else { el.textContent = 'æœªæ¥ç¶š'; el.className = 'sync-status disconnected'; }
}

function setupFBListener(){
    if (!docRef) return; if (fbUnsubscribe) fbUnsubscribe();
    fbUnsubscribe = docRef.onSnapshot(snapshot => {
        if (!snapshot.exists){ fbUpdating = false; updateSyncStatus('connected'); if (records.length > 0 || members.length > 1 || cases.length > 0) syncPushToServer(); return; }
        const serverData = snapshot.data() || {}, serverVersion = serverData.lastUpdatedVersion || 0;
        if (serverVersion > localVersion) {
            fbUpdating = true;
            members = serverData.members || ['æ‹…å½“è€…1']; customTasks = serverData.customTasks || {}; customIcons = serverData.customIcons || {};
            records = serverData.records || []; activeTimers = serverData.activeTimers || {}; taskList = serverData.taskList || [];
            breakList = serverData.breakList || []; cases = serverData.cases || [];
            localVersion = serverVersion; lastSyncTime = Date.now();
            saveDataLocal(); render(); updateVersionDisplay(); hideConflictBanner(); fbUpdating = false; updateSyncStatus('connected');
        } else { updateSyncStatus('connected'); }
    }, err => { console.error('onSnapshot error:', err); updateSyncStatus('disconnected'); });
}

async function syncPushToServer(){
    if (!fbConnected || !docRef || !fs) return; updateSyncStatus('syncing');
    try {
        await fs.runTransaction(async tx => {
            const snap = await tx.get(docRef), serverData = snap.exists ? snap.data() : {}, serverVersion = serverData.lastUpdatedVersion || 0;
            if (serverVersion > localVersion) throw new Error('CONFLICT');
            const newVersion = Math.max(serverVersion, localVersion) + 1;
            tx.set(docRef, { members, customTasks, customIcons, records, activeTimers, taskList, breakList, cases, lastUpdatedVersion: newVersion, lastUpdatedAt: firebase.firestore.FieldValue.serverTimestamp(), lastUpdatedBy: getDeviceId() }, { merge: false });
            localVersion = newVersion; lastSyncTime = Date.now();
            localStorage.setItem('tt_version', String(localVersion)); localStorage.setItem('tt_lastSyncTime', String(lastSyncTime));
        });
        pendingLocalChanges = false; updateSyncStatus('connected'); updateVersionDisplay();
    } catch (e) { if (e.message === 'CONFLICT') { showConflictBanner(); updateSyncStatus('connected'); } else { console.error('[Sync] Push error:', e); updateSyncStatus('disconnected'); } }
}

async function forcePushToServer(){
    if (!fbConnected || !docRef || !fs) { alert('Firebaseã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
    if (!confirm('ç¾åœ¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã§ã‚µãƒ¼ãƒãƒ¼ã‚’ä¸Šæ›¸ãã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    updateSyncStatus('syncing');
    try {
        const snap = await docRef.get(), serverData = snap.exists ? snap.data() : {}, newVersion = Math.max(serverData.lastUpdatedVersion || 0, localVersion) + 1;
        await docRef.set({ members, customTasks, customIcons, records, activeTimers, taskList, breakList, cases, lastUpdatedVersion: newVersion, lastUpdatedAt: firebase.firestore.FieldValue.serverTimestamp(), lastUpdatedBy: getDeviceId(), forcePushed: true });
        localVersion = newVersion; lastSyncTime = Date.now();
        localStorage.setItem('tt_version', String(localVersion)); localStorage.setItem('tt_lastSyncTime', String(lastSyncTime));
        hideConflictBanner(); updateSyncStatus('connected'); updateVersionDisplay(); toast('âœ“ å¼·åˆ¶ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†');
    } catch (e) { alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message); updateSyncStatus('disconnected'); }
}

function getDeviceId(){ let deviceId = localStorage.getItem('tt_deviceId'); if (!deviceId) { deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9); localStorage.setItem('tt_deviceId', deviceId); } return deviceId; }
function showConflictBanner(){ const banner = document.getElementById('conflictBanner'); if (banner) banner.classList.remove('hidden'); }
function hideConflictBanner(){ const banner = document.getElementById('conflictBanner'); if (banner) banner.classList.add('hidden'); }

function forceReload(){
    if (!docRef) { location.reload(); return; } updateSyncStatus('syncing');
    docRef.get().then(snap => {
        if (!snap.exists) { toast('âš ï¸ ã‚µãƒ¼ãƒãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); updateSyncStatus('connected'); return; }
        const serverData = snap.data();
        members = serverData.members || ['æ‹…å½“è€…1']; customTasks = serverData.customTasks || {}; customIcons = serverData.customIcons || {};
        records = serverData.records || []; activeTimers = serverData.activeTimers || {}; taskList = serverData.taskList || [];
        breakList = serverData.breakList || []; cases = serverData.cases || [];
        localVersion = serverData.lastUpdatedVersion || 0; lastSyncTime = Date.now();
        saveDataLocal(); render(); updateVersionDisplay(); hideConflictBanner(); updateSyncStatus('connected'); toast('âœ“ æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ');
    }).catch(err => { alert('ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message); updateSyncStatus('disconnected'); });
}

// ===== ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/å‰Šé™¤ =====
function exportData(){
    const data = { members, customTasks, customIcons, records, activeTimers, taskList, breakList, cases, version: localVersion, exported: new Date().toISOString(), deviceId: getDeviceId() };
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'})); a.download=`æ—¥å ±å…¥åŠ›_${formatDate(new Date())}.json`; a.click(); toast('âœ“ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ');
}

function importData(){
    const input=document.createElement('input'); input.type='file'; input.accept='.json';
    input.onchange=e=>{
        const reader=new FileReader();
        reader.onload=ev=>{
            try{
                const data=JSON.parse(ev.target.result); if (!confirm('ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) return;
                members = data.members || members; customTasks = data.customTasks || {}; customIcons = data.customIcons || {};
                records = data.records || []; activeTimers = data.activeTimers || {}; taskList = data.taskList || [];
                breakList = data.breakList || []; cases = data.cases || [];
                localVersion = (data.version || 0) + 1; saveData(); render(); updateVersionDisplay(); toast('âœ“ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ');
            }catch(e){ alert('ã‚¨ãƒ©ãƒ¼: '+e.message); }
        };
        reader.readAsText(e.target.files[0]);
    };
    input.click();
}

function clearData(){
    if (!confirm('å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; if (!confirm('æœ¬å½“ã«ï¼Ÿ')) return;
    members=['æ‹…å½“è€…1']; customTasks={}; customIcons={}; records=[]; activeTimers={}; taskList=[]; breakList=[]; cases=[];
    currentMember=members[0]; localVersion = localVersion + 1; saveData(); render(); updateVersionDisplay(); toast('ğŸ—‘ å‰Šé™¤');
}

function toast(msg){ const el=document.createElement('div'); el.className='toast'; el.textContent=msg; document.body.appendChild(el); setTimeout(()=>el.remove(),2000); }

// ===== å‰æ—¥ç¶™ç¶šã‚¿ã‚¹ã‚¯ =====
function checkPendingTasks(){
    const alertEl=document.getElementById('pendingTasksAlert'); if (!alertEl) return;
    const today=formatDate(new Date());
    const pendingTasks=[];
    Object.entries(activeTimers).forEach(([member,timer])=>{ if (formatDate(new Date(timer.startTime))<today) pendingTasks.push({ member, task:timer.task, startTime:timer.startTime, date:formatDate(new Date(timer.startTime)) }); });
    if (!pendingTasks.length){ alertEl.innerHTML=''; return; }
    let html = `<div class="pending-alert"><h4>âš ï¸ å‰æ—¥ã‹ã‚‰ç¶™ç¶šä¸­ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™</h4>`;
    pendingTasks.forEach(p=>{ html += `<div class="pending-item"><div class="pending-item-info"><div class="name">${getTaskIcon(p.task)} ${p.task}</div><div class="detail">${p.member} | ${p.date} ${formatTime(new Date(p.startTime))}ã€œ</div></div><div class="pending-actions"><button class="btn-complete" onclick="completePendingTask('${p.member}')">çµ‚äº†æ™‚åˆ»ã‚’å…¥åŠ›</button><button class="btn-discard" onclick="discardPendingTask('${p.member}')">ç ´æ£„</button></div></div>`; });
    alertEl.innerHTML = html+'</div>';
}

function completePendingTask(member){
    const timer=activeTimers[member]; if (!timer) return;
    const start=new Date(timer.startTime), startDate=formatDate(start), startTimeStr=formatTime(start);
    const endTimeInput = prompt(`${member}ã®ã€Œ${timer.task}ã€ã®çµ‚äº†æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\né–‹å§‹: ${startDate} ${startTimeStr}\n(ä¾‹: 18:00, 23:30)`,'18:00');
    if (!endTimeInput) return;
    const m=endTimeInput.match(/^(\d{1,2}):(\d{2})$/); if (!m){ alert('æ­£ã—ã„æ™‚åˆ»å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    const endTime=`${String(parseInt(m[1])).padStart(2,'0')}:${m[2]}`;
    if (endTime<=startTimeStr){ alert('çµ‚äº†æ™‚åˆ»ã¯é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã«ã—ã¦ãã ã•ã„'); return; }
    records.push({ id:Date.now(), member, task:timer.task, date:startDate, startTime:startTimeStr, endTime });
    delete activeTimers[member]; saveData(); render(); toast(`âœ“ ${startDate}ã®è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
}

function discardPendingTask(member){ if (!confirm(`${member}ã®å‰æ—¥ã®ã‚¿ã‚¹ã‚¯ã‚’ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ`)) return; delete activeTimers[member]; saveData(); render(); toast('ğŸ—‘ ç ´æ£„ã—ã¾ã—ãŸ'); }

// ===== ã‚¿ã‚¹ã‚¯ç®¡ç† =====
function renderTaskManager(){
    const alertsEl=document.getElementById('taskAlerts'), listEl=document.getElementById('taskManagerList'), assigneeEl=document.getElementById('newTaskAssignee');
    if (!alertsEl || !listEl) return;
    if (assigneeEl){ const cv=assigneeEl.value; assigneeEl.innerHTML = '<option value="">æ‹…å½“è€…</option>' + members.map(m=>`<option value="${m}">${m}</option>`).join(''); if (cv) assigneeEl.value=cv; }
    const hideCompleted = document.getElementById('hideCompletedTasks')?.checked;
    const today=new Date(); today.setHours(0,0,0,0);
    const overdue=[], warning=[];
    taskList.filter(t=>!t.completed && t.deadline).forEach(t=>{
        const dl=new Date(t.deadline); dl.setHours(0,0,0,0); const diff=Math.ceil((dl-today)/86400000);
        if (diff<0) overdue.push({...t,days:Math.abs(diff)}); else if (diff<=3) warning.push({...t,days:diff});
    });
    let alertHtml='';
    if (overdue.length){ alertHtml+='<div class="task-alert danger"><h4>ğŸš¨ æœŸé™è¶…é</h4>'; overdue.forEach(t=>alertHtml+=`<div class="task-alert-item">${t.name} (${t.assignee||'æœªè¨­å®š'}) - ${t.days}æ—¥è¶…é</div>`); alertHtml+='</div>'; }
    if (warning.length){ alertHtml+='<div class="task-alert warning"><h4>âš ï¸ æœŸé™é–“è¿‘</h4>'; warning.forEach(t=>alertHtml+=`<div class="task-alert-item">${t.name} (${t.assignee||'æœªè¨­å®š'}) - ${t.days===0?'ä»Šæ—¥':'ã‚ã¨'+t.days+'æ—¥'}</div>`); alertHtml+='</div>'; }
    alertsEl.innerHTML=alertHtml;
    let list = hideCompleted?taskList.filter(t=>!t.completed):[...taskList];
    list.sort((a,b)=>{ if (a.completed!==b.completed) return a.completed?1:-1; if (!a.deadline) return 1; if (!b.deadline) return -1; return new Date(a.deadline)-new Date(b.deadline); });
    if (!list.length){ listEl.innerHTML='<div style="text-align:center;color:#888;padding:20px;">ã‚¿ã‚¹ã‚¯ãªã—</div>'; return; }
    listEl.innerHTML = list.map(t=>{
        let statusClass='';
        if (t.deadline && !t.completed){ const dl=new Date(t.deadline); dl.setHours(0,0,0,0); const diff=Math.ceil((dl-today)/86400000); if (diff<0) statusClass='overdue'; else if (diff<=3) statusClass='warning'; }
        const progress=t.progress||0, gaugeClass = progress<30?'low':progress<70?'mid':'high';
        return `<div class="task-manager-item ${statusClass} ${t.completed?'completed':''}">
            <div class="tm-name">${t.name}</div>
            <div class="tm-progress-container"><input type="number" class="tm-progress" value="${progress}" min="0" max="100" onchange="updateTaskProgress(${t.id}, this.value)" ${t.completed?'disabled':''}><div class="tm-gauge"><div class="tm-gauge-fill ${gaugeClass}" style="width:${progress}%"></div><span class="tm-gauge-text">${progress}%</span></div></div>
            <div><input type="date" class="tm-deadline" value="${t.deadline||''}" onchange="updateTaskDeadline(${t.id}, this.value)" ${t.completed?'disabled':''}></div>
            <div>${t.assignee||'-'}${t.completed?'<br><small style="color:#10b981;">å®Œäº†</small>':''}</div>
            <div style="display:flex;gap:4px;">${!t.completed?`<button class="btn btn-success btn-sm" onclick="completeTaskItem(${t.id})">âœ“</button>`:`<button class="btn btn-secondary btn-sm" onclick="uncompleteTaskItem(${t.id})">æˆ»</button>`}<button class="btn btn-danger btn-sm" onclick="deleteTaskItem(${t.id})">Ã—</button></div>
        </div>`;
    }).join('');
}

function addTaskItem(){
    const name=document.getElementById('newTaskName').value.trim(); if (!name){ alert('ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    taskList.push({ id:Date.now(), name, progress:0, assignee:document.getElementById('newTaskAssignee').value || null, deadline:document.getElementById('newTaskDeadline').value || null, completed:false });
    document.getElementById('newTaskName').value=''; document.getElementById('newTaskDeadline').value=''; saveData(); renderTaskManager(); toast('âœ“ è¿½åŠ ');
}
function updateTaskProgress(id,value){ const t=taskList.find(x=>x.id===id); if (t) t.progress=Math.min(100,Math.max(0,parseInt(value)||0)); saveData(); renderTaskManager(); }
function updateTaskDeadline(id,value){ const t=taskList.find(x=>x.id===id); if (t) t.deadline=value||null; saveData(); renderTaskManager(); toast('âœ“ ç´æœŸæ›´æ–°'); }
function completeTaskItem(id){ const t=taskList.find(x=>x.id===id); if (t){ t.completed=true; t.completedDate=formatDate(new Date()); t.progress=100; } saveData(); renderTaskManager(); toast('âœ“ å®Œäº†'); }
function uncompleteTaskItem(id){ const t=taskList.find(x=>x.id===id); if (t){ t.completed=false; t.completedDate=null; } saveData(); renderTaskManager(); }
function deleteTaskItem(id){ if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; taskList=taskList.filter(t=>t.id!==id); saveData(); renderTaskManager(); toast('ğŸ—‘ å‰Šé™¤'); }

window.onclick = e=>{ if (e.target.classList.contains('modal')){ closeModal(); closeAddModal(); closeTaskModal(); closeNewCaseModal(); closeCaseDetailModal(); } };
</script>
</body>
</html>
