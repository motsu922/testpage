<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ç”Ÿç”£å®Ÿç¸¾ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{
  --fg:#111;
  --muted:#4b5563;
  --border:#cbd5e1;
  --border-strong:#94a3b8;
  --bg:#f7fafc;
  --accent:#0369a1;
  --success:#059669;
  --danger:#dc2626;
  --warning:#d97706;
}
*{ box-sizing:border-box; }
body{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin:0; color:var(--fg); background:var(--bg); line-height:1.5; }
header{ background:#fff; border-bottom:2px solid var(--border); padding:16px 24px; display:flex; gap:16px; align-items:center; flex-wrap:wrap; position:sticky; top:0; z-index:10; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
h1{ font-size:22px; margin:0; font-weight:700; color:var(--accent); }
.badge{ font-size:12px; padding:4px 10px; border-radius:12px; border:1px solid var(--border); font-weight:500; }
.badge.connected{ background:#d1fae5; color:var(--success); border-color:#6ee7b7; }
.badge.disconnected{ background:#fee2e2; color:var(--danger); border-color:#fecaca; }
main{ padding:24px; max-width:1600px; margin:0 auto; }
.panel{ background:#fff; border:1px solid var(--border); border-radius:16px; padding:20px; margin-bottom:20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
.filter-grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); margin-bottom:16px; }
label{ font-size:13px; font-weight:600; color:var(--muted); display:block; margin-bottom:6px; }
input, select{ border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:14px; background:#fff; width:100%; transition: border-color 0.2s; }
input:focus, select:focus{ outline:none; border-color:var(--accent); }
button{ border:1px solid var(--border); background:#fff; border-radius:10px; padding:10px 16px; cursor:pointer; font-size:14px; font-weight:500; transition: all 0.2s; }
button:hover{ background:#f9fafb; }
button.primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
button.primary:hover{ background:#0284c7; }
button.danger{ background:var(--danger); color:#fff; border-color:var(--danger); }
button.danger:hover{ background:#b91c1c; }
button.success{ background:var(--success); color:#fff; border-color:var(--success); }
button:disabled{ opacity:.5; cursor:not-allowed; }
table{ width:100%; border-collapse: collapse; }
th, td{ border-bottom:1px solid var(--border); padding:12px; text-align:left; vertical-align:middle; }
th{ font-size:12px; font-weight:700; color:var(--muted); background:#fafafa; text-transform:uppercase; letter-spacing:0.5px; }
tbody tr:hover{ background:#f9fafb; }
.controls{ display:flex; gap:10px; align-items:center; margin-left:auto; flex-wrap:wrap; }
.error{ color:var(--danger); font-size:13px; font-weight:500; }
.small{ font-size:13px; color:var(--muted); }
.right{ text-align:right; }
.center{ text-align:center; }
.pager{ display:flex; gap:10px; align-items:center; justify-content:center; }
.chart-container{ position:relative; height:350px; margin-bottom:16px; }
h2{ font-size:18px; margin:0 0 16px 0; color:var(--fg); font-weight:700; display:flex; align-items:center; gap:8px; }
h2::before{ content:""; width:4px; height:20px; background:var(--accent); border-radius:2px; }
.tabs{ display:flex; gap:4px; margin-bottom:20px; border-bottom:2px solid var(--border); background:#fff; border-radius:12px 12px 0 0; padding:0 20px; }
.tab{ padding:14px 24px; cursor:pointer; border-bottom:3px solid transparent; color:var(--muted); font-weight:600; font-size:14px; transition: all 0.2s; margin-bottom:-2px; }
.tab:hover{ color:var(--fg); background:#f9fafb; }
.tab.active{ color:var(--accent); border-bottom-color:var(--accent); }
.tab-content{ display:none; }
.tab-content.active{ display:block; }
.note{ background:#fef3c7; border:1px solid #fbbf24; border-radius:12px; padding:16px; margin-bottom:20px; font-size:14px; line-height:1.6; }
.note strong{ color:#92400e; }
.action-bar{ display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; align-items:center; }
.master-table-wrap{ overflow-x:auto; border:1px solid var(--border); border-radius:12px; }
.nowrap{ white-space:nowrap; }
.tableWrap{ max-height: 60vh; overflow:auto; border:1px solid var(--border); border-radius:12px; }
.msg-box{ padding:12px 16px; border-radius:10px; margin-bottom:16px; font-size:14px; font-weight:500; }
.msg-box.success{ background:#d1fae5; color:var(--success); border:1px solid #6ee7b7; }
.msg-box.error{ background:#fee2e2; color:var(--danger); border:1px solid #fecaca; }

.line-card{ background:#fff; border:2px solid var(--border); border-radius:12px; padding:16px; transition: all 0.2s; }
.line-card:hover{ border-color:var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
.line-card-header{ font-size:18px; font-weight:700; color:var(--accent); margin-bottom:10px; display:flex; align-items:center; gap:8px; }
.line-card-header::before{ content:"ğŸ­"; }
.product-item{ display:flex; justify-content:space-between; padding:8px 12px; background:#f9fafb; border-radius:8px; margin-bottom:6px; }
.product-name{ font-weight:600; color:var(--fg); display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.product-qty{ font-size:16px; font-weight:700; color:var(--accent); }
.line-card-footer{ margin-top:12px; padding-top:12px; border-top:1px solid var(--border); display:flex; justify-content:space-between; gap:10px; font-size:13px; color:var(--muted); flex-wrap:wrap; }
.highlight-stop{ background:#fef3c7; font-weight:700; color:var(--warning); padding:2px 8px; border-radius:999px; border:1px solid #fde68a; }
.status-pill{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:8px 10px;border-radius:12px;font-size:13px;font-weight:800;border:2px solid var(--border); margin-bottom:10px;}
.status-pill .left{display:flex; align-items:center; gap:8px; flex-wrap:wrap;}

/* ã‹ã‚“ã°ã‚“v2ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¯¾å¿œ */
.status-RUNNING{background:#ecfdf5;color:var(--success);border-color:#86efac;}
.status-TRY{background:#fef3c7;color:var(--warning);border-color:#fde68a;}
.status-ABNORMAL_STOP{background:#fff1f2;color:var(--danger);border-color:#fecaca;}
.status-PLAN_STOP{background:#fef3c7;color:#92400e;border-color:#fde68a;}
.status-MATERIAL_CHANGE{background:#dbeafe;color:#1e40af;border-color:#93c5fd;}
.status-SETUP_CHANGE{background:#e0e7ff;color:#4338ca;border-color:#a5b4fc;}
.status-NOT_STARTED{background:#f3f4f6;color:#374151;border-color:#e5e7eb;}

/* å¾“æ¥ã®è‡ªå‹•åˆ¤å®šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆã‹ã‚“ã°ã‚“v2ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒãªã„å ´åˆï¼‰ */
.status-on{background:#ecfdf5;color:var(--success);border-color:#86efac;}
.status-stop{background:#fff1f2;color:var(--danger);border-color:#fecaca;}
.status-off{background:#f3f4f6;color:#374151;border-color:#e5e7eb;}

.time-chip{font-size:12px; font-weight:800; padding:2px 8px; border-radius:999px; border:1px solid rgba(0,0,0,0.08); background:#fff;}
.time-range{font-size:12px;color:var(--muted);font-weight:700;}
.kanban-badge{
  display:inline-flex;
  align-items:center;
  gap:4px;
  padding:3px 8px;
  background:#e0e7ff;
  color:#4338ca;
  border-radius:8px;
  font-size:11px;
  font-weight:700;
  border:1px solid #a5b4fc;
}
</style>
</head>
<body>
<header>
  <h1>ğŸ“Š ç”Ÿç”£å®Ÿç¸¾ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
  <span id="fbStatus" class="badge">Firebase: æœªæ¥ç¶š</span>
  <div class="controls">
    <button id="btnExport">ğŸ“¥ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    <button id="btnReload" class="primary">ğŸ”„ ãƒ‡ãƒ¼ã‚¿å†å–å¾—</button>
  </div>
</header>

<main>
  <section class="panel">
    <div class="filter-grid">
      <div>
        <label for="bushoSel">éƒ¨ç½²</label>
        <select id="bushoSel">
          <option value="">ã™ã¹ã¦</option>
          <option>1G</option>
          <option>3G</option>
          <option>4G</option>
          <option>5G</option>
          <option>6G</option>
          <option>å“è³ª</option>
        </select>
      </div>
      <div>
        <label for="dateFrom">é–‹å§‹æ—¥</label>
        <input id="dateFrom" type="date" />
      </div>
      <div>
        <label for="dateTo">çµ‚äº†æ—¥</label>
        <input id="dateTo" type="date" />
      </div>
      <div>
        <label for="lineSel">ç”Ÿç”£ãƒ©ã‚¤ãƒ³</label>
        <select id="lineSel"><option value="">ã™ã¹ã¦</option></select>
      </div>
      <div>
        <label for="slicedSel">å“ç•ª</label>
        <select id="slicedSel"><option value="">ã™ã¹ã¦</option></select>
      </div>
      <div>
        <label for="hourGroup">æ™‚é–“å¸¯é›†è¨ˆ</label>
        <select id="hourGroup">
          <option value="1">1æ™‚é–“ã”ã¨</option>
          <option value="2">2æ™‚é–“ã”ã¨</option>
          <option value="4">4æ™‚é–“ã”ã¨</option>
          <option value="8">8æ™‚é–“ã”ã¨</option>
        </select>
      </div>
    </div>
    <div class="right">
      <button id="btnApply" class="primary">ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨</button>
    </div>
    <div id="err" class="error" style="display:none; margin-top:12px;"></div>
  </section>

  <div class="tabs">
    <div class="tab active" data-tab="dashboard">ğŸ“ˆ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
    <div class="tab" data-tab="master">âš™ï¸ QRãƒã‚¹ã‚¿ç®¡ç†</div>
    <div class="tab" data-tab="settings">ğŸ• ç¨¼åƒ/åœæ­¢åˆ¤å®š è¨­å®š</div>
    <div class="tab" data-tab="manual">ğŸ“– ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</div>
  </div>

  <div class="tab-content active" id="dashboard">
    <section class="panel">
      <h2>ãƒ©ã‚¤ãƒ³åˆ¥ç”Ÿç”£ã‚µãƒãƒªãƒ¼</h2>
      <div id="lineSummaryCards" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(320px, 1fr)); gap:16px;"></div>
    </section>

    <section class="panel">
      <h2>ãƒ©ã‚¤ãƒ³åˆ¥ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»ï¼ˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼‰</h2>
      <div class="chart-container" style="height:600px;">
        <canvas id="statusTransitionChart"></canvas>
      </div>
      <div class="small" style="margin-top:8px; color:var(--muted);">
        â€»ã‹ã‚“ã°ã‚“v2ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´å±¥æ­´ã‚’8:00ã€œç¿Œ5:00ã®æ™‚ç³»åˆ—ã§è¡¨ç¤ºã€‚æ¨ªè»¸ãŒæ™‚åˆ»ã€ç¸¦è»¸ãŒãƒ©ã‚¤ãƒ³ã€‚å„ãƒãƒ¼ä¸Šã«å“ç•ªã‚„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
      </div>
    </section>

    <section class="panel">
      <h2>ãƒ©ã‚¤ãƒ³åˆ¥åœæ­¢æ™‚é–“è©³ç´°</h2>
      <div style="overflow-x:auto;">
        <table id="stopDetailTable">
          <thead>
            <tr>
              <th>ãƒ©ã‚¤ãƒ³</th>
              <th>ç”Ÿç”£å“ç•ª</th>
              <th>åœæ­¢é–‹å§‹æ™‚åˆ»</th>
              <th>åœæ­¢çµ‚äº†æ™‚åˆ»</th>
              <th class="right">åœæ­¢æ™‚é–“ï¼ˆåˆ†ï¼‰</th>
            </tr>
          </thead>
          <tbody id="stopDetailTbody"></tbody>
        </table>
      </div>
    </section>

    <section class="panel">
      <h2>ãƒ©ã‚¤ãƒ³åˆ¥åœæ­¢æ™‚é–“</h2>
      <div class="chart-container" style="height:300px;">
        <canvas id="stopTimeChart"></canvas>
      </div>
    </section>

    <section class="panel">
      <h2>æ™‚ç³»åˆ—ç”Ÿç”£æ¨ç§»ï¼ˆãƒ©ã‚¤ãƒ³åˆ¥ï¼‰</h2>
      <div class="chart-container">
        <canvas id="timeSeriesChart"></canvas>
      </div>
    </section>

    <section class="panel">
      <h2>ãƒ­ã‚°æ˜ç´°ï¼ˆãƒšãƒ¼ã‚¸è¡¨ç¤ºï¼‰</h2>
      <div class="pager" style="margin: 0 0 16px 0;">
        <button id="btnPrev" disabled>â¬…ï¸ å‰ã¸</button>
        <span id="pageInfo" class="small">ãƒšãƒ¼ã‚¸ 1 / 10</span>
        <button id="btnNext" disabled>æ¬¡ã¸ â¡ï¸</button>
      </div>
      <div style="margin-bottom:12px;">
        <span id="count" class="small"></span>
      </div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th class="nowrap">ç«¯æœ«æ™‚åˆ»</th>
              <th>ç”Ÿç”£ãƒ©ã‚¤ãƒ³</th>
              <th>å“ç•ª</th>
              <th class="center">ç”Ÿç”£å€‹æ•°</th>
              <th>QR(raw)</th>
              <th class="center">çµæœ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <div class="tab-content" id="master">
    <section class="panel">
      <div class="note">
        <strong>ğŸ“ QRãƒã‚¹ã‚¿ã«ã¤ã„ã¦</strong><br>
        å“ç•ªã”ã¨ã«1å›ã®QRèª­ã¿å–ã‚Šã§ç”Ÿç”£ã•ã‚Œã‚‹å€‹æ•°ã‚’ç™»éŒ²ã§ãã¾ã™ã€‚<br>
        ä¾‹ï¼šå“ç•ªã€ŒABC-001ã€ã‚’1å›èª­ã¿å–ã‚‹ã¨10å€‹ç”Ÿç”£ã•ã‚Œã‚‹å ´åˆã€å€‹æ•°ã«ã€Œ10ã€ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚<br>
        ãƒã‚¹ã‚¿æœªç™»éŒ²ã®å“ç•ªã¯ã€èª­å–ä»¶æ•°ï¼ç”Ÿç”£å€‹æ•°ã¨ã—ã¦è¨ˆç®—ã•ã‚Œã¾ã™ï¼ˆå€‹æ•°=1ï¼‰ã€‚<br>
        <strong>ğŸ’¾ ãƒã‚¹ã‚¿ã¯Firebaseã«ä¿å­˜ã•ã‚Œã€ãƒãƒ¼ãƒ å…¨ä½“ã§å…±æœ‰ã•ã‚Œã¾ã™ã€‚</strong>
      </div>

      <div class="action-bar">
        <button id="btnAddMaster" class="primary">â• æ–°è¦è¿½åŠ </button>
        <button id="btnReloadMaster" class="success">ğŸ”„ Firebaseã‹ã‚‰å†èª­è¾¼</button>
        <button id="btnExportMaster">ğŸ“¥ ãƒã‚¹ã‚¿CSVå‡ºåŠ›</button>
        <button id="btnImportMaster">ğŸ“¤ ãƒã‚¹ã‚¿CSVå–è¾¼</button>
        <input type="file" id="fileImportMaster" accept=".csv" style="display:none;" />
        <div style="margin-left:auto;">
          <span class="stat-value" id="registeredMaster" style="font-size:24px; font-weight:700; color:var(--accent);">0</span>
          <span class="small">ä»¶ç™»éŒ²æ¸ˆã¿</span>
        </div>
      </div>

      <div id="masterMsg"></div>

      <div class="master-table-wrap">
        <table>
          <thead>
            <tr>
              <th>å“ç•ªï¼ˆåˆ‡ã‚Šå‡ºã—å€¤ï¼‰</th>
              <th class="center">ç”Ÿç”£å€‹æ•°/å›</th>
              <th class="center" style="width:120px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="masterTbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <div class="tab-content" id="settings">
    <section class="panel">
      <div class="note">
        <strong>ğŸ• ç¨¼åƒæ™‚é–“è¨­å®šã«ã¤ã„ã¦</strong><br>
        éç¨¼åƒã®æ›œæ—¥ã‚„æ™‚é–“å¸¯ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€åœæ­¢æ™‚é–“ã®è¨ˆç®—ã‹ã‚‰é™¤å¤–ã§ãã¾ã™ã€‚<br>
        ä¼‘æ†©æ™‚é–“ã¯è¤‡æ•°è¨­å®šã§ãã¾ã™ã€‚æ—¥ã‚’ã¾ãŸãè¨­å®šï¼ˆå¤œå‹¤ï¼‰ã‚‚å¯èƒ½ã§ã™ã€‚<br>
        <strong>ğŸ’¾ è¨­å®šã¯Firebaseã«ä¿å­˜ã•ã‚Œã€ãƒãƒ¼ãƒ å…¨ä½“ã§å…±æœ‰ã•ã‚Œã¾ã™ã€‚</strong>
      </div>

      <div id="settingsMsg"></div>

      <div style="margin-bottom:24px;">
        <h2>ç¨¼åƒæ›œæ—¥</h2>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
            <input type="checkbox" id="day0" value="0" />
            <span>æ—¥æ›œæ—¥</span>
          </label>
          <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
            <input type="checkbox" id="day1" value="1" checked />
            <span>æœˆæ›œæ—¥</span>
          </label>
          <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
            <input type="checkbox" id="day2" value="2" checked />
            <span>ç«æ›œæ—¥</span>
          </label>
          <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
            <input type="checkbox" id="day3" value="3" checked />
            <span>æ°´æ›œæ—¥</span>
          </label>
          <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
            <input type="checkbox" id="day4" value="4" checked />
            <span>æœ¨æ›œæ—¥</span>
          </label>
          <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
            <input type="checkbox" id="day5" value="5" checked />
            <span>é‡‘æ›œæ—¥</span>
          </label>
          <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
            <input type="checkbox" id="day6" value="6" />
            <span>åœŸæ›œæ—¥</span>
          </label>
        </div>
      </div>

      <div style="margin-bottom:24px;">
        <h2>ç¨¼åƒæ™‚é–“å¸¯</h2>
        <div style="display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); max-width:800px;">
          <div>
            <label for="workStartTime">é–‹å§‹æ™‚åˆ»</label>
            <input type="time" id="workStartTime" value="08:00" />
          </div>
          <div>
            <label for="workEndTime">çµ‚äº†æ™‚åˆ»</label>
            <input type="time" id="workEndTime" value="17:00" />
          </div>
        </div>
      </div>

      <div style="margin-bottom:24px;">
        <h2>ä¼‘æ†©æ™‚é–“</h2>
        <div id="breaksContainer"></div>
        <button id="btnAddBreak" style="margin-top:12px;">â• ä¼‘æ†©æ™‚é–“ã‚’è¿½åŠ </button>
      </div>

      <div style="margin-bottom:24px;">
        <h2>åœæ­¢åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯</h2>

        <div class="note" style="margin-bottom:12px;">
          <strong>ğŸ›‘ åœæ­¢åˆ¤å®šã«ã¤ã„ã¦</strong><br>
          ã€Œå‰å›ã®èª­ã¿å–ã‚Šã‹ã‚‰ä½•åˆ†ä»¥ä¸Šç©ºã„ãŸã‚‰åœæ­¢ã¨ã¿ãªã™ã‹ã€ç­‰ã‚’è¨­å®šã§ãã¾ã™ã€‚<br>
          è¨­å®šã¯Firebaseã«ä¿å­˜ã•ã‚Œã€ãƒãƒ¼ãƒ å…¨ä½“ã§å…±æœ‰ã•ã‚Œã¾ã™ã€‚
        </div>

        <div style="display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr)); max-width:900px;">
          <div>
            <label for="stopThresholdMin">åœæ­¢åˆ¤å®šã—ãã„å€¤ï¼ˆåˆ†ï¼‰</label>
            <input id="stopThresholdMin" type="number" min="1" step="1" value="15" />
            <div class="small">ä¾‹ï¼š15 â†’ 15åˆ†ä»¥ä¸Šç©ºãã¨åœæ­¢</div>
          </div>

          <div>
            <label for="changeoverHardTimeoutMin">å“ç•ªåˆ‡æ›¿ï¼ˆåŸºæº–/ç…§åˆå¾…ã¡ï¼‰æœ€å¤§ç¶™ç¶šï¼ˆåˆ†ï¼‰</label>
            <input id="changeoverHardTimeoutMin" type="number" min="1" step="1" value="60" />
            <div class="small">åˆ‡æ›¿ã‚·ã‚°ãƒŠãƒ«å¾Œã€ã“ã“ã‚’è¶…ãˆã‚‹ã¨é€šå¸¸åˆ¤å®šã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯</div>
          </div>

          <div>
            <label for="verifyWindowMin">ã€Œç”Ÿç”£ä¸­ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯åˆ¤å®šï¼ˆåˆ†ï¼‰</label>
            <input id="verifyWindowMin" type="number" min="1" step="1" value="30" />
            <div class="small">ç›´è¿‘ãƒ­ã‚°ã‹ã‚‰ã“ã®åˆ†ä»¥å†…ãªã‚‰ç”Ÿç”£ä¸­æ‰±ã„ï¼ˆä¿é™ºï¼‰</div>
          </div>
        </div>

        <div class="right" style="margin-top:12px;">
          <button id="btnSaveStopLogic" class="primary">ğŸ’¾ åœæ­¢åˆ¤å®šã‚’ä¿å­˜</button>
        </div>
      </div>

      <div class="right">
        <button id="btnSaveSettings" class="primary">ğŸ’¾ ç¨¼åƒæ™‚é–“è¨­å®šã‚’ä¿å­˜</button>
      </div>
    </section>
  </div>

  <div class="tab-content" id="manual">
    <section class="panel">
      <h1 style="font-size:24px; margin:0 0 24px 0; color:var(--accent);">ğŸ“– ç”Ÿç”£å®Ÿç¸¾ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</h1>
      <div class="note">
        <strong>åœæ­¢æ™‚é–“ã®å®šç¾©</strong><br>
        é€£ç¶šç”Ÿç”£ä¸­ã«ã€å‰å›ã®QRèª­ã¿å–ã‚Šã‹ã‚‰ã€Œåœæ­¢åˆ¤å®šã—ãã„å€¤ï¼ˆåˆ†ï¼‰ã€ä»¥ä¸Šç©ºã„ãŸå ´åˆã«åœæ­¢ã¨ã¿ãªã—ã¾ã™ã€‚<br>
        ç¨¼åƒæ™‚é–“å¤–/ä¼‘æ†©ã¯é™¤å¤–ã•ã‚Œã¾ã™ï¼ˆè¨­å®šã‚¿ãƒ–å‚ç…§ï¼‰ã€‚
      </div>
      <div class="note">
        <strong>ã‹ã‚“ã°ã‚“v2ã¨ã®é€£æº</strong><br>
        å„ãƒ©ã‚¤ãƒ³ã§ã‹ã‚“ã°ã‚“v2ï¼ˆQRç…§åˆç«¯æœ«ï¼‰ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€ãã“ã§è¨­å®šã•ã‚ŒãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒè‡ªå‹•çš„ã«åæ˜ ã•ã‚Œã¾ã™ã€‚<br>
        ã‹ã‚“ã°ã‚“v2ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒãªã„å ´åˆã¯ã€QRãƒ­ã‚°ã‹ã‚‰è‡ªå‹•åˆ¤å®šã—ãŸçŠ¶æ…‹ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
      </div>
      <div class="small">â€»ã“ã®ç”»é¢ã¯å¿…è¦ã«å¿œã˜ã¦è¿½è¨˜ã—ã¦ãã ã•ã„ã€‚</div>
    </section>
  </div>

</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, collection, query, orderBy, limit, getDocs, startAfter,
    doc, setDoc, deleteDoc, getDoc, onSnapshot, where
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAOMRoojKv9Hnh3OjVGwYV_k1LBTGOKepY",
    authDomain: "miyamaunitec-fb87a.firebaseapp.com",
    databaseURL: "https://miyamaunitec-fb87a-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "miyamaunitec-fb87a",
    storageBucket: "miyamaunitec-fb87a.firebasestorage.app",
    messagingSenderId: "495316649507",
    appId: "1:495316649507:web:1f98ee3dd851474fa39396",
    measurementId: "G-1NXD8ZPGNR"
  };

  const fbStatus = document.getElementById("fbStatus");
  const tbody = document.getElementById("tbody");
  const masterTbody = document.getElementById("masterTbody");
  const masterMsg = document.getElementById("masterMsg");
  const settingsMsg = document.getElementById("settingsMsg");
  const btnExport = document.getElementById("btnExport");
  const btnReload = document.getElementById("btnReload");
  const btnApply = document.getElementById("btnApply");
  const btnPrev = document.getElementById("btnPrev");
  const btnNext = document.getElementById("btnNext");
  const pageInfo = document.getElementById("pageInfo");
  const errEl = document.getElementById("err");
  const countEl = document.getElementById("count");

  const lineSel = document.getElementById("lineSel");
  const slicedSel = document.getElementById("slicedSel");
  const hourGroup = document.getElementById("hourGroup");
  const dateFrom = document.getElementById("dateFrom");
  const dateTo = document.getElementById("dateTo");
  const bushoSel = document.getElementById("bushoSel");

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  function setFbStatus(t, connected){
    fbStatus.textContent = "Firebase: " + t;
    fbStatus.className = "badge " + (connected ? "connected" : "disconnected");
  }

  try{
    await signInAnonymously(auth);
    setFbStatus("æ¥ç¶šæ¸ˆã¿", true);
  }catch(e){
    console.warn(e);
    setFbStatus("æœªæ¥ç¶š", false);
  }

  const PER_PAGE = 2000;
  const MAX_PAGES = 10;

  let currentPage = 1;
  let pageCursors = [null];
  let currentDocs = [];
  let allData = [];

  let qrMaster = {};
  let workSettings = {
    workingDays: [1,2,3,4,5],
    workStart: "08:00",
    workEnd: "17:00",
    breaks: [{ start:"12:00", end:"13:00", enabled:true }]
  };

  let stopLogic = {
    stopThresholdMin: 15,
    changeoverHardTimeoutMin: 60,
    verifyWindowMin: 30
  };

  // â˜…â˜… ã‹ã‚“ã°ã‚“v2ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  let kanbanStatusCache = {};
  let statusUnsubscribe = null;

  let charts = { timeSeries: null, stopTime: null, statusTransition: null };
  let realtimeUnsubscribe = null;
  let autoUpdateInterval = null;
  const AUTO_UPDATE_INTERVAL = 30 * 1000;

  // ã‹ã‚“ã°ã‚“v2ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°
  const KANBAN_STATUS_TEXT = {
    'NOT_STARTED': 'â¹ æœªé–‹å§‹',
    'RUNNING': 'ğŸŸ¢ ç”Ÿç”£ä¸­',
    'TRY': 'ğŸ” è©¦ã—ï¼ˆç…§åˆå¾…ã¡ï¼‰',
    'ABNORMAL_STOP': 'â›” ç•°å¸¸åœæ­¢ä¸­',
    'PLAN_STOP': 'ğŸ›‘ è¨ˆç”»åœæ­¢ä¸­',
    'MATERIAL_CHANGE': 'ğŸ“¦ ææ–™æ›¿ãˆä¸­',
    'SETUP_CHANGE': 'ğŸ”§ æ®µæ›¿ãˆä¸­'
  };

  // reasonã‚’èª­ã¿ã‚„ã™ã„ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›
  function formatReason(reason) {
    if (!reason) return '';
    
    // BTNã§çµ‚ã‚ã‚‹å ´åˆã¯å‰Šé™¤
    const cleaned = reason.replace(/_BTN$/, '');
    
    // ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«å¤‰æ›ã—ã€åˆ†ã‹ã‚Šã‚„ã™ã„æ—¥æœ¬èªã«å¤‰æ›
    const reasonMap = {
      'BACK_TO_RUNNING': 'ãƒœã‚¿ãƒ³æ“ä½œ',
      'TRY': 'ãƒˆãƒ©ã‚¤ãƒ¢ãƒ¼ãƒ‰',
      'ABNORMAL_STOP': 'ç•°å¸¸åœæ­¢',
      'PLAN_STOP': 'è¨ˆç”»åœæ­¢',
      'MATERIAL_CHANGE': 'ææ–™æ›¿ãˆ',
      'SETUP_CHANGE': 'æ®µæ›¿ãˆ',
      'MANUAL': 'æ‰‹å‹•å¤‰æ›´',
      'BASE_QR_SET': 'åŸºæº–QRè¨­å®š',
      'RESET': 'ãƒªã‚»ãƒƒãƒˆ'
    };
    
    return reasonMap[cleaned] || '';
  }

  // ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =========
  function parseClientDate(tsStr){
    if (!tsStr) return null;
    const m = tsStr.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2}):(\d{2})$/);
    if (!m) return null;
    const [_, y, mo, d, h, mi, s] = m.map(Number);
    return new Date(y, mo-1, d, h, mi, s);
  }

  function parseLogTime(r){
    if (r.ts) return parseClientDate(r.ts);
    if (r.readAt && r.readAt.seconds) return new Date(r.readAt.seconds*1000);
    return null;
  }

  function fmtHM(d){
    return d ? d.toLocaleString('ja-JP',{hour:'2-digit',minute:'2-digit'}) : '-';
  }

  function fmtAgo(fromDate){
    if (!fromDate) return "ä¸æ˜";
    const diffMs = Date.now() - fromDate.getTime();
    if (diffMs < 0) return "ã„ã¾";
    const min = Math.floor(diffMs/60000);
    if (min < 1) return "ã„ã¾";
    if (min < 60) return `${min}åˆ†å‰`;
    const h = Math.floor(min/60);
    const m = min % 60;
    if (h < 24) return `${h}æ™‚é–“${m}åˆ†å‰`;
    const d = Math.floor(h/24);
    const rh = h % 24;
    return `${d}æ—¥${rh}æ™‚é–“å‰`;
  }

  function uniqueSorted(values){
    return Array.from(new Set(values.filter(v => v != null && v !== ""))).sort((a,b)=>{
      const sa=String(a), sb=String(b);
      return sa.localeCompare(sb,"ja");
    });
  }

  function populateSelectors(data){
    const lines = uniqueSorted(data.map(r => r.line || ""));
    const sliced = uniqueSorted(data.map(r => r.sliced || ""));

    const fill = (sel, arr) => {
      const cur = sel.value;
      sel.innerHTML = "<option value=''>ã™ã¹ã¦</option>" + arr.map(v => `<option value="${String(v).replace(/"/g,'&quot;')}">${v}</option>`).join("");
      if (cur && arr.includes(cur)) sel.value = cur;
    };
    fill(lineSel, lines);
    fill(slicedSel, sliced);
  }

  function getBusho(row){
    return row.busho || row.dept || row.department || "";
  }

  function getQuantity(sliced){
    return qrMaster[sliced] || 1;
  }

  // ========= ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ =========
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
    });
  });

  // ========= ãƒã‚¹ã‚¿ï¼ˆqrMasterï¼‰ =========
  function showMasterMsg(msg, type){
    masterMsg.className = 'msg-box ' + type;
    masterMsg.textContent = msg;
    masterMsg.style.display = 'block';
    setTimeout(()=>{ masterMsg.style.display='none'; }, 4000);
  }

  function renderMasterTable(){
    masterTbody.innerHTML = '';
    const entries = Object.entries(qrMaster).sort((a,b)=>a[0].localeCompare(b[0],'ja'));

    if (!entries.length){
      masterTbody.innerHTML = '<tr><td colspan="3" class="center small" style="padding:40px; color:var(--muted);">ãƒã‚¹ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>';
    }

    entries.forEach(([product, qty]) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${product}</strong></td>
        <td class="center"><strong style="font-size:16px;">${qty}</strong></td>
        <td class="center"><button class="danger" data-product="${product}">ğŸ—‘ï¸ å‰Šé™¤</button></td>
      `;
      tr.querySelector('button').addEventListener('click', async ()=>{
        if (!confirm(`å“ç•ªã€Œ${product}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        const ok = await deleteMasterFromFirestore(product);
        if (ok){
          delete qrMaster[product];
          renderMasterTable();
          updateDashboard();
          showMasterMsg('å‰Šé™¤ã—ã¾ã—ãŸï¼ˆFirebaseåŒæœŸæ¸ˆã¿ï¼‰','success');
        }else{
          showMasterMsg('Firebaseã‹ã‚‰ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ','error');
        }
      });
      masterTbody.appendChild(tr);
    });

    document.getElementById('registeredMaster').textContent = entries.length;
  }

  async function loadMasterFromFirestore(){
    try{
      const masterCol = collection(db, "qrMaster");
      const masterSnap = await getDocs(masterCol);
      qrMaster = {};
      masterSnap.forEach(d=>{
        const data = d.data();
        qrMaster[d.id] = data.quantity || 1;
      });
      renderMasterTable();
      showMasterMsg(`${Object.keys(qrMaster).length}ä»¶ã®ãƒã‚¹ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success');
    }catch(e){
      console.warn("ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
      showMasterMsg('ãƒã‚¹ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
  }

  async function saveMasterToFirestore(product, quantity){
    try{
      const docRef = doc(db, "qrMaster", product);
      await setDoc(docRef, { quantity, updatedAt: new Date() }, { merge:true });
      return true;
    }catch(e){
      console.warn("ãƒã‚¹ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
      return false;
    }
  }

  async function deleteMasterFromFirestore(product){
    try{
      const docRef = doc(db, "qrMaster", product);
      await deleteDoc(docRef);
      return true;
    }catch(e){
      console.warn("ãƒã‚¹ã‚¿å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", e);
      return false;
    }
  }

  document.getElementById('btnAddMaster').addEventListener('click', async ()=>{
    const product = prompt('å“ç•ªï¼ˆåˆ‡ã‚Šå‡ºã—å€¤ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
    if (!product || product.trim()==='') return;
    const qty = prompt('1å›ã®èª­ã¿å–ã‚Šã‚ãŸã‚Šã®ç”Ÿç”£å€‹æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', '1');
    if (qty === null) return;
    const qtyNum = parseInt(qty, 10);
    if (isNaN(qtyNum) || qtyNum < 1){
      alert('å€‹æ•°ã¯1ä»¥ä¸Šã®æ•´æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    const key = product.trim();
    qrMaster[key] = qtyNum;
    const saved = await saveMasterToFirestore(key, qtyNum);
    if (saved){
      renderMasterTable();
      updateDashboard();
      showMasterMsg('ç™»éŒ²ã—ã¾ã—ãŸï¼ˆFirebaseåŒæœŸæ¸ˆã¿ï¼‰','success');
    }else{
      delete qrMaster[key];
      showMasterMsg('Firebaseã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ','error');
    }
  });

  document.getElementById('btnReloadMaster').addEventListener('click', async ()=>{
    await loadMasterFromFirestore();
    updateDashboard();
  });

  document.getElementById('btnExportMaster').addEventListener('click', ()=>{
    const rows = [['å“ç•ª','ç”Ÿç”£å€‹æ•°']];
    Object.entries(qrMaster).sort((a,b)=>a[0].localeCompare(b[0],'ja')).forEach(([p,q])=>rows.push([p,q]));
    const csv = rows.map(r=>r.map(f=>{
      const s = String(f ?? "");
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(",")).join("\n");
    const blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `qr_master.csv`; a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById('btnImportMaster').addEventListener('click', ()=>{
    document.getElementById('fileImportMaster').click();
  });

  document.getElementById('fileImportMaster').addEventListener('change', async (e)=>{
    const file = e.target.files[0];
    if (!file) return;

    try{
      const text = await file.text();
      const lines = text.replace(/^\uFEFF/,'').split('\n').map(l=>l.trim()).filter(l=>l);

      let imported = 0, failed = 0;
      for (let i=1;i<lines.length;i++){
        const parts = lines[i].split(',').map(p=>p.replace(/^"|"$/g,'').trim());
        if (parts.length >= 2){
          const product = parts[0];
          const qty = parseInt(parts[1], 10);
          if (product && !isNaN(qty) && qty > 0){
            qrMaster[product] = qty;
            const ok = await saveMasterToFirestore(product, qty);
            if (ok) imported++; else failed++;
          }
        }
      }
      renderMasterTable();
      updateDashboard();
      if (failed>0) showMasterMsg(`${imported}ä»¶å–è¾¼ã€${failed}ä»¶å¤±æ•—ï¼ˆFirebaseåŒæœŸã‚¨ãƒ©ãƒ¼ï¼‰`,'error');
      else showMasterMsg(`${imported}ä»¶ã®ãƒã‚¹ã‚¿ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸï¼ˆFirebaseåŒæœŸæ¸ˆã¿ï¼‰`,'success');
    }catch(err){
      console.error(err);
      showMasterMsg('CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ','error');
    }
    e.target.value = '';
  });

  // ========= ç¨¼åƒæ™‚é–“è¨­å®š =========
  function showSettingsMsg(msg, type){
    settingsMsg.className = 'msg-box ' + type;
    settingsMsg.textContent = msg;
    settingsMsg.style.display = 'block';
    setTimeout(()=>{ settingsMsg.style.display='none'; }, 4000);
  }

  function renderBreaksUI(){
    const container = document.getElementById('breaksContainer');
    container.innerHTML = '';

    workSettings.breaks.forEach((breakTime, index)=>{
      const breakDiv = document.createElement('div');
      breakDiv.style.cssText = 'display:flex; gap:12px; align-items:end; margin-bottom:12px; padding:12px; background:#f9fafb; border-radius:10px;';
      breakDiv.innerHTML = `
        <div style="flex:1;">
          <label style="font-size:12px; font-weight:600; color:var(--muted); display:block; margin-bottom:6px;">é–‹å§‹æ™‚åˆ»</label>
          <input type="time" class="break-start" data-index="${index}" value="${breakTime.start}" style="width:100%;" />
        </div>
        <div style="flex:1;">
          <label style="font-size:12px; font-weight:600; color:var(--muted); display:block; margin-bottom:6px;">çµ‚äº†æ™‚åˆ»</label>
          <input type="time" class="break-end" data-index="${index}" value="${breakTime.end}" style="width:100%;" />
        </div>
        <label style="display:flex; align-items:center; gap:6px; cursor:pointer; white-space:nowrap;">
          <input type="checkbox" class="break-enabled" data-index="${index}" ${breakTime.enabled ? 'checked' : ''} />
          <span>æœ‰åŠ¹</span>
        </label>
        <button class="danger btn-remove-break" data-index="${index}" style="white-space:nowrap;">ğŸ—‘ï¸ å‰Šé™¤</button>
      `;
      container.appendChild(breakDiv);
    });

    container.querySelectorAll('.break-start').forEach(input=>{
      input.addEventListener('change', (e)=>{
        const idx = parseInt(e.target.dataset.index, 10);
        workSettings.breaks[idx].start = e.target.value;
      });
    });
    container.querySelectorAll('.break-end').forEach(input=>{
      input.addEventListener('change', (e)=>{
        const idx = parseInt(e.target.dataset.index, 10);
        workSettings.breaks[idx].end = e.target.value;
      });
    });
    container.querySelectorAll('.break-enabled').forEach(input=>{
      input.addEventListener('change', (e)=>{
        const idx = parseInt(e.target.dataset.index, 10);
        workSettings.breaks[idx].enabled = e.target.checked;
      });
    });
    container.querySelectorAll('.btn-remove-break').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const idx = parseInt(e.target.dataset.index, 10);
        workSettings.breaks.splice(idx, 1);
        renderBreaksUI();
      });
    });
  }

  function applyWorkSettingsToUI(){
    for (let i=0;i<=6;i++){
      const checkbox = document.getElementById(`day${i}`);
      if (checkbox) checkbox.checked = workSettings.workingDays.includes(i);
    }
    document.getElementById('workStartTime').value = workSettings.workStart;
    document.getElementById('workEndTime').value = workSettings.workEnd;
    renderBreaksUI();
  }

  function readWorkSettingsFromUI(){
    const workingDays = [];
    for (let i=0;i<=6;i++){
      const checkbox = document.getElementById(`day${i}`);
      if (checkbox && checkbox.checked) workingDays.push(i);
    }
    workSettings.workingDays = workingDays;
    workSettings.workStart = document.getElementById('workStartTime').value;
    workSettings.workEnd = document.getElementById('workEndTime').value;
  }

  async function loadWorkSettings(){
    try{
      const docRef = doc(db, "settings", "workSchedule");
      const snap = await getDoc(docRef);
      if (snap.exists()){
        const data = snap.data();
        workSettings = {
          workingDays: data.workingDays || [1,2,3,4,5],
          workStart: data.workStart || "08:00",
          workEnd: data.workEnd || "17:00",
          breaks: data.breaks || [{start:"12:00", end:"13:00", enabled:true}]
        };
      }
      applyWorkSettingsToUI();
      showSettingsMsg('ç¨¼åƒæ™‚é–“è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ','success');
    }catch(e){
      console.warn("è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
      applyWorkSettingsToUI();
    }
  }

  async function saveWorkSettings(){
    try{
      const docRef = doc(db, "settings", "workSchedule");
      await setDoc(docRef, { ...workSettings, updatedAt:new Date() }, { merge:true });
      return true;
    }catch(e){
      console.warn("è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
      return false;
    }
  }

  document.getElementById('btnAddBreak').addEventListener('click', ()=>{
    workSettings.breaks.push({ start:"15:00", end:"15:15", enabled:true });
    renderBreaksUI();
  });

  document.getElementById('btnSaveSettings').addEventListener('click', async ()=>{
    readWorkSettingsFromUI();
    const ok = await saveWorkSettings();
    if (ok){
      showSettingsMsg('ç¨¼åƒæ™‚é–“è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆFirebaseåŒæœŸæ¸ˆã¿ï¼‰','success');
      updateDashboard();
    }else{
      showSettingsMsg('ç¨¼åƒæ™‚é–“è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ','error');
    }
  });

  // ========= åœæ­¢åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆUI/Firestoreï¼‰ =========
  function applyStopLogicToUI(){
    const a = document.getElementById('stopThresholdMin');
    const b = document.getElementById('changeoverHardTimeoutMin');
    const c = document.getElementById('verifyWindowMin');
    if (!a || !b || !c) return;
    a.value = stopLogic.stopThresholdMin ?? 15;
    b.value = stopLogic.changeoverHardTimeoutMin ?? 60;
    c.value = stopLogic.verifyWindowMin ?? 30;
  }

  function readStopLogicFromUI(){
    const a = document.getElementById('stopThresholdMin');
    const b = document.getElementById('changeoverHardTimeoutMin');
    const c = document.getElementById('verifyWindowMin');
    const st = Math.max(1, parseInt(a?.value || '15', 10));
    const ch = Math.max(1, parseInt(b?.value || '60', 10));
    const vw = Math.max(1, parseInt(c?.value || '30', 10));
    stopLogic.stopThresholdMin = st;
    stopLogic.changeoverHardTimeoutMin = ch;
    stopLogic.verifyWindowMin = vw;
  }

  async function loadStopLogic(){
    try{
      const docRef = doc(db, "settings", "stopLogic");
      const snap = await getDoc(docRef);
      if (snap.exists()){
        const data = snap.data();
        stopLogic = {
          stopThresholdMin: data.stopThresholdMin ?? 15,
          changeoverHardTimeoutMin: data.changeoverHardTimeoutMin ?? 60,
          verifyWindowMin: data.verifyWindowMin ?? 30
        };
      }
      applyStopLogicToUI();
      showSettingsMsg('åœæ­¢åˆ¤å®šè¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ','success');
    }catch(e){
      console.warn("åœæ­¢åˆ¤å®šè¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
      applyStopLogicToUI();
    }
  }

  async function saveStopLogic(){
    try{
      const docRef = doc(db, "settings", "stopLogic");
      await setDoc(docRef, { ...stopLogic, updatedAt:new Date() }, { merge:true });
      return true;
    }catch(e){
      console.warn("åœæ­¢åˆ¤å®šè¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
      return false;
    }
  }

  document.getElementById('btnSaveStopLogic').addEventListener('click', async ()=>{
    readStopLogicFromUI();
    const ok = await saveStopLogic();
    if (ok){
      showSettingsMsg('åœæ­¢åˆ¤å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆFirebaseåŒæœŸæ¸ˆã¿ï¼‰','success');
      updateDashboard();
    }else{
      showSettingsMsg('åœæ­¢åˆ¤å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ','error');
    }
  });

  // ========= ç¨¼åƒæ™‚é–“åˆ¤å®šï¼ˆä¼‘æ†©å«ã‚€ãƒ»æ—¥è·¨ãå¯¾å¿œï¼‰ =========
  function isWorkingTime(date){
    const day = date.getDay();
    if (!workSettings.workingDays.includes(day)) return false;

    const timeStr = `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
    const startTime = workSettings.workStart;
    const endTime   = workSettings.workEnd;
    const crossesMidnight = startTime > endTime;

    if (crossesMidnight){
      if (timeStr < startTime && timeStr >= endTime) return false;
    }else{
      if (timeStr < startTime || timeStr >= endTime) return false;
    }

    for (const breakTime of workSettings.breaks){
      if (!breakTime.enabled) continue;
      const bs = breakTime.start;
      const be = breakTime.end;
      const brCross = bs > be;
      if (brCross){
        if (timeStr >= bs || timeStr < be) return false;
      }else{
        if (timeStr >= bs && timeStr < be) return false;
      }
    }
    return true;
  }

  function calculateNonWorkingMinutes(startTime, endTime){
    let nonWorkingMinutes = 0;
    const current = new Date(startTime);
    while (current < endTime){
      if (!isWorkingTime(current)) nonWorkingMinutes++;
      current.setMinutes(current.getMinutes()+1);
    }
    return nonWorkingMinutes;
  }

  function extractState(r){
    const candidates = [r.state, r.status, r.phase, r.mode, r.step, r.judge, r.result, r.flag, r.tag, r.kind, r.type, r.note, r.message, r.msg];
    return (candidates.filter(Boolean).join(' ') || '').toLowerCase();
  }
  function isVerifyingState(r){
    const s = extractState(r);
    return /(ç…§åˆ|verify|verifying|checking|compare|æ¯”è¼ƒ)/.test(s);
  }
  function isBaseState(r){
    const s = extractState(r);
    return /(åŸºæº–|base|åŸºæº–qr)/.test(s);
  }
  function isChangeoverStart(r){
    const s = extractState(r);
    return /(åŸºæº–\s*qr?|æ®µå–|æ®µå–ã‚Š|åˆ‡æ›¿|åˆ‡ã‚Šæ›¿ãˆ|changeover|setup|set[-\s]*up)/.test(s);
  }

  function buildLineSessions(data){
    const lineMap = {};
    const rows = data
      .filter(r => (r.judge || r.result || '') === 'OK')
      .map(r => ({...r, _time: parseLogTime(r)}))
      .filter(r => r._time);

    const byLine = {};
    rows.forEach(r=>{
      const line = r.line || 'ä¸æ˜';
      if(!byLine[line]) byLine[line] = [];
      byLine[line].push(r);
    });
    Object.keys(byLine).forEach(line => byLine[line].sort((a,b)=>a._time - b._time));

    Object.keys(byLine).forEach(line=>{
      const list = byLine[line];
      const sessions = [];
      let cur = null;

      let seenVerifyFlow = false;

      for (let i=0;i<list.length;i++){
        const r = list[i];
        const product = r.sliced || 'ä¸æ˜';

        if (!cur){
          cur = { product, start:r._time, last:r._time };
          seenVerifyFlow = isBaseState(r);
          continue;
        }

        if (product !== cur.product){
          sessions.push({ product:cur.product, start:cur.start, end:cur.last });
          cur = { product, start:r._time, last:r._time };
          seenVerifyFlow = isBaseState(r);
          continue;
        }

        cur.last = r._time;
        if (isVerifyingState(r)) seenVerifyFlow = true;
      }

      if (cur) sessions.push({ product:cur.product, start:cur.start, end:cur.last });

      let currentProduct = null;
      let active = null;
      if (list.length){
        const last = list[list.length-1];
        const minutesFromLast = (Date.now() - last._time.getTime())/60000;
        const fallbackActive = minutesFromLast <= (stopLogic.verifyWindowMin ?? 30);
        if (seenVerifyFlow || fallbackActive){
          currentProduct = last.sliced || 'ä¸æ˜';
          active = { product: currentProduct, start: sessions.length ? sessions[sessions.length-1].start : last._time, last:last._time };
        }
      }

      lineMap[line] = { sessions, active, currentProduct };
    });

    return lineMap;
  }

  function getCurrentLineStatusGlobal(recordsForLine){
    if (!recordsForLine || recordsForLine.length === 0) return {state:'idle', lastReadAt:null, elapsedText:'ãƒ‡ãƒ¼ã‚¿ãªã—'};

    const list = [...recordsForLine]
      .map(r => ({...r, _t: parseLogTime(r)}))
      .filter(r => r._t)
      .sort((a,b)=>a._t - b._t);

    if (!list.length) return {state:'idle', lastReadAt:null, elapsedText:'ãƒ‡ãƒ¼ã‚¿ãªã—'};

    const now = new Date();
    const inWorking = isWorkingTime(now);

    // â˜… æœ€çµ‚èª­ã¿å–ã‚Šï¼ˆOK/NGå«ã‚€å…¨ã¦ï¼‰
    const lastAny = list[list.length-1];
    const lastReadAt = lastAny._t;
    const elapsedText = fmtAgo(lastReadAt);

    const okList = list.filter(r => (r.judge || r.result || '') === 'OK');
    const lastOK = okList[okList.length-1] || null;
    const lastOKTime = lastOK?._t || null;

    const changeSignals = list.filter(r => isChangeoverStart(r) || isVerifyingState(r) || isBaseState(r));
    const lastChange = changeSignals.length ? changeSignals[changeSignals.length-1] : null;
    const lastChangeTime = lastChange?._t || null;

    const threshold = stopLogic.stopThresholdMin ?? 15;
    const CHANGEOVER_HARD_TIMEOUT_MIN = stopLogic.changeoverHardTimeoutMin ?? 60;

    const minutesSince = (ref)=> ref ? (now - ref)/60000 : Infinity;

    // ç¨¼åƒå¤–åˆ¤å®š
    if (!inWorking){
      return { state:'idle', lastReadAt, elapsedText, reason:'ç¨¼åƒå¤–' };
    }

    // â˜… æœ€çµ‚èª­ã¿å–ã‚Šï¼ˆOK/NGå«ã‚€ï¼‰ã‹ã‚‰ã®çµŒéæ™‚é–“ã§åœæ­¢åˆ¤å®š
    const minutesFromLastRead = minutesSince(lastReadAt);
    if (minutesFromLastRead >= threshold){
      // å“ç•ªåˆ‡æ›¿ã‹ã©ã†ã‹åˆ¤å®šï¼ˆç›´è¿‘2ã¤ã®OKã‚’æ¯”è¼ƒï¼‰
      const last2OK = okList[okList.length-2] || null;
      const reason = (lastOK && last2OK && (last2OK.sliced||'') !== (lastOK.sliced||'')) ? 'å“ç•ªåˆ‡æ›¿' : 'èª­è¾¼ç„¡ã—';
      return { state:'stopped', reason, since:lastReadAt, lastReadAt, elapsedText };
    }

    // å“ç•ªåˆ‡æ›¿ã‚·ã‚°ãƒŠãƒ«ã®å‡¦ç†
    if (lastChangeTime && (!lastOKTime || lastChangeTime > lastOKTime)){
      if (minutesSince(lastChangeTime) < CHANGEOVER_HARD_TIMEOUT_MIN){
        return { state:'stopped', reason:'å“ç•ªåˆ‡æ›¿', since:lastChangeTime, lastReadAt, elapsedText };
      }
    }

    // OKãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
    if (!lastOKTime){
      return { state:'idle', lastReadAt, elapsedText, reason:'OKãƒ‡ãƒ¼ã‚¿ãªã—' };
    }

    // ç”Ÿç”£ä¸­
    return { state:'active', product:(lastOK.sliced||'ä¸æ˜'), since:lastOKTime, lastReadAt, elapsedText };
  }

  function getFilteredData(){
    const fLine   = lineSel.value.trim();
    const fSliced = slicedSel.value.trim();
    const fBusho  = bushoSel.value.trim();

    let fromDate = null, toDate = null;
    if (dateFrom.value) fromDate = new Date(dateFrom.value + "T00:00:00");
    if (dateTo.value)   toDate   = new Date(dateTo.value   + "T23:59:59");

    const filtered = allData.filter(r=>{
      const judge = r.judge || r.result || "";
      if (judge !== "OK") return false;

      if (fLine   && r.line   !== fLine) return false;
      if (fSliced && r.sliced !== fSliced) return false;
      if (fBusho && getBusho(r) !== fBusho) return false;

      let dt = parseLogTime(r);
      if (!dt) return false;
      if (fromDate && dt < fromDate) return false;
      if (toDate && dt > toDate) return false;
      return true;
    });

    return filtered;
  }

  function calculateStopTime(data){
    const threshold = stopLogic.stopThresholdMin ?? 15;

    const lineData = {};
    data.forEach(r=>{
      const dt = parseLogTime(r);
      if (!dt) return;
      const line = r.line || "ä¸æ˜";
      const product = r.sliced || "";
      if (!lineData[line]) lineData[line] = [];
      lineData[line].push({ time: dt, product });
    });

    const stopTimeByLine = {};
    const stopDetails = [];
    let totalStopMinutes = 0;

    Object.keys(lineData).forEach(line=>{
      const records = lineData[line].sort((a,b)=>a.time-b.time);
      let stopMinutes = 0;

      for (let i=1;i<records.length;i++){
        const prev = records[i-1];
        const curr = records[i];
        const totalDiffMinutes = (curr.time - prev.time) / 60000;

        if (totalDiffMinutes >= threshold){
          const nonWorkingMinutes = calculateNonWorkingMinutes(prev.time, curr.time);
          const actualStopMinutes = totalDiffMinutes - nonWorkingMinutes;

          if (actualStopMinutes >= threshold){
            stopMinutes += actualStopMinutes;
            stopDetails.push({
              line,
              product: (prev.product !== curr.product) ? `${prev.product}â†’${curr.product}` : prev.product,
              startTime: prev.time,
              endTime: curr.time,
              stopMinutes: actualStopMinutes,
              nonWorkingMinutes,
              reason: (prev.product !== curr.product) ? "å“ç•ªåˆ‡æ›¿" : "é€šå¸¸åœæ­¢"
            });
          }
        }
      }

      stopTimeByLine[line] = stopMinutes;
      totalStopMinutes += stopMinutes;
    });

    return { stopTimeByLine, totalStopMinutes, stopDetails };
  }

  function updateDashboard(){
    const filtered = getFilteredData();
    const { stopTimeByLine, stopDetails } = calculateStopTime(filtered);

    updateLineSummaryCards(filtered, stopTimeByLine);
    updateStopDetailTable(stopDetails);
    updateStopTimeChart(stopTimeByLine);
    updateTimeSeriesChart(filtered);
    updateStatusTransitionChart(); // â˜… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
  }

 // â˜…â˜… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®æç”»ï¼ˆç©ã¿ä¸Šã’æ¨ªæ£’ã€æ™‚åˆ»è»¸ï¼‰
async function updateStatusTransitionChart() {
  try {
    const fromDate = dateFrom.value ? new Date(dateFrom.value + "T00:00:00") : null;
    const toDate   = dateTo.value   ? new Date(dateTo.value   + "T23:59:59") : null;
    if (!fromDate || !toDate) return;

    // 8:00ï½ç¿Œ5:00ã®ç¯„å›²ã‚’è¨­å®š
    const startMs = new Date(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate(), 8, 0, 0).getTime();
    const endMs   = new Date(toDate.getFullYear(),   toDate.getMonth(),   toDate.getDate() + 1, 5, 0, 0).getTime();

    // â˜…è¿½åŠ ï¼šæœªæ¥ã¾ã§ã€Œå®Ÿç¸¾ã€ã‚’æã‹ãªã„ï¼ˆä»Šæ—¥ã‚’å«ã‚€å ´åˆã¯â€œä»Šâ€ã§æ­¢ã‚ã‚‹ï¼‰
    const nowMs = Date.now();
    const effectiveEndMs = Math.min(endMs, nowMs);

    const colRef = collection(db, "prodStatusLogs");
    const qRef = query(
      colRef,
      where("tsMs", ">=", startMs),
      where("tsMs", "<=", effectiveEndMs),
      orderBy("tsMs", "asc")
    );

    const snapshot = await getDocs(qRef);
    const logs = [];
    snapshot.forEach(doc => logs.push(doc.data()));

    if (logs.length === 0) {
      if (charts.statusTransition) {
        charts.statusTransition.destroy();
        charts.statusTransition = null;
      }
      return;
    }



      // ãƒ©ã‚¤ãƒ³åˆ¥ã«ãƒ­ã‚°ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const lineData = {};
      logs.forEach(log => {
        const line = log.line || 'ä¸æ˜';
        if (line === 'ä¸æ˜' || !line) return;
        
        if (!lineData[line]) lineData[line] = [];
        lineData[line].push(log);
      });

      const lines = Object.keys(lineData).sort((a,b) => a.localeCompare(b, 'ja'));
      
      if (lines.length === 0) {
        if (charts.statusTransition) {
          charts.statusTransition.destroy();
          charts.statusTransition = null;
        }
        return;
      }

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‰²è¨­å®š

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‰²è¨­å®šï¼ˆâ˜…ã“ã‚Œ1å›ã ã‘ï¼‰
const statusColors = {
  __SPACER__: 'rgba(0,0,0,0)',
  RUNNING: '#059669',
  TRY: '#d97706',
  ABNORMAL_STOP: '#dc2626',
  PLAN_STOP: '#ea580c',
  MATERIAL_CHANGE: '#7c3aed',
  SETUP_CHANGE: '#0891b2',
  NOT_STARTED: '#6b7280'
};

// å„ãƒ©ã‚¤ãƒ³ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æœŸé–“ã‚’è¨ˆç®—ã—ã¦ã€ç©ã¿ä¸Šã’ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
const datasets = [];
const allPeriods = []; // ãƒ©ãƒ™ãƒ«è¡¨ç¤ºç”¨ï¼ˆã“ã®é…åˆ—ã«ã‚¹ãƒšãƒ¼ã‚µãƒ¼ã¯å…¥ã‚Œãªã„ï¼‰

lines.forEach((line, lineIndex) => {
  const lineLogs = lineData[line] || [];
  if (lineLogs.length === 0) return;

  // â˜… 8:00â†’æœ€åˆã®ãƒ­ã‚°é–‹å§‹ã¾ã§ã®ã‚¹ãƒšãƒ¼ã‚µãƒ¼ï¼ˆé–‹å§‹ä½ç½®ã‚’åˆã‚ã›ã‚‹ï¼‰
  const firstTs = Math.max((lineLogs[0]?.tsMs ?? startMs), startMs);
  const offsetHours = Math.max(0, (firstTs - startMs) / 3600000);

  if (offsetHours > 0) {
    datasets.push({
      label: '',
      data: lines.map((_, idx) => (idx === lineIndex ? offsetHours : 0)),
      backgroundColor: statusColors.__SPACER__,
      borderWidth: 0,
      stack: `stack${lineIndex}`,
      statusKey: '__SPACER__',
      periodStart: startMs,
      periodEnd: firstTs,
      fullLabel: '',
      lineIndex
    });
  }

  // â†“ã“ã“ã‹ã‚‰ä¸‹ï¼ˆforãƒ«ãƒ¼ãƒ—ï¼‰ã¯ã€ä»Šã®ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã‚’ç¶šã‘ã¦OK


        // å„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æœŸé–“ã‚’è¨ˆç®—
        for (let i = 0; i < lineLogs.length; i++) {
          const log = lineLogs[i];
          const periodStart = Math.max(log.tsMs, startMs);
          const periodEnd = (i < lineLogs.length - 1)
  ? Math.min(lineLogs[i + 1].tsMs, effectiveEndMs)
  : effectiveEndMs;
          
          if (periodEnd <= periodStart) continue;
          
          const statusKey = statusKeyFromText(log.nextStatus);
          const color = statusColors[statusKey] || '#6b7280';
          const durationHours = (periodEnd - periodStart) / 3600000;
          
          // ãƒ©ãƒ™ãƒ«ã‚’ä½œæˆ
          let displayLabel = '';
          if (statusKey === 'RUNNING' && log.baseQR) {
            displayLabel = log.baseQR;
          } else {
            const shortLabels = {
              'TRY': 'è©¦',
              'ABNORMAL_STOP': 'ç•°å¸¸',
              'PLAN_STOP': 'è¨ˆç”»',
              'MATERIAL_CHANGE': 'ææ–™',
              'SETUP_CHANGE': 'æ®µæ›¿',
              'NOT_STARTED': 'æœª'
            };
            displayLabel = shortLabels[statusKey] || '';
          }
          
          // ãƒ©ãƒ™ãƒ«è¡¨ç¤ºæƒ…å ±ã‚’ä¿å­˜
          allPeriods.push({
            line: line,
            lineIndex: lineIndex,
            label: displayLabel,
            start: periodStart,
            end: periodEnd,
            duration: durationHours,
            statusKey: statusKey,
            color: color,
            product: log.baseQR || '',
            fullLabel: KANBAN_STATUS_TEXT[statusKey] || statusKey
          });
          
          datasets.push({
            label: displayLabel,
            data: Array(lines.length).fill(0).map((_, idx) => idx === lineIndex ? durationHours : 0),
            backgroundColor: color,
            borderColor: '#fff',
            borderWidth: 1,
            stack: `stack${lineIndex}`,
            statusKey: statusKey,
            product: log.baseQR || '',
            periodStart: periodStart,
            periodEnd: periodEnd,
            fullLabel: KANBAN_STATUS_TEXT[statusKey] || statusKey,
            lineIndex: lineIndex
          });
        }
      });

      if (charts.statusTransition) charts.statusTransition.destroy();
      const ctx = document.getElementById('statusTransitionChart').getContext('2d');
      
      // ãƒ©ãƒ™ãƒ«è¡¨ç¤ºãƒ—ãƒ©ã‚°ã‚¤ãƒ³
      const labelPlugin = {
        id: 'stackedBarLabels',
        afterDatasetsDraw(chart) {
          const { ctx, chartArea: { left, right, top, bottom }, scales: { x, y } } = chart;
          
          ctx.save();
          ctx.font = 'bold 12px sans-serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          
          // å„ãƒ©ã‚¤ãƒ³ã”ã¨ã«å‡¦ç†
          lines.forEach((line, lineIndex) => {
            const yPos = y.getPixelForValue(lineIndex);
            let cumulativeX = left;
            
            // ã“ã®ãƒ©ã‚¤ãƒ³ã®æœŸé–“ã‚’å–å¾—
            const linePeriods = allPeriods.filter(p => p.lineIndex === lineIndex);
            
            linePeriods.forEach(period => {
              const barWidth = (period.duration / 21) * (right - left); // 21æ™‚é–“ = 8:00-ç¿Œ5:00
              
              if (barWidth > 40 && period.label) { // ååˆ†ãªå¹…ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤º
                ctx.fillStyle = '#fff';
                ctx.fillText(period.label, cumulativeX + barWidth / 2, yPos);
              }
              if (period.statusKey === '__SPACER__') {
  cumulativeX += barWidth;
  return;
}
              cumulativeX += barWidth;
            });
          });
          
          ctx.restore();
        }
      };
      
      charts.statusTransition = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: lines,
          datasets: datasets
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                title: function(context) {
                  const line = context[0].label;
                  const dataset = context[0].dataset;
                  return `${line} - ${dataset.fullLabel}`;
                },
                label: function(context) {
                  const dataset = context.dataset;
                  const duration = context.parsed.x;
                  const durationMin = Math.round(duration * 60);
                  
                  const formatTime = (ms) => {
                    const d = new Date(ms);
                    return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                  };
                  
                  const lines = [
                    `${formatTime(dataset.periodStart)} ã€œ ${formatTime(dataset.periodEnd)}`,
                    `ç¶™ç¶šæ™‚é–“: ${durationMin}åˆ† (${duration.toFixed(2)}æ™‚é–“)`
                  ];
                  
                  // ç”Ÿç”£ä¸­ã®å ´åˆã¯å“ç•ªã‚’è¡¨ç¤º
                  if (dataset.statusKey === 'RUNNING' && dataset.product) {
                    lines.push(`å“ç•ª: ${dataset.product}`);
                  }
                  
                  return lines;
                }
              }
            }
          },
          scales: {
            x: {
              stacked: true,
              min: 0,
              max: 21, // 8:00-ç¿Œ5:00 = 21æ™‚é–“
              title: {
                display: true,
                text: 'æ™‚åˆ»ï¼ˆ8:00ã€œç¿Œ5:00ï¼‰',
                font: {
                  size: 13,
                  weight: 'bold'
                }
              },
              ticks: {
                callback: function(value) {
                  const hours = 8 + value;
                  const displayHour = hours >= 24 ? hours - 24 : hours;
                  return `${String(displayHour).padStart(2,'0')}:00`;
                },
                stepSize: 1,
                maxRotation: 0
              },
              grid: {
                color: function(context) {
                  const value = context.tick.value;
                  const hours = 8 + value;
                  // 0æ™‚ï¼ˆ16æ™‚é–“å¾Œï¼‰ã‚’å¼·èª¿
                  if (hours === 24) {
                    return '#f59e0b';
                  }
                  return '#e5e7eb';
                },
                lineWidth: function(context) {
                  const value = context.tick.value;
                  const hours = 8 + value;
                  if (hours === 24) {
                    return 3;
                  }
                  return 1;
                }
              }
            },
            y: {
              stacked: true,
              title: {
                display: true,
                text: 'ãƒ©ã‚¤ãƒ³',
                font: {
                  size: 13,
                  weight: 'bold'
                }
              },
              ticks: {
                font: {
                  size: 12,
                  weight: 'bold'
                }
              }
            }
          }
        },
        plugins: [labelPlugin]
      });

    } catch(e) {
      console.error("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»ã‚°ãƒ©ãƒ•ã‚¨ãƒ©ãƒ¼:", e);
    }
  }

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã‚­ãƒ¼ã«å¤‰æ›ï¼ˆã‹ã‚“ã°ã‚“v2ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
  function statusKeyFromText(text) {
    if(text === "ç”Ÿç”£ä¸­") return "RUNNING";
    if(text === "ãƒˆãƒ©ã‚¤ä¸­") return "TRY";
    if(text === "ç•°å¸¸åœæ­¢ä¸­") return "ABNORMAL_STOP";
    if(text === "è¨ˆç”»åœæ­¢ä¸­") return "PLAN_STOP";
    if(text === "ææ–™æ›¿ãˆä¸­") return "MATERIAL_CHANGE";
    if(text === "æ®µæ›¿ãˆä¸­") return "SETUP_CHANGE";
    return "NOT_STARTED";
  }

  // â˜…â˜… ã‹ã‚“ã°ã‚“v2ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é€£æº
  function updateLineSummaryCards(dataOKOnly, stopTimeByLine){
    const container = document.getElementById('lineSummaryCards');
    container.innerHTML = '';

    const lineProducts = {};
    dataOKOnly.forEach(r=>{
      const line = r.line || 'ä¸æ˜';
      const product = r.sliced || 'ä¸æ˜';
      if (!lineProducts[line]) lineProducts[line] = {};
      if (!lineProducts[line][product]) lineProducts[line][product] = 0;
      lineProducts[line][product] += getQuantity(r.sliced);
    });

    const sessionsByLine = buildLineSessions(dataOKOnly);

    const sortedLines = Object.keys(lineProducts).sort((a,b)=>a.localeCompare(b,'ja'));

    sortedLines.forEach(line=>{
      const products = lineProducts[line];
      const totalQty = Object.values(products).reduce((s,q)=>s+q,0);
      const stopMin = stopTimeByLine[line] || 0;

      const lineRowsAll = allData.filter(r => (r.line || 'ä¸æ˜') === line);
      const autoStatus = getCurrentLineStatusGlobal(lineRowsAll);

      // â˜…â˜… ã‹ã‚“ã°ã‚“v2ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å„ªå…ˆ
      const kanbanStatus = kanbanStatusCache[line];
      let statusClass, statusText, subText, statusSource;
      
      if (kanbanStatus && kanbanStatus.state) {
        // ã‹ã‚“ã°ã‚“v2ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã‚ã‚‹å ´åˆ
        statusClass = 'status-' + kanbanStatus.state;
        statusText = KANBAN_STATUS_TEXT[kanbanStatus.state] || kanbanStatus.stateText || kanbanStatus.state;
        
        if (kanbanStatus.product) {
          subText = `æ•´ç†No: ${kanbanStatus.product}`;
        } else {
          const formattedReason = formatReason(kanbanStatus.reason);
          subText = formattedReason ? `ï¼ˆ${formattedReason}ï¼‰` : '';
        }
        
        statusSource = '<span class="kanban-badge">ğŸ“± ã‹ã‚“ã°ã‚“é€£æº</span>';
      } else {
        // è‡ªå‹•åˆ¤å®šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆå¾“æ¥é€šã‚Šï¼‰
        const { active, sessions, currentProduct } = sessionsByLine[line] || {active:null, sessions:[], currentProduct:null};

        if (autoStatus.state === 'active'){
          statusClass = 'status-on';
          statusText = `ğŸŸ¢ ç”Ÿç”£ä¸­ï¼š${autoStatus.product || currentProduct || 'ä¸æ˜'}`;
          subText = `ï¼ˆ${fmtHM(autoStatus.since)}ã€œç¾åœ¨ï¼‰`;
        } else if (autoStatus.state === 'stopped'){
          statusClass = 'status-stop';
          const reason = autoStatus.reason === 'å“ç•ªåˆ‡æ›¿' ? 'å“ç•ªåˆ‡æ›¿' : 'èª­è¾¼ç„¡ã—';
          statusText = `â›” åœæ­¢ä¸­ï¼š${reason}`;
          subText = `ï¼ˆ${fmtHM(autoStatus.since)}ã€œç¾åœ¨ï¼‰`;
        } else {
          statusClass = 'status-off';
          statusText = `â¹ åœæ­¢ä¸­`;
          subText = autoStatus.reason ? `ï¼ˆ${autoStatus.reason}ï¼‰` : '';
        }
        
        statusSource = '<span class="time-chip">è‡ªå‹•åˆ¤å®š</span>';
      }

      const lastReadChip = autoStatus.lastReadAt
        ? `<span class="time-chip">æœ€çµ‚èª­å–: ${autoStatus.elapsedText}</span>`
        : `<span class="time-chip">æœ€çµ‚èª­å–: ãƒ‡ãƒ¼ã‚¿ãªã—</span>`;

      const productRows = Object.entries(products)
        .sort((a,b)=>b[1]-a[1])
        .map(([prod, qty])=>{
          const ses = (sessionsByLine[line]?.sessions||[]).filter(s=>s.product===prod);
          const lastFinished = ses[ses.length-1];
          const timeChip = lastFinished ? `<span class="time-range">ï¼ˆ${fmtHM(lastFinished.start)}ã€œ${fmtHM(lastFinished.end)}ï¼‰</span>` : '';
          return `
            <div class="product-item">
              <span class="product-name">${prod} ${timeChip}</span>
              <span class="product-qty">${qty.toLocaleString()}</span>
            </div>
          `;
        }).join('');

      const card = document.createElement('div');
      card.className = 'line-card';
      card.innerHTML = `
        <div class="line-card-header">${line}</div>

        <div class="status-pill ${statusClass}">
          <div class="left">
            <span>${statusText}</span>
            ${subText ? `<span class="time-range">${subText}</span>` : ``}
          </div>
          <div style="display:flex; gap:4px; align-items:center; flex-wrap:wrap;">
            ${statusSource}
            ${lastReadChip}
          </div>
        </div>

        ${productRows}

        <div class="line-card-footer">
          <span>åˆè¨ˆ: <strong>${totalQty.toLocaleString()}</strong>å€‹</span>
          <span class="highlight-stop">åœæ­¢: ${(stopMin/60).toFixed(1)}æ™‚é–“</span>
          <span class="small">åœæ­¢åˆ¤å®š: ${stopLogic.stopThresholdMin ?? 15}åˆ†</span>
        </div>
      `;
      container.appendChild(card);
    });
  }

  function updateStopDetailTable(stopDetails){
    const tb = document.getElementById('stopDetailTbody');
    tb.innerHTML = '';

    if (!stopDetails.length){
      tb.innerHTML = '<tr><td colspan="5" class="center small" style="padding:40px; color:var(--muted);">åœæ­¢æ™‚é–“ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }

    const sorted = [...stopDetails].sort((a,b)=>b.stopMinutes - a.stopMinutes);

    sorted.forEach(stop=>{
      const tr = document.createElement('tr');
      const startTime = stop.startTime.toLocaleString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
      const endTime = stop.endTime.toLocaleString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});

      const stopMinutesDisplay = stop.nonWorkingMinutes
        ? `${stop.stopMinutes.toFixed(0)} <span style="font-size:11px; color:var(--muted);">(éç¨¼åƒ${stop.nonWorkingMinutes.toFixed(0)}åˆ†é™¤å¤–)</span>`
        : stop.stopMinutes.toFixed(0);

      tr.innerHTML = `
        <td><strong>${stop.line}</strong></td>
        <td>${stop.product}</td>
        <td class="nowrap">${startTime}</td>
        <td class="nowrap">${endTime}</td>
        <td class="right highlight-stop">${stopMinutesDisplay}</td>
      `;
      tb.appendChild(tr);
    });
  }

  function updateTimeSeriesChart(data){
    const groupHours = parseInt(hourGroup.value,10);
    const lineData = {};

    data.forEach(r=>{
      const dt = parseLogTime(r);
      if (!dt) return;

      const line = r.line || "ä¸æ˜";
      const hour = Math.floor(dt.getHours()/groupHours)*groupHours;
      const timeKey = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')} ${String(hour).padStart(2,'0')}:00`;

      if(!lineData[line]) lineData[line] = {};
      lineData[line][timeKey] = (lineData[line][timeKey] || 0) + getQuantity(r.sliced);
    });

    const allTimes = new Set();
    Object.values(lineData).forEach(times=>Object.keys(times).forEach(t=>allTimes.add(t)));
    const sortedTimes = Array.from(allTimes).sort();

    const colors = ['#0369a1', '#dc2626', '#059669', '#d97706', '#7c3aed', '#db2777', '#0891b2', '#65a30d'];
    const datasets = Object.keys(lineData).sort().map((line, idx)=>({
      label: line,
      data: sortedTimes.map(t=>lineData[line][t] || 0),
      borderColor: colors[idx % colors.length],
      backgroundColor: colors[idx % colors.length] + '20',
      tension: 0.3,
      fill: true,
      borderWidth: 2
    }));

    if (charts.timeSeries) charts.timeSeries.destroy();
    const ctx = document.getElementById('timeSeriesChart').getContext('2d');
    charts.timeSeries = new Chart(ctx, {
      type:'line',
      data:{ labels:sortedTimes, datasets },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ position:'bottom' } },
        scales:{
          y:{ beginAtZero:true, ticks:{ precision:0 }, title:{ display:true, text:'ç”Ÿç”£å€‹æ•°' } }
        }
      }
    });
  }

  function updateStopTimeChart(stopTimeByLine){
    const sorted = Object.entries(stopTimeByLine).sort((a,b)=>b[1]-a[1]);
    const labels = sorted.map(e=>e[0]);
    const values = sorted.map(e=>e[1]);

    const colors = values.map(minutes=>{
      if (minutes >= 60) return '#dc2626';
      if (minutes <= 10) return '#0369a1';
      return '#d97706';
    });

    const valuesInHours = values.map(m => (m/60).toFixed(1));

    if (charts.stopTime) charts.stopTime.destroy();
    const ctx = document.getElementById('stopTimeChart').getContext('2d');
    charts.stopTime = new Chart(ctx, {
      type:'bar',
      data:{
        labels,
        datasets:[{
          label:'åœæ­¢æ™‚é–“ï¼ˆæ™‚é–“ï¼‰',
          data: valuesInHours,
          backgroundColor: colors
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ display:false },
          tooltip:{
            callbacks:{
              label: (context)=>{
                const minutes = values[context.dataIndex];
                const hours = (minutes/60).toFixed(1);
                return `åœæ­¢æ™‚é–“: ${hours}æ™‚é–“ (${minutes.toFixed(0)}åˆ†)`;
              }
            }
          }
        },
        scales:{ y:{ beginAtZero:true, title:{ display:true, text:'æ™‚é–“' } } }
      }
    });
  }

  function renderDetailTable(rows){
    tbody.innerHTML = '';
    for (const d of rows){
      const qty = getQuantity(d.sliced);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="nowrap">${d.ts||""}</td>
        <td>${d.line||""}</td>
        <td>${d.sliced||""}</td>
        <td class="center"><strong>${qty}</strong></td>
        <td style="font-size:12px;">${d.raw||d.qrData||""}</td>
        <td class="center">${d.judge||d.result||""}</td>
      `;
      tbody.appendChild(tr);
    }
    const totalQty = rows.reduce((sum,r)=>sum + getQuantity(r.sliced), 0);
    countEl.textContent = `è¡¨ç¤ºä»¶æ•°ï¼š${rows.length} / ç”Ÿç”£å€‹æ•°ï¼š${totalQty}`;
  }

  function applyFilters(){
    errEl.style.display="none";
    updateDashboard();

    const fLine   = lineSel.value.trim();
    const fSliced = slicedSel.value.trim();
    const fBusho  = bushoSel.value.trim();

    let fromDate=null, toDate=null;
    if (dateFrom.value) fromDate = new Date(dateFrom.value + "T00:00:00");
    if (dateTo.value)   toDate   = new Date(dateTo.value   + "T23:59:59");

    const filtered = currentDocs.filter(r=>{
      if (fLine && r.line !== fLine) return false;
      if (fSliced && r.sliced !== fSliced) return false;
      if (fBusho && getBusho(r) !== fBusho) return false;

      const dt = parseLogTime(r);
      if (fromDate && dt && dt < fromDate) return false;
      if (toDate && dt && dt > toDate) return false;
      return true;
    });

    renderDetailTable(filtered);
  }

  async function fetchPage(pageNum){
    errEl.style.display="none";
    countEl.textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";
    pageInfo.textContent = `ãƒšãƒ¼ã‚¸ ${pageNum} / ${MAX_PAGES}`;

    try{
      const colRef = collection(db, "qrLogs");
      let qRef = query(colRef, orderBy("readAt","desc"), limit(PER_PAGE));

      const cursor = pageCursors[pageNum-1] || null;
      if (cursor) qRef = query(qRef, startAfter(cursor));

      const snap = await getDocs(qRef);
      currentDocs = [];
      snap.forEach(d=>currentDocs.push({ id:d.id, ...d.data() }));

      const lastDoc = snap.docs[snap.docs.length-1] || null;
      pageCursors[pageNum] = lastDoc;

      btnPrev.disabled = (pageNum === 1);
      btnNext.disabled = !(lastDoc && pageNum < MAX_PAGES);

      allData = [...allData, ...currentDocs];
      populateSelectors(allData);
      applyFilters();

      console.log(`ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ: ${currentDocs.length}ä»¶`);
    }catch(e){
      console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", e);
      errEl.style.display="block";
      errEl.textContent = "èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆreadAt descï¼‰ãŒå¿…è¦ãªå ´åˆã¯ä½œæˆã—ã¦ãã ã•ã„ã€‚è©³ç´°: " + e.message;
    }
  }

  // â˜…â˜… ã‹ã‚“ã°ã‚“v2ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
  function startKanbanStatusListener(){
    if (statusUnsubscribe) statusUnsubscribe();

    try{
      const colRef = collection(db, "lineStatus");

      statusUnsubscribe = onSnapshot(colRef, (snapshot)=>{
        kanbanStatusCache = {};
        
        snapshot.forEach(d=>{
          const data = d.data();
          kanbanStatusCache[d.id] = data;
        });

        updateDashboard();

        console.log("ğŸ”„ ã‹ã‚“ã°ã‚“v2ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°:", Object.keys(kanbanStatusCache).length, "ãƒ©ã‚¤ãƒ³");
      }, (error)=>{
        console.error("âŒ ã‹ã‚“ã°ã‚“v2ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç›£è¦–ã‚¨ãƒ©ãƒ¼:", error);
      });

      console.log("ğŸ”„ ã‹ã‚“ã°ã‚“v2ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸ");
    }catch(error){
      console.error("âŒ ã‹ã‚“ã°ã‚“v2ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç›£è¦–ã®é–‹å§‹ã‚¨ãƒ©ãƒ¼:", error);
    }
  }

  function startRealtimeListener(){
    if (realtimeUnsubscribe) realtimeUnsubscribe();

    try{
      const colRef = collection(db, "qrLogs");
      const qRef = query(colRef, orderBy("readAt","desc"), limit(2000));

      realtimeUnsubscribe = onSnapshot(qRef, (snapshot)=>{
        currentDocs = [];
        snapshot.forEach(d=>{
          currentDocs.push({ id:d.id, ...d.data() });
        });

        const map = new Map();
        currentDocs.forEach(r=>map.set(r.id, r));
        allData.forEach(r=>{
          if (!map.has(r.id)) map.set(r.id, r);
        });
        allData = Array.from(map.values());

        populateSelectors(allData);
        applyFilters();

        const now = new Date();
        fbStatus.textContent = `Firebase: æ¥ç¶šæ¸ˆã¿ (${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}æ›´æ–°)`;
        fbStatus.className = "badge connected";
      }, (error)=>{
        console.error("âŒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
        fbStatus.textContent = "Firebase: ã‚¨ãƒ©ãƒ¼";
        fbStatus.className = "badge disconnected";
      });

      console.log("ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’é–‹å§‹ã—ã¾ã—ãŸ");
    }catch(error){
      console.error("âŒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã®é–‹å§‹ã‚¨ãƒ©ãƒ¼:", error);
    }
  }

  function startAutoUpdate(){
    if (autoUpdateInterval) clearInterval(autoUpdateInterval);
    autoUpdateInterval = setInterval(()=>{
      try{
        updateDashboard();
      }catch(e){}
    }, AUTO_UPDATE_INTERVAL);
  }

  btnApply.addEventListener("click", applyFilters);

  btnReload.addEventListener("click", async ()=>{
    currentPage = 1;
    pageCursors = [null];
    allData = [];
    await fetchPage(currentPage);
  });

  btnPrev.addEventListener("click", async ()=>{
    if (currentPage <= 1) return;
    currentPage -= 1;
    await fetchPage(currentPage);
  });

  btnNext.addEventListener("click", async ()=>{
    if (currentPage >= MAX_PAGES) return;
    currentPage += 1;
    await fetchPage(currentPage);
  });

  btnExport.addEventListener("click", ()=>{
    const filtered = getFilteredData();
    const rows = [["æ™‚åˆ»","ãƒ©ã‚¤ãƒ³","å“ç•ª","ç”Ÿç”£å€‹æ•°","QRã‚³ãƒ¼ãƒ‰"]];
    filtered.forEach(r=>{
      let dt = "";
      if (r.ts) dt = r.ts;
      else if (r.readAt && r.readAt.seconds) dt = new Date(r.readAt.seconds*1000).toISOString();
      rows.push([dt, r.line||"", r.sliced||"", getQuantity(r.sliced), r.raw||r.qrData||""]);
    });
    const csv = rows.map(r=>r.map(f=>{
      const s = String(f ?? "");
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(",")).join("\n");
    const blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `production_report.csv`; a.click();
    URL.revokeObjectURL(url);
  });

  renderMasterTable();
  await loadMasterFromFirestore();
  await loadWorkSettings();
  await loadStopLogic();

  const today = new Date();
  const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
  dateFrom.value = todayStr;
  dateTo.value = todayStr;

  await fetchPage(currentPage);

  startRealtimeListener();
  startKanbanStatusListener(); // â˜…â˜… ã‹ã‚“ã°ã‚“v2ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç›£è¦–é–‹å§‹
  startAutoUpdate();

  console.log("ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–å®Œäº†");
</script>

</body>
</html>
