<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ç”Ÿç”£å®Ÿç¸¾ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{ --fg:#111; --muted:#6b7280; --border:#e5e7eb; --bg:#f9fafb; --accent:#0369a1; --success:#059669; --danger:#dc2626; --warning:#d97706; }
  *{ box-sizing:border-box; }
  body{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin:0; color:var(--fg); background:var(--bg); line-height:1.5; }
  header{ background:#fff; border-bottom:2px solid var(--border); padding:16px 24px; display:flex; gap:16px; align-items:center; flex-wrap:wrap; position:sticky; top:0; z-index:10; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
  h1{ font-size:22px; margin:0; font-weight:700; color:var(--accent); }
  .badge{ font-size:12px; padding:4px 10px; border-radius:12px; border:1px solid var(--border); font-weight:500; }
  .badge.connected{ background:#d1fae5; color:var(--success); border-color:#6ee7b7; }
  .badge.disconnected{ background:#fee2e2; color:var(--danger); border-color:#fecaca; }
  .badge.liveon{ background:#e0f2fe; color:#0369a1; border-color:#bae6fd; }
  .badge.liveoff{ background:#f3f4f6; color:#6b7280; border-color:#e5e7eb; }
  main{ padding:24px; max-width:1600px; margin:0 auto; }
  .panel{ background:#fff; border:1px solid var(--border); border-radius:16px; padding:20px; margin-bottom:20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
  .filter-grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); margin-bottom:16px; }
  label{ font-size:13px; font-weight:600; color:var(--muted); display:block; margin-bottom:6px; }
  input, select{ border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:14px; background:#fff; width:100%; transition: border-color 0.2s; }
  input:focus, select:focus{ outline:none; border-color:var(--accent); }
  button{ border:1px solid var(--border); background:#fff; border-radius:10px; padding:10px 16px; cursor:pointer; font-size:14px; font-weight:500; transition: all 0.2s; }
  button:hover{ background:#f9fafb; }
  button.primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
  button.primary:hover{ background:#0284c7; }
  button.danger{ background:var(--danger); color:#fff; border-color:var(--danger); }
  button.danger:hover{ background:#b91c1c; }
  button.success{ background:var(--success); color:#fff; border-color:var(--success); }
  button:disabled{ opacity:.5; cursor:not-allowed; }
  table{ width:100%; border-collapse: collapse; }
  th, td{ border-bottom:1px solid var(--border); padding:12px; text-align:left; vertical-align:middle; }
  th{ font-size:12px; font-weight:700; color:var(--muted); background:#fafafa; text-transform:uppercase; letter-spacing:0.5px; }
  tbody tr:hover{ background:#f9fafb; }
  .controls{ display:flex; gap:10px; align-items:center; margin-left:auto; flex-wrap:wrap; }
  .error{ color:var(--danger); font-size:13px; font-weight:500; }
  .success{ color:var(--success); font-size:13px; font-weight:500; }
  .small{ font-size:13px; color:var(--muted); }
  .right{ text-align:right; }
  .center{ text-align:center; }
  .pager{ display:flex; gap:10px; align-items:center; justify-content:center; }
  .stats-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:16px; margin-bottom:24px; }
  .stat-card{ background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius:14px; padding:20px; border:1px solid #bae6fd; }
  .chart-container{ position:relative; height:350px; margin-bottom:16px; }
  h2{ font-size:18px; margin:0 0 16px 0; color:var(--fg); font-weight:700; display:flex; align-items:center; gap:8px; }
  h2::before{ content:""; width:4px; height:20px; background:var(--accent); border-radius:2px; }
  .tabs{ display:flex; gap:4px; margin-bottom:20px; border-bottom:2px solid var(--border); background:#fff; border-radius:12px 12px 0 0; padding:0 20px; }
  .tab{ padding:14px 24px; cursor:pointer; border-bottom:3px solid transparent; color:var(--muted); font-weight:600; font-size:14px; transition: all 0.2s; margin-bottom:-2px; }
  .tab:hover{ color:var(--fg); background:#f9fafb; }
  .tab.active{ color:var(--accent); border-bottom-color:var(--accent); }
  .tab-content{ display:none; }
  .tab-content.active{ display:block; }
  .note{ background:#fef3c7; border:1px solid #fbbf24; border-radius:12px; padding:16px; margin-bottom:20px; font-size:14px; line-height:1.6; }
  .note strong{ color:#92400e; }
  .action-bar{ display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; align-items:center; }
  .master-table-wrap{ overflow-x:auto; border:1px solid var(--border); border-radius:12px; }
  .nowrap{ white-space:nowrap; }
  .tableWrap{ max-height: 60vh; overflow:auto; border:1px solid var(--border); border-radius:12px; }
  .msg-box{ padding:12px 16px; border-radius:10px; margin-bottom:16px; font-size:14px; font-weight:500; }
  .msg-box.success{ background:#d1fae5; color:var(--success); border:1px solid #6ee7b7; }
  .msg-box.error{ background:#fee2e2; color:var(--danger); border:1px solid #fecaca; }
  .line-card{ background:#fff; border:2px solid var(--border); border-radius:12px; padding:16px; transition: all 0.2s; }
  .line-card:hover{ border-color:var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .line-card-header{ font-size:18px; font-weight:700; color:var(--accent); margin-bottom:12px; display:flex; align-items:center; gap:8px; }
  .line-card-header::before{ content:"ğŸ­"; }
  .product-item{ display:block; padding:8px 12px; background:#f9fafb; border-radius:8px; margin-bottom:6px; }
  .product-name{ font-weight:600; color:var(--fg); }
  .product-qty{ font-size:16px; font-weight:700; color:var(--accent); float:right; }
  .line-card-footer{ margin-top:12px; padding-top:12px; border-top:1px solid var(--border); display:flex; justify-content:space-between; font-size:13px; color:var(--muted); }
  .highlight-stop{ background:#fef3c7; font-weight:600; color:var(--warning); }
</style>
</head>
<body>
<header>
  <h1>ğŸ“Š ç”Ÿç”£å®Ÿç¸¾ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
  <span id="fbStatus" class="badge">Firebase: æœªæ¥ç¶š</span>
  <span id="liveStatus" class="badge liveoff">LIVE: OFF</span>
  <div class="controls">
    <button id="btnLiveToggle" class="success">ğŸŸ¢ LIVE åˆ‡æ›¿</button>
    <button id="btnExport">ğŸ“¥ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    <button id="btnReload" class="primary">ğŸ”„ ãƒ‡ãƒ¼ã‚¿å†å–å¾—</button>
  </div>
</header>

<main>
  <section class="panel">
    <div class="filter-grid">
      <div>
        <label for="dateFrom">é–‹å§‹æ—¥</label>
        <input id="dateFrom" type="date" />
      </div>
      <div>
        <label for="dateTo">çµ‚äº†æ—¥</label>
        <input id="dateTo" type="date" />
      </div>
      <div>
        <label for="lineSel">ç”Ÿç”£ãƒ©ã‚¤ãƒ³</label>
        <select id="lineSel"><option value="">ã™ã¹ã¦</option></select>
      </div>
      <div>
        <label for="slicedSel">å“ç•ª</label>
        <select id="slicedSel"><option value="">ã™ã¹ã¦</option></select>
      </div>
      <div>
        <label for="hourGroup">æ™‚é–“å¸¯é›†è¨ˆ</label>
        <select id="hourGroup">
          <option value="1">1æ™‚é–“ã”ã¨</option>
          <option value="2">2æ™‚é–“ã”ã¨</option>
          <option value="4">4æ™‚é–“ã”ã¨</option>
          <option value="8">8æ™‚é–“ã”ã¨</option>
        </select>
      </div>
    </div>
    <div class="right">
      <button id="btnApply" class="primary">ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨</button>
    </div>
    <div id="err" class="error" style="display:none; margin-top:12px;"></div>
  </section>

  <div class="tabs">
    <div class="tab active" data-tab="dashboard">ğŸ“ˆ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
    <div class="tab" data-tab="master">âš™ï¸ QRãƒã‚¹ã‚¿ç®¡ç†</div>
    <div class="tab" data-tab="settings">ğŸ• ç¨¼åƒæ™‚é–“è¨­å®š</div>
    <div class="tab" data-tab="manual">ğŸ“– ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</div>
    <div class="tab" data-tab="detail">ğŸ“‹ è©³ç´°ãƒ‡ãƒ¼ã‚¿</div>
  </div>

  <!-- ä¸¦ã³æ›¿ãˆæ¸ˆã¿ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
  <div class="tab-content active" id="dashboard">
    <section class="panel">
      <h2>ãƒ©ã‚¤ãƒ³åˆ¥ç”Ÿç”£ã‚µãƒãƒªãƒ¼</h2>
      <div id="lineSummaryCards" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:16px;"></div>
    </section>

    <section class="panel">
      <h2>ãƒ©ã‚¤ãƒ³åˆ¥åœæ­¢æ™‚é–“è©³ç´°</h2>
      <div style="overflow-x:auto;">
        <table id="stopDetailTable">
          <thead>
            <tr>
              <th>ãƒ©ã‚¤ãƒ³</th>
              <th>ç”Ÿç”£å“ç•ª</th>
              <th>åœæ­¢é–‹å§‹æ™‚åˆ»</th>
              <th>åœæ­¢çµ‚äº†æ™‚åˆ»</th>
              <th class="right">åœæ­¢æ™‚é–“ï¼ˆåˆ†ï¼‰</th>
            </tr>
          </thead>
          <tbody id="stopDetailTbody"></tbody>
        </table>
      </div>
    </section>

    <section class="panel">
      <h2>ãƒ©ã‚¤ãƒ³åˆ¥åœæ­¢æ™‚é–“</h2>
      <div class="chart-container" style="height:300px;">
        <canvas id="stopTimeChart"></canvas>
      </div>
    </section>

    <section class="panel">
      <h2>æ™‚ç³»åˆ—ç”Ÿç”£æ¨ç§»ï¼ˆãƒ©ã‚¤ãƒ³åˆ¥ï¼‰</h2>
      <div class="chart-container">
        <canvas id="timeSeriesChart"></canvas>
      </div>
    </section>

    <section class="panel">
      <h2>æ™‚é–“å¸¯åˆ¥ç”Ÿç”£å®Ÿç¸¾</h2>
      <div style="overflow-x:auto;">
        <table id="hourlyTable">
          <thead>
            <tr>
              <th>æ™‚é–“å¸¯</th>
              <th class="right">ç”Ÿç”£å€‹æ•°</th>
              <th class="right">èª­å–ä»¶æ•°</th>
              <th class="right">åœæ­¢æ™‚é–“ï¼ˆåˆ†ï¼‰</th>
            </tr>
          </thead>
          <tbody id="hourlyTbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- ä»–ã‚¿ãƒ–ï¼ˆå¤‰æ›´ãªã—ï¼‰ -->
  <div class="tab-content" id="master">
    <section class="panel">
      <div class="note">
        <strong>ğŸ“ QRãƒã‚¹ã‚¿ã«ã¤ã„ã¦</strong><br>
        â€¦ï¼ˆçœç•¥ï¼šå…ƒã®èª¬æ˜ã‚’ç¶­æŒï¼‰â€¦
      </div>

      <div class="action-bar">
        <button id="btnAddMaster" class="primary">â• æ–°è¦è¿½åŠ </button>
        <button id="btnReloadMaster" class="success">ğŸ”„ Firebaseã‹ã‚‰å†èª­è¾¼</button>
        <button id="btnExportMaster">ğŸ“¥ ãƒã‚¹ã‚¿CSVå‡ºåŠ›</button>
        <button id="btnImportMaster">ğŸ“¤ ãƒã‚¹ã‚¿CSVå–è¾¼</button>
        <input type="file" id="fileImportMaster" accept=".csv" style="display:none;" />
        <div style="margin-left:auto;">
          <span class="stat-value" id="registeredMaster" style="font-size:24px; font-weight:700; color:var(--accent);">0</span>
          <span class="small">ä»¶ç™»éŒ²æ¸ˆã¿</span>
        </div>
      </div>

      <div id="masterMsg"></div>

      <div class="master-table-wrap">
        <table>
          <thead>
            <tr>
              <th>å“ç•ªï¼ˆåˆ‡ã‚Šå‡ºã—å€¤ï¼‰</th>
              <th class="center">ç”Ÿç”£å€‹æ•°/å›</th>
              <th class="center" style="width:120px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="masterTbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <div class="tab-content" id="settings">
    <section class="panel">
      <div class="note">
        <strong>ğŸ• ç¨¼åƒæ™‚é–“è¨­å®šã«ã¤ã„ã¦</strong><br>
        â€¦ï¼ˆçœç•¥ï¼šå…ƒã®èª¬æ˜ã‚’ç¶­æŒï¼‰â€¦
      </div>

      <div id="settingsMsg"></div>

      <div style="margin-bottom:24px;">
        <h2>ç¨¼åƒæ›œæ—¥</h2>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <label><input type="checkbox" id="day0" value="0" /> æ—¥æ›œæ—¥</label>
          <label><input type="checkbox" id="day1" value="1" checked /> æœˆæ›œæ—¥</label>
          <label><input type="checkbox" id="day2" value="2" checked /> ç«æ›œæ—¥</label>
          <label><input type="checkbox" id="day3" value="3" checked /> æ°´æ›œæ—¥</label>
          <label><input type="checkbox" id="day4" value="4" checked /> æœ¨æ›œæ—¥</label>
          <label><input type="checkbox" id="day5" value="5" checked /> é‡‘æ›œæ—¥</label>
          <label><input type="checkbox" id="day6" value="6" /> åœŸæ›œæ—¥</label>
        </div>
      </div>

      <div style="margin-bottom:24px;">
        <h2>ç¨¼åƒæ™‚é–“å¸¯</h2>
        <div style="display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); max-width:800px;">
          <div>
            <label for="workStartTime">é–‹å§‹æ™‚åˆ»</label>
            <input type="time" id="workStartTime" value="08:00" />
          </div>
          <div>
            <label for="workEndTime">çµ‚äº†æ™‚åˆ»</label>
            <input type="time" id="workEndTime" value="17:00" />
          </div>
        </div>
      </div>

      <div style="margin-bottom:24px;">
        <h2>ä¼‘æ†©æ™‚é–“</h2>
        <div id="breaksContainer"></div>
        <button id="btnAddBreak" style="margin-top:12px;">â• ä¼‘æ†©æ™‚é–“ã‚’è¿½åŠ </button>
      </div>

      <div class="right">
        <button id="btnSaveSettings" class="primary">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
      </div>
    </section>
  </div>

  <div class="tab-content" id="manual">
    <section class="panel">
      <h1 style="font-size:24px; margin:0 0 24px 0; color:var(--accent);">ğŸ“– ç”Ÿç”£å®Ÿç¸¾ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</h1>
      â€¦ï¼ˆçœç•¥ï¼šå…ƒã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’ç¶­æŒï¼‰â€¦
    </section>
  </div>

  <div class="tab-content" id="detail">
    <section class="panel">
      <div class="pager" style="margin: 0 0 16px 0;">
        <button id="btnPrev" disabled>â¬…ï¸ å‰ã¸</button>
        <span id="pageInfo" class="small">ãƒšãƒ¼ã‚¸ 1 / 10</span>
        <button id="btnNext" disabled>æ¬¡ã¸ â¡ï¸</button>
      </div>
      <div style="margin-bottom:12px;">
        <span id="count" class="small"></span>
      </div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th class="nowrap">ç«¯æœ«æ™‚åˆ»</th>
              <th>ç”Ÿç”£ãƒ©ã‚¤ãƒ³</th>
              <th>å“ç•ª</th>
              <th class="center">ç”Ÿç”£å€‹æ•°</th>
              <th>QR(raw)</th>
              <th class="center">çµæœ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, collection, query, orderBy, limit, getDocs, startAfter, doc, setDoc, deleteDoc, getDoc,
    where, onSnapshot, Timestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  /* ====== å‚ç…§è¦ç´  ====== */
  const fbStatus = document.getElementById("fbStatus");
  const liveStatus = document.getElementById("liveStatus");
  const btnLiveToggle = document.getElementById("btnLiveToggle");
  const tbody = document.getElementById("tbody");
  const masterTbody = document.getElementById("masterTbody");
  const masterMsg = document.getElementById("masterMsg");
  const settingsMsg = document.getElementById("settingsMsg");
  const btnExport = document.getElementById("btnExport");
  const btnReload = document.getElementById("btnReload");
  const btnApply = document.getElementById("btnApply");
  const btnPrev = document.getElementById("btnPrev");
  const btnNext = document.getElementById("btnNext");
  const pageInfo = document.getElementById("pageInfo");
  const errEl = document.getElementById("err");
  const countEl = document.getElementById("count");
  const lineSel = document.getElementById("lineSel");
  const slicedSel = document.getElementById("slicedSel");
  const hourGroup = document.getElementById("hourGroup");
  const dateFrom = document.getElementById("dateFrom");
  const dateTo = document.getElementById("dateTo");

  /* ====== Firebase ====== */
  const app = initializeApp({
    apiKey: "AIzaSyDb62GTdYU_zksCYiQyr9-WERZLFrztJ1U",
    authDomain: "miyama-seizo.firebaseapp.com",
    projectId: "miyama-seizo",
  });
  const auth = getAuth(app);
  const db = getFirestore(app);

  function setFbStatus(t, connected){
    fbStatus.textContent = "Firebase: " + t;
    fbStatus.className = "badge " + (connected ? "connected" : "disconnected");
  }
  try{
    await signInAnonymously(auth);
    setFbStatus("æ¥ç¶šæ¸ˆã¿", true);
  }catch(e){
    console.warn(e);
    setFbStatus("æœªæ¥ç¶š", false);
  }

  /* ====== ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ====== */
  const PER_PAGE = 2000;
  const MAX_PAGES = 10;
  const STOP_THRESHOLD_MINUTES = 15;
  const LIVE_LIMIT = 5000;         // ä»Šæ—¥ã®ãƒ©ã‚¤ãƒ–ã§ä¿æŒã™ã‚‹æœ€å¤§ä»¶æ•°
  const INACTIVITY_MS = 3 * 60 * 1000; // 3åˆ†ç„¡æ“ä½œã§LIVEã«æˆ»ã™

  /* ====== çŠ¶æ…‹ ====== */
  let currentPage = 1;
  let pageCursors = [null];
  let currentDocs = [];
  let allData = [];
  let qrMaster = {};
  let workSettings = {
    workingDays: [1,2,3,4,5],
    workStart: "08:00",
    workEnd: "17:00",
    breaks: [{ start:"12:00", end:"13:00", enabled:true }]
  };
  let charts = { timeSeries: null, stopTime: null };

  // LIVEï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰é–¢é€£
  let liveUnsub = null;
  let liveMode = false;

  /* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
  function setLiveStatus(on){
    liveMode = on;
    liveStatus.textContent = on ? "LIVE: ON" : "LIVE: OFF";
    liveStatus.className = "badge " + (on ? "liveon" : "liveoff");
    // LIVEä¸­ã¯ãƒšãƒ¼ã‚¸ãƒ³ã‚°UIã‚’ç„¡åŠ¹åŒ–
    btnPrev.disabled = true; btnNext.disabled = true;
  }

  function todayYYYYMMDD(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }

  function setDateRangeToToday(){
    const t = todayYYYYMMDD();
    dateFrom.value = t;
    dateTo.value = t;
  }

  function isTodayRangeSelected(){
    const t = todayYYYYMMDD();
    return dateFrom.value === t && dateTo.value === t;
    }

  function parseClientDate(tsStr){
    if (!tsStr) return null;
    const m = tsStr.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2}):(\d{2})$/);
    if (!m) return null;
    const [_, y, mo, d, h, mi, s] = m.map(Number);
    return new Date(y, mo-1, d, h, mi, s);
  }

  function uniqueSorted(values){
    return Array.from(new Set(values.filter(v => v != null && v !== ""))).sort((a, b) => String(a).localeCompare(String(b), 'ja'));
  }

  function populateSelectors(data){
    const lines = uniqueSorted(data.map(r => r.line || ""));
    const sliced = uniqueSorted(data.map(r => r.sliced || ""));
    const fill = (sel, arr) => {
      const cur = sel.value;
      sel.innerHTML = "<option value=''>ã™ã¹ã¦</option>" + arr.map(v => `<option value="${String(v).replace(/"/g, '&quot;')}">${v}</option>`).join("");
      if (cur && arr.includes(cur)){ sel.value = cur; }
    };
    fill(lineSel, lines);
    fill(slicedSel, sliced);
  }

  function getQuantity(sliced){ return qrMaster[sliced] || 1; }

  /* ====== ç¨¼åƒæ™‚é–“ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ—¢å­˜ã®ã¾ã¾ï¼‰ ====== */
  function isWorkingTime(date){
    const day = date.getDay();
    if (!workSettings.workingDays.includes(day)) return false;
    const timeStr = `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
    const startTime = workSettings.workStart;
    const endTime = workSettings.workEnd;
    const crossesMidnight = startTime > endTime;
    if (crossesMidnight){
      if (timeStr < startTime && timeStr >= endTime) return false;
    } else {
      if (timeStr < startTime || timeStr >= endTime) return false;
    }
    for (const b of workSettings.breaks){
      if (!b.enabled) continue;
      const cross = b.start > b.end;
      if (cross){ if (timeStr >= b.start || timeStr < b.end) return false; }
      else { if (timeStr >= b.start && timeStr < b.end) return false; }
    }
    return true;
  }

  function calculateNonWorkingMinutes(startTime, endTime){
    let non = 0;
    const cur = new Date(startTime);
    while (cur < endTime){
      if (!isWorkingTime(cur)) non++;
      cur.setMinutes(cur.getMinutes()+1);
    }
    return non;
  }

  /* ====== é›†è¨ˆãƒ»æç”»ï¼ˆæ—¢å­˜ã®ã¾ã¾ï¼‰ ====== */
  function getFilteredData(){
    const fLine = lineSel.value.trim();
    const fSliced = slicedSel.value.trim();
    let fromDate = null, toDate = null;
    if (dateFrom.value){ fromDate = new Date(dateFrom.value + "T00:00:00"); }
    if (dateTo.value){ toDate = new Date(dateTo.value + "T23:59:59"); }

    return allData.filter(r => {
      const judge = r.judge || r.result || "";
      if (judge !== "OK") return false;
      if (fLine && r.line !== fLine) return false;
      if (fSliced && r.sliced !== fSliced) return false;

      let dt = null;
      if (r.ts){ dt = parseClientDate(r.ts); }
      if (!dt && r.readAt && r.readAt.seconds){ dt = new Date(r.readAt.seconds*1000); }
      if (!dt) return false;

      if (fromDate && dt < fromDate) return false;
      if (toDate && dt > toDate) return false;
      return true;
    });
  }

  function calculateStopTime(data){
    const lineData = {};
    data.forEach(r=>{
      let dt=null;
      if (r.ts) dt = parseClientDate(r.ts);
      if (!dt && r.readAt && r.readAt.seconds) dt = new Date(r.readAt.seconds*1000);
      if (!dt) return;
      const line = r.line || "ä¸æ˜";
      const product = r.sliced || "";
      (lineData[line] ||= []).push({ time: dt, product });
    });

    const stopTimeByLine = {};
    const stopDetails = [];
    Object.keys(lineData).forEach(line=>{
      const records = lineData[line].sort((a,b)=>a.time-b.time);
      let stopMinutes=0;
      for (let i=1;i<records.length;i++){
        const prev=records[i-1], curr=records[i];
        const diffMin = (curr.time - prev.time)/60000;
        if (prev.product===curr.product && diffMin>=STOP_THRESHOLD_MINUTES){
          const non = calculateNonWorkingMinutes(prev.time, curr.time);
          const actual = diffMin - non;
          if (actual>=STOP_THRESHOLD_MINUTES){
            stopMinutes += actual;
            stopDetails.push({ line, product: prev.product, startTime: prev.time, endTime: curr.time, stopMinutes: actual, nonWorkingMinutes: non });
          }
        }
      }
      stopTimeByLine[line] = stopMinutes;
    });
    return { stopTimeByLine, stopDetails };
  }

  function updateLineSummaryCards(data, stopTimeByLine){
    const lineProducts = {};
    data.forEach(r=>{
      const line = r.line || "ä¸æ˜";
      const product = r.sliced || "ä¸æ˜";
      let dt=null;
      if (r.ts) dt = parseClientDate(r.ts);
      if (!dt && r.readAt && r.readAt.seconds) dt = new Date(r.readAt.seconds*1000);
      (lineProducts[line] ||= {});
      (lineProducts[line][product] ||= { qty:0, startTime:dt, endTime:dt });
      lineProducts[line][product].qty += getQuantity(r.sliced);
      if (dt){
        if (!lineProducts[line][product].startTime || dt < lineProducts[line][product].startTime) lineProducts[line][product].startTime = dt;
        if (!lineProducts[line][product].endTime || dt > lineProducts[line][product].endTime)   lineProducts[line][product].endTime   = dt;
      }
    });

    const container = document.getElementById('lineSummaryCards');
    container.innerHTML='';
    Object.keys(lineProducts).sort().forEach(line=>{
      const products = lineProducts[line];
      const totalQty = Object.values(products).reduce((s,p)=>s+p.qty,0);
      const stopTime = stopTimeByLine[line] || 0;
      const card = document.createElement('div'); card.className='line-card';
      const sortedProducts = Object.entries(products).sort((a,b)=>(a[1].startTime||new Date(0))-(b[1].startTime||new Date(0)));
      card.innerHTML = `
        <div class="line-card-header">${line}</div>
        ${sortedProducts.map(([product, d])=>`
          <div class="product-item">
            <span class="product-name">${product}</span>
            <span class="product-qty">${d.qty.toLocaleString()}</span>
            <div style="clear:both; font-size:11px; color:var(--muted); margin-top:4px;">
              ${d.startTime ? d.startTime.toLocaleString('ja-JP',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}) : '---'}
              ï½
              ${d.endTime ? d.endTime.toLocaleString('ja-JP',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}) : '---'}
            </div>
          </div>
        `).join('')}
        <div class="line-card-footer">
          <span>åˆè¨ˆ: <strong>${totalQty.toLocaleString()}</strong>å€‹</span>
          <span class="highlight-stop">åœæ­¢: ${(stopTime/60).toFixed(1)}æ™‚é–“</span>
        </div>
      `;
      container.appendChild(card);
    });
  }

  function updateStopDetailTable(stopDetails){
    const tb = document.getElementById('stopDetailTbody');
    tb.innerHTML='';
    if (stopDetails.length===0){
      tb.innerHTML = '<tr><td colspan="5" class="center small" style="padding:40px; color:var(--muted);">åœæ­¢æ™‚é–“ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }
    const sorted = stopDetails.sort((a,b)=>b.stopMinutes-a.stopMinutes);
    sorted.forEach(s=>{
      const start = s.startTime.toLocaleString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
      const end   = s.endTime.toLocaleString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
      const disp = s.nonWorkingMinutes ? `${s.stopMinutes.toFixed(0)} <span style="font-size:11px; color:var(--muted);">(éç¨¼åƒ${s.nonWorkingMinutes.toFixed(0)}åˆ†é™¤å¤–)</span>` : s.stopMinutes.toFixed(0);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${s.line}</strong></td>
        <td>${s.product}</td>
        <td class="nowrap">${start}</td>
        <td class="nowrap">${end}</td>
        <td class="right highlight-stop">${disp}</td>
      `;
      tb.appendChild(tr);
    });
  }

  function updateTimeSeriesChart(data){
    const groupHours = parseInt(hourGroup.value);
    const lineData = {};
    data.forEach(r=>{
      let dt=null;
      if (r.ts) dt = parseClientDate(r.ts);
      if (!dt && r.readAt && r.readAt.seconds) dt = new Date(r.readAt.seconds*1000);
      if (!dt) return;
      const line = r.line || "ä¸æ˜";
      const hour = Math.floor(dt.getHours()/groupHours)*groupHours;
      const key = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')} ${String(hour).padStart(2,'0')}:00`;
      (lineData[line] ||= {}); lineData[line][key] = (lineData[line][key]||0) + getQuantity(r.sliced);
    });
    const allTimes = new Set(); Object.values(lineData).forEach(t=>Object.keys(t).forEach(k=>allTimes.add(k)));
    const labels = Array.from(allTimes).sort();
    const colors = ['#0369a1','#dc2626','#059669','#d97706','#7c3aed','#db2777','#0891b2','#65a30d'];
    const datasets = Object.keys(lineData).sort().map((line, i)=>({
      label: line,
      data: labels.map(t=>lineData[line][t]||0),
      borderColor: colors[i%colors.length],
      backgroundColor: colors[i%colors.length]+'20',
      tension: 0.3, fill: true, borderWidth: 2
    }));
    if (charts.timeSeries) charts.timeSeries.destroy();
    const ctx = document.getElementById('timeSeriesChart').getContext('2d');
    charts.timeSeries = new Chart(ctx,{ type:'line', data:{ labels, datasets }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 }, title:{ display:true, text:'ç”Ÿç”£å€‹æ•°' } } } } });
  }

  function updateStopTimeChart(stopTimeByLine){
    const sorted = Object.entries(stopTimeByLine).sort((a,b)=>b[1]-a[1]);
    const labels = sorted.map(e=>e[0]);
    const values = sorted.map(e=>e[1]);
    const colors = values.map(m=> m>=60 ? '#dc2626' : (m<=10 ? '#0369a1' : '#d97706'));
    const hours = values.map(m=>(m/60).toFixed(1));
    if (charts.stopTime) charts.stopTime.destroy();
    const ctx = document.getElementById('stopTimeChart').getContext('2d');
    charts.stopTime = new Chart(ctx,{
      type:'bar',
      data:{ labels, datasets:[{ label:'åœæ­¢æ™‚é–“ï¼ˆæ™‚é–“ï¼‰', data:hours, backgroundColor:colors }]},
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>{ const m=values[c.dataIndex]; return `åœæ­¢æ™‚é–“: ${(m/60).toFixed(1)}æ™‚é–“ (${m.toFixed(0)}åˆ†)`; } } } },
        scales:{ y:{ beginAtZero:true, title:{ display:true, text:'æ™‚é–“' } } }
      }
    });
  }

  function updateHourlyTable(data){
    const groupHours = parseInt(hourGroup.value);
    const hourCounts = {};
    const lineHourData = {};
    data.forEach(r=>{
      let dt=null;
      if (r.ts) dt = parseClientDate(r.ts);
      if (!dt && r.readAt && r.readAt.seconds) dt = new Date(r.readAt.seconds*1000);
      if (!dt) return;
      const line = r.line || "ä¸æ˜";
      const product = r.sliced || "";
      const hour = Math.floor(dt.getHours()/groupHours)*groupHours;
      const key = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')} ${String(hour).padStart(2,'0')}:00`;

      (hourCounts[key] ||= { qty:0, count:0 });
      hourCounts[key].qty += getQuantity(r.sliced);
      hourCounts[key].count += 1;

      (lineHourData[line] ||= {});
      (lineHourData[line][key] ||= []).push({ time: dt, product });
    });

    const hourStops = {};
    Object.keys(lineHourData).forEach(line=>{
      Object.keys(lineHourData[line]).forEach(key=>{
        const recs = lineHourData[line][key].sort((a,b)=>a.time-b.time);
        for (let i=1;i<recs.length;i++){
          const prev=recs[i-1], curr=recs[i];
          const diff = (curr.time - prev.time)/60000;
          if (prev.product===curr.product && diff>=STOP_THRESHOLD_MINUTES){
            const non = calculateNonWorkingMinutes(prev.time, curr.time);
            const actual = diff - non;
            if (actual>=STOP_THRESHOLD_MINUTES){
              (hourStops[key] ||= 0);
              hourStops[key] += actual;
            }
          }
        }
      });
    });

    const rows = Object.keys(hourCounts).sort().map(key=>{
      const c = hourCounts[key];
      const stop = Math.round(hourStops[key] || 0);
      return { key, qty: c.qty, count: c.count, stop };
    });

    const tb = document.getElementById('hourlyTbody');
    tb.innerHTML='';
    if (rows.length===0){
      tb.innerHTML = '<tr><td colspan="4" class="center small" style="padding:40px; color:var(--muted);">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="nowrap">${r.key}</td>
        <td class="right">${r.qty.toLocaleString()}</td>
        <td class="right">${r.count.toLocaleString()}</td>
        <td class="right">${r.stop.toLocaleString()}</td>
      `;
      tb.appendChild(tr);
    });
  }

  function updateDashboard(){
    const filtered = getFilteredData();
    const { stopTimeByLine, stopDetails } = calculateStopTime(filtered);
    updateLineSummaryCards(filtered, stopTimeByLine);
    updateStopDetailTable(stopDetails);
    updateStopTimeChart(stopTimeByLine);
    updateTimeSeriesChart(filtered);
    updateHourlyTable(filtered);
  }

  /* ====== ãƒã‚¹ã‚¿/è¨­å®š èª­ã¿è¾¼ã¿ ====== */
  async function loadMasterFromFirestore(){
    try{
      const masterCol = collection(db, "qrMaster");
      const masterSnap = await getDocs(masterCol);
      qrMaster = {};
      masterSnap.forEach(docu => {
        const data = docu.data();
        qrMaster[docu.id] = data.quantity || 1;
      });
      renderMasterTable();
      showMasterMsg(`${Object.keys(qrMaster).length}ä»¶ã®ãƒã‚¹ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success');
    }catch(e){
      console.warn("ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
      showMasterMsg('ãƒã‚¹ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
  }

  async function loadWorkSettings(){
    try{
      const docRef = doc(db, "settings", "workSchedule");
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        workSettings = {
          workingDays: data.workingDays || [1,2,3,4,5],
          workStart: data.workStart || "08:00",
          workEnd: data.workEnd || "17:00",
          breaks: data.breaks || [{ start:"12:00", end:"13:00", enabled:true }]
        };
        applyWorkSettingsToUI();
        showSettingsMsg('ç¨¼åƒæ™‚é–“è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
      } else {
        applyWorkSettingsToUI();
      }
    }catch(e){
      console.warn("è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
      applyWorkSettingsToUI();
    }
  }

  function renderMasterTable(){
    masterTbody.innerHTML = '';
    const entries = Object.entries(qrMaster).sort((a,b)=>a[0].localeCompare(b[0],'ja'));
    if (entries.length===0){
      masterTbody.innerHTML = '<tr><td colspan="3" class="center small" style="padding:40px; color:var(--muted);">ãƒã‚¹ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>';
    }
    entries.forEach(([product, qty])=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${product}</strong></td>
        <td class="center"><strong style="font-size:16px;">${qty}</strong></td>
        <td class="center"><button class="danger" data-product="${product}">ğŸ—‘ï¸ å‰Šé™¤</button></td>
      `;
      tr.querySelector('button').addEventListener('click', async ()=>{
        if (!confirm(`å“ç•ªã€Œ${product}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        try{ await deleteDoc(doc(db, "qrMaster", product)); delete qrMaster[product]; renderMasterTable(); updateDashboard(); showMasterMsg('å‰Šé™¤ã—ã¾ã—ãŸï¼ˆFirebaseåŒæœŸæ¸ˆã¿ï¼‰','success'); }
        catch(e){ showMasterMsg('Firebaseã‹ã‚‰ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ','error'); }
      });
      masterTbody.appendChild(tr);
    });
    document.getElementById('registeredMaster').textContent = entries.length;
  }

  function showMasterMsg(msg, type){ masterMsg.className = 'msg-box ' + type; masterMsg.textContent = msg; masterMsg.style.display='block'; setTimeout(()=>masterMsg.style.display='none',4000); }
  function showSettingsMsg(msg, type){ settingsMsg.className = 'msg-box ' + type; settingsMsg.textContent = msg; settingsMsg.style.display='block'; setTimeout(()=>settingsMsg.style.display='none',4000); }

  /* ====== å±¥æ­´ï¼ˆå¾“æ¥ã® getDocs ãƒšãƒ¼ã‚¸ãƒ³ã‚°ï¼‰ ====== */
  async function fetchPage(pageIndex){
    const col = collection(db, "qrLogs");
    let q = query(col, orderBy("readAt", "desc"), limit(PER_PAGE));
    if (pageIndex>1 && pageCursors[pageIndex-1]) q = query(col, orderBy("readAt", "desc"), startAfter(pageCursors[pageIndex-1]), limit(PER_PAGE));
    const snap = await getDocs(q);
    if (snap.docs.length>0){
      pageCursors[pageIndex] = snap.docs[snap.docs.length-1];
    }
    currentDocs = snap.docs;
    return snap.docs.map(d=>({ id:d.id, ...d.data() }));
  }

  function renderTable(data){
    tbody.innerHTML='';
    data.forEach(r=>{
      let dt=null;
      if (r.ts) dt = parseClientDate(r.ts);
      if (!dt && r.readAt && r.readAt.seconds) dt = new Date(r.readAt.seconds*1000);
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="nowrap">${dt ? dt.toLocaleString('ja-JP') : ''}</td>
        <td>${r.line || ''}</td>
        <td>${r.sliced || ''}</td>
        <td class="center">${getQuantity(r.sliced)}</td>
        <td>${r.raw || r.qr || ''}</td>
        <td class="center">${r.judge || r.result || ''}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  /* ====== LIVEï¼ˆä»Šæ—¥ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰ ====== */
  function stopLiveListener(){
    if (liveUnsub){ liveUnsub(); liveUnsub = null; }
    setLiveStatus(false);
  }

  async function startLiveToday(){
    stopLiveListener();
    setDateRangeToToday();
    const start = new Date(todayYYYYMMDD() + "T00:00:00");
    const q = query(
      collection(db, "qrLogs"),
      where("readAt", ">=", Timestamp.fromDate(start)),
      orderBy("readAt","desc"),
      limit(LIVE_LIMIT)
    );
    liveUnsub = onSnapshot(q, (snap)=>{
      const data = [];
      snap.forEach(d=> data.push({ id:d.id, ...d.data() }));
      // å†…éƒ¨ä¿æŒã¯æ˜‡é †ã«
      allData = data.slice().reverse();
      populateSelectors(allData);
      renderTable(data); // è¡¨ç¤ºãƒ†ãƒ¼ãƒ–ãƒ«ã¯é™é †ï¼ˆæœ€æ–°ä¸Šï¼‰
      countEl.textContent = `LIVEå–å¾—: ${data.length.toLocaleString()}ï¼ˆä»Šæ—¥ï¼‰`;
      pageInfo.textContent = `LIVE / ä»Šæ—¥`;
      updateDashboard();
    }, (err)=>{
      console.warn("LIVE onSnapshot ã‚¨ãƒ©ãƒ¼:", err);
      errEl.textContent = 'ãƒ©ã‚¤ãƒ–å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
      errEl.style.display='block';
      stopLiveListener();
    });
    setLiveStatus(true);
  }

  /* ====== ç„¡æ“ä½œã‚¿ã‚¤ãƒãƒ¼ ====== */
  let idleTimer = null;
  function resetIdleTimer(){
    if (idleTimer) clearTimeout(idleTimer);
    idleTimer = setTimeout(()=>{
      // ç„¡æ“ä½œ -> ä»Šæ—¥ã®LIVEã«æˆ»ã™
      startLiveToday();
    }, INACTIVITY_MS);
  }
  ["click","keydown","mousemove","touchstart","wheel"].forEach(ev=>{
    document.addEventListener(ev, resetIdleTimer, { passive:true });
  });

  /* ====== ã‚¤ãƒ™ãƒ³ãƒˆ ====== */
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
    });
  });

  btnReload.addEventListener('click', async ()=>{ stopLiveListener(); await reloadAll(); });
  btnApply.addEventListener('click', ()=>{
    // ä»Šæ—¥ä»¥å¤–ã‚’æŒ‡å®šã—ãŸã‚‰LIVEåœæ­¢
    if (!isTodayRangeSelected()) stopLiveListener();
    updateDashboard();
  });

  btnPrev.addEventListener('click', async ()=>{
    if (liveMode) return; // LIVEä¸­ã¯ç„¡åŠ¹
    if (currentPage<=1) return;
    currentPage--;
    const data = await fetchPage(currentPage);
    renderTable(data);
    countEl.textContent = `å–å¾—ä»¶æ•°: ${data.length.toLocaleString()} / ãƒšãƒ¼ã‚¸ ${currentPage}`;
    btnPrev.disabled = (currentPage===1);
    btnNext.disabled = false;
    pageInfo.textContent = `ãƒšãƒ¼ã‚¸ ${currentPage} / ${MAX_PAGES}`;
  });

  btnNext.addEventListener('click', async ()=>{
    if (liveMode) return; // LIVEä¸­ã¯ç„¡åŠ¹
    if (currentPage>=MAX_PAGES) return;
    currentPage++;
    const data = await fetchPage(currentPage);
    renderTable(data);
    countEl.textContent = `å–å¾—ä»¶æ•°: ${data.length.toLocaleString()} / ãƒšãƒ¼ã‚¸ ${currentPage}`;
    btnPrev.disabled = false;
    btnNext.disabled = (data.length < PER_PAGE) || (currentPage>=MAX_PAGES);
    pageInfo.textContent = `ãƒšãƒ¼ã‚¸ ${currentPage} / ${MAX_PAGES}`;
  });

  btnLiveToggle.addEventListener('click', ()=>{
    if (liveMode) { stopLiveListener(); } else { startLiveToday(); }
  });

  // æ—¥ä»˜å¤‰æ›´ã§ä»Šæ—¥ä»¥å¤–ã«å‹•ã„ãŸã‚‰LIVEåœæ­¢
  [dateFrom, dateTo].forEach(inp=>{
    inp.addEventListener('change', ()=>{
      if (!isTodayRangeSelected()) stopLiveListener();
    });
  });

  // ãƒã‚¹ã‚¿é–¢é€£ï¼ˆæ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼‰
  document.getElementById('btnAddMaster').addEventListener('click', async ()=>{
    const product = prompt('å“ç•ªï¼ˆåˆ‡ã‚Šå‡ºã—å€¤ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:'); if (!product || product.trim()==='') return;
    const qty = prompt('1å›ã®èª­ã¿å–ã‚Šã‚ãŸã‚Šã®ç”Ÿç”£å€‹æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', '1'); if (qty===null) return;
    const qtyNum = parseInt(qty); if (isNaN(qtyNum) || qtyNum<1){ alert('å€‹æ•°ã¯1ä»¥ä¸Šã®æ•´æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    qrMaster[product.trim()] = qtyNum;
    try{ await setDoc(doc(db, "qrMaster", product.trim()), { quantity: qtyNum, updatedAt: new Date() }); renderMasterTable(); updateDashboard(); showMasterMsg('ç™»éŒ²ã—ã¾ã—ãŸï¼ˆFirebaseåŒæœŸæ¸ˆã¿ï¼‰','success'); }
    catch(e){ delete qrMaster[product.trim()]; showMasterMsg('Firebaseã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ','error'); }
  });

  document.getElementById('btnReloadMaster').addEventListener('click', async ()=>{ await loadMasterFromFirestore(); updateDashboard(); });
  document.getElementById('btnExportMaster').addEventListener('click', ()=>{
    const rows=[['å“ç•ª','ç”Ÿç”£å€‹æ•°']];
    Object.entries(qrMaster).sort((a,b)=>a[0].localeCompare(b[0],'ja')).forEach(([p,q])=>rows.push([p,q]));
    const csv = rows.map(r=>r.map(f=>{ const s=String(f??''); return /[\",\n]/.test(s)?`"${s.replace(/\"/g,'\"\"')}"`:s; }).join(",")).join("\n");
    const blob=new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8"}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='qr_master.csv'; a.click(); URL.revokeObjectURL(url);
  });
  document.getElementById('btnImportMaster').addEventListener('click', ()=> document.getElementById('fileImportMaster').click());
  document.getElementById('fileImportMaster').addEventListener('change', async (e)=>{
    const file=e.target.files[0]; if(!file) return;
    try{
      const text=await file.text();
      const lines=text.replace(/^\uFEFF/,'').split('\n').map(l=>l.trim()).filter(l=>l);
      let imported=0, failed=0;
      for (let i=1;i<lines.length;i++){
        const parts=lines[i].split(',').map(p=>p.replace(/^"|"$/g,'').trim());
        if (parts.length>=2){
          const product=parts[0]; const qty=parseInt(parts[1]);
          if (product && !isNaN(qty) && qty>0){
            qrMaster[product]=qty;
            try{ await setDoc(doc(db, "qrMaster", product), { quantity: qty, updatedAt: new Date() }); imported++; }
            catch{ failed++; }
          }
        }
      }
      renderMasterTable(); updateDashboard();
      if (failed>0) showMasterMsg(`${imported}ä»¶å–è¾¼ã€${failed}ä»¶å¤±æ•—ï¼ˆFirebaseåŒæœŸã‚¨ãƒ©ãƒ¼ï¼‰`, 'error');
      else showMasterMsg(`${imported}ä»¶ã®ãƒã‚¹ã‚¿ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸï¼ˆFirebaseåŒæœŸæ¸ˆã¿ï¼‰`, 'success');
    }catch(err){ console.error(err); showMasterMsg('CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error'); }
    e.target.value='';
  });

  btnExport.addEventListener('click', ()=>{
    const filtered = getFilteredData();
    const rows=[['æ™‚åˆ»','ç”Ÿç”£ãƒ©ã‚¤ãƒ³','å“ç•ª','ç”Ÿç”£å€‹æ•°','QR']];
    filtered.forEach(r=>{
      let dt=null;
      if (r.ts) dt = parseClientDate(r.ts);
      if (!dt && r.readAt && r.readAt.seconds) dt = new Date(r.readAt.seconds*1000);
      rows.push([
        dt?dt.toISOString().slice(0,19).replace('T',' '):'',
        r.line||'',
        r.sliced||'',
        getQuantity(r.sliced),
        r.raw || r.qr || ''
      ]);
    });
    const csv = rows.map(r=>r.map(f=>{ const s=String(f??''); return /[\",\n]/.test(s)?`"${s.replace(/\"/g,'\"\"')}"`:s; }).join(",")).join("\n");
    const blob=new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8"}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='production_export.csv'; a.click(); URL.revokeObjectURL(url);
  });

  /* ====== åˆæœŸãƒ­ãƒ¼ãƒ‰ ====== */
  async function reloadAll(){
    errEl.style.display='none';
    try{
      currentPage = 1; pageCursors=[null];
      const data = await fetchPage(1);
      allData = data.slice().reverse(); // æ˜‡é †ã§å†…éƒ¨ä¿æŒ
      populateSelectors(allData);
      renderTable(data);
      countEl.textContent = `å–å¾—ä»¶æ•°: ${data.length.toLocaleString()} / ãƒšãƒ¼ã‚¸ ${currentPage}`;
      btnPrev.disabled = true;
      btnNext.disabled = (data.length < PER_PAGE);
      pageInfo.textContent = `ãƒšãƒ¼ã‚¸ ${currentPage} / ${MAX_PAGES}`;
      await loadMasterFromFirestore();
      await loadWorkSettings();
      updateDashboard();
    }catch(e){
      console.error(e);
      errEl.textContent = 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
      errEl.style.display='block';
    }
  }

  // æ—¢å®šã¯LIVEã§ã‚¹ã‚¿ãƒ¼ãƒˆ â†’ ç„¡æ“ä½œã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
  await loadMasterFromFirestore();
  await loadWorkSettings();
  await startLiveToday();
  resetIdleTimer();
</script>
</body>
</html>
