<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ç”Ÿç”£å®Ÿç¸¾ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{ --fg:#111; --muted:#6b7280; --border:#e5e7eb; --bg:#f9fafb; --accent:#0369a1; --success:#059669; --danger:#dc2626; --warning:#d97706; }
  *{ box-sizing:border-box; }
  body{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin:0; color:var(--fg); background:var(--bg); line-height:1.5; }
  header{ background:#fff; border-bottom:2px solid var(--border); padding:16px 24px; display:flex; gap:16px; align-items:center; flex-wrap:wrap; position:sticky; top:0; z-index:10; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
  h1{ font-size:22px; margin:0; font-weight:700; color:var(--accent); }
  .badge{ font-size:12px; padding:4px 10px; border-radius:12px; border:1px solid var(--border); font-weight:500; }
  .badge.connected{ background:#d1fae5; color:var(--success); border-color:#6ee7b7; }
  .badge.disconnected{ background:#fee2e2; color:var(--danger); border-color:#fecaca; }
  main{ padding:24px; max-width:1600px; margin:0 auto; }
  .panel{ background:#fff; border:1px solid var(--border); border-radius:16px; padding:20px; margin-bottom:20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
  .filter-grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); margin-bottom:16px; }
  label{ font-size:13px; font-weight:600; color:var(--muted); display:block; margin-bottom:6px; }
  input, select{ border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:14px; background:#fff; width:100%; transition: border-color 0.2s; }
  input:focus, select:focus{ outline:none; border-color:var(--accent); }
  button{ border:1px solid var(--border); background:#fff; border-radius:10px; padding:10px 16px; cursor:pointer; font-size:14px; font-weight:500; transition: all 0.2s; }
  button:hover{ background:#f9fafb; }
  button.primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
  button.primary:hover{ background:#0284c7; }
  button.danger{ background:var(--danger); color:#fff; border-color:var(--danger); }
  button.danger:hover{ background:#b91c1c; }
  button.success{ background:var(--success); color:#fff; border-color:var(--success); }
  button:disabled{ opacity:.5; cursor:not-allowed; }
  table{ width:100%; border-collapse: collapse; }
  th, td{ border-bottom:1px solid var(--border); padding:12px; text-align:left; vertical-align:middle; }
  th{ font-size:12px; font-weight:700; color:var(--muted); background:#fafafa; text-transform:uppercase; letter-spacing:0.5px; }
  tbody tr:hover{ background:#f9fafb; }
  .controls{ display:flex; gap:10px; align-items:center; margin-left:auto; flex-wrap:wrap; }
  .error{ color:var(--danger); font-size:13px; font-weight:500; }
  .success{ color:var(--success); font-size:13px; font-weight:500; }
  .small{ font-size:13px; color:var(--muted); }
  .right{ text-align:right; }
  .center{ text-align:center; }
  .pager{ display:flex; gap:10px; align-items:center; justify-content:center; }
  .stats-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:16px; margin-bottom:24px; }
  .stat-card{ background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius:14px; padding:20px; border:1px solid #bae6fd; }
  .stat-card.success{ background:linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-color:#bbf7d0; }
  .stat-card.warning{ background:linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border-color:#fde68a; }
  .stat-card.danger{ background:linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border-color:#fecaca; }
  .stat-value{ font-size:32px; font-weight:700; color:var(--accent); line-height:1; }
  .stat-label{ font-size:13px; color:var(--muted); margin-top:8px; font-weight:500; }
  .chart-container{ position:relative; height:350px; margin-bottom:16px; }
  h2{ font-size:18px; margin:0 0 16px 0; color:var(--fg); font-weight:700; display:flex; align-items:center; gap:8px; }
  h2::before{ content:""; width:4px; height:20px; background:var(--accent); border-radius:2px; }
  .tabs{ display:flex; gap:4px; margin-bottom:20px; border-bottom:2px solid var(--border); background:#fff; border-radius:12px 12px 0 0; padding:0 20px; }
  .tab{ padding:14px 24px; cursor:pointer; border-bottom:3px solid transparent; color:var(--muted); font-weight:600; font-size:14px; transition: all 0.2s; margin-bottom:-2px; }
  .tab:hover{ color:var(--fg); background:#f9fafb; }
  .tab.active{ color:var(--accent); border-bottom-color:var(--accent); }
  .tab-content{ display:none; }
  .tab-content.active{ display:block; }
  .note{ background:#fef3c7; border:1px solid #fbbf24; border-radius:12px; padding:16px; margin-bottom:20px; font-size:14px; line-height:1.6; }
  .note strong{ color:#92400e; }
  .action-bar{ display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; align-items:center; }
  .master-table-wrap{ overflow-x:auto; border:1px solid var(--border); border-radius:12px; }
  .nowrap{ white-space:nowrap; }
  .tableWrap{ max-height: 60vh; overflow:auto; border:1px solid var(--border); border-radius:12px; }
  .icon{ display:inline-block; width:20px; height:20px; }
  .msg-box{ padding:12px 16px; border-radius:10px; margin-bottom:16px; font-size:14px; font-weight:500; }
  .msg-box.success{ background:#d1fae5; color:var(--success); border:1px solid #6ee7b7; }
  .msg-box.error{ background:#fee2e2; color:var(--danger); border:1px solid #fecaca; }
  .line-card{ background:#fff; border:2px solid var(--border); border-radius:12px; padding:16px; transition: all 0.2s; }
  .line-card:hover{ border-color:var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .line-card-header{ font-size:18px; font-weight:700; color:var(--accent); margin-bottom:12px; display:flex; align-items:center; gap:8px; }
  .line-card-header::before{ content:"ğŸ­"; }
  .product-item{ display:flex; justify-content:space-between; padding:8px 12px; background:#f9fafb; border-radius:8px; margin-bottom:6px; }
  .product-name{ font-weight:600; color:var(--fg); }
  .product-qty{ font-size:16px; font-weight:700; color:var(--accent); }
  .line-card-footer{ margin-top:12px; padding-top:12px; border-top:1px solid var(--border); display:flex; justify-content:space-between; font-size:13px; color:var(--muted); }
  .highlight-stop{ background:#fef3c7; font-weight:600; color:var(--warning); }
  .manual-section{ margin-bottom:32px; }
  .manual-section h3{ font-size:20px; color:var(--accent); margin:0 0 16px 0; font-weight:700; padding-bottom:8px; border-bottom:2px solid var(--border); }
  .manual-section h4{ font-size:16px; color:var(--fg); margin:16px 0 8px 0; font-weight:600; }
  .manual-section p{ margin:8px 0; line-height:1.8; }
  .manual-section ul{ margin:8px 0; padding-left:24px; line-height:1.8; }
  .manual-section li{ margin:4px 0; }
  .manual-box{ background:#f0f9ff; border:1px solid #bae6fd; border-radius:10px; padding:16px; margin:12px 0; }
  .manual-box.warning{ background:#fef3c7; border-color:#fde68a; }
  .manual-box.success{ background:#d1fae5; border-color:#6ee7b7; }
  .example-box{ background:#f9fafb; border:1px solid var(--border); border-radius:8px; padding:12px; margin:12px 0; font-family:monospace; font-size:13px; }
  .color-legend{ display:inline-flex; align-items:center; gap:6px; margin-right:16px; }
  .color-box{ width:20px; height:20px; border-radius:4px; border:1px solid var(--border); }
.status-pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid var(--border);}
.status-on{background:#d1fae5;color:var(--success);border-color:#86efac;}
.status-off{background:#e5e7eb;color:#374151;border-color:#d1d5db;}
.time-range{font-size:12px;color:var(--muted);}
.product-item .time-range{margin-left:8px;}
</style>
</head>
<body>
<header>
  <h1>ğŸ“Š ç”Ÿç”£å®Ÿç¸¾ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
  <span id="fbStatus" class="badge">Firebase: æœªæ¥ç¶š</span>
  <div class="controls">
    <button id="btnExport">ğŸ“¥ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    <button id="btnReload" class="primary">ğŸ”„ ãƒ‡ãƒ¼ã‚¿å†å–å¾—</button>
  </div>
</header>

<main>
  <section class="panel">
    <div class="filter-grid">
  <div>
    <label for="bushoSel">éƒ¨ç½²</label>
    <select id="bushoSel">
      <option value="">ã™ã¹ã¦</option>
      <option>1G</option>
      <option>3G</option>
      <option>4G</option>
      <option>5G</option>
      <option>6G</option>
      <option>å“è³ª</option>
    </select>
  </div>
      <div>
        <label for="dateFrom">é–‹å§‹æ—¥</label>
        <input id="dateFrom" type="date" />
      </div>
      <div>
        <label for="dateTo">çµ‚äº†æ—¥</label>
        <input id="dateTo" type="date" />
      </div>
      <div>
        <label for="lineSel">ç”Ÿç”£ãƒ©ã‚¤ãƒ³</label>
        <select id="lineSel"><option value="">ã™ã¹ã¦</option></select>
      </div>
      <div>
        <label for="slicedSel">å“ç•ª</label>
        <select id="slicedSel"><option value="">ã™ã¹ã¦</option></select>
      </div>
      <div>
        <label for="hourGroup">æ™‚é–“å¸¯é›†è¨ˆ</label>
        <select id="hourGroup">
          <option value="1">1æ™‚é–“ã”ã¨</option>
          <option value="2">2æ™‚é–“ã”ã¨</option>
          <option value="4">4æ™‚é–“ã”ã¨</option>
          <option value="8">8æ™‚é–“ã”ã¨</option>
        </select>
      </div>
    </div>
    <div class="right">
      <button id="btnApply" class="primary">ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨</button>
    </div>
    <div id="err" class="error" style="display:none; margin-top:12px;"></div>
  </section>

  <div class="tabs">
    <div class="tab active" data-tab="dashboard">ğŸ“ˆ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
    <div class="tab" data-tab="master">âš™ï¸ QRãƒã‚¹ã‚¿ç®¡ç†</div>
    <div class="tab" data-tab="settings">ğŸ• ç¨¼åƒæ™‚é–“è¨­å®š</div>
    <div class="tab" data-tab="manual">ğŸ“– ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</div>
    <div class="tab" data-tab="detail">ğŸ“‹ è©³ç´°ãƒ‡ãƒ¼ã‚¿</div>
  </div>

  <div class="tab-content active" id="dashboard">
    <section class="panel">
      <h2>ãƒ©ã‚¤ãƒ³åˆ¥ç”Ÿç”£ã‚µãƒãƒªãƒ¼</h2>
      <div id="lineSummaryCards" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:16px;"></div>
    </section>

    <section class="panel">
      <h2>ãƒ©ã‚¤ãƒ³åˆ¥åœæ­¢æ™‚é–“è©³ç´°</h2>
      <div style="overflow-x:auto;">
        <table id="stopDetailTable">
          <thead>
            <tr>
              <th>ãƒ©ã‚¤ãƒ³</th>
              <th>ç”Ÿç”£å“ç•ª</th>
              <th>åœæ­¢é–‹å§‹æ™‚åˆ»</th>
              <th>åœæ­¢çµ‚äº†æ™‚åˆ»</th>
              <th class="right">åœæ­¢æ™‚é–“ï¼ˆåˆ†ï¼‰</th>
            </tr>
          </thead>
          <tbody id="stopDetailTbody"></tbody>
        </table>
      </div>
    </section>

    <section class="panel">
      <h2>ãƒ©ã‚¤ãƒ³åˆ¥åœæ­¢æ™‚é–“</h2>
      <div class="chart-container" style="height:300px;">
        <canvas id="stopTimeChart"></canvas>
      </div>
    </section>

    <section class="panel">
      <h2>æ™‚ç³»åˆ—ç”Ÿç”£æ¨ç§»ï¼ˆãƒ©ã‚¤ãƒ³åˆ¥ï¼‰</h2>
      <div class="chart-container">
        <canvas id="timeSeriesChart"></canvas>
      </div>
    </section>
  </div>

  <div class="tab-content" id="master">
    <section class="panel">
      <div class="note">
        <strong>ğŸ“ QRãƒã‚¹ã‚¿ã«ã¤ã„ã¦</strong><br>
        å“ç•ªã”ã¨ã«1å›ã®QRèª­ã¿å–ã‚Šã§ç”Ÿç”£ã•ã‚Œã‚‹å€‹æ•°ã‚’ç™»éŒ²ã§ãã¾ã™ã€‚<br>
        ä¾‹ï¼šå“ç•ªã€ŒABC-001ã€ã‚’1å›èª­ã¿å–ã‚‹ã¨10å€‹ç”Ÿç”£ã•ã‚Œã‚‹å ´åˆã€å€‹æ•°ã«ã€Œ10ã€ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚<br>
        ãƒã‚¹ã‚¿æœªç™»éŒ²ã®å“ç•ªã¯ã€èª­å–ä»¶æ•°ï¼ç”Ÿç”£å€‹æ•°ã¨ã—ã¦è¨ˆç®—ã•ã‚Œã¾ã™ï¼ˆå€‹æ•°=1ï¼‰ã€‚<br>
        <strong>ğŸ’¾ ãƒã‚¹ã‚¿ã¯Firebaseã«ä¿å­˜ã•ã‚Œã€ãƒãƒ¼ãƒ å…¨ä½“ã§å…±æœ‰ã•ã‚Œã¾ã™ã€‚</strong>
      </div>

      <div class="action-bar">
        <button id="btnAddMaster" class="primary">â• æ–°è¦è¿½åŠ </button>
        <button id="btnReloadMaster" class="success">ğŸ”„ Firebaseã‹ã‚‰å†èª­è¾¼</button>
        <button id="btnExportMaster">ğŸ“¥ ãƒã‚¹ã‚¿CSVå‡ºåŠ›</button>
        <button id="btnImportMaster">ğŸ“¤ ãƒã‚¹ã‚¿CSVå–è¾¼</button>
        <input type="file" id="fileImportMaster" accept=".csv" style="display:none;" />
        <div style="margin-left:auto;">
          <span class="stat-value" id="registeredMaster" style="font-size:24px; font-weight:700; color:var(--accent);">0</span>
          <span class="small">ä»¶ç™»éŒ²æ¸ˆã¿</span>
        </div>
      </div>

      <div id="masterMsg"></div>

      <div class="master-table-wrap">
        <table>
          <thead>
            <tr>
              <th>å“ç•ªï¼ˆåˆ‡ã‚Šå‡ºã—å€¤ï¼‰</th>
              <th class="center">ç”Ÿç”£å€‹æ•°/å›</th>
              <th class="center" style="width:120px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="masterTbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <div class="tab-content" id="settings">
    <section class="panel">
      <div class="note">
        <strong>ğŸ• ç¨¼åƒæ™‚é–“è¨­å®šã«ã¤ã„ã¦</strong><br>
        éç¨¼åƒã®æ›œæ—¥ã‚„æ™‚é–“å¸¯ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€åœæ­¢æ™‚é–“ã®è¨ˆç®—ã‹ã‚‰é™¤å¤–ã§ãã¾ã™ã€‚<br>
        ä¾‹ï¼šåœŸæ—¥ãŒä¼‘ã¿ã€å¹³æ—¥12:00-13:00ãŒæ˜¼ä¼‘æ†©ã®å ´åˆã€ãã®æ™‚é–“ã¯åœæ­¢æ™‚é–“ã«ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã¾ã›ã‚“ã€‚<br>
        ä¼‘æ†©æ™‚é–“ã¯è¤‡æ•°è¨­å®šã§ãã¾ã™ï¼ˆæ˜¼ä¼‘æ†©ã€åˆå¾Œã®å°ä¼‘æ†©ãªã©ï¼‰ã€‚<br>
        <strong>ğŸŒ™ æ—¥ã‚’ã¾ãŸãè¨­å®šã‚‚å¯èƒ½ï¼š</strong>å¤œå‹¤ã®å ´åˆã€é–‹å§‹æ™‚åˆ»20:00ãƒ»çµ‚äº†æ™‚åˆ»06:00ã®ã‚ˆã†ã«è¨­å®šã§ãã¾ã™ã€‚<br>
        <strong>ğŸ’¾ è¨­å®šã¯Firebaseã«ä¿å­˜ã•ã‚Œã€ãƒãƒ¼ãƒ å…¨ä½“ã§å…±æœ‰ã•ã‚Œã¾ã™ã€‚</strong>
      </div>

      <div id="settingsMsg"></div>

      <div style="margin-bottom:24px;">
        <h2>ç¨¼åƒæ›œæ—¥</h2>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
            <input type="checkbox" id="day0" value="0" />
            <span>æ—¥æ›œæ—¥</span>
          </label>
          <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
            <input type="checkbox" id="day1" value="1" checked />
            <span>æœˆæ›œæ—¥</span>
          </label>
          <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
            <input type="checkbox" id="day2" value="2" checked />
            <span>ç«æ›œæ—¥</span>
          </label>
          <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
            <input type="checkbox" id="day3" value="3" checked />
            <span>æ°´æ›œæ—¥</span>
          </label>
          <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
            <input type="checkbox" id="day4" value="4" checked />
            <span>æœ¨æ›œæ—¥</span>
          </label>
          <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
            <input type="checkbox" id="day5" value="5" checked />
            <span>é‡‘æ›œæ—¥</span>
          </label>
          <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
            <input type="checkbox" id="day6" value="6" />
            <span>åœŸæ›œæ—¥</span>
          </label>
        </div>
      </div>

      <div style="margin-bottom:24px;">
        <h2>ç¨¼åƒæ™‚é–“å¸¯</h2>
        <div style="display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); max-width:800px;">
          <div>
            <label for="workStartTime">é–‹å§‹æ™‚åˆ»</label>
            <input type="time" id="workStartTime" value="08:00" />
          </div>
          <div>
            <label for="workEndTime">çµ‚äº†æ™‚åˆ»</label>
            <input type="time" id="workEndTime" value="17:00" />
          </div>
        </div>
      </div>

      <div style="margin-bottom:24px;">
        <h2>ä¼‘æ†©æ™‚é–“</h2>
        <div id="breaksContainer"></div>
        <button id="btnAddBreak" style="margin-top:12px;">â• ä¼‘æ†©æ™‚é–“ã‚’è¿½åŠ </button>
      </div>

      <div class="right">
        <button id="btnSaveSettings" class="primary">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
      </div>
    </section>
  </div>

  <div class="tab-content" id="manual">
    <section class="panel">
      <h1 style="font-size:24px; margin:0 0 24px 0; color:var(--accent);">ğŸ“– ç”Ÿç”£å®Ÿç¸¾ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</h1>

      <div class="manual-section">
        <h3>ğŸ”´ åœæ­¢æ™‚é–“ã®å®šç¾©ã¨è¨ˆç®—æ–¹æ³•</h3>
        
        <div class="manual-box warning">
          <strong>âš ï¸ é‡è¦ï¼šåœæ­¢æ™‚é–“ã¨ã¯</strong><br>
          åŒã˜å“ç•ªã‚’é€£ç¶šç”Ÿç”£ã—ã¦ã„ã‚‹éš›ã«ã€QRèª­ã¿å–ã‚Šã®é–“éš”ãŒ<strong>15åˆ†ä»¥ä¸Š</strong>ç©ºã„ãŸå ´åˆã«ç™ºç”Ÿã™ã‚‹æ™‚é–“ã‚’æŒ‡ã—ã¾ã™ã€‚
        </div>

        <h4>âœ… åœæ­¢æ™‚é–“ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹æ¡ä»¶</h4>
        <ul>
          <li><strong>åŒä¸€å“ç•ª</strong>ã®é€£ç¶šç”Ÿç”£ä¸­ã§ã‚ã‚‹ã“ã¨</li>
          <li>å‰å›ã®QRèª­ã¿å–ã‚Šã‹ã‚‰<strong>15åˆ†ä»¥ä¸Š</strong>çµŒéã—ã¦ã„ã‚‹ã“ã¨</li>
          <li>éç¨¼åƒæ™‚é–“ï¼ˆä¼‘æ†©ãƒ»ä¼‘æ—¥ãƒ»ç¨¼åƒæ™‚é–“å¤–ï¼‰ã‚’<strong>é™¤å¤–</strong>ã—ãŸå®Ÿè³ªæ™‚é–“ãŒ15åˆ†ä»¥ä¸Šã§ã‚ã‚‹ã“ã¨</li>
        </ul>

        <h4>âŒ åœæ­¢æ™‚é–“ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œãªã„ã‚±ãƒ¼ã‚¹</h4>
        <ul>
          <li><strong>å“ç•ªåˆ‡ã‚Šæ›¿ãˆæ™‚</strong>ï¼šå“ç•ªAã‹ã‚‰å“ç•ªBã¸ã®åˆ‡ã‚Šæ›¿ãˆã¯æ®µå–ã‚Šæ›¿ãˆã®ãŸã‚åœæ­¢ã«ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„</li>
          <li><strong>15åˆ†æœªæº€ã®é–“éš”</strong>ï¼šé€šå¸¸ã®ç”Ÿç”£ã‚µã‚¤ã‚¯ãƒ«å†…ã¨åˆ¤æ–­</li>
          <li><strong>éç¨¼åƒæ™‚é–“</strong>ï¼šåœŸæ—¥ç¥æ—¥ã€ç¨¼åƒæ™‚é–“å¤–ã€ä¼‘æ†©æ™‚é–“ã¯è‡ªå‹•çš„ã«é™¤å¤–</li>
        </ul>

        <h4>ğŸ“Š è¨ˆç®—ä¾‹</h4>
        <div class="example-box">
<strong>ã‚±ãƒ¼ã‚¹1ï¼šåœæ­¢æ™‚é–“ã‚ã‚Š</strong>
10:00 å“ç•ªAç”Ÿç”£ â†’ 10:35 å“ç•ªAç”Ÿç”£
é–“éš”ï¼š35åˆ† â†’ <span style="color:#dc2626; font-weight:bold;">åœæ­¢æ™‚é–“ 20åˆ†</span>ï¼ˆ15åˆ†é–¾å€¤ã‚’è¶…éï¼‰

<strong>ã‚±ãƒ¼ã‚¹2ï¼šåœæ­¢æ™‚é–“ãªã—ï¼ˆå“ç•ªåˆ‡æ›¿ï¼‰</strong>
10:00 å“ç•ªAç”Ÿç”£ â†’ 10:30 å“ç•ªBç”Ÿç”£
é–“éš”ï¼š30åˆ† â†’ <span style="color:#059669; font-weight:bold;">åœæ­¢ãªã—</span>ï¼ˆå“ç•ªãŒç•°ãªã‚‹ãŸã‚æ®µå–ã‚Šæ›¿ãˆï¼‰

<strong>ã‚±ãƒ¼ã‚¹3ï¼šéç¨¼åƒæ™‚é–“ã‚’é™¤å¤–</strong>
é‡‘æ›œ 17:00 å“ç•ªAç”Ÿç”£ â†’ æœˆæ›œ 08:30 å“ç•ªAç”Ÿç”£
é–“éš”ï¼š63.5æ™‚é–“
- åœŸæ—¥ï¼š48æ™‚é–“ï¼ˆéç¨¼åƒï¼‰
- é‡‘æ›œ17:00-æœˆæ›œ08:00ï¼š15æ™‚é–“ï¼ˆéç¨¼åƒï¼‰
- å®Ÿè³ªåœæ­¢ï¼š30åˆ† â†’ <span style="color:#d97706; font-weight:bold;">åœæ­¢æ™‚é–“ 15åˆ†</span>
        </div>

        <h4>ğŸ¨ åœæ­¢æ™‚é–“ã®è‰²åˆ†ã‘ï¼ˆã‚°ãƒ©ãƒ•è¡¨ç¤ºï¼‰</h4>
        <div style="margin:12px 0;">
          <div class="color-legend">
            <div class="color-box" style="background:#dc2626;"></div>
            <span><strong>èµ¤è‰²ï¼š1æ™‚é–“ä»¥ä¸Š</strong> - é‡å¤§ãªåœæ­¢ã€è¦ç·Šæ€¥å¯¾å¿œ</span>
          </div>
          <div class="color-legend">
            <div class="color-box" style="background:#d97706;"></div>
            <span><strong>é»„è‰²ï¼š11åˆ†ã€œ59åˆ†</strong> - æ³¨æ„ãŒå¿…è¦ã€åŸå› èª¿æŸ»æ¨å¥¨</span>
          </div>
          <div class="color-legend">
            <div class="color-box" style="background:#0369a1;"></div>
            <span><strong>é’è‰²ï¼š10åˆ†ä»¥ä¸‹</strong> - æ­£å¸¸ç¯„å›²å†…</span>
          </div>
        </div>
      </div>

      <div class="manual-section">
        <h3>âš™ï¸ QRãƒã‚¹ã‚¿ç®¡ç†</h3>
        
        <div class="manual-box">
          <strong>ğŸ“ QRãƒã‚¹ã‚¿ã¨ã¯</strong><br>
          å“ç•ªã”ã¨ã«ã€Œ1å›ã®QRèª­ã¿å–ã‚Š = ä½•å€‹ã®ç”Ÿç”£ã€ã‹ã‚’å®šç¾©ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚
        </div>

        <h4>ä½¿ç”¨ä¾‹</h4>
        <p>å“ç•ªã€ŒABC-001ã€ã®QRã‚³ãƒ¼ãƒ‰ã‚’1å›èª­ã¿å–ã‚‹ã¨ã€å®Ÿéš›ã«ã¯10å€‹ã®è£½å“ãŒç”Ÿç”£ã•ã‚Œã‚‹å ´åˆï¼š</p>
        <div class="example-box">
å“ç•ªï¼šABC-001
ç”Ÿç”£å€‹æ•°/å›ï¼š10

â†’ QRã‚’5å›èª­ã¿å–ã‚Š = <strong>50å€‹ç”Ÿç”£</strong>ã¨è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™
        </div>

        <h4>ãƒã‚¹ã‚¿ç™»éŒ²æ–¹æ³•</h4>
        <ul>
          <li><strong>æ‰‹å‹•ç™»éŒ²</strong>ï¼šã€Œâ• æ–°è¦è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰1ä»¶ãšã¤ç™»éŒ²</li>
          <li><strong>CSVä¸€æ‹¬ç™»éŒ²</strong>ï¼šã€ŒğŸ“¤ ãƒã‚¹ã‚¿CSVå–è¾¼ã€ã§è¤‡æ•°å“ç•ªã‚’ä¸€æ‹¬ç™»éŒ²</li>
          <li><strong>CSVå‡ºåŠ›</strong>ï¼šã€ŒğŸ“¥ ãƒã‚¹ã‚¿CSVå‡ºåŠ›ã€ã§ç¾åœ¨ã®è¨­å®šã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</li>
        </ul>

        <h4>CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</h4>
        <div class="example-box">
å“ç•ª,ç”Ÿç”£å€‹æ•°
ABC-001,10
XYZ-999,5
DEF-123,20
        </div>

        <div class="manual-box success">
          <strong>ğŸ’¾ è‡ªå‹•åŒæœŸ</strong><br>
          ãƒã‚¹ã‚¿ã¯Firebaseã«ä¿å­˜ã•ã‚Œã€ãƒãƒ¼ãƒ å…¨å“¡ãŒåŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ã§ãã¾ã™ã€‚
        </div>
      </div>

      <div class="manual-section">
        <h3>ğŸ• ç¨¼åƒæ™‚é–“è¨­å®š</h3>
        
        <p>å·¥å ´ã®ç¨¼åƒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€åœæ­¢æ™‚é–“ã®è¨ˆç®—ç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚</p>

        <h4>è¨­å®šé …ç›®</h4>
        <ul>
          <li><strong>ç¨¼åƒæ›œæ—¥</strong>ï¼šæœˆã€œæ—¥ã®ã†ã¡ç¨¼åƒã™ã‚‹æ›œæ—¥ã‚’é¸æŠ</li>
          <li><strong>ç¨¼åƒæ™‚é–“</strong>ï¼šé–‹å§‹æ™‚åˆ»ã¨çµ‚äº†æ™‚åˆ»ã‚’è¨­å®šï¼ˆä¾‹ï¼š8:00ã€œ17:00ï¼‰</li>
          <li><strong>ä¼‘æ†©æ™‚é–“</strong>ï¼šè¤‡æ•°ã®ä¼‘æ†©æ™‚é–“ã‚’è¨­å®šå¯èƒ½ï¼ˆæ˜¼ä¼‘æ†©ã€å°ä¼‘æ†©ãªã©ï¼‰</li>
        </ul>

        <h4>æ—¥ã‚’ã¾ãŸãè¨­å®šï¼ˆå¤œå‹¤å¯¾å¿œï¼‰ğŸŒ™</h4>
        <p>å¤œå‹¤ãªã©ã€æ—¥ã‚’ã¾ãŸãç¨¼åƒæ™‚é–“ã‚‚è¨­å®šå¯èƒ½ã§ã™ï¼š</p>
        <div class="example-box">
<strong>ä¾‹ï¼šå¤œå‹¤ã®å ´åˆ</strong>
é–‹å§‹æ™‚åˆ»: 20:00
çµ‚äº†æ™‚åˆ»: 06:00

â†’ 20:00ï½ç¿Œæœ6:00ãŒç¨¼åƒæ™‚é–“ã¨ã—ã¦èªè­˜ã•ã‚Œã¾ã™
â†’ 22:00ã€0:00ã€2:00ãªã©ã‚‚ç¨¼åƒæ™‚é–“å†…ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™
        </div>

        <h4>ä¼‘æ†©æ™‚é–“ã®è¤‡æ•°è¨­å®š</h4>
        <p>ã€Œâ• ä¼‘æ†©æ™‚é–“ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã§ä½•å€‹ã§ã‚‚è¿½åŠ ã§ãã¾ã™ï¼š</p>
        <div class="example-box">
ä¼‘æ†©1: 12:00-13:00 âœ…æœ‰åŠ¹ï¼ˆæ˜¼ä¼‘æ†©ï¼‰
ä¼‘æ†©2: 10:00-10:15 âœ…æœ‰åŠ¹ï¼ˆåˆå‰ã®å°ä¼‘æ†©ï¼‰
ä¼‘æ†©3: 15:00-15:15 âœ…æœ‰åŠ¹ï¼ˆåˆå¾Œã®å°ä¼‘æ†©ï¼‰
ä¼‘æ†©4: 00:00-01:00 âœ…æœ‰åŠ¹ï¼ˆå¤œå‹¤ã®ä¼‘æ†©ãƒ»æ—¥ã‚’ã¾ãŸãå ´åˆã‚‚å¯ï¼‰
        </div>

        <div class="manual-box warning">
          <strong>âš ï¸ æ³¨æ„</strong><br>
          ç¨¼åƒæ™‚é–“è¨­å®šã‚’å¤‰æ›´ã—ãŸå¾Œã¯ã€ŒğŸ’¾ è¨­å®šã‚’ä¿å­˜ã€ã‚’å¿…ãšã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
        </div>
      </div>

      <div class="manual-section">
        <h3>ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®è¦‹æ–¹</h3>

        <h4>çµ±è¨ˆã‚«ãƒ¼ãƒ‰</h4>
        <ul>
          <li><strong>ç·ç”Ÿç”£å€‹æ•°</strong>ï¼šQRãƒã‚¹ã‚¿ã‚’è€ƒæ…®ã—ãŸå®Ÿéš›ã®ç”Ÿç”£æ•°</li>
          <li><strong>ç·èª­å–ä»¶æ•°</strong>ï¼šQRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ãŸå›æ•°ï¼ˆOKåˆ¤å®šã®ã¿ï¼‰</li>
          <li><strong>åœæ­¢æ™‚é–“</strong>ï¼šä¸Šè¨˜å®šç¾©ã«åŸºã¥ãå®Ÿè³ªåœæ­¢æ™‚é–“ã®åˆè¨ˆ</li>
          <li><strong>ç¨¼åƒãƒ©ã‚¤ãƒ³æ•°</strong>ï¼šæœŸé–“ä¸­ã«ç¨¼åƒã—ãŸãƒ©ã‚¤ãƒ³ã®æ•°</li>
          <li><strong>å“ç•ªæ•°</strong>ï¼šç”Ÿç”£ã—ãŸå“ç•ªã®ç¨®é¡æ•°</li>
          <li><strong>å¹³å‡ç”Ÿç”£å€‹æ•°/æ™‚é–“</strong>ï¼šæ™‚é–“ã‚ãŸã‚Šã®ç”Ÿç”£åŠ¹ç‡</li>
        </ul>

        <h4>ãƒ©ã‚¤ãƒ³åˆ¥ç”Ÿç”£ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰</h4>
        <p>å„ãƒ©ã‚¤ãƒ³ã”ã¨ã«ï¼š</p>
        <ul>
          <li>ç”Ÿç”£ã—ãŸå“ç•ªã¨å€‹æ•°ã‚’ä¸€è¦§è¡¨ç¤º</li>
          <li>ãƒ©ã‚¤ãƒ³åˆè¨ˆã®ç”Ÿç”£å€‹æ•°</li>
          <li>ãã®ãƒ©ã‚¤ãƒ³ã®ç·åœæ­¢æ™‚é–“</li>
        </ul>

        <h4>ãƒ©ã‚¤ãƒ³åˆ¥åœæ­¢æ™‚é–“è©³ç´°</h4>
        <p>åœæ­¢ãŒç™ºç”Ÿã—ãŸçŠ¶æ³ã‚’æ™‚ç³»åˆ—ã§è¡¨ç¤ºã€‚åœæ­¢æ™‚é–“ãŒé•·ã„é †ã«ã‚½ãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
        <ul>
          <li>ã©ã®ãƒ©ã‚¤ãƒ³ã§</li>
          <li>ä½•ã®å“ç•ªã‚’ç”Ÿç”£ä¸­ã«</li>
          <li>ã„ã¤ã‹ã‚‰ã„ã¤ã¾ã§</li>
          <li>ä½•åˆ†åœæ­¢ã—ãŸã‹</li>
        </ul>
        <p>éç¨¼åƒæ™‚é–“ãŒé™¤å¤–ã•ã‚ŒãŸå ´åˆã¯ã€æ‹¬å¼§å†…ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
      </div>

      <div class="manual-section">
        <h3>ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½</h3>
        
        <p>æœŸé–“ã‚„ãƒ©ã‚¤ãƒ³ã€å“ç•ªã§çµã‚Šè¾¼ã‚“ã§ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã§ãã¾ã™ã€‚</p>

        <h4>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é …ç›®</h4>
        <ul>
          <li><strong>é–‹å§‹æ—¥ãƒ»çµ‚äº†æ—¥</strong>ï¼šåˆ†æå¯¾è±¡æœŸé–“ã‚’æŒ‡å®š</li>
          <li><strong>ç”Ÿç”£ãƒ©ã‚¤ãƒ³</strong>ï¼šç‰¹å®šã®ãƒ©ã‚¤ãƒ³ã®ã¿è¡¨ç¤º</li>
          <li><strong>å“ç•ª</strong>ï¼šç‰¹å®šã®å“ç•ªã®ã¿è¡¨ç¤º</li>
          <li><strong>æ™‚é–“å¸¯é›†è¨ˆ</strong>ï¼šã‚°ãƒ©ãƒ•ã®æ™‚é–“è»¸ã‚’1/2/4/8æ™‚é–“å˜ä½ã§åˆ‡æ›¿</li>
        </ul>

        <p>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¨­å®šå¾Œã€ã€ŒğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</p>
      </div>

      <div class="manual-section">
        <h3>ğŸ“¥ CSVå‡ºåŠ›</h3>
        
        <p>ã€ŒğŸ“¥ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€ãƒœã‚¿ãƒ³ã§ã€ç¾åœ¨è¡¨ç¤ºä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚</p>

        <h4>å‡ºåŠ›å†…å®¹</h4>
        <ul>
          <li>æ™‚åˆ»</li>
          <li>ç”Ÿç”£ãƒ©ã‚¤ãƒ³</li>
          <li>å“ç•ª</li>
          <li>ç”Ÿç”£å€‹æ•°ï¼ˆãƒã‚¹ã‚¿è€ƒæ…®å¾Œï¼‰</li>
          <li>QRã‚³ãƒ¼ãƒ‰ï¼ˆç”Ÿãƒ‡ãƒ¼ã‚¿ï¼‰</li>
        </ul>

        <p>Excelãªã©ã§é–‹ã„ã¦ã€ã•ã‚‰ã«è©³ç´°ãªåˆ†æãŒå¯èƒ½ã§ã™ã€‚</p>
      </div>

      <div class="manual-section">
        <h3>ğŸ”„ ãƒ‡ãƒ¼ã‚¿å†å–å¾—</h3>
        
        <p>ã€ŒğŸ”„ ãƒ‡ãƒ¼ã‚¿å†å–å¾—ã€ãƒœã‚¿ãƒ³ã§ã€æœ€æ–°ã®QRãƒ­ã‚°ã‚’Firebaseã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã™ã€‚</p>
        <p>æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆã‚„ã€è¡¨ç¤ºãŒãŠã‹ã—ã„å ´åˆã«ã”åˆ©ç”¨ãã ã•ã„ã€‚</p>
      </div>

      <div class="manual-section">
        <h3>â“ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h3>
        
        <h4>ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œãªã„</h4>
        <ul>
          <li>Firebaseæ¥ç¶šçŠ¶æ…‹ã‚’ç¢ºèªï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å³ä¸Šã®ãƒãƒƒã‚¸ï¼‰</li>
          <li>ã€ŒğŸ”„ ãƒ‡ãƒ¼ã‚¿å†å–å¾—ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
          <li>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ãŒå³ã—ã™ããªã„ã‹ç¢ºèª</li>
        </ul>

        <h4>åœæ­¢æ™‚é–“ãŒæƒ³å®šã¨é•ã†</h4>
        <ul>
          <li>ç¨¼åƒæ™‚é–“è¨­å®šã‚’ç¢ºèªï¼ˆä¼‘æ†©æ™‚é–“ã€éç¨¼åƒæ—¥ã®è¨­å®šï¼‰</li>
          <li>åœæ­¢æ™‚é–“ã®å®šç¾©ï¼ˆ15åˆ†é–¾å€¤ã€å“ç•ªåˆ‡æ›¿é™¤å¤–ï¼‰ã‚’å†ç¢ºèª</li>
          <li>ã€Œãƒ©ã‚¤ãƒ³åˆ¥åœæ­¢æ™‚é–“è©³ç´°ã€ã§å€‹åˆ¥ã‚±ãƒ¼ã‚¹ã‚’ç¢ºèª</li>
        </ul>

        <h4>ãƒã‚¹ã‚¿ãŒåæ˜ ã•ã‚Œãªã„</h4>
        <ul>
          <li>ã€ŒğŸ”„ Firebaseã‹ã‚‰å†èª­è¾¼ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
          <li>ã€ŒğŸ’¾ è¨­å®šã‚’ä¿å­˜ã€ã‚’æŠ¼ã—ãŸã‹ç¢ºèª</li>
          <li>ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ãƒªãƒ­ãƒ¼ãƒ‰</li>
        </ul>
      </div>

      <div class="manual-box success" style="margin-top:32px;">
        <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ</strong><br>
        ã“ã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã¯ã„ã¤ã§ã‚‚ã€ŒğŸ“– ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã€ã‚¿ãƒ–ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚<br>
        ä¸æ˜ç‚¹ãŒã‚ã‚Œã°ã€ã“ã®ãƒšãƒ¼ã‚¸ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
      </div>
    </section>
  </div>

  <div class="tab-content" id="detail">
    <section class="panel">
      <div class="note">
        <strong>ğŸ“ QRãƒã‚¹ã‚¿ã«ã¤ã„ã¦</strong><br>
        å“ç•ªã”ã¨ã«1å›ã®QRèª­ã¿å–ã‚Šã§ç”Ÿç”£ã•ã‚Œã‚‹å€‹æ•°ã‚’ç™»éŒ²ã§ãã¾ã™ã€‚<br>
        ä¾‹ï¼šå“ç•ªã€ŒABC-001ã€ã‚’1å›èª­ã¿å–ã‚‹ã¨10å€‹ç”Ÿç”£ã•ã‚Œã‚‹å ´åˆã€å€‹æ•°ã«ã€Œ10ã€ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚<br>
        ãƒã‚¹ã‚¿æœªç™»éŒ²ã®å“ç•ªã¯ã€èª­å–ä»¶æ•°ï¼ç”Ÿç”£å€‹æ•°ã¨ã—ã¦è¨ˆç®—ã•ã‚Œã¾ã™ï¼ˆå€‹æ•°=1ï¼‰ã€‚<br>
        <strong>ğŸ’¾ ãƒã‚¹ã‚¿ã¯Firebaseã«ä¿å­˜ã•ã‚Œã€ãƒãƒ¼ãƒ å…¨ä½“ã§å…±æœ‰ã•ã‚Œã¾ã™ã€‚</strong>
      </div>

      <div class="action-bar">
        <button id="btnAddMaster" class="primary">â• æ–°è¦è¿½åŠ </button>
        <button id="btnReloadMaster" class="success">ğŸ”„ Firebaseã‹ã‚‰å†èª­è¾¼</button>
        <button id="btnExportMaster">ğŸ“¥ ãƒã‚¹ã‚¿CSVå‡ºåŠ›</button>
        <button id="btnImportMaster">ğŸ“¤ ãƒã‚¹ã‚¿CSVå–è¾¼</button>
        <input type="file" id="fileImportMaster" accept=".csv" style="display:none;" />
        <div style="margin-left:auto;">
          <span class="stat-value" id="registeredMaster" style="font-size:24px;">0</span>
          <span class="small">ä»¶ç™»éŒ²æ¸ˆã¿</span>
        </div>
      </div>

      <div id="masterMsg"></div>

      <div class="master-table-wrap">
        <table>
          <thead>
            <tr>
              <th>å“ç•ªï¼ˆåˆ‡ã‚Šå‡ºã—å€¤ï¼‰</th>
              <th class="center">ç”Ÿç”£å€‹æ•°/å›</th>
              <th class="center" style="width:120px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="masterTbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <div class="tab-content" id="detail">
    <section class="panel">
      <div class="pager" style="margin: 0 0 16px 0;">
        <button id="btnPrev" disabled>â¬…ï¸ å‰ã¸</button>
        <span id="pageInfo" class="small">ãƒšãƒ¼ã‚¸ 1 / 10</span>
        <button id="btnNext" disabled>æ¬¡ã¸ â¡ï¸</button>
      </div>
      <div style="margin-bottom:12px;">
        <span id="count" class="small"></span>
      </div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th class="nowrap">ç«¯æœ«æ™‚åˆ»</th>
              <th>ç”Ÿç”£ãƒ©ã‚¤ãƒ³</th>
              <th>å“ç•ª</th>
              <th class="center">ç”Ÿç”£å€‹æ•°</th>
              <th>QR(raw)</th>
              <th class="center">çµæœ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script type="module">
// === ãƒ©ã‚¤ãƒ³åˆ¥ ç”Ÿç”£ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ ===
// è¿”ã‚Šå€¤: { [line]: { active: {product, start, last}, sessions: [{product,start,end}] , currentProduct: string|null } }
function buildLineSessions(data){
  const lineMap = {};
  // OKã®ã¿å¯¾è±¡ï¼ˆæ—¢å­˜ä»•æ§˜ã«åˆã‚ã›ã‚‹ï¼‰
  const rows = data.filter(r => (r.judge || r.result || '') === 'OK')
                   .map(r => ({ ...r, _time: parseLogTime(r) }))
                   .filter(r => r._time);

  // ãƒ©ã‚¤ãƒ³â†’æ™‚ç³»åˆ—
  const byLine = {};
  rows.forEach(r=>{
    const line = r.line || 'ä¸æ˜';
    if(!byLine[line]) byLine[line] = [];
    byLine[line].push(r);
  });
  Object.keys(byLine).forEach(line => byLine[line].sort((a,b)=>a._time - b._time));

  // ãƒ©ã‚¤ãƒ³ã”ã¨ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³åŒ–
  Object.keys(byLine).forEach(line=>{
    const list = byLine[line];
    const sessions = [];
    let cur = null;

    // ç›´è¿‘â€œåŸºæº–â†’ç…§åˆä¸­â€ã®æµã‚Œã‚’è¦šãˆã‚‹
    let seenBaseAfterChange = false;

    for(let i=0;i<list.length;i++){
      const r = list[i];
      const product = r.sliced || 'ä¸æ˜';

      if(!cur){
        cur = { product, start: r._time, last: r._time };
        seenBaseAfterChange = isBaseState(r); // ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ç›´å¾Œã®åŸºæº–QR
        continue;
      }

      // å“ç•ªãŒå¤‰ã‚ã£ãŸã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºå®š
      if(product !== cur.product){
        sessions.push({ product: cur.product, start: cur.start, end: cur.last });
        // æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
        cur = { product, start: r._time, last: r._time };
        seenBaseAfterChange = isBaseState(r);
        continue;
      }

      // åŒä¸€å“ç•ªç¶™ç¶š
      cur.last = r._time;
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã«â€œç…§åˆä¸­â€ãŒè¦³æ¸¬ã•ã‚ŒãŸã‚‰è¦šãˆã‚‹
      if(isVerifyingState(r)) seenBaseAfterChange = true;
    }
    if(cur){
      sessions.push({ product: cur.product, start: cur.start, end: cur.last }); // æœ€å¾Œã‚‚ç¢ºå®šï¼ˆend = lastï¼‰
    }

    // ç¾åœ¨ç”Ÿç”£ä¸­ã®æ¨å®š
    let currentProduct = null;
    let active = null;
    if(list.length){
      const last = list[list.length-1];
      const minutesFromLast = (Date.now() - last._time.getTime())/60000;
      const hasVerifyFlow = seenBaseAfterChange; // ã€ŒåŸºæº–â†’ç…§åˆä¸­ã€ã‚’è¦‹ãŸã‹
      const fallbackActive = minutesFromLast <= VERIFY_WINDOW_MIN; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

      if(hasVerifyFlow || fallbackActive){
        currentProduct = last.sliced || 'ä¸æ˜';
        active = { product: currentProduct, start: sessions.length ? sessions[sessions.length-1].start : last._time, last: last._time };
      }
    }

    lineMap[line] = { active, sessions, currentProduct };
  });

  return lineMap;
}

// === ç”Ÿç”£çŠ¶æ…‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===
const VERIFY_WINDOW_MIN = 30; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ã€Œç”Ÿç”£ä¸­ã€ã¨ã¿ãªã™æ™‚é–“ï¼ˆåˆ†ï¼‰
function parseLogTime(r){
  if (r.ts) return parseClientDate(r.ts);
  if (r.readAt && r.readAt.seconds) return new Date(r.readAt.seconds*1000);
  return null;
}
// ãƒ­ã‚°å†…ã®çŠ¶æ…‹ã£ã½ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’åºƒãæ‹¾ã†
function extractState(r){
  const candidates = [r.state, r.status, r.phase, r.mode, r.step, r.judge, r.result, r.flag, r.tag, r.kind, r.type, r.note, r.message, r.msg];
  const joined = (candidates.filter(Boolean).join(' ') || '').toLowerCase();
  return joined;
}
// ã€ŒåŸºæº–QR/ç…§åˆä¸­ã€ã‚‰ã—ã•ã®åˆ¤å®šï¼ˆæ—¥æœ¬èª/è‹±èªã©ã¡ã‚‰ã‚‚æ‹¾ã†ï¼‰
function isVerifyingState(r){
  const s = extractState(r);
  return /(ç…§åˆ|verify|verifying|checking|compare|æ¯”è¼ƒ)/.test(s);
}
function isBaseState(r){
  const s = extractState(r);
  return /(åŸºæº–|base|åŸºæº–qr)/.test(s);
}

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, collection, query, orderBy, limit, getDocs, startAfter, doc, setDoc, deleteDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const fbStatus = document.getElementById("fbStatus");
  const tbody = document.getElementById("tbody");
  const masterTbody = document.getElementById("masterTbody");
  const masterMsg = document.getElementById("masterMsg");
  const settingsMsg = document.getElementById("settingsMsg");
  const btnExport = document.getElementById("btnExport");
  const btnReload = document.getElementById("btnReload");
  const btnApply = document.getElementById("btnApply");
  const btnPrev = document.getElementById("btnPrev");
  const btnNext = document.getElementById("btnNext");
  const pageInfo = document.getElementById("pageInfo");
  const errEl = document.getElementById("err");
  const countEl = document.getElementById("count");

  const lineSel = document.getElementById("lineSel");
  const slicedSel = document.getElementById("slicedSel");
  const hourGroup = document.getElementById("hourGroup");
  const dateFrom = document.getElementById("dateFrom");
  const dateTo = document.getElementById("dateTo");
const bushoSel = document.getElementById("bushoSel");

function getCurrentFilters() {
  return {
    line: lineSel.value,
    sliced: slicedSel.value,
    busho: bushoSel.value,  // è¿½åŠ 
    dateFrom: dateFrom.value,
    dateTo: dateTo.value,
    hourGroup: hourGroup.value
  }
}

function filterData(allData, filters) {
  return allData.filter(row => {
    if (filters.line && row.line !== filters.line) return false;
    if (filters.sliced && row.sliced !== filters.sliced) return false;
    if (filters.busho && row.busho !== filters.busho) return false; // è¿½åŠ 
    // ...æ—¢å­˜ã®æœŸé–“åˆ¤å®šãªã©
    return true;
  });
}
  const app = initializeApp({
    apiKey: "AIzaSyDb62GTdYU_zksCYiQyr9-WERZLFrztJ1U",
    authDomain: "miyama-seizo.firebaseapp.com",
    projectId: "miyama-seizo",
  });
  const auth = getAuth(app);
  const db = getFirestore(app);

  function setFbStatus(t, connected){ 
    fbStatus.textContent = "Firebase: " + t;
    fbStatus.className = "badge " + (connected ? "connected" : "disconnected");
  }
  
  try{ 
    await signInAnonymously(auth); 
    setFbStatus("æ¥ç¶šæ¸ˆã¿", true); 
  }catch(e){ 
    console.warn(e); 
    setFbStatus("æœªæ¥ç¶š", false); 
  }

  const PER_PAGE = 2000;
  const MAX_PAGES = 10;
  const STOP_THRESHOLD_MINUTES = 15;

  let currentPage = 1;
  let pageCursors = [null];
  let currentDocs = [];
  let allData = [];
  let qrMaster = {};
  let workSettings = {
    workingDays: [1, 2, 3, 4, 5], // æœˆ-é‡‘
    workStart: "08:00",
    workEnd: "17:00",
    breaks: [
      { start: "12:00", end: "13:00", enabled: true }
    ]
  };

  let charts = { timeSeries: null, stopTime: null };
  let realtimeUnsubscribe = null; // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã®è§£é™¤ç”¨
  
  // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ç”¨ã®å¤‰æ•°
  let autoUpdateInterval = null;
  let lastActivityTime = Date.now();
  const INACTIVITY_TIMEOUT = 5 * 60 * 1000; // 5åˆ†é–“æ“ä½œãªã—
  const AUTO_UPDATE_INTERVAL = 30 * 1000; // 30ç§’ã”ã¨

  // Firestoreã‹ã‚‰ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
  async function loadMasterFromFirestore(){
    try{
      const masterCol = collection(db, "qrMaster");
      const masterSnap = await getDocs(masterCol);
      qrMaster = {};
      masterSnap.forEach(doc => {
        const data = doc.data();
        qrMaster[doc.id] = data.quantity || 1;
      });
      renderMasterTable();
      showMasterMsg(`${Object.keys(qrMaster).length}ä»¶ã®ãƒã‚¹ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success');
    }catch(e){
      console.warn("ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
      showMasterMsg('ãƒã‚¹ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
  }

  // ç¨¼åƒæ™‚é–“è¨­å®šã‚’èª­ã¿è¾¼ã¿
  async function loadWorkSettings(){
    try{
      const docRef = doc(db, "settings", "workSchedule");
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        workSettings = {
          workingDays: data.workingDays || [1, 2, 3, 4, 5],
          workStart: data.workStart || "08:00",
          workEnd: data.workEnd || "17:00",
          breaks: data.breaks || [{ start: "12:00", end: "13:00", enabled: true }]
        };
        applyWorkSettingsToUI();
        showSettingsMsg('ç¨¼åƒæ™‚é–“è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
      } else {
        applyWorkSettingsToUI();
      }
    }catch(e){
      console.warn("è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
      applyWorkSettingsToUI();
    }
  }

  // ç¨¼åƒæ™‚é–“è¨­å®šã‚’Firestoreã«ä¿å­˜
  async function saveWorkSettings(){
    try{
      const docRef = doc(db, "settings", "workSchedule");
      await setDoc(docRef, {
        ...workSettings,
        updatedAt: new Date()
      });
      return true;
    }catch(e){
      console.warn("è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
      return false;
    }
  }

  function renderBreaksUI(){
    const container = document.getElementById('breaksContainer');
    container.innerHTML = '';
    
    workSettings.breaks.forEach((breakTime, index) => {
      const breakDiv = document.createElement('div');
      breakDiv.style.cssText = 'display:flex; gap:12px; align-items:end; margin-bottom:12px; padding:12px; background:#f9fafb; border-radius:10px;';
      breakDiv.innerHTML = `
        <div style="flex:1;">
          <label style="font-size:12px; font-weight:600; color:var(--muted); display:block; margin-bottom:6px;">é–‹å§‹æ™‚åˆ»</label>
          <input type="time" class="break-start" data-index="${index}" value="${breakTime.start}" style="width:100%;" />
        </div>
        <div style="flex:1;">
          <label style="font-size:12px; font-weight:600; color:var(--muted); display:block; margin-bottom:6px;">çµ‚äº†æ™‚åˆ»</label>
          <input type="time" class="break-end" data-index="${index}" value="${breakTime.end}" style="width:100%;" />
        </div>
        <label style="display:flex; align-items:center; gap:6px; cursor:pointer; white-space:nowrap;">
          <input type="checkbox" class="break-enabled" data-index="${index}" ${breakTime.enabled ? 'checked' : ''} />
          <span>æœ‰åŠ¹</span>
        </label>
        <button class="danger btn-remove-break" data-index="${index}" style="white-space:nowrap;">ğŸ—‘ï¸ å‰Šé™¤</button>
      `;
      container.appendChild(breakDiv);
    });

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    container.querySelectorAll('.break-start').forEach(input => {
      input.addEventListener('change', (e) => {
        const idx = parseInt(e.target.dataset.index);
        workSettings.breaks[idx].start = e.target.value;
      });
    });
    container.querySelectorAll('.break-end').forEach(input => {
      input.addEventListener('change', (e) => {
        const idx = parseInt(e.target.dataset.index);
        workSettings.breaks[idx].end = e.target.value;
      });
    });
    container.querySelectorAll('.break-enabled').forEach(input => {
      input.addEventListener('change', (e) => {
        const idx = parseInt(e.target.dataset.index);
        workSettings.breaks[idx].enabled = e.target.checked;
      });
    });
    container.querySelectorAll('.btn-remove-break').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const idx = parseInt(e.target.dataset.index);
        workSettings.breaks.splice(idx, 1);
        renderBreaksUI();
      });
    });
  }

  function applyWorkSettingsToUI(){
    for (let i = 0; i <= 6; i++) {
      const checkbox = document.getElementById(`day${i}`);
      if (checkbox) {
        checkbox.checked = workSettings.workingDays.includes(i);
      }
    }
    document.getElementById('workStartTime').value = workSettings.workStart;
    document.getElementById('workEndTime').value = workSettings.workEnd;
    renderBreaksUI();
  }

  function readWorkSettingsFromUI(){
    const workingDays = [];
    for (let i = 0; i <= 6; i++) {
      const checkbox = document.getElementById(`day${i}`);
      if (checkbox && checkbox.checked) {
        workingDays.push(i);
      }
    }
    workSettings.workingDays = workingDays;
    workSettings.workStart = document.getElementById('workStartTime').value;
    workSettings.workEnd = document.getElementById('workEndTime').value;
    // breaksã¯æ—¢ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã•ã‚Œã¦ã„ã‚‹
  }

  async function saveMasterToFirestore(product, quantity){
    try{
      const docRef = doc(db, "qrMaster", product);
      await setDoc(docRef, { quantity, updatedAt: new Date() });
      return true;
    }catch(e){
      console.warn("ãƒã‚¹ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
      return false;
    }
  }

  async function deleteMasterFromFirestore(product){
    try{
      const docRef = doc(db, "qrMaster", product);
      await deleteDoc(docRef);
      return true;
    }catch(e){
      console.warn("ãƒã‚¹ã‚¿å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", e);
      return false;
    }
  }

  // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
    });
  });

  function getQuantity(sliced){
    return qrMaster[sliced] || 1;
  }

  function renderMasterTable(){
    masterTbody.innerHTML = '';
    const entries = Object.entries(qrMaster).sort((a, b) => a[0].localeCompare(b[0], 'ja'));
    
    if (entries.length === 0) {
      masterTbody.innerHTML = '<tr><td colspan="3" class="center small" style="padding:40px; color:var(--muted);">ãƒã‚¹ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>';
    }
    
    entries.forEach(([product, qty]) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${product}</strong></td>
        <td class="center"><strong style="font-size:16px;">${qty}</strong></td>
        <td class="center"><button class="danger" data-product="${product}">ğŸ—‘ï¸ å‰Šé™¤</button></td>
      `;
      tr.querySelector('button').addEventListener('click', async () => {
        if (!confirm(`å“ç•ªã€Œ${product}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        
        const deleted = await deleteMasterFromFirestore(product);
        if (deleted) {
          delete qrMaster[product];
          renderMasterTable();
          updateDashboard();
          showMasterMsg('å‰Šé™¤ã—ã¾ã—ãŸï¼ˆFirebaseåŒæœŸæ¸ˆã¿ï¼‰', 'success');
        } else {
          showMasterMsg('Firebaseã‹ã‚‰ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
      });
      masterTbody.appendChild(tr);
    });

    document.getElementById('registeredMaster').textContent = entries.length;
  }

  function showMasterMsg(msg, type){
    masterMsg.className = 'msg-box ' + type;
    masterMsg.textContent = msg;
    masterMsg.style.display = 'block';
    setTimeout(() => { masterMsg.style.display = 'none'; }, 4000);
  }

  function showSettingsMsg(msg, type){
    settingsMsg.className = 'msg-box ' + type;
    settingsMsg.textContent = msg;
    settingsMsg.style.display = 'block';
    setTimeout(() => { settingsMsg.style.display = 'none'; }, 4000);
  }

  // æŒ‡å®šã•ã‚ŒãŸæ™‚åˆ»ãŒç¨¼åƒæ™‚é–“å†…ã‹ã©ã†ã‹åˆ¤å®šï¼ˆæ—¥ã‚’ã¾ãŸãå¯¾å¿œï¼‰
  function isWorkingTime(date){
    const day = date.getDay();
    if (!workSettings.workingDays.includes(day)) {
      return false; // éç¨¼åƒæ—¥
    }

    const timeStr = `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    
    // ç¨¼åƒæ™‚é–“ã®ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¥ã‚’ã¾ãŸãå ´åˆã«å¯¾å¿œï¼‰
    const startTime = workSettings.workStart;
    const endTime = workSettings.workEnd;
    
    // æ—¥ã‚’ã¾ãŸãã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆé–‹å§‹æ™‚åˆ» > çµ‚äº†æ™‚åˆ»ã®å ´åˆï¼‰
    const crossesMidnight = startTime > endTime;
    
    if (crossesMidnight) {
      // æ—¥ã‚’ã¾ãŸãå ´åˆï¼šé–‹å§‹æ™‚åˆ»ä»¥é™ OR çµ‚äº†æ™‚åˆ»æœªæº€
      if (timeStr < startTime && timeStr >= endTime) {
        return false;
      }
    } else {
      // é€šå¸¸ã®å ´åˆï¼šé–‹å§‹æ™‚åˆ»ä»¥é™ AND çµ‚äº†æ™‚åˆ»æœªæº€
      if (timeStr < startTime || timeStr >= endTime) {
        return false;
      }
    }

    // ä¼‘æ†©æ™‚é–“ãƒã‚§ãƒƒã‚¯ï¼ˆè¤‡æ•°å¯¾å¿œï¼‰
    for (const breakTime of workSettings.breaks) {
      if (!breakTime.enabled) continue;
      
      const breakStart = breakTime.start;
      const breakEnd = breakTime.end;
      const breakCrossesMidnight = breakStart > breakEnd;
      
      if (breakCrossesMidnight) {
        // ä¼‘æ†©æ™‚é–“ãŒæ—¥ã‚’ã¾ãŸãå ´åˆ
        if (timeStr >= breakStart || timeStr < breakEnd) {
          return false;
        }
      } else {
        // é€šå¸¸ã®ä¼‘æ†©æ™‚é–“
        if (timeStr >= breakStart && timeStr < breakEnd) {
          return false;
        }
      }
    }

    return true;
  }

  // 2ã¤ã®æ™‚åˆ»é–“ã®éç¨¼åƒæ™‚é–“ï¼ˆåˆ†ï¼‰ã‚’è¨ˆç®—
  function calculateNonWorkingMinutes(startTime, endTime){
    let nonWorkingMinutes = 0;
    const current = new Date(startTime);
    
    // 1åˆ†åˆ»ã¿ã§éç¨¼åƒæ™‚é–“ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
    while (current < endTime) {
      if (!isWorkingTime(current)) {
        nonWorkingMinutes++;
      }
      current.setMinutes(current.getMinutes() + 1);
    }
    
    return nonWorkingMinutes;
  }

  document.getElementById('btnAddMaster').addEventListener('click', async () => {
    const product = prompt('å“ç•ªï¼ˆåˆ‡ã‚Šå‡ºã—å€¤ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
    if (!product || product.trim() === '') return;
    
    const qty = prompt('1å›ã®èª­ã¿å–ã‚Šã‚ãŸã‚Šã®ç”Ÿç”£å€‹æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', '1');
    if (qty === null) return;
    
    const qtyNum = parseInt(qty);
    if (isNaN(qtyNum) || qtyNum < 1) {
      alert('å€‹æ•°ã¯1ä»¥ä¸Šã®æ•´æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    const productKey = product.trim();
    qrMaster[productKey] = qtyNum;
    
    const saved = await saveMasterToFirestore(productKey, qtyNum);
    if (saved) {
      renderMasterTable();
      updateDashboard();
      showMasterMsg('ç™»éŒ²ã—ã¾ã—ãŸï¼ˆFirebaseåŒæœŸæ¸ˆã¿ï¼‰', 'success');
    } else {
      delete qrMaster[productKey];
      showMasterMsg('Firebaseã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
  });

  document.getElementById('btnReloadMaster').addEventListener('click', async () => {
    await loadMasterFromFirestore();
    updateDashboard();
  });

  document.getElementById('btnExportMaster').addEventListener('click', () => {
    const rows = [['å“ç•ª', 'ç”Ÿç”£å€‹æ•°']];
    Object.entries(qrMaster).sort((a, b) => a[0].localeCompare(b[0], 'ja')).forEach(([p, q]) => {
      rows.push([p, q]);
    });
    
    const csv = rows.map(r => r.map(f => {
      const s = String(f ?? "");
      return /[\",\n]/.test(s) ? `"${s.replace(/\"/g,'\"\"')}"` : s;
    }).join(",")).join("\n");
    
    const blob = new Blob(["\uFEFF" + csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `qr_master.csv`;
    a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById('btnImportMaster').addEventListener('click', () => {
    document.getElementById('fileImportMaster').click();
  });

  document.getElementById('fileImportMaster').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      const text = await file.text();
      const lines = text.replace(/^\uFEFF/, '').split('\n').map(l => l.trim()).filter(l => l);
      
      let imported = 0;
      let failed = 0;
      
      for (let i = 1; i < lines.length; i++) {
        const parts = lines[i].split(',').map(p => p.replace(/^"|"$/g, '').trim());
        if (parts.length >= 2) {
          const product = parts[0];
          const qty = parseInt(parts[1]);
          if (product && !isNaN(qty) && qty > 0) {
            qrMaster[product] = qty;
            const saved = await saveMasterToFirestore(product, qty);
            if (saved) {
              imported++;
            } else {
              failed++;
            }
          }
        }
      }
      
      renderMasterTable();
      updateDashboard();
      
      if (failed > 0) {
        showMasterMsg(`${imported}ä»¶å–è¾¼ã€${failed}ä»¶å¤±æ•—ï¼ˆFirebaseåŒæœŸã‚¨ãƒ©ãƒ¼ï¼‰`, 'error');
      } else {
        showMasterMsg(`${imported}ä»¶ã®ãƒã‚¹ã‚¿ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸï¼ˆFirebaseåŒæœŸæ¸ˆã¿ï¼‰`, 'success');
      }
    } catch (err) {
      console.error(err);
      showMasterMsg('CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
    
    e.target.value = '';
  });

  function parseClientDate(tsStr){
    if (!tsStr) return null;
    const m = tsStr.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2}):(\d{2})$/);
    if (!m) return null;
    const [_, y, mo, d, h, mi, s] = m.map(Number);
    return new Date(y, mo-1, d, h, mi, s);
  }

  function uniqueSorted(values){
    return Array.from(new Set(values.filter(v => v != null && v !== ""))).sort((a, b) => {
      const sa=String(a), sb=String(b);
      return sa.localeCompare(sb, "ja");
    });
  }

  function populateSelectors(data){
    const lines = uniqueSorted(data.map(r => r.line || ""));
    const sliced = uniqueSorted(data.map(r => r.sliced || ""));

    const fill = (sel, arr) => {
      const cur = sel.value;
      sel.innerHTML = "<option value=''>ã™ã¹ã¦</option>" + arr.map(v => `<option value="${String(v).replace(/"/g, '&quot;')}">${v}</option>`).join("");
      if (cur && arr.includes(cur)){ sel.value = cur; }
    };
    fill(lineSel, lines);
    fill(slicedSel, sliced);
  }

  function getFilteredData(){
    const fLine = lineSel.value.trim();
    const fSliced = slicedSel.value.trim();

    let fromDate = null, toDate = null;
    if (dateFrom.value){ fromDate = new Date(dateFrom.value + "T00:00:00"); }
    if (dateTo.value){ toDate = new Date(dateTo.value + "T23:59:59"); }

    console.log("ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶:", {
      ãƒ©ã‚¤ãƒ³: fLine || "ã™ã¹ã¦",
      å“ç•ª: fSliced || "ã™ã¹ã¦", 
      é–‹å§‹æ—¥: dateFrom.value,
      çµ‚äº†æ—¥: dateTo.value,
      å…¨ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: allData.length
    });

    const filtered = allData.filter(r => {
      const judge = r.judge || r.result || "";
      if (judge !== "OK") return false;

      if (fLine && r.line !== fLine) return false;
      if (fSliced && r.sliced !== fSliced) return false;

      let dt = null;
      if (r.ts){ dt = parseClientDate(r.ts); }
      if (!dt && r.readAt && r.readAt.seconds){ dt = new Date(r.readAt.seconds*1000); }
      if (!dt) return false;

      if (fromDate && dt < fromDate) return false;
      if (toDate && dt > toDate) return false;
      return true;
    });
    
    console.log("âœ… ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œ:", filtered.length + "ä»¶");
    
    return filtered;
  }

  // åœæ­¢æ™‚é–“ã‚’è¨ˆç®—ï¼ˆãƒ©ã‚¤ãƒ³åˆ¥ã€å“ç•ªã‚’è€ƒæ…®ã€éç¨¼åƒæ™‚é–“ã‚’é™¤å¤–ï¼‰
  function calculateStopTime(data){
    const lineData = {};
    
    data.forEach(r => {
      let dt = null;
      if (r.ts){ dt = parseClientDate(r.ts); }
      if (!dt && r.readAt && r.readAt.seconds){ dt = new Date(r.readAt.seconds*1000); }
      if (!dt) return;
      
      const line = r.line || "ä¸æ˜";
      const product = r.sliced || "";
      
      if (!lineData[line]) lineData[line] = [];
      lineData[line].push({ time: dt, product });
    });
    
    const stopTimeByLine = {};
    const stopDetails = []; // åœæ­¢è©³ç´°æƒ…å ±
    let totalStopMinutes = 0;
    
    Object.keys(lineData).forEach(line => {
      const records = lineData[line].sort((a, b) => a.time - b.time);
      let stopMinutes = 0;
      
      for (let i = 1; i < records.length; i++) {
        const prev = records[i - 1];
        const curr = records[i];
        const totalDiffMinutes = (curr.time - prev.time) / (1000 * 60);
        
        // åŒã˜å“ç•ªã§15åˆ†ä»¥ä¸Šã®é–“éš”ãŒã‚ã‚‹å ´åˆã®ã¿å‡¦ç†
        if (prev.product === curr.product && totalDiffMinutes >= STOP_THRESHOLD_MINUTES) {
          // éç¨¼åƒæ™‚é–“ã‚’é™¤å¤–
          const nonWorkingMinutes = calculateNonWorkingMinutes(prev.time, curr.time);
          const actualStopMinutes = totalDiffMinutes - nonWorkingMinutes;
          
          // å®Ÿéš›ã®åœæ­¢æ™‚é–“ãŒé–¾å€¤ä»¥ä¸Šã®å ´åˆã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ
          if (actualStopMinutes >= STOP_THRESHOLD_MINUTES) {
            stopMinutes += actualStopMinutes;
            stopDetails.push({
              line: line,
              product: prev.product,
              startTime: prev.time,
              endTime: curr.time,
              stopMinutes: actualStopMinutes,
              nonWorkingMinutes: nonWorkingMinutes
            });
          }
        }
      }
      
      stopTimeByLine[line] = stopMinutes;
      totalStopMinutes += stopMinutes;
    });
    
    return { stopTimeByLine, totalStopMinutes, stopDetails };
  }

  function updateDashboard(){
    const filtered = getFilteredData();

    // åœæ­¢æ™‚é–“è¨ˆç®—
    const { stopTimeByLine, totalStopMinutes, stopDetails } = calculateStopTime(filtered);

    updateLineSummaryCards(filtered, stopTimeByLine);
    updateStopDetailTable(stopDetails);
    updateStopTimeChart(stopTimeByLine);
    updateTimeSeriesChart(filtered);
  }
function updateLineSummaryCards(data, stopTimeByLine){
  const container = document.getElementById('lineSummaryCards');
  container.innerHTML = '';

  // ãƒ©ã‚¤ãƒ³åˆ¥é›†è¨ˆï¼ˆæ—¢å­˜ã¨åŒç­‰ï¼‰
  const lineProducts = {};
  data.forEach(r=>{
    const line = r.line || 'ä¸æ˜';
    const product = r.sliced || 'ä¸æ˜';
    if(!lineProducts[line]) lineProducts[line] = {};
    if(!lineProducts[line][product]) lineProducts[line][product] = 0;
    lineProducts[line][product] += getQuantity(r.sliced);
  });

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆæ–°ï¼‰
  const sessionsByLine = buildLineSessions(data);

  // è¡¨ç¤º
  const sortedLines = Object.keys(lineProducts).sort();
  const fmt = (d)=> d ? d.toLocaleString('ja-JP',{hour:'2-digit',minute:'2-digit'}) : '-';

  sortedLines.forEach(line=>{
    const products = lineProducts[line];
    const totalQty = Object.values(products).reduce((s,q)=>s+q,0);
    const stopTime = stopTimeByLine[line] || 0;

    const card = document.createElement('div');
    card.className = 'line-card';

    const { active, sessions, currentProduct } = sessionsByLine[line] || {active:null, sessions:[], currentProduct:null};

    // å…ˆé ­ï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ”ãƒ«
    let statusHtml = '';
    if(currentProduct){
      statusHtml = `<div class="status-pill status-on">ğŸŸ¢ ç”Ÿç”£ä¸­ï¼š<strong>${currentProduct}</strong><span class="time-range">ï¼ˆ${fmt(active?.start)}ã€œç¾åœ¨ï¼‰</span></div>`;
    }else{
      statusHtml = `<div class="status-pill status-off">â¹ ç”Ÿç”£çµ‚äº†</div>`;
    }

    // å“ç•ªãƒªã‚¹ãƒˆï¼ˆæ•°é‡ï¼‰ï¼‹ çµ‚äº†ã—ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ™‚é–“å¸¯è¡¨ç¤º
    const productRows = Object
      .entries(products)
      .sort((a,b)=>b[1]-a[1])
      .map(([prod, qty])=>{
        // ãã®å“ç•ªã®ç›´è¿‘ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆçµ‚äº†ã—ã¦ã„ã‚‹ã‚‚ã®ï¼‰ã‚’æ¢ã™
        const ses = (sessions||[]).filter(s=>s.product===prod);
        // â€œç¾åœ¨ç”Ÿç”£ä¸­â€ã®å ´åˆã¯æœ€å¾Œã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯é€²è¡Œä¸­ã¨è¦‹åšã™ã®ã§ã€çµ‚äº†è¡¨ç¤ºã¯ç›´è¿‘ã§å®Œäº†æ¸ˆã¿ã®ã‚‚ã®ã«é™å®š
        const lastFinished = (currentProduct===prod && ses.length>1) ? ses[ses.length-2] : ses[ses.length-1];
        // ç”Ÿç”£ä¸­ã®å“ç•ªã¯è¡Œã« â€œï¼ˆé–‹å§‹ã€œä»Šï¼‰â€ ã‚’å‡ºã™ã€‚çµ‚äº†å“ã¯ â€œé–‹å§‹ã€œçµ‚äº†â€
        const timeChip = (currentProduct===prod)
          ? `<span class="time-range">ï¼ˆ${fmt(active?.start)}ã€œç¾åœ¨ï¼‰</span>`
          : (lastFinished ? `<span class="time-range">ï¼ˆ${fmt(lastFinished.start)}ã€œ${fmt(lastFinished.end)}ï¼‰</span>` : '');
        return `
          <div class="product-item">
            <span class="product-name">${prod} ${timeChip}</span>
            <span class="product-qty">${qty.toLocaleString()}</span>
          </div>`;
      }).join('');

    card.innerHTML = `
      <div class="line-card-header">${line}</div>
      ${statusHtml}
      ${productRows}
      <div class="line-card-footer">
        <span>åˆè¨ˆ: <strong>${totalQty.toLocaleString()}</strong>å€‹</span>
        <span class="highlight-stop">åœæ­¢: ${(stopTime/60).toFixed(1)}æ™‚é–“</span>
      </div>
    `;
    container.appendChild(card);
  });
}
  function updateStopDetailTable(stopDetails){
    const tbody = document.getElementById('stopDetailTbody');
    tbody.innerHTML = '';
    
    if (stopDetails.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="center small" style="padding:40px; color:var(--muted);">åœæ­¢æ™‚é–“ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }
    
    // åœæ­¢æ™‚é–“ãŒé•·ã„é †ã«ã‚½ãƒ¼ãƒˆ
    const sorted = stopDetails.sort((a, b) => b.stopMinutes - a.stopMinutes);
    
    sorted.forEach(stop => {
      const tr = document.createElement('tr');
      const startTime = stop.startTime.toLocaleString('ja-JP', { 
        year: 'numeric', month: '2-digit', day: '2-digit', 
        hour: '2-digit', minute: '2-digit' 
      });
      const endTime = stop.endTime.toLocaleString('ja-JP', { 
        year: 'numeric', month: '2-digit', day: '2-digit', 
        hour: '2-digit', minute: '2-digit' 
      });
      
      const stopMinutesDisplay = stop.nonWorkingMinutes 
        ? `${stop.stopMinutes.toFixed(0)} <span style="font-size:11px; color:var(--muted);">(éç¨¼åƒ${stop.nonWorkingMinutes.toFixed(0)}åˆ†é™¤å¤–)</span>`
        : stop.stopMinutes.toFixed(0);
      
      tr.innerHTML = `
        <td><strong>${stop.line}</strong></td>
        <td>${stop.product}</td>
        <td class="nowrap">${startTime}</td>
        <td class="nowrap">${endTime}</td>
        <td class="right highlight-stop">${stopMinutesDisplay}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function updateTimeSeriesChart(data){
    const groupHours = parseInt(hourGroup.value);
    const lineData = {};

    data.forEach(r => {
      let dt = null;
      if (r.ts){ dt = parseClientDate(r.ts); }
      if (!dt && r.readAt && r.readAt.seconds){ dt = new Date(r.readAt.seconds*1000); }
      if (!dt) return;

      const line = r.line || "ä¸æ˜";
      const hour = Math.floor(dt.getHours() / groupHours) * groupHours;
      const timeKey = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')} ${String(hour).padStart(2,'0')}:00`;

      if (!lineData[line]) lineData[line] = {};
      lineData[line][timeKey] = (lineData[line][timeKey] || 0) + getQuantity(r.sliced);
    });

    const allTimes = new Set();
    Object.values(lineData).forEach(times => {
      Object.keys(times).forEach(t => allTimes.add(t));
    });
    const sortedTimes = Array.from(allTimes).sort();

    const colors = ['#0369a1', '#dc2626', '#059669', '#d97706', '#7c3aed', '#db2777', '#0891b2', '#65a30d'];
    const datasets = Object.keys(lineData).sort().map((line, idx) => ({
      label: line,
      data: sortedTimes.map(t => lineData[line][t] || 0),
      borderColor: colors[idx % colors.length],
      backgroundColor: colors[idx % colors.length] + '20',
      tension: 0.3,
      fill: true,
      borderWidth: 2
    }));

    if (charts.timeSeries) charts.timeSeries.destroy();
    const ctx = document.getElementById('timeSeriesChart').getContext('2d');
    charts.timeSeries = new Chart(ctx, {
      type: 'line',
      data: { labels: sortedTimes, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } },
        scales: {
          y: { beginAtZero: true, ticks: { precision: 0 }, title: { display: true, text: 'ç”Ÿç”£å€‹æ•°' } }
        }
      }
    });
  }

  function updateStopTimeChart(stopTimeByLine){
    const sorted = Object.entries(stopTimeByLine).sort((a, b) => b[1] - a[1]);
    const labels = sorted.map(e => e[0]);
    const values = sorted.map(e => e[1]); // åˆ†å˜ä½ã§ä¿æŒ

    // åœæ­¢æ™‚é–“ã«å¿œã˜ãŸè‰²åˆ†ã‘
    const colors = values.map(minutes => {
      if (minutes >= 60) return '#dc2626'; // 1æ™‚é–“ä»¥ä¸Šï¼šèµ¤
      if (minutes <= 10) return '#0369a1'; // 10åˆ†ä»¥ä¸‹ï¼šé’
      return '#d97706'; // ãã®é–“ï¼šé»„è‰²
    });

    const valuesInHours = values.map(m => (m / 60).toFixed(1)); // è¡¨ç¤ºç”¨ã«æ™‚é–“ã«å¤‰æ›

    if (charts.stopTime) charts.stopTime.destroy();
    const ctx = document.getElementById('stopTimeChart').getContext('2d');
    charts.stopTime = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'åœæ­¢æ™‚é–“ï¼ˆæ™‚é–“ï¼‰',
          data: valuesInHours,
          backgroundColor: colors
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                const minutes = values[context.dataIndex];
                const hours = (minutes / 60).toFixed(1);
                return `åœæ­¢æ™‚é–“: ${hours}æ™‚é–“ (${minutes.toFixed(0)}åˆ†)`;
              }
            }
          }
        },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'æ™‚é–“' } }
        }
      }
    });
  }

  function updateHourlyTable(data){
    const groupHours = parseInt(hourGroup.value);
    const hourCounts = {};
    const hourStopTime = {};

    // ãƒ©ã‚¤ãƒ³åˆ¥ã«æ™‚é–“å¸¯ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
    const lineHourData = {};
    data.forEach(r => {
      let dt = null;
      if (r.ts){ dt = parseClientDate(r.ts); }
      if (!dt && r.readAt && r.readAt.seconds){ dt = new Date(r.readAt.seconds*1000); }
      if (!dt) return;

      const line = r.line || "ä¸æ˜";
      const product = r.sliced || "";
      const hour = Math.floor(dt.getHours() / groupHours) * groupHours;
      const timeKey = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')} ${String(hour).padStart(2,'0')}:00`;

      if (!hourCounts[timeKey]) hourCounts[timeKey] = { qty: 0, count: 0 };
      hourCounts[timeKey].qty += getQuantity(r.sliced);
      hourCounts[timeKey].count += 1;

      if (!lineHourData[line]) lineHourData[line] = {};
      if (!lineHourData[line][timeKey]) lineHourData[line][timeKey] = [];
      lineHourData[line][timeKey].push({ time: dt, product });
    });

    // å„æ™‚é–“å¸¯ã®åœæ­¢æ™‚é–“ã‚’è¨ˆç®—ï¼ˆéç¨¼åƒæ™‚é–“ã‚’é™¤å¤–ï¼‰
    Object.keys(lineHourData).forEach(line => {
      Object.keys(lineHourData[line]).forEach(timeKey => {
        const records = lineHourData[line][timeKey].sort((a, b) => a.time - b.time);
        let stopMinutes = 0;

        for (let i = 1; i < records.length; i++) {
          const prev = records[i - 1];
          const curr = records[i];
          const totalDiffMinutes = (curr.time - prev.time) / (1000 * 60);

          if (prev.product === curr.product && totalDiffMinutes >= STOP_THRESHOLD_MINUTES) {
            const nonWorkingMinutes = calculateNonWorkingMinutes(prev.time, curr.time);
            const actualStopMinutes = totalDiffMinutes - nonWorkingMinutes;
            if (actualStopMinutes >= STOP_THRESHOLD_MINUTES) {
              stopMinutes += actualStopMinutes;
            }
          }
        }

        if (!hourStopTime[timeKey]) hourStopTime[timeKey] = 0;
        hourStopTime[timeKey] += stopMinutes;
      });
    });

    const sorted = Object.entries(hourCounts).sort((a, b) => a[0].localeCompare(b[0]));
    const tbody = document.getElementById('hourlyTbody');
    tbody.innerHTML = '';
    
    sorted.forEach(([time, data]) => {
      const tr = document.createElement('tr');
      const stopMin = hourStopTime[time] || 0;
      tr.innerHTML = `
        <td>${time}</td>
        <td class="right"><strong>${data.qty}</strong></td>
        <td class="right">${data.count}</td>
        <td class="right">${stopMin.toFixed(0)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderDetailTable(rows){
    tbody.innerHTML = '';
    for (const d of rows){
      const qty = getQuantity(d.sliced);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="nowrap">${d.ts||""}</td>
        <td>${d.line||""}</td>
        <td>${d.sliced||""}</td>
        <td class="center"><strong>${qty}</strong></td>
        <td style="font-size:12px;">${d.raw||d.qrData||""}</td>
        <td class="center">${d.judge||d.result||""}</td>
      `;
      tbody.appendChild(tr);
    }
    const totalQty = rows.reduce((sum, r) => sum + getQuantity(r.sliced), 0);
    countEl.textContent = `è¡¨ç¤ºä»¶æ•°ï¼š${rows.length} / ç”Ÿç”£å€‹æ•°ï¼š${totalQty}`;
  }

  // Firestoreã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚’é–‹å§‹
  function startRealtimeListener(){
    // æ—¢å­˜ã®ç›£è¦–ã‚’è§£é™¤
    if (realtimeUnsubscribe) {
      realtimeUnsubscribe();
    }
    
    try {
      const col = collection(db, "qrLogs");
      const qRef = query(col, orderBy("readAt", "desc"), limit(2000));
      
      console.log("ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’é–‹å§‹ã—ã¾ã—ãŸ");
      
      realtimeUnsubscribe = onSnapshot(qRef, (snapshot) => {
        console.log(`ğŸ“¥ ãƒ‡ãƒ¼ã‚¿æ›´æ–°: ${snapshot.size}ä»¶`);
        
        currentDocs = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          currentDocs.push({ id: doc.id, ...data });
          
          // æœ€åˆã®1ä»¶ã ã‘ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’è¡¨ç¤º
          if (currentDocs.length === 1) {
            console.log("ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ«:", {
              id: doc.id,
              ts: data.ts,
              readAt: data.readAt,
              line: data.line,
              sliced: data.sliced,
              judge: data.judge
            });
          }
        });
        
        allData = [...currentDocs];
        populateSelectors(allData);
        applyFilters();
        
        // æœ€çµ‚æ›´æ–°æ™‚åˆ»ã‚’è¡¨ç¤º
        const statusBadge = document.getElementById('fbStatus');
        const now = new Date();
        statusBadge.textContent = `Firebase: æ¥ç¶šæ¸ˆã¿ (${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}æ›´æ–°)`;
      }, (error) => {
        console.error("âŒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
        const statusBadge = document.getElementById('fbStatus');
        statusBadge.textContent = "Firebase: ã‚¨ãƒ©ãƒ¼";
        statusBadge.className = "badge disconnected";
      });
    } catch (error) {
      console.error("âŒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã®é–‹å§‹ã‚¨ãƒ©ãƒ¼:", error);
    }
  }

  function startAutoUpdate(){
    if (autoUpdateInterval) clearInterval(autoUpdateInterval);
    
    // 5åˆ†é–“éš”ã§éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒã‚§ãƒƒã‚¯
    autoUpdateInterval = setInterval(() => {
      checkInactivityAndUpdate();
    }, AUTO_UPDATE_INTERVAL);
    
    console.log("è‡ªå‹•æ›´æ–°ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ã—ã¾ã—ãŸ");
  }

  async function fetchPage(pageNum){
    errEl.style.display="none";
    countEl.textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";
    pageInfo.textContent = `ãƒšãƒ¼ã‚¸ ${pageNum} / ${MAX_PAGES}`;

    try{
      const col = collection(db, "qrLogs");
      let qRef = query(col, orderBy("readAt","desc"), limit(PER_PAGE));

      const cursor = pageCursors[pageNum-1] || null;
      if (cursor) qRef = query(qRef, startAfter(cursor));

      const snap = await getDocs(qRef);
      currentDocs = [];
      snap.forEach(doc => currentDocs.push({ id: doc.id, ...doc.data() }));

      const lastDoc = snap.docs[snap.docs.length-1] || null;
      pageCursors[pageNum] = lastDoc;

      btnPrev.disabled = (pageNum === 1);
      btnNext.disabled = !(lastDoc && pageNum < MAX_PAGES);

      allData = [...allData, ...currentDocs];
      populateSelectors(allData);
      applyFilters();
      
      console.log(`ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ: ${currentDocs.length}ä»¶`);
    }catch(e){
      console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", e);
      errEl.style.display="block";
      errEl.textContent = "èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆreadAt descï¼‰ãŒå¿…è¦ãªå ´åˆã¯ä½œæˆã—ã¦ãã ã•ã„ã€‚è©³ç´°: " + e.message;
    }
  }

  function applyFilters(){
    errEl.style.display="none";
    updateDashboard();
    
    const fLine = lineSel.value.trim();
    const fSliced = slicedSel.value.trim();
    let fromDate = null, toDate = null;
    if (dateFrom.value){ fromDate = new Date(dateFrom.value + "T00:00:00"); }
    if (dateTo.value){ toDate = new Date(dateTo.value + "T23:59:59"); }

    const filtered = currentDocs.filter(r => {
      if (fLine && r.line !== fLine) return false;
      if (fSliced && r.sliced !== fSliced) return false;

      let dt = null;
      if (r.ts){ dt = parseClientDate(r.ts); }
      if (!dt && r.readAt && r.readAt.seconds){ dt = new Date(r.readAt.seconds*1000); }
      if (fromDate && dt && dt < fromDate) return false;
      if (toDate && dt && dt > toDate) return false;
      return true;
    });
    
    renderDetailTable(filtered);
  }

  btnApply.addEventListener("click", applyFilters);
  btnReload.addEventListener("click", async () => {
    currentPage = 1;
    pageCursors = [null];
    allData = [];
    await fetchPage(currentPage);
  });
  btnPrev.addEventListener("click", async () => {
    if (currentPage <= 1) return;
    currentPage -= 1;
    await fetchPage(currentPage);
  });
  btnNext.addEventListener("click", async () => {
    if (currentPage >= MAX_PAGES) return;
    currentPage += 1;
    await fetchPage(currentPage);
  });

  btnExport.addEventListener("click", () => {
    const filtered = getFilteredData();
    const rows = [["æ™‚åˆ»","ãƒ©ã‚¤ãƒ³","å“ç•ª","ç”Ÿç”£å€‹æ•°","QRã‚³ãƒ¼ãƒ‰"]];
    filtered.forEach(r => {
      let dt = "";
      if (r.ts) dt = r.ts;
      else if (r.readAt && r.readAt.seconds) dt = new Date(r.readAt.seconds*1000).toISOString();
      rows.push([dt, r.line||"", r.sliced||"", getQuantity(r.sliced), r.raw||r.qrData||""]);
    });
    const csv = rows.map(r => r.map(f => {
      const s = String(f ?? ""); 
      return /[\",\n]/.test(s) ? `"${s.replace(/\"/g,'\"\"')}"` : s;
    }).join(",")).join("\n");
    const blob = new Blob(["\uFEFF" + csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `production_report.csv`; a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById('btnSaveSettings').addEventListener('click', async () => {
    readWorkSettingsFromUI();
    const saved = await saveWorkSettings();
    if (saved) {
      showSettingsMsg('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆFirebaseåŒæœŸæ¸ˆã¿ï¼‰', 'success');
      updateDashboard(); // è¨­å®šå¤‰æ›´ã‚’åæ˜ 
    } else {
      showSettingsMsg('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
  });

  document.getElementById('btnAddBreak').addEventListener('click', () => {
    workSettings.breaks.push({ start: "15:00", end: "15:15", enabled: true });
    renderBreaksUI();
  });

  renderMasterTable();
  await loadMasterFromFirestore();
  await loadWorkSettings();
  
  // ä»Šæ—¥ã®æ—¥ä»˜ã‚’åˆæœŸè¨­å®š
  const today = new Date();
  const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
  dateFrom.value = todayStr;
  dateTo.value = todayStr;
  
  await fetchPage(currentPage);
  
  // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’é–‹å§‹
  startRealtimeListener();
  
  // è‡ªå‹•æ›´æ–°ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
  startAutoUpdate();
  
  console.log("ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–å®Œäº†");
</script>

</body>
</html>
