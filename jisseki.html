<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ç”Ÿç”£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<style>
  :root{
    --bg:#0f172a;
    --card:#1e293b;
    --border:#334155;
    --text:#f8fafc;
    --muted:#94a3b8;
  }
  *{ box-sizing:border-box; margin:0; padding:0; }
  
  body{
    background:var(--bg);
    color:var(--text);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    padding:20px;
  }

  header{
    margin-bottom:24px;
    text-align:center;
  }
  h1{
    font-size:32px;
    font-weight:900;
    margin-bottom:8px;
    background:linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
  }
  .updateTime{
    color:var(--muted);
    font-size:14px;
  }

  .filters{
    display:flex;
    gap:12px;
    margin-bottom:20px;
    flex-wrap:wrap;
    align-items:center;
  }
  .filterLabel{
    font-size:14px;
    font-weight:700;
    color:var(--muted);
  }
  select, input{
    padding:8px 12px;
    border-radius:8px;
    border:1px solid var(--border);
    background:var(--card);
    color:var(--text);
    font-size:14px;
  }
  button{
    padding:10px 16px;
    border-radius:8px;
    border:1px solid var(--border);
    background:var(--card);
    color:var(--text);
    cursor:pointer;
    font-size:14px;
    font-weight:600;
    transition:all 0.2s;
  }
  button:hover{
    background:#334155;
  }
  button.primary{
    background:#667eea;
    border-color:#667eea;
    color:#fff;
  }
  button.primary:hover{
    background:#5568d3;
  }

  .dashboard{
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));
    gap:16px;
  }
  
  @media (max-width:768px){
    .dashboard{
      grid-template-columns:1fr;
    }
  }

  .lineCard{
    background:var(--card);
    border-radius:16px;
    padding:16px;
    border:2px solid var(--border);
    transition:all 0.3s ease;
    position:relative;
    overflow:hidden;
  }
  .lineCard:hover{
    transform:translateY(-2px);
    box-shadow:0 8px 24px rgba(0,0,0,0.3);
  }

  .lineCard::before{
    content:'';
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:4px;
    transition:background 0.3s ease;
  }
  .lineCard.status-RUNNING::before{ background:#22c55e; }
  .lineCard.status-TRY::before{ background:#3b82f6; }
  .lineCard.status-ABNORMAL_STOP::before{ background:#ef4444; }
  .lineCard.status-PLAN_STOP::before{ background:#f59e0b; }
  .lineCard.status-MATERIAL_CHANGE::before{ background:#a855f7; }
  .lineCard.status-SETUP_CHANGE::before{ background:#eab308; }
  .lineCard.status-NOT_STARTED::before{ background:#64748b; }

  .lineHeader{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:12px;
  }
  .lineName{
    font-size:20px;
    font-weight:900;
  }
  .bushoTag{
    font-size:11px;
    padding:4px 8px;
    border-radius:6px;
    background:#334155;
    color:#94a3b8;
    font-weight:700;
  }

  .statusBadge{
    display:inline-block;
    padding:6px 12px;
    border-radius:8px;
    font-size:13px;
    font-weight:900;
    margin-bottom:12px;
  }
  .statusBadge.status-RUNNING{
    background:#bbf7d0;
    color:#166534;
  }
  .statusBadge.status-TRY{
    background:#bfdbfe;
    color:#1e40af;
  }
  .statusBadge.status-ABNORMAL_STOP{
    background:#fecaca;
    color:#991b1b;
  }
  .statusBadge.status-PLAN_STOP{
    background:#fed7aa;
    color:#9a3412;
  }
  .statusBadge.status-MATERIAL_CHANGE{
    background:#e9d5ff;
    color:#6b21a8;
  }
  .statusBadge.status-SETUP_CHANGE{
    background:#fde68a;
    color:#854d0e;
  }
  .statusBadge.status-NOT_STARTED{
    background:#f1f5f9;
    color:#475569;
  }

  .cardStats{
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    gap:8px;
    margin-bottom:12px;
  }
  .cardStat{
    background:#0f172a;
    border-radius:10px;
    padding:10px 8px;
    text-align:center;
    border:1px solid var(--border);
  }
  .cardStatLabel{
    font-size:10px;
    color:var(--muted);
    margin-bottom:4px;
    font-weight:700;
  }
  .cardStatValue{
    font-size:20px;
    font-weight:900;
    line-height:1;
  }
  .cardStatValue.good{ color:#22c55e; }
  .cardStatValue.plan{ color:#667eea; }
  .cardStatValue.rate{ color:#f59e0b; }
  .cardStatUnit{
    font-size:10px;
    color:var(--muted);
    margin-top:2px;
  }

  .productInfo{
    background:#0f172a;
    border-radius:12px;
    padding:12px;
    margin-bottom:12px;
  }
  .productLabel{
    font-size:11px;
    color:var(--muted);
    margin-bottom:4px;
    font-weight:700;
  }
  .productName{
    font-size:24px;
    font-weight:900;
    color:#667eea;
    letter-spacing:0.05em;
  }
  .productName.empty{
    color:var(--muted);
    font-size:14px;
  }

  .progressInfo{
    margin-bottom:12px;
  }
  .progressBarContainer{
    width:100%;
    height:24px;
    background:#0f172a;
    border-radius:12px;
    overflow:hidden;
    position:relative;
  }
  .progressBar{
    height:100%;
    background:linear-gradient(90deg, #22c55e, #16a34a);
    transition:width 0.5s ease;
    position:relative;
  }
  .progressBar.complete{
    background:linear-gradient(90deg, #3b82f6, #2563eb);
  }
  .progressBar.over{
    background:linear-gradient(90deg, #f59e0b, #d97706);
  }
  .progressPercent{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    font-size:12px;
    font-weight:900;
    color:#fff;
    text-shadow:0 1px 2px rgba(0,0,0,0.5);
  }

  /* å‡ºæ¥é«˜æ¨ç§»ã‚°ãƒ©ãƒ• */
  .outputChartSection{
    margin-top:16px;
    padding-top:16px;
    border-top:1px solid var(--border);
  }

  .metaInfo{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    font-size:12px;
    color:var(--muted);
  }
  .metaItem{
    display:flex;
    align-items:center;
    gap:4px;
  }

  .noData{
    text-align:center;
    padding:60px 20px;
    color:var(--muted);
  }
  .noData h2{
    font-size:24px;
    margin-bottom:8px;
  }

  .loading{
    text-align:center;
    padding:40px;
    color:var(--muted);
    font-size:18px;
  }

  .summary{
    background:var(--card);
    border-radius:16px;
    padding:20px;
    margin-bottom:20px;
    border:1px solid var(--border);
  }
  .summaryTitle{
    font-size:18px;
    font-weight:900;
    margin-bottom:16px;
  }
  .summaryGrid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));
    gap:12px;
  }
  .summaryItem{
    text-align:center;
    padding:12px;
    border-radius:12px;
    background:#0f172a;
  }
  .summaryCount{
    font-size:32px;
    font-weight:900;
    margin-bottom:4px;
  }
  .summaryCount.running{ color:#22c55e; }
  .summaryCount.try{ color:#3b82f6; }
  .summaryCount.abnormal{ color:#ef4444; }
  .summaryCount.plan{ color:#f59e0b; }
  .summaryCount.material{ color:#a855f7; }
  .summaryCount.setup{ color:#eab308; }
  .summaryCount.notStarted{ color:#64748b; }
  .summaryLabel{
    font-size:11px;
    color:var(--muted);
    font-weight:700;
  }

  .lockIndicator{
    position:absolute;
    top:12px;
    right:12px;
    font-size:20px;
    animation:pulse 2s infinite;
  }
  @keyframes pulse{
    0%, 100%{ opacity:1; }
    50%{ opacity:0.5; }
  }

  /* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal{
    display:none;
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.8);
    backdrop-filter:blur(4px);
    z-index:1000;
    align-items:center;
    justify-content:center;
    padding:20px;
  }
  .modal.show{
    display:flex;
  }
  .modalContent{
    background:var(--card);
    border-radius:16px;
    padding:24px;
    max-width:600px;
    width:100%;
    max-height:90vh;
    overflow-y:auto;
    border:2px solid var(--border);
  }
  .modalHeader{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:20px;
  }
  .modalTitle{
    font-size:24px;
    font-weight:900;
  }
  .modalClose{
    background:transparent;
    border:none;
    font-size:28px;
    cursor:pointer;
    padding:0;
    width:32px;
    height:32px;
  }
  .settingSection{
    margin-bottom:24px;
  }
  .settingLabel{
    font-size:14px;
    font-weight:700;
    color:var(--text);
    margin-bottom:8px;
    display:block;
  }
  .settingDesc{
    font-size:12px;
    color:var(--muted);
    margin-bottom:12px;
  }
  .inputGroup{
    display:flex;
    gap:8px;
    align-items:center;
    margin-bottom:8px;
  }
  .inputGroup input{
    flex:1;
  }
  .inputGroup button{
    padding:8px 12px;
  }
</style>
</head>

<body>
<header>
  <h1>ğŸ­ ç”Ÿç”£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
  <div class="updateTime">æœ€çµ‚æ›´æ–°: <span id="updateTime">--:--:--</span></div>
  <div style="margin-top:12px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
    <button id="btnSettings">âš™ï¸ è¨­å®š</button>
    <button id="btnReload" class="primary">ğŸ”„ ãƒ‡ãƒ¼ã‚¿å†å–å¾—</button>
  </div>
</header>

<div class="filters">
  <span class="filterLabel">éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</span>
  <select id="bushoFilter">
    <option value="">ã™ã¹ã¦</option>
    <option>1G</option>
    <option>3G</option>
    <option>4G</option>
    <option>5G</option>
    <option>6G</option>
    <option>å“è³ª</option>
  </select>
  
  <span class="filterLabel">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</span>
  <select id="statusFilter">
    <option value="">ã™ã¹ã¦</option>
    <option value="RUNNING">ç”Ÿç”£ä¸­</option>
    <option value="TRY">ãƒˆãƒ©ã‚¤ä¸­</option>
    <option value="ABNORMAL_STOP">ç•°å¸¸åœæ­¢ä¸­</option>
    <option value="PLAN_STOP">è¨ˆç”»åœæ­¢ä¸­</option>
    <option value="MATERIAL_CHANGE">ææ–™æ›¿ãˆä¸­</option>
    <option value="SETUP_CHANGE">æ®µæ›¿ãˆä¸­</option>
    <option value="NOT_STARTED">æœªé–‹å§‹</option>
  </select>
</div>

<div class="summary" id="summary">
  <div class="summaryTitle">ğŸ“Š ç¨¼åƒçŠ¶æ³ã‚µãƒãƒªãƒ¼</div>
  <div class="summaryGrid">
    <div class="summaryItem">
      <div class="summaryCount running" id="runningCount">0</div>
      <div class="summaryLabel">ç”Ÿç”£ä¸­</div>
    </div>
    <div class="summaryItem">
      <div class="summaryCount try" id="tryCount">0</div>
      <div class="summaryLabel">ãƒˆãƒ©ã‚¤ä¸­</div>
    </div>
    <div class="summaryItem">
      <div class="summaryCount abnormal" id="abnormalCount">0</div>
      <div class="summaryLabel">ç•°å¸¸åœæ­¢</div>
    </div>
    <div class="summaryItem">
      <div class="summaryCount plan" id="planCount">0</div>
      <div class="summaryLabel">è¨ˆç”»åœæ­¢</div>
    </div>
    <div class="summaryItem">
      <div class="summaryCount material" id="materialCount">0</div>
      <div class="summaryLabel">ææ–™æ›¿ãˆ</div>
    </div>
    <div class="summaryItem">
      <div class="summaryCount setup" id="setupCount">0</div>
      <div class="summaryLabel">æ®µæ›¿ãˆ</div>
    </div>
    <div class="summaryItem">
      <div class="summaryCount notStarted" id="notStartedCount">0</div>
      <div class="summaryLabel">æœªé–‹å§‹</div>
    </div>
  </div>
</div>

<div id="loading" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
<div id="dashboard" class="dashboard"></div>
<div id="noData" class="noData" style="display:none;">
  <h2>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h2>
  <p>ãƒ©ã‚¤ãƒ³ã®ç”Ÿç”£çŠ¶æ…‹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
</div>

<!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="settingsModal">
  <div class="modalContent">
    <div class="modalHeader">
      <div class="modalTitle">âš™ï¸ è¨­å®š</div>
      <button class="modalClose" id="closeSettings">Ã—</button>
    </div>
    
    <div class="settingSection">
      <label class="settingLabel">åœæ­¢åˆ¤å®šã—ãã„å€¤ï¼ˆåˆ†ï¼‰</label>
      <div class="settingDesc">å‰å›ã®èª­ã¿å–ã‚Šã‹ã‚‰ä½•åˆ†ä»¥ä¸Šç©ºã„ãŸã‚‰åœæ­¢ã¨ã¿ãªã™ã‹</div>
      <input type="number" id="stopThreshold" min="1" max="120" value="15" />
    </div>
    
    <div class="settingSection">
      <label class="settingLabel">ç¨¼åƒæ™‚é–“</label>
      <div class="settingDesc">ç”Ÿç”£ãƒ©ã‚¤ãƒ³ã®ç¨¼åƒé–‹å§‹ãƒ»çµ‚äº†æ™‚åˆ»</div>
      <div class="inputGroup">
        <input type="time" id="workStart" value="08:00" />
        <span style="color:var(--muted);">ã€œ</span>
        <input type="time" id="workEnd" value="17:00" />
      </div>
    </div>
    
    <div class="settingSection">
      <label class="settingLabel">ä¼‘æ†©æ™‚é–“</label>
      <div class="settingDesc">è¤‡æ•°ã®ä¼‘æ†©æ™‚é–“ã‚’è¨­å®šã§ãã¾ã™</div>
      <div id="breaksList"></div>
      <button id="addBreak" style="margin-top:8px;">â• ä¼‘æ†©æ™‚é–“ã‚’è¿½åŠ </button>
    </div>
    
    <div class="settingSection">
      <label class="settingLabel">ç¨¼åƒæ›œæ—¥</label>
      <div class="settingDesc">ç”Ÿç”£ã‚’è¡Œã†æ›œæ—¥ã‚’é¸æŠ</div>
      <div style="display:flex; flex-wrap:wrap; gap:8px;">
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
          <input type="checkbox" class="dayCheck" value="0" /><span>æ—¥</span>
        </label>
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
          <input type="checkbox" class="dayCheck" value="1" checked /><span>æœˆ</span>
        </label>
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
          <input type="checkbox" class="dayCheck" value="2" checked /><span>ç«</span>
        </label>
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
          <input type="checkbox" class="dayCheck" value="3" checked /><span>æ°´</span>
        </label>
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
          <input type="checkbox" class="dayCheck" value="4" checked /><span>æœ¨</span>
        </label>
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
          <input type="checkbox" class="dayCheck" value="5" checked /><span>é‡‘</span>
        </label>
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
          <input type="checkbox" class="dayCheck" value="6" /><span>åœŸ</span>
        </label>
      </div>
    </div>
    
    <button id="saveSettings" class="primary" style="width:100%;">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, collection, onSnapshot, query, where, orderBy, getDocs, doc, getDoc, setDoc, limit
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAOMRoojKv9Hnh3OjVGwYV_k1LBTGOKepY",
    authDomain: "miyamaunitec-fb87a.firebaseapp.com",
    databaseURL: "https://miyamaunitec-fb87a-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "miyamaunitec-fb87a",
    storageBucket: "miyamaunitec-fb87a.firebasestorage.app",
    messagingSenderId: "495316649507",
    appId: "1:495316649507:web:1f98ee3dd851474fa39396",
    measurementId: "G-1NXD8ZPGNR"
  };

  // DOM
  const $dashboard = document.getElementById("dashboard");
  const $loading = document.getElementById("loading");
  const $noData = document.getElementById("noData");
  const $updateTime = document.getElementById("updateTime");
  const $bushoFilter = document.getElementById("bushoFilter");
  const $statusFilter = document.getElementById("statusFilter");
  const $btnSettings = document.getElementById("btnSettings");
  const $btnReload = document.getElementById("btnReload");
  const $settingsModal = document.getElementById("settingsModal");
  const $closeSettings = document.getElementById("closeSettings");
  const $saveSettings = document.getElementById("saveSettings");

  // Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  try{
    await signInAnonymously(auth);
  }catch(e){
    console.warn(e);
  }

  // State
  let allLineData = [];
  let lineCharts = {}; // { [line]: Chart }
  let qrMasterCache = {}; // { [seiriNo]: quantity }

  // è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
  let settings = {
    stopThresholdMin: 15,
    workStart: "08:00",
    workEnd: "17:00",
    breaks: [{ start:"12:00", end:"13:00" }],
    workingDays: [1,2,3,4,5]
  };

  // QRãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿
  async function loadQrMaster(){
    try{
      const masterRef = collection(db, "qrMaster");
      const snapshot = await getDocs(masterRef);
      qrMasterCache = {};
      snapshot.forEach(doc => {
        const data = doc.data();
        const qty = data.quantity;
        if(typeof qty === 'number' && qty > 0){
          qrMasterCache[doc.id] = qty;
        }
      });
      console.log('QRãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', Object.keys(qrMasterCache).length, 'ä»¶');
    }catch(e){
      console.warn('QRãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
    }
  }

  // å“ç•ªã‹ã‚‰å€‹æ•°ã‚’å–å¾—
  function getQtyBySeiriNo(seiriNo){
    const key = String(seiriNo || '').trim();
    if(!key) return 1;
    return qrMasterCache[key] || 1; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1å€‹
  }

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆ
  const statusText = {
    RUNNING: "ç”Ÿç”£ä¸­",
    TRY: "ãƒˆãƒ©ã‚¤ä¸­",
    ABNORMAL_STOP: "ç•°å¸¸åœæ­¢ä¸­",
    PLAN_STOP: "è¨ˆç”»åœæ­¢ä¸­",
    MATERIAL_CHANGE: "ææ–™æ›¿ãˆä¸­",
    SETUP_CHANGE: "æ®µæ›¿ãˆä¸­",
    NOT_STARTED: "æœªé–‹å§‹"
  };

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  function formatTime(dateStr){
    if(!dateStr) return "--:--";
    try{
      const d = new Date(dateStr);
      const h = String(d.getHours()).padStart(2, "0");
      const m = String(d.getMinutes()).padStart(2, "0");
      return `${h}:${m}`;
    }catch(e){
      return "--:--";
    }
  }

  function cssSafe(s){
    return String(s || '').replace(/[^a-zA-Z0-9_\-]/g, '_');
  }

  function calcElapsed(dateStr){
    if(!dateStr) return "-";
    try{
      const diff = Date.now() - new Date(dateStr).getTime();
      const minutes = Math.floor(diff / 60000);
      if(minutes < 60) return `${minutes}åˆ†å‰`;
      const hours = Math.floor(minutes / 60);
      if(hours < 24) return `${hours}æ™‚é–“å‰`;
      return `${Math.floor(hours / 24)}æ—¥å‰`;
    }catch(e){
      return "-";
    }
  }

  // ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
  function createLineCard(data){
    const status = data.state || "NOT_STARTED";
    const stateText = data.stateText || statusText[status] || "æœªé–‹å§‹";
    const product = data.product || "";
    const busho = data.busho || "æœªè¨­å®š";
    const goodCount = data.goodCount || 0;
    const planQuantity = data.planQuantity || 0;
    const lockState = data.lockState || "UNLOCK";
    const updatedAt = data.updatedAt || "";
    const line = data.line || "ä¸æ˜";

    let achievementRate = 0;
    if(planQuantity > 0){
      achievementRate = Math.round((goodCount / planQuantity) * 100);
    }

    let percent = 0;
    let barClass = "";
    if(planQuantity > 0){
      percent = Math.min(100, Math.round((goodCount / planQuantity) * 100));
      if(goodCount >= planQuantity){
        barClass = "complete";
        if(goodCount > planQuantity) barClass = "over";
      }
    }

    const card = document.createElement("div");
    card.className = `lineCard status-${status}`;
    card.innerHTML = `
      ${lockState === "LOCKED" ? '<div class="lockIndicator">ğŸ”’</div>' : ''}
      <div class="lineHeader">
        <div class="lineName">${line}</div>
        <div class="bushoTag">${busho}</div>
      </div>
      <div class="statusBadge status-${status}">${stateText}</div>
      
      <div class="cardStats">
        <div class="cardStat">
          <div class="cardStatLabel">å‡ºæ¥é«˜</div>
          <div class="cardStatValue good">${goodCount.toLocaleString()}</div>
          <div class="cardStatUnit">å€‹</div>
        </div>
        <div class="cardStat">
          <div class="cardStatLabel">è¨ˆç”»æ•°</div>
          <div class="cardStatValue plan">${planQuantity > 0 ? planQuantity.toLocaleString() : '-'}</div>
          <div class="cardStatUnit">${planQuantity > 0 ? 'å€‹' : ''}</div>
        </div>
        <div class="cardStat">
          <div class="cardStatLabel">é”æˆç‡</div>
          <div class="cardStatValue rate">${planQuantity > 0 ? achievementRate : '-'}</div>
          <div class="cardStatUnit">${planQuantity > 0 ? '%' : ''}</div>
        </div>
      </div>
      
      <div class="productInfo">
        <div class="productLabel">è£½å“ï¼ˆæ•´ç†Noï¼‰</div>
        <div class="productName ${product ? '' : 'empty'}">${product || 'æœªè¨­å®š'}</div>
      </div>
      ${planQuantity > 0 ? `
        <div class="progressInfo">
          <div class="progressBarContainer">
            <div class="progressBar ${barClass}" style="width:${percent}%;">
              <span class="progressPercent">${percent}%</span>
            </div>
          </div>
        </div>
      ` : ''}
      
      <div class="outputChartSection">
        <div class="productLabel" style="margin-bottom:8px;">ğŸ“ˆ æœ¬æ—¥ã®å‡ºæ¥é«˜æ¨ç§»ï¼ˆæ™‚é–“åˆ¥ï¼‰</div>
        <div style="position:relative; height:200px; width:100%;">
          <canvas id="chart_${cssSafe(line)}"></canvas>
        </div>
      </div>
      
      <div class="metaInfo">
        <div class="metaItem">ğŸ• ${formatTime(updatedAt)}</div>
        <div class="metaItem">â±ï¸ ${calcElapsed(updatedAt)}</div>
      </div>
    `;
    return card;
  }

  // ã‚µãƒãƒªãƒ¼æ›´æ–°ï¼ˆæœ¬æ—¥ç¨¼åƒãƒ©ã‚¤ãƒ³ã®ã¿ï¼‰
  async function updateSummary(data){
    // æœ¬æ—¥å‹•ãã®ã‚ã‚‹ãƒ©ã‚¤ãƒ³ã®ã¿ã«çµã‚Šè¾¼ã¿
    const activeLines = await getActiveLinesToday();
    const activeData = data.filter(d => activeLines.has(d.line));
    
    const counts = {
      RUNNING: 0,
      TRY: 0,
      ABNORMAL_STOP: 0,
      PLAN_STOP: 0,
      MATERIAL_CHANGE: 0,
      SETUP_CHANGE: 0,
      NOT_STARTED: 0
    };

    activeData.forEach(d => {
      const status = d.state || "NOT_STARTED";
      if(counts[status] !== undefined){
        counts[status]++;
      }
    });

    document.getElementById("runningCount").textContent = counts.RUNNING;
    document.getElementById("tryCount").textContent = counts.TRY;
    document.getElementById("abnormalCount").textContent = counts.ABNORMAL_STOP;
    document.getElementById("planCount").textContent = counts.PLAN_STOP;
    document.getElementById("materialCount").textContent = counts.MATERIAL_CHANGE;
    document.getElementById("setupCount").textContent = counts.SETUP_CHANGE;
    document.getElementById("notStartedCount").textContent = counts.NOT_STARTED;
  }

  // æœ¬æ—¥å‹•ãã®ã‚ã‚‹ãƒ©ã‚¤ãƒ³ã‚’å–å¾—
  let activeLinesCache = new Set();
  let lastActiveLinesFetch = 0;
  const ACTIVE_LINES_CACHE_MS = 60000; // 1åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥

  async function getActiveLinesToday(){
    const now = Date.now();
    
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ãªã‚‰ãã‚Œã‚’è¿”ã™
    if(now - lastActiveLinesFetch < ACTIVE_LINES_CACHE_MS){
      return activeLinesCache;
    }
    
    const today = new Date();
    const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 0, 0, 0);
    const todayEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
    
    try{
      const logsRef = collection(db, "qrLogs");
      const q = query(
        logsRef,
        where("readAt", ">=", todayStart),
        where("readAt", "<=", todayEnd),
        orderBy("readAt", "asc"),
        limit(5000)
      );
      
      const snapshot = await getDocs(q);
      const activeLines = new Set();
      
      snapshot.forEach(doc => {
        const data = doc.data();
        if((data.judge || data.result || '') === 'OK' && data.line){
          activeLines.add(data.line);
        }
      });
      
      activeLinesCache = activeLines;
      lastActiveLinesFetch = now;
      
      console.log('æœ¬æ—¥ç¨¼åƒãƒ©ã‚¤ãƒ³:', Array.from(activeLines));
      return activeLines;
    }catch(e){
      console.error('æœ¬æ—¥ç¨¼åƒãƒ©ã‚¤ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
      return activeLinesCache; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å‰å›ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¿”ã™
    }
  }

  // å‡ºæ¥é«˜æ¨ç§»ã‚°ãƒ©ãƒ•æ›´æ–°
  async function updateOutputCharts(lineDataArray){
    const now = new Date();
    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);

    for(const lineData of lineDataArray){
      const line = lineData.line || 'ä¸æ˜';
      const canvasId = `chart_${cssSafe(line)}`;
      const canvas = document.getElementById(canvasId);
      if(!canvas) continue;

      try{
        // qrLogsã‹ã‚‰æœ¬æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const logsRef = collection(db, "qrLogs");
        const q = query(
          logsRef,
          where("readAt", ">=", todayStart),
          where("readAt", "<=", todayEnd),
          orderBy("readAt", "asc"),
          limit(5000)
        );
        
        const snapshot = await getDocs(q);
        const logs = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          if(data.line === line && (data.judge || data.result || '') === 'OK'){
            const seiriNo = data.sliced || '';
            const qty = getQtyBySeiriNo(seiriNo); // qrMasterã‹ã‚‰å€‹æ•°å–å¾—
            logs.push({
              time: data.readAt.toDate(),
              product: seiriNo,
              qty: qty
            });
          }
        });

        // æ™‚é–“ã”ã¨ã«é›†è¨ˆ
        const hourlyData = Array(24).fill(0);

        logs.forEach(log => {
          const hour = log.time.getHours();
          if(hour >= 0 && hour < 24){
            hourlyData[hour] += log.qty;
          }
        });

        // æœ€å¤§å€¤ã‚’è¨ˆç®—
        const maxValue = Math.max(...hourlyData, 0);
        const suggestedMax = maxValue > 0 ? Math.ceil(maxValue * 1.2) : 10;

        const chartData = {
          labels: Array.from({length:24}, (_,i) => `${String(i).padStart(2,'0')}æ™‚`),
          datasets: [{
            label: 'å‡ºæ¥é«˜',
            data: hourlyData,
            backgroundColor: 'rgba(102, 126, 234, 0.7)',
            borderColor: '#667eea',
            borderWidth: 1,
            barPercentage: 0.8,
            categoryPercentage: 0.9
          }]
        };

        if(lineCharts[line]){
          lineCharts[line].destroy();
        }

        const ctx = canvas.getContext('2d');
        lineCharts[line] = new Chart(ctx, {
          type: 'bar',
          data: chartData,
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => `å‡ºæ¥é«˜: ${context.parsed.y}å€‹`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                suggestedMax: suggestedMax,
                ticks: { 
                  precision: 0,
                  color: '#94a3b8',
                  callback: function(value) {
                    if(Number.isInteger(value)) {
                      return value;
                    }
                  }
                },
                grid: { color: '#334155' },
                title: {
                  display: true,
                  text: 'å‡ºæ¥é«˜ï¼ˆå€‹ï¼‰',
                  color: '#94a3b8',
                  font: { size: 12, weight: 'bold' }
                }
              },
              x: {
                ticks: { 
                  color: '#94a3b8',
                  maxRotation: 0,
                  minRotation: 0,
                  autoSkip: true,
                  maxTicksLimit: 12
                },
                grid: { display: false }
              }
            }
          }
        });

      }catch(e){
        console.error(`ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼ (${line}):`, e);
      }
    }
  }

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  async function filterAndRender(){
    const bushoVal = $bushoFilter.value;
    const statusVal = $statusFilter.value;

    let filtered = allLineData;

    if(bushoVal){
      filtered = filtered.filter(d => d.busho === bushoVal);
    }

    if(statusVal){
      filtered = filtered.filter(d => d.state === statusVal);
    }

    // æœ¬æ—¥å‹•ãã®ã‚ã‚‹ãƒ©ã‚¤ãƒ³ã®ã¿ã«çµã‚Šè¾¼ã¿
    const activeLines = await getActiveLinesToday();
    filtered = filtered.filter(d => activeLines.has(d.line));

    // ã‚µãƒãƒªãƒ¼ã‚‚æœ¬æ—¥ç¨¼åƒãƒ©ã‚¤ãƒ³ã®ã¿ã§æ›´æ–°
    await updateSummary(allLineData);

    $dashboard.innerHTML = "";
    if(filtered.length === 0){
      $noData.style.display = "block";
      $dashboard.style.display = "none";
    }else{
      $noData.style.display = "none";
      $dashboard.style.display = "grid";
      filtered.forEach(data => {
        $dashboard.appendChild(createLineCard(data));
      });
      
      // ã‚°ãƒ©ãƒ•æ›´æ–°
      updateOutputCharts(filtered);
    }
  }

  // è¨­å®šèª­ã¿è¾¼ã¿
  async function loadSettings(){
    try{
      const docRef = doc(db, "settings", "dashboardConfig");
      const snap = await getDoc(docRef);
      if(snap.exists()){
        const data = snap.data();
        settings = {
          stopThresholdMin: data.stopThresholdMin || 15,
          workStart: data.workStart || "08:00",
          workEnd: data.workEnd || "17:00",
          breaks: data.breaks || [{start:"12:00", end:"13:00"}],
          workingDays: data.workingDays || [1,2,3,4,5]
        };
      }
      applySettingsToUI();
      console.log('è¨­å®šèª­ã¿è¾¼ã¿å®Œäº†:', settings);
    }catch(e){
      console.warn('è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
    }
  }

  // è¨­å®šã‚’UIã«åæ˜ 
  function applySettingsToUI(){
    document.getElementById('stopThreshold').value = settings.stopThresholdMin;
    document.getElementById('workStart').value = settings.workStart;
    document.getElementById('workEnd').value = settings.workEnd;
    
    document.querySelectorAll('.dayCheck').forEach(cb => {
      cb.checked = settings.workingDays.includes(parseInt(cb.value));
    });
    
    renderBreaksList();
  }

  // UIã‹ã‚‰è¨­å®šã‚’èª­ã¿å–ã‚Š
  function readSettingsFromUI(){
    settings.stopThresholdMin = parseInt(document.getElementById('stopThreshold').value) || 15;
    settings.workStart = document.getElementById('workStart').value;
    settings.workEnd = document.getElementById('workEnd').value;
    
    settings.workingDays = [];
    document.querySelectorAll('.dayCheck:checked').forEach(cb => {
      settings.workingDays.push(parseInt(cb.value));
    });
  }

  // ä¼‘æ†©æ™‚é–“ãƒªã‚¹ãƒˆæç”»
  function renderBreaksList(){
    const container = document.getElementById('breaksList');
    container.innerHTML = '';
    
    settings.breaks.forEach((br, idx) => {
      const div = document.createElement('div');
      div.className = 'inputGroup';
      div.innerHTML = `
        <input type="time" class="breakStart" data-idx="${idx}" value="${br.start}" />
        <span style="color:var(--muted);">ã€œ</span>
        <input type="time" class="breakEnd" data-idx="${idx}" value="${br.end}" />
        <button class="removeBreak" data-idx="${idx}">ğŸ—‘ï¸</button>
      `;
      container.appendChild(div);
    });
    
    container.querySelectorAll('.breakStart').forEach(inp => {
      inp.addEventListener('change', e => {
        settings.breaks[parseInt(e.target.dataset.idx)].start = e.target.value;
      });
    });
    
    container.querySelectorAll('.breakEnd').forEach(inp => {
      inp.addEventListener('change', e => {
        settings.breaks[parseInt(e.target.dataset.idx)].end = e.target.value;
      });
    });
    
    container.querySelectorAll('.removeBreak').forEach(btn => {
      btn.addEventListener('click', e => {
        settings.breaks.splice(parseInt(e.target.dataset.idx), 1);
        renderBreaksList();
      });
    });
  }

  // è¨­å®šä¿å­˜
  async function saveSettings(){
    readSettingsFromUI();
    try{
      const docRef = doc(db, "settings", "dashboardConfig");
      await setDoc(docRef, { ...settings, updatedAt: new Date() });
      alert('âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      $settingsModal.classList.remove('show');
      filterAndRender(); // å†æç”»
    }catch(e){
      console.error('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
      alert('âŒ è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  $btnSettings.addEventListener('click', () => {
    $settingsModal.classList.add('show');
  });

  $closeSettings.addEventListener('click', () => {
    $settingsModal.classList.remove('show');
  });

  $settingsModal.addEventListener('click', (e) => {
    if(e.target === $settingsModal){
      $settingsModal.classList.remove('show');
    }
  });

  $saveSettings.addEventListener('click', saveSettings);

  document.getElementById('addBreak').addEventListener('click', () => {
    settings.breaks.push({ start:"15:00", end:"15:15" });
    renderBreaksList();
  });

  $btnReload.addEventListener('click', () => {
    filterAndRender();
  });

  $bushoFilter.addEventListener("change", filterAndRender);
  $statusFilter.addEventListener("change", filterAndRender);

  // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
  const q = query(collection(db, "lineStatus"));
  onSnapshot(q, (snapshot) => {
    $loading.style.display = "none";
    
    allLineData = [];
    snapshot.forEach(doc => {
      allLineData.push(doc.data());
    });

    allLineData.sort((a, b) => {
      const lineA = a.line || "";
      const lineB = b.line || "";
      return lineA.localeCompare(lineB);
    });

    filterAndRender();

    const now = new Date();
    const h = String(now.getHours()).padStart(2, "0");
    const m = String(now.getMinutes()).padStart(2, "0");
    const s = String(now.getSeconds()).padStart(2, "0");
    $updateTime.textContent = `${h}:${m}:${s}`;
  }, (error) => {
    console.error("Firestore error:", error);
    $loading.textContent = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
  });

  // åˆæœŸåŒ–
  await loadSettings();
  await loadQrMaster(); // QRãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿

  console.log('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–å®Œäº†');
</script>

</body>
</html>
